<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> New package: mwan2; testers wanted.</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 31 Mar 2018 and 27 Apr 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 14</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=33129&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=33129&amp;p=3.html">3</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=33129&amp;p=14.html">14</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p149372">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						23 Nov 2011, 14:03					</div>
				</div>
				<div class="post-content content">
					<p>Hi all,</p><p>I have made a multiwan script called mwan2, which should resolve some issues i had with multiwan. I&#039;d really like it if you could give it a go and let me know what you think of it.</p><p><em>edit: mwan2 has had an update, so it&#039;s now compatible with netifd.</em><br /><em>edit2: mwan2 now support session-based load sharing. Please read the mwan2 config file for more information. Also the config has changed a little. You now NEED to define at least one rule to make mwan2 work.</em><br /><em>edit3: mwan3 is now available: <a href="https://forum.openwrt.org/viewtopic.php?id=39052">https://forum.openwrt.org/viewtopic.php?id=39052</a></em><br /><em>edit4: mwan svn repository is up: svn://213.136.13.52/var/svn/mwan, it is now much easier to add mwan to the openwrt trunk. Just add the line &quot;src-svn mwan svn://213.136.13.52/var/svn/mwan&quot; to the file &quot;feeds.conf.default&quot;.</em></p><p>The package:<br /><a href="http://213.136.13.52/mwan2_1.4-5.ipk">http://213.136.13.52/mwan2_1.4-5.ipk</a></p><p>And the source:<br /><a href="http://213.136.13.52/mwan2_1.4-5.tar.gz">http://213.136.13.52/mwan2_1.4-5.tar.gz</a><br />svn://213.136.13.52/var/svn/mwan</p><p><strong>What is mwan2:</strong><br />Mwan2 is a couple of lines of code that simplifies the usage of more (up to 7) WAN interfaces in OpenWRT. It is hotplug driven and it allows for any combination of primary, secondary or more failover interfaces, load balanced or not, for any combination of traffic. Mwan2 can monitor the state of interfaces by sending pings to a configured tracking host and failover if necessary.</p><br /><p><strong>Why should i use mwan2 instead of multi-wan ?:</strong><br />- It is faster; mwan2 uses less iptables-rules.<br />- It is more configurable; mwan2 can handle multiple levels of backup interfaces, load-balanced or not.<br />- It is compatible; mwan2 uses flowmask to be compatible with other packages (such as OpenVPN, PPTP VPN, QoS-script, Tunnels, etc) and you can configure destinations to fall-back to the default routing table.</p><br /><p><strong>Requirements:</strong><br />Mwan2 is successfully tested on OpenWRT trunk r28731 and up. You need the following packages (which should be installed automatically if missing): ip, iptables, iptables-mod-conntrack, iptables-mod-conntrack-extra, iptables-mod-ipopt.</p><br /><p><strong>How does it work:</strong><br />Mwan2 is triggered by hotplug-events. When an interface comes up it creates new routing tables and new iptables rules. A new routing table is created for each possible combination of wan interfaces. So if you have 4 WAN interfaces, 2^4-1 routing tables are created. </p><p>It then sets up iptables rules and uses iptables MARK to mark certain traffic. Traffic that is allowed over WAN interface 1 gets the first mark bit set. Traffic that is allowed over WAN interface 2 gets the second mark bit set. And so forth. Eventually you get a flow with certain &#039;wan&#039; marks set. The kernel then uses that mark to determine which routing table to use.</p><p>When an interface goes down, mwan2 deletes all routes to that interface in all created routing tables.</p><br /><p><strong>How to install and configure:</strong><br />I&#039;ll assume here you have a clean install of OpenWRT. [s]Due to a bug in OpenWRT (<a href="https://dev.openwrt.org/ticket/10423">https://dev.openwrt.org/ticket/10423</a>) you have to edit the file &quot;/usr/share/udhcpc/default.script&quot; and replace line 72 from[/s]<br /></p><div class="codebox"><pre><code>eval $(route -n | awk &#039;</code></pre></div><p>[s]to[/s]<br /></p><div class="codebox"><pre><code>eval $(route -n | awk &#039;$5 == (&#039;${user_metric:-0}&#039;)&#039; | awk &#039;</code></pre></div><p>You then configure your network according to your setup. Place a different metric on each WAN interface. This metric has only effect on the default routing table, not on the mwan2 routing tables. If it is configured correctly you should have a default gateway with a different metric set for each WAN interface. Something will look like this:<br /></p><div class="codebox"><pre><code>root@openwrt:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         31.151.171.1    0.0.0.0         UG    10     0        0 eth0.1
0.0.0.0         195.240.99.254  0.0.0.0         UG    20     0        0 eth0.2
31.151.171.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0.1
192.168.33.0    0.0.0.0         255.255.255.0   U     0      0        0 br-lan
195.240.96.0    0.0.0.0         255.255.252.0   U     0      0        0 eth0.2</code></pre></div><p>Check if above configuration works by trying to ping <a href="http://www.google.com">www.google.com</a> form each interface:<br /></p><div class="codebox"><pre><code>root@openwrt:~# ping -c 1 -I eth0.1 www.google.com
PING www.google.com (209.85.148.103): 56 data bytes
64 bytes from 209.85.148.103: seq=0 ttl=54 time=19.637 ms

--- www.google.com ping statistics ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 19.637/19.637/19.637 ms

root@openwrt:~# ping -c 1 -I eth0.2 www.google.com
PING www.google.com (209.85.148.99): 56 data bytes
64 bytes from 209.85.148.99: seq=0 ttl=56 time=25.552 ms

--- www.google.com ping statistics ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 25.552/25.552/25.552 ms</code></pre></div><p>If above ping tests are successful, you can then continue installing mwan2. If you cannot ping <a href="http://www.google.com">www.google.com</a> from all WAN interfaces, there is a problem with your config and installing mwan2 won&#039;t fix that!</p><p>After installing mwan2, configure it by editting /etc/config/mwan2. For each WAN interface create an interface with a name that matches the one used in /etc/config/network. Configure weight and metric. Interface with a low metric have precedence over higher metric interfaces. Interfaces with the same metric will load-balance. Load balancing interfaces (with same metric) will distribute load based on those weights values. All other options are for tracking and are optional.</p><p>After that, configure mwan2 rules. With the mwan2 rules you can direct traffic to certain WAN interfaces, or use the default routing table by choosing default. The order of the rules is important, as they are loaded in iptables in that order. If a rule is matched, but all listed WAN interfaces are down, traffic is handled by the default routing table.</p><br /><p><strong>Troubleshooting (if necessary):</strong><br /></p><div class="codebox"><pre><code>root@openwrt:~# ip rule list
0:    from all lookup local 
256:    from all fwmark 0x100/0xff00 lookup 1 
257:    from all fwmark 0x200/0xff00 lookup 2 
258:    from all fwmark 0x300/0xff00 lookup 3 
512:    from 31.151.171.0/24 lookup 1 
513:    from 195.240.96.0/22 lookup 2 
32766:    from all lookup main 
32767:    from all lookup default 

root@openwrt:~# ip route list table 3
default  metric 1 
    nexthop via 195.240.99.254  dev eth0.2 weight 1
    nexthop via 31.151.171.1  dev eth0.1 weight 1

root@openwrt:~# iptables -L mwan2_pre -t mangle -v
Chain mwan2_pre (2 references)
 pkts bytes target     prot opt in     out     source               destination         
1341K  939M CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK restore mask 0xff00 
 1887  194K MARK       all  --  eth0.2 any     anywhere             anywhere            MARK xset 0x8200/0xff00 
89251   41M MARK       all  --  eth0.1 any     anywhere             anywhere            MARK xset 0x8100/0xff00 
 176K   11M mwan2_rules  all  --  any    any     anywhere             anywhere            ctstate NEW mark match 0x0/0xff00 

root@openwrt:~# iptables -L mwan2_post -t mangle -v
Chain mwan2_post (1 references)
 pkts bytes target     prot opt in     out     source               destination         
 1853  187K MARK       all  --  any    eth0.2  anywhere             anywhere            MARK xset 0x200/0xff00 
36520 4106K MARK       all  --  any    eth0.1  anywhere             anywhere            MARK xset 0x100/0xff00 
 670K  870M MARK       all  --  any    any     anywhere             anywhere            mark match 0x8000/0x8000 MARK and 0xffff7fff 
1098K  905M CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK save mask 0xff00 

root@openwrt:~# iptables -L mwan2_rules -t mangle -v
Chain mwan2_rules (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       all  --  any    any     anywhere             10.0.0.0/8          mark match 0x0/0xff00 MARK xset 0x8000/0xff00 
13634  827K MARK       all  --  any    any     anywhere             127.0.0.0/8         mark match 0x0/0xff00 MARK xset 0x8000/0xff00 
    0     0 MARK       all  --  any    any     anywhere             172.16.0.0/12       mark match 0x0/0xff00 MARK xset 0x8000/0xff00 
  105 15694 MARK       all  --  any    any     anywhere             192.168.0.0/16      mark match 0x0/0xff00 MARK xset 0x8000/0xff00 
  423 28080 MARK       all  --  any    any     anywhere             base-address.mcast.net/3 mark match 0x0/0xff00 MARK xset 0x8000/0xff00 
 2461  204K MARK       all  --  any    any     anywhere             anywhere            mark match 0x0/0xff00 MARK xset 0x300/0xff00</code></pre></div>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 10 Sep 2012, 12:29)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p149856">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						29 Nov 2011, 14:32					</div>
				</div>
				<div class="post-content content">
					<p>Really no one is interested? Only 3 downloads and 0 replies. Guess multiple WANs isn&#039;t that common and used, as i thought...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p152281">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">xopal</div>
					<div class="post-datetime">
						28 Dec 2011, 18:59					</div>
				</div>
				<div class="post-content content">
					<p>Thank you Adze, I&#039;m running your script on my router right now , I&#039;ll give you report in a few days.</p>											<p class="post-edited">(Last edited by <strong>xopal</strong> on 28 Dec 2011, 20:13)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p152287">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">dir2cas</div>
					<div class="post-datetime">
						28 Dec 2011, 19:42					</div>
				</div>
				<div class="post-content content">
					<p>I find this a great piece of information. Comprehensive and detailed, thanks.</p><p>Unfortunately, in spite I intent to build a multiwan environment in future, now I am not able to give this a real test. In my oppinion, this should be inspected and tested and put in the wiki...</p><p>I may try it in a virtualbox setup with several openwrt machines that I am currently running for testing purposes.</p><p>Keep it going Adze.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p152442">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">gulikoza</div>
					<div class="post-datetime">
						30 Dec 2011, 13:31					</div>
				</div>
				<div class="post-content content">
					<p>Thanks, I&#039;ll check it out.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153997">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">rossb</div>
					<div class="post-datetime">
						12 Jan 2012, 21:30					</div>
				</div>
				<div class="post-content content">
					<p>have tried this out and using wan1 = wired, wan2=3g. It works and is a great solution for failover / loadsharing applications where all interfaces are kept up at all times. In my application, I want the 3g interface off until needed. May be useful to have interface config option which takes down unneeded interfaces (such as 3g) when main interfaces up.</p><p>For my application, opted for this script:</p><p><a href="https://forum.openwrt.org/viewtopic.php?pid=153957#p153957">https://forum.openwrt.org/viewtopic.php … 57#p153957</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p154002">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">rossb</div>
					<div class="post-datetime">
						12 Jan 2012, 22:03					</div>
				</div>
				<div class="post-content content">
					<p>also noticing this (logread):</p><p>Jan 12 19:57:30 OpenWrt user.info firewall: removing wan (eth1) from zone wan<br />Jan 12 19:57:31 OpenWrt user.notice root: mwan2: Lost 3 ping(s) on interface ppp0 (3g-ppp0)<br />Jan 12 19:57:35 OpenWrt user.notice root: mwan2: Lost 3 ping(s) on interface wan (eth1)<br />Jan 12 19:58:09 OpenWrt user.notice root: mwan2: Interface ppp0 (3g-ppp0) is back online<br />Jan 12 19:58:09 OpenWrt user.notice ifup: Enabling Router Solicitations on ppp0 (3g-ppp0)<br />Jan 12 19:58:09 OpenWrt user.notice root: mwan2: Adding rules for interface ppp0 (3g-ppp0)<br />Jan 12 19:58:11 OpenWrt user.notice root: mwan2: Interface wan (eth1) is back online<br />Jan 12 19:58:11 OpenWrt user.notice ifup: Allowing Router Advertisements on wan (eth1)<br />Jan 12 19:58:11 OpenWrt user.notice root: mwan2: Adding rules for interface wan (eth1)<br />Jan 12 19:58:11 OpenWrt user.info firewall: adding wan (eth1) to zone wan<br />Jan 12 19:59:53 OpenWrt user.notice root: mwan2: Interface ppp0 (3g-ppp0) is offline<br />Jan 12 19:59:53 OpenWrt user.notice root: mwan2: Deleting rules for interface ppp0 (3g-ppp0)<br />Jan 12 19:59:57 OpenWrt user.notice root: mwan2: Interface wan (eth1) is offline<br />Jan 12 19:59:58 OpenWrt user.notice root: mwan2: Deleting rules for interface wan (eth1)<br />Jan 12 19:59:58 OpenWrt user.info firewall: removing wan (eth1) from zone wan<br />Jan 12 19:59:59 OpenWrt user.notice root: mwan2: Lost 3 ping(s) on interface ppp0 (3g-ppp0)<br />Jan 12 20:00:03 OpenWrt user.notice root: mwan2: Lost 3 ping(s) on interface wan (eth1)</p><p>Indicating that mwan2 believes both interfaces are unstable. They are not. Looks like some sort of race condition.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p154085">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						13 Jan 2012, 17:26					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>rossb wrote:</cite><blockquote><p>May be useful to have interface config option which takes down unneeded interfaces (such as 3g) when main interfaces up.</p></blockquote></div><p>This should be possible i think... You have to remove all tracking options for your 3g connection in &quot;/etc/config/mwan2&quot;. And configure dial on demand in &quot;/etc/config/network&quot;. Don&#039;t have a 3g dongle myself (yet), so can&#039;t test it myself right now.</p><div class="codebox"><pre><code>config &#039;interface&#039; &#039;ppp0&#039;
        option &#039;proto&#039; &#039;3g&#039;
        option &#039;ifname&#039; &#039;3g-ppp0&#039;
        option &#039;service&#039; &#039;umts_only&#039;
        option &#039;apn&#039; &#039;???&#039;
        option &#039;pincode&#039; &#039;???&#039;
        option &#039;device&#039; &#039;/dev/ttyUSB0&#039;
        option &#039;demand&#039; &#039;600&#039;</code></pre></div><div class="quotebox"><cite>rossb wrote:</cite><blockquote><p>Indicating that mwan2 believes both interfaces are unstable. They are not. Looks like some sort of race condition.</p></blockquote></div><p>It should be fixed now in the 1.3-2 release. It was a small problem of ip rule order.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p154124">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">rossb</div>
					<div class="post-datetime">
						14 Jan 2012, 00:26					</div>
				</div>
				<div class="post-content content">
					<p>... with updated package, still seeing mwan2 lost pings and interface rules being changed. It may be because of 3g which you do not have and therefore, cannot test with. I have other tasks, so have spent as much time as I can on this. Thanks for your work and, I may be able to revisit once stability achieved.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p154247">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">babel_fish_42</div>
					<div class="post-datetime">
						15 Jan 2012, 08:31					</div>
				</div>
				<div class="post-content content">
					<p>Hi there I have started to get things under test but an issue hads apeared</p><p>if i have wan 1 = eth1 and wan 2 = eth2</p><p>i get 2 enteries in my routing table</p><br /><p>if wan 1 = eth1 and wan 2 = 3g dongle<br />i get only the route or the 3g dongle. if i look at my routing table as it applies i can see the route or eth0 apears and then gets overwriten by the 3g dongle. also thr routemetric does not stick.</p><br /><br /><p>Destination&nbsp; &nbsp; &nbsp;Gateway&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Genmask&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Flags Metric Ref&nbsp; &nbsp; Use Iface<br />10.64.64.64&nbsp; &nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.255 UH&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 3g-3g<br />10.10.1.0&nbsp; &nbsp; &nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 br-lan<br />192.168.0.0&nbsp; &nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth1<br />default&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10.64.64.64&nbsp; &nbsp; &nbsp;0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 3g-3g</p><br /><p>config &#039;interface&#039; &#039;WAN&#039;<br />&nbsp; &nbsp; option &#039;ifname&#039; &#039;eth1&#039;<br />&nbsp; &nbsp; option &#039;_orig_ifname&#039; &#039;eth1&#039;<br />&nbsp; &nbsp; option &#039;_orig_bridge&#039; &#039;false&#039;<br />&nbsp; &nbsp; option &#039;proto&#039; &#039;static&#039;<br />&nbsp; &nbsp; option &#039;ipaddr&#039; &#039;192.168.0.100&#039;<br />&nbsp; &nbsp; option &#039;netmask&#039; &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; option &#039;gateway&#039; &#039;192.168.0.1&#039;<br />&nbsp; &nbsp; option &#039;broadcast&#039; &#039;192.168.0.255&#039;<br />&nbsp; &nbsp; option &#039;dns&#039; &#039;192.168.0.1&#039;<br />&nbsp; &nbsp; option &#039;metric&#039; &#039;10&#039;</p><p>config &#039;interface&#039; &#039;3g&#039;<br />&nbsp; &nbsp; option &#039;proto&#039; &#039;3g&#039;<br />&nbsp; &nbsp; option &#039;device&#039; &#039;/dev/ttyUSB0&#039;<br />&nbsp; &nbsp; option &#039;apn&#039; &#039;three.co.uk&#039;<br />&nbsp; &nbsp; option &#039;service&#039; &#039;umts&#039;<br />&nbsp; &nbsp; option &#039;metric&#039; &#039;20&#039;</p><p>Thanks in advance Dafydd</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p154259">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						15 Jan 2012, 12:53					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>babel_fish_42 wrote:</cite><blockquote><p>if i look at my routing table as it applies i can see the route or eth0 apears and then gets overwriten by the 3g dongle. also thr routemetric does not stick.</p></blockquote></div><p>That is a problem indeed. Although the main routing table isn&#039;t used for traffic forwarding to WANs, it is used to dynamically create the custom routing tables. Could you please try the setting &quot;option defaultroute 0&quot; in your 3g network config? Could you also paste me the output of &quot;ip route list table 3&quot; please?</p><p>Thanx</p><p>Edit: i see that your 3g interface in the routing table is named &quot;3g-3g&quot;. This will probably be troublesome. Could you also try to add the setting &quot;option iface 3g-3g&quot; in your 3g network config?</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 15 Jan 2012, 13:13)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p154261">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">babel_fish_42</div>
					<div class="post-datetime">
						15 Jan 2012, 13:06					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for the swit reply <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>with option set to 0</p><p>Kernel IP routing table<br />Destination&nbsp; &nbsp; &nbsp;Gateway&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Genmask&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Flags Metric Ref&nbsp; &nbsp; Use Iface<br />10.64.64.64&nbsp; &nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.255 UH&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 3g-3g<br />10.10.1.0&nbsp; &nbsp; &nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 br-lan<br />192.168.0.0&nbsp; &nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth1<br />default&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;192.168.0.1&nbsp; &nbsp; &nbsp;0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 10&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth1</p><br /><p>ip route table 3 = Blank</p><p>root@Semaphore:/# ip route list table 3<br />root@Semaphore:/#</p><p>Thanks<br />Dafydd</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p154262">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						15 Jan 2012, 13:36					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>babel_fish_42 wrote:</cite><blockquote><p>...</p><p>Thanks<br />Dafydd</p></blockquote></div><p>I PM-ed you, because otherwise the forum may become some sort of slow chat.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155300">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">xopal</div>
					<div class="post-datetime">
						25 Jan 2012, 05:53					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>I found this error when recall /reload mwan2track</p><div class="codebox"><pre><code>root@OpenWrt:~# mwan2track
/usr/sbin/mwan2track: line 4: arithmetic syntax error</code></pre></div><div class="codebox"><pre><code>line 1#!/bin/sh
line 2 echo &quot;$$&quot; &gt; /var/run/mwan2track-$2.pid
line 3
line 4 score=$(($7+$8))
line 5 lost=0</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155329">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						25 Jan 2012, 14:04					</div>
				</div>
				<div class="post-content content">
					<p>Thats because there is no 7th and 8th numeric argument in your commandline.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155336">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						25 Jan 2012, 14:51					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>xopal wrote:</cite><blockquote><p>Hello,</p><p>I found this error when recall /reload mwan2track</p></blockquote></div><p>mwan2track shouldn&#039;t be started by hand, but by the mwan2 script. I will add some syntax checks and warnings if options are missing or started manually. If you really want to start it by hand:</p><p>mwan2track $1 $2 $3 $4 $5 $6 $7 $8</p><p>where $1 = interface, $2 = device, $3 = host to ping, $4 = number of echo-requests per test, $5 = timeout per icmp-request, $6 = interval between tests in seconds, $7 = number of failed tests until interface is considered &quot;down&quot;, $8 = number of successful tests until interface is considered &quot;up&quot;.</p><p>Example:<br /></p><div class="codebox"><pre><code>/usr/sbin/mwan2track isp1 eth0.1 www.google.com 1 2 5 3 8</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155342">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">VeNoM</div>
					<div class="post-datetime">
						25 Jan 2012, 15:49					</div>
				</div>
				<div class="post-content content">
					<p>Cool. I will test it too.</p>											<p class="post-edited">(Last edited by <strong>VeNoM</strong> on 25 Jan 2012, 15:49)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p156338">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">xopal</div>
					<div class="post-datetime">
						5 Feb 2012, 17:21					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>babel_fish_42 wrote:</cite><blockquote><p>Thanks for the swit reply <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>with option set to 0</p><p>Kernel IP routing table<br />Destination&nbsp; &nbsp; &nbsp;Gateway&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Genmask&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Flags Metric Ref&nbsp; &nbsp; Use Iface<br />10.64.64.64&nbsp; &nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.255 UH&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 3g-3g<br />10.10.1.0&nbsp; &nbsp; &nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 br-lan<br />192.168.0.0&nbsp; &nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth1<br />default&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;192.168.0.1&nbsp; &nbsp; &nbsp;0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 10&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth1</p><br /><p>ip route table 3 = Blank</p><p>root@Semaphore:/# ip route list table 3<br />root@Semaphore:/#</p><p>Thanks<br />Dafydd</p></blockquote></div><p>Hi</p><p>This is the way i manage my dual wan wired and 3g dongle, may this help you.</p><p>#opkg update<br />#opkg install multiwan<br />#wget mwan2 (look at adze link)</p><p>#opkg install *.ipk</p><p>network</p><div class="codebox"><pre><code>config &#039;interface&#039; &#039;wan&#039;
        option &#039;proto&#039;     &#039;pppoe&#039;
        option &#039;ifname&#039;    &#039;eth0.2&#039;
        option &#039;username&#039;  &#039;xxxxxxxxxxxx&#039;
        option &#039;password&#039;  &#039;xxxxxxxxx&#039;
        option &#039;timeout&#039;   &#039;10&#039;
     #option &#039;defaultroute&#039; &#039;0&#039;
     option &#039;peerdns&#039;    &#039;0&#039;
     option &#039;dns&#039;        &#039;180.131.144.144 180.131.145.145&#039;

config &#039;interface&#039; &#039;ppp0&#039;
        option &#039;proto&#039; &#039;3g&#039;
        #option &#039;ifname&#039; &#039;3g-ppp0&#039;
        option &#039;service&#039; &#039;evdo&#039;
        option &#039;username&#039; &#039;smart&#039;
        option &#039;password&#039; &#039;smart&#039;
        option &#039;device&#039; &#039;/dev/ttyUSB0&#039;
     #option &#039;defaultroute&#039; &#039;0&#039;
     option &#039;peerdns&#039;    &#039;0&#039;
     option &#039;dns&#039;        &#039;180.131.144.144 180.131.145.145&#039;</code></pre></div><p>multiwan</p><div class="codebox"><pre><code>config &#039;interface&#039; &#039;ppp0&#039;
    option &#039;weight&#039; &#039;disable&#039;
    option &#039;health_interval&#039; &#039;10&#039;
    option &#039;icmp_hosts&#039; &#039;disable&#039;
    # icmp_count is defaulted to 1, and can be increased to reduce
    # false positives.
    # option &#039;icmp_count&#039; &#039;3&#039;
    option &#039;timeout&#039; &#039;3&#039;
    option &#039;health_fail_retries&#039; &#039;3&#039;
    option &#039;health_recovery_retries&#039; &#039;5&#039;
    option &#039;failover_to&#039; &#039;wan&#039;
    option &#039;dns&#039; &#039;auto&#039;

config &#039;interface&#039; &#039;wan&#039;
    option &#039;weight&#039; &#039;disable&#039;
    option &#039;health_interval&#039; &#039;10&#039;
    option &#039;icmp_hosts&#039; &#039;disable&#039;
    option &#039;timeout&#039; &#039;3&#039;
    option &#039;health_fail_retries&#039; &#039;3&#039;
    option &#039;health_recovery_retries&#039; &#039;5&#039;
    option &#039;failover_to&#039; &#039;balancer&#039;
    option &#039;dns&#039; &#039;180.131.144.144 180.131.145.145&#039;</code></pre></div><p>mwan2</p><div class="codebox"><pre><code>config &#039;interface&#039; &#039;wan&#039;
    option &#039;enabled&#039; &#039;1&#039;
    option &#039;metric&#039; &#039;1&#039;
    option &#039;weight&#039; &#039;1&#039;
    option &#039;track_ip&#039; &#039;www.google.com&#039;
    option &#039;count&#039; &#039;1&#039;
    option &#039;timeout&#039; &#039;2&#039;
    option &#039;interval&#039; &#039;5&#039;
    option &#039;down&#039; &#039;3&#039;
    option &#039;up&#039; &#039;8&#039;

config &#039;interface&#039; &#039;ppp0&#039;
    option &#039;enabled&#039; &#039;1&#039;
    option &#039;metric&#039; &#039;1&#039;
    option &#039;weight&#039; &#039;6&#039;
    option &#039;track_ip&#039; &#039;www.google.com&#039;
    option &#039;count&#039; &#039;1&#039;
    option &#039;timeout&#039; &#039;2&#039;
    option &#039;interval&#039; &#039;5&#039;
    option &#039;down&#039; &#039;3&#039;
    option &#039;up&#039; &#039;8&#039;</code></pre></div><div class="codebox"><pre><code>root@OpenWrt:/tmp# ip route list table 3
default  metric 1
        nexthop via 10.20.31.13  dev 3g-ppp0 weight 6
        nexthop via 180.251.112.1  dev pppoe-wan weight 1</code></pre></div><p>I move my primary connection to 3g and my wired act as a secondary connection.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p156340">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						5 Feb 2012, 17:25					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>xopal wrote:</cite><blockquote><p>#opkg install multiwan</p></blockquote></div><p>mwan2 is NOT intended to be used together with multiwan. You can do perfectly without multiwan in a dual wired (load-balanced) and a 3g backup, or any other primary/backup setup. As a matter of fact i&#039;m running it now.</p><p>Will update this topic soon with some details and configuration examples.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 5 Feb 2012, 17:54)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p156347">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						5 Feb 2012, 17:49					</div>
				</div>
				<div class="post-content content">
					<p>As i was fiddling with a 3g dongle this weekend, i have managed to setup the following scenario:</p><p>- 2 Wired WAN links (Unlimited traffic, 120/10Mbps cable link and 20/1Mbps dsl link)<br />- 1 Wireless UMTS link (2GB/month, 7,2/2Mbps link)</p><p>I wanted both wired links to load-balance traffic and the 3G link only to kick-in when both wired links have failed. I also wanted some specific tcp ports to always traverse the second wired link. This is my config:</p><p>/etc/config/network:<br /></p><div class="codebox"><pre><code>config &#039;interface&#039; &#039;lan&#039;
    option &#039;ifname&#039; &#039;eth1&#039;
    option &#039;proto&#039; &#039;static&#039;
    option &#039;ipaddr&#039; &#039;192.168.33.1&#039;
    option &#039;netmask&#039; &#039;255.255.255.0&#039;
    option &#039;ip6addr&#039; &#039;2001:610:64d:1::1/64&#039;

config &#039;interface&#039; &#039;isp1&#039;
    option &#039;ifname&#039; &#039;eth0.1&#039;
    option &#039;proto&#039; &#039;dhcp&#039;
    option &#039;metric&#039; &#039;10&#039;
    option &#039;dns&#039; &#039;208.67.222.222 8.8.8.8&#039;

config &#039;interface&#039; &#039;isp2&#039;
    option &#039;ifname&#039; &#039;eth0.2&#039;
    option &#039;proto&#039; &#039;dhcp&#039;
    option &#039;metric&#039; &#039;20&#039;
    option &#039;dns&#039; &#039;208.67.220.220 8.8.4.4&#039;
    
config &#039;interface&#039; &#039;isp3&#039;
    option &#039;ifname&#039; &#039;ppp0&#039;
    option &#039;device&#039; &#039;/dev/ttyUSB0&#039;
    option &#039;apn&#039; &#039;office.vodafone.nl&#039;
    option &#039;username&#039; &#039;vodafone&#039;
    option &#039;password&#039; &#039;vodafone&#039;
    option &#039;service&#039; &#039;umts&#039;
    option &#039;proto&#039; &#039;3g&#039;
    option &#039;defaultroute&#039; &#039;0&#039;

config &#039;route&#039;
    option &#039;interface&#039; &#039;isp3&#039;
    option &#039;target&#039; &#039;0.0.0.0&#039;
    option &#039;netmask&#039; &#039;0.0.0.0&#039;
    option &#039;metric&#039; &#039;30&#039;</code></pre></div><p>/etc/config/mwan2:<br /></p><div class="codebox"><pre><code>config &#039;interface&#039; &#039;isp1&#039;
    option &#039;enabled&#039; &#039;1&#039;
    option &#039;metric&#039; &#039;1&#039;
    option &#039;weight&#039; &#039;4&#039;
    option &#039;track_ip&#039; &#039;www.google.com&#039;
    option &#039;count&#039; &#039;1&#039;
    option &#039;timeout&#039; &#039;2&#039;
    option &#039;interval&#039; &#039;5&#039;
    option &#039;down&#039; &#039;3&#039;
    option &#039;up&#039; &#039;8&#039;

config &#039;interface&#039; &#039;isp2&#039;
    option &#039;enabled&#039; &#039;1&#039;
    option &#039;metric&#039; &#039;1&#039;
    option &#039;weight&#039; &#039;1&#039;
    option &#039;track_ip&#039; &#039;www.google.com&#039;
    option &#039;count&#039; &#039;1&#039;
    option &#039;timeout&#039; &#039;2&#039;
    option &#039;interval&#039; &#039;5&#039;
    option &#039;down&#039; &#039;3&#039;
    option &#039;up&#039; &#039;8&#039;

config &#039;interface&#039; &#039;isp3&#039;
    option &#039;enabled&#039; &#039;1&#039;
    option &#039;metric&#039; &#039;2&#039;
    option &#039;weight&#039; &#039;1&#039;

config &#039;rule&#039;
    option &#039;proto&#039; &#039;tcp&#039;
    option &#039;src_ip&#039; &#039;192.168.33.0/24&#039;
    option &#039;dest_port&#039; &#039;119,563&#039;
    list &#039;use_interface&#039; &#039;isp1&#039;

config &#039;rule&#039;
    option &#039;proto&#039; &#039;tcp&#039;
    option &#039;src_ip&#039; &#039;192.168.33.0/24&#039;
    option &#039;dest_port&#039; &#039;995&#039;
    list &#039;use_interface&#039; &#039;isp2&#039;</code></pre></div><p>/etc/config/firewall<br /></p><div class="codebox"><pre><code>config &#039;defaults&#039;
    option &#039;input&#039; &#039;DROP&#039;
    option &#039;forward&#039; &#039;REJECT&#039;
    option &#039;output&#039; &#039;ACCEPT&#039;
    option &#039;syn_flood&#039; &#039;1&#039;
    option &#039;drop_invalid&#039; &#039;1&#039;

config &#039;zone&#039;
    option &#039;name&#039; &#039;local&#039;
    option &#039;network&#039; &#039;lan&#039;
    option &#039;input&#039; &#039;ACCEPT&#039;
    option &#039;forward&#039; &#039;REJECT&#039;
    option &#039;output&#039; &#039;ACCEPT&#039;

config &#039;zone&#039;
    option &#039;name&#039; &#039;internet&#039;
    option &#039;network&#039; &#039;isp1 isp2 isp3&#039;
    option &#039;input&#039; &#039;DROP&#039;
    option &#039;forward&#039; &#039;DROP&#039;
    option &#039;output&#039; &#039;ACCEPT&#039;
    option &#039;masq&#039; &#039;1&#039;

config &#039;forwarding&#039;
    option &#039;src&#039; &#039;local&#039;
    option &#039;dest&#039; &#039;internet&#039;</code></pre></div><p>With above config you will get these results:<br /></p><div class="codebox"><pre><code>root@mercurius:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         31.151.166.1    0.0.0.0         UG    10     0        0 eth0.1
0.0.0.0         82.168.15.254   0.0.0.0         UG    20     0        0 eth0.2
0.0.0.0         10.64.64.64     0.0.0.0         UG    30     0        0 3g-isp3
10.64.64.64     0.0.0.0         255.255.255.255 UH    0      0        0 3g-isp3
31.151.166.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0.1
82.168.12.0     0.0.0.0         255.255.252.0   U     0      0        0 eth0.2
192.168.33.0    0.0.0.0         255.255.255.0   U     0      0        0 eth1

root@mercurius:~# ip route list table 7
default  metric 1 
    nexthop via 31.151.166.1  dev eth0.1 weight 4
    nexthop via 82.168.15.254  dev eth0.2 weight 1
default via 10.64.64.64 dev 3g-isp3  metric 2
 
root@mercurius:~# ip rule show
0:    from all lookup local 
128:    from 31.151.166.0/24 fwmark 0x0/0x8000 lookup 1 
129:    from 82.168.12.0/22 fwmark 0x0/0x8000 lookup 2 
130:    from 10.64.64.64 fwmark 0x0/0x8000 lookup 4 
256:    from all fwmark 0x100/0xff00 lookup 1 
257:    from all fwmark 0x200/0xff00 lookup 2 
258:    from all fwmark 0x300/0xff00 lookup 3 
259:    from all fwmark 0x400/0xff00 lookup 4 
260:    from all fwmark 0x500/0xff00 lookup 5 
261:    from all fwmark 0x600/0xff00 lookup 6 
262:    from all fwmark 0x700/0xff00 lookup 7 
32766:    from all lookup main 
32767:    from all lookup default

root@mercurius:~# iptables -L -t mangle -v -n
Chain PREROUTING (policy ACCEPT 2991K packets, 2941M bytes)
 pkts bytes target     prot opt in     out     source               destination         
2992K 2941M mwan2_pre  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain INPUT (policy ACCEPT 793K packets, 653M bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 2168K packets, 2286M bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 485K packets, 43M bytes)
 pkts bytes target     prot opt in     out     source               destination         
 485K   43M mwan2_pre  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain POSTROUTING (policy ACCEPT 2652K packets, 2329M bytes)
 pkts bytes target     prot opt in     out     source               destination         
2653K 2329M mwan2_post  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain mwan2_default (1 references)
 pkts bytes target     prot opt in     out     source               destination         
 398K   33M MARK       all  --  *      *       0.0.0.0/0            127.0.0.0/8         mark match 0x0/0xff00 MARK xset 0x8000/0xff00 
32453 2386K MARK       all  --  *      *       0.0.0.0/0            224.0.0.0/3         mark match 0x0/0xff00 MARK xset 0x8000/0xff00 
    0     0 MARK       all  --  *      *       0.0.0.0/0            10.64.64.64         mark match 0x0/0xff00 MARK xset 0x8000/0xff00 
    0     0 MARK       all  --  *      *       0.0.0.0/0            31.151.166.0/24     mark match 0x0/0xff00 MARK xset 0x8000/0xff00 
    0     0 MARK       all  --  *      *       0.0.0.0/0            82.168.12.0/22      mark match 0x0/0xff00 MARK xset 0x8000/0xff00 
18610 1483K MARK       all  --  *      *       0.0.0.0/0            192.168.33.0/24     mark match 0x0/0xff00 MARK xset 0x8000/0xff00 

Chain mwan2_post (1 references)
 pkts bytes target     prot opt in     out     source               destination         
1072K 1367M MARK       all  --  *      eth0.1  0.0.0.0/0            0.0.0.0/0           MARK xset 0x100/0xff00 
    0     0 MARK       all  --  *      3g-isp3  0.0.0.0/0            0.0.0.0/0           MARK xset 0x400/0xff00 
 349K   50M MARK       all  --  *      eth0.2  0.0.0.0/0            0.0.0.0/0           MARK xset 0x200/0xff00 
1231K  912M MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x8000/0x8000 MARK and 0xffff7fff 
2653K 2329M CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0           CONNMARK save mask 0xff00 

Chain mwan2_pre (2 references)
 pkts bytes target     prot opt in     out     source               destination         
3478K 2985M CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0           CONNMARK restore mask 0xff00 
 916K  653M MARK       all  --  eth0.1 *       0.0.0.0/0            0.0.0.0/0           MARK xset 0x8100/0xff00 
    0     0 MARK       all  --  3g-isp3 *       0.0.0.0/0            0.0.0.0/0           MARK xset 0x8400/0xff00 
 689K  878M MARK       all  --  eth0.2 *       0.0.0.0/0            0.0.0.0/0           MARK xset 0x8200/0xff00 
 494K   40M mwan2_default  all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff00 
43553 3426K mwan2_rules  all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff00 

Chain mwan2_rules (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       tcp  --  *      *       192.168.33.0/24      0.0.0.0/0           multiport sports 0:65535 multiport dports 119,563 mark match 0x0/0xff00 MARK xset 0x100/0xff00 
    0     0 MARK       tcp  --  *      *       192.168.33.0/24      0.0.0.0/0           multiport sports 0:65535 multiport dports 995 mark match 0x0/0xff00 MARK xset 0x200/0xff00 
42108 3267K MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff00 MARK xset 0x700/0xff00</code></pre></div>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 5 Feb 2012, 18:22)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p156353">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">xopal</div>
					<div class="post-datetime">
						5 Feb 2012, 18:22					</div>
				</div>
				<div class="post-content content">
					<p>If i disable multiwan my rout -n will be look like this</p><div class="codebox"><pre><code>root@OpenWrt:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.20.31.11     0.0.0.0         UG    0      0        0 3g-ppp0
10.20.31.11     0.0.0.0         255.255.255.255 UH    0      0        0 3g-ppp0
180.251.112.1   0.0.0.0         255.255.255.255 UH    0      0        0 pppoe-wan
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan</code></pre></div><p>May be i miss something in my network configuration or iptables i&#039;ll check it later.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p156354">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						5 Feb 2012, 18:24					</div>
				</div>
				<div class="post-content content">
					<p>You&#039;re missing two static default route entries and uncomment the &quot;defaultroute&quot; &#039;0&quot; options in your /etc/config/network. Look at my config example above.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 5 Feb 2012, 18:39)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p156359">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">xopal</div>
					<div class="post-datetime">
						5 Feb 2012, 19:02					</div>
				</div>
				<div class="post-content content">
					<p>Thank&#039;s Adze it works !!, you just saved my live</p><div class="codebox"><pre><code>root@OpenWrt:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.20.31.3      0.0.0.0         UG    30     0        0 3g-isp2
0.0.0.0         180.251.112.1   0.0.0.0         UG    30     0        0 pppoe-isp1
10.20.31.3      0.0.0.0         255.255.255.255 UH    0      0        0 3g-isp2
180.251.112.1   0.0.0.0         255.255.255.255 UH    0      0        0 pppoe-isp1
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan
root@OpenWrt:~# ip route list table 3
default  metric 1
        nexthop via 10.20.31.3  dev 3g-isp2 weight 6
        nexthop via 180.251.112.1  dev pppoe-isp1 weight 1</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p156361">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						5 Feb 2012, 19:06					</div>
				</div>
				<div class="post-content content">
					<p>Mind you that your current setup is loadbalanced, not active/standby. Loadbalanced on a factor of 6 to 1. If you want active/standby, you should change the metric values.</p><p>Nice to see that its working.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p156376">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">hnsr</div>
					<div class="post-datetime">
						5 Feb 2012, 20:43					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>As i was fiddling with a 3g dongle this weekend, i have managed to setup the following scenario:</p><p>- 2 Wired WAN links (Unlimited traffic, 120/10Mbps cable link and 20/1Mbps dsl link)<br />- 1 Wireless UMTS link (2GB/month, 7,2/2Mbps link)</p></blockquote></div><p>Funny, that&#039;s identical to the setup I was hoping to be able to get going (ziggo cable, a backup dsl line, and vodafone 3g) <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I actually have one complication in my current setup though (not using my OpenWRT router yet), the DSL line is connected to a Vigor modem that does PPPoE pass-through, so I can make use of the native IPv6 connectivity my DSL ISP provdes. Right now I have a non-openwrt router doing the Cable (with NAT and everything), and the Vigor PPPoE connection is terminated on a seperate Gentoo machine that has a very hacky and non-automated setup where it gets the IPv6 prefix-delegation from the DSL ISP using dhcpv6 on the ppp IF, and then it uses that prefix and I have to assign an address of that range to my lan IF so radvd starts announcing it. So right now IPv6 traffic goes (thtough the Gentoo machine) via my DSL line, and IPv4 traffic via my Cable NAT device.</p><p>Do you think such a setup is possible to get going with OpenWRT and more specifically with mwan2? I&#039;m especially unsure about the IPv6 bits, getting the PD via dhcpv6 and then making sure that prefix is used and announced on my LAN seems complicated if not supported by uci.</p><p>Also, I suppose I don&#039;t really need loadbalancing nor an extra 3G backup (maybe I&#039;ll add that later, I don&#039;t have a 3G dongle yet), just being able to failover to DSL should my cable go down would actually be fine for me.</p>											<p class="post-edited">(Last edited by <strong>hnsr</strong> on 5 Feb 2012, 20:44)</p>
									</div>
			</article>

			
		
						<div class="notice">
				<p>Sorry, posts 26 to 25 are missing from our archive.</p>
			</div>
		
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 14</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=33129&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=33129&amp;p=3.html">3</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=33129&amp;p=14.html">14</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>