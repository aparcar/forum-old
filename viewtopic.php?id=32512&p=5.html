<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> TP-Link MR3420v1 16M flash /64M Memory hardware mod with uboot bin</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 4 Apr 2018 and 5 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 5 of 5</div><nav><ul><li><a href="viewtopic.php%3Fid=32512&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=32512&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=32512&amp;p=4.html">4</a></li><li class="pagination-current"><span>5</span></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p247233">
				<div class="post-metadata">
					<div class="post-num">Post #101</div>
					<div class="post-author">JohnV</div>
					<div class="post-datetime">
						16 Sep 2014, 21:50					</div>
				</div>
				<div class="post-content content">
					<p>OK, I have some more info, and maybe this will help someone help me.&nbsp; Wow, has this been hard to sort out.</p><p>It appear that MR3220 uses AR9285 WLAN.</p><p>The board I have uses AR9281 WLAN.</p><p>So it would appear I need to change my standard build for MR3220 to support AR9281 instead of AR9285.</p><p>I assumed any AR WLAN card would work ok since they are all supported by ath9k drivers, but I think I am wrong.&nbsp; That there must be something specific to the MR3220 config that knows what type of WLAN is installed.</p><p>Any comments?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p269200">
				<div class="post-metadata">
					<div class="post-num">Post #102</div>
					<div class="post-author">swiftgeek</div>
					<div class="post-datetime">
						19 Mar 2015, 08:43					</div>
				</div>
				<div class="post-content content">
					<p>#1 is so unreadable that i had to translate it :D<br />(Formatting post in progress)</p><p>• Compile guide<br />&nbsp; &nbsp; ∘ Create new user for it - because you will run binaries from unknown source :D<br />&nbsp; &nbsp; ∘ Download this half gig tarball, includes toolchain <br />&nbsp; &nbsp; &nbsp; &nbsp;<a href="http://www.tp-link.com/resources/GPL/mr3420_3220v1.tar.gz">http://www.tp-link.com/resources/GPL/mr … 0v1.tar.gz</a><br />&nbsp; &nbsp; ∘ Apply patch below to file mr3420_3220v1/ap99/boot/u-boot/include/configs/ap99.h <br />&nbsp; &nbsp; &nbsp; &nbsp;<a href="https://gist.github.com/swiftgeek/6128eb9a6c9ad26f9fdf">https://gist.github.com/swiftgeek/6128eb9a6c9ad26f9fdf</a><br />&nbsp; &nbsp; &nbsp; &nbsp;Edit it to your needs afterwards (eg. for 8MiB flash change #define FLASH_SIZE)<br />&nbsp; &nbsp; ∘ Look into ar7240.h for device/setup specific changes (prompt, autoboot)<br />&nbsp; &nbsp; ∘ cd to mr3420_3220v1/build<br />&nbsp; &nbsp; ∘ mv Makefile Makefile.bak<br />&nbsp; &nbsp; ∘ mv Makefile.ap99 Makefile<br />&nbsp; &nbsp; ∘ make BOARD_TYPE=ap99 uboot<br />&nbsp; &nbsp; &nbsp; &nbsp; ∘ Image will appear in mr3420_3220v1/images/ap99/<br />&nbsp; &nbsp; ∘ Additional cosmetic changes:<br />&nbsp; &nbsp; &nbsp; &nbsp; ∘&nbsp; Compile in the future ! (set date to future so compilation timestamp will show future time)<br />• Dump guide<br />&nbsp; &nbsp; ∘ In case of tplinks save u-boot and art partitions, cat /proc/mtd <br /></p><div class="codebox"><pre><code>dev:    size   erasesize  name 
mtd0: 00020000 00010000 &quot;u-boot&quot; 
mtd1: 00110600 00010000 &quot;kernel&quot;
mtd2: 002bfa00 00010000 &quot;rootfs&quot;
mtd3: 000a0000 00010000 &quot;rootfs_data&quot;
mtd4: 00010000 00010000 &quot;art&quot; 
mtd5: 003d0000 00010000 &quot;firmware&quot;</code></pre></div><p>&nbsp; &nbsp; ∘ cat /dev/mtd0 &gt; u-boot_orig.img<br />&nbsp; &nbsp; ∘ cat /dev/mtd4 &gt; art_orig.img<br />&nbsp; &nbsp; ∘ check sizes with du (128KiB, 64KiB)<br />• Merge guide<br />&nbsp; &nbsp; ∘ Since generated uboot image isn&#039;t round 131072 bytes - but has to be not bigger than 127KiB (do not attempt to continue if bigger) - append 0xFF to the end of space dedicated for binary (or instead of using dump, type in values manually like in post #1)  <a href="http://stackoverflow.com/questions/20526198/why-using-conv-notrunc-when-cloning-a-disk-with-dd">Read about notrunc</a><br />&nbsp; &nbsp; ∘ First remove original u-boot (0xFF it!)<br />&nbsp; &nbsp; &nbsp; &nbsp; </p><div class="codebox"><pre><code>dd if=/dev/zero bs=127K count=1 | tr &#039;\000&#039; &#039;\377&#039; | dd of=u-boot_16MiB.img conv=notrunc</code></pre></div><p>&nbsp; &nbsp; ∘ Then insert new u-boot (the binary that you have compiled, from mr3420_3220v1/images/ap99/)<br />&nbsp; &nbsp; &nbsp; &nbsp; </p><div class="codebox"><pre><code>dd if=u-boot_16MiB.bin of=u-boot_16MiB.img conv=notrunc </code></pre></div><p>&nbsp; &nbsp; ∘ Make sure that model/mac/pin prevailed!<br />&nbsp; &nbsp; &nbsp; &nbsp; ∘&nbsp; vim :%!xxd<br />• Flash guide<br />&nbsp; &nbsp; ∘ flashrom layout preparation<br />&nbsp; &nbsp; &nbsp; &nbsp; ∘ grep mtd name (like art) from dmesg<br /></p><div class="codebox"><pre><code>[    0.840000] 0x0000003f0000-0x000000400000 : &quot;art&quot;</code></pre></div><p>&nbsp; &nbsp; &nbsp; &nbsp; ∘ Or even grep like this: <br /></p><div class="codebox"><pre><code># dmesg | grep \&quot; | grep 0x
[    0.770000] 0x000000000000-0x000000020000 : &quot;u-boot&quot;
[    0.780000] 0x000000020000-0x000000130600 : &quot;kernel&quot;
[    0.800000] 0x000000130600-0x0000003f0000 : &quot;rootfs&quot;
[    0.830000] 0x000000350000-0x0000003f0000 : &quot;rootfs_data&quot;
[    0.840000] 0x0000003f0000-0x000000400000 : &quot;art&quot;
[    0.840000] 0x000000020000-0x0000003f0000 : &quot;firmware&quot;  </code></pre></div><p>Basically copy and paste starting points of partitions and &quot;calculate&quot; (size of dumps in bytes in hex -1 + starting point) endings as both addresses are included<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; • For&nbsp; 4MiB (because why would you want more with programmer being so slow?), save as file eg. TODO &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p><div class="codebox"><pre><code>00000000:0001ffff u-boot 
0003f000:0003fffff art</code></pre></div><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; • For 16MiB <br /></p><div class="codebox"><pre><code>00000000:0001ffff u-boot 
00ff0000:00ffffff art</code></pre></div><p>&nbsp; &nbsp; ∘ arduino serprog as example programmer for everyone<br />&nbsp; &nbsp; &nbsp; &nbsp; ∘ <a href="http://flashrom.org/Serprog/Arduino_flasher">http://flashrom.org/Serprog/Arduino_flasher</a><br />&nbsp; &nbsp; &nbsp; &nbsp; ∘ Prepare image of whole flash (even if you are only flashing one partitiion)<br /></p><div class="codebox"><pre><code>dd if=/dev/zero bs=16777216 count=1 | tr &#039;\000&#039; &#039;\377&#039; | dd of=total.img conv=notrunc
dd if=./u-boot_16MiB.img of=total.img conv=notrunc
dd if=./art_orig.img of=total.img conv=notrunc obs=16320k seek=1</code></pre></div><p>&nbsp; &nbsp; &nbsp; &nbsp; ∘ Either use buffers to get right voltage levels or power whole duino board from 3v3 (like eg. nanino) and connect flash directly<br /></p><div class="codebox"><pre><code>flashrom -p serprog:dev=/dev/ttyUSB0:2000000  -l nor-16MiB.layout -i art -i u-boot -w total.img</code></pre></div><p>&nbsp; &nbsp; ∘ the rest from uboot tftp method (or if something goes wrong and u-boot still woks)<br />&nbsp; &nbsp; &nbsp; &nbsp; ∘ tftpgui is fastest to run/setup on linux desktop, but do not forget about disabling firewall/adding rules in firewall for it<br />&nbsp; &nbsp; &nbsp; &nbsp; ∘ <a href="https://github.com/pepe2k/u-boot_mod#using-uart-u-boot-console-and-tftp-server">https://github.com/pepe2k/u-boot_mod#us … ftp-server</a><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; • Only typing &quot;tpl&quot; string is needed - no need for pressing enter after it to break from autoboot<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; • Mind correct offsets and sizes (eg. 3420v1 bootloader + config has 128KiB - 0x2000). Size is provided as result of tftpboot command. U-boot offsets are using ¿physical address space - not address space of mtd device!<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; • Go first with tftpboot to get line: <br /> </p><div class="codebox"><pre><code>&quot;Bytes transferred = 3932160 (3c0000 hex)&quot; </code></pre></div><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; just for double checking size for flash/erase<br />&nbsp; &nbsp; ∘ Other ways than uboot¿?<br />&nbsp; &nbsp; &nbsp; &nbsp; ∘ kermit is too slow (theretical max of ?14KiB/s)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://blackfin.uclinux.org/doku.php?id=bootloaders:u-boot:serial_port_loading_files">http://blackfin.uclinux.org/doku.php?id … ding_files</a></p><p>Varia:<br />ART partition can differ (very) slightly from board to board - same hwrev! (at least on hwrev1.2 of mr3420)</p><p>Autoboot with escape (ar7240.h)<br /></p><div class="codebox"><pre><code>#define CONFIG_AUTOBOOT_STOP_STR &quot;\x1b&quot;
#define CONFIG_AUTOBOOT_PROMPT   &quot;Hit ESC key to stop autoboot: %d\n&quot;</code></pre></div><p>u-boot mod is not explicitly needed as long as you copy art partition properly - it will boot stock images just fine. You just won&#039;t be able to access anything past 4MiB from u-boot</p>											<p class="post-edited">(Last edited by <strong>swiftgeek</strong> on 19 Mar 2015, 09:48)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 5 of 5</div><nav><ul><li><a href="viewtopic.php%3Fid=32512&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=32512&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=32512&amp;p=4.html">4</a></li><li class="pagination-current"><span>5</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>