<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> CNAME does not work</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 29 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p293541">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">Steijn_van_Essen</div>
					<div class="post-datetime">
						26 Sep 2015, 15:18					</div>
				</div>
				<div class="post-content content">
					<p>Dear community,</p><p>I&#039;ve been working with OpenWRT 10.03.1 (Backfire) on a Netgear WNdR3800 wireless router for three years flawlessly. However, when I want to add aliasses I noticed this can not be accomplished through the LuCI (GUI) (or can it?!).<br />Then I found that I could achieve aliassing through the &#039;cname&#039; construct in /etc/config/dhcp. However, it doesn&#039;t work for me.<br />Eventually I stumbled upon &quot;<a href="https://trent.utfs.org/wiki/OpenWRT#DNS_CNAME">https://trent.utfs.org/wiki/OpenWRT#DNS_CNAME</a>&quot; which confirms that CNAMEs no longer work with the introduction of BackFire.<br />By accident (by having entered two hostnames for the same IP address via LuCI) I discovered that the construct below will give CNAME-ish behaviour.</p><p>Result of LuCI overlapping entries in /etc/config/dhcp:</p><div class="codebox"><pre><code>config &#039;domain&#039;
        option &#039;name&#039; &#039;Client70&#039;
        option &#039;ip&#039; &#039;192.168.141.12&#039;

config &#039;domain&#039;
        option &#039;name&#039; &#039;VMware02&#039;
        option &#039;ip&#039; &#039;192.168.141.12&#039;</code></pre></div><p>Results when resolving these hostnames forward and reverse (using Domain Name Resolver which is much simpler than nslookup):</p><div class="codebox"><pre><code>C:\Users\MyUserID&gt;dnr Client70
Calling gethostbyname() for [Client70]
Name:    Client70.mydomain.sw
IP Address[0]: 192.168.141.12

C:\Users\MyUserID&gt;dnr VMware02
Calling gethostbyname() for [VMware02]
Name:    VMware02.mydomain.sw
IP Address[0]: 192.168.141.12

C:\Users\MyUserID&gt;dnr 192.168.141.12
Calling gethostbyaddr() for [192.168.141.12]
Name:    VMware02.mydomain.sw
IP Address[0]: 192.168.141.12
Alias[0]: Client70.mydomain.sw</code></pre></div><p>Since this is not the official approach I removed this construct and decided to upgrade to OpenWrt 15.05 (Chaos Calmer) last week because I nowhere found evidence of an official fix for BackFire to solve my issue.<br />To my regret CNAMEs still does not work for me with Chaos Calmer. This is what I have in /etc/config/dhcp (partial listing):</p><div class="codebox"><pre><code>config cname
        option cname &#039;Router01-mgt&#039;
        option target &#039;Router01-vl1&#039;

config cname
        option cname &#039;Router01&#039;
        option target &#039;Router01-mgt&#039;

config domain
        option name &#039;Router01-vl1&#039;
        option ip &#039;192.168.141.1&#039;

config domain
        option name &#039;Router01-vl2&#039;
        option ip &#039;192.168.142.1&#039;

config domain
        option name &#039;Router01-vl3&#039;
        option ip &#039;192.168.143.1&#039;</code></pre></div><p><em>Note: I add th *-mgt alias/CNAME because I restrict management of all my gear to interfaces in VLAN 1 (I have 10 VLANs in total in my home network).</em></p><p>/tmp/hosts/dhcp (generated by the dnsmasq start/stop script) looks fine (partial listing):</p><div class="codebox"><pre><code>192.168.141.1 Router01-vl1
192.168.142.1 Router01-vl2
192.168.143.1 Router01-vl3</code></pre></div><p>The same holds for /var/etc/dnsmasq.conf (partial listing):</p><div class="codebox"><pre><code>cname=Router01-mgt,Router01-vl1
cname=Router01,Router01-mgt
cname=CheckPnt-vpn,CheckPnt-dmz</code></pre></div><p>So at least the start/stop script /etc/init.d/dnsmasq has been fixed from BackFire to Chaos Calmer to generate &#039;cname=&#039; entries in /var/etc/dnsmasq.conf again (I think these entries were missing in BackFire).<br />But why am I still not able to resolve my aliasses?</p><div class="codebox"><pre><code>C:\Users\MyUserID&gt;dnr Router01-vl1
Calling gethostbyname() for [Router01-vl1]
Name:    Router01-vl1.swansoft.sw
IP Address[0]: 192.168.141.1

C:\Users\MyUserID&gt;dnr Router01-mgt
Calling gethostbyname() for [Router01-mgt]
Cannot resolve [Router01-mgt]
Socket error 11001: Authoritative Answer Host not found</code></pre></div><p>- Should the &#039;cname&#039; construct work with Chaos Calmer in the first place?<br />- Do I need to activate the use of aliasses somewhere in LuCI or in the dnsmasq configuration?<br />- Does dnsmasq get confused because I mix uppercase and lowercase in DNS names and aliasses?<br />- /tmp/resolv.conf.auto is recreated empty: does it play any role in resolving aliases for internal hosts?</p><p>Anybody any ideas?</p><br /><p>Appreciating any help,</p><p>Steijn van Essen<br /><em>From i8088 to i7-980X in 25 years and still waiting ...</em></p>											<p class="post-edited">(Last edited by <strong>Steijn_van_Essen</strong> on 26 Sep 2015, 15:27)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p293557">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">epek</div>
					<div class="post-datetime">
						26 Sep 2015, 18:22					</div>
				</div>
				<div class="post-content content">
					<p># - Should the &#039;cname&#039; construct work with Chaos Calmer in the first place?</p><p>If you look into /etc/init.d/dnsmasq which is the startup script, that transforms uci notation into dnsmasq configuration parameter, you will find the following at line 504, following:</p><p>dhcp_cname_add() {&nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; local cfg=&quot;$1&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; local cname target&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get cname &quot;$cfg&quot; cname<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$cname&quot; ] || return 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get target &quot;$cfg&quot; target<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$target&quot; ] || return 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; xappend &quot;--cname=${cname},${target}&quot;<br />}&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p><p>Dnsmasq should also support this:<br />dnsmasq -v -&gt; Dnsmasq version 2.73&nbsp; Copyright (c) 2000-2015 Simon Kelley<br />dnsmasq --help | grep -i cname -&gt; --cname=&lt;alias&gt;,&lt;target&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Specify alias name for LOCAL DNS name.</p><p>The notation seems to be correct, so I guess the answer is yes.<br />You can try or work around manually by editing /etc/dnsmasq.conf.</p><p># - Do I need to activate the use of aliasses somewhere in LuCI or in the dnsmasq configuration?<br />I don&#039;t know. LuCI is sometimes a bit behind in development.</p><p>#- Does dnsmasq get confused because I mix uppercase and lowercase in DNS names and aliasses?<br />I don&#039;t know. I guess it shouldn&#039;t. Try to prove your assumption by testing that manually as described above, then file a bug report if necessary.</p><p>#- /tmp/resolv.conf.auto is recreated empty: does it play any role in resolving aliases for internal hosts?<br />The resolv file is defined by the following uci-option in /etc/config/dhcp, section dnsmasq:<br />&nbsp; &nbsp; option resolvfile &#039;/tmp/resolv.conf.auto&#039;<br />Looking into /etc/init.d/dnsmasq we see the following:</p><p>append_parm &quot;$cfg&quot; &quot;resolvfile&quot; &quot;--resolv-file&quot; </p><p>Checking <a href="http://www.thekelleys.org.uk/dnsmasq/docs/dnsmasq-man.html:">http://www.thekelleys.org.uk/dnsmasq/do â€¦ -man.html:</a><br />&quot;-r, --resolv-file=&lt;file&gt;<br />&nbsp; &nbsp; Read the IP addresses of the upstream nameservers from &lt;file&gt;, instead of /etc/resolv.conf. For the format of this file see resolv.conf(5). The only lines relevant to dnsmasq are nameserver ones. Dnsmasq can be told to poll more than one resolv.conf file, the first file name specified overrides the default, subsequent ones add to the list. This is only allowed when polling; the file with the currently latest modification time is the one used. &quot;</p><p>So, in order to answer your question, please have a look at the temporary dnsmasq-configuration, which will tell you, if one or more resolv-files are in use.</p><p>If the resolv.conf.auto (or another file) is using external resolvers instead of localhost, the reasons for your problems are obvious.<br />In that case please use the forwarders (= -S, --local, --server=[/[&lt;domain&gt;]/[domain/]][&lt;ipaddr&gt;[#&lt;port&gt;][@&lt;source-ip&gt;|&lt;interface&gt;[#&lt;port&gt;]], see thekelleys links above, instead. LuCI provides these settings too.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p293572">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">slh</div>
					<div class="post-datetime">
						26 Sep 2015, 20:29					</div>
				</div>
				<div class="post-content content">
					<p>CNAMEs are working, but you need to specify the FQDN for cname and target:</p><div class="codebox"><pre><code>config cname
        option cname &#039;xyz.lan&#039;
        option target &#039;abc.lan&#039;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p293838">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">Steijn_van_Essen</div>
					<div class="post-datetime">
						28 Sep 2015, 23:39					</div>
				</div>
				<div class="post-content content">
					<p><span class="bbu">@slh</span>: <em><strong>Yep, appending the HLQs did the trick!</strong></em><br />I also tried to add them just on the &#039;option cname&#039; or just on the &#039;option target&#039; line, but that did not work. As you said: they are needed on both statements.</p><p>I never tried adding the HLQs (high level qualifiers) because <a href="http://wiki.openwrt.org/doc/uci/dhcp">http://wiki.openwrt.org/doc/uci/dhcp</a> suggests HLQs are not needed:</p><div class="quotebox"><blockquote><p><strong>CNAME RR</strong></p><p>To specify that the web server also doubles as the FTP server (at least in name), one might use:</p><div class="codebox"><pre><code>config &#039;cname&#039;
    option cname &#039;ftp&#039;
    option target &#039;www&#039;</code></pre></div></blockquote></div><p><span class="bbu">@slh &amp; epek</span>:</p><p>I think there is more content on this wiki page that is no longer accurate. F.e.</p><div class="quotebox"><blockquote><p><strong>Using plain dnsmasq.conf</strong></p><p>It is possible to mix the traditional /etc/dnsmasq.conf configuration file with the options found in /etc/config/dhcp.</p><p>The dnsmasq.conf file does not exist by default but will be processed by dnsmasq on startup if it is present. Note that options in /etc/config/dhcp take precendence over dnsmasq.conf since they are translated to command line arguments.</p></blockquote></div><p>First, I think&nbsp; the &quot;are translated to command line arguments&quot; part no longer holds (according to <a href="https://dev.openwrt.org/ticket/13576).">https://dev.openwrt.org/ticket/13576).</a> Agree?!<br />Second, when I was struggling to make CNAMEs work and added some &#039;cname=...&#039; lines to /etc/dnsmasq.conf domain name resolving abruptly seized to work with a message in the system log inicating that dnsmasq could not be started because of duplicate cname entries which to me indicates that the contents of /etc/config/dhcp does not take precedence over the contents of /etc/dnsmasq.conf. Right?!</p><p><span class="bbu">@epek</span>: You write:</p><div class="quotebox"><blockquote><p>The notation seems to be correct, so I guess the answer is yes.<br />You can try or work around manually by editing /etc/dnsmasq.conf.</p></blockquote></div><p>Your right twice (as my findings - with the help of slh - now prove).</p><p>And further: no need to explicitly tell dnsmasq (through LuCI or the CLI) that it needs to start resolving CNAMEs. And yes: we were both right on this: mixing upper/lower case shouldn&#039;t be a problem.<br />With respect to &#039;resolve.conf.auto&#039;: thanks for the elaborate explanation. I already found part of the<br />answer, but wasn&#039;t yet aware of all details. FYI: I did not touch this part of the config so I didn&#039;t bother checking.</p><p><span class="bbu">@epek &amp; slh and the OpenWRT community</span>:</p><p>Thanks for your quick response and good help!</p><p>And if anybody takes an interest in how I use IPtables on OpenWRT to configure NAT on my management VLAN 1 to allow my hosts to have a separate mgmt and data interface without the need to configure static routes on each of them I&#039;ll be more than willing to share this with you ... ;-)</p><br /><p>Steijn van Essen<br /><em>From i8088 to i7-980X in 25 years and still waiting ...</em></p>											<p class="post-edited">(Last edited by <strong>Steijn_van_Essen</strong> on 28 Sep 2015, 23:46)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>