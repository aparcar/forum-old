<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Bootloader/Image for a DLink DWL-2100AP</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 26 Mar 2018 and 5 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 6 of 15</div><nav><ul><li><a href="viewtopic.php%3Fid=6357&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=6357&amp;p=4.html">4</a></li><li><a href="viewtopic.php%3Fid=6357&amp;p=5.html">5</a></li><li class="pagination-current"><span>6</span></li><li><a href="viewtopic.php%3Fid=6357&amp;p=7.html">7</a></li><li><a href="viewtopic.php%3Fid=6357&amp;p=8.html">8</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=6357&amp;p=15.html">15</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p51652">
				<div class="post-metadata">
					<div class="post-num">Post #126</div>
					<div class="post-author">ramcheck</div>
					<div class="post-datetime">
						2 Jul 2007, 15:26					</div>
				</div>
				<div class="post-content content">
					<p>Hi bitbucket,</p><p>Thank you for your comments and hints.</p><div class="quotebox"><cite>bitbucket wrote:</cite><blockquote><p>(on merging the fis and fconfig) AFAIK, it is default in redboot.</p></blockquote></div><p>Perhaps it is for certain platforms, but it&#039;s certainly not the case for the ap51 (I&#039;m using the reference redboot with your patches and mine). But it&#039;s otherwise a good idea keeping the fis and fconfig together. Actually, with a little tweaking it&#039;s probably possible to merge all the config blocks into a single one. This would required copying the whole block to ram each time a config were updated, but since it&#039;s not done very often, it shouldn&#039;t be a problem.</p><div class="quotebox"><cite>bitbucket wrote:</cite><blockquote><p>I&#039;m using redboot only for loading kernel from flash or from network, so I have removed FIS, configuration (it is hardcoded) and other debugging stuff from redboot.</p></blockquote></div><p>The fis is very convenient for prototyping, but it&#039;s probably unnecessary for production. How do you get rid of the debugging stuff?</p><div class="quotebox"><cite>bitbucket wrote:</cite><blockquote><p>I&#039;ve got different value: about ~100kb between gzip and lzma compressed kernel.</p></blockquote></div><p>Of course that figure varies depending on the kernel config options and I&#039;m probably lucky getting 25%.</p><div class="quotebox"><cite>bitbucket wrote:</cite><blockquote><p>(on detecting code length) ... It is simple, because of flat memory model !</p></blockquote></div><p>I tried that, but at least on one occasion I got the wrong numbers because apparently the linker or gcc had relocated the code, changing the order of each procedure. Do you know how to prevent this from happening?</p><div class="quotebox"><cite>bitbucket wrote:</cite><blockquote><p>(on detecting whether code runs from ROM) This can be made by address value in epc ($14)</p></blockquote></div><p>This probably works, but I was looking for a more portable way. Aren&#039;t there any global variables in redboot that tell you where the ROM is? Then because of the flat memory model it should be just a matter of comparing the pointer of the current function with those values, right?</p><p>Well, now to a completely different issue. I was thinking whether it would be possible to completely replace the original firmware with redboot and openwrt using just the web interface. I think this could be done in stages: first an intermediate image is loaded that will install redboot and a minimal kernel with a web interface. Then this could be used to load a final redboot and openwrt. It would be convenient and would avoid opening the case and so it&#039;s less time-consuming. We have over 200 of these ap&#039;s in the field and opening each of them is certainly not a good prospect.</p><p>Do you think this is possible?</p><p>ramcheck</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51653">
				<div class="post-metadata">
					<div class="post-num">Post #127</div>
					<div class="post-author">ramcheck</div>
					<div class="post-datetime">
						2 Jul 2007, 15:38					</div>
				</div>
				<div class="post-content content">
					<p>Hi erebus,</p><div class="quotebox"><cite>erebus wrote:</cite><blockquote><p>Unfortunately I had to revert it to original ap43 version because of awfully long TFTP downloading time. It takes more than five minutes to load ramdisked linux compared to 13 seconds I&#039;ve had before.<br />May be your 2 to 5 minutes decompression time is somehow related to this? At least I havn&#039;t noticed any slowdown with gzipped kernel on ap43 - it starts almost instantly.</p></blockquote></div><p>Thanks for your testing and feedback. I was suspecting there was something wrong with the ap51 setup. Most things seem much slower than they should be, but my times are not so long as the ones you describe. I&#039;ll be investigating this issue more closely before too long. </p><p>In any case, AFAIK rom is significantly slower than ram and this should reflect in longer decompression times. Unless, of course, the code was copied to ram first.</p><p>ramcheck</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51654">
				<div class="post-metadata">
					<div class="post-num">Post #128</div>
					<div class="post-author">ramcheck</div>
					<div class="post-datetime">
						2 Jul 2007, 15:48					</div>
				</div>
				<div class="post-content content">
					<p>Hi guys,</p><div class="quotebox"><cite>bitbucket wrote:</cite><blockquote><div class="quotebox"><cite>erebus wrote:</cite><blockquote><p>Also I don&#039;t thoroughly understand how bootblocks are described. Are those values sizes or offsets or something else?</p></blockquote></div><p>bootblocks: &lt;offset of 1st block&gt;, &lt;offset of 2nd block&gt; and so on. i.e. these values are offests by which it is possible to erase sector.</p></blockquote></div><p>Isn&#039;t it more like &lt;first block base&gt; &lt;block-length&gt; &lt;block-length&gt; ... etc? In any case the device geometry is available in the CFI and this is a standard in the amd/fujitsu world, so why do we need a hard-coded table?</p><p>ramcheck</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51657">
				<div class="post-metadata">
					<div class="post-num">Post #129</div>
					<div class="post-author">bitbucket</div>
					<div class="post-datetime">
						2 Jul 2007, 16:48					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ramcheck wrote:</cite><blockquote><p>Actually, with a little tweaking it&#039;s probably possible to merge all the config blocks into a single one. This would required copying the whole block to ram each time a config were updated, but since it&#039;s not done very often, it shouldn&#039;t be a problem.</p></blockquote></div><p>It may help, when it will be not enouhg space in flash for software.</p><div class="quotebox"><cite>ramcheck wrote:</cite><blockquote><div class="quotebox"><cite>bitbucket wrote:</cite><blockquote><p>I&#039;m using redboot only for loading kernel from flash or from network, so I have removed FIS, configuration (it is hardcoded) and other debugging stuff from redboot.</p></blockquote></div><p>The fis is very convenient for prototyping, but it&#039;s probably unnecessary for production. How do you get rid of the debugging stuff?</p></blockquote></div><p>If kernel can&#039;t boot from flash, I&#039;ll boot stable version from ram via tftp and use it to replace kernel. </p><div class="quotebox"><cite>bitbucket wrote:</cite><blockquote><p>I&#039;ve got different value: about ~100kb between gzip and lzma compressed kernel.</p></blockquote></div><p>Of course that figure varies depending on the kernel config options and I&#039;m probably lucky getting 25%.</p><div class="quotebox"><cite>ramcheck wrote:</cite><blockquote><div class="quotebox"><cite>bitbucket wrote:</cite><blockquote><p>(on detecting code length) ... It is simple, because of flat memory model !</p></blockquote></div><p>I tried that, but at least on one occasion I got the wrong numbers because apparently the linker or gcc had relocated the code, changing the order of each procedure. Do you know how to prevent this from happening?</p></blockquote></div><p>Check compiler&#039;s assembler output (-S), because linker does not change function layout inside one object (.o). If your function and XXX_end function are in one module - it should work: linker does not change their locations.<br />Also, you may use asm() to make symbol with function size like this:<br /></p><div class="codebox"><pre><code>#include &lt;stdlib.h&gt;

void test(void) {
  printf(&quot;ddd\n&quot;);
  printf(&quot;ddd\n&quot;);
}

asm(&quot;\ntest_size = . - test\n&quot;);

int main(void) {
  extern int *test_size;
  printf(&quot;size=%d\n&quot;,&amp;test_size);
  return 0;
}</code></pre></div><div class="quotebox"><cite>ramcheck wrote:</cite><blockquote><p>This probably works, but I was looking for a more portable way. Aren&#039;t there any global variables in redboot that tell you where the ROM is? Then because of the flat memory model it should be just a matter of comparing the pointer of the current function with those values, right?</p></blockquote></div><p>Check files in /ecos-2.0/packages/hal/mips/&lt;platform&gt;/v2_0/include/pkgconf</p><div class="quotebox"><cite>ramcheck wrote:</cite><blockquote><p>Well, now to a completely different issue. I was thinking whether it would be possible to completely replace the original firmware with redboot and openwrt using just the web interface. I think this could be done in stages: first an intermediate image is loaded that will install redboot and a minimal kernel with a web interface. Then this could be used to load a final redboot and openwrt. It would be convenient and would avoid opening the case and so it&#039;s less time-consuming. We have over 200 of these ap&#039;s in the field and opening each of them is certainly not a good prospect.</p><p>Do you think this is possible?</p></blockquote></div><p>It is not possible to change bootloader from original firmware - it have no access to this part of flash from vxworks.</p><p>The easyest way is: make temporary console cable, connect it to device, from original bootloader command prompt load kernel+ramdisk via tftp, update flash from kernel using mtd. It is about ~10min per device, I think.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51658">
				<div class="post-metadata">
					<div class="post-num">Post #130</div>
					<div class="post-author">bitbucket</div>
					<div class="post-datetime">
						2 Jul 2007, 16:50					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ramcheck wrote:</cite><blockquote><p>so why do we need a hard-coded table?</p></blockquote></div><p>Because driver in rebdoot can&#039;t read geometry from chip, linux and jtag read it from chip and all works fine.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51660">
				<div class="post-metadata">
					<div class="post-num">Post #131</div>
					<div class="post-author">ramcheck</div>
					<div class="post-datetime">
						2 Jul 2007, 17:08					</div>
				</div>
				<div class="post-content content">
					<p>Hi bitbucket,</p><p>Thank you for all the feedback and infos. I&#039;ll get back to development/testing later today.</p><p>ramcheck</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51664">
				<div class="post-metadata">
					<div class="post-num">Post #132</div>
					<div class="post-author">erebus</div>
					<div class="post-datetime">
						2 Jul 2007, 17:34					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bitbucket wrote:</cite><blockquote><p>Because lpt port not so fast, and also you have to use lower jtag data clock speed for unbuffered cable because interference (buffered cable works better), and both cables: wiggler or dlc5 not use dma.</p></blockquote></div><p>That&#039;s clear. I wonder what cable and software was used to achieve results posted in <a href="http://wiki.openwrt.org/OpenWrtDocs/Hardware/D-Link/DWL-2100AP">wiki</a>. After all the DLC5 cable is ubelieveable slow compared to those, so I think there can be some misconfiguration in my setup.<br /></p><div class="quotebox"><cite>bitbucket wrote:</cite><blockquote><p>May be these values are wrong ? because by default (for ihis platform) kernel starts from 0x80041000 , and entry point is at 0x8021e000</p></blockquote></div><p>Thanks for a hint. &quot;exec -b 0x80041000&quot; did the job, but the kernel complains about unexpected IRQ #0 when I type something on console. I&#039;ll try to investigate this issue and why RedBoot decided the kernel base to be at 0x80080000 even this address doesn&#039;t figure in headers according to readelf output.<br /></p><div class="quotebox"><cite>ramcheck wrote:</cite><blockquote><p>I was thinking whether it would be possible to completely replace the original firmware with redboot and openwrt using just the web interface. I think this could be done in stages</p></blockquote></div><p>There are some threads in russian about hacking DWL-2100AP, but the discussion inevitable comes to arguing about BlueBox (the firmware in similiar devices). Someone even wrote tfp unpacker to extract files from original firmware, but it seems nobody had reverse-engineered APIMG1 file that VxWorks loader boots by default.<br />I don&#039;t know if that&#039;s of any use, but Linksys WRT54GS router starting from rev.5 is shipped with VxWorks and multistaged process of reflashing it to linux is described <a href="http://www.bitsum.com/openwiking/owbase/ow.asp?WRT54G5_CFE">here</a>.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51666">
				<div class="post-metadata">
					<div class="post-num">Post #133</div>
					<div class="post-author">ramponis</div>
					<div class="post-datetime">
						2 Jul 2007, 17:45					</div>
				</div>
				<div class="post-content content">
					<p>Hi ramcheck,</p><p>I have tested your new redboot with lzma compression support.<br />I have loaded on the flash openwrt with lzma compression<br />But when i try to load it in memory...</p><div class="codebox"><pre><code>fis load -d vmlinux.bin.l7
decompression error: incorrect gzip header</code></pre></div><p>What&#039;s wrong?</p><p>Wellcome back bitbucket <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p>											<p class="post-edited">(Last edited by <strong>ramponis</strong> on 2 Jul 2007, 17:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51671">
				<div class="post-metadata">
					<div class="post-num">Post #134</div>
					<div class="post-author">bitbucket</div>
					<div class="post-datetime">
						2 Jul 2007, 18:45					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>erebus wrote:</cite><blockquote><p>That&#039;s clear. I wonder what cable and software was used to achieve results posted in <a href="http://wiki.openwrt.org/OpenWrtDocs/Hardware/D-Link/DWL-2100AP">wiki</a>. After all the DLC5 cable is ubelieveable slow compared to those, so I think there can be some misconfiguration in my setup.</p></blockquote></div><p>I&#039;ve tested DLC5 (used to unbrick linksys&#039;es) and WIGGLER cables. Because my DLC5 cable is unbuffered I&#039;m using WIGGLER, which is buffered and works fine at high clock rates.</p><div class="quotebox"><cite>erebus wrote:</cite><blockquote><p>Thanks for a hint. &quot;exec -b 0x80041000&quot; did the job, but the kernel complains about unexpected IRQ #0 when I type something on console. I&#039;ll try to investigate this issue and why RedBoot decided the kernel base to be at 0x80080000 even this address doesn&#039;t figure in headers according to readelf output.</p></blockquote></div><p>I had such a problem when I started to port redboot to 2100AP. Try to &#039;go &lt;startup addr&gt;&#039; in redboot - may be it helps. But redboot must to load elf kernel at the location, which set in elf file. When I&#039;m loading kernel from net - it works right.</p><div class="quotebox"><cite>erebus wrote:</cite><blockquote><p>There are some threads in russian about hacking DWL-2100AP, but the discussion inevitable comes to arguing about BlueBox (the firmware in similiar devices). Someone even wrote tfp unpacker to extract files from original firmware, but it seems nobody had reverse-engineered APIMG1 file that VxWorks loader boots by default.</p></blockquote></div><p>BlueBox by vector from the Ukraine ? It is vxworks driven firmware, so reflash is very simple. Btw, if anybody want to test it - free version at <a href="http://tchk.net/download/ffw.zip">http://tchk.net/download/ffw.zip</a> . I&#039;m never use this firmware, but some people like it.</p><div class="quotebox"><cite>erebus wrote:</cite><blockquote><p>I don&#039;t know if that&#039;s of any use, but Linksys WRT54GS router starting from rev.5 is shipped with VxWorks and multistaged process of reflashing it to linux is described <a href="http://www.bitsum.com/openwiking/owbase/ow.asp?WRT54G5_CFE">here</a>.</p></blockquote></div><p>If you have one-two devices like linksys with vxworks - it is possible to reflash them, but when there are about 500-600 devices, it is too many for reflash using jtag.</p>											<p class="post-edited">(Last edited by <strong>bitbucket</strong> on 2 Jul 2007, 18:57)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51672">
				<div class="post-metadata">
					<div class="post-num">Post #135</div>
					<div class="post-author">ramcheck</div>
					<div class="post-datetime">
						2 Jul 2007, 19:02					</div>
				</div>
				<div class="post-content content">
					<p>Hi ramponis,</p><p>Just like the foneras, you use -l switch for lzma decompression. <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>ramcheck</p><div class="quotebox"><cite>ramponis wrote:</cite><blockquote><p>Hi ramcheck,</p><p>I have tested your new redboot with lzma compression support.<br />I have loaded on the flash openwrt with lzma compression<br />But when i try to load it in memory...</p><div class="codebox"><pre><code>fis load -d vmlinux.bin.l7
decompression error: incorrect gzip header</code></pre></div><p>What&#039;s wrong?</p><p>Wellcome back bitbucket <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p></blockquote></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51673">
				<div class="post-metadata">
					<div class="post-num">Post #136</div>
					<div class="post-author">ramponis</div>
					<div class="post-datetime">
						2 Jul 2007, 19:17					</div>
				</div>
				<div class="post-content content">
					<p>Thank you ramcheck</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51675">
				<div class="post-metadata">
					<div class="post-num">Post #137</div>
					<div class="post-author">ramcheck</div>
					<div class="post-datetime">
						2 Jul 2007, 19:25					</div>
				</div>
				<div class="post-content content">
					<p>Hey bitbucket,</p><div class="quotebox"><cite>bitbucket wrote:</cite><blockquote><p>Because my DLC5 cable is unbuffered I&#039;m using WIGGLER, which is buffered and works fine at high clock rates.</p></blockquote></div><p>What clock rates have you tested with the WIGGLER. I have one, but it&#039;s doesn&#039;t seem faster than my older unbuffered cable. A you using openwince-jtag?</p><p>Another question: how can you do a hard reset with jtag?</p><p>ramcheck</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51676">
				<div class="post-metadata">
					<div class="post-num">Post #138</div>
					<div class="post-author">ramcheck</div>
					<div class="post-datetime">
						2 Jul 2007, 20:05					</div>
				</div>
				<div class="post-content content">
					<p>Hey guys,</p><p>This is how you put a function in ram. At the function definition, simply declare it like:<br /></p><div class="codebox"><pre><code>int  some_function(void* arg1, unsigned int arg2)
    __attribute__ ((section (&quot;.2ram.some_function&quot;)));</code></pre></div><p>Then just call your function as usual.</p><p>ramcheck</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51684">
				<div class="post-metadata">
					<div class="post-num">Post #139</div>
					<div class="post-author">bitbucket</div>
					<div class="post-datetime">
						2 Jul 2007, 22:01					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ramcheck wrote:</cite><blockquote><p>What clock rates have you tested with the WIGGLER. I have one, but it&#039;s doesn&#039;t seem faster than my older unbuffered cable. A you using openwince-jtag?</p></blockquote></div><p>Yes, I&#039;m using openwince-jtag, and clock frequency is 0 (i.e. maximum possible). <br />The difference between buffered and unbuffered cables is maximum cable length, at which jtag works without errors. I have a lot of electronics at my workplace, so for sure that all data from jtag are correct I had made buffered WIGGLER cable. </p><div class="quotebox"><cite>ramcheck wrote:</cite><blockquote><p>Another question: how can you do a hard reset with jtag?</p></blockquote></div><p>OCD commander have this function, and it works. But I like to unplug power supply and plug it back. <br />All debugging for redboot I&#039;ve done from windows version of ocd commander. Also, some of redboot builds I had loaded via jtag directly to RAM. It is fast enought.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51685">
				<div class="post-metadata">
					<div class="post-num">Post #140</div>
					<div class="post-author">bitbucket</div>
					<div class="post-datetime">
						2 Jul 2007, 22:16					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ramcheck wrote:</cite><blockquote><p>This is how you put a function in ram. At the function definition, simply declare it like:<br /></p><div class="codebox"><pre><code>int  some_function(void* arg1, unsigned int arg2)
    __attribute__ ((section (&quot;.2ram.some_function&quot;)));</code></pre></div><p>Then just call your function as usual.</p></blockquote></div><p>To use this definition correctly in your program scope you have to edit linker&#039;s script (.lds file) to set address space for your section &quot;.2ram.some_function&quot;. And don&#039;t forget, that in RAW image you have no symbol table (like in elf file), so you can&#039;t access your section or any symbol by name.</p><p>But, it is not possible to make raw image of such elf file for flash. </p><p>I&#039;ve made redboot from 2 parts: first is part of original bootloader, which check system, setup system and unpack RAM version of redboot from flash to RAM. redboot is loaded to the end of ram, to get linux kernel loaded as it like. After kernel is started I don&#039;t need redboot code any more - it overrided by kernel&#039;s/user&#039;s data. In this case all RAM are used by kernel, and redboot works fast enough from RAM (it loads 3Mb image from tftp in seconds), also it have small size in flash because compression.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51687">
				<div class="post-metadata">
					<div class="post-num">Post #141</div>
					<div class="post-author">ramcheck</div>
					<div class="post-datetime">
						2 Jul 2007, 22:54					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bitbucket wrote:</cite><blockquote><div class="quotebox"><cite>ramcheck wrote:</cite><blockquote><p>This is how you put a function in ram. At the function definition, simply declare it like:<br /></p><div class="codebox"><pre><code>int  some_function(void* arg1, unsigned int arg2)
    __attribute__ ((section (&quot;.2ram.some_function&quot;)));</code></pre></div><p>Then just call your function as usual.</p></blockquote></div><p>To use this definition correctly in your program scope you have to edit linker&#039;s script (.lds file) to set address space for your section &quot;.2ram.some_function&quot;. And don&#039;t forget, that in RAW image you have no symbol table (like in elf file), so you can&#039;t access your section or any symbol by name.</p><p>But, it is not possible to make raw image of such elf file for flash.</p></blockquote></div><p>Why, it seems to have worked for me. No compilation or execution errors/warnings whatsoever, and I&#039;m getting times comparable to when I was copying the code to ram. My guess is that redboot has it&#039;s own resolver/loader. It must have for otherwise all the flash stuff, which uses this principle, would not work. Anyway it seems that the .lds files are inexistent and/or they&#039;re not used in redboot.</p><p>Redboot is for the most part unnecessary, however makes certain things more convenient, at the expense of three flash blocks or less. Not so bad.</p><p>ramcheck</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51690">
				<div class="post-metadata">
					<div class="post-num">Post #142</div>
					<div class="post-author">bitbucket</div>
					<div class="post-datetime">
						3 Jul 2007, 00:08					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ramcheck wrote:</cite><blockquote><p>Why, it seems to have worked for me. No compilation or execution errors/warnings whatsoever, and I&#039;m getting times comparable to when I was copying the code to ram. My guess is that redboot has it&#039;s own resolver/loader.</p></blockquote></div><p>I did not find where in redboot code section &quot;2ram&quot; is copied to RAM. It needs more investigations for me to understand how it works. Thank you for this information.</p><div class="quotebox"><cite>ramcheck wrote:</cite><blockquote><p>It must have for otherwise all the flash stuff, which uses this principle, would not work. Anyway it seems that the .lds files are inexistent and/or they&#039;re not used in redboot.</p></blockquote></div><p>.lds (or .ld) files are needed to link code correct. Main file is placed at buildXXX_PPP/install/lib/target.ld </p><div class="quotebox"><cite>ramcheck wrote:</cite><blockquote><p>Redboot is for the most part unnecessary, however makes certain things more convenient, at the expense of three flash blocks or less. Not so bad.</p></blockquote></div><p>It is usable only for developer, not user. I need more flash for working system, which I will use evry day or week, and does not need any extra features in bootloader, which is used once a year to recover broken firmware.</p><p>A few years ago I&#039;d made linux run on adsl modem with conexant SoC. There were no bootloader at all - only kernel which setup hardware to run linux kernel at start and filesystem.Flash was reprogrammed via usb.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51729">
				<div class="post-metadata">
					<div class="post-num">Post #143</div>
					<div class="post-author">erebus</div>
					<div class="post-datetime">
						3 Jul 2007, 15:10					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>I&#039;ve found why RedBoot assumes kernel base to be at 0x80080000. It is just the value of CYGDAT_REDBOOT_MIPS_LINUX_BOOT_ARGV_ADDR option defined in packages/hal/mips/arch/v2_0/cdl/hal_mips.cdl. It&#039;s never redefined anywhere else so it&#039;s taken by default. This address is used to store user and machine-specific parameters and then passed to kernel. The corresponding function is do_exec in packages/hal/mips/arch/v2_0/src/redboot_linux_exec.c.<br /><strong>WARNING!</strong>If you don&#039;t take care about that, you&#039;ll get a hidden kernel corruption since 0x80080000 points inside linux code. The workaround that bitbucket suggested is to use &quot;go&quot; instead of &quot;exec&quot;.<br />I don&#039;t know what the correct solution is. Defining this option in packages/hal/mips/ap43/v2_0/misc/redboot_ROM.ecm as inferred_value 0x80041000 doesn&#039;t help, because initial jump gets overwritten and I&#039;ve had to specify correct entry point every time. That&#039;s inconvenient because this address can change from one kernel to another. The most funny part is that&#039;s impossible to pass parameters anyway - the kernel ingores them on this platform <img src="https://forum.openwrt.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51733">
				<div class="post-metadata">
					<div class="post-num">Post #144</div>
					<div class="post-author">bitbucket</div>
					<div class="post-datetime">
						3 Jul 2007, 16:53					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>erebus wrote:</cite><blockquote><p>I&#039;ve found why RedBoot assumes kernel base to be at 0x80080000.</p></blockquote></div><p>Redboot have to determine kernel loading address from ELF file, like it does when loading file from network.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51744">
				<div class="post-metadata">
					<div class="post-num">Post #145</div>
					<div class="post-author">erebus</div>
					<div class="post-datetime">
						3 Jul 2007, 19:39					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bitbucket wrote:</cite><blockquote><p>Redboot have to determine kernel loading address from ELF file, like it does when loading file from network.</p></blockquote></div><p>RedBoot loads kernel to correct address. The problem is with &quot;exec&quot; command and I&#039;ve encountered it exactly during booting trunk kernel from network, though it affects FIS stored kernels too. Take a look what RedBoot says after you order it to &quot;exec&quot; but before it jumps to Linux. Base address equals to 0x80080000 independent of what is in ELF header. You may want to examine redboot_linux_exec.c to see that redboot writes some parameters (memory size, console port setup, MAC address) to this address in order to pass them to kernel.</p><p>A not-so-quick test:<br />1. Load kernel from network and do &quot;exec&quot;. Then do &quot;reboot&quot; to get back into RedBoot. Examine interesting region with &quot;dump -b 0x80080000 -l 0x100&quot;. You can even see some human-readable strings like &quot;memsize&quot; and &quot;modetty&quot; there. Load kernel again and do &quot;exec 0x80041000&quot;. Kernel boots ok.<br />2. Load kernel from network and do &quot;exec -b 0x80041000&quot;. The do &quot;reboot&quot; to get back into RedBoot. Examine interesting regions with &quot;dump -b 0x80080000 -l 0x100&quot; and &quot;dump -b 0x80041000 -l 0x100&quot;. You can see that kernel parameters moved to second location. Load kernel again and do &quot;exec -b 0x80041000 0x80041000&quot;. RedBoot panics because parameters has overwritten initial jump.<br />3. Disassemble kernel with debug symbols (located in build_mips/linux/vmlinux) via objdump. Go to 0x80080000 - you&#039;ll probably end up within some kernel function.</p><p>I think it&#039;s worth to bear in mind these side-effects of &quot;exec&quot; command.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51757">
				<div class="post-metadata">
					<div class="post-num">Post #146</div>
					<div class="post-author">ramcheck</div>
					<div class="post-datetime">
						3 Jul 2007, 21:29					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bitbucket wrote:</cite><blockquote><div class="quotebox"><cite>ramcheck wrote:</cite><blockquote><p>so why do we need a hard-coded table?</p></blockquote></div><p>Because driver in rebdoot can&#039;t read geometry from chip, linux and jtag read it from chip and all works fine.</p></blockquote></div><p>A nice cfi-compliant driver is in the oven and it looks promising... preliminary results below. The only critical information that is a bit harder to obtain from the chips is the geometry of the boot blocks. For that, it seems that the PRI (which is optional) is required. At the present stage, my driver should be able to recover that information from PRI versions 1.0 throug 1.3. This covers all the flash devices that have been seen in the DWL-2100AP&#039;s. </p><p>Good hacking,<br />ramcheck</p><div class="codebox"><pre><code>RedBoot startup
Detected CFI-compliant device
Device size 0x00400000
Number of erase regions: 2
Erase region 1, block size=0x00010000, count=63
Erase region 2, block size=0x00002000, count=8
Block size 0x00010000, block_count 64
Primary extended information version 1.0.
Boot blocks type: 2
Flash block table:
0x00000000
0x00002000
0x00002000
0x00002000
0x00002000
0x00002000
0x00002000
0x00002000
0x00002000
Flash initialization sucessfull
...
Copyright (C) 2000, 2001, 2002, Red Hat, Inc.

RAM: 0x80010000-0x81000000, 0x806c1878-0x807d1ce0 available
FLASH: 0xbfc00000 - 0xbffe0000, 62 blocks of 0x00010000 bytes each.
RedBoot&gt;</code></pre></div><p>A RAM image for testing is available <a href="http://www.dm.ufscar.br/profs/waldeck/redboot.img">here</a><br />It&#039;s very easy to test from redboot/tftp and it should not brick your unit (although I offer absolutely no warranties):<br /></p><div class="codebox"><pre><code>RedBoot&gt; load redboot.img
Entry point: 0x80680000, address range: 0x80680000-0x806ac318
RedBoot&gt; exec
...</code></pre></div><p>Beware: this think may shrink your kids and scare your dog! Please leave your feedback.</p>											<p class="post-edited">(Last edited by <strong>ramcheck</strong> on 4 Jul 2007, 04:23)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51805">
				<div class="post-metadata">
					<div class="post-num">Post #147</div>
					<div class="post-author">erebus</div>
					<div class="post-datetime">
						4 Jul 2007, 12:44					</div>
				</div>
				<div class="post-content content">
					<p>Hi ramcheck,</p><p>I&#039;ve tested your version. Seems like it works!<br /></p><div class="codebox"><pre><code>RedBoot&gt; l redboot.img
Entry point: 0x80680000, address range: 0x80680000-0x806ac330
RedBoot&gt; g
+
RedBoot startup
Detected CFI-compliant device
Device size 0x00400000
Number of erase regions: 2
Erase region 1, block size=0x00002000, count=8
Erase region 2, block size=0x00010000, count=63
Block size 0x00010000, block_count 64
Primary extended information version 1.3.
Boot blocks type: 2 (2=bottom, 3=top)
Flash block blocks layout:
0x00000000
0x00002000
0x00002000
0x00002000
0x00002000
0x00002000
0x00002000
0x00002000
0x00002000
Flash initialization sucessfull
Ethernet eth0: MAC address 00:17:xx:xx:xx:xx
IP: 10.10.10.111/255.255.255.0, Gateway: 10.10.10.7
Default server: 10.10.10.7, DNS server IP: 0.0.0.0

RedBoot(tm) bootstrap and debug environment [RAM]
Non-certified release, version v2_0 - built 22:19:06, Jul  3 2007
With changes made by Waldeck Schutzer &lt;waldeck@dm.ufscar.br&gt;


Copyright (C) 2000, 2001, 2002, Red Hat, Inc.

RAM: 0x80010000-0x81000000, 0x806c1888-0x807d1ce0 available
FLASH: 0xbfc00000 - 0xbffe0000, 62 blocks of 0x00010000 bytes each.
RedBoot&gt; fis init -f
About to initialize [format] FLASH image system - continue (y/n)? y
*** Initialize FLASH Image System
... Erase from 0xbfc30000-0xbffc0000: ..........................................
...............
... Erase from 0xbffd0000-0xbffd0000:
... Erase from 0xbffe0000-0xbffe0000:
... Erase from 0xbffd0000-0xbffe0000: .
... Program from 0x80fef000-0x80fff000 at 0xbffd0000: .
RedBoot&gt; fis list
Name              FLASH addr  Mem addr    Length      Entry point
RedBoot           0xBFC00000  0xBFC00000  0x00030000  0x00000000
RedBoot config    0xBFFC0000  0xBFFC0000  0x00001000  0x00000000
FIS directory     0xBFFD0000  0xBFFD0000  0x00010000  0x00000000</code></pre></div><p>That&#039;s a great work and really adds convinience.<br />As the last version of RedBoot has been released 3 years ago, I wonder what it&#039;s current development status is.</p>											<p class="post-edited">(Last edited by <strong>erebus</strong> on 4 Jul 2007, 12:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51815">
				<div class="post-metadata">
					<div class="post-num">Post #148</div>
					<div class="post-author">ramcheck</div>
					<div class="post-datetime">
						4 Jul 2007, 15:54					</div>
				</div>
				<div class="post-content content">
					<p>Hi erebus,</p><p>Thank you for taking your time testing my driver. I just have to parse a few fields in the Common Flash Interface data. It should work for the chips in the DWL2100AP and probably on other boards as well, provided that the flash chip is CFI-compliant versions 1.0 through 1.3. It&#039;s not a full CFI driver though, so we can&#039;t expect it to work everywhere.</p><p>I can see from your logs that you have a different chip than mine. <img src="https://forum.openwrt.org/img/smilies/cool.png" width="15" height="15" alt="cool" /> If I added manufacturer/id parsing, would you mind testing it again? I wonder if it&#039;ll still work for an upper boot block device.</p><div class="quotebox"><cite>erebus wrote:</cite><blockquote><p>Hi ramcheck,</p><p>I&#039;ve tested your version. Seems like it works!</p><p>That&#039;s a great work and really adds convinience.<br />As the last version of RedBoot has been released 3 years ago, I wonder what it&#039;s current development status is.</p></blockquote></div><p>Well RedBoot development may have stalled as a whole, but there&#039;s always room for a few improvements. <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /> I wonder if the stuff I&#039;m doing is of any interest to them.</p><p>Cheers,<br />ramcheck</p><p>Edit: The above changes are available <a href="http://www.dm.ufscar.br/profs/waldeck/redboot.img">here</a>.</p>											<p class="post-edited">(Last edited by <strong>ramcheck</strong> on 4 Jul 2007, 21:36)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51862">
				<div class="post-metadata">
					<div class="post-num">Post #149</div>
					<div class="post-author">erebus</div>
					<div class="post-datetime">
						5 Jul 2007, 12:15					</div>
				</div>
				<div class="post-content content">
					<p>Hi ramcheck,</p><p>I&#039;ve tried your bootloader. Here&#039;s the output:<br /></p><div class="codebox"><pre><code>RedBoot startup

Detected flash, manufacturer=0x0001, id codes=(0x7e 0x1a 0x00)
Detected CFI-compliant device
Device size 0x00400000
Number of erase regions: 2
Erase region 1, block size=0x00002000, count=8
Erase region 2, block size=0x00010000, count=63
Block size 0x00010000, block_count 64
Primary extended information version 1.3.
Boot blocks type: 2 (2=bottom, 3=top)
Flash block blocks layout:
0x00000000
0x00002000
0x00002000
0x00002000
0x00002000
0x00002000
0x00002000
0x00002000
0x00002000
Flash initialization sucessfull</code></pre></div><p>Onboard flash chip is Spansion S29GL032M90TFIR4.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p51872">
				<div class="post-metadata">
					<div class="post-num">Post #150</div>
					<div class="post-author">ramcheck</div>
					<div class="post-datetime">
						5 Jul 2007, 16:24					</div>
				</div>
				<div class="post-content content">
					<p>Hi erebus,</p><p>Thank you for the test.</p><div class="quotebox"><cite>erebus wrote:</cite><blockquote><p>Onboard flash chip is Spansion S29GL032M90TFIR4.</p></blockquote></div><p>That&#039;s what I was going to say if you hadn&#039;t said so. I feel encouraged by the fact that, although I have built and tested on a completely different chip, the code also works fine for your chip. Now I have to do a some code polishing, remove the debugging stuff and post the patches somewhere. Unfortunately I&#039;m having difficulties with my ISP at this moment and I must find an alternative place to host my stuff.</p><p>ramcheck</p><p>Edit: I&#039;m working on some parts of the driver that are still hardwired, like the support for the different operation modes, serial/parallel arrangement, etc. I should soon have a driver that relies solely on the CFI data and hence should work everywhere. Patience makes the perfect...</p>											<p class="post-edited">(Last edited by <strong>ramcheck</strong> on 6 Jul 2007, 01:46)</p>
									</div>
			</article>

			
		
						<div class="notice">
				<p>Sorry, posts 151 to 150 are missing from our archive.</p>
			</div>
		
		
	
	<div class="pagination"><div class="pagination-number">Page 6 of 15</div><nav><ul><li><a href="viewtopic.php%3Fid=6357&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=6357&amp;p=4.html">4</a></li><li><a href="viewtopic.php%3Fid=6357&amp;p=5.html">5</a></li><li class="pagination-current"><span>6</span></li><li><a href="viewtopic.php%3Fid=6357&amp;p=7.html">7</a></li><li><a href="viewtopic.php%3Fid=6357&amp;p=8.html">8</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=6357&amp;p=15.html">15</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>