<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> SQM Qos Interface selection</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 9 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p302423">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">chronoman</div>
					<div class="post-datetime">
						4 Dec 2015, 19:33					</div>
				</div>
				<div class="post-content content">
					<p>Hello, my connection on the wan interface is pppoe. In the interface selection do i choose eth0 or pppoe-wan ?</p>											<p class="post-edited">(Last edited by <strong>chronoman</strong> on 4 Dec 2015, 19:34)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p302518">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						5 Dec 2015, 17:06					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>chronoman wrote:</cite><blockquote><p>Hello, my connection on the wan interface is pppoe. In the interface selection do i choose eth0 or pppoe-wan ?</p></blockquote></div><p>Hi chronoman,</p><p>I would recommend pppoe-wan in that situation.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304337">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">bobptz</div>
					<div class="post-datetime">
						20 Dec 2015, 12:07					</div>
				</div>
				<div class="post-content content">
					<p>Hello moeller0</p><p>I was using eth0.2 and SQM seemed not to have any effect.&nbsp; When I switched to pppoe-wan, I saw a vbig improvement in the <a href="http://www.dslreports.com/speedtest">http://www.dslreports.com/speedtest</a>&nbsp; BufferBloat&nbsp; ratings.&nbsp; Thank you for the tip.</p><p>However, I have trouble setting up my 2nd wan connection.&nbsp; I am using two wans and mwan3.&nbsp; My wan2 is connected to a Motorola SBV5121E cable modem.&nbsp; &nbsp;I followed instructions, all default settings etc.&nbsp; For interface name I use&nbsp; eth0.3.&nbsp; I do not see any other viable option.</p><p>SQM seems to have no effect on this connection.&nbsp; Is eth0.3 the correct interface name to use?</p><p>EDIT:&nbsp; I do see a strange interface name : ifb4pppoe-wan.&nbsp; I tried this out too, it gave me different results but not better, so I dropped it.</p><p>EDIT2:&nbsp; Maybe I was not clear.&nbsp; My problem is that wan2 behaves the same with or without SQM enabled.&nbsp; Could it be that SQM is not started?&nbsp; I have read previous posts, but I assume the problem is fixed.</p>											<p class="post-edited">(Last edited by <strong>bobptz</strong> on 20 Dec 2015, 12:21)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304352">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						20 Dec 2015, 14:23					</div>
				</div>
				<div class="post-content content">
					<p>Hi bobptz,</p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>Hello moeller0</p><p>I was using eth0.2 and SQM seemed not to have any effect.&nbsp; When I switched to pppoe-wan, I saw a vbig improvement in the <a href="http://www.dslreports.com/speedtest">http://www.dslreports.com/speedtest</a>&nbsp; BufferBloat&nbsp; ratings.&nbsp; Thank you for the tip.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; The trick really is to select the highest-level wan interface. If your pppoe-wan lived on top of eth0.2 I think that sqm should also have worked if set-up on eth0.2, but only on pppoe-wan it can actually see the packet header clear enough to allow multi-tier shaping. So if you used simplest.os it would not matter, but for simple.os it would.<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>However, I have trouble setting up my 2nd wan connection.&nbsp; I am using two wans and mwan3.&nbsp; My wan2 is connected to a Motorola SBV5121E cable modem.&nbsp; &nbsp;I followed instructions, all default settings etc.&nbsp; For interface name I use&nbsp; eth0.3.&nbsp; I do not see any other viable option.</p><p>SQM seems to have no effect on this connection.&nbsp; Is eth0.3 the correct interface name to use?</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; No idea, I have never used mwan3 and do not know your setup sufficiently well to even guess.<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>EDIT:&nbsp; I do see a strange interface name : ifb4pppoe-wan.&nbsp; I tried this out too, it gave me different results but not better, so I dropped it.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; This is the intermediate functional block device, which sqm needs to be able to traffic shape ingress traffic. Newer versions od sqm try to hide this fro the user. Since sqm will try to create its own IFB it does not make any sense to select this device, so dropping (or rather not-using it for sqm) is the right thing to do.<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>EDIT2:&nbsp; Maybe I was not clear.&nbsp; My problem is that wan2 behaves the same with or without SQM enabled.&nbsp; Could it be that SQM is not started?&nbsp; I have read previous posts, but I assume the problem is fixed.</p></blockquote></div><p>Which openwrt version are you using, BB, CC or even DD?<br />Could you post the results of the following commends rbi on a shell on the router:</p><p>1) cat /etc/config/sqm</p><p>2) tc -d qdisc</p><p>3) /etc/init.d/sqm stop</p><p>4) SQM_DEBUG=1 /etc/init.d/sqm start ; SQM_DEBUG=1 /etc/init.d/sqm stop</p><p>then look into /var/run/sqm, if there is a file with log or debug in its name please also post the contents here.</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304527">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">bobptz</div>
					<div class="post-datetime">
						21 Dec 2015, 20:27					</div>
				</div>
				<div class="post-content content">
					<p>Hello moeller0</p><p>Thank you for your answer.</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>The trick really is to select the highest-level wan interface. If your pppoe-wan lived on top of eth0.2 I think that sqm should also have worked if set-up on eth0.2, but only on pppoe-wan it can actually see the packet header clear enough to allow multi-tier shaping.</p></blockquote></div><p>So the take home message is to use pppoe-wan.&nbsp; Otherwise I would need to ask what are &quot;higher level wan interface&quot; and &quot;live on top off&quot;. </p><br /><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>&nbsp; &nbsp; However, I have trouble setting up my 2nd wan connection.&nbsp; I am using two wans and mwan3.&nbsp; My wan2 is connected to a Motorola SBV5121E cable modem.&nbsp; &nbsp;I followed instructions, all default settings etc.&nbsp; For interface name I use&nbsp; eth0.3.&nbsp; I do not see any other viable option.</p><p>&nbsp; &nbsp; SQM seems to have no effect on this connection.&nbsp; Is eth0.3 the correct interface name to use?</p></blockquote></div><p>Can we assume that mwan3 does not exist and I only have wan2 active?&nbsp; Here is wan2 setup:</p><p><span class="postimg"><img src="http://s28.postimg.org/cyw3il465/interfaces.png" alt="http://s28.postimg.org/cyw3il465/interfaces.png" /></span></p><p><span class="postimg"><img src="http://s1.postimg.org/9hs6h78an/interface_wan2.png" alt="http://s1.postimg.org/9hs6h78an/interface_wan2.png" /></span></p><p><span class="postimg"><img src="http://s24.postimg.org/vb29znqcl/interface_wan2_2.png" alt="http://s24.postimg.org/vb29znqcl/interface_wan2_2.png" /></span></p><p><span class="postimg"><img src="http://s3.postimg.org/kn9ebuic3/sqm.png" alt="http://s3.postimg.org/kn9ebuic3/sqm.png" /></span></p><br /><p>I am using OpenWrt Chaos Calmer 15.05.&nbsp; I do not know what BB, CC or DD mean.<br />I am also using sqm-scripts ver 1.0.3-1.</p><br /><br /><div class="codebox"><pre><code># cat /etc/config/sqm

config queue
    option qdisc &#039;fq_codel&#039;
    option script &#039;simple.qos&#039;
    option qdisc_advanced &#039;0&#039;
    option linklayer &#039;atm&#039;
    option overhead &#039;44&#039;
    option download &#039;7450&#039;
    option upload &#039;720&#039;
    option enabled &#039;1&#039;
    option interface &#039;pppoe-wan&#039;

config queue
    option qdisc &#039;fq_codel&#039;
    option script &#039;simple.qos&#039;
    option linklayer &#039;none&#039;
    option qdisc_advanced &#039;0&#039;
    option download &#039;9300&#039;
    option upload &#039;825&#039;
    option enabled &#039;1&#039;
    option interface &#039;eth0.3&#039;</code></pre></div><br /><br /><div class="codebox"><pre><code># tc -d qdisc
qdisc fq_codel 0: dev eth0 root refcnt 2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc htb 1: dev eth0.3 root refcnt 2 r2q 10 default 12 direct_packets_stat 0 ver 3.17 direct_qlen 2
qdisc fq_codel 110: dev eth0.3 parent 1:11 limit 1001p flows 1024 quantum 300 target 14.9ms interval 109.9ms ecn 
qdisc fq_codel 120: dev eth0.3 parent 1:12 limit 1001p flows 1024 quantum 300 target 14.9ms interval 109.9ms ecn 
qdisc fq_codel 130: dev eth0.3 parent 1:13 limit 1001p flows 1024 quantum 300 target 14.9ms interval 109.9ms ecn 
qdisc ingress ffff: dev eth0.3 parent ffff:fff1 ---------------- 
qdisc htb 1: dev pppoe-wan root refcnt 2 r2q 10 default 12 direct_packets_stat 0 ver 3.17 direct_qlen 3
 linklayer atm overhead 44 mtu 2047 tsize 512 
qdisc fq_codel 110: dev pppoe-wan parent 1:11 limit 1001p flows 1024 quantum 300 target 17.1ms interval 112.1ms ecn 
qdisc fq_codel 120: dev pppoe-wan parent 1:12 limit 1001p flows 1024 quantum 300 target 17.1ms interval 112.1ms ecn 
qdisc fq_codel 130: dev pppoe-wan parent 1:13 limit 1001p flows 1024 quantum 300 target 17.1ms interval 112.1ms ecn 
qdisc ingress ffff: dev pppoe-wan parent ffff:fff1 ---------------- 
qdisc mq 0: dev wlan0 root 
qdisc fq_codel 0: dev wlan0 parent :1 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc fq_codel 0: dev wlan0 parent :2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc fq_codel 0: dev wlan0 parent :3 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc fq_codel 0: dev wlan0 parent :4 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc htb 1: dev ifb4pppoe-wan root refcnt 2 r2q 10 default 10 direct_packets_stat 0 ver 3.17 direct_qlen 32
 linklayer atm overhead 44 mtu 2047 tsize 512 
qdisc fq_codel 110: dev ifb4pppoe-wan parent 1:10 limit 1001p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc htb 1: dev ifb4eth0.3 root refcnt 2 r2q 10 default 10 direct_packets_stat 0 ver 3.17 direct_qlen 32
qdisc fq_codel 110: dev ifb4eth0.3 parent 1:10 limit 1001p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn </code></pre></div><br /><br /><br /><div class="codebox"><pre><code># /etc/init.d/sqm stop
SQM: /usr/lib/sqm/stop-sqm: Stopping eth0.3
SQM: ifb associated with interface eth0.3: ifb4eth0.3
SQM: /usr/lib/sqm/stop-sqm: ifb4eth0.3 shaper deleted
SQM: /usr/lib/sqm/stop-sqm: ifb4eth0.3 interface deleted
SQM: /usr/lib/sqm/stop-sqm: Stopping pppoe-wan
SQM: ifb associated with interface pppoe-wan: ifb4pppoe-wan
SQM: /usr/lib/sqm/stop-sqm: ifb4pppoe-wan shaper deleted
SQM: /usr/lib/sqm/stop-sqm: ifb4pppoe-wan interface deleted</code></pre></div><br /><br /><div class="codebox"><pre><code># SQM_DEBUG=1 /etc/init.d/sqm start ; SQM_DEBUG=1 /etc/init.d/sqm stop
SQM: /usr/lib/sqm/start-sqm: Starting pppoe-wan
SQM: /usr/lib/sqm/start-sqm: Queue Setup Script: simple.qos
SQM: QDISC htb is useable.
SQM: QDISC fq_codel is useable.
SQM: Starting simple.qos
SQM: ifb associated with interface pppoe-wan: 
SQM: Currently no ifb is associated with pppoe-wan, this is normal during starting of the sqm system.
SQM: Squashing differentiated services code points (DSCP) from ingress.
SQM: STAB: stab mtu 2047 tsize 512 mpu 0 overhead 44 linklayer atm
SQM: get_limit:  CURLIMIT: 1001
SQM: get_target defaulting to auto.
SQM: get_limit:  CURLIMIT: 1001
SQM: get_target defaulting to auto.
SQM: get_limit:  CURLIMIT: 1001
SQM: get_target defaulting to auto.
SQM: egress shaping activated
SQM: QDISC ingress is useable.
SQM: Do not perform DSCP based filtering on ingress. (1-tier classification)
SQM: STAB: stab mtu 2047 tsize 512 mpu 0 overhead 44 linklayer atm
SQM: get_limit:  CURLIMIT: 1001
SQM: get_target defaulting to auto.
SQM: ingress shaping activated
SQM: /usr/lib/sqm/start-sqm: Starting eth0.3
SQM: /usr/lib/sqm/start-sqm: Queue Setup Script: simple.qos
SQM: QDISC htb is useable.
SQM: QDISC fq_codel is useable.
SQM: Starting simple.qos
SQM: ifb associated with interface eth0.3: 
SQM: Currently no ifb is associated with eth0.3, this is normal during starting of the sqm system.
SQM: Squashing differentiated services code points (DSCP) from ingress.
SQM: get_limit:  CURLIMIT: 1001
SQM: get_target defaulting to auto.
SQM: get_limit:  CURLIMIT: 1001
SQM: get_target defaulting to auto.
SQM: get_limit:  CURLIMIT: 1001
SQM: get_target defaulting to auto.
SQM: egress shaping activated
SQM: QDISC ingress is useable.
SQM: Do not perform DSCP based filtering on ingress. (1-tier classification)
SQM: get_limit:  CURLIMIT: 1001
SQM: get_target defaulting to auto.
SQM: ingress shaping activated
SQM: /usr/lib/sqm/stop-sqm: Stopping eth0.3
SQM: ifb associated with interface eth0.3: ifb4eth0.3
SQM: /usr/lib/sqm/stop-sqm: ifb4eth0.3 shaper deleted
SQM: /usr/lib/sqm/stop-sqm: ifb4eth0.3 interface deleted
SQM: /usr/lib/sqm/stop-sqm: Stopping pppoe-wan
SQM: ifb associated with interface pppoe-wan: ifb4pppoe-wan
SQM: /usr/lib/sqm/stop-sqm: ifb4pppoe-wan shaper deleted
SQM: /usr/lib/sqm/stop-sqm: ifb4pppoe-wan interface deleted</code></pre></div><br /><br /><br /><p>/var/run/sqm<br />takes me to:<br />/tmp/run/sqm<br />There I only see this directory:<br />/tmp/run/sqm/available_qdiscs</p>											<p class="post-edited">(Last edited by <strong>bobptz</strong> on 21 Dec 2015, 20:32)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304538">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						21 Dec 2015, 21:11					</div>
				</div>
				<div class="post-content content">
					<p>Hi bobptz</p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>Hello moeller0</p><p>Thank you for your answer.</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>The trick really is to select the highest-level wan interface. If your pppoe-wan lived on top of eth0.2 I think that sqm should also have worked if set-up on eth0.2, but only on pppoe-wan it can actually see the packet header clear enough to allow multi-tier shaping.</p></blockquote></div><p>So the take home message is to use pppoe-wan.&nbsp; Otherwise I would need to ask what are &quot;higher level wan interface&quot; and &quot;live on top off&quot;.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; Yepp, pppoe-wan should the interface to use on this link. pppoe-XXX is sort of a virtual interface the packets of which are transported over the vlan interface eth0.2, so in that sense pppoe sits on top of eth0.2, sorry for not being precise enough.<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>&nbsp; &nbsp; However, I have trouble setting up my 2nd wan connection.&nbsp; I am using two wans and mwan3.&nbsp; My wan2 is connected to a Motorola SBV5121E cable modem.&nbsp; &nbsp;I followed instructions, all default settings etc.&nbsp; For interface name I use&nbsp; eth0.3.&nbsp; I do not see any other viable option.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;According to the images you posted eth0.3 looks correct.<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>&nbsp; &nbsp; SQM seems to have no effect on this connection.&nbsp; Is eth0.3 the correct interface name to use?</p></blockquote></div><p>Can we assume that mwan3 does not exist and I only have wan2 active?&nbsp; Here is wan2 setup:</p><p><span class="postimg"><img src="http://s28.postimg.org/cyw3il465/interfaces.png" alt="http://s28.postimg.org/cyw3il465/interfaces.png" /></span></p><p><span class="postimg"><img src="http://s1.postimg.org/9hs6h78an/interface_wan2.png" alt="http://s1.postimg.org/9hs6h78an/interface_wan2.png" /></span></p><p><span class="postimg"><img src="http://s24.postimg.org/vb29znqcl/interface_wan2_2.png" alt="http://s24.postimg.org/vb29znqcl/interface_wan2_2.png" /></span></p><p><span class="postimg"><img src="http://s3.postimg.org/kn9ebuic3/sqm.png" alt="http://s3.postimg.org/kn9ebuic3/sqm.png" /></span></p><br /><p>I am using OpenWrt Chaos Calmer 15.05.&nbsp; I do not know what BB, CC or DD mean.<br />I am also using sqm-scripts ver 1.0.3-1.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; CC is shoer for Chaos Calmer, BB for Barrier Breaker, DD for designated driver, all openwty releases are names after cocktails ans sind AA attitude adjustment the names are also alliterations. I believe DD receives sqm-scripts updates in a more timely fashion...<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><br /><br /><div class="codebox"><pre><code># cat /etc/config/sqm

config queue
    option qdisc &#039;fq_codel&#039;
    option script &#039;simple.qos&#039;
    option qdisc_advanced &#039;0&#039;
    option linklayer &#039;atm&#039;
    option overhead &#039;44&#039;
    option download &#039;7450&#039;
    option upload &#039;720&#039;
    option enabled &#039;1&#039;
    option interface &#039;pppoe-wan&#039;

config queue
    option qdisc &#039;fq_codel&#039;
    option script &#039;simple.qos&#039;
    option linklayer &#039;none&#039;
    option qdisc_advanced &#039;0&#039;
    option download &#039;9300&#039;
    option upload &#039;825&#039;
    option enabled &#039;1&#039;
    option interface &#039;eth0.3&#039;</code></pre></div></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp;This looks fine.<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><br /><br /><div class="codebox"><pre><code># tc -d qdisc
qdisc fq_codel 0: dev eth0 root refcnt 2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc htb 1: dev eth0.3 root refcnt 2 r2q 10 default 12 direct_packets_stat 0 ver 3.17 direct_qlen 2
qdisc fq_codel 110: dev eth0.3 parent 1:11 limit 1001p flows 1024 quantum 300 target 14.9ms interval 109.9ms ecn 
qdisc fq_codel 120: dev eth0.3 parent 1:12 limit 1001p flows 1024 quantum 300 target 14.9ms interval 109.9ms ecn 
qdisc fq_codel 130: dev eth0.3 parent 1:13 limit 1001p flows 1024 quantum 300 target 14.9ms interval 109.9ms ecn 
qdisc ingress ffff: dev eth0.3 parent ffff:fff1 ---------------- 
qdisc htb 1: dev pppoe-wan root refcnt 2 r2q 10 default 12 direct_packets_stat 0 ver 3.17 direct_qlen 3
 linklayer atm overhead 44 mtu 2047 tsize 512 
qdisc fq_codel 110: dev pppoe-wan parent 1:11 limit 1001p flows 1024 quantum 300 target 17.1ms interval 112.1ms ecn 
qdisc fq_codel 120: dev pppoe-wan parent 1:12 limit 1001p flows 1024 quantum 300 target 17.1ms interval 112.1ms ecn 
qdisc fq_codel 130: dev pppoe-wan parent 1:13 limit 1001p flows 1024 quantum 300 target 17.1ms interval 112.1ms ecn 
qdisc ingress ffff: dev pppoe-wan parent ffff:fff1 ---------------- 
qdisc mq 0: dev wlan0 root 
qdisc fq_codel 0: dev wlan0 parent :1 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc fq_codel 0: dev wlan0 parent :2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc fq_codel 0: dev wlan0 parent :3 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc fq_codel 0: dev wlan0 parent :4 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc htb 1: dev ifb4pppoe-wan root refcnt 2 r2q 10 default 10 direct_packets_stat 0 ver 3.17 direct_qlen 32
 linklayer atm overhead 44 mtu 2047 tsize 512 
qdisc fq_codel 110: dev ifb4pppoe-wan parent 1:10 limit 1001p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc htb 1: dev ifb4eth0.3 root refcnt 2 r2q 10 default 10 direct_packets_stat 0 ver 3.17 direct_qlen 32
qdisc fq_codel 110: dev ifb4eth0.3 parent 1:10 limit 1001p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn </code></pre></div></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; This also looks fine, there is one shaper instance (the lines starting with qdisc htb) for both interfaces and both directions so this should work. When you say sqm on eth0.3 does not work how did you test? And did you reboot before testing? (I ask because under some conditions sqm will not autostart an instance after a reboot). So could you redo your test with pppoe-wan not working (unplug the ethernet cable from the modem?) so mwan3 should switch to eth0.3 AFTER issuing &quot;/etc/init.d/sqm start&quot; Does that work better?<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><br /><br /><div class="codebox"><pre><code># /etc/init.d/sqm stop
SQM: /usr/lib/sqm/stop-sqm: Stopping eth0.3
SQM: ifb associated with interface eth0.3: ifb4eth0.3
SQM: /usr/lib/sqm/stop-sqm: ifb4eth0.3 shaper deleted
SQM: /usr/lib/sqm/stop-sqm: ifb4eth0.3 interface deleted
SQM: /usr/lib/sqm/stop-sqm: Stopping pppoe-wan
SQM: ifb associated with interface pppoe-wan: ifb4pppoe-wan
SQM: /usr/lib/sqm/stop-sqm: ifb4pppoe-wan shaper deleted
SQM: /usr/lib/sqm/stop-sqm: ifb4pppoe-wan interface deleted</code></pre></div><br /><br /><div class="codebox"><pre><code># SQM_DEBUG=1 /etc/init.d/sqm start ; SQM_DEBUG=1 /etc/init.d/sqm stop
SQM: /usr/lib/sqm/start-sqm: Starting pppoe-wan
SQM: /usr/lib/sqm/start-sqm: Queue Setup Script: simple.qos
SQM: QDISC htb is useable.
SQM: QDISC fq_codel is useable.
SQM: Starting simple.qos
SQM: ifb associated with interface pppoe-wan: 
SQM: Currently no ifb is associated with pppoe-wan, this is normal during starting of the sqm system.
SQM: Squashing differentiated services code points (DSCP) from ingress.
SQM: STAB: stab mtu 2047 tsize 512 mpu 0 overhead 44 linklayer atm
SQM: get_limit:  CURLIMIT: 1001
SQM: get_target defaulting to auto.
SQM: get_limit:  CURLIMIT: 1001
SQM: get_target defaulting to auto.
SQM: get_limit:  CURLIMIT: 1001
SQM: get_target defaulting to auto.
SQM: egress shaping activated
SQM: QDISC ingress is useable.
SQM: Do not perform DSCP based filtering on ingress. (1-tier classification)
SQM: STAB: stab mtu 2047 tsize 512 mpu 0 overhead 44 linklayer atm
SQM: get_limit:  CURLIMIT: 1001
SQM: get_target defaulting to auto.
SQM: ingress shaping activated
SQM: /usr/lib/sqm/start-sqm: Starting eth0.3
SQM: /usr/lib/sqm/start-sqm: Queue Setup Script: simple.qos
SQM: QDISC htb is useable.
SQM: QDISC fq_codel is useable.
SQM: Starting simple.qos
SQM: ifb associated with interface eth0.3: 
SQM: Currently no ifb is associated with eth0.3, this is normal during starting of the sqm system.
SQM: Squashing differentiated services code points (DSCP) from ingress.
SQM: get_limit:  CURLIMIT: 1001
SQM: get_target defaulting to auto.
SQM: get_limit:  CURLIMIT: 1001
SQM: get_target defaulting to auto.
SQM: get_limit:  CURLIMIT: 1001
SQM: get_target defaulting to auto.
SQM: egress shaping activated
SQM: QDISC ingress is useable.
SQM: Do not perform DSCP based filtering on ingress. (1-tier classification)
SQM: get_limit:  CURLIMIT: 1001
SQM: get_target defaulting to auto.
SQM: ingress shaping activated
SQM: /usr/lib/sqm/stop-sqm: Stopping eth0.3
SQM: ifb associated with interface eth0.3: ifb4eth0.3
SQM: /usr/lib/sqm/stop-sqm: ifb4eth0.3 shaper deleted
SQM: /usr/lib/sqm/stop-sqm: ifb4eth0.3 interface deleted
SQM: /usr/lib/sqm/stop-sqm: Stopping pppoe-wan
SQM: ifb associated with interface pppoe-wan: ifb4pppoe-wan
SQM: /usr/lib/sqm/stop-sqm: ifb4pppoe-wan shaper deleted
SQM: /usr/lib/sqm/stop-sqm: ifb4pppoe-wan interface deleted</code></pre></div></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; So sqm believes it started instances on both pppoe-wan and eth0.3 successfully, but how are the test results over both links? For testing it is often best to set the shaper to 50% of the line rate so that the effect you expect to see is decidedly not subtle...<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><br /><br /><p>/var/run/sqm<br />takes me to:<br />/tmp/run/sqm<br />There I only see this directory:<br />/tmp/run/sqm/available_qdiscs</p></blockquote></div><br /><p>Okay, so it looks like CC&#039;s sqm-scripts is several revisions old and does not support debug logging yet... Not a problem...</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304547">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">bobptz</div>
					<div class="post-datetime">
						21 Dec 2015, 21:47					</div>
				</div>
				<div class="post-content content">
					<p>Hello moeller0</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>When you say sqm on eth0.3 does not work how did you test? And did you reboot before testing? (I ask because under some conditions sqm will not autostart an instance after a reboot). So could you redo your test with pppoe-wan not working (unplug the ethernet cable from the modem?) so mwan3 should switch to eth0.3 AFTER issuing &quot;/etc/init.d/sqm start&quot; Does that work better?</p></blockquote></div><p>I believe I did.&nbsp; I either turned wan (pppoe-wan) off or I had unplugged the utp cable from the ADSL modem.&nbsp; I also rebooted some times the router.&nbsp; I do not remember the exact conditions but our logic is the same.&nbsp; So I will try to do the tests again as you instructed.</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>And did you reboot before testing?&nbsp; (I ask because under some conditions sqm will not autostart an instance after a reboot).</p></blockquote></div><p>I am sorry?&nbsp; So do you want me to reboot or not before the test?&nbsp; And if some times sqm does not start, is this an SQM bug?&nbsp; This is very serious.&nbsp; What is the purpose of testing and fine tunning, if SQM&nbsp; &nbsp;may not be working when I use the router in production enviroment?</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>For testing it is often best to set the shaper to 50% of the line rate so that the effect you expect to see is decidedly not subtle...</p></blockquote></div><p>I am sorry, how do I set the shapper rate to 50%?</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>So could you redo your test with pppoe-wan not working (unplug the ethernet cable from the modem?) so mwan3 should switch to eth0.3 AFTER issuing &quot;/etc/init.d/sqm start&quot; Does that work better?</p></blockquote></div><p>TEST 1, without SQM:<br />1) I will unplug the wan (ADSL) connection.<br />2) I will uncheck both SQM queues (pppoe-wan and eth0.3).<br />3) I will hard boot the router.<br />4) I wil go to <a href="http://www.dslreports.com/speedtest">http://www.dslreports.com/speedtest</a> and make a test clicking on CABLE.</p><br /><p>TEST 2, with SQM:<br />1) I will check the SQM queue eth0.3<br />2) I will hard boot the router.<br />3) I wil go to <a href="http://www.dslreports.com/speedtest">http://www.dslreports.com/speedtest</a> and make a test clicking on CABLE.</p><p>TEST 3, with SQM:<br />1) I will additionally issue the command: &quot;/etc/init.d/sqm start&quot; <br />2) I wil go to <a href="http://www.dslreports.com/speedtest">http://www.dslreports.com/speedtest</a> and make a test clicking on CABLE.</p><p>I will then compare results from TEST 1, TEST 2 and TEST 3.</p><p>Is this correct?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304551">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						21 Dec 2015, 22:09					</div>
				</div>
				<div class="post-content content">
					<p>Hi bobptz,</p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>Hello moeller0</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>When you say sqm on eth0.3 does not work how did you test? And did you reboot before testing? (I ask because under some conditions sqm will not autostart an instance after a reboot). So could you redo your test with pppoe-wan not working (unplug the ethernet cable from the modem?) so mwan3 should switch to eth0.3 AFTER issuing &quot;/etc/init.d/sqm start&quot; Does that work better?</p></blockquote></div><p>I believe I did.&nbsp; I either turned wan (pppoe-wan) off or I had unplugged the utp cable from the ADSL modem.&nbsp; I also rebooted some times the router.&nbsp; I do not remember the exact conditions but our logic is the same.&nbsp; So I will try to do the tests again as you instructed.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; So to be clear I am talking about two issues here a new test (preferably against <a href="http://speedtest.dslreports.com">http://speedtest.dslreports.com</a> ) with pppoe-wan disabled and a test whether sqm on eth0.3 starts automatically up after a reboot.<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>And did you reboot before testing?&nbsp; (I ask because under some conditions sqm will not autostart an instance after a reboot).</p></blockquote></div><p>I am sorry?&nbsp; So do you want me to reboot or not before the test?</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; Okay, I would like to see the following:<br />1) tc -d qdisc<br />2) reboot<br />3) tc -d qdisc<br />4) # disable pppoe-wan by unplugging the ethernet cable from your modem <br />5) /etc/init.d/sqm start<br />6) set the shaper for eth0.3 to 4500 for download and 500 for upload<br />7) speedtest against <a href="http://speedtest.dslreports.com">http://speedtest.dslreports.com</a><br />8) set the shaper for eth0.3 to 500 for download and 4500 for upload # not a typo, please switch the values<br />9) speedtest against <a href="http://speedtest.dslreports.com">http://speedtest.dslreports.com</a></p><p>post the output of the commands as well as the links for both of these tests, please.</p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>And if some times sqm does not start, is this an SQM bug?&nbsp; This is very serious.&nbsp; What is the purpose of testing and fine tunning, if SQM&nbsp; &nbsp;may not be working when I use the router in production enviroment?</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; We switched sqm to get automatically started by hot-plug events to save around 10 seconds of boot time; later we learned that on some interfaces openwrt does not generate hotplug events and reverted the commit that switched to hotplug only. So if this is the case on your link this is an sqm bug, but one we fixed already. Could you please also post the output of &quot;cat /etc/init.d/sqm&quot; that will show whether your version suffers from the bug or not. The purpose of testing and fine tuning I believe is to catch bugs and misconfigurations before going into production, exactly what are you doing here.<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>For testing it is often best to set the shaper to 50% of the line rate so that the effect you expect to see is decidedly not subtle...</p></blockquote></div><p>I am sorry, how do I set the shapper rate to 50%?</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; The easiest is to use the sqm GUI and put number into the two bandwidth fields that are roughly 50% of the link rates as in your contract, or simply 50% of the values you tried before.<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>So could you redo your test with pppoe-wan not working (unplug the ethernet cable from the modem?) so mwan3 should switch to eth0.3 AFTER issuing &quot;/etc/init.d/sqm start&quot; Does that work better?</p></blockquote></div><p>TEST 1, without SQM:<br />1) I will unplug the wan (ADSL) connection.<br />2) I will uncheck both SQM queues (pppoe-wan and eth0.3).</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; make sure to hit/click &quot;save&amp;apply&quot; in the GUI<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>3) I will hard boot the router.<br />4) I wil go to <a href="http://www.dslreports.com/speedtest">http://www.dslreports.com/speedtest</a> and make a test clicking on CABLE.</p><br /><p>TEST 2, with SQM:<br />1) I will check the SQM queue eth0.3<br />2) I will hard boot the router.<br />3) I wil go to <a href="http://www.dslreports.com/speedtest">http://www.dslreports.com/speedtest</a> and make a test clicking on CABLE.</p><p>TEST 3, with SQM:<br />1) I will additionally issue the command: &quot;/etc/init.d/sqm start&quot; <br />2) I wil go to <a href="http://www.dslreports.com/speedtest">http://www.dslreports.com/speedtest</a> and make a test clicking on CABLE.</p><p>I will then compare results from TEST 1, TEST 2 and TEST 3.</p><p>Is this correct?</p></blockquote></div><p>That is a pretty solid testing plan, that I fully endorse, but please note my additional points above please. In the dslreports speedtest, make sure to activate the high resolution buffer bloat test in the settings; and you might want to set the number of up and downstreams to say 16 each.</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304552">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">bobptz</div>
					<div class="post-datetime">
						21 Dec 2015, 22:19					</div>
				</div>
				<div class="post-content content">
					<p>Hello moeller0</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>In the dslreports speedtest, make sure to activate the high resolution buffer bloat test in the settings; and you might want to set the number of up and downstreams to say 16 each.</p></blockquote></div><p>I am sorry to appear so naive again.&nbsp; How do you do this?&nbsp; I did not see any SETTINGS option.</p><div class="codebox"><pre><code># cat /etc/init.d/sqm
#!/bin/sh /etc/rc.common

START=50

reload()
{
    start
}

restart()
{
    reload
}

start()
{
    /usr/lib/sqm/run.sh start
}

stop()
{
    /usr/lib/sqm/run.sh stop
}

boot()
{
    # We are being run through hotplug scripts, don&#039;t do anything at boot
    logger -t SQM -s &quot;sqm-scripts do nothing at boot, waiting for hotplug events.&quot;
    return 0
}</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304553">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						21 Dec 2015, 22:27					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>Hello moeller0</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>In the dslreports speedtest, make sure to activate the high resolution buffer bloat test in the settings; and you might want to set the number of up and downstreams to say 16 each.</p></blockquote></div><p>I am sorry to appear so naive again.&nbsp; How do you do this?&nbsp; I did not see any SETTINGS option.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; On the page where you select the connection type there is blue green button (the second from the right) showing a small cog, pressing that leads to the settings page; it might be required to get a free account at dslreports to be able to see this page. Hope this helps.<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><div class="codebox"><pre><code># cat /etc/init.d/sqm
#!/bin/sh /etc/rc.common

START=50

reload()
{
    start
}

restart()
{
    reload
}

start()
{
    /usr/lib/sqm/run.sh start
}

stop()
{
    /usr/lib/sqm/run.sh stop
}

boot()
{
    # We are being run through hotplug scripts, don&#039;t do anything at boot
    logger -t SQM -s &quot;sqm-scripts do nothing at boot, waiting for hotplug events.&quot;
    return 0
}</code></pre></div></blockquote></div><p>Okay, so you have a sqm-scripts version that requires hotplug to be functional, but that is easy to fix, simply remove the following lines from /etc/init.d/sqm:<br />boot()<br />{<br />&nbsp; &nbsp; # We are being run through hotplug scripts, don&#039;t do anything at boot<br />&nbsp; &nbsp; logger -t SQM -s &quot;sqm-scripts do nothing at boot, waiting for hotplug events.&quot;<br />&nbsp; &nbsp; return 0<br />}</p><p>Without the boot() function sqm will be started by init and hence is independent of hotplug. Now it is not clear whether that was/is the solution to your eth0.3 issue or not...</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304567">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">bobptz</div>
					<div class="post-datetime">
						22 Dec 2015, 00:49					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; Okay, I would like to see the following:<br />1) tc -d qdisc<br />2) reboot<br />3) tc -d qdisc<br />4) # disable pppoe-wan by unplugging the ethernet cable from your modem <br />5) /etc/init.d/sqm start<br />6) set the shaper for eth0.3 to 4500 for download and 500 for upload<br />7) speedtest against <a href="http://speedtest.dslreports.com">http://speedtest.dslreports.com</a><br />8) set the shaper for eth0.3 to 500 for download and 4500 for upload # not a typo, please switch the values<br />9) speedtest against <a href="http://speedtest.dslreports.com">http://speedtest.dslreports.com</a></p><p>post the output of the commands as well as the links for both of these tests, please.</p></blockquote></div><p>I tried to do the above first.&nbsp; See what I get when I do step #5:<br /></p><div class="codebox"><pre><code>/etc/init.d/sqm start
&#039;bin/sh: can&#039;t open &#039;/etc/rc.common</code></pre></div><p>I am continuing with your test.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304570">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">bobptz</div>
					<div class="post-datetime">
						22 Dec 2015, 01:02					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; Okay, I would like to see the following:<br />1) tc -d qdisc<br />2) reboot<br />3) tc -d qdisc<br />4) # disable pppoe-wan by unplugging the ethernet cable from your modem <br />5) /etc/init.d/sqm start<br />6) set the shaper for eth0.3 to 4500 for download and 500 for upload<br />7) speedtest against <a href="http://speedtest.dslreports.com">http://speedtest.dslreports.com</a><br />8) set the shaper for eth0.3 to 500 for download and 4500 for upload # not a typo, please switch the values<br />9) speedtest against <a href="http://speedtest.dslreports.com">http://speedtest.dslreports.com</a></p><p>post the output of the commands as well as the links for both of these tests, please.</p></blockquote></div><br /><p>1)<br /># tc -d qdisc<br />qdisc fq_codel 0: dev eth0 root refcnt 2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc mq 0: dev wlan0 root <br />qdisc fq_codel 0: dev wlan0 parent :1 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc fq_codel 0: dev wlan0 parent :2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc fq_codel 0: dev wlan0 parent :3 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc fq_codel 0: dev wlan0 parent :4 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn </p><p>2) soft booted the router</p><p>3) <br />#&nbsp; tc -d qdisc<br />qdisc fq_codel 0: dev eth0 root refcnt 2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc mq 0: dev wlan0 root <br />qdisc fq_codel 0: dev wlan0 parent :1 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc fq_codel 0: dev wlan0 parent :2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc fq_codel 0: dev wlan0 parent :3 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc fq_codel 0: dev wlan0 parent :4 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc fq_codel 0: dev pppoe-wan root refcnt 2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn </p><p>4)<br /># disable pppoe-wan by unplugging the ethernet cable from your modem </p><p>5)<br />/etc/init.d/sqm start<br />&#039;bin/sh: can&#039;t open &#039;/etc/rc.common</p><p>6) set the shaper for eth0.3 to 4500 for download and 500 for upload</p><p>7)<br />&lt;a href=&quot;http://www.dslreports.com/speedtest/2302412&quot;&gt;<br />&lt;img src=&quot;http://www.dslreports.com/speedtest/2302412.png&quot;&gt;&lt;/a&gt;</p><p>8) set the shaper for eth0.3 to 500 for download and 4500 for upload # not a typo, please switch the values</p><p>9)<br />&lt;a href=&quot;http://www.dslreports.com/speedtest/2302438&quot;&gt;<br />&lt;img src=&quot;http://www.dslreports.com/speedtest/2302438.png&quot;&gt;&lt;/a&gt;</p><br /><br /><p>Step #5 shows a problem, right?</p><p>Tests #7 and #9 show that SQM has no effect on the line.&nbsp; Am I correct?</p><p>Should I do the rest of the tests?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304572">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">bobptz</div>
					<div class="post-datetime">
						22 Dec 2015, 01:08					</div>
				</div>
				<div class="post-content content">
					<p>There is another problem that I noticed these days.</p><p>If I unplug the UTP cable from the pppoe-wan connection, or I disable the wan interface, then on the SQM queue screen the interface changes to eth0.&nbsp; On the combo box there is no pppoe-wan any more.</p><p>When the pppoe-wan connection is re-established, SQM still shows eto as the interface name.</p><p>Does this mean that every time that the ADSL line goes down and then up, I have to manually select the value pppoe-wan all over again?</p><p>Can you fix this please?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304600">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						22 Dec 2015, 09:44					</div>
				</div>
				<div class="post-content content">
					<p>Hi bobptz,</p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; Okay, I would like to see the following:<br />1) tc -d qdisc<br />2) reboot<br />3) tc -d qdisc<br />4) # disable pppoe-wan by unplugging the ethernet cable from your modem <br />5) /etc/init.d/sqm start<br />6) set the shaper for eth0.3 to 4500 for download and 500 for upload<br />7) speedtest against <a href="http://speedtest.dslreports.com">http://speedtest.dslreports.com</a><br />8) set the shaper for eth0.3 to 500 for download and 4500 for upload # not a typo, please switch the values<br />9) speedtest against <a href="http://speedtest.dslreports.com">http://speedtest.dslreports.com</a></p><p>post the output of the commands as well as the links for both of these tests, please.</p></blockquote></div><p>I tried to do the above first.&nbsp; See what I get when I do step #5:<br /></p><div class="codebox"><pre><code>/etc/init.d/sqm start
&#039;bin/sh: can&#039;t open &#039;/etc/rc.common</code></pre></div><p>I am continuing with your test.</p></blockquote></div><br /><p>Okay, so this is bad, and outside the scope of sqm-scripts. Could you please post the result of:</p><p>cat /etc/init.d/sqm</p><p>cat /etc/rc.common</p><p>As long as running init scripts does not work, sqm will not work at all. You might also see other services failing...</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304601">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						22 Dec 2015, 09:49					</div>
				</div>
				<div class="post-content content">
					<p>Hi bobptz,</p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; Okay, I would like to see the following:<br />1) tc -d qdisc<br />2) reboot<br />3) tc -d qdisc<br />4) # disable pppoe-wan by unplugging the ethernet cable from your modem <br />5) /etc/init.d/sqm start<br />6) set the shaper for eth0.3 to 4500 for download and 500 for upload<br />7) speedtest against <a href="http://speedtest.dslreports.com">http://speedtest.dslreports.com</a><br />8) set the shaper for eth0.3 to 500 for download and 4500 for upload # not a typo, please switch the values<br />9) speedtest against <a href="http://speedtest.dslreports.com">http://speedtest.dslreports.com</a></p><p>post the output of the commands as well as the links for both of these tests, please.</p></blockquote></div><br /><p>1)<br /># tc -d qdisc<br />qdisc fq_codel 0: dev eth0 root refcnt 2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc mq 0: dev wlan0 root <br />qdisc fq_codel 0: dev wlan0 parent :1 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc fq_codel 0: dev wlan0 parent :2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc fq_codel 0: dev wlan0 parent :3 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc fq_codel 0: dev wlan0 parent :4 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; This shows that sqm scripts is not running on any interface at all (the lines starting with &quot;qdisc htb&quot; are completely missing). So something is severely broken right now.<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>2) soft booted the router</p><p>3) <br />#&nbsp; tc -d qdisc<br />qdisc fq_codel 0: dev eth0 root refcnt 2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc mq 0: dev wlan0 root <br />qdisc fq_codel 0: dev wlan0 parent :1 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc fq_codel 0: dev wlan0 parent :2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc fq_codel 0: dev wlan0 parent :3 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc fq_codel 0: dev wlan0 parent :4 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn <br />qdisc fq_codel 0: dev pppoe-wan root refcnt 2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; And things are still broken.<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>4)<br /># disable pppoe-wan by unplugging the ethernet cable from your modem </p><p>5)<br />/etc/init.d/sqm start<br />&#039;bin/sh: can&#039;t open &#039;/etc/rc.common</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; With this being the most likely culprit, if the /etc/init.d/sqm script can not run then sqm will not instantiate. I am sorry to say all the tests further down are basically testing the no-SQM situation.<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>6) set the shaper for eth0.3 to 4500 for download and 500 for upload</p><p>7)<br />&lt;a href=&quot;http://www.dslreports.com/speedtest/2302412&quot;&gt;<br />&lt;img src=&quot;http://www.dslreports.com/speedtest/2302412.png&quot;&gt;&lt;/a&gt;</p><p>8) set the shaper for eth0.3 to 500 for download and 4500 for upload # not a typo, please switch the values</p><p>9)<br />&lt;a href=&quot;http://www.dslreports.com/speedtest/2302438&quot;&gt;<br />&lt;img src=&quot;http://www.dslreports.com/speedtest/2302438.png&quot;&gt;&lt;/a&gt;</p><br /><br /><p>Step #5 shows a problem, right?</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; Yes, and a problem that needs fixing as otherwise sqm will never run.<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><br /><p>Tests #7 and #9 show that SQM has no effect on the line.&nbsp; Am I correct?</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; No, it just shows that with sqm being disabled it has o effect on latency under load...<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><br /><p>Should I do the rest of the tests?</p></blockquote></div><p>No, fixing the init script start up is required first.</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304602">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						22 Dec 2015, 09:58					</div>
				</div>
				<div class="post-content content">
					<p>HI bobptz,</p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>There is another problem that I noticed these days.</p><p>If I unplug the UTP cable from the pppoe-wan connection, or I disable the wan interface, then on the SQM queue screen the interface changes to eth0.&nbsp; On the combo box there is no pppoe-wan any more.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; Fair enough, the pppoe-wan interface is sort of a meta-interface that only exists if there is an &quot;active&quot; PPPoE link/connection, if the link is down it will disappear, so far so good.<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><br /><p>When the pppoe-wan connection is re-established, SQM still shows eto as the interface name.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; Did you log out of the web GUI and log in again? I believe luci might require this to show additional interfaces. But if you actually hit save&amp;apply while the wrong interface name was shown in the GUI you actively changed the configuration and it will stich to eth0 until you change the configuration again. This again is awkward but normal luci behavior as fas I can tell.<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>Does this mean that every time that the ADSL line goes down and then up, I have to manually select the value pppoe-wan all over again?</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; No, if you leave the GUI alone the configuration file wilt change and on reappearance of pppoe-wan hotplug should restart the pre-configured sqm instance. At least that is the theory ans what tests so far have shown to happen, but there might be corner cases...<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>Can you fix this please?</p></blockquote></div><p>Fixing/changing luci behavior is outside of my capabilities, but I believe it is also not really required. SQM sort of requires interfaces to be active during GUI configuration (you can always edit /etc/config/sqm by hand if you want to, and use what ever interface name you want), which I believe is reasonable, since there is no way to tell what interfaces might appear in the future. It is also a bit surprising if encountered for the first time... </p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304652">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">bobptz</div>
					<div class="post-datetime">
						22 Dec 2015, 21:16					</div>
				</div>
				<div class="post-content content">
					<p>Hello moeller0</p><p>Here are the commands you asked me:</p><div class="codebox"><pre><code># cat /etc/init.d/sqm
#!/bin/sh /etc/rc.common

START=50

reload()
{
    start
}

restart()
{
    reload
}

start()
{
    /usr/lib/sqm/run.sh start
}

stop()
{
    /usr/lib/sqm/run.sh stop
}</code></pre></div><br /><br /><br /><br /><div class="codebox"><pre><code># cat /etc/rc.common
#!/bin/sh
# Copyright (C) 2006-2012 OpenWrt.org

. $IPKG_INSTROOT/lib/functions.sh
. $IPKG_INSTROOT/lib/functions/service.sh

initscript=$1
action=${2:-help}
shift 2

start() {
    return 0
}

stop() {
    return 0
}

reload() {
    return 1
}

restart() {
    trap &#039;&#039; TERM
    stop &quot;$@&quot;
    start &quot;$@&quot;
}

boot() {
    start &quot;$@&quot;
}

shutdown() {
    stop
}

disable() {
    name=&quot;$(basename &quot;${initscript}&quot;)&quot;
    rm -f &quot;$IPKG_INSTROOT&quot;/etc/rc.d/S??$name
    rm -f &quot;$IPKG_INSTROOT&quot;/etc/rc.d/K??$name
}

enable() {
    name=&quot;$(basename &quot;${initscript}&quot;)&quot;
    disable
    [ -n &quot;$START&quot; -o -n &quot;$STOP&quot; ] || {
        echo &quot;/etc/init.d/$name does not have a START or STOP value&quot;
        return 1
    }
    [ &quot;$START&quot; ] &amp;&amp; ln -s &quot;../init.d/$name&quot; &quot;$IPKG_INSTROOT/etc/rc.d/S${START}${name##S[0-9][0-9]}&quot;
    [ &quot;$STOP&quot;  ] &amp;&amp; ln -s &quot;../init.d/$name&quot; &quot;$IPKG_INSTROOT/etc/rc.d/K${STOP}${name##K[0-9][0-9]}&quot;
}

enabled() {
    name=&quot;$(basename &quot;${initscript}&quot;)&quot;
    [ -x &quot;$IPKG_INSTROOT/etc/rc.d/S${START}${name##S[0-9][0-9]}&quot; ]
}

depends() {
    return 0
}

help() {
    cat &lt;&lt;EOF
Syntax: $initscript [command]

Available commands:
    start    Start the service
    stop    Stop the service
    restart    Restart the service
    reload    Reload configuration files (or restart if that fails)
    enable    Enable service autostart
    disable    Disable service autostart
$EXTRA_HELP
EOF
}

# for procd
start_service() {
    return 0
}

stop_service() {
    return 0
}

service_triggers() {
    return 0
}

service_running() {
    return 0
}

${INIT_TRACE:+set -x}

. &quot;$initscript&quot;

[ -n &quot;$USE_PROCD&quot; ] &amp;&amp; {
    EXTRA_COMMANDS=&quot;${EXTRA_COMMANDS} running trace&quot;

    . $IPKG_INSTROOT/lib/functions/procd.sh
    basescript=$(readlink &quot;$initscript&quot;)
    rc_procd() {
        procd_open_service &quot;$(basename ${basescript:-$initscript})&quot; &quot;$initscript&quot;
        &quot;$@&quot;
        procd_close_service
    }

    start() {
        rc_procd start_service &quot;$@&quot;
        if eval &quot;type service_started&quot; 2&gt;/dev/null &gt;/dev/null; then
            service_started
        fi
    }

    trace() {
        TRACE_SYSCALLS=1
        start &quot;$@&quot;
    }

    stop() {
        stop_service &quot;$@&quot;
        procd_kill &quot;$(basename ${basescript:-$initscript})&quot; &quot;$1&quot;
    }

    reload() {
        if eval &quot;type reload_service&quot; 2&gt;/dev/null &gt;/dev/null; then
            reload_service &quot;$@&quot;
        else
            start
        fi
    }

    running() {
        service_running &quot;$@&quot;
    }
}

ALL_COMMANDS=&quot;start stop reload restart boot shutdown enable disable enabled depends ${EXTRA_COMMANDS}&quot;
list_contains ALL_COMMANDS &quot;$action&quot; || action=help
[ &quot;$action&quot; = &quot;reload&quot; ] &amp;&amp; action=&#039;eval reload &quot;$@&quot; || restart &quot;$@&quot; &amp;&amp; :&#039;
$action &quot;$@&quot;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304661">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">bobptz</div>
					<div class="post-datetime">
						22 Dec 2015, 22:06					</div>
				</div>
				<div class="post-content content">
					<p>SQM was disabled at the startup screen.&nbsp; It refused to become enabled.&nbsp; I tried to remove it from LUCI and it failed.&nbsp; So I opened a new thread for this issue:<br /><a href="https://forum.openwrt.org/viewtopic.php?id=61697">https://forum.openwrt.org/viewtopic.php?id=61697</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304662">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						22 Dec 2015, 22:18					</div>
				</div>
				<div class="post-content content">
					<p>Hi bobptz,</p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>Hello moeller0</p><p>Here are the commands you asked me:</p><div class="codebox"><pre><code># cat /etc/init.d/sqm
#!/bin/sh /etc/rc.common

START=50

reload()
{
    start
}

restart()
{
    reload
}

start()
{
    /usr/lib/sqm/run.sh start
}

stop()
{
    /usr/lib/sqm/run.sh stop
}</code></pre></div></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; I see you removed the boot() section already, maybe your editor included invisible junk characters? Maybe you can try to re-install the latest sqm-scripts from source, see README.md on <a href="https://github.com/tohojo/sqm-scripts">https://github.com/tohojo/sqm-scripts</a> for instructions. This should get you back to a known working sqm-scripts and /etc/init.d/sqm<br /></p><div class="quotebox"><cite>bobptz wrote:</cite><blockquote><br /><div class="codebox"><pre><code># cat /etc/rc.common
#!/bin/sh
# Copyright (C) 2006-2012 OpenWrt.org

. $IPKG_INSTROOT/lib/functions.sh
. $IPKG_INSTROOT/lib/functions/service.sh

initscript=$1
action=${2:-help}
shift 2

start() {
    return 0
}

stop() {
    return 0
}

reload() {
    return 1
}

restart() {
    trap &#039;&#039; TERM
    stop &quot;$@&quot;
    start &quot;$@&quot;
}

boot() {
    start &quot;$@&quot;
}

shutdown() {
    stop
}

disable() {
    name=&quot;$(basename &quot;${initscript}&quot;)&quot;
    rm -f &quot;$IPKG_INSTROOT&quot;/etc/rc.d/S??$name
    rm -f &quot;$IPKG_INSTROOT&quot;/etc/rc.d/K??$name
}

enable() {
    name=&quot;$(basename &quot;${initscript}&quot;)&quot;
    disable
    [ -n &quot;$START&quot; -o -n &quot;$STOP&quot; ] || {
        echo &quot;/etc/init.d/$name does not have a START or STOP value&quot;
        return 1
    }
    [ &quot;$START&quot; ] &amp;&amp; ln -s &quot;../init.d/$name&quot; &quot;$IPKG_INSTROOT/etc/rc.d/S${START}${name##S[0-9][0-9]}&quot;
    [ &quot;$STOP&quot;  ] &amp;&amp; ln -s &quot;../init.d/$name&quot; &quot;$IPKG_INSTROOT/etc/rc.d/K${STOP}${name##K[0-9][0-9]}&quot;
}

enabled() {
    name=&quot;$(basename &quot;${initscript}&quot;)&quot;
    [ -x &quot;$IPKG_INSTROOT/etc/rc.d/S${START}${name##S[0-9][0-9]}&quot; ]
}

depends() {
    return 0
}

help() {
    cat &lt;&lt;EOF
Syntax: $initscript [command]

Available commands:
    start    Start the service
    stop    Stop the service
    restart    Restart the service
    reload    Reload configuration files (or restart if that fails)
    enable    Enable service autostart
    disable    Disable service autostart
$EXTRA_HELP
EOF
}

# for procd
start_service() {
    return 0
}

stop_service() {
    return 0
}

service_triggers() {
    return 0
}

service_running() {
    return 0
}

${INIT_TRACE:+set -x}

. &quot;$initscript&quot;

[ -n &quot;$USE_PROCD&quot; ] &amp;&amp; {
    EXTRA_COMMANDS=&quot;${EXTRA_COMMANDS} running trace&quot;

    . $IPKG_INSTROOT/lib/functions/procd.sh
    basescript=$(readlink &quot;$initscript&quot;)
    rc_procd() {
        procd_open_service &quot;$(basename ${basescript:-$initscript})&quot; &quot;$initscript&quot;
        &quot;$@&quot;
        procd_close_service
    }

    start() {
        rc_procd start_service &quot;$@&quot;
        if eval &quot;type service_started&quot; 2&gt;/dev/null &gt;/dev/null; then
            service_started
        fi
    }

    trace() {
        TRACE_SYSCALLS=1
        start &quot;$@&quot;
    }

    stop() {
        stop_service &quot;$@&quot;
        procd_kill &quot;$(basename ${basescript:-$initscript})&quot; &quot;$1&quot;
    }

    reload() {
        if eval &quot;type reload_service&quot; 2&gt;/dev/null &gt;/dev/null; then
            reload_service &quot;$@&quot;
        else
            start
        fi
    }

    running() {
        service_running &quot;$@&quot;
    }
}

ALL_COMMANDS=&quot;start stop reload restart boot shutdown enable disable enabled depends ${EXTRA_COMMANDS}&quot;
list_contains ALL_COMMANDS &quot;$action&quot; || action=help
[ &quot;$action&quot; = &quot;reload&quot; ] &amp;&amp; action=&#039;eval reload &quot;$@&quot; || restart &quot;$@&quot; &amp;&amp; :&#039;
$action &quot;$@&quot;</code></pre></div></blockquote></div><p>Okay, this looks fine as far as I can tell, and since you never edited this it should not have changed at all. So I would like to ask you to get the most recent sqm-scripts, install them, set up your configuration (make a copy of /etc/config/sqm before) fresh (enter the values through the GUI), start it, reboot the router and post the result of:</p><p>tc -s qdisc</p><p>right after the reboot finished</p><p>followed by the following 3 commands:</p><p>/etc/init.d/sqm stop<br />SQM_DEBUG=1 SQM_VERBOSITY=8 /etc/init.d/sqm start ; SQM_DEBUG=1 SQM_VERBOSITY=8 /etc/init.d/sqm stop SQM_DEBUG=0 SQM_VERBOSITY=5 /etc/init.d/sqm start</p><br /><p>and then post the console output these command generated (and also the contents of /var/run/sqm/*.debug.log if these are not too large to post).</p><p>Once sqm runs agin, we can tackle the mwan3 issue...</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p304667">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						22 Dec 2015, 22:34					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bobptz wrote:</cite><blockquote><p>SQM was disabled at the startup screen.&nbsp; It refused to become enabled.&nbsp; I tried to remove it from LUCI and it failed.&nbsp; So I opened a new thread for this issue:<br /><a href="https://forum.openwrt.org/viewtopic.php?id=61697">https://forum.openwrt.org/viewtopic.php?id=61697</a></p></blockquote></div><br /><p>I believe these are just symptoms of /etc/init.d/sqm not working (or at least both issues have the same root cause...)</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>