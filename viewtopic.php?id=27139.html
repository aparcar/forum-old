<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Troubleshooting ser2net - OpenWRT controlling central heating</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 1 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p119988">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">japers</div>
					<div class="post-datetime">
						29 Oct 2010, 19:18					</div>
				</div>
				<div class="post-content content">
					<p>I am running the latest 10.03 RC3 of OpenWRT on my Buffalo WZR-HP-G300NH and working on a fun and very useful project - to remotely control my home heating! Winter is coming and I am often away for 2-5 days and I hate coming to a freezing house...</p><p>The&nbsp; principle is that the Thermostats use RS485 so I have used a USB-&gt;RS232 converter and then in turn a RS232-&gt;485 adapter. Someone has succesfully managed to make this work using perl, Telnet.pm and ser2net and I have communicated with him to try and do the same. He has been absolutely great and shared his scripts - for anyone interested in the details, the link is:</p><p><a href="http://desrablog.blogspot.com/2010/01/all-quiet-on-western-front.html">http://desrablog.blogspot.com/2010/01/a â€¦ front.html</a></p><p>Basically I am stuck at the final stage: the USB converter seems to work ok (pl2303 drivers installed) and dmesg shows:</p><p>USB Serial support registered for pl2303<br />usbcore: registered new interface driver pl2303<br />pl2303: Prolific PL2303 USB to serial adaptor driver<br />pl2303 1-1:1.0: pl2303 converter detected<br />usb 1-1: pl2303 converter now attached to ttyUSB0</p><p>I have added a line to ser2net.conf: &quot;2009:raw:5:/dev/ttyUSB0:4800&quot;</p><p>With ser2net, perl and Telnet.pm in all in place and loaded, running the script shows a success but my thermostats do not change their settings and do not report anything back (just blank temps). I know the script reporting a success is just down to the script probably needing tweaking. If ser2net is not loaded or Telnet.pm not in the right directory, I get a script error so I know these elements are working ok.</p><p>By process of elimination, I have tried running the script with the USB cord unplugged - it makes no difference, I get the same blank/success response. So I believe therefore the problem is not with the hardware (also tested hardware using Windows laptop and manufacturer software and worked fine). So I can only deduce there is no communication between ser2net and the USB adapter- I have spent hours looking at the different solutions but in vain.</p><p>I have tried to find out any errors using &quot;logread&quot; but this only reports when ser2net is started/stopped or the usb dis/connected. Is there anyway to get further detailed logs about ser2net comms?</p><p>I am posting this on OpenWRT forums as I know syslogd on OpenWRT is a little unique!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119991">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						29 Oct 2010, 19:49					</div>
				</div>
				<div class="post-content content">
					<p>I think you still need stty to set the baudrate of /dev/ttyUSB0.</p><p>If you don&#039;t mind open the router, you could just use the serial console without converting from USB.</p><p><a href="https://forum.openwrt.org/viewtopic.php?id=27075">OpenWrt / how to change the USB Serial port baud rate by using getty?</a><br /><a href="https://forum.openwrt.org/viewtopic.php?pid=108111#p108111">OpenWrt / Fonera 2100 serial console need urgent help</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120158">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">japers</div>
					<div class="post-datetime">
						1 Nov 2010, 15:34					</div>
				</div>
				<div class="post-content content">
					<p>Thanks very much for the tip fyi, I tried extensive reading about and use of stty but unfortunately it did not work:</p><p>stty -F /dev/ttyUSB0 speed 4800 raw</p><p>The command shows that the new baud rate is 4800 (down from 9600) but the problem remains. Some of the posts on stty also mention setserial - I could not figure out if setserial is an alternative to stty or whether it is complementary and allows different settings?</p><p>Is there anything else I might have missed?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120189">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						2 Nov 2010, 01:03					</div>
				</div>
				<div class="post-content content">
					<p>My usb serial cable works just fine.<br /></p><div class="codebox"><pre><code>opkg install kmod-usb-serial
opkg install kmod-usb-serial-pl2303</code></pre></div><div class="codebox"><pre><code>root@OpenWrt:~# dmesg | grep usb
usb.c: registered new driver usbdevfs
usb.c: registered new driver hub
usb-ohci.c: USB OHCI at membase 0xb8004000, IRQ 2
usb-ohci.c: usb-00:04.0, PCI device 14e4:4715
usb.c: new USB bus registered, assigned bus number 1
usb.c: registered new driver serial
usbserial.c: USB Serial support registered for Generic
usbserial.c: USB Serial Driver core v1.4
usbserial.c: USB Serial support registered for PL-2303
usbserial.c: PL-2303 converter detected
usbserial.c: PL-2303 converter now attached to ttyUSB0 (or usb/tts/0 for devfs)

root@OpenWrt:~# stty -F /dev/usb/tts/0 -a
speed 9600 baud; rows 0; columns 0; line = 0;
intr = ^C; quit = ^\; erase = ^?; kill = ^U; eof = ^D; eol = &lt;undef&gt;;
eol2 = &lt;undef&gt;; swtch = &lt;undef&gt;; start = ^Q; stop = ^S; susp = ^Z; rprnt = ^R;
werase = ^W; lnext = ^V; flush = ^O; min = 1; time = 0;
-parenb -parodd cs8 hupcl -cstopb cread clocal -crtscts
-ignbrk -brkint -ignpar -parmrk -inpck -istrip -inlcr -igncr icrnl ixon -ixoff
-iuclc -ixany -imaxbel
opost -olcuc -ocrnl onlcr -onocr -onlret -ofill -ofdel nl0 cr0 tab0 bs0 vt0 ff0
isig icanon iexten echo echoe echok -echonl -noflsh -xcase -tostop -echoprt
echoctl echoke

root@OpenWrt:~# stty -F /dev/usb/tts/0 speed 4800 raw -echo
9600

root@OpenWrt:~# stty -F /dev/usb/tts/0 -a
speed 4800 baud; rows 0; columns 0; line = 0;
intr = ^C; quit = ^\; erase = ^?; kill = ^U; eof = ^D; eol = &lt;undef&gt;;
eol2 = &lt;undef&gt;; swtch = &lt;undef&gt;; start = ^Q; stop = ^S; susp = ^Z; rprnt = ^R;
werase = ^W; lnext = ^V; flush = ^O; min = 1; time = 0;
-parenb -parodd cs8 hupcl -cstopb cread clocal -crtscts
-ignbrk -brkint -ignpar -parmrk -inpck -istrip -inlcr -igncr -icrnl -ixon -ixoff
-iuclc -ixany -imaxbel
-opost -olcuc -ocrnl onlcr -onocr -onlret -ofill -ofdel nl0 cr0 tab0 bs0 vt0 ff0
-isig -icanon iexten -echo echoe echok -echonl -noflsh -xcase -tostop -echoprt
echoctl echoke

root@OpenWrt:~# stty -F /dev/ttyUSB0 -a
/dev/ttyUSB0: No such file or directory</code></pre></div><p><a href="http://wiki.openwrt.org/inbox/howto/install-usb-support">Installing USB support - OpenWrt Wiki</a><br /><a href="http://www.nslu2-linux.org/wiki/Peripherals/USB2Serial">NSLU2-Linux - Peripherals / USB2Serial browse</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120256">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						3 Nov 2010, 00:50					</div>
				</div>
				<div class="post-content content">
					<div class="codebox"><pre><code>root@OpenWrt:/dev# uname -a
Linux OpenWrt 2.4.35.4 #12 Tue Dec 29 15:30:20 UTC 2009 mips unknown

root@OpenWrt:/dev# ls -l /dev/usb/tts
crw-------    1 root     root     188,   0 Jan  1  1970 0

root@OpenWrt:/dev# mknod -m 644 /dev/ttyUSB0 c 188 0

root@OpenWrt:/dev# ls -l
crw-------    1 root     root       5,   1 Jan  1  1970 console
crw-rw-rw-    1 root     root       1,   7 Jan  1  1970 full
drwxr-xr-x    1 root     root            0 Jan  1  1970 gpio
crw-r-----    1 root     root       1,   2 Jan  1  1970 kmem
srw-rw-rw-    1 root     root            0 Dec 29 23:28 log
crw-r-----    1 root     root       1,   1 Jan  1  1970 mem
drwxr-xr-x    1 root     root            0 Jan  1  1970 mtd
drwxr-xr-x    1 root     root            0 Jan  1  1970 mtdblock
crw-rw-rw-    1 root     root       1,   3 Jan  1  1970 null
crw-r-----    1 root     root     253,   0 Jan  1  1970 nvram
crw-r-----    1 root     root       1,   4 Jan  1  1970 port
crw-------    1 root     root     108,   0 Jan  1  1970 ppp
crw-rw-rw-    1 root     root       5,   2 Dec 29 23:37 ptmx
drwxr-xr-x    2 root     root            0 Jan  1  2000 pts
drwxr-xr-x    1 root     root            0 Jan  1  1970 pty
crw-r--r--    1 root     root       1,   8 Jan  1  1970 random
lr-xr-xr-x    1 root     root           10 Jan  1  2000 root -&gt; mtdblock/2
drwxr-xr-x    1 root     root            0 Jan  1  1970 shm
crw-rw-rw-    1 root     root       5,   0 Jan  1  1970 tty
crw-r--r--    1 root     root     188,   0 Dec 29 23:37 ttyUSB0
crw-r--r--    1 root     root       1,   9 Jan  1  1970 urandom
drwxr-xr-x    1 root     root            0 Jan  1  1970 usb
crw-rw-rw-    1 root     root       1,   5 Jan  1  1970 zero

root@OpenWrt:/dev# stty -F /dev/ttyUSB0 -a
speed 9600 baud; rows 0; columns 0; line = 0;
intr = ^C; quit = ^\; erase = ^?; kill = ^U; eof = ^D; eol = &lt;undef&gt;;
eol2 = &lt;undef&gt;; swtch = &lt;undef&gt;; start = ^Q; stop = ^S; susp = ^Z; rprnt = ^R;
werase = ^W; lnext = ^V; flush = ^O; min = 1; time = 0;
-parenb -parodd cs8 hupcl -cstopb cread clocal -crtscts
-ignbrk -brkint -ignpar -parmrk -inpck -istrip -inlcr -igncr icrnl ixon -ixoff
-iuclc -ixany -imaxbel
opost -olcuc -ocrnl onlcr -onocr -onlret -ofill -ofdel nl0 cr0 tab0 bs0 vt0 ff0
isig icanon iexten echo echoe echok -echonl -noflsh -xcase -tostop -echoprt
echoctl echoke</code></pre></div><p><a href="http://www.faqs.org/docs/linux_admin/x797.html">The mknod command</a><br /><a href="http://www.lanana.org/docs/device-list/">LANANA Linux Device List</a><br /><a href="http://svn.dd-wrt.com:8000/dd-wrt/browser/src/linux/ar531x/linux-2.6.24/Documentation/serial-console.txt">http://svn.dd-wrt.com:8000/dd-wrt/brows â€¦ onsole.txt</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120310">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">japers</div>
					<div class="post-datetime">
						3 Nov 2010, 17:17					</div>
				</div>
				<div class="post-content content">
					<p>Thanks very much for all the info fyi, much appreciated. I had installed the correct kmod drivers as you recommended but you have given me a lot of tips and pointers to digest here. I am away for a few days but when I get back I will give all of them a go and report back!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120329">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						3 Nov 2010, 23:41					</div>
				</div>
				<div class="post-content content">
					<p>I think you don&#039;t need stty to set the port speed because ser2net should be able to take care of it. I install Kamikaze brcm-2.4 on my ASUS WL-HDD2.5. The filesystem is devfs so I have to create /dev/ttyUSB0 by mknod.</p><p>Maybe you shouldn&#039;t omit detailed protocol options in /etc/ser2net.conf:<br /></p><div class="codebox"><pre><code>2009:raw:60:/dev/ttyUSB0:4800 NONE 1STOPBIT 8DATABITS -XONXOFF LOCAL -RTSCTS</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120687">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">japers</div>
					<div class="post-datetime">
						9 Nov 2010, 17:44					</div>
				</div>
				<div class="post-content content">
					<p>OK thanks again fyi,&nbsp; I have had a good play and research around with all the info you provided but with no success sadly. Firstly, the driver situation:</p><div class="codebox"><pre><code>root@OpenWrt:/# dmesg | grep usb
Registered led device: wzr-hp-g300nh:blue:usb
usbcore: registered new interface driver usbfs
usbcore: registered new interface driver hub
usbcore: registered new device driver usb
usb usb1: configuration #1 chosen from 1 choice
usb 1-1: new full speed USB device using ar71xx-ehci and address 2
usb 1-1: configuration #1 chosen from 1 choice
usbcore: registered new interface driver usbserial
usbcore: registered new interface driver usbserial_generic
usbserial: USB Serial Driver core
usbcore: registered new interface driver usb-storage
usbcore: registered new interface driver ums-alauda
usbcore: registered new interface driver ums-cypress
usbcore: registered new interface driver ums-datafab
usbcore: registered new interface driver ums-freecom
usbcore: registered new interface driver ums-isd200
usbcore: registered new interface driver ums-jumpshot
usbcore: registered new interface driver ums-karma
usbcore: registered new interface driver ums-sddr09
usbcore: registered new interface driver ums-sddr55
usbcore: registered new interface driver ums-usbat
usb 1-1: pl2303 converter now attached to ttyUSB0
usbcore: registered new interface driver pl2303

root@OpenWrt:/# ls -l /dev/ttyUSB*
crw-rw-rw-    1 root     root     188,   0 Nov  9 11:31 /dev/ttyUSB0</code></pre></div><p>According to me, this shoes that the device has been connected succesfully and drivers loaded ok - therefore no need for insmod/mknod, etc? Further &quot;proof&quot; that the USB has been correctly loaded (I think):</p><div class="codebox"><pre><code>root@OpenWrt:/# stty -F /dev/ttyUSB0 -a
speed 4800 baud; rows 0; columns 0; line = 0;
intr = &lt;undef&gt;; quit = &lt;undef&gt;; erase = &lt;undef&gt;; kill = &lt;undef&gt;; eof = &lt;undef&gt;;
eol = &lt;undef&gt;; eol2 = &lt;undef&gt;; swtch = &lt;undef&gt;; start = &lt;undef&gt;; stop = &lt;undef&gt;;
susp = &lt;undef&gt;; rprnt = &lt;undef&gt;; werase = &lt;undef&gt;; lnext = &lt;undef&gt;;
flush = &lt;undef&gt;; min = 1; time = 0;
-parenb -parodd cs8 -hupcl -cstopb cread clocal -crtscts
ignbrk -brkint -ignpar -parmrk -inpck -istrip -inlcr -igncr -icrnl -ixon -ixoff
-iuclc -ixany -imaxbel
-opost -olcuc -ocrnl -onlcr -onocr -onlret -ofill -ofdel nl0 cr0 tab0 bs0 vt0 ff0
-isig -icanon -iexten -echo -echoe -echok -echonl -noflsh -xcase -tostop -echoprt
-echoctl -echoke</code></pre></div><p>Assuming that all is correctly loaded, I have tried the following settings in ser2net.conf:<br /></p><div class="codebox"><pre><code>2009:raw:60:/dev/ttyUSB0:4800 NONE 1STOPBIT 8DATABITS -XONXOFF LOCAL -RTSCTS
or
2009:raw:60:/dev/ttyUSB0:4800 NONE 1STOPBIT 8DATABITS
or
2009:raw:60:/dev/ttyUSB0:4800</code></pre></div><p>I ran &quot;killall ser2net&quot; and restarted ser2net in between each change.</p><p>Have ordered a FTDI based RS232 cable as I have read a lot of problems with the pl2303 chipset. Will report on success/failure when this arrives, unless I have done an obvious mistake above?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120707">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						10 Nov 2010, 01:56					</div>
				</div>
				<div class="post-content content">
					<p>Yes, opkg install has taken care of insmod. Run lsmod to verify. But there are so many &lt;undef&gt; in your stty info and I&#039;m not sure whether the usb port has been initialized properly.</p><p>Did you access tcp port 2009? Before testing ser2net, I suggest that you run stty to setup the port and install picocom to directly control the port from OpenWrt.<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# picocom -b 4800 /dev/ttyUSB0</code></pre></div><div class="codebox"><pre><code>root@OpenWrt:~# lsmod | grep usb
usbserial              24620   0 [pl2303]
usb-ohci               19252   0 (unused)
usbcore                71296   1 [pl2303 usbserial usb-ohci]

root@OpenWrt:~# cat /proc/tty/driver/usb-serial
usbserinfo:1.0 driver:v1.4
0: module:pl2303 name:&quot;PL-2303&quot; vendor:067b product:2303 num_ports:1 port:1 path:usb-00:04.0-1

root@OpenWrt:~# stty -F /dev/ttyUSB0 -a
speed 9600 baud; rows 0; columns 0; line = 0;
intr = ^C; quit = ^\; erase = ^?; kill = ^U; eof = ^D; eol = &lt;undef&gt;;
eol2 = &lt;undef&gt;; swtch = &lt;undef&gt;; start = ^Q; stop = ^S; susp = ^Z; rprnt = ^R;
werase = ^W; lnext = ^V; flush = ^O; min = 1; time = 0;
-parenb -parodd cs8 hupcl -cstopb cread clocal -crtscts
-ignbrk -brkint -ignpar -parmrk -inpck -istrip -inlcr -igncr icrnl ixon -ixoff
-iuclc -ixany -imaxbel
opost -olcuc -ocrnl onlcr -onocr -onlret -ofill -ofdel nl0 cr0 tab0 bs0 vt0 ff0
isig icanon iexten echo echoe echok -echonl -noflsh -xcase -tostop -echoprt
echoctl echoke

root@OpenWrt:~# stty -F /dev/ttyUSB0 sane

root@OpenWrt:~# stty -F /dev/ttyUSB0 -a
speed 9600 baud; rows 0; columns 0; line = 0;
intr = ^C; quit = ^\; erase = ^?; kill = ^U; eof = ^D; eol = &lt;undef&gt;;
eol2 = &lt;undef&gt;; swtch = &lt;undef&gt;; start = ^Q; stop = ^S; susp = ^Z; rprnt = ^R;
werase = ^W; lnext = ^V; flush = ^O; min = 1; time = 0;
-parenb -parodd cs8 hupcl -cstopb cread clocal -crtscts
-ignbrk brkint -ignpar -parmrk -inpck -istrip -inlcr -igncr icrnl ixon -ixoff
-iuclc -ixany imaxbel
opost -olcuc -ocrnl onlcr -onocr -onlret -ofill -ofdel nl0 cr0 tab0 bs0 vt0 ff0
isig icanon iexten echo echoe echok -echonl -noflsh -xcase -tostop -echoprt
echoctl echoke</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120847">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">japers</div>
					<div class="post-datetime">
						11 Nov 2010, 21:26					</div>
				</div>
				<div class="post-content content">
					<p>Thanks again fyi! OK here is the result of the tests (after killall ser2net to ensure it is not loaded). Can&#039;t see anything here which looks unusual so I think it is ok.</p><div class="codebox"><pre><code>root@OpenWrt:/# lsmod | grep usb
ums_usbat               8464  0
usb_storage            32720 10 ums_usbat,ums_sddr55,ums_sddr09,ums_karma,ums_jumpshot,ums_isd200,ums_freecom,ums_datafab,ums_cypress,ums_alauda
usbserial              24352  3 pl2303
usbcore                97616 16 pl2303,ums_usbat,ums_sddr55,ums_sddr09,ums_karma,ums_jumpshot,ums_isd200,ums_freecom,ums_datafab,ums_cypress,ums_alauda,usb_storage,usbserial,ohci_hcd,ehci_hcd
scsi_mod               68240  3 ums_cypress,usb_storage,sd_mod
nls_base                4800 17 vfat,fat,isofs,nls_utf8,nls_koi8_r,nls_iso8859_2,nls_iso8859_15,nls_iso8859_13,nls_iso8859_1,nls_cp866,nls_cp852,nls_cp850,nls_cp775,nls_cp437,nls_cp1251,nls_cp1250,usbcore

root@OpenWrt:/#  cat /proc/tty/driver/usbserial
usbserinfo:1.0 driver:2.0
0: module:pl2303 name:&quot;pl2303&quot; vendor:067b product:2303 num_ports:1 port:1 path:usb-ar71xx-ehci-1

root@OpenWrt:/# stty -F /dev/ttyUSB0 -a
speed 4800 baud; rows 0; columns 0; line = 0;
intr = ^C; quit = ^\; erase = ^?; kill = ^U; eof = ^D; eol = &lt;undef&gt;;
eol2 = &lt;undef&gt;; swtch = &lt;undef&gt;; start = ^Q; stop = ^S; susp = ^Z; rprnt = ^R;
werase = ^W; lnext = ^V; flush = ^O; min = 1; time = 0;
-parenb -parodd cs8 hupcl -cstopb cread clocal -crtscts
-ignbrk -brkint -ignpar -parmrk -inpck -istrip -inlcr -igncr -icrnl -ixon -ixoff
-iuclc -ixany -imaxbel
-opost -olcuc -ocrnl onlcr -onocr -onlret -ofill -ofdel nl0 cr0 tab0 bs0 vt0 ff0
-isig -icanon -iexten -echo echoe echok -echonl -noflsh -xcase -tostop -echoprt
echoctl echoke

root@OpenWrt:/# stty -F /dev/ttyUSB0 sane

root@OpenWrt:/# stty -F /dev/ttyUSB0 -a
speed 4800 baud; rows 0; columns 0; line = 0;
intr = ^C; quit = ^\; erase = ^?; kill = ^U; eof = ^D; eol = &lt;undef&gt;;
eol2 = &lt;undef&gt;; swtch = &lt;undef&gt;; start = ^Q; stop = ^S; susp = ^Z; rprnt = ^R;
werase = ^W; lnext = ^V; flush = ^O; min = 1; time = 0;
-parenb -parodd cs8 hupcl -cstopb cread clocal -crtscts
-ignbrk brkint -ignpar -parmrk -inpck -istrip -inlcr -igncr icrnl -ixon -ixoff
-iuclc -ixany imaxbel
opost -olcuc -ocrnl onlcr -onocr -onlret -ofill -ofdel nl0 cr0 tab0 bs0 vt0 ff0
isig icanon iexten echo echoe echok -echonl -noflsh -xcase -tostop -echoprt
echoctl echoke</code></pre></div><p>Struggled with picocom... Once loaded (picocom -b 4800 /dev/ttyUSB0) no keystroke whatsoever does anything. Even Control-C does not get out of it, the only exit is to close the terminal and start a fresh session. Not sure if this is a proble due to my serial port or something unrelated?</p><p>Oh the new cable arrived and of course this did not solve the problem which remains the same, damn! Installed ftdi drivers ok and cable recognised and named ttyUSB0 as well. So the problem is software somewhere - I&#039;m sure I&#039;m missing something very simple!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120858">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						12 Nov 2010, 02:10					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>japers wrote:</cite><blockquote><div class="codebox"><pre><code>root@OpenWrt:/# lsmod | grep usb
ums_usbat               8464  0
usb_storage            32720 10 ums_usbat,ums_sddr55,ums_sddr09,ums_karma,ums_jumpshot,ums_isd200,ums_freecom,ums_datafab,ums_cypress,ums_alauda
usbserial              24352  3 pl2303
usbcore                97616 16 pl2303,ums_usbat,ums_sddr55,ums_sddr09,ums_karma,ums_jumpshot,ums_isd200,ums_freecom,ums_datafab,ums_cypress,ums_alauda,usb_storage,usbserial,ohci_hcd,ehci_hcd
scsi_mod               68240  3 ums_cypress,usb_storage,sd_mod
nls_base                4800 17 vfat,fat,isofs,nls_utf8,nls_koi8_r,nls_iso8859_2,nls_iso8859_15,nls_iso8859_13,nls_iso8859_1,nls_cp866,nls_cp852,nls_cp850,nls_cp775,nls_cp437,nls_cp1251,nls_cp1250,usbcore</code></pre></div></blockquote></div><p>This is what I meant. Some said that you still need to install USB1.1 driver (kmod-usb-ohci).</p><p><a href="https://forum.openwrt.org/viewtopic.php?id=27143">OpenWrt / p910nd not seeing any printer on USB port</a></p><p>BTW, picocom is a terminal emulation program. It would be difficult for you to enter hexadecimal numbers with keystrokes. If there&#039;s feedback, it might look like garbage or null. Enter Ctrl-a Ctrl-x to exit.</p><p><a href="http://linux.die.net/man/8/picocom">picocom(8) - Linux man page</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p121169">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">japers</div>
					<div class="post-datetime">
						15 Nov 2010, 18:00					</div>
				</div>
				<div class="post-content content">
					<p>Hey fyi, thanks again! I have spent a lot of time again over the weekend and whilst not solved, feel that I am getting closer!</p><p>Another person sent me a Heatmiser (logging) script - which uses Device::SerialPort in perl rather than ser2net. I quickly discovered that compiling Device::SerialPort on openwrt was tricky so I though what the hell and installed Arch Linux on an old laptop!</p><p>Arch Linux seems to come with all the drivers and perl natively, ttyUSB0 was created succesfully immediately. Yet again complete failure (even after tweaking) with both ser2net and Serial Port.&nbsp; I then realised that my new FTDI cable has a Tx and Rx LED: both scripts/methods succesfully transmit as the Tx LED transmits but there is never an answer from the thermostats. So over the past couple of days, have concluded it is not a PC/OpenWRT problem but something with both sets of perl scripts.</p><p>By chance, one of the script writers got in touch today and mentioned it might be something to do with different setups having a different checksum. He had a similar problem when writing the script.</p><p>So... now gone to read all there is about checksums and protocol and dissect the script(s)!</p><p>Thanks again for all the time spent helping fyi, it is really appreciated, I will be back with more success (or failure) stories ;-)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p121190">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						15 Nov 2010, 19:58					</div>
				</div>
				<div class="post-content content">
					<p>I suggest that you should do some simple tests before jumping into the final stage.</p><p>Install <a href="http://www.heatmiser.co.uk/support/question.php?ID=70">PCLink Version 3 Demonstration</a> and connect Windows to the Heatmiser thermostat.<br /></p><div class="quotebox"><blockquote><p>Laptop with Windows -&gt; USB to RS232 -&gt; RS232 to RS485 -&gt; thermostat</p></blockquote></div><p>Next, configure OpenWrt with ser2net and run the perl scripts from your laptop with Perl installed.<br /></p><div class="quotebox"><blockquote><p>Laptop with Perl -&gt; OpenWrt with ser2net -&gt; USB to RS232 -&gt; RS232 to RS485 -&gt; thermostat</p></blockquote></div><p>You have to modify the perl scipts to access the ip address of OpenWrt (192.168.1.1) instead of 127.0.0.1.</p><p>If all the above is working fine, then install Perl or MicroPerl to OpenWrt and run the perl script from OpenWrt.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p121213">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						15 Nov 2010, 22:54					</div>
				</div>
				<div class="post-content content">
					<p>In getheatmiserstatus.pl:<br /></p><div class="codebox"><pre><code>my ($sum) = ( $address + $function + $data );</code></pre></div><p>But in toggleheatmiser.pl:<br /></p><div class="codebox"><pre><code>my ($sum) = ( ($address + $function + $data ) | 0xff00 ) - 0xff00;</code></pre></div><p>Why are they different? Besides, from what I see, these two perl scrips do not follow <a href="http://www.heatmiser.co.uk/support/admin/attachments/protocolv3system.pdf">protocolv3system.pdf</a>. If your Heatmiser thermostat is a V3 unit, you could send the following hex numbers and see if there&#039;s reply on the RX line.<br /></p><div class="codebox"><pre><code>01 0A 81 00 00 00 FF FF 2C 09</code></pre></div><p>If the Heatmiser thermostat is a V2 unit, you can test it with&nbsp; <a href="http://www.heatmiser.co.uk/support/article-71.html">PCLink Version 2 Demonstration</a>.<br /></p><div class="quotebox"><blockquote><p><strong>How do I know my thermostat is version 2 or 3?</strong></p><p>If you have a version 2 thermostat the display should go off when the power button is pressed. When the same button is pressed on a version 3 unit the thermostat should enter frost mode.<br />The touch screen thermostats are only available with version 3 protocol.</p></blockquote></div><p>Did you connect two wires (half duplex) between RS485 and the Heatmiser thermostat?<br /></p><div class="quotebox"><cite>mwillett wrote:</cite><blockquote><p>An RS485 has 4 connectors; just use 2 of them (called either D+/A or D-/B). The PRT-N has blue and yellow comms cables. Blue goes to B and yellow goes to A.</p></blockquote></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p121287">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">japers</div>
					<div class="post-datetime">
						16 Nov 2010, 20:25					</div>
				</div>
				<div class="post-content content">
					<p>fyi you are always several steps ahead of me!! ;-)</p><p>I had had a very brief look at the script ages ago and compared it to a document called &quot;Heatmiser Protocol v0.3&quot; and it all seemed to hold together in my mind. I only just discovered this document despite it&#039;s name this document is for Heatmiser V2 units so you are correct again- I have V3 thermostats and the problem all along has been that I have been using a V2 script! Because of the document&#039;s name and the fact that the scripts were written early in the year, I simply assumed they were for V3 - classic mistake!</p><p>I had originally tested with PC Link software so I knew the hardware setup worked with a windows laptop hence why I blamed the router rather than even consider the script. So... once I get home (am away again this week) I will do some more testing as per your recommendations and let you know how I get on!</p><p>Did I say thank you very much!?!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p121575">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">japers</div>
					<div class="post-datetime">
						20 Nov 2010, 22:08					</div>
				</div>
				<div class="post-content content">
					<p>Right! Have been busy playing around with some success finally but still quite a few questions as always! Firstly I got a reply from my second thermostat using one of the sripts that someone had sent (on my laptop using perl &amp; Device::SerialPort) and changing the thermostats Number to 4 using this code which came with the script:</p><div class="codebox"><pre><code>04 0A 81 00 00 00 FF FF 72 8F</code></pre></div><p>I tried changing the script to use your checksum (and of course thermostat 1) but got no response:</p><div class="codebox"><pre><code>01 0A 81 00 00 00 FF FF 2C 09</code></pre></div><p>The reason I tried it using this script is that I struggled using the command line. I&#039;m really sorry I know this is very newby question but this is what I tried:</p><div class="codebox"><pre><code>echo -e -n 04 0A 81 00 00 00 FF FF 72 8F &gt; /dev/ttyUSB0                            
echo -e -n &quot;04 0A 81 00 00 00 FF FF 72 8F&quot; &gt; /dev/ttyUSB0
                                
echo -e -n 04, 0A, 81, 00, 00, 00, FF, FF, 72, 8F &gt; /dev/ttyUSB0
echo -e -n &quot;04, 0A, 81, 00, 00, 00, FF, FF, 72, 8F&quot; &gt; /dev/ttyUSB0

echo -e -n 0x04 0x0A 0x81 0x00 0x00 0x00 0xFF 0xFF 0x72 0x8F &gt; /dev/ttyUSB0
echo -e -n &quot;0x04 0x0A 0x81 0x00 0x00 0x00 0xFF 0xFF 0x72 0x8F&quot; &gt; /dev/ttyUSB0

echo -e -n 0x04 ,0x0A ,0x81 ,0x00 ,0x00 ,0x00 ,0xFF ,0xFF ,0x72 ,0x8F &gt; /dev/ttyUSB0
echo -e -n &quot;0x04 ,0x0A ,0x81 ,0x00 ,0x00 ,0x00 ,0xFF ,0xFF ,0x72 ,0x8F&quot; &gt; /dev/ttyUSB0</code></pre></div><p>I used this code rather than yours as I had managed to test it succesfully - not saying yours is wrong, likely I messed up when editing the script and inserting your code! All these commands above were done on the laptop which succesfuly ran the perl script hence I know the hardware is working. With all the above attempts, the Tx LED flashed but I never got an Rx LED response.</p><p>I know this is getting quite OpenWRT off-topic but I also had a good look at the CRC code in the Heatmiser pdf document. I managed to figure out is in C but I could not figure out how on earth to run it with the necessary arguments or calculate (even manually) a CRC from it!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p121653">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						21 Nov 2010, 22:53					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>japers wrote:</cite><blockquote><div class="codebox"><pre><code>echo -e -n &quot;04 0A 81 00 00 00 FF FF 72 8F&quot; &gt; /dev/ttyUSB0</code></pre></div></blockquote></div><div class="codebox"><pre><code>root@OpenWrt:~# stty -F /dev/ttyUSB0 -onlcr
root@OpenWrt:~# echo -e -n &quot;\04\012\0201\0\0\0\0377\0377\162\217&quot; &gt; /dev/ttyUSB0</code></pre></div><p><a href="http://linux.die.net/man/1/echo">echo(1): line of text - Linux man page</a></p><p>I suggest that you explore the hardware with PCLink Version 3 Demonstration and sniff the usb traffic with usb monitor software.<br /></p><div class="quotebox"><blockquote><p><strong>How do i set the comms number ?</strong></p><p>The comms number is set in feature 7 on version 2 thermostats and feature 6 on version 3 and touchscreen thermostats, it must be a unique number between 1 and 32 and is used to identify the thermostat on the network.</p></blockquote></div><p><a href="http://www.incentivespro.com/usb-logger.html">Simple USB Logger for Windows - Incentives Pro</a><br /><a href="http://www.pcausa.com/Utilities/UsbSnoop/">SniffUsb 2.0 - A USB Sniffer for Windows</a><br /><a href="http://wiki.wireshark.org/Tools#USB_capture">Tools - The Wireshark Wiki - 4.6 USB capture</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p122468">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">japers</div>
					<div class="post-datetime">
						2 Dec 2010, 21:32					</div>
				</div>
				<div class="post-content content">
					<p>Finally back, have spent bits of the last couple of days working on this. </p><p>I love the USB sniffing approach to get the correct code! It may not be as elegant as using a script but for my purposes, it is ideal and even better. I have realised that for my purposes all I effectively need are the following two commands to each thermostats:</p><p>a) Frost mode on (away)<br />b) Set temp to say 22 degrees</p><p>With this all I need is the shortest of scripts attached to simple on/off webserver page and I have the perfect arrangement!</p><p>Now, the USB sniffing works perfectly, and I can confirm that the query code you originally generated for T1 is correct: &quot;01 0A 81 00 00 00 FF FF 2C 09&quot; :-) This is the RAW code which the USB sniffer (in windows) picks up from Heatmiser&#039;s software.</p><p>I have however continued trying to get &quot;echo&quot; to work in Linux but with no luck. I have tried your suggestions above (with and without quotations) as well as trying numbers generated for T1 at my end:</p><div class="codebox"><pre><code>echo -e -n &quot;\1\10\129\0\0\0\255\255\44\9&quot; &gt; /dev/ttyUSB0
echo -e -n \1\10\129\0\0\0\255\255\44\9 &gt; /dev/ttyUSB0</code></pre></div><p>None of these get a response from the thermostats, I therefore tried running them without &quot;/dev/ttyUSB0&quot;. I am not sure what the result should be but it is respectively:</p><div class="codebox"><pre><code>[root]#  echo -e -n &quot;\1\11\129\1\18\0\1\0\28\146\215\56&quot;
1111291180102814621556
[root]#  echo -e -n &quot;\1\11\129\1\18\0\1\0\28\146\215\56&quot;
\1\11\129\1\18\1\28\146\215\56</code></pre></div><p>Which doesn&#039;t seem right to me? (the code above is a sniffed one which sets T1 to 28 degrees - I figured it was easier to check success/fail this way in case the Thermostat receives the signal but the response is lost somehow. I tried yours as well)</p><p>Sorry for being a bore but do you have any other ideas? USB Capture on OpenWRT looks a bit difficult...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p122480">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						2 Dec 2010, 22:49					</div>
				</div>
				<div class="post-content content">
					<p>It looks like busybox&#039; &quot;echo&quot; is too limited for your purpose. <br />However printf seems to interpret those escape sequences correctly:</p><div class="codebox"><pre><code>root@OpenWrt:~# printf &quot;\1\11\129\1\18\0\1\0\28\146\215\56&quot;
    
988f .root@OpenWrt:~#</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p122488">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						2 Dec 2010, 22:58					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>fyi wrote:</cite><blockquote><div class="codebox"><pre><code>root@OpenWrt:~# stty -F /dev/ttyUSB0 -onlcr</code></pre></div></blockquote></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p122497">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">japers</div>
					<div class="post-datetime">
						3 Dec 2010, 00:25					</div>
				</div>
				<div class="post-content content">
					<p>Thanks again so much guys, still no luck, so frustrating, below is the code exactly as I have tried it:</p><div class="codebox"><pre><code>[root@/]# stty -F /dev/ttyUSB0 -onlcr
[root@/]# echo -e -n &quot;\1\11\129\1\18\0\1\0\28\146\215\56&quot;
\1\11\129\1\18\1\28\146\215\56
[root@/]# echo -e -n \1\11\129\1\18\0\1\0\28\146\215\56
1111291180102814621556
[root@/]# printf &quot;\1\11\129\1\18\0\1\0\28\146\215\56&quot;

[root@/]# stty -F /dev/ttyUSB0 -a
speed 4800 baud; rows 0; columns 0; line = 0;
intr = &lt;undef&gt;; quit = &lt;undef&gt;; erase = &lt;undef&gt;; kill = &lt;undef&gt;; eof = &lt;undef&gt;;
eol = &lt;undef&gt;; eol2 = &lt;undef&gt;; swtch = &lt;undef&gt;; start = &lt;undef&gt;; stop = &lt;undef&gt;;
susp = &lt;undef&gt;; rprnt = &lt;undef&gt;; werase = &lt;undef&gt;; lnext = &lt;undef&gt;;
flush = &lt;undef&gt;; min = 1; time = 0;
-parenb -parodd cs8 -hupcl -cstopb cread -clocal -crtscts
ignbrk -brkint -ignpar -parmrk -inpck -istrip -inlcr -igncr -icrnl -ixon -ixoff
-iuclc -ixany -imaxbel -iutf8
-opost -olcuc -ocrnl -onlcr -onocr -onlret -ofill -ofdel nl0 cr0 tab0 bs0 vt0 ff0
-isig -icanon -iexten -echo -echoe -echok -echonl -noflsh -xcase -tostop -echoprt
-echoctl -echoke</code></pre></div><p>Jow - Printf gives me the same garble as you (988f) but again no response after sending with &quot;&gt; /dev/ttyUSB0&quot;</p><p>I also tried the above with &quot;\1\10\129\0\0\0\255\255\44\9&quot; and &quot;\04\012\0201\0\0\0\0377\0377\162\217&quot;.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p122509">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						3 Dec 2010, 06:46					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>japers wrote:</cite><blockquote><p>Now, the USB sniffing works perfectly, and I can confirm that the query code you originally generated for T1 is correct: &quot;01 0A 81 00 00 00 FF FF 2C 09&quot; :-) This is the RAW code which the USB sniffer (in windows) picks up from Heatmiser&#039;s software.</p><p>I have however continued trying to get &quot;echo&quot; to work in Linux but with no luck. I have tried your suggestions above (with and without quotations) as well as trying numbers generated for T1 at my end:</p><div class="codebox"><pre><code>echo -e -n &quot;\1\10\129\0\0\0\255\255\44\9&quot; &gt; /dev/ttyUSB0
echo -e -n \1\10\129\0\0\0\255\255\44\9 &gt; /dev/ttyUSB0</code></pre></div></blockquote></div><p>You didn&#039;t pay attention. These are not octal. Read #17 till you fully understand it.</p><p>Since you have two usb to ttl serial cables,<br /></p><div class="quotebox"><blockquote><p>Router &lt;-&gt; FTDI cable &lt;-&gt; Crossover &lt;-&gt; PL2303 cable &lt;-&gt; Laptop</p></blockquote></div><p>Run echo from router.<br />Run <a href="http://www.serialmon.com">SerialMon</a> from Windows.<br />And you&#039;ll see what goes wrong.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>