<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> [SOLVED] OpenWRT Roadwarrior behind Captive Portal</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 28 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p322516">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">maxx1982</div>
					<div class="post-datetime">
						4 May 2016, 15:54					</div>
				</div>
				<div class="post-content content">
					<p>Hi all,</p><p>I have setup a TP-Link MR3020 on ChaosCalmer to be able to broadcast my own WiFi when travelling. This all works very well, with one exception which I don&#039;t understand and hope some of you can help me with:</p><p>Whenever the Router is behind a Captive Portal (which is the usual case these days), what happens is that any of the connected clients forwards to the URL of the respective Captive Portal correctly, i. e. the adress bar changes, but I get a &quot;page not found&quot; error. In other words I can&#039;t authenticate on the Captive Portal. I currently circumvent this issue by first authenticating with one of the clients directly in the respective network and then doing a MAC clone of the router to make it look like I am still connected with the other client.</p><p>However, this is not really a satisfying solution as whenever the guest network demands to re-authenticate I need to once again change networks, re-authenticate and change back to the router network. </p><p>I assume this is some sort of routing or DNS issue. On the other hand, it can&#039;t be because why would the clients be able to surf without any issues after the authentification on the Captive Portal has taken place?</p><p>I have tried everything, setting the DNS manually on the LAN interface to the DNS of the WAN, checked all the route, no sucess... Right now I am having the issue again and route -n shows this:</p><p>Destination&nbsp; &nbsp; &nbsp;Gateway&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Genmask&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Flags Metric Ref&nbsp; &nbsp; Use Iface<br />0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;192.168.1.1&nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth0<br />172.22.222.0&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 wlan0<br />192.168.1.1&nbsp; &nbsp; &nbsp;0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.255 UH&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth0</p><p>Any ideas?</p><p>Rgds<br />maxx1982</p>											<p class="post-edited">(Last edited by <strong>maxx1982</strong> on 4 May 2016, 23:50)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p322517">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Max Hopper</div>
					<div class="post-datetime">
						4 May 2016, 15:58					</div>
				</div>
				<div class="post-content content">
					<p>Be so kind to <a href="https://forum.openwrt.org/search.php">Search</a> before posting. This forum is flooded with threads pertaining to this topic.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p322520">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">maxx1982</div>
					<div class="post-datetime">
						4 May 2016, 16:18					</div>
				</div>
				<div class="post-content content">
					<p>Trust me that I did, but the only topics that I found were around how to set up a Captive Portal on OpenWRT which is not what I want. Pls. share the link to a post re. my question if you have one.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p322541">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">Max Hopper</div>
					<div class="post-datetime">
						4 May 2016, 19:15					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>maxx1982 wrote:</cite><blockquote><p>Trust me that I did, ...</p></blockquote></div><p>-1 (untrustworthy)</p><p>First hit, with keywords &#039;captive&#039; and &#039;logon&#039;.</p><p>-2 (topic is unrelated to OpenWrt)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p322566">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">maxx1982</div>
					<div class="post-datetime">
						4 May 2016, 22:10					</div>
				</div>
				<div class="post-content content">
					<p>Hi all,</p><p>In case anybody is interested in the solution to this - after another session of searching around I finally found this pretty old post: <a href="https://forum.openwrt.org/viewtopic.php?id=42144">Connecting router to Brit Telecom wifi hotspot as client</a>. Though the question is specific to Brit Telecom it contains the key to it:</p><p>My suspicion of DNS was correct; the reason for this is the DNS Rebind protection of OpenWRT. Option Network &gt; DHCP and DNS &gt; General Settings &gt; Rebind protection needs to be turned off to make this work or the respective captive portal URLs have to be whitelisted (see also <a href="https://wiki.openwrt.org/doc/uci/dhcp">Wiki Page DNS/DHCP</a>, options rebind_protection and rebind_domain).</p><p>Works fine for me!</p><p><strong>@Max Hopper</strong><br />1) likewise. maybe you&#039;ve got that impression because that was my first post in this forum? The reason for that is that I usually spend a lot of time researching and finding my way myself (which I did for the past three months re. OpenWRT already) <strong>before</strong> I start posting stuff in forums. I also don&#039;t blow up my number of posts with posting useless stuff like &quot;search in google&quot; or &quot;create a script&quot;.<br />Sorry to say so, but your behaviour clearly indicates that you have no clue yourself what the solution is. If that is the case, then why do you waste yours and my time posting messages like &quot;use the search function&quot; or &quot;there is something i found on the first hit&quot;? Had you really found something or known the answer you could have just said &quot;turn that option off&quot; or posted a link. That would have saved a lot of words on your end (and additional search time for me - which is the whole point of a forum).<br />2) nonsense - see above, just confirms my point of view of your ignorance of the topic</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p322634">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">Max Hopper</div>
					<div class="post-datetime">
						5 May 2016, 12:54					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>maxx1982 wrote:</cite><blockquote><p>The reason for that is that I usually spend a lot of time researching and finding my way myself ...</p></blockquote></div><p>After searching &#039;a lot of time&#039; it is fortuitous then that within 6 hours of posting, a solution was found.</p><p>-3 (<strong>a lot</strong> untrustworthy)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p322644">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">Max Hopper</div>
					<div class="post-datetime">
						5 May 2016, 14:40					</div>
				</div>
				<div class="post-content content">
					<p>Perhaps a primative graphic assists -</p><div class="codebox"><pre><code>-----    ----------        -----                    -----
|STA|    |AP &amp; STA|        |AP |                    |URL|
-----    ----------        ----------    --------    -----
         |DNSmasq |        |CP &amp; DNS|    |CP URL|
         ----------        ----------    --------</code></pre></div><ul><li><p>STA requests URL example.com</p></li><li><p>The STA of AP &amp; STA is associated with an AP hosting a CP</p></li><li><p>DNSmasq on AP &amp; STA forwards this upstream (not cached)</p></li><li><p>The CP (built-in DNS) responds with the IP address of the webserver hosting the CP login page (and a very short cache validity)</p></li><li><p>DNSmasq caches the returned IP address of the CP webserver *as* example.com</p></li><li><p>CP login authenticated</p></li><li><p>CP webserver returns HTTP 301</p></li><li><p>STA redirects to example.com</p></li><li><p>DNSmasq forwards the request upstream</p></li><li><p>CP recognises the authenticated STA and forwards the DNS request upstream</p></li><li><p>DNSmasq compares the returned IP address because <em>--stop-dns-rebind</em> is enabled</p></li><li><p>DNSmasq indicates a host not found (11001) error to the STA</p></li></ul>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>