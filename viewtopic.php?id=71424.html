<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> how to modify igb-5.3.5.7 driver to support compile in openwrt system</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 7 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p361534">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">guozhengqian0825</div>
					<div class="post-datetime">
						5 Jul 2017, 08:44					</div>
				</div>
				<div class="post-content content">
					<p>I have already write a common kernel module package, and it can copy the source file to build_dir folder, but when it execute `make` in source folder, it would fail.</p><p>The Makefile is as below, how to make the least modification to make it work right ?</p><p>```<br />################################################################################<br />#<br /># Intel(R) Gigabit Ethernet Linux driver<br /># Copyright(c) 2007-2015 Intel Corporation.<br />#<br /># This program is free software; you can redistribute it and/or modify it<br /># under the terms and conditions of the GNU General Public License,<br /># version 2, as published by the Free Software Foundation.<br />#<br /># This program is distributed in the hope it will be useful, but WITHOUT<br /># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or<br /># FITNESS FOR A PARTICULAR PURPOSE.&nbsp; See the GNU General Public License for<br /># more details.<br />#<br /># The full GNU General Public License is included in this distribution in<br /># the file called &quot;COPYING&quot;.<br />#<br /># Contact Information:<br /># Linux NICS &lt;linux.nics@intel.com&gt;<br /># e1000-devel Mailing List &lt;e1000-devel@lists.sourceforge.net&gt;<br /># Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497<br />#<br />################################################################################</p><p>###########################################################################<br /># Driver files<br />FAMILYC = e1000_82575.c e1000_i210.c<br />FAMILYH = e1000_82575.h e1000_i210.h</p><p># core driver files<br />CFILES = igb_main.c $(FAMILYC) e1000_mac.c e1000_nvm.c e1000_phy.c \<br />&nbsp; &nbsp;&nbsp; e1000_manage.c igb_param.c igb_ethtool.c kcompat.c e1000_api.c \<br />&nbsp; &nbsp;&nbsp; e1000_mbx.c igb_vmdq.c igb_procfs.c igb_hwmon.c igb_debugfs.c<br />HFILES = igb.h e1000_hw.h e1000_osdep.h e1000_defines.h e1000_mac.h \<br />&nbsp; &nbsp;&nbsp; e1000_nvm.h e1000_manage.h $(FAMILYH) kcompat.h e1000_regs.h \<br />&nbsp; &nbsp;&nbsp; e1000_api.h igb_regtest.h e1000_mbx.h igb_vmdq.h<br />ifeq (,$(BUILD_KERNEL))<br />BUILD_KERNEL=$(shell uname -r)<br />endif</p><p>DRIVER_NAME=igb</p><br /><p>###########################################################################<br /># Environment tests</p><p># Kernel Search Path<br /># All the places we look for kernel source<br />KSP :=&nbsp; /lib/modules/$(BUILD_KERNEL)/build \<br />&nbsp; &nbsp; &nbsp; &nbsp; /lib/modules/$(BUILD_KERNEL)/source \<br />&nbsp; &nbsp; &nbsp; &nbsp; /usr/src/linux-$(BUILD_KERNEL) \<br />&nbsp; &nbsp; &nbsp; &nbsp; /usr/src/linux-$($(BUILD_KERNEL) | sed &#039;s/-.*//&#039;) \<br />&nbsp; &nbsp; &nbsp; &nbsp; /usr/src/kernel-headers-$(BUILD_KERNEL) \<br />&nbsp; &nbsp; &nbsp; &nbsp; /usr/src/kernel-source-$(BUILD_KERNEL) \<br />&nbsp; &nbsp; &nbsp; &nbsp; /usr/src/linux-$($(BUILD_KERNEL) | sed &#039;s/\([0-9]*\.[0-9]*\)\..*/\1/&#039;) \<br />&nbsp; &nbsp; &nbsp; &nbsp; /usr/src/linux</p><p># prune the list down to only values that exist<br /># and have an include/linux sub-directory<br />test_dir = $(shell [ -e $(dir)/include/linux ] &amp;&amp; echo $(dir))<br />KSP := $(foreach dir, $(KSP), $(test_dir))</p><p># we will use this first valid entry in the search path<br />ifeq (,$(KSRC))<br />&nbsp; KSRC := $(firstword $(KSP))<br />endif</p><p>ifeq (,$(KSRC))<br />&nbsp; $(warning *** Kernel header files not in any of the expected locations.)<br />&nbsp; $(warning *** Install the appropriate kernel development package, e.g.)<br />&nbsp; $(error kernel-devel, for building kernel modules and try again)<br />else<br />ifeq (/lib/modules/$(BUILD_KERNEL)/source, $(KSRC))<br />&nbsp; KOBJ :=&nbsp; /lib/modules/$(BUILD_KERNEL)/build<br />else<br />&nbsp; KOBJ :=&nbsp; $(KSRC)<br />endif<br />endif</p><p># Version file Search Path<br />VSP :=&nbsp; $(KOBJ)/include/generated/utsrelease.h \<br />&nbsp; &nbsp; &nbsp; &nbsp; $(KOBJ)/include/linux/utsrelease.h \<br />&nbsp; &nbsp; &nbsp; &nbsp; $(KOBJ)/include/linux/version.h \<br />&nbsp; &nbsp; &nbsp; &nbsp; $(KOBJ)/include/generated/uapi/linux/version.h \<br />&nbsp; &nbsp; &nbsp; &nbsp; /boot/vmlinuz.version.h</p><p># Config file Search Path<br />CSP :=&nbsp; $(KOBJ)/include/generated/autoconf.h \<br />&nbsp; &nbsp; &nbsp; &nbsp; $(KOBJ)/include/linux/autoconf.h \<br />&nbsp; &nbsp; &nbsp; &nbsp; /boot/vmlinuz.autoconf.h</p><p># prune the lists down to only files that exist<br />test_file = $(shell [ -f $(file) ] &amp;&amp; echo $(file))<br />VSP := $(foreach file, $(VSP), $(test_file))<br />CSP := $(foreach file, $(CSP), $(test_file))</p><p># and use the first valid entry in the Search Paths<br />ifeq (,$(VERSION_FILE))<br />&nbsp; VERSION_FILE := $(firstword $(VSP))<br />endif<br />ifeq (,$(CONFIG_FILE))<br />&nbsp; CONFIG_FILE := $(firstword $(CSP))<br />endif</p><p>ifeq (,$(wildcard $(VERSION_FILE)))<br />&nbsp; $(error Linux kernel source not configured - missing version header file)<br />endif</p><p>ifeq (,$(wildcard $(CONFIG_FILE)))<br />&nbsp; $(error Linux kernel source not configured - missing autoconf.h)<br />endif</p><p># pick a compiler<br />ifneq (,$(findstring egcs-2.91.66, $(shell cat /proc/version)))<br />&nbsp; CC := kgcc gcc cc<br />else<br />&nbsp; CC := gcc cc<br />endif<br />test_cc = $(shell $(cc) --version &gt; /dev/null 2&gt;&amp;1 &amp;&amp; echo $(cc))<br />CC := $(foreach cc, $(CC), $(test_cc))<br />CC := $(firstword $(CC))<br />ifeq (,$(CC))<br />&nbsp; $(error Compiler not found)<br />endif</p><p># we need to know what platform the driver is being built on<br /># some additional features are only built on Intel platforms<br />ARCH := $(shell uname -m | sed &#039;s/i.86/i386/&#039;)<br />ifeq ($(ARCH),alpha)<br />&nbsp; EXTRA_CFLAGS += -ffixed-8 -mno-fp-regs<br />endif<br />ifeq ($(ARCH),x86_64)<br />&nbsp; EXTRA_CFLAGS += -mcmodel=kernel -mno-red-zone<br />endif<br />ifeq ($(ARCH),ppc)<br />&nbsp; EXTRA_CFLAGS += -msoft-float<br />endif<br />ifeq ($(ARCH),ppc64)<br />&nbsp; EXTRA_CFLAGS += -m64 -msoft-float<br />&nbsp; LDFLAGS += -melf64ppc<br />endif</p><p># extra flags for module builds<br />EXTRA_CFLAGS += -DDRIVER_$(shell echo $(DRIVER_NAME) | tr &#039;[a-z]&#039; &#039;[A-Z]&#039;)<br />EXTRA_CFLAGS += -DDRIVER_NAME=$(DRIVER_NAME)<br />EXTRA_CFLAGS += -DDRIVER_NAME_CAPS=$(shell echo $(DRIVER_NAME) | tr &#039;[a-z]&#039; &#039;[A-Z]&#039;)<br /># standard flags for module builds<br />EXTRA_CFLAGS += -DLINUX -D__KERNEL__ -DMODULE -O2 -pipe -Wall<br />EXTRA_CFLAGS += -I$(KSRC)/include<br />EXTRA_CFLAGS += $(shell [ -f $(KSRC)/include/linux/modversions.h ] &amp;&amp; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo &quot;-DMODVERSIONS -DEXPORT_SYMTAB \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -include $(KSRC)/include/linux/modversions.h&quot;)</p><p># Some helper functions for converting kernel version to version codes<br />get_kver = $(or $(word ${2},$(subst ., ,${1})),0)<br />get_kvercode = $(shell [ &quot;${1}&quot; -ge 0 -a &quot;${1}&quot; -le 255 2&gt;/dev/null ] &amp;&amp; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[ &quot;${2}&quot; -ge 0 -a &quot;${2}&quot; -le 255 2&gt;/dev/null ] &amp;&amp; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[ &quot;${3}&quot; -ge 0 -a &quot;${3}&quot; -le 255 2&gt;/dev/null ] &amp;&amp; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;printf %d $$(( ( ${1} &lt;&lt; 16 ) + ( ${2} &lt;&lt; 8 ) + ( ${3} ) )) )</p><p># The following command line parameter is intended for development of KCOMPAT<br /># against upstream kernels such as net-next which have broken or non-updated<br /># version codes in their Makefile. They are intended for debugging and<br /># development purpose only so that we can easily test new KCOMPAT early. If you<br /># don&#039;t know what this means, you do not need to set this flag. There is no<br /># arcane magic here.</p><p># Convert LINUX_VERSION into LINUX_VERSION_CODE<br />ifneq (${LINUX_VERSION},)<br />&nbsp; LINUX_VERSION_CODE=$(call get_kvercode,$(call get_kver,${LINUX_VERSION},1),$(call get_kver,${LINUX_VERSION},2),$(call get_kver,${LINUX_VERSION},3))<br />endif</p><p># Honor LINUX_VERSION_CODE<br />ifneq (${LINUX_VERSION_CODE},)<br />&nbsp; $(warning Forcing target kernel&#039;s LINUX_VERSION_CODE to ${LINUX_VERSION_CODE}$(if ${LINUX_VERSION}, from LINUX_VERSION=${LINUX_VERSION}). Do this at your own risk.)<br />&nbsp; KVER_CODE := ${LINUX_VERSION_CODE}<br />&nbsp; EXTRA_CFLAGS += -DLINUX_VERSION_CODE=${LINUX_VERSION_CODE}<br />endif</p><p>EXTRA_CFLAGS += $(CFLAGS_EXTRA)</p><p>RHC := $(KSRC)/include/linux/rhconfig.h<br />ifneq (,$(wildcard $(RHC)))<br />&nbsp; # 7.3 typo in rhconfig.h<br />&nbsp; ifneq (,$(shell $(CC) $(EXTRA_CFLAGS) -E -dM $(RHC) | grep __module__bigmem))<br />&nbsp; &nbsp; EXTRA_CFLAGS += -D__module_bigmem<br />&nbsp; endif<br />endif</p><p># get the kernel version - we use this to find the correct install path<br />KVER := $(shell $(CC) $(EXTRA_CFLAGS) -E -dM $(VERSION_FILE) | grep UTS_RELEASE | \<br />&nbsp; &nbsp; &nbsp; &nbsp; awk &#039;{ print $$3 }&#039; | sed &#039;s/\&quot;//g&#039;)</p><p># assume source symlink is the same as build, otherwise adjust KOBJ<br />ifneq (,$(wildcard /lib/modules/$(KVER)/build))<br />ifneq ($(KSRC),$(shell readlink /lib/modules/$(KVER)/build))<br />&nbsp; KOBJ=/lib/modules/$(KVER)/build<br />endif<br />endif</p><p>ifeq (${KVER_CODE},)<br />&nbsp; KVER_CODE := $(shell $(CC) $(EXTRA_CFLAGS) -E -dM $(VSP) 2&gt;/dev/null |\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;grep -m 1 LINUX_VERSION_CODE | awk &#039;{ print $$3 }&#039; | sed &#039;s/\&quot;//g&#039;)<br />endif</p><p>RHEL_CODE := $(shell $(CC) $(EXTRA_CFLAGS) -E -dM $(VSP) 2&gt;/dev/null |\<br />&nbsp; &nbsp; grep -m 1 RHEL_RELEASE_CODE | awk &#039;{ print $$3 }&#039;)</p><p># Determine SLE_LOCALVERSION_CODE for SuSE SLE (needed by kcompat)<br /># This assumes SuSE will continue setting CONFIG_LOCALVERSION to the string<br /># appended to the stable kernel version on which their kernel is based with<br /># additional versioning information (up to 3 numbers), a possible abbreviated<br /># git SHA1 commit id and a kernel type, e.g. CONFIG_LOCALVERSION=-1.2.3-default<br /># or CONFIG_LOCALVERSION=-999.gdeadbee-default<br />ifeq (1,$(shell ${CC} -E -dM ${CONFIG_FILE} 2&gt; /dev/null |\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; grep -m 1 CONFIG_SUSE_KERNEL | awk &#039;{ print $$3 }&#039;))<br />&nbsp; LOCALVERSION := $(shell ${CC} -E -dM ${CONFIG_FILE} 2&gt; /dev/null |\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; grep -m 1 CONFIG_LOCALVERSION | awk &#039;{ print $$3 }&#039; |\<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cut -d&#039;-&#039; -f2 | sed &#039;s/\.g[[:xdigit:]]\{7\}//&#039;)<br />&nbsp; LOCALVER_A := $(shell echo ${LOCALVERSION} | cut -d&#039;.&#039; -f1)<br />&nbsp; LOCALVER_B := $(shell echo ${LOCALVERSION} | cut -s -d&#039;.&#039; -f2)<br />&nbsp; LOCALVER_C := $(shell echo ${LOCALVERSION} | cut -s -d&#039;.&#039; -f3)<br />&nbsp; SLE_LOCALVERSION_CODE := $(shell expr ${LOCALVER_A} \* 65536 + \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0${LOCALVER_B} \* 256 + 0${LOCALVER_C})<br />&nbsp; EXTRA_CFLAGS += -DSLE_LOCALVERSION_CODE=${SLE_LOCALVERSION_CODE}<br />endif</p><p># abort the build on kernels older than 2.4.21<br />ifneq (1,$(shell [ $(KVER_CODE) -ge 132117 ] &amp;&amp; echo 1 || echo 0))<br />&nbsp; $(error *** Aborting the build. \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *** This driver &#039;$(KVER_CODE)&#039; is not supported on kernel versions older than 2.4.21, \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; because this driver requires NAPI support.)<br />endif</p><p># look for PCI in config.h<br />PCI := $(shell $(CC) $(EXTRA_CFLAGS) -E -dM $(CONFIG_FILE) | \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;grep -w CONFIG_PCI | awk &#039;{ print $$3 }&#039;)<br />ifneq ($(PCI),1)<br />&nbsp; $(error *** Aborting the build. \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *** This driver requires that CONFIG_PCI is enabled)<br />endif</p><p># Use NO_PTP_SUPPORT flag to disable IEEE-1588 PTP (Documented in README)<br />ifneq ($(filter %NO_PTP_SUPPORT,$(CFLAGS_EXTRA)),-DNO_PTP_SUPPORT)<br /># Do not attempt to enable PTP in kernels which do not have support<br />ifeq (1,$(shell ([ $(KVER_CODE) -ge 196608 ] || [ $(RHEL_CODE) -ge 1540 ]) &amp;&amp; echo 1 || echo 0))<br />include $(KOBJ)/include/config/auto.conf<br />ifdef CONFIG_PTP_1588_CLOCK<br />CFILES += igb_ptp.c<br />endif # CONFIG_PTP_1588_CLOCK<br />endif # kernel version &gt;= 3.0<br />endif # !NO_PTP_SUPPORT</p><p># set the install path<br />INSTDIR ?= /lib/modules/${KVER}/updates/drivers/net/ethernet/intel</p><p># look for SMP in config.h<br />SMP := $(shell $(CC) $(EXTRA_CFLAGS) -E -dM $(CONFIG_FILE) | \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;grep -w CONFIG_SMP | awk &#039;{ print $$3 }&#039;)<br />ifneq ($(SMP),1)<br />&nbsp; SMP := 0<br />endif</p><p>ifneq ($(SMP),$(shell uname -a | grep SMP &gt; /dev/null 2&gt;&amp;1 &amp;&amp; echo 1 || echo 0))<br />&nbsp; $(warning ***)<br />&nbsp; ifeq ($(SMP),1)<br />&nbsp; &nbsp; $(warning *** Warning: kernel source configuration (SMP))<br />&nbsp; &nbsp; $(warning *** does not match running kernel (UP))<br />&nbsp; else<br />&nbsp; &nbsp; $(warning *** Warning: kernel source configuration (UP))<br />&nbsp; &nbsp; $(warning *** does not match running kernel (SMP))<br />&nbsp; endif<br />&nbsp; $(warning *** Continuing with build,)<br />&nbsp; $(warning *** resulting driver may not be what you want)<br />&nbsp; $(warning ***)<br />endif</p><p>ifeq ($(SMP),1)<br />&nbsp; EXTRA_CFLAGS += -D__SMP__<br />endif</p><br /><p>###########################################################################<br /># Kernel Version Specific rules</p><p>ifeq (1,$(shell [ $(KVER_CODE) -ge 132352 ] &amp;&amp; echo 1 || echo 0))</p><p># Makefile for 2.5.x and newer kernel<br />TARGET = $(DRIVER_NAME).ko</p><p># man page<br />MANSECTION = 7<br />MANFILE = $(TARGET:.ko=.$(MANSECTION))</p><p>ifneq ($(PATCHLEVEL),)<br />EXTRA_CFLAGS += $(CFLAGS_EXTRA)<br />obj-m += $(DRIVER_NAME).o<br />$(DRIVER_NAME)-objs := $(CFILES:.c=.o)<br />else<br />default:<br />ifeq ($(KOBJ),$(KSRC))<br />&nbsp; &nbsp; $(MAKE) -C $(KSRC) SUBDIRS=$(shell pwd) modules<br />else<br />&nbsp; &nbsp; $(MAKE) -C $(KSRC) O=$(KOBJ) SUBDIRS=$(shell pwd) modules<br />endif<br />endif</p><p>else # ifeq (1,$(shell [ $(KVER_CODE) -ge 132352 ] &amp;&amp; echo 1 || echo 0))</p><p># Makefile for 2.4.x kernel<br />TARGET = $(DRIVER_NAME).o</p><p># man page<br />MANSECTION = 7<br />MANFILE = $(TARGET:.o=.$(MANSECTION))</p><p># Get rid of compile warnings in kernel header files from SuSE<br />ifneq (,$(wildcard /etc/SuSE-release))<br />&nbsp; EXTRA_CFLAGS += -Wno-sign-compare -fno-strict-aliasing<br />endif</p><p># Get rid of compile warnings in kernel header files from fedora<br />ifneq (,$(wildcard /etc/fedora-release))<br />&nbsp; EXTRA_CFLAGS += -fno-strict-aliasing<br />endif<br />CFLAGS += $(EXTRA_CFLAGS)</p><p>.SILENT: $(TARGET)<br />$(TARGET): $(filter-out $(TARGET), $(CFILES:.c=.o))<br />&nbsp; &nbsp; $(LD) $(LDFLAGS) -r $^ -o $@<br />&nbsp; &nbsp; echo; echo<br />&nbsp; &nbsp; echo &quot;**************************************************&quot;<br />&nbsp; &nbsp; echo &quot;** $(TARGET) built for $(KVER)&quot;<br />&nbsp; &nbsp; echo -n &quot;** SMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&quot;<br />&nbsp; &nbsp; if [ &quot;$(SMP)&quot; = &quot;1&quot; ]; \<br />&nbsp; &nbsp; &nbsp; &nbsp; then echo &quot;Enabled&quot;; else echo &quot;Disabled&quot;; fi<br />&nbsp; &nbsp; echo &quot;**************************************************&quot;<br />&nbsp; &nbsp; echo</p><p>$(CFILES:.c=.o): $(HFILES) Makefile<br />default:<br />&nbsp; &nbsp; $(MAKE)</p><p>endif # ifeq (1,$(shell [ $(KVER_CODE) -ge 132352 ] &amp;&amp; echo 1 || echo 0))</p><p>ifeq (,$(MANDIR))<br />&nbsp; # find the best place to install the man page<br />&nbsp; MANPATH := $(shell (manpath 2&gt;/dev/null || echo $MANPATH) | sed &#039;s/:/ /g&#039;)<br />&nbsp; ifneq (,$(MANPATH))<br />&nbsp; &nbsp; # test based on inclusion in MANPATH<br />&nbsp; &nbsp; test_dir = $(findstring $(dir), $(MANPATH))<br />&nbsp; else<br />&nbsp; &nbsp; # no MANPATH, test based on directory existence<br />&nbsp; &nbsp; test_dir = $(shell [ -e $(dir) ] &amp;&amp; echo $(dir))<br />&nbsp; endif<br />&nbsp; # our preferred install path<br />&nbsp; # should /usr/local/man be in here ?<br />&nbsp; MANDIR := /usr/share/man /usr/man<br />&nbsp; MANDIR := $(foreach dir, $(MANDIR), $(test_dir))<br />&nbsp; MANDIR := $(firstword $(MANDIR))<br />endif<br />ifeq (,$(MANDIR))<br />&nbsp; # fallback to /usr/man<br />&nbsp; MANDIR := /usr/man<br />endif</p><p># depmod version for rpm builds<br />DEPVER := $(shell /sbin/depmod -V 2&gt;/dev/null | \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; awk &#039;BEGIN {FS=&quot;.&quot;} NR==1 {print $$2}&#039;)</p><p>###########################################################################<br /># Build rules</p><p>$(MANFILE).gz: ../$(MANFILE)<br />&nbsp; &nbsp; gzip -c $&lt; &gt; $@</p><p>install: default $(MANFILE).gz<br />&nbsp; &nbsp; install -D -m 644 $(TARGET) $(INSTALL_MOD_PATH)$(INSTDIR)/$(TARGET)<br />ifeq (,$(INSTALL_MOD_PATH))<br />&nbsp; &nbsp; /sbin/depmod -a || true<br />else<br />&nbsp; ifeq ($(DEPVER),1 )<br />&nbsp; &nbsp; /sbin/depmod -r $(INSTALL_MOD_PATH) -a || true<br />&nbsp; else<br />&nbsp; &nbsp; /sbin/depmod -b $(INSTALL_MOD_PATH) -a -n $(KVERSION) &gt; /dev/null || true<br />&nbsp; endif<br />endif<br />&nbsp; &nbsp; install -D -m 644 $(MANFILE).gz $(INSTALL_MOD_PATH)$(MANDIR)/man$(MANSECTION)/$(MANFILE).gz</p><p>uninstall:<br />&nbsp; &nbsp; if [ -e $(INSTDIR)/$(TARGET) ] ; then \<br />&nbsp; &nbsp;&nbsp; &nbsp; &nbsp;rm -f $(INSTDIR)/$(TARGET) ; \<br />&nbsp; &nbsp; fi<br />&nbsp; &nbsp; /sbin/depmod -a<br />&nbsp; &nbsp; if [ -e $(MANDIR)/man$(MANSECTION)/$(MANFILE).gz ] ; then \<br />&nbsp; &nbsp; &nbsp; &nbsp; rm -f $(MANDIR)/man$(MANSECTION)/$(MANFILE).gz ; \<br />&nbsp; &nbsp; fi</p><p>.PHONY: clean install</p><p>clean:<br />&nbsp; &nbsp; rm -rf $(TARGET) $(TARGET:.ko=.o) $(TARGET:.ko=.mod.c) $(TARGET:.ko=.mod.o) $(CFILES:.c=.o) \<br />&nbsp; &nbsp; $(MANFILE).gz .*cmd .tmp_versions Module.markers Module.symvers modules.order</p><p>```</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>