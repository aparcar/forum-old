<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> VLAN trunking on OpenWRT possible ?</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 29 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p281040">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">markusm</div>
					<div class="post-datetime">
						23 Jun 2015, 00:10					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>i want to build a separated vlan for wlan guests on three openwrt routers in my house. all the routers (2x Tl-WR1043ND v2, 1x WDR4300) are configured as switch with WLAN-AP, because the main router is a hardware firewall appliance. </p><p>The physical network is addresses as 192.168.1.0/24, with 192.168.1.1 = firewall, 192.168.1.10/11/12 the openwrt devices. <br />Now i want to create a guest (w)lan (adressed e.g. with 192.168.100.0/24) with no access to the LAN, Internet only. I don&#039;t want any new cables, so vlan trunking should be the way to go. </p><p>I started with the OpenWRT device which is connected directly to the firewall over lan port 4. On the appliance i created a VLAN (ID 9) on the LAN-nic (Intel 82546GB [has 802.11q vlan support]). </p><p>now i am stuck, and very confused - after a lot of reading it has gotten worse, so i decided to ask here for help. What i have to do in OpenWRT, if port 4 is used by both the virtual and the physical network. Which one to tag, and how do i configure this in OpenWRT ?</p><p>Thanks a lot !</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p281062">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">jea101</div>
					<div class="post-datetime">
						23 Jun 2015, 03:32					</div>
				</div>
				<div class="post-content content">
					<p>How are the Openwrt boxes connected to the fire wall and each other?&nbsp; Even a crude picture would <br />help.&nbsp; </p><p>All of your devices support multiple tagged VLANs on a single port.&nbsp; I don’t know if they can support <br />both tagged and a single untagged VLAN on a port.</p><p>The “firewall” must also support VLANs.&nbsp; My both my Zywall USG50 and Ubiquiti Edgerouter Lite support <br />VLANs.&nbsp; Ubiquiti is also shipping the Edgerouter x for $50 that supportd VLANs.&nbsp; </p><p>If your “firewall” doesn’t support VLANs you must replace it to do what you want.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p281069">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">mk24</div>
					<div class="post-datetime">
						23 Jun 2015, 04:54					</div>
				</div>
				<div class="post-content content">
					<p>It works best to tag both networks on the trunk cable(s).&nbsp; You can configure the switches to make the other ports untagged to connect ordinary wired clients to one network or the other.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p281077">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">vilpalu</div>
					<div class="post-datetime">
						23 Jun 2015, 09:18					</div>
				</div>
				<div class="post-content content">
					<p>yes, it works correctly but from CC. If you want use BB or older openwrt you cant mix tagged and untagged frames in one interface.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p281085">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">markusm</div>
					<div class="post-datetime">
						23 Jun 2015, 11:42					</div>
				</div>
				<div class="post-content content">
					<p>Thank you for your answers.</p><p>I tried to make an easy network diagram (sorry for visio, though <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /> ). The firewall-system is a self-built intel atom system with one intel 82546GB dual-port NIC (supports VLAN) for LAN / VoIP-Network, and a Realtek 8168 (WAN-Uplink). Software is monowall (supports VLAN, too). </p><p>Each OpenWRT-device should provide a guest-wifi-AP, separated from the &quot;normal&quot; network by using vlans (changes: red font in diagram)</p><p><a href="http://www.directupload.net/file/d/4027/sjncumvk_png.htm"><span class="postimg"><img src="http://fs2.directupload.net/images/150623/temp/sjncumvk.png" alt="http://fs2.directupload.net/images/150623/temp/sjncumvk.png" /></span></a></p><p>I hope that helps</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p281094">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">jea101</div>
					<div class="post-datetime">
						23 Jun 2015, 13:21					</div>
				</div>
				<div class="post-content content">
					<p>Your WIFI bridge may be a problem.&nbsp; <br />From what I have read WIFI doesn’t support 802.1Q tags.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p281145">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">golialive</div>
					<div class="post-datetime">
						23 Jun 2015, 22:31					</div>
				</div>
				<div class="post-content content">
					<p>Hey there.</p><p>I have no clue about wifi and 802.1q. Imho that just works, as long a very specific wifi configuration messes with packages. There&#039;s a chance wds (or bridges in general) do manipulate packages in a way vlans get corrupted. But as long as a wifi connection acts transparently to every ethernet packages, vlans shouldn&#039;t be a problem.</p><p>To mixing both, tagged and untagged on the same wire: Well. Could somebody please give me a use case? Usually I would interconnect my wifi aware devices (switches) in a tagged trunk network and create untagged outlets, only one vlan per port.</p><p>If you can live with not mixing tagged and untagged packages on the wire: That&#039;s really easy with OpenWRT.</p><p>Just have a look at the LuCI switch part. Of course setting up vlans in plain config files or console based UCI is easy too. But for starters doing first steps via LuCI is and check what happened to the config file is ok.</p><p>Rules of thumb (for me, there are others using different configurations):<br /></p><ul><li><p>Only tagged or untagged, no mixes on a single port. Others might think different, but to me that&#039;s the way to go.</p></li><li><p>If untagged, only one untagged per port. Outgoing is pretty easy (the switch remoes the tag), but ingoing traffic has no clue which tag do add. There might be ways around this, but that&#039;s magic to me. And magic is to avoid by all meams if it comes to infra structure.</p></li><li><p>If tagged, as many tags as you want.</p></li><li><p>Keep one port connected to untagged vlan2 in order to not cut your config interface <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></li><li><p>Try which hardware port goes to which software port by plugging in and out another devie than your computer. That&#039;s something you can find in documentation, but since that&#039;s the way bricking devices (if you have no serial interface to reset), I&#039;d better just double check it.</p></li><li><p>Mind the &quot;CPU&quot; port. That&#039;s the port a router can add its &quot;gateway interace&quot;, or, in case of DNS or something, its &quot;serbice interface&quot; to. Switching works perfectly fine without that. Of course you should at least keep vlan2 connected to CPU, otherwise you will not be able to configure. But all other vlans can live without CPU connected. Even adding the CPU to a single vlan doesn&#039;t necessarily make it &quot;talk&quot; with that network. You still need to create an &quot;interface&quot; in OpenWRT and bind it to &quot;eth0.$vlan&quot;.</p></li></ul><p>Regards,<br />Stephan.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p282023">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">markusm</div>
					<div class="post-datetime">
						1 Jul 2015, 15:59					</div>
				</div>
				<div class="post-content content">
					<p>Hello Stephan,</p><p>thank you for your posting and your splendid explanation. Now that i&#039;m back from holidays i decided to take small steps. So i tried to configure the VLANs for the OpenWRT box directly connected to the m0n0wall. i added a VLAN to the m0nowall&#039;s eth2 device, with the tag id 9. </p><p>The OpenWRT device is TP-Link 1043ND v2, which hardware and software ports are reversed, for example hardware port 4 is port 1 in software. Currently, as there is no WAN interface the switch config looks like this: </p><div class="codebox"><pre><code>config switch
        option name &#039;switch0&#039;
        option reset &#039;1&#039;
        option enable_vlan &#039;1&#039;
        option mirror_source_port &#039;0&#039;
        option mirror_monitor_port &#039;0&#039;

config switch_vlan
        option device &#039;switch0&#039;
        option vlan &#039;1&#039;
        option vid &#039;1&#039;
        option ports &#039;0 1 2 3 4 5 6&#039;</code></pre></div><p>According to the devices <a href="http://wiki.openwrt.org/toh/tp-link/tl-wr1043nd#interfaces">wiki site</a> port 0 is the cpu, 1-5 are the 4 lan ports + wan, 6 is another cpu port. <br />to keep things easy i&#039;ll refer to the software ports, not the hardware ports. </p><p>the m0n0wall is directly connected to port 5, this cable serves all wan traffic. so it has to be trunked, i think - one vlan for common lan traffic from my network, another vlan for guests. my first try was to add the device connected to port 2 to the vlan id 9.</p><p>these are the steps i did:</p><p>1) create vlan with id 9 on m0n0wall, added the interface eth2.1, add DHCP/DNS server for eth2.1<br />2) create vlan with id 9 on OpenWRT with all ports off except port 5 tagged, and port 2 untagged<br />3) modifed default wlan 1: set port 2 to off, and port 5 to tagged. <br />4) not sure about the (both?) cpu ports, tried both tagged as well untagged in vlan1 and vlan9 parallel<br />5) added new openwrt interface, covering eth0.9 only, set to dhcp client mode</p><p>I think this should work, but the openwrt box is unable to get a ip address from m0n0wall - i can&#039;t see any incoming requests in tcpdump or the protocols. </p><p>Any ideas ?</p>											<p class="post-edited">(Last edited by <strong>markusm</strong> on 1 Jul 2015, 15:59)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p282027">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">mk24</div>
					<div class="post-datetime">
						1 Jul 2015, 16:24					</div>
				</div>
				<div class="post-content content">
					<p>Avoid any configuration which connects the two CPU ports together in the same VLAN.</p><p>I see two ways to go about it:</p><p>Tagged traffic on port 5 in two VLANs, one VLAN untagged to each CPU port.<br /></p><div class="codebox"><pre><code>option vlan &#039;1&#039;
option ports &#039;5t 0&#039;

option vlan &#039;9&#039;
option ports &#039;5t 6&#039;</code></pre></div><p>Here one of the networks would be on eth0 and the other on eth1.&nbsp; There is limited possibility for expansion though.&nbsp; You could switch either one out to wired users by adding untagged ports to that VLAN, but you couldn&#039;t have another internal network come out without using VLANs on a CPU port.</p><br /><p>Or, tag both VLANs through to one CPU port.&nbsp; The other CPU port is unused for now.<br /></p><div class="codebox"><pre><code>option vlan &#039;1&#039;
option ports &#039;5t 6t&#039;

option vlan &#039;9&#039;
option ports &#039;5t 6t&#039;</code></pre></div><p>One network is eth0.1 and the other is eth0.9&nbsp; You could connect eth1 independently to the other 4 ethernet ports by making another vlan that doesn&#039;t include port 5:<br /></p><div class="codebox"><pre><code>option vlan &#039;2&#039;
option ports &#039;0 1 2 3 4&#039;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p282030">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">markusm</div>
					<div class="post-datetime">
						1 Jul 2015, 17:47					</div>
				</div>
				<div class="post-content content">
					<p>thank you for your answer.. i tried to setup your second option with tagging both VLANs through one cpu port. </p><p>the dhcp client on eth0.9 immediately got an IP from the m0n0wall, and clients to port 2 where able to access the internet, but not the LAN - which is exactly what i want. The rest of the network was offline immediately (no wan access), i suppose because the m0n0wall is not configured for a vlan with vid 1. so i reverted vlan 1 to it&#039;s original configuration (everything untagged with exception of port 2 = off) while leaving vlan9 as it is. </p><p>to my surprise both the LAN and the VLAN are working now with the following config:</p><div class="codebox"><pre><code>config switch
        option name &#039;switch0&#039;
        option reset &#039;1&#039;
        option enable_vlan &#039;1&#039;
        option mirror_source_port &#039;0&#039;
        option mirror_monitor_port &#039;0&#039;

config switch_vlan
        option device &#039;switch0&#039;
        option vlan &#039;1&#039;
        option vid &#039;1&#039;
        option ports &#039;0 1 3 4 5&#039;

config switch_vlan
        option device &#039;switch0&#039;
        option vlan &#039;2&#039;
        option vid &#039;9&#039;
        option ports &#039;2 5t 6t&#039;

config interface &#039;vlan9&#039;
        option proto &#039;dhcp&#039;
        option ifname &#039;eth0.9&#039;</code></pre></div><p>is this a valid configuration, or are there any issues ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p282040">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">BenFranske</div>
					<div class="post-datetime">
						1 Jul 2015, 19:17					</div>
				</div>
				<div class="post-content content">
					<p>I would suggest changing your firewall so as to not assign an IP address at all to eth2 and make your LAN interface eth2.2 and tag it with a VLAN. For security reasons it is a bad idea to have traffic flowing on the untagged VLAN on a trunk link. See VLAN hopping attacks, specifically &quot;Q-in-Q&quot; for details.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>