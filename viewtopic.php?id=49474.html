<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Atheros AP121 Reference Board 2MB</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 9 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p227448">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">puckettatpatton</div>
					<div class="post-datetime">
						12 Mar 2014, 19:11					</div>
				</div>
				<div class="post-content content">
					<p>Hope someone can point me in the right direction.&nbsp; I am a newb...</p><p>I have an Atheros AP121 reference board and I would like to put OpenWrt on the unit. I have created my own build machine and tried to flash the unit accordingly.&nbsp; &nbsp;</p><p><strong> 1. Flash squashfs - I know now this is the wrong file. Can some one point me to the right way to make file, or a snapshot of the right squashfs file? </strong> </p><div class="codebox"><pre><code> TFTP from server 192.168.1.10; our IP address is 192.168.1.2
Filename &#039;openwrt-ar71xx-generic-root.squashfs&#039;.
Load address: 0x80060000
Loading: #################################################################
       
done
Bytes transferred = 7733248 (760000 hex)
ar7240&gt; erase 0x9f010000 +0x130000
Erase Flash from 0x9f010000 to 0x9f13ffff in Bank # 1
First 0x1 last 0x13 sector size 0x10000                                       19
Erased 19 sectors
ar7240&gt; cp.b $fileaddr 0x9f010000 $filesize
Copy to Flash... Outside available Flash </code></pre></div><p>I see that this flash is 8MB, I think I need a 2MB flash.&nbsp; &nbsp;I am not sure how do this?&nbsp; </p><div class="codebox"><pre><code> ar7240&gt; boot
## Booting image at 9f300000 ...
Bad Magic Number </code></pre></div><p><strong>2. Flash the Linux Kernal </strong></p><div class="codebox"><pre><code>ar7240&gt; tftpboot 0x80060000 openwrt-ar71xx-generic-uImage-lzma.bin
Using eth1 device
TFTP from server 192.168.1.10; our IP address is 192.168.1.2
Filename &#039;openwrt-ar71xx-generic-uImage-lzma.bin&#039;.
Load address: 0x80060000
Loading: #################################################################
         
done
Bytes transferred = 1027310 (facee hex)
ar7240&gt; erase 0x9f140000 +$filesize
Erase Flash from 0x9f140000 to 0x9f23ffff in Bank # 1
First 0x14 last 0x23 sector size 0x10000                                      35
Erased 16 sectors
ar7240&gt; cp.b $fileaddr 0x9f140000 $filesize
Copy to Flash... write addr: 9f140000
done </code></pre></div><p><strong> 3. Hard reset of the unit. </strong>&nbsp; </p><div class="codebox"><pre><code> U-Boot 1.1.4 (Feb  6 2013 - 14:27:40)

AP121 (ar9331) U-boot

DRAM:  16 MB
Top of RAM usable for U-Boot at: 81000000
Reserving 139k for U-Boot at: 80fdc000
Reserving 192k for malloc() at: 80fac000
Reserving 44 Bytes for Board Info at: 80fabfd4
Reserving 36 Bytes for Global Data at: 80fabfb0
Reserving 128k for boot params() at: 80f8bfb0
Stack Pointer at: 80f8bf98
Now running in RAM - U-Boot at: 80fdc000
Flash Manuf Id 0xc2, DeviceId0 0x20, DeviceId1 0x16
flash size 4194304, sector count = 64
Flash:  4 MB
Using default environment

In:    serial
Out:   serial
Err:   serial
Net:   ag7240_enet_initialize...
Fetching MAC Address from 0x80ff4068
Fetching MAC Address from 0x80ff4068
: cfg1 0x5 cfg2 0x7114
eth0: 00:03:7f:11:55:df
eth0 up
: cfg1 0xf cfg2 0x7214
eth1: 00:03:7f:11:55:e0
athrs26_reg_init_lan
ATHRS26: resetting s26
ATHRS26: s26 reset done
eth1 up
eth0, eth1
Hit any key to stop autoboot:  0
## Booting image at 9f300000 ...
Bad Magic Number
ar7240&gt;</code></pre></div><p>Thanks for your your help.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p227478">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">neryba</div>
					<div class="post-datetime">
						12 Mar 2014, 22:46					</div>
				</div>
				<div class="post-content content">
					<p>you have 4mb version </p><div class="quotebox"><blockquote><p>Flash:&nbsp; 4 MB</p></blockquote></div><p> plzz print output of &#039;printenv&#039; command. and read this <a href="https://dev.openwrt.org/ticket/14571">ticket</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p227480">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">puckettatpatton</div>
					<div class="post-datetime">
						13 Mar 2014, 01:02					</div>
				</div>
				<div class="post-content content">
					<p>Thank you for the response.&nbsp; </p><p>Yes, I realize now that I have a 4MB flash.&nbsp; The documentation for this board reads &quot;SPI NOR Flash memory support and configured with 2MB serial flash.&nbsp; I see now, that my board is capable of handling the 4MB flash.&nbsp; </p><p>I will read the link you sent me, I stumbled upon this before I originally posted but didn&#039;t grasp what I needed to do.&nbsp; Now I know my answer lies within, I will study deeper.&nbsp; &nbsp;I appreciate your post.&nbsp; </p><p><strong>Here is my &#039;printevn&#039; as requested </strong></p><div class="codebox"><pre><code> ar7240&gt; printenv
bootargs=console=ttyS0,115200 root=31:02 rootfstype=squashfs init=/sbin/init mtd                                                       parts=ar7240-nor0:256k(u-boot),64k(u-boot-env),2752k(rootfs),896k(uImage),64k(NV                                                       RAM),64k(ART)
bootcmd=bootm 0x9f300000
bootdelay=4
baudrate=115200
ethaddr=0x00:0xaa:0xbb:0xcc:0xdd:0xee
ipaddr=192.168.1.2
serverip=192.168.1.10
stdin=serial
stdout=serial
stderr=serial
ethact=eth0 


Environment size: 359/65532 bytes
ar7240&gt;  </code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p227562">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">puckettatpatton</div>
					<div class="post-datetime">
						14 Mar 2014, 01:25					</div>
				</div>
				<div class="post-content content">
					<p>I have installed all of the patches on trac ticket #14571.&nbsp; These are the files after my build.&nbsp; Can you help me, is this correct, I don&#039;t see any files match the changes made in the image &quot;Makefile&quot;.&nbsp; Does this look correct?&nbsp; &nbsp;</p><p><strong>AP121 Reference Board Build</strong></p><div class="codebox"><pre><code>puckett@jsieg-OptiPlex-GX620:/openwrt/trunk/openwrt/bin/ar71xx$ ls -l
total 113376
-rw-r--r-- 1 puckett puckett     1546 Mar 13 19:14 md5sums
-rw-r--r-- 1 puckett puckett 10144798 Mar 13 19:14 openwrt-ar71xx-generic-AP121-rootfs.tar.gz
-rw-r--r-- 1 puckett puckett  8175833 Mar 13 19:13 openwrt-ar71xx-generic-ap121-2M-initramfs-uImage.bin
-rw-r--r-- 1 puckett puckett  8175744 Mar 13 19:14 openwrt-ar71xx-generic-ap121-4M-initramfs-uImage.bin
-rwxr-xr-x 1 puckett puckett   160116 Mar 13 17:35 openwrt-ar71xx-generic-nbg460n_550n_550nh-u-boot.bin
-rw-r--r-- 1 puckett puckett  7733248 Mar 13 19:14 openwrt-ar71xx-generic-root.squashfs
-rw-r--r-- 1 puckett puckett  7602180 Mar 13 19:14 openwrt-ar71xx-generic-root.squashfs-64k
-rw-r--r-- 1 puckett puckett  1418494 Mar 13 19:13 openwrt-ar71xx-generic-uImage-gzip.bin
-rw-r--r-- 1 puckett puckett  8471210 Mar 13 19:13 openwrt-ar71xx-generic-uImage-initramfs-gzip.bin
-rw-r--r-- 1 puckett puckett  8175851 Mar 13 19:13 openwrt-ar71xx-generic-uImage-initramfs-lzma.bin
-rw-r--r-- 1 puckett puckett  1027122 Mar 13 19:13 openwrt-ar71xx-generic-uImage-lzma.bin
-rwxr-xr-x 1 puckett puckett  8247845 Mar 13 19:13 openwrt-ar71xx-generic-vmlinux-initramfs-lzma.elf
-rwxr-xr-x 1 puckett puckett 10152868 Mar 13 19:13 openwrt-ar71xx-generic-vmlinux-initramfs.bin
-rwxr-xr-x 1 puckett puckett 10219372 Mar 13 19:13 openwrt-ar71xx-generic-vmlinux-initramfs.elf
-rw-r--r-- 1 puckett puckett  8519680 Mar 13 19:13 openwrt-ar71xx-generic-vmlinux-initramfs.gz
-rw-r--r-- 1 puckett puckett  8192000 Mar 13 19:13 openwrt-ar71xx-generic-vmlinux-initramfs.lzma
-rwxr-xr-x 1 puckett puckett  1099117 Mar 13 19:13 openwrt-ar71xx-generic-vmlinux-lzma.elf
-rwxr-xr-x 1 puckett puckett  3099884 Mar 13 19:13 openwrt-ar71xx-generic-vmlinux.bin
-rwxr-xr-x 1 puckett puckett  3166388 Mar 13 19:13 openwrt-ar71xx-generic-vmlinux.elf
-rw-r--r-- 1 puckett puckett  1441792 Mar 13 19:13 openwrt-ar71xx-generic-vmlinux.gz
-rw-r--r-- 1 puckett puckett  1048576 Mar 13 19:13 openwrt-ar71xx-generic-vmlinux.lzma
drwxr-xr-x 2 puckett puckett    20480 Mar 13 19:14 packages
drwxr-xr-x 2 puckett puckett     4096 Mar 13 17:35 uboot-ar71xx-nbg460n_550n_550nh
puckett@jsieg-OptiPlex-GX620:/openwrt/trunk/openwrt/bin/ar71xx$ </code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p227587">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">neryba</div>
					<div class="post-datetime">
						14 Mar 2014, 12:49					</div>
				</div>
				<div class="post-content content">
					<p>openwrt-ar71xx-generic-ap121-4M-initramfs-uImage.bin may be the right image(boot on ram), but it doesn&#039;t give you chance to save changes, after reboot all changes restore back.<br />if you build correctly you will see openwrt-ar71xx-generic-ap121-4M-rootfs-sysupgrade.bin</p><p>I will write on Monday, with right instruction.</p>											<p class="post-edited">(Last edited by <strong>neryba</strong> on 14 Mar 2014, 12:55)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p227785">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">puckettatpatton</div>
					<div class="post-datetime">
						17 Mar 2014, 16:05					</div>
				</div>
				<div class="post-content content">
					<p>Thank you, I think I missing something in my builds.&nbsp; I have run a few builds and I don&#039;t see the &quot;openwrt-ar71xx-generic-ap121-4M-rootfs-sysupgrade.bin&quot; file.&nbsp; Can I use this file to upgrade directly from the UBOOT?&nbsp; I am stuck here because I don&#039;t know enough about the memory locations. The commands above come directly from the Atheros reference guide document, but this may not be the right procedure for the OpenWrt build.&nbsp; Thanks again for your help.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p227815">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">neryba</div>
					<div class="post-datetime">
						17 Mar 2014, 22:16					</div>
				</div>
				<div class="post-content content">
					<p>if you try build own image with V=s flag, you will siee output why it is cannot by created. </p><div class="codebox"><pre><code>make V=s</code></pre></div><p>You will see somethig like that </p><div class="codebox"><pre><code>LZMA 4.65 : Igor Pavlov : Public domain : 2009-02-03
mkimage -A mips -O linux -T kernel -a 0x80060000 -C lzma -e 0x80060000 -n &#039;MIPS OpenWrt Linux-3.10.21&#039; -d /home/user/Source/trunk/build_dir/target-mips_34kc_uClibc-0.9.33.2/linux-ar71xx_generic/tmp/vmlinux-ap121-4M.bin.lzma /home/user/Source/trunk/build_dir/target-mips_34kc_uClibc-0.9.33.2/linux-ar71xx_generic/tmp/vmlinux-ap121-4M.uImage
Image Name: MIPS OpenWrt Linux-3.10.21
Created: Sun Dec 8 22:52:33 2013
Image Type: MIPS Linux Kernel Image (lzma compressed)
Data Size: 988396 Bytes = 965.23 kB = 0.94 MB
Load Address: 80060000
Entry Point: 80060000
/home/user/Source/trunk/staging_dir/host/bin/mksquashfs4 /home/user/Source/trunk/build_dir/target-mips_34kc_uClibc-0.9.33.2/root-ar71xx /home/user/Source/trunk/build_dir/target-mips_34kc_uClibc-0.9.33.2/linux-ar71xx_generic/root.squashfs -nopad -noappend -root-owned -comp xz -Xpreset 9 -Xe -Xlc 0 -Xlp 2 -Xpb 2 -b 256k -p &#039;/dev d 755 0 0&#039; -p &#039;/dev/console c 600 0 0 5 1&#039; -processors 1
Parallel mksquashfs: Using 1 processor</code></pre></div><p>kernel part is bigger than this <a href="https://dev.openwrt.org/browser/branches/attitude_adjustment/target/linux/ar71xx/image/Makefile#L796">line allow</a><br />change this line to </p><div class="codebox"><pre><code>$(eval $(call SingleProfile,AthLzma,$(fs_64k),AP121_4M,ap121-4M,AP121,ttyATH0,115200,$$(ap121_mtdlayout_4M),1048576,2689676,KRuImage))</code></pre></div><p> and line 166 to </p><div class="codebox"><pre><code>ap121_mtdlayout_4M=mtdparts=spi0.0:256k(u-boot)ro,64k(u-boot-env)ro,1024k(kernel),2624k(rootfs),64k(nvram),64k(art)ro,3648k@0x50000(firmware)</code></pre></div><p>now remove build_dir and build image again.</p><p>this change place of kernel partition and it size. maybe you need change bootloader to this string </p><div class="codebox"><pre><code>bootcmd=bootm 0x9f50000</code></pre></div>											<p class="post-edited">(Last edited by <strong>neryba</strong> on 17 Mar 2014, 22:17)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p227915">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">puckettatpatton</div>
					<div class="post-datetime">
						19 Mar 2014, 01:35					</div>
				</div>
				<div class="post-content content">
					<p>Thank you for your post.&nbsp; I will do a &#039;make clean&#039; and a new build tonight.&nbsp; I appreciate your help, I need to buy you a beer...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p228355">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">puckettatpatton</div>
					<div class="post-datetime">
						24 Mar 2014, 23:21					</div>
				</div>
				<div class="post-content content">
					<p>I managed to try another build, but for some reason my squashfs partition file is still too big.&nbsp; Please let me know if there is a way to attach my verbose log output, maybe you can see why it is failing, I can&#039;t.&nbsp; </p><p>Thanks if you can help me.&nbsp; If not I may just put a bigger flash on this board and call it a day!&nbsp; </p><br /><div class="codebox"><pre><code> puckett@jsieg-OptiPlex-GX620:/openwrt/trunk/openwrt/bin/ar71xx$ ls -l
total 27076
-rw-r--r-- 1 puckett puckett     729 Mar 18 23:56 md5sums
-rwxr-xr-x 1 puckett puckett  160116 Mar 18 22:19 openwrt-ar71xx-generic-nbg460n_550n_550nh-u-boot.bin
-rw-r--r-- 1 puckett puckett 7733248 Mar 18 23:56 openwrt-ar71xx-generic-root.squashfs
-rw-r--r-- 1 puckett puckett 7602180 Mar 18 23:56 openwrt-ar71xx-generic-root.squashfs-64k
-rw-r--r-- 1 puckett puckett 1418493 Mar 18 23:56 openwrt-ar71xx-generic-uImage-gzip.bin
-rw-r--r-- 1 puckett puckett 1027323 Mar 18 23:56 openwrt-ar71xx-generic-uImage-lzma.bin
-rwxr-xr-x 1 puckett puckett 1099317 Mar 18 23:56 openwrt-ar71xx-generic-vmlinux-lzma.elf
-rwxr-xr-x 1 puckett puckett 3099884 Mar 18 23:56 openwrt-ar71xx-generic-vmlinux.bin
-rwxr-xr-x 1 puckett puckett 3166388 Mar 18 23:56 openwrt-ar71xx-generic-vmlinux.elf
-rw-r--r-- 1 puckett puckett 1441792 Mar 18 23:56 openwrt-ar71xx-generic-vmlinux.gz
-rw-r--r-- 1 puckett puckett 1048576 Mar 18 23:56 openwrt-ar71xx-generic-vmlinux.lzma
drwxr-xr-x 2 puckett puckett   20480 Mar 18 23:56 packages
drwxr-xr-x 2 puckett puckett    4096 Mar 18 22:19 uboot-ar71xx-nbg460n_550n_550nh
puckett@jsieg-OptiPlex-GX620:/openwrt/trunk/openwrt/bin/ar71xx$ </code></pre></div>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>