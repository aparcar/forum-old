<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> ar9331&#039;s usb stability issue - [SOLVED]</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 23 Mar 2017 and 6 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 4 of 13</div><nav><ul><li><a href="viewtopic.php%3Fid=39956&amp;p=1.html">1</a></li><li><a href="viewtopic.php%3Fid=39956&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=39956&amp;p=3.html">3</a></li><li class="pagination-current"><span>4</span></li><li><a href="viewtopic.php%3Fid=39956&amp;p=5.html">5</a></li><li><a href="viewtopic.php%3Fid=39956&amp;p=6.html">6</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39956&amp;p=13.html">13</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p182917">
				<div class="post-metadata">
					<div class="post-num">Post #76</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						10 Nov 2012, 22:41					</div>
				</div>
				<div class="post-content content">
					<p>here are the register values when using a USB hub...</p><br /><p>[ 2340.510000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br />[ 2341.520000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br />[ 2342.530000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br />[ 2343.350000] usb 1-1: new high-speed USB device number 6 using ehci-platform<br />[ 2343.500000] hub 1-1:1.0: USB hub found<br />[ 2343.500000] hub 1-1:1.0: 4 ports detected<br />[ 2343.540000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[ 2344.550000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[ 2345.560000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[ 2346.570000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[ 2347.580000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[ 2348.590000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[ 2349.600000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[ 2350.610000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[ 2351.620000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[ 2352.630000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[ 2353.640000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[ 2354.650000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[ 2355.110000] usb 1-1.2: new full-speed USB device number 7 using ehci-platform<br />[ 2355.230000] cdc_acm 1-1.2:1.0: ttyACM0: USB ACM device<br />[ 2355.660000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[ 2356.670000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[ 2357.680000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[ 2358.690000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[ 2359.700000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c</p><p>note that values do not vary when the usb 1.1 is being used. Also note that the values are different for the hub than for the USB 1.1 device directly connected.</p><p>And as always... the USB 1.1. device works perfectly when connected to the hub.</p><p>--luis</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182927">
				<div class="post-metadata">
					<div class="post-num">Post #77</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						11 Nov 2012, 02:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>lsoltero wrote:</cite><blockquote><p>I will also mention that like @Squonk I am not seeing ar933x_wmac_reset(void) called once on boot up and when the WLAN is reset.&nbsp; Otherwise this function is not being called.</p><p>--luis</p></blockquote></div><p>Thank you Luis for performing these tests while I am recovering <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>However, this doesn&#039;t give us a clue on what is going on, then <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182964">
				<div class="post-metadata">
					<div class="post-num">Post #78</div>
					<div class="post-author">mips</div>
					<div class="post-datetime">
						11 Nov 2012, 17:48					</div>
				</div>
				<div class="post-content content">
					<p>@lsoltero:<br />From your register dump,the 0xb8116c84 and 0xb8116c88 are not 0xdeadbeef as Squonk dump.If the value are 0xdeadbeef,that&#039;s means a invalid access...it&#039;s a good news that the dumped value seems make sense.<br />Maybe first we watch the reigister change before and after usb hang is a wrong idea,from the tips we get we need let some bit set,some bit clear about these two register.If these register value are not right,the use will hang,that&#039;s the hang reason,and hang without any change about these register ...<br />Maybe first we need these two register have right value(some bit must set,some bit must clear),in your kernel thread you can add these check(let&#039;s it do very offten) and revert and test if the usb will hang.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182965">
				<div class="post-metadata">
					<div class="post-num">Post #79</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						11 Nov 2012, 17:55					</div>
				</div>
				<div class="post-content content">
					<p>hello @mips,</p><p>here is my current kernel thread.</p><br /><p>static int ar933regmon(void *data)<br />{<br />&nbsp; &nbsp; while ( 1 ) {<br />&nbsp; &nbsp; &nbsp; &nbsp; pr_err(&quot;ar933x reg dump: 0x%x, 0x%x, 0x%x, 0x%x&quot;, __raw_readl((const volatile void *) 0xbb000184), __raw_readl((const volatile void *) 0xbb000188),<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __raw_readl((const volatile void *) 0xb8116c84), __raw_readl((const volatile void *) 0xb8116c88));<br />&nbsp; &nbsp; &nbsp; &nbsp; msleep(1000);<br />&nbsp; &nbsp; }<br />&nbsp; &nbsp; return 0;<br />}</p><p>what i will do is i will change the code to dump the values when they change and then do an msleep(10);&nbsp; &nbsp;This way we will only get print statements when something changes.</p><p>I will try to do that now.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182968">
				<div class="post-metadata">
					<div class="post-num">Post #80</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						11 Nov 2012, 18:33					</div>
				</div>
				<div class="post-content content">
					<p>OK...</p><p>here is the new monitor.</p><br /><p>static int ar933regmon(void *data)<br />{<br />&nbsp; &nbsp; unsigned long a = 0xdeadbeef;<br />&nbsp; &nbsp; unsigned long b = 0xdeadbeef;<br />&nbsp; &nbsp; unsigned long c = 0xdeadbeef;<br />&nbsp; &nbsp; unsigned long d = 0xdeadbeef;</p><p>&nbsp; &nbsp; while ( 1 ) {<br />&nbsp; &nbsp; &nbsp; &nbsp; unsigned long aa = __raw_readl((const volatile void *) 0xbb0001<br />&nbsp; &nbsp; &nbsp; &nbsp; unsigned long bb = __raw_readl((const volatile void *) 0xbb0001<br />&nbsp; &nbsp; &nbsp; &nbsp; unsigned long cc = __raw_readl((const volatile void *) 0xb8116c<br />&nbsp; &nbsp; &nbsp; &nbsp; unsigned long dd = __raw_readl((const volatile void *) 0xb8116c</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if ( a != aa || b != bb || c != cc || d != dd ) {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pr_err(&quot;ar933x reg dump: 0x%lx, 0x%lx, 0x%lx, 0x%lx&quot;, a<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; a = aa;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = bb;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c = cc;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; d = dd;<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; msleep(1);<br />&nbsp; &nbsp; }<br />&nbsp; &nbsp; return 0;<br />}</p><p>and here are the results.</p><br /><p>root@Optimizer:/# dmesg | grep ar933<br />[&nbsp; &nbsp; 0.500000] ar933x: WMAC reset called<br />[&nbsp; &nbsp; 0.500000] ar933x reg dump: 0xdeadbeef, 0xdeadbeef<br />[&nbsp; &nbsp; 0.510000] ar933x reg dump: 0x1c000004, 0x0<br />[&nbsp; &nbsp; 0.510000] ar933x reg dump: 0x1c000004, 0x0, 0xdeadbeef, 0xdeadbeef<br />[&nbsp; &nbsp; 0.660000] ar933x-uart: ttyATH0 at MMIO 0x18020000 (irq = 11) is a AR933X UART<br />[&nbsp; &nbsp;19.620000] ar933x reg dump: 0x1c000004, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; &nbsp;20.570000] ar933x reg dump: 0x1c000000, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; &nbsp;20.630000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; &nbsp;28.810000] ar933x reg dump: 0x1c001000, 0x0, 0xdeadbeef, 0xdeadbeef<br />[&nbsp; &nbsp;28.910000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br />root@Optimizer:/# [&nbsp; &nbsp;66.270000] ar933x reg dump: 0x10001801, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; &nbsp;66.290000] ar933x reg dump: 0x10001803, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; &nbsp;66.310000] ar933x reg dump: 0x10001801, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; &nbsp;66.470000] ar933x reg dump: 0x10001101, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; &nbsp;66.530000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; &nbsp;66.580000] usb 1-1: new full-speed USB device number 2 using ehci-platform<br />[&nbsp; &nbsp;66.590000] ar933x reg dump: 0x10001101, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; &nbsp;66.650000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; &nbsp;66.740000] cdc_acm 1-1:1.0: ttyACM0: USB ACM device<br />[&nbsp; 192.820000] usb 1-1: USB disconnect, device number 2<br />[&nbsp; 192.830000] cdc_acm 1-1:1.0: acm_ctrl_irq - usb_submit_urb failed: -19<br />[&nbsp; 192.840000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c</p><p>So... there were no changes that could be detected in any of the 4 registers during USB failure.&nbsp; The USB started up fine... started a PPP session... the phone dialed connected and durning the PPP negotiation the USB interface stopped working.</p><br /><p>here is the dump for a successful connection using a USB 2.0 passive HUB.</p><br /><p>[&nbsp; 329.080000] ar933x reg dump: 0x10001801, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; 329.240000] ar933x reg dump: 0x10001501, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; 329.260000] ar933x reg dump: 0x10001901, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; 329.300000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; 329.350000] usb 1-1: new high-speed USB device number 3 using ehci-platform<br />[&nbsp; 329.360000] ar933x reg dump: 0x18001701, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; 329.380000] ar933x reg dump: 0x18001b01, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; 329.400000] ar933x reg dump: 0x18001701, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; 329.420000] ar933x reg dump: 0x18001205, 0x0, 0x84100095, 0xf01b6c<br />[&nbsp; 329.500000] hub 1-1:1.0: USB hub found<br />[&nbsp; 329.500000] hub 1-1:1.0: 4 ports detected<br />[&nbsp; 337.000000] usb 1-1.2: new full-speed USB device number 4 using ehci-platform<br />[&nbsp; 337.150000] cdc_acm 1-1.2:1.0: ttyACM0: USB ACM device</p><p>looking forward to comments.</p><p>--luis</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183032">
				<div class="post-metadata">
					<div class="post-num">Post #81</div>
					<div class="post-author">mips</div>
					<div class="post-datetime">
						12 Nov 2012, 15:03					</div>
				</div>
				<div class="post-content content">
					<p>@lsoltero:<br />In your while kernel thread,don&#039;t monitor as before.<br />Check the register 0xb8116c84 bit 20,make sure it&#039;s always 0,if bit 20 is 1,show the register value and change the bit 20 to 0,other bits in this register should not change.<br />Check the register 0xb8116c88,make sure the bit 21,bit 22,bit 23 are always 1,make sure the bit 24 and bit 25 are always 0.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183044">
				<div class="post-metadata">
					<div class="post-num">Post #82</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						12 Nov 2012, 18:52					</div>
				</div>
				<div class="post-content content">
					<p>hello @mips,</p><p>the current monitor prints to the console when any value of the 4 monitored register changes.</p><p>&nbsp; &nbsp; &nbsp; &nbsp; unsigned long aa = __raw_readl((const volatile void *) 0xbb0001<br />&nbsp; &nbsp; &nbsp; &nbsp; unsigned long bb = __raw_readl((const volatile void *) 0xbb0001<br />&nbsp; &nbsp; &nbsp; &nbsp; unsigned long cc = __raw_readl((const volatile void *) 0xb8116c<br />&nbsp; &nbsp; &nbsp; &nbsp; unsigned long dd = __raw_readl((const volatile void *) 0xb8116c<br />&nbsp; &nbsp; &nbsp; &nbsp; if ( a != aa || b != bb || c != cc || d != dd ) {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pr_err(&quot;ar933x reg dump: 0x%lx, 0x%lx, 0x%lx, 0x%lx&quot;, a<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; a = aa;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = bb;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c = cc;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; d = dd;<br />&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>for some reason the copy paste did not work... so here are the register definitions again..</p><p>unsigned long aa = __raw_readl((const volatile void *) 0xbb000184);<br />unsigned long bb = __raw_readl((const volatile void *) 0xbb000188);<br />unsigned long cc = __raw_readl((const volatile void *) 0xb8116c84);<br />unsigned long dd = __raw_readl((const volatile void *) 0xb8116c88);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; </p><p>it does this every millisecond.</p><p>so we know that 0xb8X registers are not changing&nbsp; the only register that changes 0xbb000184 and it only changes when when a USB device is plugged into the unit.&nbsp; </p><p>[&nbsp; &nbsp;66.740000] cdc_acm 1-1:1.0: ttyACM0: USB ACM device</p><p>no changes in the registers happened here during a test.</p><p>[&nbsp; 192.820000] usb 1-1: USB disconnect, device number 2</p><p>i will try to run the test with finer resolution than 1 msec in the loop and report back..</p><p>--luis</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183050">
				<div class="post-metadata">
					<div class="post-num">Post #83</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						12 Nov 2012, 20:50					</div>
				</div>
				<div class="post-content content">
					<p>ok. as it turns out msleep(1) is the smallest interruptible sleep that can be done in the kernel. udelay() does a busy way and basically bricks the kernel when the thread is spawned...</p><p>BUT... doing a thread to monitor the register values is probably not the way to go anyway.&nbsp; If the bits are changing rapidly then the thread can miss them... especially since &lt; 20 ms sleeps are unreliable in linux and usually take longer than they are supposed to.</p><p>probably the thing to do is to add the register test in the ehci usb driver before and then again after a read/write.&nbsp; &nbsp;I am not familiar with the USB code to know where the best place to do this is... </p><p>anyone have any ideas were best to place the register test/dump code?</p><p>--luis</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183164">
				<div class="post-metadata">
					<div class="post-num">Post #84</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						13 Nov 2012, 20:26					</div>
				</div>
				<div class="post-content content">
					<p>Hi all,</p><p>This may be the final word on this whole story regarding the AR9331&#039;s USB stability issue...</p><p>Following a conversation that took place between Elektra from the <a href="http://villagetelco.org/">Village Telco</a> and <a href="https://forum.openwrt.org/profile.php?id=1034">nbd</a> from this forum, it appeared that the &quot;<em>AR9331 chip only implements EHCI, so the USB port is only 2.0 compliant</em>&quot;.</p><p>The &quot;<strong>USB 2.0</strong>&quot; term used by Atheros (and other manufacturers too) is rather confusing, since there can be some &quot;USB 2.0&quot;-labeled devices which are in fact only using Full-Speed or even Low-Speed actual protocol. The &quot;USB 2.0&quot; sticker only says that they passed the corresponding version USB-IF compliance, but not at which speed...</p><p>At this light, I tried several configurations, and it looks like that the AR9331 only effectively implements EHCI only and not OHCI, so <strong>only High-Speed (480Mbps) devices are supported by the AR9331 chip</strong>.</p><p>So, to summarize, i strongly suspect that:<br /></p><ul><li><p><strong>REAL USB 2.0 High-Speed 480 Mbps devices</strong> such as 3G modems or USB drives <strong>are supported by the AR9331</strong></p></li><li><p><strong>SO-CALLED USB2.0 or ACTUALLY USB 1.1 Full-Speed 12 Mbps</strong> such as almost all cdc-acm devices (including GSM/GPRS modems, FTDI chip-based devices, POTS modems, GPS devices, Arduino boards, etc.) appear to work but in fact feature the strange bugs we found and <strong>do not work reliably</strong></p></li><li><p><strong>SO-CALLED USB2.0 or ACTUALLY USB 1.1 Low-Speed 1.5 MBps</strong> such as mice, keyboards, joysticks and <a href="http://www.obdev.at/products/vusb/index.html">Software-based USB AVR implementations</a> <strong>do not work at all</strong></p></li></ul><p>In order for such USB Full-Speed 12 Mbps or Low-Speed 1.5 MBps devices to work with the AR9331, you need to add a High-speed hub (active or passive, it doesn&#039;t matter, provided you respect the 100 mA w/o negotiation / 500 mA max current from the USB spec) in-between.</p><p>As it looks like it really is a low-level hardware limitation and not a software OHCI driver problem, in this case they seem to work (at least for days) without problem.</p>											<p class="post-edited">(Last edited by <strong>Squonk</strong> on 13 Nov 2012, 20:34)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183165">
				<div class="post-metadata">
					<div class="post-num">Post #85</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						13 Nov 2012, 20:35					</div>
				</div>
				<div class="post-content content">
					<p>which begs the question...</p><p>how can TP-LINK sell TP-MR3040 routers which support a plethora of USB 1.1 GSM 3G and 4G modems on an AR9331 based processor?</p><p><a href="http://www.tp-link.com/us/products/details/?categoryid=218&amp;model=TL-MR3040">http://www.tp-link.com/us/products/deta … =TL-MR3040</a></p><p><a href="http://www.tp-link.com/us/support/3g-comp-list/?model=TL-MR3040">http://www.tp-link.com/us/support/3g-co … =TL-MR3040</a><br /><a href="http://www.tp-link.com/us/support/3g/">http://www.tp-link.com/us/support/3g/</a></p><p>I personally own a USB760 modem (one supported by TP-LINK) and know for a fact that this is a USB 1.1 device.</p>											<p class="post-edited">(Last edited by <strong>lsoltero</strong> on 13 Nov 2012, 20:38)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183167">
				<div class="post-metadata">
					<div class="post-num">Post #86</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						13 Nov 2012, 20:45					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>lsoltero wrote:</cite><blockquote><p>which begs the question...</p><p>how can TP-LINK sell TP-MR3040 routers which support a plethora of USB 1.1 GSM 3G and 4G modems on an AR9331 based processor?</p><p><a href="http://www.tp-link.com/us/products/details/?categoryid=218&amp;model=TL-MR3040">http://www.tp-link.com/us/products/deta … =TL-MR3040</a></p><p><a href="http://www.tp-link.com/us/support/3g-comp-list/?model=TL-MR3040">http://www.tp-link.com/us/support/3g-co … =TL-MR3040</a><br /><a href="http://www.tp-link.com/us/support/3g/">http://www.tp-link.com/us/support/3g/</a></p><p>I personally own a USB760 modem (one supported by TP-LINK) and know for a fact that this is a USB 1.1 device.</p></blockquote></div><p>As the USB760 integrates a removable microSD slot, are you sure it doesn&#039;t also contain an integrated High-Speed hub, such as a AU6350 chip?</p><p>How does it enumerate under OpenWrt? Directly, or do you also see a high-speed hub in-between?</p><p>Most modern 3G modems are High-Speed devices, and use /dev/HStty ports.</p>											<p class="post-edited">(Last edited by <strong>Squonk</strong> on 13 Nov 2012, 20:56)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183168">
				<div class="post-metadata">
					<div class="post-num">Post #87</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						13 Nov 2012, 20:56					</div>
				</div>
				<div class="post-content content">
					<p>no hub...</p><p>[50838.780000] usb 1-1: USB disconnect, device number 8<br />[50840.060000] usb 1-1: new full-speed USB device number 9 using ehci-platform</p><p>note that on openwrt i have to use usb_modeswitch to get it form the USB storage media to USB modem mode.</p><p>but... there is no HUB.&nbsp; </p><p>And BTW... I have not yet been able to get the USB760 working on WRT. Still trying to figure out how to get the virtual serial ports recognized on the system although the important thing here is to note that this is a supported device for TP-LINK and its a USB 1.1 device.</p><p>--luis</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183169">
				<div class="post-metadata">
					<div class="post-num">Post #88</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						13 Nov 2012, 20:58					</div>
				</div>
				<div class="post-content content">
					<p>BTW... just incase anyone cares... here is the usb_modswitch.conf file required to switch the mode on the U760</p><p>########################################################<br /># Novatel U760</p><p>DefaultVendor= 0x1410<br />DefaultProduct=0x5030</p><p>TargetVendor=&nbsp; 0x1410<br />TargetProduct= 0x6000</p><p>CheckSuccess=20</p><p>MessageContent=&quot;5553424312345678000000000000061b000000020000000000000000000000&quot;</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183170">
				<div class="post-metadata">
					<div class="post-num">Post #89</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						13 Nov 2012, 21:07					</div>
				</div>
				<div class="post-content content">
					<p>I don&#039;t know the exact details for this particular modem, but the fact that there is a microSD slot is a clue that it also contains some kind of hub, that TP-Link may be using when they have it working. I can&#039;t imagine they provide only a pretty useless only full-speed SDcard support (too slow), and if they have high speed, then why not use it for the modem too?</p><p>However, it will be difficult to check the list of supported 3G modems one by one and make sure they are full or high speed devices, and if they work reliably or not.</p><p>We should try if possible to get an confirmation by Atheros or some reliable 3rd-party of the fact that the AR9331 USB only supports EHCI and not OHCI, this would clear this issue definitely.</p><p>But it seriously looks like it is the case, and as for me, I am now buying small/cheap passive hubs <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p>											<p class="post-edited">(Last edited by <strong>Squonk</strong> on 13 Nov 2012, 21:09)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183171">
				<div class="post-metadata">
					<div class="post-num">Post #90</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						13 Nov 2012, 21:11					</div>
				</div>
				<div class="post-content content">
					<p>we are doing the same thing...</p><p>we are designing passive hubs to be included in our boards as well... sigh....</p><p>--luis</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p184522">
				<div class="post-metadata">
					<div class="post-num">Post #91</div>
					<div class="post-author">SharkAttack99</div>
					<div class="post-datetime">
						28 Nov 2012, 08:12					</div>
				</div>
				<div class="post-content content">
					<p>Does anyone know anything about why a passive hub fixes this issue, or maybe hooked up a scope to see what is going on? I&#039;m not familiar enough with the USB spec to make any logical guesses.</p><p>The issue I&#039;m seeing is actually a little different, as for some AR9331 devices from the same model have issues recognizing certain USB 2.0 high speed devices. The capacitor across C113 trick mentioned in other threads did not help, but a passive hub did. So I&#039;m wondering what exactly the hub does (timing, voltage levels?).</p><p>Thanks.</p>											<p class="post-edited">(Last edited by <strong>SharkAttack99</strong> on 28 Nov 2012, 08:51)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p184535">
				<div class="post-metadata">
					<div class="post-num">Post #92</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						28 Nov 2012, 09:50					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>SharkAttack99 wrote:</cite><blockquote><p>Does anyone know anything about why a passive hub fixes this issue, or maybe hooked up a scope to see what is going on? I&#039;m not familiar enough with the USB spec to make any logical guesses.</p></blockquote></div><p>With High-Speed USB, we speak of signals at 480Mbps... This would require at least a 10x oversampling to get the correct signal shape (Nyquist says 2x, but this is for sine waves...), so this requires in practice an expensive 5Gsps scope!!!</p><p>And then, the problem arises after from a few minutes to an hour, so you would have to find a way to trigger when something unknown happens, you can&#039;t just press &quot;record&quot; and search in there over this long period.</p><p>This is just to give you an hint on why it is so difficult, probably even for Atheros... It is like searching for (something that may not even be)&nbsp; a needle in a haystack.</p><div class="quotebox"><cite>SharkAttack99 wrote:</cite><blockquote><p>The issue I&#039;m seeing is actually a little different, as for some AR9331 devices from the same model have issues recognizing certain USB 2.0 high speed devices. The capacitor across C113 trick mentioned in other threads did not help, but a passive hub did. So I&#039;m wondering what exactly the hub does (timing, voltage levels?).</p></blockquote></div><p>It is probably a timing issue, as I was able to connect twice the same &quot;load&quot; (Arduino boards) through a passive hub and have it work perfectly for days, as opposed to a single &quot;load&quot; crashing after a few minutes when connected directly to the USB port.&nbsp; So it is probably not a voltage or current overload problem here. This is confirmed with the C113 not having any influence.</p><p>The problem may happen more often with some chips than with others, and there may also be a connection between wireless and the USB clock PLL loosing sync, but this is purely hypothetical at the moment. You may confirm that by disconnecting wireless while performing your tests, if this is possible.</p>											<p class="post-edited">(Last edited by <strong>Squonk</strong> on 28 Nov 2012, 09:50)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p184542">
				<div class="post-metadata">
					<div class="post-num">Post #93</div>
					<div class="post-author">SharkAttack99</div>
					<div class="post-datetime">
						28 Nov 2012, 10:32					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Squonk wrote:</cite><blockquote><p>The problem may happen more often with some chips than with others, and there may also be a connection between wireless and the USB clock PLL loosing sync, but this is purely hypothetical at the moment. You may confirm that by disconnecting wireless while performing your tests, if this is possible.</p></blockquote></div><p>Thanks for the response. And yes, it would require a very pricey scope. It does not appear WiFi related to me.</p><p>Though because it is an issue of the device not being recognized (or more precisely, the driver recognizes a USB device, but then times out trying to communicate with it) it is theoretically much easier to diagnose than the intermittent problem you see with the USB 1.0 devices.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p184543">
				<div class="post-metadata">
					<div class="post-num">Post #94</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						28 Nov 2012, 10:46					</div>
				</div>
				<div class="post-content content">
					<p>Your best bet would be to put a hardware USB analyzer in-between to see what is going on, but that&#039;s also a very expensive tool, not within reach for hobbyists.</p><p>Unless we you can catch it using a cheap USB &quot;spy&quot; device or capture software, but I doubt it would give anything good in HS.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p184546">
				<div class="post-metadata">
					<div class="post-num">Post #95</div>
					<div class="post-author">SharkAttack99</div>
					<div class="post-datetime">
						28 Nov 2012, 11:09					</div>
				</div>
				<div class="post-content content">
					<p>Yeah, I was thinking along the lines of a hardware USB analyzer, but it looks like starting price for a high speed is about a grand.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p184547">
				<div class="post-metadata">
					<div class="post-num">Post #96</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						28 Nov 2012, 11:14					</div>
				</div>
				<div class="post-content content">
					<p>Maybe rent one?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p184610">
				<div class="post-metadata">
					<div class="post-num">Post #97</div>
					<div class="post-author">SharkAttack99</div>
					<div class="post-datetime">
						28 Nov 2012, 21:56					</div>
				</div>
				<div class="post-content content">
					<p>Well if I ever figure anything out I&#039;ll be sure to update this thread so others can perhaps benefit.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p185831">
				<div class="post-metadata">
					<div class="post-num">Post #98</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						12 Dec 2012, 13:32					</div>
				</div>
				<div class="post-content content">
					<p>hello all,</p><p>here is a very interesting find...Its the complete data sheet for the AR9331</p><p><a href="https://forum.openwrt.org/viewtopic.php?pid=185817#p185817">https://forum.openwrt.org/viewtopic.php … 17#p185817</a></p><p>I have looked at it and cant make much sense of it.&nbsp; Maybe someone with a better understanding of the OpenWRT USB implementation can use this document to tell us once and for all of this chipset supports USB 1.1 devices.</p><p>--luis</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p185839">
				<div class="post-metadata">
					<div class="post-num">Post #99</div>
					<div class="post-author">robthebrew</div>
					<div class="post-datetime">
						12 Dec 2012, 14:39					</div>
				</div>
				<div class="post-content content">
					<p>Nice find Isoltero. A quick glance through suggests the chip can do high-speed and full-speed (ie USB 1 and 2). So maybe it is the firmware incorrectly setting the select-bits, or it is the circuit design.<br />This is beyond my knowledge though. Squonk??</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p185843">
				<div class="post-metadata">
					<div class="post-num">Post #100</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						12 Dec 2012, 15:07					</div>
				</div>
				<div class="post-content content">
					<p>Be careful, some parts of the datasheet (p 237) which seem to be generic tell about low/full speed hand-off, but in some other parts, it is explicitly told that there is no hand-off (pp 251-252).</p><p>It isn&#039;t the circuit design: this happens on several models from TP-Link and Alfa (at least...) which only have in common that they are AR9331-based.</p><p>From my experience with the TP-Link T-WR703N, the routing is clean with controlled length and impedance traces, no stub, and only ESD protection devices in the middle.</p><p>It is not related to the chip revision either, but results may vary largely from one chip to the other.</p><p>Also, if you turn off the wireless, you have no longer problems... Same if you insert a passive hub.</p><p>It looks like wireless radio interferes with the USB clock PLL in some way, only in full-speed mode...</p><p>Any idea?</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 4 of 13</div><nav><ul><li><a href="viewtopic.php%3Fid=39956&amp;p=1.html">1</a></li><li><a href="viewtopic.php%3Fid=39956&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=39956&amp;p=3.html">3</a></li><li class="pagination-current"><span>4</span></li><li><a href="viewtopic.php%3Fid=39956&amp;p=5.html">5</a></li><li><a href="viewtopic.php%3Fid=39956&amp;p=6.html">6</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39956&amp;p=13.html">13</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>