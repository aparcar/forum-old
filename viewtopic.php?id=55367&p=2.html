<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Netgear R8000 support?</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 23 Mar 2018 and 5 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 2 of 19</div><nav><ul><li><a href="viewtopic.php%3Fid=55367&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=55367&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=55367&amp;p=4.html">4</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=55367&amp;p=19.html">19</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p263492">
				<div class="post-metadata">
					<div class="post-num">Post #26</div>
					<div class="post-author">raven-au</div>
					<div class="post-datetime">
						30 Jan 2015, 12:27					</div>
				</div>
				<div class="post-content content">
					<p>OK, system boots but PCI bus doesn&#039;t look like it&#039;s getting detected.</p><p>Here&#039;s the log.<br /><a href="https://www.dropbox.com/s/pnzmx8mqa6gx9nc/openwrt-boot.log?dl=0">https://www.dropbox.com/s/pnzmx8mqa6gx9 … t.log?dl=0</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p263494">
				<div class="post-metadata">
					<div class="post-num">Post #27</div>
					<div class="post-author">Zajec</div>
					<div class="post-datetime">
						30 Jan 2015, 12:45					</div>
				</div>
				<div class="post-content content">
					<p>Oh, it seems you have your partitions there. That&#039;s nice!</p><p>I can see 3 problems there:</p><p>1) PCIe host controller<br />You&#039;re right, there is something wrong. I won&#039;t be able to fix it in the next days and on Monday I&#039;m leaving for a week.</p><p>2) Ethernet MAC<br />For some reason NVRAM doesn&#039;t seem to provide valid MAC addr:</p><div class="codebox"><pre><code>bgmac bcma0:3: Invalid MAC addr: 00:00:00:00:00:00
bgmac bcma0:3: Using random MAC: 16:4a:0e:2d:fa:56</code></pre></div><p>Can you provide me output of &quot;nvram show&quot;?</p><p>3) LEDs and buttons<br />It would be nice to support them. Can you take a look at our howto:<br /><a href="http://wiki.openwrt.org/doc/devel/add.new.device#gpios">http://wiki.openwrt.org/doc/devel/add.new.device#gpios</a><br />and try to find GPIOs controlling LEDs &amp; buttons?</p>											<p class="post-edited">(Last edited by <strong>Zajec</strong> on 30 Jan 2015, 12:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p263496">
				<div class="post-metadata">
					<div class="post-num">Post #28</div>
					<div class="post-author">raven-au</div>
					<div class="post-datetime">
						30 Jan 2015, 12:52					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Zajec wrote:</cite><blockquote><p>Oh, it seems you have your partitions there. That&#039;s nice!</p><p>I can see 3 problems there:</p><p>1) PCIe host controller<br />You&#039;re right, there is something wrong. I won&#039;t be able to fix it in the next days and on Monday I&#039;m leaving for a week.</p></blockquote></div><p>Yep.</p><div class="quotebox"><cite>Zajec wrote:</cite><blockquote><p>2) Ethernet MAC<br />For some reason NVRAM doesn&#039;t seem to provide valid MAC addr:</p><div class="codebox"><pre><code>bgmac bcma0:3: Invalid MAC addr: 00:00:00:00:00:00
bgmac bcma0:3: Using random MAC: 16:4a:0e:2d:fa:56</code></pre></div><p>Can you provide me output of &quot;nvram show&quot;?</p></blockquote></div><p>Will the &quot;nvram show&quot; from the Netgear firmware be OK?</p><br /><div class="quotebox"><cite>Zajec wrote:</cite><blockquote><p>3) LEDs and buttons<br />It would be nice to support them. Can you take a look at our howto:<br /><a href="http://wiki.openwrt.org/doc/devel/add.new.device#gpios">http://wiki.openwrt.org/doc/devel/add.new.device#gpios</a><br />and try to find GPIOs controlling LEDs &amp; buttons?</p></blockquote></div><p>Sure, will try and have something for you on your return.<br />I also need to tear myself away from this to catch up on work.</p><p>Ian</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p263500">
				<div class="post-metadata">
					<div class="post-num">Post #29</div>
					<div class="post-author">Zajec</div>
					<div class="post-datetime">
						30 Jan 2015, 13:11					</div>
				</div>
				<div class="post-content content">
					<p>Ahh, I can see the problem with MAC address. This unit uses pretty new SPROM revision, see:</p><div class="codebox"><pre><code>sromrev=11</code></pre></div><p>However there should be &quot;Unsupported SPROM revision&quot; in OpenWrt boot log, no idea why it didn&#039;t appear <img src="https://forum.openwrt.org/img/smilies/neutral.png" width="15" height="15" alt="neutral" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p263501">
				<div class="post-metadata">
					<div class="post-num">Post #30</div>
					<div class="post-author">raven-au</div>
					<div class="post-datetime">
						30 Jan 2015, 13:15					</div>
				</div>
				<div class="post-content content">
					<p>Here is &quot;nvram show&quot; from the Netgear firmware install.<br /><a href="https://www.dropbox.com/s/auy2mpfx0acis1y/nvram-show.log?dl=0">https://www.dropbox.com/s/auy2mpfx0acis … w.log?dl=0</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p263502">
				<div class="post-metadata">
					<div class="post-num">Post #31</div>
					<div class="post-author">raven-au</div>
					<div class="post-datetime">
						30 Jan 2015, 13:24					</div>
				</div>
				<div class="post-content content">
					<p>Any thoughts on why the PCI bus discovery isn&#039;t working?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p263504">
				<div class="post-metadata">
					<div class="post-num">Post #32</div>
					<div class="post-author">Zajec</div>
					<div class="post-datetime">
						30 Jan 2015, 13:26					</div>
				</div>
				<div class="post-content content">
					<p>No. You have to look for some problems in target/linux/bcm53xx/patches-3.14/170-pcie2-bcma-add-new-PCIe2-driver-for-bcma.patch</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p263506">
				<div class="post-metadata">
					<div class="post-num">Post #33</div>
					<div class="post-author">raven-au</div>
					<div class="post-datetime">
						30 Jan 2015, 13:32					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Zajec wrote:</cite><blockquote><p>No. You have to look for some problems in target/linux/bcm53xx/patches-3.14/170-pcie2-bcma-add-new-PCIe2-driver-for-bcma.patch</p></blockquote></div><p>Will do, not familiar with this though.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p263974">
				<div class="post-metadata">
					<div class="post-num">Post #34</div>
					<div class="post-author">raven-au</div>
					<div class="post-datetime">
						3 Feb 2015, 11:09					</div>
				</div>
				<div class="post-content content">
					<p>Here&#039;s an interesting bit of information.</p><p>AFAICS these devices don&#039;t have an SPROM!</p><p>Now, someone probably already knows that because under the bcm53xx target there&#039;s this file files/drivers/misc/bcm47xx-sprom.c.<br />OK, so this driver provides nvram -&gt; sprom mapping, supposedly, to be used when there&#039;s no SPROM available.<br />OK, again, but it loads afrter the bcma module which calls the SPROM load.<br />So we can play with module load order to fix that.</p><p>Obviously the nvram -&gt; sprom driver needs an nvram module.<br />OK, again even.<br />But the nvram module looks like requires an MTD module and we even see a driver for this at files/drivers/mtd/spi-nor/bcm53xxspiflash.c.<br />But that driver looks like it needs the base MTD and probably the SPI driver.</p><p>Not OK, since it looks like the pci bus scan must be completed for these modules to load.<br />OOPS!</p><p>Someone tell me I&#039;m wrong, please!<br />Ian</p>											<p class="post-edited">(Last edited by <strong>raven-au</strong> on 3 Feb 2015, 11:10)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p264103">
				<div class="post-metadata">
					<div class="post-num">Post #35</div>
					<div class="post-author">raven-au</div>
					<div class="post-datetime">
						4 Feb 2015, 08:48					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>raven-au wrote:</cite><blockquote><p>AFAICS these devices don&#039;t have an SPROM!</p><p>Now, someone probably already knows that because under the bcm53xx target there&#039;s this file files/drivers/misc/bcm47xx-sprom.c.<br />OK, so this driver provides nvram -&gt; sprom mapping, supposedly, to be used when there&#039;s no SPROM available.<br />OK, again, but it loads afrter the bcma module which calls the SPROM load.<br />So we can play with module load order to fix that.</p><p>Obviously the nvram -&gt; sprom driver needs an nvram module.<br />OK, again even.<br />But the nvram module looks like requires an MTD module and we even see a driver for this at files/drivers/mtd/spi-nor/bcm53xxspiflash.c.<br />But that driver looks like it needs the base MTD and probably the SPI driver.</p><p>Not OK, since it looks like the pci bus scan must be completed for these modules to load.<br />OOPS!</p><p>Someone tell me I&#039;m wrong, please!<br />Ian</p></blockquote></div><p>In answer to my own question, no the MTD subsystem shouldn&#039;t be needed.</p><p>Provided that the sprom driver that implements the fallback SPROM provider is loaded early enough.<br />And a special call is made to the nvram -&gt; sprom driver to prime the lookup cache which has been written to scan the NAND device for the nvram variables and read them in before calling the&nbsp; fallback SPROM provider.</p><p>Now, if I can get that to work, all that needs to be done is add support for the differences in the revision 11 sprom variables.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p264721">
				<div class="post-metadata">
					<div class="post-num">Post #36</div>
					<div class="post-author">Zajec</div>
					<div class="post-datetime">
						9 Feb 2015, 01:05					</div>
				</div>
				<div class="post-content content">
					<p>You are overthinking that. Everything you need is already in place.<br />1) NVRAM is built-in exporting simple symbols<br />2) bcma registers SPI &amp; NAND cores before any NVRAM entry is needed<br />3) SPI core driver loads, registers SPI master<br />4) mtd SPI driver loads, registers MTD and &quot;nvram&quot; partition<br />5) NVRAM starts working (entries can be read)<br />6) bcma triggers reading SPROM from NVRAM<br />7) bcma registers rest of cores</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p264733">
				<div class="post-metadata">
					<div class="post-num">Post #37</div>
					<div class="post-author">raven-au</div>
					<div class="post-datetime">
						9 Feb 2015, 02:59					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Zajec wrote:</cite><blockquote><p>You are overthinking that. Everything you need is already in place.<br />1) NVRAM is built-in exporting simple symbols<br />2) bcma registers SPI &amp; NAND cores before any NVRAM entry is needed<br />3) SPI core driver loads, registers SPI master<br />4) mtd SPI driver loads, registers MTD and &quot;nvram&quot; partition<br />5) NVRAM starts working (entries can be read)<br />6) bcma triggers reading SPROM from NVRAM<br />7) bcma registers rest of cores</p></blockquote></div><p>The messages</p><p>bcma: bus0: Using fallback SPROM failed (err -2)<br />bcma: bus0: No SPROM available<br />bma: bus0: Bus registered</p><p>definitely come before those other modules load.</p><p>There&#039;s an entry point in&nbsp; files/drivers/firmware/broadcom/bcm47xx_nvram.c,&nbsp; bcm47xx_nvram_init_from_mem(), specifically for the early access but I can&#039;t work out what should be used for the parameters to the function.</p><p>The above messages result from a call to bcma_sprom_get() in bcma_bus_register() which is done before any of the steps above occur.</p><p>However, as you say, the values aren&#039;t actually needed by anything until much later so maybe it isn&#039;t important.<br />It&#039;s worth another look and there&#039;s still the question of whether these devices actually have an SPROM.</p><p>TBH I&#039;m more concerned with the pci scan failures and it&#039;s not worth doing anything else until that can be sorted out since pretty much nothing works. In particular no switch and no gpios.</p><p>It may be related to the device having a BCM53012 rather than a BCM53011 which the code seems to be aware of and, I guess, knows how to handle.</p><p>The only thing I know for sure is that at a certain point an attempt is made by the pci subsystem to read standard pci header values which fails.<br />But the device should be returning something different for a device that isn&#039;t present so the pci subsystem knows it or the read is not using the correct hardware access method, perhaps because it hasn&#039;t actually seen a BCM53012 before or perhaps the dts definition isn&#039;t quite right, not sure.</p><p>Have a look at this log:<br /><a href="https://www.dropbox.com/s/g51782t4p23rius/openwrt-pci-prob-boot.log?dl=0">https://www.dropbox.com/s/g51782t4p23ri … t.log?dl=0</a></p><p>You can see where this goes pear shaped.<br />Any suggestions.</p><p>Ian</p>											<p class="post-edited">(Last edited by <strong>raven-au</strong> on 9 Feb 2015, 04:30)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p264745">
				<div class="post-metadata">
					<div class="post-num">Post #38</div>
					<div class="post-author">Zajec</div>
					<div class="post-datetime">
						9 Feb 2015, 09:00					</div>
				</div>
				<div class="post-content content">
					<p>Oops, shit. I see the problem now, it appears on other Broadcom ARM devices as well.<br />At least it&#039;s clear now why there isn&#039;t &quot;Unsupported SPROM revision&quot; in the log.</p><p>To make it more interesting, building SPROM was working earlier, it&#039;s a regression since dropping some hacky code:<br /><a href="https://dev.openwrt.org/changeset/43981/">https://dev.openwrt.org/changeset/43981/</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p264748">
				<div class="post-metadata">
					<div class="post-num">Post #39</div>
					<div class="post-author">raven-au</div>
					<div class="post-datetime">
						9 Feb 2015, 10:07					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Zajec wrote:</cite><blockquote><p>Oops, shit. I see the problem now, it appears on other Broadcom ARM devices as well.<br />At least it&#039;s clear now why there isn&#039;t &quot;Unsupported SPROM revision&quot; in the log.</p><p>To make it more interesting, building SPROM was working earlier, it&#039;s a regression since dropping some hacky code:<br /><a href="https://dev.openwrt.org/changeset/43981/">https://dev.openwrt.org/changeset/43981/</a></p></blockquote></div><p>LOL, so my reading of the code wasn&#039;t completely wrong.<br />We can return to this later although I wonder what effect that might have on the bus scan&nbsp; .....</p><p>I&#039;ll add that patch back and see what happens just so I know.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p264806">
				<div class="post-metadata">
					<div class="post-num">Post #40</div>
					<div class="post-author">Zajec</div>
					<div class="post-datetime">
						9 Feb 2015, 20:44					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>raven-au wrote:</cite><blockquote><p>I&#039;ll add that patch back and see what happens just so I know.</p></blockquote></div><p>I&#039;ve added a bit more sane patch, see<br /><a href="https://dev.openwrt.org/changeset/44367/">https://dev.openwrt.org/changeset/44367/</a></p><p>Let me know if you get a message about SPROM revision now and maybe try to find GPIOs in some free time <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>											<p class="post-edited">(Last edited by <strong>Zajec</strong> on 9 Feb 2015, 20:45)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p264850">
				<div class="post-metadata">
					<div class="post-num">Post #41</div>
					<div class="post-author">raven-au</div>
					<div class="post-datetime">
						10 Feb 2015, 02:19					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Zajec wrote:</cite><blockquote><div class="quotebox"><cite>raven-au wrote:</cite><blockquote><p>I&#039;ll add that patch back and see what happens just so I know.</p></blockquote></div><p>I&#039;ve added a bit more sane patch, see<br /><a href="https://dev.openwrt.org/changeset/44367/">https://dev.openwrt.org/changeset/44367/</a></p><p>Let me know if you get a message about SPROM revision now and maybe try to find GPIOs in some free time <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></blockquote></div><p>I&#039;ll give it a try but the bus scan still fails with the old patch so, no switch, no gpios etc.<br />I&#039;m not sure this will make a difference to that.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p264884">
				<div class="post-metadata">
					<div class="post-num">Post #42</div>
					<div class="post-author">raven-au</div>
					<div class="post-datetime">
						10 Feb 2015, 10:57					</div>
				</div>
				<div class="post-content content">
					<p>I was looking at bgmac.c and noticed something odd.</p><p>There are a number of checks for, for example BCMA_CHIP_ID_BCM4707, and in most cases they use struct bcma_chipinfo from the struct bcma_device. But a couple use the id from struct bcma_device_id.</p><p>On my device the bcma_chipinfo id corresponds to, for example BCMA_CHIP_ID_BCM4707, whereas the bcma_device_id corresponds to the switch id so in the (I think two) cases where bcma_device_id is used the check will never succeed.</p><p>That looks wrong to me because, for example, in bgmac_chip_reset() it refers to doing the reset in bgmac_probe() but in bgmac_probe() the reset won&#039;t be done due to this.</p><p>Thoughts?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p264885">
				<div class="post-metadata">
					<div class="post-num">Post #43</div>
					<div class="post-author">raven-au</div>
					<div class="post-datetime">
						10 Feb 2015, 11:04					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>raven-au wrote:</cite><blockquote><div class="quotebox"><cite>Zajec wrote:</cite><blockquote><div class="quotebox"><cite>raven-au wrote:</cite><blockquote><p>I&#039;ll add that patch back and see what happens just so I know.</p></blockquote></div><p>I&#039;ve added a bit more sane patch, see<br /><a href="https://dev.openwrt.org/changeset/44367/">https://dev.openwrt.org/changeset/44367/</a></p><p>Let me know if you get a message about SPROM revision now and maybe try to find GPIOs in some free time <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></blockquote></div><p>I&#039;ll give it a try but the bus scan still fails with the old patch so, no switch, no gpios etc.<br />I&#039;m not sure this will make a difference to that.</p></blockquote></div><p>And it didn&#039;t, *sigh*.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p264901">
				<div class="post-metadata">
					<div class="post-num">Post #44</div>
					<div class="post-author">raven-au</div>
					<div class="post-datetime">
						10 Feb 2015, 12:57					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>raven-au wrote:</cite><blockquote><div class="quotebox"><cite>Zajec wrote:</cite><blockquote><div class="quotebox"><cite>raven-au wrote:</cite><blockquote><p>I&#039;ll add that patch back and see what happens just so I know.</p></blockquote></div><p>I&#039;ve added a bit more sane patch, see<br /><a href="https://dev.openwrt.org/changeset/44367/">https://dev.openwrt.org/changeset/44367/</a></p><p>Let me know if you get a message about SPROM revision now and maybe try to find GPIOs in some free time <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></blockquote></div><p>I&#039;ll give it a try but the bus scan still fails with the old patch so, no switch, no gpios etc.<br />I&#039;m not sure this will make a difference to that.</p></blockquote></div><p>I should have also mentioned I did get the expected message about the SPROM revision.<br />I guess it&#039;s worth updating that to deal with rev 11 regardless of how this progresses.<br />Is this page sufficiently up to date?<br /><a href="http://bcm-v4.sipsolutions.net/SPROM">http://bcm-v4.sipsolutions.net/SPROM</a></p><p>It does specify rev 11 differences.<br />Ian</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p264930">
				<div class="post-metadata">
					<div class="post-num">Post #45</div>
					<div class="post-author">Zajec</div>
					<div class="post-datetime">
						10 Feb 2015, 15:18					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>raven-au wrote:</cite><blockquote><div class="quotebox"><cite>raven-au wrote:</cite><blockquote><p>I&#039;ll give it a try but the bus scan still fails with the old patch so, no switch, no gpios etc.<br />I&#039;m not sure this will make a difference to that.</p></blockquote></div><p>And it didn&#039;t, *sigh*.</p></blockquote></div><p>Please provide a log, otherwise we know nothing <img src="https://forum.openwrt.org/img/smilies/neutral.png" width="15" height="15" alt="neutral" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p264943">
				<div class="post-metadata">
					<div class="post-num">Post #46</div>
					<div class="post-author">raven-au</div>
					<div class="post-datetime">
						10 Feb 2015, 16:15					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Zajec wrote:</cite><blockquote><div class="quotebox"><cite>raven-au wrote:</cite><blockquote><div class="quotebox"><cite>raven-au wrote:</cite><blockquote><p>I&#039;ll give it a try but the bus scan still fails with the old patch so, no switch, no gpios etc.<br />I&#039;m not sure this will make a difference to that.</p></blockquote></div><p>And it didn&#039;t, *sigh*.</p></blockquote></div><p>Please provide a log, otherwise we know nothing <img src="https://forum.openwrt.org/img/smilies/neutral.png" width="15" height="15" alt="neutral" /></p></blockquote></div><p>These logs are older (I&#039;ll add printks again later if needed) but the recent log messages I see indicate the problem is occurring in the same way at the same place.</p><p>A boot log:<br /><a href="https://www.dropbox.com/s/g51782t4p23rius/openwrt-pci-prob-boot.log?dl=0">https://www.dropbox.com/s/g51782t4p23ri … t.log?dl=0</a></p><p>and the dmesg output after the boot has slightly more info:<br /><a href="https://www.dropbox.com/s/9c2pyj57jve7h09/openwrt-pci-prob-dmesg.log?dl=0">https://www.dropbox.com/s/9c2pyj57jve7h … g.log?dl=0</a></p><p>It&nbsp; looks like a device is hung somehow and is returning rubbish.<br />Not quite which device it is...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p265345">
				<div class="post-metadata">
					<div class="post-num">Post #47</div>
					<div class="post-author">raven-au</div>
					<div class="post-datetime">
						13 Feb 2015, 04:58					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>raven-au wrote:</cite><blockquote><div class="quotebox"><cite>Zajec wrote:</cite><blockquote><div class="quotebox"><cite>raven-au wrote:</cite><blockquote><p>And it didn&#039;t, *sigh*.</p></blockquote></div><p>Please provide a log, otherwise we know nothing <img src="https://forum.openwrt.org/img/smilies/neutral.png" width="15" height="15" alt="neutral" /></p></blockquote></div><p>These logs are older (I&#039;ll add printks again later if needed) but the recent log messages I see indicate the problem is occurring in the same way at the same place.</p><p>A boot log:<br /><a href="https://www.dropbox.com/s/g51782t4p23rius/openwrt-pci-prob-boot.log?dl=0">https://www.dropbox.com/s/g51782t4p23ri … t.log?dl=0</a></p><p>and the dmesg output after the boot has slightly more info:<br /><a href="https://www.dropbox.com/s/9c2pyj57jve7h09/openwrt-pci-prob-dmesg.log?dl=0">https://www.dropbox.com/s/9c2pyj57jve7h … g.log?dl=0</a></p><p>It&nbsp; looks like a device is hung somehow and is returning rubbish.<br />Not quite which device it is...</p></blockquote></div><p>@Zajec, no thoughts on this?</p><p>Perhaps it&#039;s the PEX8603 that&#039;s causing confusion, I can&#039;t see any driver for this?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p265798">
				<div class="post-metadata">
					<div class="post-num">Post #48</div>
					<div class="post-author">Zajec</div>
					<div class="post-datetime">
						16 Feb 2015, 20:20					</div>
				</div>
				<div class="post-content content">
					<p>OK, I finally resolved other issues and got time to look at this R8000.</p><br /><div class="quotebox"><cite>raven-au wrote:</cite><blockquote><div class="quotebox"><cite>Zajec wrote:</cite><blockquote><p>I&#039;ve added a bit more sane patch, see<br /><a href="https://dev.openwrt.org/changeset/44367/">https://dev.openwrt.org/changeset/44367/</a></p><p>Let me know if you get a message about SPROM revision now and maybe try to find GPIOs in some free time <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></blockquote></div><p>I&#039;ll give it a try but the bus scan still fails with the old patch so, no switch, no gpios etc.<br />I&#039;m not sure this will make a difference to that.</p></blockquote></div><p>I took a look at log you provided (openwrt-pci-prob-boot.log) and:<br /></p><ol class="decimal"><li><p>It uses r44186 so it doesn&#039;t contain my fix for bus loading. It was added in r44367.</p></li><li><p>I see &quot;bcma: bus0: Found chip with id 53010, rev 0x00 and package 0x00&quot; and many devices below, so bus scanning seems to work.</p></li><li><p>Switch won&#039;t work because of using old revision. You need r44367 to get SPROM working. You need SPROM to get bgmac working. You need bgmac to get switch working.</p></li><li><p>I don&#039;t see any GPIO error, is /sys/class/gpio empty for you or something?</p></li></ol><br /><div class="quotebox"><cite>raven-au wrote:</cite><blockquote><p>I was looking at bgmac.c and noticed something odd.</p><p>There are a number of checks for, for example BCMA_CHIP_ID_BCM4707, and in most cases they use struct bcma_chipinfo from the struct bcma_device. But a couple use the id from struct bcma_device_id.</p></blockquote></div><p>A very nice catch, thank you! Fixed in:<br /><a href="https://git.kernel.org/cgit/linux/kernel/git/davem/net.git/commit/?id=21697336d46b71dd031f29e426dda0b1e7f06cc0">https://git.kernel.org/cgit/linux/kerne … b1e7f06cc0</a><br /><a href="https://dev.openwrt.org/changeset/44411/">https://dev.openwrt.org/changeset/44411/</a></p><br /><div class="quotebox"><cite>raven-au wrote:</cite><blockquote><p>I should have also mentioned I did get the expected message about the SPROM revision.<br />I guess it&#039;s worth updating that to deal with rev 11 regardless of how this progresses.<br />Is this page sufficiently up to date?<br /><a href="http://bcm-v4.sipsolutions.net/SPROM">http://bcm-v4.sipsolutions.net/SPROM</a></p><p>It does specify rev 11 differences.</p></blockquote></div><p>I think we can use bcmsrom_tbl.h, it&#039;s open source and can be Googled easily.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p265799">
				<div class="post-metadata">
					<div class="post-num">Post #49</div>
					<div class="post-author">Zajec</div>
					<div class="post-datetime">
						16 Feb 2015, 20:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>raven-au wrote:</cite><blockquote><p>These logs are older (I&#039;ll add printks again later if needed) but the recent log messages I see indicate the problem is occurring in the same way at the same place.</p><p>A boot log:<br /><a href="https://www.dropbox.com/s/g51782t4p23rius/openwrt-pci-prob-boot.log?dl=0">https://www.dropbox.com/s/g51782t4p23ri … t.log?dl=0</a></p><p>and the dmesg output after the boot has slightly more info:<br /><a href="https://www.dropbox.com/s/9c2pyj57jve7h09/openwrt-pci-prob-dmesg.log?dl=0">https://www.dropbox.com/s/9c2pyj57jve7h … g.log?dl=0</a></p><p>It&nbsp; looks like a device is hung somehow and is returning rubbish.<br />Not quite which device it is...</p></blockquote></div><p>I finally took a look at this PCI problem. I was looking at above logs and another one you shared on IRC: <a href="https://www.dropbox.com/s/1uv912m0cj3iktl/netgear-fw-devices.txt?dl=0">https://www.dropbox.com/s/1uv912m0cj3ik … s.txt?dl=0</a></p><p>First of all, I&#039;m a bit surprised how PCI host/devices are connected. This router contains 3 PCIe devices and has 3 PCIe hosts, so I expected there will be one device per PCIe host. In other words I expected 3 separated PCI domains. This is not really the case:</p><div class="codebox"><pre><code>[    0.602917] pci_host_bcm5301x bcma0:7: initializing PCIe controller
[    0.880319] pci_host_bcm5301x bcma0:7: link: UP
[    0.886400] pci_host_bcm5301x bcma0:7: PCI host bridge to bus 0000:00
[    1.018950] pci_host_bcm5301x bcma0:8: initializing PCIe controller
[    1.300309] pci_host_bcm5301x bcma0:8: link: UP
[    1.306346] pci_host_bcm5301x bcma0:8: PCI host bridge to bus 0001:00
[    2.377650] pci_host_bcm5301x bcma0:9: initializing PCIe controller
[    2.770308] pci_host_bcm5301x bcma0:9: link: DOWN</code></pre></div><p>Worth noting when looking at this issue.</p><p>So the first domain (0001: for Broadcom firmware, 0000: for OpenWrt) contains 2 buses:<br /></p><ol class="decimal"><li><p>One with just a 14e4:8012.</p></li><li><p>Another with just a 14e4:aa52. It seems brcmfmac may be missing 14e4:aa52 entry.</p></li></ol><p>The 2nd domain (0002: for Broadcom firmware, 0001: for OpenWrt) contains 5 buses:<br /></p><ol class="decimal"><li><p>1 device with ID 14e4:8012</p></li><li><p>1 device with ID 10b5:8603</p></li><li><p>2 devices, both 10b5:8603</p></li><li><p>1 device with ID 14e4:aa52</p></li><li><p>1 device with ID 14e4:aa52</p></li></ol><p>The first PCI domain (with a 1st BCM43602) seems to be working fine with OpenWrt.</p><p>In case on 2nd domain (with two BCM43602 as last buses) there are following errors that could worry us:</p><div class="codebox"><pre><code>[    1.456450] pci 0001:03:00.0: BAR 2: can&#039;t assign mem (size 0x400000)
[    1.464640] pci 0001:03:00.0: BAR 0: can&#039;t assign mem (size 0x8000)
[    1.478950] pci 0001:04:00.0: BAR 2: can&#039;t assign mem (size 0x400000)
[    1.487142] pci 0001:04:00.0: BAR 0: can&#039;t assign mem (size 0x8000)</code></pre></div><p>It may be worth to check if we try assigning memory correcty in our PCI host driver.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p265838">
				<div class="post-metadata">
					<div class="post-num">Post #50</div>
					<div class="post-author">raven-au</div>
					<div class="post-datetime">
						17 Feb 2015, 02:47					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Zajec wrote:</cite><blockquote><p>OK, I finally resolved other issues and got time to look at this R8000.</p></blockquote></div><p>Right, thanks for looking at this.</p><br /><div class="quotebox"><cite>Zajec wrote:</cite><blockquote><p>I don&#039;t see any GPIO error, is /sys/class/gpio empty for you or something?</p></blockquote></div><p>Yeah, either it didn&#039;t work last time I tried or I didn&#039;t perform the procedure correctly.<br />I tried the gpios again yesterday and I was able to make the power light go off and then on.</p><p>I&#039;ll work through the gpio process and get back with the info.</p><p>Umm, what should I do about leds that have three states, off, white (on) and and Amber (error or pending)?</p>									</div>
			</article>

			
		
						<div class="notice">
				<p>Sorry, posts 51 to 50 are missing from our archive.</p>
			</div>
		
		
	
	<div class="pagination"><div class="pagination-number">Page 2 of 19</div><nav><ul><li><a href="viewtopic.php%3Fid=55367&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=55367&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=55367&amp;p=4.html">4</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=55367&amp;p=19.html">19</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>