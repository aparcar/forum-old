<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> possible? (Traffic Shaping)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 13 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p11709">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">Morbid Angel</div>
					<div class="post-datetime">
						4 Sep 2005, 15:24					</div>
				</div>
				<div class="post-content content">
					<p>I have used the following script traffic shaping with debian sid, it is possible to &quot;translate&quot; it to ash and use it with openwrt? <br />Can someone do it? </p><p>#!/bin/bash<br />#<br />#&nbsp; &nbsp; htb.init v0.8.5<br />#&nbsp; &nbsp; Copyright (C) 2002-2004&nbsp; Lubomir Bulej &lt;pallas@kadan.cz&gt;<br />#<br />#&nbsp; &nbsp; chkconfig:&nbsp; &nbsp;2345 11 89<br />#&nbsp; &nbsp; description: script to set up HTB traffic control<br />#<br />#&nbsp; &nbsp; This program is free software; you can redistribute it and/or modify<br />#&nbsp; &nbsp; it under the terms of the GNU General Public License as published by<br />#&nbsp; &nbsp; the Free Software Foundation; either version 2 of the License, or<br />#&nbsp; &nbsp; (at your option) any later version.<br />#<br />#&nbsp; &nbsp; This program is distributed in the hope that it will be useful,<br />#&nbsp; &nbsp; but WITHOUT ANY WARRANTY; without even the implied warranty of<br />#&nbsp; &nbsp; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&nbsp; See the<br />#&nbsp; &nbsp; GNU General Public License for more details.<br />#<br />#&nbsp; &nbsp; You should have received a copy of the GNU General Public License<br />#&nbsp; &nbsp; along with this program; if not, write to the Free Software<br />#&nbsp; &nbsp; Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA&nbsp; 02111-1307&nbsp; USA<br />#<br />#&nbsp; &nbsp; To get the latest version, check on Freshmeat for actual location:<br />#<br />#&nbsp; &nbsp; &nbsp; &nbsp; <a href="http://freshmeat.net/projects/htb.init">http://freshmeat.net/projects/htb.init</a><br />#<br />#<br /># VERSION HISTORY<br /># ---------------<br /># v0.8.5- Nathan Shafer &lt;nicodemus at users.sourceforge.net&gt;<br />#&nbsp; &nbsp;&nbsp; &nbsp;- allow symlins to class files<br />#&nbsp; &nbsp; - Seth J. Blank &lt;antifreeze at users.sourceforge.net&gt;<br />#&nbsp; &nbsp;&nbsp; &nbsp;- replace hardcoded ip/tc location with variables<br />#&nbsp; &nbsp; - Mark Davis &lt;mark.davis at gmx.de&gt;<br />#&nbsp; &nbsp;&nbsp; &nbsp;- allow setting of PRIO_{MARK,RULE,REALM} in class file<br /># v0.8.4- Lubomir Bulej &lt;pallas at kadan.cz&gt;<br />#&nbsp; &nbsp;&nbsp; &nbsp;- fixed small bug in RULE parser to correctly parse<br />#&nbsp; &nbsp;&nbsp; &nbsp; &nbsp;rules with identical source and destination fields<br />#&nbsp; &nbsp;&nbsp; &nbsp;- removed the experimental INJECT keyword<br />#&nbsp; &nbsp;&nbsp; &nbsp;- ignore *~ backup files when looking for classes<br />#&nbsp; &nbsp; - Mike Boyer &lt;boyer at administrative.com&gt;<br />#&nbsp; &nbsp;&nbsp; &nbsp;- fix to allow arguments to be passed to &quot;restart&quot; command<br />#&nbsp; &nbsp; - &lt;face at pos.sk&gt;<br />#&nbsp; &nbsp;&nbsp; &nbsp;- fix to preserve class priority after timecheck<br /># v0.8.3- Lubomir Bulej &lt;pallas at kadan.cz&gt;<br />#&nbsp; &nbsp;&nbsp; &nbsp;- use LC_COLLATE=&quot;C&quot; when sorting class files<br />#&nbsp; &nbsp; - Paulo Sedrez<br />#&nbsp; &nbsp;&nbsp; &nbsp;- fix time2abs to allow hours with leading zero in TIME rules<br /># v0.8.2- Lubomir Bulej &lt;pallas at kadan.cz&gt;<br />#&nbsp; &nbsp;&nbsp; &nbsp;- thanks to Hasso Tepper for reporting the following problems<br />#&nbsp; &nbsp;&nbsp; &nbsp;- allow dots in interface names for use with VLAN interfaces<br />#&nbsp; &nbsp;&nbsp; &nbsp;- fixed a thinko resulting from &quot;cosmetic overdosage&quot; <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br /># v0.8.1- Lubomir Bulej &lt;pallas at kadan.cz&gt;<br />#&nbsp; &nbsp;&nbsp; &nbsp;- added function alternatives for sed/find with less features. To<br />#&nbsp; &nbsp;&nbsp; &nbsp; &nbsp;enable them, you need to set HTB_BASIC to nonempty string.<br />#&nbsp; &nbsp;&nbsp; &nbsp;- added posibility to refer to RATE/CEIL of parent class when<br />#&nbsp; &nbsp;&nbsp; &nbsp; &nbsp;setting RATE/CEIL for child class. Look for &quot;prate&quot; or &quot;pceil&quot;<br />#&nbsp; &nbsp;&nbsp; &nbsp; &nbsp;in the documentation.<br />#&nbsp; &nbsp;&nbsp; &nbsp;- fixed broken &quot;timecheck&quot; invocation<br /># v0.8&nbsp; &nbsp; - Lubomir Bulej &lt;pallas at kadan.cz&gt;<br />#&nbsp; &nbsp;&nbsp; &nbsp;- simplified and converted CBQ.init 0.7 into HTB.init<br />#&nbsp; &nbsp;&nbsp; &nbsp;- changed configuration file naming conventions<br />#&nbsp; &nbsp;&nbsp; &nbsp;- lots of HTB specific changes<br />#<br />#<br /># INTRODUCTION<br /># ------------<br />#<br /># This script is a clone of CBQ.init and is meant to simplify setup of HTB<br /># based traffic control. HTB setup itself is pretty simple compared to CBQ,<br /># so the purpose of this script is to allow the administrator of large HTB<br /># configurations to manage individual classes using simple, human readable<br /># files.<br />#<br /># The &quot;H&quot; in HTB stands for &quot;hierarchical&quot;, so while many people did not use<br /># (or know about) the possibility to build hierarchical structures using<br /># CBQ.init, it should be obvious thing to expect from HTB.init :-)<br />#<br /># In HTB.init this is done differently, compared to CBQ.init: the usage of<br /># PARENT keyword was dropped and instead, class file naming convetion was<br /># introduced. This convention allows the child class to determine ID of its<br /># parent class from the filename and also (if not abused <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> enforces file<br /># ordering so that the parent classes are created before their children.<br />#<br /># HTB.init uses simple caching mechanism to speed up &quot;start&quot; invocation if the<br /># configuration is unchanged. When invoked for the first time, it compiles the<br /># configuration files into simple shell script containing the sequence of &quot;tc&quot;<br /># commands required to setup the traffic control. This cache-script is stored<br /># in /var/cache/htb.init by default and is invalidated either by presence of<br /># younger class config file, or by invoking HTB.init with &quot;start invalidate&quot;.<br />#<br /># If you want to HTB.init to setup the traffic control directly without the<br /># cache, invoke it with &quot;start nocache&quot; parameters. Caching is also disabled<br /># if you have logging enabled (ie. HTB_DEBUG is not empty).<br />#<br /># If you only want HTB.init to translate your configuration to &quot;tc&quot; commands,<br /># invoke it using the &quot;compile&quot; command. Bear in mind that &quot;compile&quot; does not<br /># check if the &quot;tc&quot; commands were successful - this is done (in certain places)<br /># only when invoked with &quot;start nocache&quot; command. When you are testing your<br /># configuration, you should use it to check whether it is completely valid.<br />#<br /># In case you are getting strange sed/find errors, try to uncomment line with<br /># HTB_BASIC setting, or set the variable to nonempty string. This will enable<br /># function alternatives which require less advanced sed/find functionality. As<br /># a result, the script will run slower but will probably run. Also the caching<br /># will not work as expected and you will have to invalidate the cache manually<br /># by invoking HTB.init with &quot;start invalidate&quot;.<br />#<br />#<br /># CONFIGURATION<br /># -------------<br />#<br /># Every traffic class is described by a single file in placed in $HTB_PATH<br /># directory, /etc/sysconfig/htb by default. The naming convention is different<br /># compared to CBQ.init. First notable change is missing &#039;htb-&#039; prefix. This<br /># was replaced by interface name to improve human readability and to separate<br /># qdisc-only configuration.<br />#<br /># Global qdisc options are placed in $HTB_PATH/&lt;ifname&gt;, where &lt;ifname&gt; is<br /># (surprisingly) name of the interface, made of characters and numbers. This<br /># file must be present if you want to setup HTB on that interface. If you<br /># don&#039;t have any options to put into it, leave it empty, but present.<br />#<br /># Class options belong to files with names matching this expression:<br /># $HTB_PATH/&lt;ifname&gt;-&lt;clsid&gt;(:&lt;clsid&gt;)*&lt;description&gt;<br />#<br /># &lt;clsid&gt; is class ID which is hexadecimal number in range 0x2-0xFFFF, without<br /># the &quot;0x&quot; prefix. If a colon-delimited list of class IDs is specified, the<br /># last &lt;clsid&gt; in the list represents ID of the class in the config file.<br />#<br /># &lt;clsid&gt; preceding the last &lt;clsid&gt; is class ID of the parent class. To keep<br /># ordering so that parent classes are always created before their children, it<br /># is recommended to include full &lt;clsid&gt; path from root class to the leaf one.<br />#<br /># &lt;description&gt; is (almost) arbitrary string where you can put symbolic<br /># class names for better readability.<br />#<br /># Examples of valid names:<br />#<br />#&nbsp; &nbsp; eth0-2&nbsp; &nbsp; &nbsp; &nbsp; root class with ID 2, on device eth0<br />#&nbsp; &nbsp; eth0-2:3&nbsp; &nbsp; child class with ID 3 and parent 2, on device eth0<br />#&nbsp; &nbsp; eth0-2:3:4&nbsp; &nbsp; child class with ID 4 and parent 3, on device eth0<br />#&nbsp; &nbsp; eth1-2.root&nbsp; &nbsp; root class with ID 2, on device eth1<br />#<br />#<br /># The configuration files may contain the following parameters. For detailed<br /># description of HTB parameters see <a href="http://luxik.cdi.cz/~devik/qos/htb">http://luxik.cdi.cz/~devik/qos/htb</a>.<br />#<br />### HTB qdisc parameters<br />#<br /># The following parameters apply to HTB root queuening discipline only and<br /># are expected to be put into $HTB_PATH/&lt;ifname&gt; files. These files must<br /># exist (even empty) if you want to configure HTB on given interface.<br />#<br /># DEFAULT=&lt;clsid&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; optional, default 0<br /># DEFAULT=30<br />#<br />#&nbsp; &nbsp; &lt;dclsid&gt; is ID of the default class where UNCLASSIFIED traffic goes.<br />#&nbsp; &nbsp; Unlike HTB qdisc, HTB.init uses 0 as default class ID, which is<br />#&nbsp; &nbsp; internal FIFO queue that will pass packets along at FULL speed!<br />#<br />#&nbsp; &nbsp; If you want to avoid surprises, always define default class and<br />#&nbsp; &nbsp; allocate minimal portion of bandwidth to it.<br />#<br /># R2Q=&lt;number&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; optional, default 10<br /># R2Q=100<br />#<br />#&nbsp; &nbsp; This allows you to set coefficient for computing DRR (Deficit<br />#&nbsp; &nbsp; Round Robin) quanta. The default value of 10 is good for rates<br />#&nbsp; &nbsp; from 5-500kbps and should be increased for higher rates.<br />#<br /># DCACHE=yes|no&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; optional, default &quot;no&quot;<br />#<br />#&nbsp; &nbsp; This parameters turns on &quot;dequeue cache&quot; which results in degraded<br />#&nbsp; &nbsp; fairness but allows HTB to be used on very fast network devices.<br />#&nbsp; &nbsp; This is turned off by default.<br />#<br />### HTB class parameters<br />#<br /># The following are parameters for HTB classes and are expected<br /># to be put into $HTB_PATH/&lt;ifname&gt;-&lt;clsid&gt;(:&lt;clsid&gt;)*.* files.<br />#<br /># RATE=&lt;speed&gt;|prate|pceil&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mandatory<br /># RATE=5Mbit<br />#<br />#&nbsp; &nbsp; Bandwidth allocated to the class. Traffic going through the class is<br />#&nbsp; &nbsp; shaped to conform to specified rate. You can use Kbit, Mbit or bps,<br />#&nbsp; &nbsp; Kbps and Mbps as suffices. If you don&#039;t specify any unit, bits/sec<br />#&nbsp; &nbsp; are used. Also note that &quot;bps&quot; means &quot;bytes per second&quot;, not bits.<br />#<br />#&nbsp; &nbsp; The &quot;prate&quot; or &quot;pceil&quot; values will resolve to RATE or CEIL of parent<br />#&nbsp; &nbsp; class. This feature is meant to help humans to keep configuration<br />#&nbsp; &nbsp; files consistent.<br />#<br /># CEIL=&lt;speed&gt;|prate|pceil&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; optional, default $RATE<br /># CEIL=6MBit<br />#<br />#&nbsp; &nbsp; The maximum bandwidth that can be used by the class. The difference<br />#&nbsp; &nbsp; between CEIL and RATE amounts to bandwidth the class can borrow, if<br />#&nbsp; &nbsp; there is unused bandwidth left.<br />#<br />#&nbsp; &nbsp; By default, CEIL is equal to RATE so the class cannot borrow bandwidth<br />#&nbsp; &nbsp; from its parent. If you want the class to borrow unused bandwidth, you<br />#&nbsp; &nbsp; must specify the maximal amount it can use, if available.<br />#<br />#&nbsp; &nbsp; When several classes compete for the unused bandwidth, each of the<br />#&nbsp; &nbsp; classes is given share proportional to their RATE.<br />#<br /># BURST=&lt;bytes&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; optional, default computed<br /># BURST=10Kb<br />#<br /># CBURST=&lt;bytes&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; optional, default computed<br /># CBURST=2Kb<br />#<br />#&nbsp; &nbsp; BURST and CBURST parameters control the amount of data that can<br />#&nbsp; &nbsp; be sent from one class at maximum (hardware) speed before trying<br />#&nbsp; &nbsp; to service other class.<br />#<br />#&nbsp; &nbsp; If CBURST is small (one packet size) it shapes bursts not to<br />#&nbsp; &nbsp; exceed CEIL rate the same way PEAK works for TBF.<br />#<br /># PRIO=&lt;number&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; optional, default 0<br /># PRIO=5<br />#<br />#&nbsp; &nbsp; Priority of class traffic. The higher the number, the lesser the<br />#&nbsp; &nbsp; priority. Also, classes with higher priority are offered excess<br />#&nbsp; &nbsp; bandwidth first.<br />#<br /># LEAF=none|sfq|pfifo|bfifo&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; optional, default &quot;none&quot;<br />#<br />#&nbsp; &nbsp; Tells the script to attach specified leaf queueing discipline to HTB<br />#&nbsp; &nbsp; class. By default, no leaf qdisc is used.<br />#<br />#&nbsp; &nbsp; If you want to ensure (approximately) fair sharing of bandwidth among<br />#&nbsp; &nbsp; several hosts in the same class, you should specify LEAF=sfq to attach<br />#&nbsp; &nbsp; SFQ as leaf queueing discipline to the class.<br />#<br /># MTU=&lt;bytes&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; optional, default &quot;1600&quot;<br />#<br />#&nbsp; &nbsp; Maximum packet size HTB creates rate maps for. The default should<br />#&nbsp; &nbsp; be sufficient for most cases, it certainly is for Ethernet.<br />#<br />### SFQ qdisc parameters<br />#<br /># The SFQ queueing discipline is a cheap way to fairly share class bandwidth<br /># among several hosts. The fairness is approximate because it is stochastic,<br /># but is not CPU intensive and will do the job in most cases. If you desire<br /># real fairness, you should probably use WRR (weighted round robin) or WFQ<br /># queueing disciplines. Note that SFQ does not do any traffic shaping - the<br /># shaping is done by the HTB class the SFQ is attached to.<br />#<br /># QUANTUM=&lt;bytes&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; optional, qdisc default<br />#<br />#&nbsp; &nbsp; Amount of data in bytes a stream is allowed to dequeue before next<br />#&nbsp; &nbsp; queue gets a turn. Defaults to one MTU-sized packet. Do not set<br />#&nbsp; &nbsp; this parameter below the MTU!<br />#<br /># PERTURB=&lt;seconds&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; optional, default &quot;10&quot;<br />#<br />#&nbsp; &nbsp; Period of hash function perturbation. If unset, hash reconfiguration<br />#&nbsp; &nbsp; will never take place which is what you probably don&#039;t want. The<br />#&nbsp; &nbsp; default value of 10 seconds is probably a good value.<br />#<br />### PFIFO/BFIFO qdisc parameters<br />#<br /># Those are simple FIFO queueing disciplines. They only have one parameter<br /># which determines their length in bytes or packets.<br />#<br /># LIMIT=&lt;packets&gt;|&lt;bytes&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; optional, qdisc default<br /># LIMIT=1000<br />#<br />#&nbsp; &nbsp; Number of packets/bytes the queue can hold. The unit depends on<br />#&nbsp; &nbsp; the type of queue used.<br />#<br />### Filtering parameters<br />#<br /># RULE=[[saddr[/prefix]][:port[/mask]],][daddr[/prefix]][:port[/mask]]<br />#<br />#&nbsp; &nbsp; These parameters make up &quot;u32&quot; filter rules that select traffic for<br />#&nbsp; &nbsp; each of the classes. You can use multiple RULE fields per config.<br />#<br />#&nbsp; &nbsp; The optional port mask should only be used by advanced users who<br />#&nbsp; &nbsp; understand how the u32 filter works.<br />#<br /># Some examples:<br />#<br />#&nbsp; &nbsp; RULE=10.1.1.0/24:80<br />#&nbsp; &nbsp; &nbsp; &nbsp; selects traffic going to port 80 in network 10.1.1.0<br />#<br />#&nbsp; &nbsp; RULE=10.2.2.5<br />#&nbsp; &nbsp; &nbsp; &nbsp; selects traffic going to any port on single host 10.2.2.5<br />#<br />#&nbsp; &nbsp; RULE=10.2.2.5:20/0xfffe<br />#&nbsp; &nbsp; &nbsp; &nbsp; selects traffic going to ports 20 and 21 on host 10.2.2.5<br />#<br />#&nbsp; &nbsp; RULE=:25,10.2.2.128/26:5000<br />#&nbsp; &nbsp; &nbsp; &nbsp; selects traffic going from anywhere on port 50 to<br />#&nbsp; &nbsp; &nbsp; &nbsp; port 5000 in network 10.2.2.128<br />#<br />#&nbsp; &nbsp; RULE=10.5.5.5:80,<br />#&nbsp; &nbsp; &nbsp; &nbsp; selects traffic going from port 80 of single host 10.5.5.5<br />#<br />#<br />#<br /># REALM=[srealm,][drealm]<br />#<br />#&nbsp; &nbsp; These parameters make up &quot;route&quot; filter rules that classify traffic<br />#&nbsp; &nbsp; according to packet source/destination realms. For information about<br />#&nbsp; &nbsp; realms, see Alexey Kuznetsov&#039;s IP Command Reference. This script<br />#&nbsp; &nbsp; does not define any realms, it justs builds &quot;tc filter&quot; commands<br />#&nbsp; &nbsp; for you if you need to classify traffic this way.<br />#<br />#&nbsp; &nbsp; Realm is either a decimal number or a string referencing entry in<br />#&nbsp; &nbsp; /etc/iproute2/rt_realms (usually).<br />#<br /># Some examples:<br />#<br />#&nbsp; &nbsp; REALM=russia,internet<br />#&nbsp; &nbsp; &nbsp; &nbsp; selects traffic going from realm &quot;russia&quot; to realm &quot;internet&quot;<br />#<br />#&nbsp; &nbsp; REALM=freenet,<br />#&nbsp; &nbsp; &nbsp; &nbsp; selects traffic going from realm &quot;freenet&quot;<br />#<br />#&nbsp; &nbsp; REALM=10<br />#&nbsp; &nbsp; &nbsp; &nbsp; selects traffic going to realm 10<br />#<br />#<br />#<br /># MARK=&lt;mark&gt;<br />#<br />#&nbsp; &nbsp; These parameters make up &quot;fw&quot; filter rules that select traffic for<br />#&nbsp; &nbsp; each of the classes accoring to firewall &quot;mark&quot;. Mark is a decimal<br />#&nbsp; &nbsp; number packets are tagged with if firewall rules say so. You can<br />#&nbsp; &nbsp; use multiple MARK fields per config.<br />#<br />#<br /># Note:&nbsp; &nbsp; Rules for different filter types can be combined. Attention must be<br />#&nbsp; &nbsp; paid to the priority of filter rules, which can be set below through<br />#&nbsp; &nbsp; the PRIO_{RULE,MARK,REALM} variables.<br />#<br />### Time ranging parameters<br />#<br /># TIME=[&lt;dow&gt;&lt;dow&gt;.../]&lt;from&gt;-&lt;till&gt;;&lt;rate&gt;[/&lt;burst&gt;][,&lt;ceil&gt;[/&lt;cburst&gt;]]<br /># TIME=60123/18:00-06:00;256Kbit/10Kb,384Kbit<br /># TIME=18:00-06:00;256Kbit<br />#<br />#&nbsp; &nbsp; This parameter allows you to change class bandwidth during the day or<br />#&nbsp; &nbsp; week. You can use multiple TIME rules. If there are several rules with<br />#&nbsp; &nbsp; overlapping time periods, the last match is taken. The &lt;rate&gt;, &lt;burst&gt;,<br />#&nbsp; &nbsp; &lt;ceil&gt; and &lt;cburst&gt; fields correspond to parameters RATE, BURST, CEIL<br />#&nbsp; &nbsp; and CBURST.<br />#<br />#&nbsp; &nbsp; &lt;dow&gt; is single digit in range 0-6 and represents day of week as<br />#&nbsp; &nbsp; returned by date(1). To specify several days, just concatenate the<br />#&nbsp; &nbsp; digits together.<br />#<br />#<br />#<br /># TRIVIAL EXAMPLE<br /># ---------------<br />#<br /># Consider the following example:<br /># (taken from Linux Advanced Routing &amp; Traffic Control HOWTO)<br />#<br /># You have a Linux server with total of 5Mbit available bandwidth. On this<br /># machine, you want to limit webserver traffic to 5Mbit, SMTP traffic to 3Mbit<br /># and everything else (unclassified traffic) to 1Kbit. In case there is unused<br /># bandwidth, you want to share it between SMTP and unclassified traffic.<br />#<br /># The &quot;total bandwidth&quot; implies one top-level class with maximum bandwidth<br /># of 5Mbit. Under the top-level class, there are three child classes.<br />#<br /># First, the class for webserver traffic is allowed to use 5Mbit of bandwidth.<br />#<br /># Second, the class for SMTP traffic is allowed to use 3Mbit of bandwidth and<br /># if there is unused bandwidth left, it can use it but must not exceed 5Mbit<br /># in total.<br />#<br /># And finally third, the class for unclassified traffic is allowed to use<br /># 1Kbit of bandwidth and borrow unused bandwith, but must not exceed 5Mbit.<br />#<br /># If there is demand in all classes, each of them gets share of bandwidth<br /># proportional to its default rate. If there unused is bandwidth left, they<br /># (again) get share proportional to their default rate.<br />#<br /># Configuration files for this scenario:<br /># ---------------------------------------------------------------------------<br /># eth0&nbsp; &nbsp; &nbsp; &nbsp; eth0-2.root&nbsp; &nbsp; eth0-2:10.www&nbsp; &nbsp; eth0-2:20.smtp&nbsp; &nbsp; eth0-2:30.dfl<br /># ----&nbsp; &nbsp; &nbsp; &nbsp; -----------&nbsp; &nbsp; -------------&nbsp; &nbsp; --------------&nbsp; &nbsp; -------------<br /># DEFAULT=30&nbsp; &nbsp; RATE=5Mbit&nbsp; &nbsp; RATE=5Mbit&nbsp; &nbsp; RATE=3Mbit&nbsp; &nbsp; RATE=1Kbit<br />#&nbsp; &nbsp; &nbsp; &nbsp; BURST=15k&nbsp; &nbsp; BURST=15k&nbsp; &nbsp; CEIL=5Mbit&nbsp; &nbsp; CEIL=5Mbit<br />#&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LEAF=sfq&nbsp; &nbsp; BURST=15k&nbsp; &nbsp; BURST=15k<br />#&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RULE=*:80,&nbsp; &nbsp; LEAF=sfq&nbsp; &nbsp; LEAF=sfq<br />#&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RULE=*:25<br /># ---------------------------------------------------------------------------<br />#<br /># Remember that you can only control traffic going out of your linux machine.<br /># If you have a host connected to network and want to control its traffic on<br /># the gateway in both directions (with respect to the host), you need to setup<br /># traffic control for that host on both (or all) gateway interfaces.<br />#<br /># Enjoy.<br />#<br />#############################################################################</p><p>export LC_ALL=C</p><p>### Command locations<br />TC=/sbin/tc<br />IP=/sbin/ip<br />MP=/sbin/modprobe</p><p>### Default filter priorities (must be different)<br />PRIO_RULE_DEFAULT=${PRIO_RULE:-100}<br />PRIO_MARK_DEFAULT=${PRIO_MARK:-200}<br />PRIO_REALM_DEFAULT=${PRIO_REALM:-300}</p><p>### Default HTB_PATH &amp; HTB_CACHE settings<br />HTB_PATH=${HTB_PATH:-/etc/htb}<br />HTB_CACHE=${HTB_CACHE:-/var/cache/htb.init}</p><p>### Uncomment for sed/find with less features (useful for busybox)<br />#HTB_BASIC=&quot;yes&quot;</p><p>### Uncomment to enable logfile for debugging<br />HTB_DEBUG=&quot;/var/run/htb-$1&quot;</p><p>### Modules to probe for. Uncomment the last HTB_PROBE<br />### line if you have QoS support compiled into kernel<br />HTB_PROBE=&quot;sch_htb sch_sfq cls_fw cls_u32 cls_route&quot;<br />#HTB_PROBE=&quot;&quot;</p><p>### Config keywords<br />HTB_QDISC=&quot;DEFAULT\|DCACHE\|R2Q&quot;<br />HTB_CLASS=&quot;RATE\|CEIL\|BURST\|CBURST\|PRIO\|LEAF\|MTU&quot;<br />HTB_CLASS=&quot;$HTB_CLASS\|PRIO_RULE\|PRIO_MARK\|PRIO_REALM&quot;<br />HTB_CLASS=&quot;$HTB_CLASS\|LIMIT\|QUANTUM\|PERTURB&quot;</p><br /><p>#############################################################################<br />############################# SUPPORT FUNCTIONS #############################<br />#############################################################################</p><p>if [ -z &quot;$HTB_BASIC&quot; ]; then<br />&nbsp; &nbsp; ### List of network devices<br />&nbsp; &nbsp; all_device_list () {<br />&nbsp; &nbsp; &nbsp; &nbsp; ip link show \<br />&nbsp; &nbsp; &nbsp; &nbsp; | sed -n &quot;/^[0-9]/ { s/[[:space:]]//g; \<br />&nbsp; &nbsp; &nbsp; &nbsp; s/^[0-9]\+:\([^@-]\+\)\(@.\+\)\?:&lt;.*/\1/; p; }&quot;<br />&nbsp; &nbsp; } # all_device_list</p><br /><p>&nbsp; &nbsp; ### Load &amp; filter file $HTB_PATH/$1<br />&nbsp; &nbsp; htb_filter_file () {<br />&nbsp; &nbsp; &nbsp; &nbsp; sed -n &quot;s/#.*//; s/[^a-zA-Z0-9.,;:=/*-_]\+//g; \<br />&nbsp; &nbsp; &nbsp; &nbsp; /^[a-zA-Z0-9]\+=[a-zA-Z0-9.,:;/*-_]\+$/ p&quot; $HTB_PATH/$1<br />&nbsp; &nbsp; } # htb_filter_file</p><br /><p>&nbsp; &nbsp; ### Parse class ID chain from file name<br />&nbsp; &nbsp; htb_clsid_chain () {<br />&nbsp; &nbsp; &nbsp; &nbsp; echo &quot;${1#*-}&quot; \<br />&nbsp; &nbsp; &nbsp; &nbsp; | sed -n &quot;/^[0-9a-fA-F]/ { s/^\([0-9a-fA-F:]\+\).*/\1/; \<br />&nbsp; &nbsp; &nbsp; &nbsp; s/::/:/g; s/:$//; p; }&quot;<br />&nbsp; &nbsp; } # htb_clsid_chain</p><br /><p>&nbsp; &nbsp; ### List of classes in $HTB_PATH<br />&nbsp; &nbsp; htb_class_list () {<br />&nbsp; &nbsp; &nbsp; &nbsp; for dev in `htb_device_list`; do<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; find $HTB_PATH \( -type f -or -type l \) \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -name &quot;$dev-*&quot; -not -name &#039;*~&#039; -maxdepth 1 \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -printf &quot;%f\n&quot;| sort<br />&nbsp; &nbsp; &nbsp; &nbsp; done<br />&nbsp; &nbsp; } # htb_class_list</p><p>&nbsp; &nbsp; ### Gather $1 rules from $CFILE<br />&nbsp; &nbsp; htb_cfile_rules () {<br />&nbsp; &nbsp; &nbsp; &nbsp; echo &quot;$CFILE&quot;| sed -n &quot;/^$1=/ { s/.*=//; p; }&quot;<br />&nbsp; &nbsp; } # htb_cfile_rules</p><br /><p>&nbsp; &nbsp; ### Validate cache against config files<br />&nbsp; &nbsp; htb_valid_cache () {<br />&nbsp; &nbsp; &nbsp; &nbsp; for dev in `htb_device_list`; do<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ `find $HTB_PATH \( -type f -or -type l \) \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;-name &quot;$dev*&quot; -maxdepth 1 -newer $HTB_CACHE| \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;wc -l` -gt 0 ] &amp;&amp; VALID=0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ $VALID -ne 1 ] &amp;&amp; break<br />&nbsp; &nbsp; &nbsp; &nbsp; done<br />&nbsp; &nbsp; } # htb_valid_cache</p><br /><p>&nbsp; &nbsp; ### Find class config for device $1, which is newer than cache<br />&nbsp; &nbsp; htb_cache_older () {<br />&nbsp; &nbsp; &nbsp; &nbsp; [ `find $HTB_PATH -type f -name &quot;$1*&quot; -maxdepth 1 \<br />&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; -newer $HTB_CACHE| wc -l` -gt 0 ] &amp;&amp; return 0<br />&nbsp; &nbsp; &nbsp; &nbsp; return 1<br />&nbsp; &nbsp; } # htb_cache_older</p><br /><p>&nbsp; &nbsp; ### Get current RATE and CEIL<br />&nbsp; &nbsp; htb_class_state () {<br />&nbsp; &nbsp; &nbsp; &nbsp; tc class show dev $1 \<br />&nbsp; &nbsp; &nbsp; &nbsp; | sed -n &quot;s/[[:space:]]\+/ /g; /^class htb 1:$2 / \<br />&nbsp; &nbsp; &nbsp; &nbsp; { s/.*rate \(.\+\) burst.*/\1/; p; q; }&quot;<br />&nbsp; &nbsp; } # htb_class_state</p><p>else ### Less feature-hungry versions of above functions</p><p>&nbsp; &nbsp; all_device_list () {<br />&nbsp; &nbsp; &nbsp; &nbsp; ip link show \<br />&nbsp; &nbsp; &nbsp; &nbsp; | grep &quot;^[0-9]&quot; \<br />&nbsp; &nbsp; &nbsp; &nbsp; | sed &quot;s/[[:space:]]//g; \<br />&nbsp; &nbsp; &nbsp; &nbsp; s/^[0-9]\+:\([^@-]\+\)\(@.\+\)\?:&lt;.*/\1/&quot;<br />&nbsp; &nbsp; } # all_device_list</p><p>&nbsp; &nbsp; htb_filter_file () {<br />&nbsp; &nbsp; &nbsp; &nbsp; sed &#039;s/#.*//; s/[^a-zA-Z0-9.,;:=/*-_]\+//g&#039; $HTB_PATH/$1 \<br />&nbsp; &nbsp; &nbsp; &nbsp; | grep &#039;^[a-zA-Z0-9]\+=[a-zA-Z0-9.,;:/*-_]\+$&#039;<br />&nbsp; &nbsp; } # htb_filter_file</p><p>&nbsp; &nbsp; htb_clsid_chain () {<br />&nbsp; &nbsp; &nbsp; &nbsp; echo &quot;${1#*-}&quot; \<br />&nbsp; &nbsp; &nbsp; &nbsp; | grep &#039;^[a-fA-F0-9]&#039; \<br />&nbsp; &nbsp; &nbsp; &nbsp; | sed &#039;s/^\([a-fA-F0-9:]\+\).*/\1/; s/::/:/g; s/:$//&#039;<br />&nbsp; &nbsp; } # htb_clsid_chain</p><p>&nbsp; &nbsp; htb_class_list () {<br />&nbsp; &nbsp; &nbsp; &nbsp; PFX=`echo &quot;$HTB_PATH&quot;| sed &#039;s/\//\\\\\//g&#039;`<br />&nbsp; &nbsp; &nbsp; &nbsp; for dev in `htb_device_list`; do<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; find $HTB_PATH -type f -name &quot;$dev-*&quot; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | grep &quot;^$HTB_PATH/$dev-[^/]\+[^~]$&quot; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | sed &quot;s/$PFX\///&quot; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | sort<br />&nbsp; &nbsp; &nbsp; &nbsp; done<br />&nbsp; &nbsp; } # htb_class_list</p><p>&nbsp; &nbsp; htb_cfile_rules () {<br />&nbsp; &nbsp; &nbsp; &nbsp; echo &quot;$CFILE&quot;| grep &quot;^$1=&quot;| cut -d&quot;=&quot; -f2<br />&nbsp; &nbsp; } # htb_cfile_rules</p><p>&nbsp; &nbsp; htb_cache_older () {<br />&nbsp; &nbsp; &nbsp; &nbsp; ### cache is always up-to-date<br />&nbsp; &nbsp; &nbsp; &nbsp; return 1<br />&nbsp; &nbsp; } # htb_cache_older</p><p>&nbsp; &nbsp; htb_class_state () {<br />&nbsp; &nbsp; &nbsp; &nbsp; tc class show dev $1 \<br />&nbsp; &nbsp; &nbsp; &nbsp; | sed &#039;s/[[:space:]]\+/ /g&#039; \<br />&nbsp; &nbsp; &nbsp; &nbsp; | grep &quot;^class htb 1:$2 &quot; \<br />&nbsp; &nbsp; &nbsp; &nbsp; | sed &#039;s/.*rate \(.\+\) burst.*/\1/&#039;<br />&nbsp; &nbsp; } # htb_class_state<br />fi # HTB_BASIC</p><br /><p>### List of HTB devices<br />htb_device_list () {<br />&nbsp; &nbsp; for dev in `all_device_list`; do<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -f $HTB_PATH/$dev ] &amp;&amp; echo $dev<br />&nbsp; &nbsp; done<br />} # htb_device_list</p><br /><p>### Remove root class from device $1<br />htb_device_off () {<br />&nbsp; &nbsp; tc qdisc del dev $1 root 2&gt; /dev/null<br />} # htb_device_off</p><br /><p>### Remove HTB from all devices<br />htb_off () {<br />&nbsp; &nbsp; for dev in `htb_device_list`; do<br />&nbsp; &nbsp; &nbsp; &nbsp; htb_device_off $dev<br />&nbsp; &nbsp; done<br />} # htb_off</p><br /><p>### Prefixed message<br />htb_message () {<br />&nbsp; &nbsp; echo -e &quot;**HTB: $@&quot;<br />} # htb_message</p><p>### Failure message<br />htb_failure () {<br />&nbsp; &nbsp; htb_message &quot;$@&quot;<br />&nbsp; &nbsp; exit 1<br />} # htb_failure</p><p>### Failure w/htb_off<br />htb_fail_off () {<br />&nbsp; &nbsp; htb_message &quot;$@&quot;<br />&nbsp; &nbsp; htb_off<br />&nbsp; &nbsp; exit 1<br />} # htb_fail_off</p><br /><p>### Convert time to absolute value<br />htb_time2abs () {<br />&nbsp; &nbsp; local min=${1##*:}; min=${min##0}<br />&nbsp; &nbsp; local hrs=${1%%:*}; hrs=${hrs##0}<br />&nbsp; &nbsp; echo $[hrs*60 + min]<br />} # htb_time2abs</p><br /><p>### Display traffic control setup<br />htb_show () {<br />&nbsp; &nbsp; for dev in `all_device_list`; do<br />&nbsp; &nbsp; &nbsp; &nbsp; [ `tc qdisc show dev $dev| wc -l` -eq 0 ] &amp;&amp; continue<br />&nbsp; &nbsp; &nbsp; &nbsp; echo -e &quot;### $dev: queueing disciplines\n&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; tc $1 qdisc show dev $dev; echo</p><p>&nbsp; &nbsp; &nbsp; &nbsp; [ `tc class show dev $dev| wc -l` -eq 0 ] &amp;&amp; continue<br />&nbsp; &nbsp; &nbsp; &nbsp; echo -e &quot;### $dev: traffic classes\n&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; tc $1 class show dev $dev; echo</p><p>&nbsp; &nbsp; &nbsp; &nbsp; [ `tc filter show dev $dev| wc -l` -eq 0 ] &amp;&amp; continue<br />&nbsp; &nbsp; &nbsp; &nbsp; echo -e &quot;### $dev: filtering rules\n&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; tc $1 filter show dev $dev; echo<br />&nbsp; &nbsp; done<br />} # htb_show</p><br /><br /><p>### Derive DEVICE, CLASS and PARENT from $1<br />### Check validity of CLASS and PARENT class IDs<br />### Load class configuration from $HTP_PATH/$1<br />### Configure class parameters from CFILE<br />htb_load_class () {<br />&nbsp; &nbsp; DEVICE=${1%%-*}<br />&nbsp; &nbsp; CLSIDS=`htb_clsid_chain $1`<br />&nbsp; &nbsp; CLASS=${CLSIDS##*:}; [ -z &quot;$CLASS&quot; ] &amp;&amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; htb_fail_off &quot;$1 has invalid class ID!&quot;</p><p>&nbsp; &nbsp; [ $[0x$CLASS] -lt 2 -o $[0x$CLASS] -gt 65535 ] &amp;&amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; htb_fail_off &quot;class ID of $1 must be in range 0x2-0xFFFF!&quot;</p><p>&nbsp; &nbsp; CLSIDS=${CLSIDS%$CLASS}; CLSIDS=${CLSIDS%:}<br />&nbsp; &nbsp; PARENT=${CLSIDS##*:}; [ -n &quot;$PARENT&quot; ] &amp;&amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; [ $[0x$PARENT] -lt 2 -o $[0x$PARENT] -gt 65535 ] &amp;&amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; htb_fail_off &quot;parent ID of $1 must be in range 0x2-0xFFFF!&quot;</p><p>&nbsp; &nbsp; CFILE=`htb_filter_file $1`</p><br /><p>&nbsp; &nbsp; ### Set defaults &amp; load class<br />&nbsp; &nbsp; MTU=&quot;&quot;; LEAF=none; PERTURB=10<br />&nbsp; &nbsp; RATE=&quot;&quot;; BURST=&quot;&quot;; CEIL=&quot;&quot;; CBURST=&quot;&quot;<br />&nbsp; &nbsp; PRIO=&quot;&quot;; LIMIT=&quot;&quot;; QUANTUM=&quot;&quot;<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; PRIO_RULE=$PRIO_RULE_DEFAULT<br />&nbsp; &nbsp; PRIO_MARK=$PRIO_MARK_DEFAULT<br />&nbsp; &nbsp; PRIO_REALM=$PRIO_REALM_DEFAULT</p><p>&nbsp; &nbsp; eval `echo &quot;$CFILE&quot;| grep &quot;^\($HTB_CLASS\)=&quot;`<br />&nbsp; &nbsp; RNAME=&quot;&quot;; CNAME=&quot;&quot;</p><p>&nbsp; &nbsp; ### Resolve RATE if needed<br />&nbsp; &nbsp; [ &quot;$RATE&quot; = &quot;prate&quot; ] &amp;&amp; RNAME=RATE_$PARENT<br />&nbsp; &nbsp; [ &quot;$RATE&quot; = &quot;pceil&quot; ] &amp;&amp; RNAME=CEIL_$PARENT<br />&nbsp; &nbsp; [ -n &quot;$RNAME&quot; ] &amp;&amp; RATE=${!RNAME}</p><p>&nbsp; &nbsp; ### RATE is required<br />&nbsp; &nbsp; [ -z &quot;$RATE&quot; ] &amp;&amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; htb_fail_off &quot;missing or unresolvable RATE in $1!&quot;</p><p>&nbsp; &nbsp; ### Resolve CEIL if needed<br />&nbsp; &nbsp; [ &quot;$CEIL&quot; = &quot;prate&quot; ] &amp;&amp; CNAME=RATE_$PARENT<br />&nbsp; &nbsp; [ &quot;$CEIL&quot; = &quot;pceil&quot; ] &amp;&amp; CNAME=CEIL_$PARENT<br />&nbsp; &nbsp; [ -n &quot;$CNAME&quot; ] &amp;&amp; CEIL=${!CNAME}</p><p>&nbsp; &nbsp; ### Store CEIL &amp; RATE for children<br />&nbsp; &nbsp; eval RATE_$CLASS=$RATE<br />&nbsp; &nbsp; eval CEIL_$CLASS=${CEIL:-$RATE}<br />} # htb_load_class</p><br /><p>#############################################################################<br />#################################### INIT ###################################<br />#############################################################################</p><p>### Check iproute2 tools<br />[ -x $TC -a -x $IP ] ||<br />&nbsp; &nbsp; htb_failure &quot;iproute2 utilities not installed or executable!&quot;</p><p>### Check $HTB_PATH directory<br />[ -d $HTB_PATH -a -r $HTB_PATH -a -x $HTB_PATH ] ||<br />&nbsp; &nbsp; htb_failure &quot;$HTB_PATH does not exist or is not readable!&quot;</p><p>### ip/tc wrappers<br />if [ &quot;$1&quot; = &quot;compile&quot; ]; then<br />&nbsp; &nbsp; ### no module probing<br />&nbsp; &nbsp; HTB_PROBE=&quot;&quot;</p><p>&nbsp; &nbsp; ip () {<br />&nbsp; &nbsp; &nbsp; &nbsp; $IP &quot;$@&quot;<br />&nbsp; &nbsp; } # ip<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; ### echo-only version of &quot;tc&quot; command<br />&nbsp; &nbsp; tc () {<br />&nbsp; &nbsp; &nbsp; &nbsp; echo &quot;$TC $@&quot;<br />&nbsp; &nbsp; } # tc</p><p>elif [ -n &quot;$HTB_DEBUG&quot; ]; then<br />&nbsp; &nbsp; echo -e &quot;# `date`&quot; &gt; $HTB_DEBUG</p><p>&nbsp; &nbsp; ### Logging version of &quot;ip&quot; command<br />&nbsp; &nbsp; ip () {<br />&nbsp; &nbsp; &nbsp; &nbsp; echo -e &quot;\n# ip $@&quot; &gt;&gt; $HTB_DEBUG<br />&nbsp; &nbsp; &nbsp; &nbsp; $IP &quot;$@&quot; 2&gt;&amp;1 | tee -a $HTB_DEBUG<br />&nbsp; &nbsp; } # ip</p><p>&nbsp; &nbsp; ### Logging version of &quot;tc&quot; command<br />&nbsp; &nbsp; tc () {<br />&nbsp; &nbsp; &nbsp; &nbsp; echo -e &quot;\n# tc $@&quot; &gt;&gt; $HTB_DEBUG<br />&nbsp; &nbsp; &nbsp; &nbsp; $TC &quot;$@&quot; 2&gt;&amp;1 | tee -a $HTB_DEBUG<br />&nbsp; &nbsp; } # tc<br />else<br />&nbsp; &nbsp; # default wrappers<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; ip () {<br />&nbsp; &nbsp; &nbsp; &nbsp; $IP &quot;$@&quot;<br />&nbsp; &nbsp; } # ip<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; tc () {<br />&nbsp; &nbsp; &nbsp; &nbsp; $TC &quot;$@&quot;<br />&nbsp; &nbsp; } # tc<br />fi # ip/tc wrappers</p><br /><p>case &quot;$1&quot; in</p><p>#############################################################################<br />############################### START/COMPILE ###############################<br />#############################################################################</p><p>start|compile)</p><p>### Probe QoS modules (start only)<br />for module in $HTB_PROBE; do<br />&nbsp; &nbsp; $MP $module || htb_failure &quot;failed to load module $module&quot;<br />done</p><p>### If we are in compile/nocache/logging mode, don&#039;t bother with cache<br />if [ &quot;$1&quot; != &quot;compile&quot; -a &quot;$2&quot; != &quot;nocache&quot; -a -z &quot;$HTB_DEBUG&quot; ]; then<br />&nbsp; &nbsp; VALID=1</p><p>&nbsp; &nbsp; ### validate the cache<br />&nbsp; &nbsp; [ &quot;$2&quot; = &quot;invalidate&quot; -o ! -f $HTB_CACHE ] &amp;&amp; VALID=0<br />&nbsp; &nbsp; [ $VALID -eq 1 ] &amp;&amp; for dev in `htb_device_list`; do<br />&nbsp; &nbsp; &nbsp; &nbsp; htb_cache_older $dev &amp;&amp; VALID=0<br />&nbsp; &nbsp; &nbsp; &nbsp; [ $VALID -ne 1 ] &amp;&amp; break<br />&nbsp; &nbsp; done</p><p>&nbsp; &nbsp; ### compile the config if the cache is invalid<br />&nbsp; &nbsp; if [ $VALID -ne 1 ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; $0 compile &gt; $HTB_CACHE ||<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; htb_fail_off &quot;failed to compile HTB configuration!&quot;<br />&nbsp; &nbsp; fi</p><p>&nbsp; &nbsp; ### run the cached commands<br />&nbsp; &nbsp; exec /bin/sh $HTB_CACHE 2&gt; /dev/null<br />fi</p><br /><p>### Setup root qdisc on all configured devices<br />DEVICES=`htb_device_list`<br />[ -z &quot;$DEVICES&quot; ] &amp;&amp; htb_failure &quot;no configured devices found!&quot;</p><p>for dev in $DEVICES; do<br />&nbsp; &nbsp; ### Retrieve root qdisc options<br />&nbsp; &nbsp; DEFAULT=&quot;&quot;; DCACHE=&quot;&quot;; R2Q=&quot;&quot;<br />&nbsp; &nbsp; eval `htb_filter_file $dev| grep &quot;^\($HTB_QDISC\)=&quot;`<br />&nbsp; &nbsp; [ &quot;$DCACHE&quot; = &quot;yes&quot; ] &amp;&amp; DCACHE=&quot;dcache&quot; || DCACHE=&quot;&quot;</p><p>&nbsp; &nbsp; ### Remove old root qdisc from device<br />&nbsp; &nbsp; htb_device_off $dev</p><p>&nbsp; &nbsp; ### Setup root qdisc for the device<br />&nbsp; &nbsp; tc qdisc add dev $dev root handle 1 htb \<br />&nbsp; &nbsp; default ${DEFAULT:-0} ${R2Q:+r2q $R2Q} $DCACHE ||<br />&nbsp; &nbsp; &nbsp; &nbsp; htb_fail_off &quot;failed to set root qdisc on $dev!&quot;</p><p>&nbsp; &nbsp; [ &quot;$1&quot; = &quot;compile&quot; ] &amp;&amp; echo<br />done # dev</p><br /><p>### Setup traffic classes (if configured)<br />for classfile in `htb_class_list`; do<br />&nbsp; &nbsp; htb_load_class $classfile</p><p>&nbsp; &nbsp; ### Create the class<br />&nbsp; &nbsp; tc class add dev $DEVICE parent 1:$PARENT classid 1:$CLASS \<br />&nbsp; &nbsp; htb rate $RATE ${CEIL:+ceil $CEIL} ${BURST:+burst $BURST} \<br />&nbsp; &nbsp; ${PRIO:+prio $PRIO} ${CBURST:+cburst $CBURST} ${MTU:+mtu $MTU} ||<br />&nbsp; &nbsp; &nbsp; &nbsp; htb_fail_off &quot;failed to add class $CLASS with parent $PARENT on $DEVICE!&quot;</p><p>&nbsp; &nbsp; ### Create leaf qdisc if set<br />&nbsp; &nbsp; if [ &quot;$LEAF&quot; != &quot;none&quot; ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; if [ &quot;$LEAF&quot; = &quot;sfq&quot; ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LEAFPARM=&quot;${PERTURB:+perturb $PERTURB} ${QUANTUM:+quantum $QUANTUM}&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; elif [ &quot;$LEAF&quot; = &quot;pfifo&quot; -o &quot;$LEAF&quot; = &quot;bfifo&quot; ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LEAFPARM=&quot;${LIMIT:+limit $LIMIT}&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; htb_fail_off &quot;unknown leaf qdisc ($LEAF) in $classfile!&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; fi</p><p>&nbsp; &nbsp; &nbsp; &nbsp; tc qdisc add dev $DEVICE \<br />&nbsp; &nbsp; &nbsp; &nbsp; parent 1:$CLASS handle $CLASS $LEAF $LEAFPARM ||<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; htb_fail_off &quot;failed to add leaf qdisc to class $CLASS on $DEVICE!&quot;<br />&nbsp; &nbsp; fi</p><br /><p>&nbsp; &nbsp; ### Create fw filter for MARK fields<br />&nbsp; &nbsp; for mark in `htb_cfile_rules MARK`; do<br />&nbsp; &nbsp; &nbsp; &nbsp; ### Attach fw filter to root class<br />&nbsp; &nbsp; &nbsp; &nbsp; tc filter add dev $DEVICE parent 1:0 protocol ip \<br />&nbsp; &nbsp; &nbsp; &nbsp; prio $PRIO_MARK handle $mark fw classid 1:$CLASS<br />&nbsp; &nbsp; done ### mark</p><p>&nbsp; &nbsp; ### Create route filter for REALM fields<br />&nbsp; &nbsp; for realm in `htb_cfile_rules REALM`; do<br />&nbsp; &nbsp; &nbsp; &nbsp; ### Split realm into source &amp; destination realms<br />&nbsp; &nbsp; &nbsp; &nbsp; SREALM=${realm%%,*}; DREALM=${realm##*,}<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$SREALM&quot; = &quot;$DREALM&quot; ] &amp;&amp; SREALM=&quot;&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ### Convert asterisks to empty strings<br />&nbsp; &nbsp; &nbsp; &nbsp; SREALM=${SREALM#\*}; DREALM=${DREALM#\*}</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ### Attach route filter to the root class<br />&nbsp; &nbsp; &nbsp; &nbsp; tc filter add dev $DEVICE parent 1:0 protocol ip \<br />&nbsp; &nbsp; &nbsp; &nbsp; prio $PRIO_REALM route ${SREALM:+from $SREALM} \<br />&nbsp; &nbsp; &nbsp; &nbsp; ${DREALM:+to $DREALM} classid 1:$CLASS<br />&nbsp; &nbsp; done ### realm</p><p>&nbsp; &nbsp; ### Create u32 filter for RULE fields<br />&nbsp; &nbsp; for rule in `htb_cfile_rules RULE`; do<br />&nbsp; &nbsp; &nbsp; &nbsp; ### Split rule into source &amp; destination<br />&nbsp; &nbsp; &nbsp; &nbsp; SRC=${rule%%,*}; DST=${rule##*,}<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$SRC&quot; = &quot;$rule&quot; ] &amp;&amp; SRC=&quot;&quot;</p><br /><p>&nbsp; &nbsp; &nbsp; &nbsp; ### Split destination into address, port &amp; mask fields<br />&nbsp; &nbsp; &nbsp; &nbsp; DADDR=${DST%%:*}; DTEMP=${DST##*:}<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$DADDR&quot; = &quot;$DST&quot; ] &amp;&amp; DTEMP=&quot;&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; DPORT=${DTEMP%%/*}; DMASK=${DTEMP##*/}<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$DPORT&quot; = &quot;$DTEMP&quot; ] &amp;&amp; DMASK=&quot;0xffff&quot;</p><br /><p>&nbsp; &nbsp; &nbsp; &nbsp; ### Split up source (if specified)<br />&nbsp; &nbsp; &nbsp; &nbsp; SADDR=&quot;&quot;; SPORT=&quot;&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; if [ -n &quot;$SRC&quot; ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SADDR=${SRC%%:*}; STEMP=${SRC##*:}<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$SADDR&quot; = &quot;$SRC&quot; ] &amp;&amp; STEMP=&quot;&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SPORT=${STEMP%%/*}; SMASK=${STEMP##*/}<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$SPORT&quot; = &quot;$STEMP&quot; ] &amp;&amp; SMASK=&quot;0xffff&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; fi</p><br /><p>&nbsp; &nbsp; &nbsp; &nbsp; ### Convert asterisks to empty strings<br />&nbsp; &nbsp; &nbsp; &nbsp; SADDR=${SADDR#\*}; DADDR=${DADDR#\*}</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ### Compose u32 filter rules<br />&nbsp; &nbsp; &nbsp; &nbsp; u32_s=&quot;${SPORT:+match ip sport $SPORT $SMASK}&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; u32_s=&quot;${SADDR:+match ip src $SADDR} $u32_s&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; u32_d=&quot;${DPORT:+match ip dport $DPORT $DMASK}&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; u32_d=&quot;${DADDR:+match ip dst $DADDR} $u32_d&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ### Uncomment the following if you want to see parsed rules<br />&nbsp; &nbsp; &nbsp; &nbsp; #echo &quot;$rule: $u32_s $u32_d&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ### Attach u32 filter to the appropriate class<br />&nbsp; &nbsp; &nbsp; &nbsp; tc filter add dev $DEVICE parent 1:0 protocol ip \<br />&nbsp; &nbsp; &nbsp; &nbsp; prio $PRIO_RULE u32 $u32_s $u32_d classid 1:$CLASS<br />&nbsp; &nbsp; done ### rule</p><p>&nbsp; &nbsp; [ &quot;$1&quot; = &quot;compile&quot; ] &amp;&amp; echo<br />done ### classfile<br />;;</p><br /><p>#############################################################################<br />################################# TIME CHECK ################################<br />#############################################################################</p><p>timecheck)</p><p>### Get time + weekday<br />TIME_TMP=`date +%w/%k:%M`<br />TIME_DOW=${TIME_TMP%%/*}<br />TIME_NOW=${TIME_TMP##*/}<br />TIME_ABS=`htb_time2abs $TIME_NOW`</p><p>### Check all classes (if configured)<br />for classfile in `htb_class_list`; do<br />&nbsp; &nbsp; ### Load class and gather all TIME rules<br />&nbsp; &nbsp; htb_load_class $classfile<br />&nbsp; &nbsp; TIMESET=`htb_cfile_rules TIME`<br />&nbsp; &nbsp; [ -z &quot;$TIMESET&quot; ] &amp;&amp; continue</p><p>&nbsp; &nbsp; MATCH=0; CHANGE=0<br />&nbsp; &nbsp; for timerule in $TIMESET; do<br />&nbsp; &nbsp; &nbsp; &nbsp; ### Split TIME rule to pieces<br />&nbsp; &nbsp; &nbsp; &nbsp; TIMESPEC=${timerule%%;*}; PARAMS=${timerule##*;}<br />&nbsp; &nbsp; &nbsp; &nbsp; WEEKDAYS=${TIMESPEC%%/*}; INTERVAL=${TIMESPEC##*/}<br />&nbsp; &nbsp; &nbsp; &nbsp; BEG_TIME=${INTERVAL%%-*}; END_TIME=${INTERVAL##*-}</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ### Check the day-of-week (if present)<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$WEEKDAYS&quot; != &quot;$INTERVAL&quot; -a \<br />&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;-n &quot;${WEEKDAYS##*$TIME_DOW*}&quot; ] &amp;&amp; continue</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ### Compute interval boundaries<br />&nbsp; &nbsp; &nbsp; &nbsp; BEG_ABS=`htb_time2abs $BEG_TIME`<br />&nbsp; &nbsp; &nbsp; &nbsp; END_ABS=`htb_time2abs $END_TIME`</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ### Midnight wrap fixup<br />&nbsp; &nbsp; &nbsp; &nbsp; if [ $BEG_ABS -gt $END_ABS ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ $TIME_ABS -le $END_ABS ] &amp;&amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TIME_ABS=$[TIME_ABS + 24*60]</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; END_ABS=$[END_ABS + 24*60]<br />&nbsp; &nbsp; &nbsp; &nbsp; fi</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ### If time period matches, remember params and set MATCH flag<br />&nbsp; &nbsp; &nbsp; &nbsp; if [ $TIME_ABS -ge $BEG_ABS -a $TIME_ABS -lt $END_ABS ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RATESPEC=${PARAMS%%,*}; CEILSPEC=${PARAMS##*,}<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$RATESPEC&quot; = &quot;$CEILSPEC&quot; ] &amp;&amp; CEILSPEC=&quot;&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NEW_RATE=${RATESPEC%%/*}; NEW_BURST=${RATESPEC##*/}<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$NEW_RATE&quot; = &quot;$NEW_BURST&quot; ] &amp;&amp; NEW_BURST=&quot;&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NEW_CEIL=${CEILSPEC%%/*}; NEW_CBURST=${CEILSPEC##*/}<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$NEW_CEIL&quot; = &quot;$NEW_CBURST&quot; ] &amp;&amp; NEW_CBURST=&quot;&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MATCH=1<br />&nbsp; &nbsp; &nbsp; &nbsp; fi<br />&nbsp; &nbsp; done ### timerule</p><br /><p>&nbsp; &nbsp; ### Get current RATE and CEIL of a class<br />&nbsp; &nbsp; read RATE_NOW JUNK CEIL_NOW &lt;&lt;-EOT<br />&nbsp; &nbsp; `htb_class_state $DEVICE $CLASS`<br />&nbsp; &nbsp; EOT</p><p>&nbsp; &nbsp; [ -z &quot;$RATE_NOW&quot; -o -z &quot;$CEIL_NOW&quot; ] &amp;&amp; continue</p><br /><p>&nbsp; &nbsp; ### Fill empty values if matched<br />&nbsp; &nbsp; if [ $MATCH -ne 0 ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; NEW_RATE=${NEW_RATE:-$RATE_NOW}<br />&nbsp; &nbsp; &nbsp; &nbsp; NEW_CEIL=${NEW_CEIL:-$CEIL_NOW}</p><p>&nbsp; &nbsp; &nbsp; &nbsp; NEW_BURST=${NEW_BURST:-$BURST}<br />&nbsp; &nbsp; &nbsp; &nbsp; NEW_CBURST=${NEW_CBURST:-$CBURST}</p><p>&nbsp; &nbsp; ### Force configured values if not matched<br />&nbsp; &nbsp; else<br />&nbsp; &nbsp; &nbsp; &nbsp; NEW_RATE=$RATE; NEW_CEIL=$CEIL<br />&nbsp; &nbsp; &nbsp; &nbsp; NEW_BURST=$BURST; NEW_CBURST=$CBURST<br />&nbsp; &nbsp; fi</p><br /><br /><p>&nbsp; &nbsp; ### Check for RATE and CEIL changes<br />&nbsp; &nbsp; [ &quot;$RATE_NOW&quot; != &quot;$NEW_RATE&quot; ] &amp;&amp; CHANGE=1<br />&nbsp; &nbsp; [ &quot;$CEIL_NOW&quot; != &quot;$NEW_CEIL&quot; ] &amp;&amp; CHANGE=1</p><p>&nbsp; &nbsp; ### If there are no changes, go for next class<br />&nbsp; &nbsp; [ $CHANGE -eq 0 ] &amp;&amp; continue</p><br /><p>&nbsp; &nbsp; ### Replace HTB class<br />&nbsp; &nbsp; tc class change dev $DEVICE classid 1:$CLASS htb \<br />&nbsp; &nbsp; prio $PRIO rate $NEW_RATE ${NEW_CEIL:+ceil $NEW_CEIL} \<br />&nbsp; &nbsp; ${NEW_BURST:+burst $NEW_BURST} ${NEW_CBURST:+cburst $NEW_CBURST}</p><p>&nbsp; &nbsp; htb_message &quot;$TIME_NOW: change on $DEVICE:$CLASS ($RATE_NOW/$CEIL_NOW -&gt; $NEW_RATE/$NEW_CEIL)&quot;<br />done ### class file<br />;;</p><br /><p>#############################################################################<br />################################## THE REST #################################<br />#############################################################################</p><p>stop)<br />&nbsp; &nbsp; htb_off<br />&nbsp; &nbsp; ;;</p><p>list)<br />&nbsp; &nbsp; htb_show<br />&nbsp; &nbsp; ;;</p><p>stats)<br />&nbsp; &nbsp; htb_show -s<br />&nbsp; &nbsp; ;;</p><p>restart)<br />&nbsp; &nbsp; shift<br />&nbsp; &nbsp; $0 stop<br />&nbsp; &nbsp; $0 start &quot;$@&quot;<br />&nbsp; &nbsp; ;;</p><p>*)<br />&nbsp; &nbsp; echo &quot;Usage: `basename $0` {start|compile|stop|restart|timecheck|list|stats}&quot;<br />esac</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p11743">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">AzCowboy</div>
					<div class="post-datetime">
						5 Sep 2005, 21:39					</div>
				</div>
				<div class="post-content content">
					<p>I dunno... I think those smilies might confuse Linux... it&#039;s a pretty serious operating system, no sense of humor at all.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p11755">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">ewildgoose</div>
					<div class="post-datetime">
						6 Sep 2005, 01:32					</div>
				</div>
				<div class="post-content content">
					<p>Crikey.&nbsp; If you can&#039;t translate it yourself are you sure you understand it well enough to use it ok?!?</p><p>There are smaller and simpler scripts around for QOS.&nbsp; You might want to start with one of those or knock something up yourself based on the notes at LARTC</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>