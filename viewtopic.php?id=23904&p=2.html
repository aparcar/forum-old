<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Multi-WAN Load Balancing</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 29 Mar 2018 and 3 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 2 of 14</div><nav><ul><li><a href="viewtopic.php%3Fid=23904&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=23904&amp;p=4.html">4</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=14.html">14</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p105136">
				<div class="post-metadata">
					<div class="post-num">Post #26</div>
					<div class="post-author">Patrik85</div>
					<div class="post-datetime">
						24 Mar 2010, 01:25					</div>
				</div>
				<div class="post-content content">
					<p>I will test your suggestions asap.<br />First I will configure the Modem to perform the PPPOE dial-in and configure one WAN link to use DHCP instead of PPPOE.<br />This will give the openwrt router also the same WAN address, but I am not sure if then the modem is used as gateway.<br />If yes, this might be the solution.</p><p>If this does not help I will configure a second router which actually has a modem included to connect the second WAN link. This router will have IP 192.168.1.1 with DHCP activated.</p><p>Did I understand everything correct?</p><p>Can you provide details regarding masquerading and the static router you are talking about?<br />Where will this be configured? On the second non openwrt router or on the openwrt router?</p><p>Thanks again for your great support!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105137">
				<div class="post-metadata">
					<div class="post-num">Post #27</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						24 Mar 2010, 01:40					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Patrik85 wrote:</cite><blockquote><p>I will test your suggestions asap.<br />First I will configure the Modem to perform the PPPOE dial-in and configure one WAN link to use DHCP instead of PPPOE.<br />This will give the openwrt router also the same WAN address, but I am not sure if then the modem is used as gateway.<br />If yes, this might be the solution.</p><p>If this does not help I will configure a second router which actually has a modem included to connect the second WAN link. This router will have IP 192.168.1.1 with DHCP activated.</p><p>Did I understand everything correct?</p><p>Can you provide details regarding masquerading and the static router you are talking about?<br />Where will this be configured? On the second non openwrt router or on the openwrt router?</p><p>Thanks again for your great support!</p></blockquote></div><p>Correct, I would first get it working via double natting, then you can move on from there.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105211">
				<div class="post-metadata">
					<div class="post-num">Post #28</div>
					<div class="post-author">Patrik85</div>
					<div class="post-datetime">
						24 Mar 2010, 23:23					</div>
				</div>
				<div class="post-content content">
					<p>Good news.<br />I placed another router between the WRT54GL and one of the DSL modems.<br />Now the WRT54GL is using the second router with its internal IP (192.1681.1) as gateway.<br />Downloads are now using both links.<br />The peak download speed I saw are 2MB/s.<br />Using both lines with seperate routers are able to provide a maximum of 2.8MB/s.<br />I read that the maximum what the WRT54GL can handle is 28 MBit/s. That would be sufficient.<br />Is there any chance to improve the download speed?<br />Can you give me some input on the dual natting issue which comes with the second router?<br />I disabled the firewall in the second router.<br />How would I know configure port-forwarding for torrent downloads for example?<br />Is there a chance to double the upload speed also?</p><p>Thanks for your input and best regards,<br />Patrik</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105288">
				<div class="post-metadata">
					<div class="post-num">Post #29</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						26 Mar 2010, 01:15					</div>
				</div>
				<div class="post-content content">
					<p>Glad to see it&#039;s working.</p><p>To remove the double natting, set the interface that connects to the second router as a static IP. (192.168.1.2)</p><p>Make sure to have the Secondary Router forward all incoming traffic to the Multi-WAN Router. (192.168.1.2)</p><p>You&#039;ll need to create static routes back and fourth to the Multi-WAN router, </p><p>Here&#039;s an example,</p><p>Multi-WAN Router Static Route:<br />Interface: (whatever the interface going to the second router is)<br />Target: 192.168.1.0<br />Subnet Mask: 255.255.255.0<br />IPV4-Gateway: 192.168.1.1</p><p>Secondary PreRouter Static Route:<br />Interface: (lan)<br />Target: 192.168.0.0 (Or whatever your using for the LAN subnet on the Multi-WAN Router)<br />Subnet Mask: 255.255.255.0<br />IPV4-Gateway: 192.168.1.2</p><p>This will allow the secondary prerouter to communicate with clients on the lan of the Multi-WAN Router, the next step is disabling the MASQUERADE option on the Multi-WAN router so that it&#039;s performed by the Secondary PreRouter.</p><p>As for speed, this implementation of Multi-WAN cannot combine the speed of the WANs, it can only distribute new sessions across them.</p>											<p class="post-edited">(Last edited by <strong>SouthPawn</strong> on 26 Mar 2010, 02:24)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105379">
				<div class="post-metadata">
					<div class="post-num">Post #30</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						27 Mar 2010, 17:24					</div>
				</div>
				<div class="post-content content">
					<p>Hi SouthPawn,</p><br /><p>Using your script for a couple of days now, but im running into a problem. At first it looked like QoS didn&#039;t work as expected, but this was due to not having iptables-tools installed. Now that i made a new image from trunk with iptables-tools enabled, your script stops working for me. After starting your script, it is almost impossible to browse the internet. As i try to ping hosts on internet from client pc&#039;s, only from the first packet i get response.</p><p>This is what my mangle table looks like after starting your script. Does everything seem OK to you? Will try to troubleshoot some more later this day...</p><div class="codebox"><pre><code>Chain PREROUTING (policy ACCEPT 3267 packets, 624K bytes)
 pkts bytes target     prot opt in     out     source               destination
 3294  626K MultiWan   all  --  any    any     anywhere             anywhere
  766  183K IMQ        all  --  eth0.1 any     anywhere             anywhere            IMQ: todev 0
  349  148K IMQ        all  --  eth0.2 any     anywhere             anywhere            IMQ: todev 1

Chain INPUT (policy ACCEPT 1750 packets, 170K bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain FORWARD (policy ACCEPT 1017 packets, 289K bytes)
 pkts bytes target     prot opt in     out     source               destination
 1017  289K MultiWan   all  --  any    any     anywhere             anywhere

Chain OUTPUT (policy ACCEPT 1563 packets, 236K bytes)
 pkts bytes target     prot opt in     out     source               destination
 1648  242K MultiWan   all  --  any    any     anywhere             anywhere

Chain POSTROUTING (policy ACCEPT 2658 packets, 539K bytes)
 pkts bytes target     prot opt in     out     source               destination
 2758  546K MultiWan   all  --  any    any     anywhere             anywhere

Chain Default (0 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK restore
    0     0 Default_ct  all  --  any    any     anywhere             anywhere            mark match 0x0
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x1 length 400:65535 MARK and 0x0
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x2 length 800:65535 MARK and 0x0
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x0 length 0:500 MARK set 0x2
    0     0 MARK       icmp --  any    any     anywhere             anywhere            MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x0 tcp spts:1024:65535 dpts:1024:65535 MARK set 0x4
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x0 udp spts:1024:65535 dpts:1024:65535 MARK set 0x4
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            length 0:128 mark match !0x4 tcp flags:FIN,SYN,RST,PSH,ACK,URG/SYN MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            length 0:128 mark match !0x4 tcp flags:FIN,SYN,RST,PSH,ACK,URG/ACK MARK set 0x1

Chain Default_ct (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x0 LAYER7 l7proto edonkey MARK set 0x4
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x0 LAYER7 l7proto bittorrent MARK set 0x4
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x0 tcp multiport ports 22,53 MARK set 0x1
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x0 udp multiport ports 22,53 MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x0 tcp multiport ports 20,21,25,80,110,443,993,995 MARK set 0x3
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x0 tcp multiport ports 5190 MARK set 0x2
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x0 udp multiport ports 5190 MARK set 0x2
    0     0 CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK save

Chain FW1MARK (8 references)
 pkts bytes target     prot opt in     out     source               destination
  721  180K MARK       all  --  any    any     anywhere             anywhere            MARK set 0x10
  721  180K CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK save

Chain FW2MARK (6 references)
 pkts bytes target     prot opt in     out     source               destination
  208 19954 MARK       all  --  any    any     anywhere             anywhere            MARK set 0x20
  208 19954 CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK save

Chain LoadBalancer (1 references)
 pkts bytes target     prot opt in     out     source               destination
  742 61270 MARK       all  --  any    any     anywhere             anywhere            MARK set 0x123
  742 61270 CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK save

Chain MultiWan (4 references)
 pkts bytes target     prot opt in     out     source               destination
 8717 1703K CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK restore
 8717 1703K MultiWanPreHandler  all  --  any    any     anywhere             anywhere
 8657 1697K MultiWanDNS  all  --  any    any     anywhere             anywhere
 8505 1687K MultiWanRules  all  --  any    any     anywhere             anywhere
 8505 1687K MultiWanPostHandler  all  --  any    any     anywhere             anywhere
 8505 1687K MultiWanQoS  all  --  any    any     anywhere             anywhere

Chain MultiWanDNS (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 FW1MARK    tcp  --  any    any     anywhere             ns01.upclive.nl     tcp dpt:53
   38  2272 FW1MARK    udp  --  any    any     anywhere             ns01.upclive.nl     udp dpt:53
    0     0 ACCEPT     tcp  --  any    any     anywhere             ns01.upclive.nl     tcp dpt:53
   38  2272 ACCEPT     udp  --  any    any     anywhere             ns01.upclive.nl     udp dpt:53
    0     0 FW1MARK    tcp  --  any    any     anywhere             ns02.upclive.nl     tcp dpt:53
   50  3120 FW1MARK    udp  --  any    any     anywhere             ns02.upclive.nl     udp dpt:53
    0     0 ACCEPT     tcp  --  any    any     anywhere             ns02.upclive.nl     tcp dpt:53
   50  3120 ACCEPT     udp  --  any    any     anywhere             ns02.upclive.nl     udp dpt:53
    0     0 FW2MARK    tcp  --  any    any     anywhere             192.168.32.254      tcp dpt:53
   32  1910 FW2MARK    udp  --  any    any     anywhere             192.168.32.254      udp dpt:53
    0     0 ACCEPT     tcp  --  any    any     anywhere             192.168.32.254      tcp dpt:53
   32  1910 ACCEPT     udp  --  any    any     anywhere             192.168.32.254      udp dpt:53

Chain MultiWanPostHandler (1 references)
 pkts bytes target     prot opt in     out     source               destination
  167 14072 FW1MARK    all  --  any    eth0.1  anywhere             anywhere            mark match 0x123
  150 13124 FW2MARK    all  --  any    eth0.2  anywhere             anywhere            mark match 0x123

Chain MultiWanPreHandler (1 references)
 pkts bytes target     prot opt in     out     source               destination
  466  161K FW1MARK    all  --  eth0.1 any     anywhere             anywhere            state NEW
   26  4920 FW2MARK    all  --  eth0.2 any     anywhere             anywhere            state NEW

Chain MultiWanQoS (1 references)
 pkts bytes target     prot opt in     out     source               destination
 1709  257K MultiWanQoS_isp1  all  --  any    any     anywhere             anywhere            mark match 0x10
    0     0 MultiWanQoS_isp1  all  --  any    any     anywhere             anywhere            mark match 0x11
    0     0 MultiWanQoS_isp1  all  --  any    any     anywhere             anywhere            mark match 0x12
    0     0 MultiWanQoS_isp1  all  --  any    any     anywhere             anywhere            mark match 0x13
    0     0 MultiWanQoS_isp1  all  --  any    any     anywhere             anywhere            mark match 0x14
  524 56924 MultiWanQoS_isp2  all  --  any    any     anywhere             anywhere            mark match 0x20
    0     0 MultiWanQoS_isp2  all  --  any    any     anywhere             anywhere            mark match 0x21
    0     0 MultiWanQoS_isp2  all  --  any    any     anywhere             anywhere            mark match 0x22
    0     0 MultiWanQoS_isp2  all  --  any    any     anywhere             anywhere            mark match 0x23
    0     0 MultiWanQoS_isp2  all  --  any    any     anywhere             anywhere            mark match 0x24

Chain MultiWanQoS_isp1 (5 references)
 pkts bytes target     prot opt in     out     source               destination
 1709  257K CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK restore
 1709  257K MultiWanQoS_isp1_ct  all  --  any    any     anywhere             anywhere            mark match 0x10
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x11 length 400:65535 MARK and 0x0
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x12 length 800:65535 MARK and 0x0
  550  176K MARK       udp  --  any    any     anywhere             anywhere            mark match 0x10 length 0:500 MARK set 0x2
 1093 75012 MARK       icmp --  any    any     anywhere             anywhere            MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x10 tcp spts:1024:65535 dpts:1024:65535 MARK set 0x4
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x10 udp spts:1024:65535 dpts:1024:65535 MARK set 0x4
   25  1300 MARK       tcp  --  any    any     anywhere             anywhere            length 0:128 mark match !0x14 tcp flags:FIN,SYN,RST,PSH,ACK,URG/SYN MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            length 0:128 mark match !0x14 tcp flags:FIN,SYN,RST,PSH,ACK,URG/ACK MARK set 0x1

Chain MultiWanQoS_isp1_ct (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x10 LAYER7 l7proto edonkey MARK set 0x4
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x10 LAYER7 l7proto bittorrent MARK set 0x4
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x10 tcp multiport ports 22,53 MARK set 0x1
   41  4706 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x10 udp multiport ports 22,53 MARK set 0x1
   25  1300 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x10 tcp multiport ports 20,21,25,80,110,443,993,995 MARK set 0x3
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x10 tcp multiport ports 5190 MARK set 0x2
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x10 udp multiport ports 5190 MARK set 0x2
 1709  257K CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK save

Chain MultiWanQoS_isp2 (5 references)
 pkts bytes target     prot opt in     out     source               destination
  524 56924 CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK restore
  524 56924 MultiWanQoS_isp2_ct  all  --  any    any     anywhere             anywhere            mark match 0x20
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x21 length 400:65535 MARK and 0x0
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x22 length 800:65535 MARK and 0x0
  104 19680 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x20 length 0:500 MARK set 0x2
  393 33012 MARK       icmp --  any    any     anywhere             anywhere            MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x20 tcp spts:1024:65535 dpts:1024:65535 MARK set 0x4
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x20 udp spts:1024:65535 dpts:1024:65535 MARK set 0x4
   12   624 MARK       tcp  --  any    any     anywhere             anywhere            length 0:128 mark match !0x24 tcp flags:FIN,SYN,RST,PSH,ACK,URG/SYN MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            length 0:128 mark match !0x24 tcp flags:FIN,SYN,RST,PSH,ACK,URG/ACK MARK set 0x1

Chain MultiWanQoS_isp2_ct (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x20 LAYER7 l7proto edonkey MARK set 0x4
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x20 LAYER7 l7proto bittorrent MARK set 0x4
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x20 tcp multiport ports 22,53 MARK set 0x1
   15  3608 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x20 udp multiport ports 22,53 MARK set 0x1
   12   624 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x20 tcp multiport ports 20,21,25,80,110,443,993,995 MARK set 0x3
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x20 tcp multiport ports 5190 MARK set 0x2
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x20 udp multiport ports 5190 MARK set 0x2
  524 56924 CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK save

Chain MultiWanRules (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 FW1MARK    tcp  --  any    any     anywhere             newsreader1.eweka.nl mark match 0x0 tcp dpt:119
    0     0 FW1MARK    udp  --  any    any     anywhere             newsreader1.eweka.nl mark match 0x0 udp dpt:119
    0     0 FW2MARK    tcp  --  any    any     anywhere             newsreader3.eweka.nl mark match 0x0 tcp dpt:119
    0     0 FW2MARK    udp  --  any    any     anywhere             newsreader3.eweka.nl mark match 0x0 udp dpt:119
  742 61270 LoadBalancer  all  --  any    any     anywhere             anywhere            mark match 0x0</code></pre></div><p>Thank you.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105395">
				<div class="post-metadata">
					<div class="post-num">Post #31</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						27 Mar 2010, 23:46					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><div class="codebox"><pre><code>Chain MultiWanQoS (1 references)
 pkts bytes target     prot opt in     out     source               destination
 1709  257K MultiWanQoS_isp1  all  --  any    any     anywhere             anywhere            mark match 0x10
    0     0 MultiWanQoS_isp1  all  --  any    any     anywhere             anywhere            mark match 0x11
    0     0 MultiWanQoS_isp1  all  --  any    any     anywhere             anywhere            mark match 0x12
    0     0 MultiWanQoS_isp1  all  --  any    any     anywhere             anywhere            mark match 0x13
    0     0 MultiWanQoS_isp1  all  --  any    any     anywhere             anywhere            mark match 0x14
  524 56924 MultiWanQoS_isp2  all  --  any    any     anywhere             anywhere            mark match 0x20
    0     0 MultiWanQoS_isp2  all  --  any    any     anywhere             anywhere            mark match 0x21
    0     0 MultiWanQoS_isp2  all  --  any    any     anywhere             anywhere            mark match 0x22
    0     0 MultiWanQoS_isp2  all  --  any    any     anywhere             anywhere            mark match 0x23
    0     0 MultiWanQoS_isp2  all  --  any    any     anywhere             anywhere            mark match 0x24

Chain MultiWanQoS_isp1 (5 references)
 pkts bytes target     prot opt in     out     source               destination
 1709  257K CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK restore
 1709  257K MultiWanQoS_isp1_ct  all  --  any    any     anywhere             anywhere            mark match 0x10
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x11 length 400:65535 MARK and 0x0
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x12 length 800:65535 MARK and 0x0
  550  176K MARK       udp  --  any    any     anywhere             anywhere            mark match 0x10 length 0:500 MARK set 0x2
 1093 75012 MARK       icmp --  any    any     anywhere             anywhere            MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x10 tcp spts:1024:65535 dpts:1024:65535 MARK set 0x4
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x10 udp spts:1024:65535 dpts:1024:65535 MARK set 0x4
   25  1300 MARK       tcp  --  any    any     anywhere             anywhere            length 0:128 mark match !0x14 tcp flags:FIN,SYN,RST,PSH,ACK,URG/SYN MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            length 0:128 mark match !0x14 tcp flags:FIN,SYN,RST,PSH,ACK,URG/ACK MARK set 0x1

Chain MultiWanQoS_isp1_ct (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x10 LAYER7 l7proto edonkey MARK set 0x4
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x10 LAYER7 l7proto bittorrent MARK set 0x4
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x10 tcp multiport ports 22,53 MARK set 0x1
   41  4706 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x10 udp multiport ports 22,53 MARK set 0x1
   25  1300 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x10 tcp multiport ports 20,21,25,80,110,443,993,995 MARK set 0x3
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x10 tcp multiport ports 5190 MARK set 0x2
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x10 udp multiport ports 5190 MARK set 0x2
 1709  257K CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK save

Chain MultiWanQoS_isp2 (5 references)
 pkts bytes target     prot opt in     out     source               destination
  524 56924 CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK restore
  524 56924 MultiWanQoS_isp2_ct  all  --  any    any     anywhere             anywhere            mark match 0x20
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x21 length 400:65535 MARK and 0x0
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x22 length 800:65535 MARK and 0x0
  104 19680 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x20 length 0:500 MARK set 0x2
  393 33012 MARK       icmp --  any    any     anywhere             anywhere            MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x20 tcp spts:1024:65535 dpts:1024:65535 MARK set 0x4
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x20 udp spts:1024:65535 dpts:1024:65535 MARK set 0x4
   12   624 MARK       tcp  --  any    any     anywhere             anywhere            length 0:128 mark match !0x24 tcp flags:FIN,SYN,RST,PSH,ACK,URG/SYN MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            length 0:128 mark match !0x24 tcp flags:FIN,SYN,RST,PSH,ACK,URG/ACK MARK set 0x1

Chain MultiWanQoS_isp2_ct (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x20 LAYER7 l7proto edonkey MARK set 0x4
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x20 LAYER7 l7proto bittorrent MARK set 0x4
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x20 tcp multiport ports 22,53 MARK set 0x1
   15  3608 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x20 udp multiport ports 22,53 MARK set 0x1
   12   624 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x20 tcp multiport ports 20,21,25,80,110,443,993,995 MARK set 0x3
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x20 tcp multiport ports 5190 MARK set 0x2
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x20 udp multiport ports 5190 MARK set 0x2
  524 56924 CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK save</code></pre></div></blockquote></div><p>Everything else looked good except the QoS area, I&#039;ve updated the script to 1.0f which should take care of this issue, let me know if it does not. I also removed tcp 53 connections from the MultiWanDNS, as it&#039;s unnecessary for client queries.</p><p>Thanks Adze,<br />-Craig</p>											<p class="post-edited">(Last edited by <strong>SouthPawn</strong> on 28 Mar 2010, 00:42)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105398">
				<div class="post-metadata">
					<div class="post-num">Post #32</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						28 Mar 2010, 00:44					</div>
				</div>
				<div class="post-content content">
					<p>SouthPawn, </p><p>Thank you for your fast reply. Tried revision f, but no luck though...</p><p>I did figure out that it indeed has something to do with qos-scripts and multiwan. If multiwan is used without the qos package, it works brilliant. but with qos and multiwan active, internet is dead. With tcp-dump i can see that occasionaly packets leave the wrong interface (packets with a masqed source ip of eth0.1 leaving at eth0.2 and vice-versa). Dont know yet why. Running without qos now for the moment.</p><p>Thanks and will keep you updated.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105416">
				<div class="post-metadata">
					<div class="post-num">Post #33</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						28 Mar 2010, 06:31					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>SouthPawn, </p><p>Thank you for your fast reply. Tried revision f, but no luck though...</p><p>I did figure out that it indeed has something to do with qos-scripts and multiwan. If multiwan is used without the qos package, it works brilliant. but with qos and multiwan active, internet is dead. With tcp-dump i can see that occasionaly packets leave the wrong interface (packets with a masqed source ip of eth0.1 leaving at eth0.2 and vice-versa). Dont know yet why. Running without qos now for the moment.</p><p>Thanks and will keep you updated.</p></blockquote></div><p>Hey Adze,</p><p>I&#039;ve updated it again, 1.0g, I believe the problem is a variance in the iptables-save output, hopefully this latest one deals with it better. If not, we may need to see a little more about the output of iptables-save for the Default and Default_ct tables on your setup.</p><p>Thanks Adze, <br />-Craig</p>											<p class="post-edited">(Last edited by <strong>SouthPawn</strong> on 28 Mar 2010, 13:01)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105497">
				<div class="post-metadata">
					<div class="post-num">Post #34</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						29 Mar 2010, 13:55					</div>
				</div>
				<div class="post-content content">
					<p>Hi SouthPawn,</p><br /><p>Thanks for the effort, but still no cigar... With qos disabled (package installed but disabled in config) it works like it should. If you&#039;re interessted i could give you ssh acces to my router to troubleshoot, otherwise i wil continue troubleshoot next weekend.</p><p>Thanks.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105509">
				<div class="post-metadata">
					<div class="post-num">Post #35</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						29 Mar 2010, 16:02					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hi SouthPawn,</p><br /><p>Thanks for the effort, but still no cigar... With qos disabled (package installed but disabled in config) it works like it should. If you&#039;re interessted i could give you ssh acces to my router to troubleshoot, otherwise i wil continue troubleshoot next weekend.</p><p>Thanks.</p></blockquote></div><p>We can definitely arrange that, but first, can you provide the output of iptables-save | egrep&nbsp; &#039;(-A Default )|(-A Default_ct )&#039; ?</p><p>Thanks Adze,<br />-Craig</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105513">
				<div class="post-metadata">
					<div class="post-num">Post #36</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						29 Mar 2010, 17:52					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>SouthPawn wrote:</cite><blockquote><p>...can you provide the output of iptables-save | egrep&nbsp; &#039;(-A Default )|(-A Default_ct )&#039; ?</p><p>-Craig</p></blockquote></div><p>sure <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><div class="codebox"><pre><code>root@Mercurius:~# iptables-save | egrep  &#039;(-A Default )|(-A Default_ct )&#039;
-A Default -m mark --mark 0x0 -j Default_ct
-A Default -m mark --mark 0x1 -m length --length 400:65535 -j MARK --set-xmark 0x0/0xffffffff
-A Default -m mark --mark 0x2 -m length --length 800:65535 -j MARK --set-xmark 0x0/0xffffffff
-A Default -p udp -m mark --mark 0x0 -m length --length 0:500 -j MARK --set-xmark 0x2/0xffffffff
-A Default -p icmp -j MARK --set-xmark 0x1/0xffffffff
-A Default -p tcp -m mark --mark 0x0 -m tcp --sport 1024:65535 --dport 1024:65535 -j MARK --set-xmark 0x4/0xffffffff
-A Default -p udp -m mark --mark 0x0 -m udp --sport 1024:65535 --dport 1024:65535 -j MARK --set-xmark 0x4/0xffffffff
-A Default -p tcp -m length --length 0:128 -m mark ! --mark 0x4 -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG SYN -j MARK --set-xmark 0x1/0xffffffff
-A Default -p tcp -m length --length 0:128 -m mark ! --mark 0x4 -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG ACK -j MARK --set-xmark 0x1/0xffffffff
-A Default_ct -m mark --mark 0x0 -m layer7 --l7proto edonkey -j MARK --set-xmark 0x4/0xffffffff
-A Default_ct -m mark --mark 0x0 -m layer7 --l7proto bittorrent -j MARK --set-xmark 0x4/0xffffffff
-A Default_ct -p tcp -m mark --mark 0x0 -m tcp -m multiport --ports 22,53 -j MARK --set-xmark 0x1/0xffffffff
-A Default_ct -p udp -m mark --mark 0x0 -m udp -m multiport --ports 22,53 -j MARK --set-xmark 0x1/0xffffffff
-A Default_ct -p tcp -m mark --mark 0x0 -m tcp -m multiport --ports 20,21,25,80,110,443,993,995 -j MARK --set-xmark 0x3/0xffffffff
-A Default_ct -p tcp -m mark --mark 0x0 -m tcp -m multiport --ports 5190 -j MARK --set-xmark 0x2/0xffffffff
-A Default_ct -p udp -m mark --mark 0x0 -m udp -m multiport --ports 5190 -j MARK --set-xmark 0x2/0xffffffff
-A Default_ct -j CONNMARK --save-mark --nfmask 0xffffffff --ctmask 0xffffffff</code></pre></div><p>And this is a part of the mangle table:<br /></p><div class="codebox"><pre><code>Chain MultiWanQoS (1 references)
 pkts bytes target     prot opt in     out     source               destination
    5   364 MultiWanQoS_isp1  all  --  any    any     anywhere             anywhere            mark match 0x10
    0     0 MultiWanQoS_isp1  all  --  any    any     anywhere             anywhere            mark match 0x11
    0     0 MultiWanQoS_isp1  all  --  any    any     anywhere             anywhere            mark match 0x12
    0     0 MultiWanQoS_isp1  all  --  any    any     anywhere             anywhere            mark match 0x13
    0     0 MultiWanQoS_isp1  all  --  any    any     anywhere             anywhere            mark match 0x14
    3   252 MultiWanQoS_isp2  all  --  any    any     anywhere             anywhere            mark match 0x20
    0     0 MultiWanQoS_isp2  all  --  any    any     anywhere             anywhere            mark match 0x21
    0     0 MultiWanQoS_isp2  all  --  any    any     anywhere             anywhere            mark match 0x22
    0     0 MultiWanQoS_isp2  all  --  any    any     anywhere             anywhere            mark match 0x23
    0     0 MultiWanQoS_isp2  all  --  any    any     anywhere             anywhere            mark match 0x24

Chain MultiWanQoS_isp1 (5 references)
 pkts bytes target     prot opt in     out     source               destination
    5   364 MultiWanQoS_isp1_ct  all  --  any    any     anywhere             anywhere            mark match 0x10
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x11 length 400:65535 MARK and 0x0
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x12 length 800:65535 MARK and 0x0
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x10 length 0:500 MARK set 0x2
    3   252 MARK       icmp --  any    any     anywhere             anywhere            MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x10 tcp spts:1024:65535 dpts:1024:65535 MARK set 0x4
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x10 udp spts:1024:65535 dpts:1024:65535 MARK set 0x4
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            length 0:128 mark match !0x14 tcp flags:FIN,SYN,RST,PSH,ACK,URG/SYN MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            length 0:128 mark match !0x14 tcp flags:FIN,SYN,RST,PSH,ACK,URG/ACK MARK set 0x1

Chain MultiWanQoS_isp1_ct (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x10 LAYER7 l7proto edonkey MARK set 0x4
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x10 LAYER7 l7proto bittorrent MARK set 0x4
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x10 tcp multiport ports 22,53 MARK set 0x1
    2   112 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x10 udp multiport ports 22,53 MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x10 tcp multiport ports 20,21,25,80,110,443,993,995 MARK set 0x3
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x10 tcp multiport ports 5190 MARK set 0x2
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x10 udp multiport ports 5190 MARK set 0x2
    5   364 CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK save

Chain MultiWanQoS_isp2 (5 references)
 pkts bytes target     prot opt in     out     source               destination
    3   252 MultiWanQoS_isp2_ct  all  --  any    any     anywhere             anywhere            mark match 0x20
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x21 length 400:65535 MARK and 0x0
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x22 length 800:65535 MARK and 0x0
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x20 length 0:500 MARK set 0x2
    3   252 MARK       icmp --  any    any     anywhere             anywhere            MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x20 tcp spts:1024:65535 dpts:1024:65535 MARK set 0x4
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x20 udp spts:1024:65535 dpts:1024:65535 MARK set 0x4
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            length 0:128 mark match !0x24 tcp flags:FIN,SYN,RST,PSH,ACK,URG/SYN MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            length 0:128 mark match !0x24 tcp flags:FIN,SYN,RST,PSH,ACK,URG/ACK MARK set 0x1

Chain MultiWanQoS_isp2_ct (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x20 LAYER7 l7proto edonkey MARK set 0x4
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x20 LAYER7 l7proto bittorrent MARK set 0x4
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x20 tcp multiport ports 22,53 MARK set 0x1
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x20 udp multiport ports 22,53 MARK set 0x1
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x20 tcp multiport ports 20,21,25,80,110,443,993,995 MARK set 0x3
    0     0 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x20 tcp multiport ports 5190 MARK set 0x2
    0     0 MARK       udp  --  any    any     anywhere             anywhere            mark match 0x20 udp multiport ports 5190 MARK set 0x2
    3   252 CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK save</code></pre></div><p>Shouldn&#039;t those qos marks be set to a different value? I also noticed something else, which might be wrong. Although i set the health_interval to 5 on each interface, it still sends out one icmp-request per 10 seconds.</p><p>Thanks!</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 29 Mar 2010, 18:06)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105570">
				<div class="post-metadata">
					<div class="post-num">Post #37</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						30 Mar 2010, 00:59					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Shouldn&#039;t those qos marks be set to a different value? I also noticed something else, which might be wrong. Although i set the health_interval to 5 on each interface, it still sends out one icmp-request per 10 seconds.</p><p>Thanks!</p></blockquote></div><p>I&#039;ve updated it again, to 1.0h which should deal with the change in qos-scripts.<br />I&#039;ve also updated the health monitor to allow a minimum of 5 seconds, before it was set to 10, but rethinking about it, I don&#039;t see why it should need to be, so setting it to 5 should now work fine.</p><p>Thanks Adze,<br />-Craig</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105602">
				<div class="post-metadata">
					<div class="post-num">Post #38</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						30 Mar 2010, 14:09					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>SouthPawn wrote:</cite><blockquote><p>I&#039;ve updated it again, to 1.0h which should deal with the change in qos-scripts.<br />I&#039;ve also updated the health monitor to allow a minimum of 5 seconds, before it was set to 10, but rethinking about it, I don&#039;t see why it should need to be, so setting it to 5 should now work fine.</p><p>Thanks Adze,<br />-Craig</p></blockquote></div><p>Hi SouthPawn,</p><p>Looks like this time everything runs smoothly. I can see that the qos mark values are changed in the mangle table. Traffic balancing works fine. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>But now i&#039;m curious to see how the qos script handles mark packets other then the normal 0x1 to 0x4. If i run `tc filter` i dont see any rules. How does the qos script &quot;know&quot; which packet belongs to which queue? As far as i can see everything is handled in the default queue...</p><p>Thank you.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105620">
				<div class="post-metadata">
					<div class="post-num">Post #39</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						30 Mar 2010, 18:43					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><div class="quotebox"><cite>SouthPawn wrote:</cite><blockquote><p>I&#039;ve updated it again, to 1.0h which should deal with the change in qos-scripts.<br />I&#039;ve also updated the health monitor to allow a minimum of 5 seconds, before it was set to 10, but rethinking about it, I don&#039;t see why it should need to be, so setting it to 5 should now work fine.</p><p>Thanks Adze,<br />-Craig</p></blockquote></div><p>Hi SouthPawn,</p><p>Looks like this time everything runs smoothly. I can see that the qos mark values are changed in the mangle table. Traffic balancing works fine. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>But now i&#039;m curious to see how the qos script handles mark packets other then the normal 0x1 to 0x4. If i run `tc filter` i dont see any rules. How does the qos script &quot;know&quot; which packet belongs to which queue? As far as i can see everything is handled in the default queue...</p><p>Thank you.</p></blockquote></div><p>To see the filters you&#039;ll need to type tc filter show dev &lt;interface&gt;, here you&#039;ll see the original filter along with the one the script added. </p><div class="codebox"><pre><code>root@OpenWrt:~# tc filter show dev eth0
filter parent 1: protocol ip pref 1 fw
filter parent 1: protocol ip pref 1 fw handle 0x1 classid 1:10
filter parent 1: protocol ip pref 1 fw handle 0x11 classid 1:10
filter parent 1: protocol ip pref 2 fw
filter parent 1: protocol ip pref 2 fw handle 0x2 classid 1:20
filter parent 1: protocol ip pref 2 fw handle 0x12 classid 1:20
filter parent 1: protocol ip pref 3 fw
filter parent 1: protocol ip pref 3 fw handle 0x3 classid 1:30
filter parent 1: protocol ip pref 3 fw handle 0x13 classid 1:30
filter parent 1: protocol ip pref 4 fw
filter parent 1: protocol ip pref 4 fw handle 0x4 classid 1:40
filter parent 1: protocol ip pref 4 fw handle 0x14 classid 1:40
root@OpenWrt:~#</code></pre></div><p>Which will correspond with ip rules set for which routing table this interface uses, which you&#039;ll see by typing ip rule.</p><div class="codebox"><pre><code>11:     from all fwmark 0x10 lookup MWAN1
12:     from all fwmark 0x11 lookup MWAN1
13:     from all fwmark 0x12 lookup MWAN1
14:     from all fwmark 0x13 lookup MWAN1
15:     from all fwmark 0x14 lookup MWAN1</code></pre></div><p>So that once it&#039;s marked by qos-scripts, it&#039;ll continue down to the correct interface.<br />If this process of copying and modifying what is created by qos-scripts didn&#039;t exist, qos would not work properly, as well, icmp packets would always be routed out the first wan.</p><p>Glad to see it&#039;s working correctly now, if you have any other questions, let me know. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />-Craig</p>											<p class="post-edited">(Last edited by <strong>SouthPawn</strong> on 30 Mar 2010, 18:53)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105641">
				<div class="post-metadata">
					<div class="post-num">Post #40</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						30 Mar 2010, 22:05					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>SouthPawn wrote:</cite><blockquote><p>Glad to see it&#039;s working correctly now, if you have any other questions, let me know. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />-Craig</p></blockquote></div><p>Hi SouthPawn,</p><br /><p>Thanks again for your time and effort. Really appreciate it! Multiwan runs really smooth now.</p><p>No further questions only two small feature requests. One is to set the minimum allowed value of health_interval to &quot;1&quot; (i know it seems strange, but let the user decide for himself what he wants), the other is a general multiwan enable/disable config option.</p><p>Thank you for your time. That&#039;ll be all... <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105660">
				<div class="post-metadata">
					<div class="post-num">Post #41</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						31 Mar 2010, 02:14					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><div class="quotebox"><cite>SouthPawn wrote:</cite><blockquote><p>Glad to see it&#039;s working correctly now, if you have any other questions, let me know. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />-Craig</p></blockquote></div><p>Hi SouthPawn,</p><br /><p>Thanks again for your time and effort. Really appreciate it! Multiwan runs really smooth now.</p><p>No further questions only two small feature requests. One is to set the minimum allowed value of health_interval to &quot;1&quot; (i know it seems strange, but let the user decide for himself what he wants), the other is a general multiwan enable/disable config option.</p><p>Thank you for your time. That&#039;ll be all... <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p></blockquote></div><p>I removed the limitation on the health_interval, but I think I&#039;m keeping the enable config option out for now, to enable/disable, /etc/init.d/multiwan enable or disable. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Thanks again<br />-Craig</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105782">
				<div class="post-metadata">
					<div class="post-num">Post #42</div>
					<div class="post-author">andyballon</div>
					<div class="post-datetime">
						1 Apr 2010, 14:02					</div>
				</div>
				<div class="post-content content">
					<p>hi, i just want to report that the luci-app-multiwan_1.0i.ipk is giving me this error on backfire rc2:<br />-----------<br />/usr/lib/lua/luci/controller/multiwan.lua:4: attempt to index field &#039;fs&#039; (a nil value)<br />stack traceback:<br />&nbsp; &nbsp; /usr/lib/lua/luci/controller/multiwan.lua:4: in function &lt;/usr/lib/lua/luci/controller/multiwan.lua:3&gt;<br />&nbsp; &nbsp; ?: in function &#039;createtree&#039;<br />&nbsp; &nbsp; ?: in function &#039;dispatch&#039;<br />&nbsp; &nbsp; ?: in function &lt;?:128&gt;<br />-----------<br />otherwise, everything seems to be working as expected. routes are going the other way during heavy loads.<br />reason i&#039;m using backfire rc2 is the i&#039;m getting a lot of sysctl errors with the kamikaze releases. those weren&#039;t there in white russian and they may be the reason why i need to power cycle the wrt54gl when i make changes. no time to investigate.<br />one quick suggestion:<br />please list the pre-requisite packages. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> <br />took me a day to figure out qos-scripts was needed.<br />overall, this is better than quagga + bgp because it uses both lines at the same time under heavy loads. but, i still miss the quick failover of quagga when one line fails.<br />i&#039;ll wait for the fixed luci thingy.</p><p>ROCK ON!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105788">
				<div class="post-metadata">
					<div class="post-num">Post #43</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						1 Apr 2010, 14:53					</div>
				</div>
				<div class="post-content content">
					<p>Fix for the error above:<br /></p><div class="codebox"><pre><code>--- usr/lib/lua/luci/controller/multiwan.lua.orig    2010-04-01 13:51:48.000000000 +0200
+++ usr/lib/lua/luci/controller/multiwan.lua    2010-04-01 13:52:08.000000000 +0200
@@ -1,7 +1,8 @@
 module(&quot;luci.controller.multiwan&quot;, package.seeall)
 
 function index()
-    if not luci.fs.access(&quot;/etc/config/multiwan&quot;) then
+    local fs = luci.fs or nixio.fs
+    if not fs.access(&quot;/etc/config/multiwan&quot;) then
         return
     end</code></pre></div><p>The luci.fs api has been deprecated.</p><p>~ JoW</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105792">
				<div class="post-metadata">
					<div class="post-num">Post #44</div>
					<div class="post-author">andyballon</div>
					<div class="post-datetime">
						1 Apr 2010, 15:27					</div>
				</div>
				<div class="post-content content">
					<p>i was digging the luci .ipk for where i&#039;ll put the above diffs and guess what i found:</p><p>======<br />Package: multiwan<br />Version: 1.0i<br />Depends: ip, iptables, iptables-utils, iptables-mod-conntrack, iptables-mod-conntrack-extra<br />Provides:<br />Source: package/multiwan<br />Section: net<br />Architecture: all<br />Priority: optional<br />Maintainer: OpenWrt Developers Team &lt;openwrt-devel@openwrt.org&gt;<br />Description:&nbsp; An agent script that makes Multi-WAN configuration simple,<br /> easy and manageable. Complete with load balancing, failover and an easy <br /> to manage traffic ruleset. Allows for configuration of up to 9 wan links.<br />======</p><p>anyhoo, i&#039;ll just wait for the &quot;j&quot; ipk.<br />(i was almost so sure multiwan needed the qos-scripts).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105793">
				<div class="post-metadata">
					<div class="post-num">Post #45</div>
					<div class="post-author">Patrik85</div>
					<div class="post-datetime">
						1 Apr 2010, 15:54					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>I having some trouble with OpenVPN and I think it has something to do with the MultiWAN Script.</p><p>Sometimes I can connect via VPN without any problem and sometimes I see the following issue in the system log.</p><div class="codebox"><pre><code>Apr  1 14:49:33 OpenWrt daemon.notice openvpn[10209]: MULTI: multi_create_instance called
Apr  1 14:49:33 OpenWrt daemon.notice openvpn[10209]: 123.123.123.123:1194 Re-using SSL/TLS context
Apr  1 14:49:33 OpenWrt daemon.notice openvpn[10209]: 123.123.123.123:1194 Control Channel MTU parms [ L:1573 D:138 EF:38 EB:0 ET:0 EL:0 ]
Apr  1 14:49:33 OpenWrt daemon.notice openvpn[10209]: 123.123.123.123:1194 Data Channel MTU parms [ L:1573 D:1450 EF:41 EB:4 ET:32 EL:0 ]
Apr  1 14:49:33 OpenWrt daemon.notice openvpn[10209]: 123.123.123.123:1194 Local Options hash (VER=V4): &#039;0ddbb6e3&#039;
Apr  1 14:49:33 OpenWrt daemon.notice openvpn[10209]: 123.123.123.123:1194 Expected Remote Options hash (VER=V4): &#039;2c50bd2c&#039;
Apr  1 14:49:33 OpenWrt daemon.notice openvpn[10209]: 123.123.123.123:1194 TLS: Initial packet from 123.123.123.123:1194, sid=f4933bca a7aaa0c9
Apr  1 14:50:33 OpenWrt daemon.err openvpn[10209]: 123.123.123.123:1194 TLS Error: TLS key negotiation failed to occur within 60 seconds (check your network connectivity)
Apr  1 14:50:33 OpenWrt daemon.err openvpn[10209]: 123.123.123.123:1194 TLS Error: TLS handshake failed
Apr  1 14:50:33 OpenWrt daemon.notice openvpn[10209]: 123.123.123.123:1194 SIGUSR1[soft,tls-error] received, client-instance restarting</code></pre></div><p>Once I also recognized this error<br /></p><div class="codebox"><pre><code>Apr  1 13:37:54 OpenWrt daemon.err openvpn[10209]: 123.123.123.123:1194 write UDPv4 []: Network is unreachable (code=128)
Apr  1 13:37:55 OpenWrt daemon.err openvpn[10209]: 123.123.123.123:1194 write UDPv4 []: Network is unreachable (code=128)</code></pre></div><p>I thougt this comes due to the reason that the router replies to the VPN request on the other WAN interface that that, where the connection is directed to.</p><p>I added a rule, that all outbound OpenVPN traffic (UDP 1194) goes through the interface where the connection arrives (I am using dyndns for one of the two WAN interfaces and use this for external connections).</p><div class="codebox"><pre><code>config &#039;multiwan&#039; &#039;config&#039;
        option &#039;resolv_conf&#039; &#039;/tmp/resolv.conf.auto&#039;
        option &#039;default_route&#039; &#039;balancer&#039;

config &#039;interface&#039; &#039;wan&#039;
        option &#039;weight&#039; &#039;5&#039;
        option &#039;health_interval&#039; &#039;10&#039;
        option &#039;timeout&#039; &#039;3&#039;
        option &#039;health_fail_retries&#039; &#039;3&#039;
        option &#039;health_recovery_retries&#039; &#039;5&#039;
        option &#039;failover_to&#039; &#039;disable&#039;
        option &#039;icmp_hosts&#039; &#039;disable&#039;

config &#039;interface&#039; &#039;wan1&#039;
        option &#039;weight&#039; &#039;5&#039;
        option &#039;health_interval&#039; &#039;10&#039;
        option &#039;timeout&#039; &#039;3&#039;
        option &#039;health_fail_retries&#039; &#039;3&#039;
        option &#039;health_recovery_retries&#039; &#039;5&#039;
        option &#039;icmp_hosts&#039; &#039;disable&#039;
        option &#039;failover_to&#039; &#039;disable&#039;

config &#039;mwanfw&#039;
        option &#039;ports&#039; &#039;1194&#039;
        option &#039;wanrule&#039; &#039;wan&#039;

config &#039;mwanfw&#039;
        option &#039;src&#039; &#039;192.168.2.250&#039;
        option &#039;ports&#039; &#039;49160&#039;
        option &#039;wanrule&#039; &#039;wan&#039;

config &#039;mwanfw&#039;
        option &#039;src&#039; &#039;192.168.2.250&#039;
        option &#039;ports&#039; &#039;49560&#039;
        option &#039;wanrule&#039; &#039;wan1&#039;</code></pre></div><p>But this does not help.</p><p>Does anybody have a hint for me?</p><p>Thanks and best regards,<br />Patrik</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105801">
				<div class="post-metadata">
					<div class="post-num">Post #46</div>
					<div class="post-author">andyballon</div>
					<div class="post-datetime">
						1 Apr 2010, 16:25					</div>
				</div>
				<div class="post-content content">
					<p>try disconnecting a internet line to rule out multiwan.<br />i got all udp packets going through wan one, (the first wan. the other one is wan2. this one has no number one but i call it wan one. <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" />)</p><p>=====<br />config &#039;mwanfw&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;proto&#039; &#039;udp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;wanrule&#039; &#039;wan&#039;<br />=====<br />and i&#039;m not having issues with multiple connections.<br />last time i saw that error i had a bad ta.key. (or i think i forgot to add the ta.key to the client config)<br />anyway, rule out multiwan then check your fw settings and configs.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105809">
				<div class="post-metadata">
					<div class="post-num">Post #47</div>
					<div class="post-author">andyballon</div>
					<div class="post-datetime">
						1 Apr 2010, 17:16					</div>
				</div>
				<div class="post-content content">
					<p>ok. i&#039;m confirming the above post #43 works.<br />i got impatient and just installed the &quot;i&quot; version and hand edited &quot;/usr/lib/lua/luci/controller/multiwan.lua&quot;</p><p>case closed on that one.<br />but pls fix it because it will scare the bejeezus out of first time installers.<br />i think backfire 10.03 is a break through of sorts because of the wireless on brcm and 2.6 kernel. plus it doesn&#039;t have the sysctl -a errors. <br />thanks for the multiwan scripts and the patch!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105828">
				<div class="post-metadata">
					<div class="post-num">Post #48</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						1 Apr 2010, 20:54					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>andyballon wrote:</cite><blockquote><p>ok. i&#039;m confirming the above post #43 works.<br />i got impatient and just installed the &quot;i&quot; version and hand edited &quot;/usr/lib/lua/luci/controller/multiwan.lua&quot;</p><p>case closed on that one.<br />but pls fix it because it will scare the bejeezus out of first time installers.<br />i think backfire 10.03 is a break through of sorts because of the wireless on brcm and 2.6 kernel. plus it doesn&#039;t have the sysctl -a errors. <br />thanks for the multiwan scripts and the patch!</p></blockquote></div><p>Updated the luci configuration module per JoW&#039;s recommendation, also qos-scripts is not required, it will however be utilized if it&#039;s installed and configured.</p><p>Thanks,<br />-Craig</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105829">
				<div class="post-metadata">
					<div class="post-num">Post #49</div>
					<div class="post-author">Dogge</div>
					<div class="post-datetime">
						1 Apr 2010, 20:57					</div>
				</div>
				<div class="post-content content">
					<p>Jow, would be cool if you and/or other core devs can give SouthPawn access to the subversion repos. So he can maintain multiwan and luci-app-multiwan in subversion directly.</p><p>I think it&#039;s ready for inclusion.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105855">
				<div class="post-metadata">
					<div class="post-num">Post #50</div>
					<div class="post-author">andyballon</div>
					<div class="post-datetime">
						2 Apr 2010, 03:18					</div>
				</div>
				<div class="post-content content">
					<p>hi southpawn,<br />sorry for the early victory post. your script needs two more tweaks. i had the impression that it was working properly because i was fiddling with routing yesterday.<br />1. the 123 table needs proto static.<br />after booting this is how the route distribution goes after about an hour:<br />--------<br />Interface wan<br />RX: 247352 Pkts. (220.10 MB)<br />TX: 175260 Pkts. (16.41 MB)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />Interface wan2<br />RX: 58 Pkts. (3.01 KB)<br />TX: 58 Pkts. (2.93 KB)<br />--------<br />if i do this:<br />ip route add default table 123 proto static nexthop via 114.108.201.1 dev eth0.1 nexthop via 202.78.96.80 dev ppp0</p><p>wan2 immediately catches up.<br />--------<br />Interface wan<br />RX: 460725 Pkts. (410.27 MB)<br />TX: 320268 Pkts. (28.08 MB)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />Interface wan2<br />RX: 26055 Pkts. (26.30 MB)<br />TX: 17740 Pkts. (1.75 MB)<br />--------</p><p><a href="http://www.ssi.bg/~ja/nano.txt">http://www.ssi.bg/~ja/nano.txt</a></p><p>2. can you make your script do the routing stuff after all interfaces are up?<br />i had two instances yesterday when i was running ppp0-less. i thought my other isp was down but it turns out the authentication took some time and multiwan ran without ppp0. status &gt; interface only showed wan and no wan2.</p><p>so, in summary <br />====<br />root@culiat-wg:~# ip route list table 123<br />202.78.96.80 dev ppp0&nbsp; proto kernel&nbsp; scope link&nbsp; src 110.55.242.76<br />192.168.1.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.1.1<br />114.108.201.0/24 dev eth0.1&nbsp; proto kernel&nbsp; scope link&nbsp; src 114.108.201.34<br />default via 114.108.201.1 dev eth0.1<br />root@culiat-wg:~# route<br />Kernel IP routing table<br />Destination&nbsp; &nbsp; &nbsp;Gateway&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Genmask&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Flags Metric Ref&nbsp; &nbsp; Use Iface<br />202.78.96.80&nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.255 UH&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 ppp0<br />192.168.1.0&nbsp; &nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 br-lan<br />114.108.201.0&nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth0.1<br />default&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;202.78.96.80&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 ppp0<br />default&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;201-GW.skybroad 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth0.1<br />root@culiat-wg:~# ip rule list<br />0:&nbsp; &nbsp; &nbsp; from all lookup local<br />10:&nbsp; &nbsp; &nbsp;from 114.108.201.34 lookup MWAN1<br />11:&nbsp; &nbsp; &nbsp;from all fwmark 0x10 lookup MWAN1<br />12:&nbsp; &nbsp; &nbsp;from all fwmark 0x11 lookup MWAN1<br />13:&nbsp; &nbsp; &nbsp;from all fwmark 0x12 lookup MWAN1<br />14:&nbsp; &nbsp; &nbsp;from all fwmark 0x13 lookup MWAN1<br />15:&nbsp; &nbsp; &nbsp;from all fwmark 0x14 lookup MWAN1<br />20:&nbsp; &nbsp; &nbsp;from 110.55.242.76 lookup MWAN2<br />21:&nbsp; &nbsp; &nbsp;from all fwmark 0x20 lookup MWAN2<br />123:&nbsp; &nbsp; from all fwmark 0x123 lookup LoadBalancer<br />32766:&nbsp; from all lookup main<br />32767:&nbsp; from all lookup default<br />root@culiat-wg:~# ip route del default table 123<br />root@culiat-wg:~# ip route add default table 123 proto static nexthop via 114.10<br />8.201.1 dev eth0.1 nexthop via 202.78.96.80 dev ppp0<br />root@culiat-wg:~# route<br />Kernel IP routing table<br />Destination&nbsp; &nbsp; &nbsp;Gateway&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Genmask&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Flags Metric Ref&nbsp; &nbsp; Use Iface<br />202.78.96.80&nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.255 UH&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 ppp0<br />192.168.1.0&nbsp; &nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 br-lan<br />114.108.201.0&nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth0.1<br />default&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;202.78.96.80&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 ppp0<br />default&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;201-GW.skybroad 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth0.1<br />root@culiat-wg:~# ip route list table 123<br />202.78.96.80 dev ppp0&nbsp; proto kernel&nbsp; scope link&nbsp; src 110.55.242.76<br />192.168.1.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.1.1<br />114.108.201.0/24 dev eth0.1&nbsp; proto kernel&nbsp; scope link&nbsp; src 114.108.201.34<br />default&nbsp; proto static<br />&nbsp; &nbsp; &nbsp; &nbsp; nexthop via 114.108.201.1&nbsp; dev eth0.1 weight 1<br />&nbsp; &nbsp; &nbsp; &nbsp; nexthop via 202.78.96.80&nbsp; dev ppp0 weight 1</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 2 of 14</div><nav><ul><li><a href="viewtopic.php%3Fid=23904&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=23904&amp;p=4.html">4</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=14.html">14</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>