<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Routed Client Mode on WZR-HP-G300NH [solution]</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 2 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p107316">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">MHOOO</div>
					<div class="post-datetime">
						19 Apr 2010, 17:08					</div>
				</div>
				<div class="post-content content">
					<p>Here is my solution for all those who want to get client mode (non bridged) to work on the WZR-HP-G300NH.<br />I&#039;m using checked out OpenWRT (trunk) from Sunday the 18. April 2010.</p><p>There seems to be a problem with the `<strong>wifi up</strong>` script, as it does not correctly parse `<strong>/etc/config/wireless</strong>`.<br />Here my `<strong>/etc/config/wireless</strong>` (mostly generated by LuCi, but modificated &#039;encryption&#039; from &#039;wpa2&#039; to &#039;wpa2+tkip&#039;):<br /></p><div class="codebox"><pre><code>config &#039;wifi-device&#039; &#039;radio0&#039;
    option &#039;type&#039; &#039;mac80211&#039;
    option &#039;macaddr&#039; &#039;00:1d:73:91:c9:81&#039;
    list &#039;ht_capab&#039; &#039;SHORT-GI-40&#039;
    list &#039;ht_capab&#039; &#039;DSSS_CCK-40&#039;
    option &#039;disabled&#039; &#039;0&#039;
    option &#039;channel&#039; &#039;auto&#039;
    option &#039;hwmode&#039; &#039;11g&#039;

config &#039;wifi-iface&#039;
    option &#039;device&#039; &#039;radio0&#039;
    option &#039;ssid&#039; &#039;&lt;your ssid&gt;&#039;
    option &#039;network&#039; &#039;wan&#039;
    option &#039;mode&#039; &#039;sta&#039;
    option &#039;encryption&#039; &#039;wpa2+tkip&#039;
    option &#039;eap_type&#039; &#039;TTLS&#039;
    option &#039;ca_cert&#039; &#039;&lt;your ca cert file&gt;&#039;
    option &#039;auth&#039; &#039;MSCHAPV2&#039;
    option &#039;identity&#039; &#039;&lt;your identity&gt;&#039;
    option &#039;password&#039; &#039;&lt;your password&gt;&#039;</code></pre></div><p>And here is my `<strong>/etc/config/network</strong>`:<br /></p><div class="codebox"><pre><code>config &#039;interface&#039; &#039;loopback&#039;
    option &#039;ifname&#039; &#039;lo&#039;
    option &#039;proto&#039; &#039;static&#039;
    option &#039;ipaddr&#039; &#039;127.0.0.1&#039;
    option &#039;netmask&#039; &#039;255.0.0.0&#039;

config &#039;interface&#039; &#039;lan&#039;
    option &#039;ifname&#039; &#039;eth0&#039;
    option &#039;type&#039; &#039;bridge&#039;
    option &#039;proto&#039; &#039;static&#039;
    option &#039;netmask&#039; &#039;255.255.255.0&#039;
    option &#039;ipaddr&#039; &#039;192.168.1.2&#039;

# the &#039;wan&#039; interface *must not* be bridged, otherwise the router is inaccessible
# you can get back in by failsafe mode
config &#039;interface&#039; &#039;wan&#039;
    option &#039;ifname&#039; &#039;eth0.1&#039; # I actually had to have this here
    option &#039;proto&#039; &#039;dhcp&#039;
    option &#039;defaultroute&#039; &#039;0&#039;
    option &#039;peerdns&#039; &#039;0&#039;

config &#039;switch&#039;
    option &#039;name&#039; &#039;rtl8366s&#039;
    option &#039;reset&#039; &#039;1&#039;
    option &#039;enable_vlan&#039; &#039;1&#039;

config &#039;switch_vlan&#039;
    option &#039;device&#039; &#039;rtl8366s&#039;
    option &#039;vlan&#039; &#039;0&#039;
    option &#039;ports&#039; &#039;0 1 2 3 5&#039;</code></pre></div><p>Once you restart the entire network with `<strong>/etc/init.d/network restart</strong>` or if you only restart the WiFi with `<strong>wifi down</strong> &amp;&amp; <strong>wifi up</strong>`, the configuration file `<strong>/etc/config/wireless</strong>` is being parsed and a a <strong>wpa_supplicant</strong> compatible configuration file is generated at /var/run/wpa_supplicant-wlan0.conf.<br />After turning wifi on with the aforementioned commands, the <strong>wpa_supplicant</strong> config file looks like this:<br /></p><div class="codebox"><pre><code>ctrl_interface=/var/run/wpa_supplicant-wlan0
network={
    scan_ssid=1
    ssid=&quot;&lt;your ssid&gt;&quot;
    
    key_mgmt=WPA-EAP
    proto=WPA2
    
    
    
    
    eap=
    ca_cert=&quot;&lt;your ca cert file&gt;&quot;
    
    
    
    
    
    
    
    
    
    
}</code></pre></div><p>Obviously, there is something wrong there. It *SHOULD* look something like this:<br /></p><div class="codebox"><pre><code>ctrl_interface=/var/run/wpa_supplicant-wlan0
network={
    scan_ssid=0
    ssid=&quot;&lt;your ssid&gt;&quot;
    key_mgmt=WPA-EAP
    proto=WPA
    eap=PEAP
    pairwise=TKIP
    group=TKIP
    identity=&quot;&lt;your identity&gt;&quot;
    password=&quot;&lt;your password&gt;&quot;
    ca_cert=&quot;&lt;your ca cert file&gt;&quot;
    phase1=&quot;peaplabel=0&quot;
    phase2=&quot;auth=MSCHAPV2&quot;
}</code></pre></div><p>Basically you have to manually create the `<strong>wpa_supplicant-wlan0.conf</strong>` file and put it inside the `<strong>/var/run</strong>` directory *after* your have activated wifi (since the file is automatically being generated whenever you activate wifi) so as to overwrite the old configuration file.<br />Then, you have to tell the <strong>wpa_supplicant</strong> to reload the new configuration file. You will need the <strong>wpa_cli</strong> tool for that. Once you have it, you can issue the command to reload the configuration file with `<strong>wpa_cli -p /var/run/wpa_supplicant-wlan0 reconfigure</strong>`.</p><p>To check whether the wpa_supplicant successfully connected, you can execute `<strong>wpa_cli -p /var/run/wpa_supplicant-wlan0 status</strong>`.</p><p>It took me 2 days to figure this out... I&#039;m kinda sucked up and can&#039;t be bothered to write a <strong>bug report</strong> (about the faulty parsing of `<strong>/etc/config/wireless</strong>`). Anyone who is keen on doing so, <strong>please do</strong>!</p><p>Kind regards,<br />MHOOO</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p111112">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">lolcatz</div>
					<div class="post-datetime">
						13 Jun 2010, 08:59					</div>
				</div>
				<div class="post-content content">
					<p>Once again, thank you so much for posting this info...</p><p>I think I&#039;m little bit lost here... in case that the AP i&#039;m trying to connect is using WEP encryption, the name of the .conf file should be something like &#039;<strong>wep_supplicant-wlan0.conf</strong>&#039; instead of &#039;<strong>wpa_supplicant-wlan0.conf</strong>&#039;?</p><p>Also, i&#039;m not a linux user... but &#039; /var/run&#039; sounds like a temporary folder that contains all the files created on the &quot;fly&quot; during the boot up of my router, &#039;<strong>wep_supplicant-wlan0.conf</strong>&#039; will be deleted and overwritten every time system starts up, and therefore i will have to &quot;fix&quot; the problem manually every time i restart the router... isn&#039;t it?</p><p>Anyways, i&#039;m not sure how to make this work on a WEP secured AP.... <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p>											<p class="post-edited">(Last edited by <strong>lolcatz</strong> on 13 Jun 2010, 10:12)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p111131">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">MHOOO</div>
					<div class="post-datetime">
						13 Jun 2010, 17:54					</div>
				</div>
				<div class="post-content content">
					<p>No, the filename should stay the same. And yeah, you will have to renew the file every time you put wifi up. This thread is kinda old though. Maybe by now you can just use luci to configure the router.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p111171">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">lolcatz</div>
					<div class="post-datetime">
						14 Jun 2010, 04:44					</div>
				</div>
				<div class="post-content content">
					<p>Actually I&#039;m using luci for almost all the basic configuration of my network....</p><br /><div class="quotebox"><cite>jow wrote:</cite><blockquote><p>Usually it is done this way:</p><p>1) navigate to network -&gt; wireless -&gt; radio0<br /> - fill out ssid, channel, key etc.<br /> - set network to wan<br /> - set mode to client</p><p>2) navigate to network -&gt; interfaces -&gt; wan<br /> - choose &quot;custom&quot; in the interface field and make it empty</p><p>3) reboot</p><p>~ JoW</p></blockquote></div><p>(<a href="https://forum.openwrt.org/viewtopic.php?pid=106061#p106061">original thread...</a>)</p><p>Following these instructions, 1st step:</p><p><span class="postimg"><img src="http://img13.imageshack.us/img13/4933/78715898.jpg" alt="http://img13.imageshack.us/img13/4933/78715898.jpg" /></span></p><p>2nd step:</p><p><span class="postimg"><img src="http://img821.imageshack.us/img821/9697/77096871.jpg" alt="http://img821.imageshack.us/img821/9697/77096871.jpg" /></span></p><br /><br /><p>The setup JoW suggested makes perfect sense. Once applied, my &quot;wan&quot; interface automatically marks wlan0 as the active device for the wan interface. Which is exactly what i want. It does even after doing the step no. 2 JoW instructed.</p><p><span class="postimg"><img src="http://img532.imageshack.us/img532/7666/53581735.jpg" alt="http://img532.imageshack.us/img532/7666/53581735.jpg" /></span></p><p>And of course, the problem here is that my router never associates with the AP....</p><p><span class="postimg"><img src="http://img88.imageshack.us/img88/7033/59939430.jpg" alt="http://img88.imageshack.us/img88/7033/59939430.jpg" /></span></p><p>This is very frustrating as the wpa_supplicant-wlan0.conf doesn&#039;t even apply in my case...&nbsp; as you can read in the first screen shot of this post, that file is associated only with the WPA encryption and the hostapd or wpa_supplicant packages...</p><p>Any ideas?.</p>											<p class="post-edited">(Last edited by <strong>lolcatz</strong> on 14 Jun 2010, 09:25)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p111360">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">MHOOO</div>
					<div class="post-datetime">
						17 Jun 2010, 09:00					</div>
				</div>
				<div class="post-content content">
					<p>Connect to your router via cable, log-in using telnet/ssh and type:<br />`wifi`</p><p>this will restart wifi. *Post the output* of the command. Maybe it has some useful information. From what I understand wpa_supplicant-XXXX.conf only really yield configuration options for the wpa_supplicant: which is a program necessary for any encryption stuff.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p111571">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">lolcatz</div>
					<div class="post-datetime">
						20 Jun 2010, 02:35					</div>
				</div>
				<div class="post-content content">
					<p>`wifi`</p><p>doesn&#039;t give any output... the cmd line just jump and waits for another command... <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>the router doesn&#039;t do anything.</p>											<p class="post-edited">(Last edited by <strong>lolcatz</strong> on 20 Jun 2010, 02:42)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>