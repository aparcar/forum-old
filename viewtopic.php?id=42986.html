<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Firewall Configuration help - OpenWRT Trunk</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 5 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p195377">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">andrea.mnt</div>
					<div class="post-datetime">
						19 Mar 2013, 11:01					</div>
				</div>
				<div class="post-content content">
					<p>Hi,<br />I&#039;ve installed OpenWRT on my cisco wrt160nl and I&#039;m amazed!<br />I&#039;m just having hard times to properly confiugure the firewall on openwrt router.</p><p>Network Configuration:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;192.168.1.64<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __________&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;__________<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;¦&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;¦lan&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wan¦&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ¦<br />--- adsl ----------- ¦&nbsp; &nbsp; router 1&nbsp; ¦ -----------------------¦ wrt160nl&nbsp; &nbsp; &nbsp;¦<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;¦_________¦&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ¦&nbsp; openwrt&nbsp; &nbsp; &nbsp;¦<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;¦lan: 192.168.1.254&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ¦__________¦<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;¦&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ¦ lan: 192.168.2.x <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;¦&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ¦<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;_____¦____&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _____¦____<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;¦&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;¦&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ¦&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;¦<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;¦&nbsp; client&nbsp; &nbsp; &nbsp; &nbsp;¦&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ¦&nbsp; &nbsp;client&nbsp; &nbsp; &nbsp;¦&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;¦&nbsp; &nbsp; &nbsp;A&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ¦&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ¦&nbsp; &nbsp; &nbsp;B&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ¦<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;¦________¦&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;¦________¦<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;192.168.1.75&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 192.168.2.x</p><br /><p>Client A and B can ping each other but client A can&#039;t connect to SMB share at IP: 192.168.2.1.<br />I can&#039;t either SSH openwrt machine from client A.</p><p>I would like to configure the openwrt firewall to accept all traffic from A to 192.168.2.x</p><p>Everything works if I change (/etc/config/firewall) the wan zone in the following way:</p><p>config zone<br />&nbsp; &nbsp; option name &nbsp; &nbsp; wan<br />&nbsp; &nbsp; option input &nbsp; &nbsp; ACCEPT&nbsp; #instead of REJECT - default conf.<br />&nbsp; &nbsp; ....</p><p>without creating any additional rules.</p><p>If I keep the wan zone default configuration and create a specific rule like this one it doesn&#039;t work:</p><p># standard wan<br />config zone<br />&nbsp; &nbsp; &nbsp; &nbsp; option name&nbsp; &nbsp; &nbsp; &nbsp; wan<br />&nbsp; &nbsp; option network&nbsp; &nbsp; &#039;wan&#039;<br />&nbsp; &nbsp; option input&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;REJECT<br />&nbsp; &nbsp; &nbsp; &nbsp; option output&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACCEPT<br />&nbsp; &nbsp; option forward&nbsp; &nbsp; &nbsp; &nbsp; REJECT<br />&nbsp; &nbsp; &nbsp; &nbsp; option masq&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; 1<br />&nbsp; &nbsp; &nbsp; &nbsp; option mtu_fix&nbsp; &nbsp; &nbsp; &nbsp; 1</p><p>#new rule<br />config rule<br />&nbsp; &nbsp; option name&nbsp; &nbsp; &nbsp; &nbsp; allow_client_A<br />&nbsp; &nbsp; option src&nbsp; &nbsp; &nbsp; &nbsp; wan<br />&nbsp; &nbsp; option src_ip&nbsp; &nbsp; &nbsp; &nbsp; 192.168.1.75<br />&nbsp; &nbsp; option dest&nbsp; &nbsp; &nbsp; &nbsp; lan<br />&nbsp; &nbsp; option proto&nbsp; &nbsp; &nbsp; &nbsp; all<br />&nbsp; &nbsp; option target&nbsp; &nbsp; &nbsp; &nbsp; ACCEPT</p><br /><p>What am I doing wrong???<br />Thanks in advance,<br />Andrea</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p195430">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">vhrm</div>
					<div class="post-datetime">
						19 Mar 2013, 20:54					</div>
				</div>
				<div class="post-content content">
					<p>Hmm... not sure what you&#039;re doing wrong, but i&#039;m confused.</p><p>1) did you set up some routing on &quot;router 1&quot; or&nbsp; on &quot;A&quot; ?&nbsp; &nbsp; Otherwise how can&nbsp; A ping B ? (i.e. how does it know to get to B through 192.168.1.64 ?)</p><p>2) B pinging A&nbsp; could work because of NAT on&nbsp; the wrt160nl&nbsp; &nbsp;so that kind of makes sense.</p><p>I&#039;m also somewhat surprised that things &quot;work&quot; if you change the wan INPUT to accept since there&#039;s no forwarding rule in the&nbsp; wan -&gt; lan direction. hmm..</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p195433">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">jeffster</div>
					<div class="post-datetime">
						19 Mar 2013, 21:24					</div>
				</div>
				<div class="post-content content">
					<p>Does &quot;Router 1&quot; know that traffic to 192.168.2.0/24 should be routed via 192.168.1.64?</p><p>tcpdump is your friend when it comes to diagnosing this kind of thing. Make sure the packets are even getting to the firewall that you think may be misconfigured.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p195440">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">andrea.mnt</div>
					<div class="post-datetime">
						19 Mar 2013, 23:57					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for the reply!</p><p>The router 1 is provided by my ISP and doesn&#039;t allow static IP routes.<br />I solved this configuring the route on clients (A, in this case) with the following command (on windows 7):</p><p>route ADD 192.168.2.0 MASK 255.255.255.0 192.168.1.64</p><p>and this is why I&#039;m able to route the traffic to 192.168.1.64. (openwrt)</p><p>Since the icmp protocol is enabled by default in OpenWRT configuration, in order to be able to ping the client B (from A) I&#039;ve <br />added the wan --&gt; lan forwarding option in /etc/config/firewall:</p><p>config forwarding<br />&nbsp; &nbsp; option src&nbsp; &nbsp; &nbsp; &nbsp; wan&nbsp; &nbsp; <br />&nbsp; &nbsp; option dest&nbsp; &nbsp; lan</p><p>Anyway, I solved the problem adding the following iptables rule to the zone_wan_src_REJECT chain:</p><p>iptables -t filter -I zone_wan_src_REJECT 1 -j ACCEPT -s 192.168.1.1/24</p><p>I used the -I option to make this rule on top of the list.</p><p>iptables -I output:<br />............<br />...........<br />Chain zone_wan_src_REJECT (1 references)<br />target&nbsp; &nbsp; &nbsp;prot opt source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination<br />ACCEPT&nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; 192.168.1.0/24&nbsp; &nbsp; &nbsp; &nbsp;anywhere<br />reject&nbsp; &nbsp; &nbsp; &nbsp; all&nbsp; --&nbsp; anywhere&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;anywhere<br />...........</p><p>Now everything works!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p195442">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">zzz2002</div>
					<div class="post-datetime">
						20 Mar 2013, 00:08					</div>
				</div>
				<div class="post-content content">
					<p>Why is client A connected to router1?<br />Can router1 be configured in &quot;bridge mode&quot;?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p195445">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">andrea.mnt</div>
					<div class="post-datetime">
						20 Mar 2013, 00:36					</div>
				</div>
				<div class="post-content content">
					<p>This is an unsual network configuration, I know <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />Two routers are in different locations and Client A is close to router 1 which (unfortunately) cannot be configured as bridge.</p><p>The openWRT router was initially configured as a bridge but in this way I wasn&#039;t able to get &quot;Transmission BT&quot; working since it listens to the WAN port which is disconnected in this configuration.</p><p>(By the way if someone is able to get transmission listen to LAN port please let me know)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p195508">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">zzz2002</div>
					<div class="post-datetime">
						20 Mar 2013, 17:58					</div>
				</div>
				<div class="post-content content">
					<p>how much control do you have over router 1.<br />Can you add routing, etc.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p195651">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">digital</div>
					<div class="post-datetime">
						22 Mar 2013, 03:41					</div>
				</div>
				<div class="post-content content">
					<p>@andrea.mnt: There are other clients connected to openwrt? if not, why don&#039;t you bridge openwrt wan port with client B port? this way both ports will &quot;see&quot; the same network, so client B will be in 192.168.1.X network... Am I wrong?</p><p>I mean...<br />Openwrt will not see client B as a client. Client B will use openwrt as a bridge AND Transmission will continue to see a &quot;wan&quot; interface... no?</p>											<p class="post-edited">(Last edited by <strong>digital</strong> on 22 Mar 2013, 03:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p195652">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">brontide</div>
					<div class="post-datetime">
						22 Mar 2013, 03:50					</div>
				</div>
				<div class="post-content content">
					<p>Funny enough I just did this today.&nbsp; Esentially you make all 5 ports the &quot;wan&quot; ( you can do this with the wifi as well, but I havn&#039;t yet ).&nbsp; One big happy bridge.</p><p>1) disable the firewall /etc/init.d/firewall disable<br />2) change the wan to type &quot;bridge&#039; and make the ifname to &quot;eth0 eth1&quot; <br />3) disable the lan<br />WARNING, get 2 or 3 wrong and you will have to go back to failsafe or a tftp reload, so make sure it&#039;s right before rebooting.</p><p>reboot and hope it comes back up.&nbsp; It then becomes a switch with your 160nl hanging off if it running openwrt.&nbsp; I do this so that I can connect 100mbps equipment in my entertainment rack and run a shairport service without another subnet to worry about.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p195654">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">brontide</div>
					<div class="post-datetime">
						22 Mar 2013, 03:52					</div>
				</div>
				<div class="post-content content">
					<div class="codebox"><pre><code>config interface &#039;loopback&#039;
    option ifname &#039;lo&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;127.0.0.1&#039;
    option netmask &#039;255.0.0.0&#039;

#config interface &#039;lan&#039;
#    option ifname &#039;eth0&#039;
#    option type &#039;bridge&#039;
#    option proto &#039;static&#039;
#    option ipaddr &#039;192.168.1.1&#039;
#    option netmask &#039;255.255.255.0&#039;
#    option ip6assign &#039;64&#039;

config interface &#039;wan&#039;
    option ifname &#039;eth1 eth0&#039;
    option type &#039;bridge&#039;
    option proto &#039;dhcp&#039;
    option ipv6 &#039;1&#039;

config switch
    option name &#039;switch0&#039;
    option reset &#039;1&#039;
    option enable_vlan &#039;1&#039;

config switch_vlan
    option device &#039;switch0&#039;
    option vlan &#039;1&#039;
    option ports &#039;0 1 2 3 4 5&#039;

config globals &#039;globals&#039;
    option ula_prefix &#039;auto&#039;

#config interface &#039;wan6&#039;
#    option proto &#039;dhcpv6&#039;
#    option ifname &#039;@wan&#039;</code></pre></div>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>