<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> adblock package, release 2.x</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 22 Mar 2018 and 4 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 17</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=59803&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=59803&amp;p=3.html">3</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=59803&amp;p=17.html">17</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p292885">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">dibdot</div>
					<div class="post-datetime">
						21 Sep 2015, 23:34					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>in openwrt package trunk you&#039;ll find an updated adblock package (plus LuCI companion/configuration package).</p><p><strong>release 2.0.x</strong><br /></p><ul><li><p>support of 21 domain blacklist sites</p></li><li><p>zero-conf like automatic installation &amp; setup</p></li><li><p>simple but yet powerful adblock engine: adblock does not use error prone external iptables rulesets, http pixel server instances and things like that</p></li><li><p>full IPv4 and IPv6 support</p></li><li><p>supports a wide range of router modes, even AP modes are supported</p></li><li><p>support different download tools like wget (default), aria2c, uclient-fetch, curl</p></li><li><p>each blocklist source will be updated and processed separately</p></li><li><p>overall duplicate removal in separate adblock lists</p></li><li><p>adblock source list parsing by fast &amp; flexible regex rulesets</p></li><li><p>additional white- and blacklist support for manual overrides</p></li><li><p>quality checks during &amp; after update of adblock lists to ensure a reliable dnsmasq service</p></li><li><p>procd based init system support (start/stop/restart/reload/suspend/resume)</p></li><li><p>procd based hotplug support, the adblock start will be triggered by interface triggers</p></li><li><p>suspend &amp; resume adblock actions temporarily without block list reloading</p></li><li><p>query function to quickly identify blocked (sub-)domains, i.e. for whitelisting</p></li><li><p>automatic block list backup &amp; restore, backups will be (de-)compressed and restored on the fly</p></li><li><p>add new adblock sources on your own via uci config</p></li><li><p>LuCI configuration frontend (provided by hnyman)</p></li></ul><p><strong>update 2.1.x</strong><br /></p><ul><li><p>add initial unbound support (experimental, see online doc)</p></li><li><p>automatically switch between wget &amp; uclient-fetch</p></li></ul><p><strong>update 2.3.x</strong><br /></p><ul><li><p>automatically selects dnsmasq or unbound as dns backend</p></li><li><p>add the new &#039;adguard&#039; source, a combined/quite effective block list</p></li><li><p>many improvements &amp; fixes</p></li></ul><p><strong>update 2.4.x</strong><br /></p><ul><li><p>add tld compression (&quot;top level domain compression&quot;)</p></li></ul><p>The new &quot;top level domain compression&quot; removes up to 40 thousand needless host entries from the block lists and lowers the memory footprint for the dns backends by 8-10 MByte.</p><p>For Designated Driver and Chaos Calmer package installation details, please check the documentation link below!<br />A big &#039;thank you&#039; to all beta testers and a special one to Hannu Nyman for his great adblock LuCI frontend! </p><p>Have fun!<br />Dirk</p><p><strong>Link to the latest <a href="https://github.com/openwrt/packages/blob/master/net/adblock/files/README.md">adblock documentation</a></strong></p>											<p class="post-edited">(Last edited by <strong>dibdot</strong> on 3 Mar 2017, 19:45)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p293438">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">dibdot</div>
					<div class="post-datetime">
						25 Sep 2015, 15:20					</div>
				</div>
				<div class="post-content content">
					<p>Script and documentation has been updated. It&#039;s tested against trunk only (min. version r47025). Prerequisites will be checked automatically during script start. If all goes well, it will be look like this excerpt:</p><div class="codebox"><pre><code>root@pi2wrt:/usr/bin# logread -e &quot;adblock&quot;
Fri Sep 25 14:12:39 2015 user.notice adblock[3295]: start adblock processing (0.9.10pre)
Fri Sep 25 14:12:39 2015 user.notice adblock[3295]: environment check finished
Fri Sep 25 14:12:39 2015 user.notice adblock[3295]: get wan/update interface: wlan1, after 0 loops
Fri Sep 25 14:13:32 2015 user.notice adblock[3295]: get ntp time sync: 0.openwrt.pool.ntp.org, after 1 loops
Fri Sep 25 14:13:38 2015 user.notice adblock[3295]: shallalist archive download finished
Fri Sep 25 14:13:42 2015 user.notice adblock[3295]: shallalist archive extraction finished
Fri Sep 25 14:13:42 2015 user.notice adblock[3295]: shallalist (pre-)processing finished (adv costtraps downloads spyware tracker warez)
Fri Sep 25 14:13:42 2015 user.notice adblock[3295]: source download finished (http://pgl.yoyo.org/adservers/serverlist.php?hostformat=one-line&amp;showintro=0&amp;mimetype=plaintext, 2422 entries)
Fri Sep 25 14:13:44 2015 user.notice adblock[3295]: source download finished (http://mirror1.malwaredomains.com/files/justdomains, 10826 entries)
Fri Sep 25 14:13:50 2015 user.notice adblock[3295]: source download finished (https://zeustracker.abuse.ch/blocklist.php?download=domainblocklist, 521 entries)
Fri Sep 25 14:13:57 2015 user.notice adblock[3295]: source download finished (https://feodotracker.abuse.ch/blocklist/?download=domainblocklist, 0 entries)
Fri Sep 25 14:14:03 2015 user.notice adblock[3295]: source download finished (https://palevotracker.abuse.ch/blocklists.php?download=domainblocklist, 12 entries)
Fri Sep 25 14:14:05 2015 user.notice adblock[3295]: source download finished (http://www.dshield.org/feeds/suspiciousdomains_Low.txt, 4542 entries)
Fri Sep 25 14:14:05 2015 user.notice adblock[3295]: source download finished (file:////mnt/sda1/adblock/adblock.blacklist, 3 entries)
Fri Sep 25 14:14:07 2015 user.notice adblock[3295]: source download finished (file:////tmp/tmp.cIKpEp/shallalist.txt, 36901 entries)
Fri Sep 25 14:14:20 2015 user.notice adblock[3295]: new block list with 52109 domains loaded, backup generated
Fri Sep 25 14:14:21 2015 user.notice adblock[3295]: finish domain adblock processing (0.9.10pre)</code></pre></div><p>Have fun!<br />Dirk</p>											<p class="post-edited">(Last edited by <strong>dibdot</strong> on 25 Sep 2015, 15:22)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p293452">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						25 Sep 2015, 17:51					</div>
				</div>
				<div class="post-content content">
					<p>The release base of R47025 is for DD Trunk.&nbsp; Do you plan to test this on the CC Final which I believe is this:<br />CC 15.05 Final&nbsp; &nbsp;R46767&nbsp; &nbsp; &nbsp; 2015 September 10<br /><a href="https://forum.openwrt.org/viewtopic.php?id=59548">https://forum.openwrt.org/viewtopic.php?id=59548</a></p><p>Regarding the prerequisites, I have a PC_ENGINES ALIX with 256MB memory and what ever size CF card I need.&nbsp; Do I still need the external USB drive, or can this work in the available memory.&nbsp; Alternatively, can I add sdx3 to my CF card and use this?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p293458">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">dibdot</div>
					<div class="post-datetime">
						25 Sep 2015, 19:01					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ve pushed 0.9.10 few minutes ago. Please take this version for tests with CC - it includes wget support for https sites (see openwrt ticket #19621 for details). In the script change the environment block to your needs, regarding CC support and space requirements you should check (space in kilobytes).</p><div class="codebox"><pre><code># minimal values for environment checks
#
min_release=47025
min_adb_space=100000
min_tmp_space=80000</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p293460">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						25 Sep 2015, 19:11					</div>
				</div>
				<div class="post-content content">
					<p>Under which menu will I find this package?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p293461">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">dibdot</div>
					<div class="post-datetime">
						25 Sep 2015, 19:14					</div>
				</div>
				<div class="post-content content">
					<p>please check git link in the first post</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p293692">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">dibdot</div>
					<div class="post-datetime">
						27 Sep 2015, 19:58					</div>
				</div>
				<div class="post-content content">
					<p>new pre-release 0.9.11 available, with the following changes:</p><p>* add support for two new blacklist sites (spam404.com &amp; winhelp.mvps2002.org)<br />* add support for multiple ntp pools<br />* fix minor domain query glitches<br />* updated documentation</p><p>Have fun!<br />Dirk</p><br /><p>Edit: Removed link to private git repo, cause package is now in trunk.</p>											<p class="post-edited">(Last edited by <strong>dibdot</strong> on 15 Nov 2015, 17:30)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p293694">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						27 Sep 2015, 20:24					</div>
				</div>
				<div class="post-content content">
					<p>Sorry, I can&#039;t test until the package is ready packaged for OpenWRT.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297775">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">dibdot</div>
					<div class="post-datetime">
						28 Oct 2015, 21:04					</div>
				</div>
				<div class="post-content content">
					<p>The new adblock package for openwrt (network/adblock) is now in trunk and ready for use. It will take a couple days for the package to get built by the buildbots, but it can be compiled now.</p><p>Feel free to test, ask questions or make suggestions.</p><p>Have fun!<br />Dirk</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297798">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						29 Oct 2015, 02:17					</div>
				</div>
				<div class="post-content content">
					<p>Grabbed a zip from the link above and looked at the code/configs. Quite a few of the blacklist URLs in the config are 404/not available.</p><p>Made me wonder how thoroughly was it tested before being published.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297809">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">dibdot</div>
					<div class="post-datetime">
						29 Oct 2015, 06:48					</div>
				</div>
				<div class="post-content content">
					<p>@stangri: which urls not working? <br />Just a rough guess: you didn&#039;t remove the &quot;&amp;ruleset=...&quot; part during local testing in your browser!?</p><div class="codebox"><pre><code>Thu Oct 29 05:40:55 2015 user.notice adblock[7693]: domain adblock processing started (0.11.0)
Thu Oct 29 05:40:55 2015 user.notice adblock[7693]: wan update check will be disabled
Thu Oct 29 05:40:55 2015 user.notice adblock[7693]: backup/restore will be disabled
Thu Oct 29 05:40:55 2015 user.notice adblock[7693]: error logging will be disabled
Thu Oct 29 05:40:55 2015 user.notice adblock[7693]: dns query logging will be disabled
Thu Oct 29 05:41:06 2015 user.notice adblock[7693]: get ntp time sync (ntp0.fau.de ntp1.fau.de ntp2.fau.de ntp3.fau.de), after 0 loops
Thu Oct 29 05:41:33 2015 user.notice adblock[7693]: shallalist archive download finished
Thu Oct 29 05:41:36 2015 user.notice adblock[7693]: shallalist archive extraction finished
Thu Oct 29 05:41:36 2015 user.notice adblock[7693]: shallalist (pre-)processing finished (adv costtraps downloads spyware tracker warez)
Thu Oct 29 05:41:37 2015 user.notice adblock[7693]: source download finished (http://pgl.yoyo.org/adservers/serverlist.php?hostformat=one-line&amp;showintro=0&amp;mimetype=plaintext, 2430 entries)
Thu Oct 29 05:41:40 2015 user.notice adblock[7693]: source download finished (http://mirror1.malwaredomains.com/files/justdomains, 12946 entries)
Thu Oct 29 05:41:41 2015 user.notice adblock[7693]: source download finished (https://zeustracker.abuse.ch/blocklist.php?download=domainblocklist, 550 entries)
Thu Oct 29 05:41:44 2015 user.notice adblock[7693]: source download finished (https://feodotracker.abuse.ch/blocklist/?download=domainblocklist, 0 entries)
Thu Oct 29 05:41:46 2015 user.notice adblock[7693]: source download finished (https://palevotracker.abuse.ch/blocklists.php?download=domainblocklist, 11 entries)
Thu Oct 29 05:41:48 2015 user.notice adblock[7693]: source download finished (http://www.dshield.org/feeds/suspiciousdomains_Low.txt, 4542 entries)
Thu Oct 29 05:41:51 2015 user.notice adblock[7693]: source download finished (file:////tmp/tmp.fJaacL/shallalist.txt, 36937 entries)
Thu Oct 29 05:41:52 2015 user.notice adblock[7693]: source download finished (http://spam404bl.com/spam404scamlist.txt, 5189 entries)
Thu Oct 29 05:41:59 2015 user.notice adblock[7693]: source download finished (http://winhelp2002.mvps.org/hosts.txt, 13852 entries)
Thu Oct 29 05:41:59 2015 user.notice adblock[7693]: source download finished (file:///etc/adblock/adblock.blacklist, 1 entries)
Thu Oct 29 05:42:15 2015 user.notice adblock[7693]: new block list with 71167 domains loaded
Thu Oct 29 05:42:15 2015 user.notice adblock[7693]: domain adblock processing finished (0.11.0)</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297811">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						29 Oct 2015, 08:37					</div>
				</div>
				<div class="post-content content">
					<p>You&#039;re right, I didn&#039;t! Now that I did all the URLs in your list are working with a browser.</p><p>Thanks!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p299898">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">dibdot</div>
					<div class="post-datetime">
						15 Nov 2015, 17:36					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>new release 0.20.2 is in trunk:</p><p>* add uci support<br />* add dynamic uhttpd instance support (no longer rely on uhttpd config changes)<br />* bugfix: busybox &quot;tr&quot; does not support character classes by default and generates (partly) odd domain names.<br />* fix for possible query log config change (enabled =&gt; disabled)</p><p>Next to come ...</p><p>* bugfixes<br />* LUCI gui</p><p>Have fun!<br />Dirk</p><p>Please note: If you&#039;ve already tested an older release before, please remove adblock uhttp config changes (/etc/uhttpd) manually.</p>											<p class="post-edited">(Last edited by <strong>dibdot</strong> on 15 Nov 2015, 17:39)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300566">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						20 Nov 2015, 15:43					</div>
				</div>
				<div class="post-content content">
					<p>@dibdot</p><p>Could you clarify the config examples and README.md a bit especially regarding the network config options, as your examples do not really give much info about the actual goals. (There are so many router models that e.g. the default interface names and number vary a lot.)</p><p>Some questions about the model config:<br />- adb_ip &quot;192.168.2.1&quot; needs to be from a different different subnet than the normal LAN (typically 192.168.1.x). Right?<br />- To which interface does adb_dev &quot;eth0&quot; relate? wan, lan or something else/unused? E.g. I have by default lan as eth0.1 and wan as eth1. Should it be eth0.1 for me?<br />- How should adb_domain be selected? some common domain in local country?</p><br /><p>Some feedback:<br />* I don&#039;t understand the need for ntp functionality. Openwrt already has normally ntp embedded in busybox, so having ntp launched here looks unnecessary.<br />* The minimum diskspace requirement 100 MB looks quite large. Probably some 95% of users have less RAM (and thus for ramdisk).</p>											<p class="post-edited">(Last edited by <strong>hnyman</strong> on 20 Nov 2015, 15:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300588">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">dibdot</div>
					<div class="post-datetime">
						20 Nov 2015, 17:13					</div>
				</div>
				<div class="post-content content">
					<p>@hnyman</p><p>Currently I&#039;ll prepare next release 0.21.0 with better documentation ...</p><p><strong>adb_ip</strong>: needs to be a different subnet from the normal LAN, it&#039;s used by the adblock network interface and uhttpd instance.<br /><strong>adb_dev</strong>: should point to the default lan interface (check /sys/class/net/...), in your case I would suggest to use eth0.1. <br /><strong>adb_domain</strong>: this domain will be used for the final nslookup check (after dnsmasq reload with the newly generated blacklist). It should be an &quot;always accessible&quot; domain and it must not point to your adb_ip during nslookup check. The newly generated blacklist will be discarded, if this check failed.<br /><strong>adb_minspace</strong>: sorry, clearly a typo ... I&#039;ve reduced this to 15MB in the default config.</p><p>The ntp check is only required for additional logfile logging (by default the script only logs to syslog fifo), to make sure to log the right date &amp; time and for logfile housekeeping (delete logfiles older than n days, see adb_queryhistory).</p><p>Thanks<br />Dirk</p><div class="quotebox"><cite>hnyman wrote:</cite><blockquote><p>@dibdot</p><p>Could you clarify the config examples and README.md a bit especially regarding the network config options, as your examples do not really give much info about the actual goals. (There are so many router models that e.g. the default interface names and number vary a lot.)</p><p>Some questions about the model config:<br />- adb_ip &quot;192.168.2.1&quot; needs to be from a different different subnet than the normal LAN (typically 192.168.1.x). Right?<br />- To which interface does adb_dev &quot;eth0&quot; relate? wan, lan or something else/unused? E.g. I have by default lan as eth0.1 and wan as eth1. Should it be eth0.1 for me?<br />- How should adb_domain be selected? some common domain in local country?</p><br /><p>Some feedback:<br />* I don&#039;t understand the need for ntp functionality. Openwrt already has normally ntp embedded in busybox, so having ntp launched here looks unnecessary.<br />* The minimum diskspace requirement 100 MB looks quite large. Probably some 95% of users have less RAM (and thus for ramdisk).</p></blockquote></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300607">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						20 Nov 2015, 20:29					</div>
				</div>
				<div class="post-content content">
					<p>So far I have not been able to got it to work. Two error messages pop up when starting the script. It gets partially initialised, so that dns probably works ok while the web server does not start ok. <br />...<br />EDIT <br />the error message is coming from the uhttpd startup. Interestingly, &quot;ifstatus adblock&quot; shows the new &quot;adblock&quot;, but old &quot;ifconfig&quot; does not show it. Is that expected?</p>											<p class="post-edited">(Last edited by <strong>hnyman</strong> on 29 Feb 2016, 11:18)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300610">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">dibdot</div>
					<div class="post-datetime">
						20 Nov 2015, 20:49					</div>
				</div>
				<div class="post-content content">
					<p>@hnyman</p><p>By default, uHTTPd is bind to 0.0.0.0 (all ports, which also includes the WAN port of your router. To bind uHTTPd to the standard LAN port only you have to change the listen_http and listen_https options to your LAN IP address.</p><div class="quotebox"><blockquote><p>config uhttpd &#039;main&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list listen_http &#039;192.168.1.1:80&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list listen_https &#039;192.168.1.1:443&#039;</p></blockquote></div><p>After that change try it again please.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300612">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						20 Nov 2015, 21:06					</div>
				</div>
				<div class="post-content content">
					<p>Looks like that helped. I haven&#039;t yet tested widely, but now there are two uhttpd processes.<br />And trying a few blocked sites in web browser does not lead into LuCI anymore. Looks good so far.</p>											<p class="post-edited">(Last edited by <strong>hnyman</strong> on 29 Feb 2016, 11:18)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300613">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">dibdot</div>
					<div class="post-datetime">
						20 Nov 2015, 21:35					</div>
				</div>
				<div class="post-content content">
					<p>The port 80 definition should be sufficient. All ad related http traffic will be redirected to the adblock interface, for &quot;https only&quot; sites like facebook you&#039;ll get an &quot;not found&quot; - no timeouts (it&#039;s not possible to &quot;fake&quot; certificates for adblock purposes).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300685">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">roger_</div>
					<div class="post-datetime">
						21 Nov 2015, 18:59					</div>
				</div>
				<div class="post-content content">
					<p>Is option adb_minspace &quot;20000&quot; for root? Seems like most devices wouldn&#039;t have nearly 20 MB free/total storage. If so, what&#039;s the best way to use /tmp?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300717">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						21 Nov 2015, 22:01					</div>
				</div>
				<div class="post-content content">
					<p>Looks like that diskspace or actually free RAM is a really critical thing:</p><p>I can download all other domain lists except &quot;shallalist&quot;. Trying to download just the shallalist (with current default selections) kills my router, as the memory/disk space requirement grows to over 30 MB at some point and the router dies</p><p>If I activate all other feeds, the resulting file is about 1.6 MB. So that is much.</p><p>But the critical thing is actually memory consumption during the update process.</p><p>Looking with ps (or htop) shows that &quot;sort -u&quot; command requires ~27 MB RAM at the peak:<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# ps -w | grep sort
 6031 root     26652 R    sort -u
 6052 root      1192 S    grep sort

root@OpenWrt:~# which sort
/usr/bin/sort

root@OpenWrt:~# ls -l /usr/bin/sort
lrwxrwxrwx    1 root     root            17 Nov 21 11:47 /usr/bin/sort -&gt; ../../bin/busybox</code></pre></div><p>That might be due to weak &quot;sort&quot; implementation in busybox. Or something.</p><p>But that might form a problem for many users, as quite many routers have less RAM than mine (64 MB).</p><p>EDIT:<br />I installed GNU sort (package &quot;coreutils-sort&quot;) and the peak memory consumption dropped to 4.4 MB ;-)</p><p>(But shallalist seems to take too much diskspace or RAM already before sort, so that does not work even then.)</p>											<p class="post-edited">(Last edited by <strong>hnyman</strong> on 21 Nov 2015, 22:12)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300727">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">dibdot</div>
					<div class="post-datetime">
						21 Nov 2015, 23:17					</div>
				</div>
				<div class="post-content content">
					<p>@roger_/hnyman: for best results please resize your tmp partition to 256MB. You&#039;ll find an example configuration in /etc/adblock/samples/rc.local.sample.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300728">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						21 Nov 2015, 23:26					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dibdot wrote:</cite><blockquote><p>@roger_/hnyman: for best results please resize your tmp partition to 256MB. You&#039;ll find an example configuration in /etc/adblock/samples/rc.local.sample.</p></blockquote></div><p>Yes, that is naturally possible, but that requires attaching a storage device to the router to have real effect on disk space. </p><p>And based on my debugging, it is not about disk space (in /tmp), but about actual RAM used by the process:<br /></p><div class="codebox"><pre><code>[ 3798.533895] Out of memory: Kill process 9406 (sort) score 408 or sacrifice child
[ 3798.541500] Killed process 9406 (sort) total-vm:26728kB, anon-rss:25572kB, file-rss:0kB</code></pre></div><p>EDIT:<br />I tested the mount command in samples to lie about the tmpfs size. That brought no help, although &quot;df&quot; now claims /tmp size to be 256 MB.<br />Still the actual RAM gets consumed and router does oom:<br /></p><div class="codebox"><pre><code>[ 4692.225439] Out of memory: Kill process 10212 (sort) score 408 or sacrifice child
[ 4692.233489] Killed process 10212 (sort) total-vm:26604kB, anon-rss:25448kB, file-rss:104kB</code></pre></div>											<p class="post-edited">(Last edited by <strong>hnyman</strong> on 21 Nov 2015, 23:39)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300730">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">dibdot</div>
					<div class="post-datetime">
						21 Nov 2015, 23:57					</div>
				</div>
				<div class="post-content content">
					<p>@hnyman: which router model did you use for testing? Maybe your router is to weak for shallalist processing ... I&#039;ve tested the script with all sources successfully on wdr4300, wdr4900, dir-835 and a raspi2. All routers have at least 128MB ram ...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300733">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						22 Nov 2015, 00:36					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dibdot wrote:</cite><blockquote><p>@hnyman: which router model did you use for testing? Maybe your router is to weak for shallalist processing ... I&#039;ve tested the script with all sources successfully on wdr4300, wdr4900, dir-835 and a raspi2. All routers have at least 128MB ram ...</p></blockquote></div><p>Today I used with WNDR3700v2 that has 64 MB RAM and is capable of running ~90 Mbit/s traffic with QoS enabled. Yesterday I was using WNDR3800 with 128 MB RAM, otherwise similar.</p><p>The router itself is capable of running adblock itself just nicely, but the &#039;sort&#039; utility from busybox seems to choke with ~41000 lines to be sorted (other lists without shallalist). Memory consumption explodes for a few seconds to 26-27 MB, which I do not understand at all. The list itself is just 1.5 MB or so, so there should be no need to that kind of memory consumption. </p><p>Like I said, installing GNU sort (coreutils-sort package) helps. It takes only some 4.5 MB RAM at the peak.</p><p>The problem is not due to your script itself, but merely the RAM consumption by the commands it runs.<br />I edited the script, and saved the downloaded blocklist input to a file and tried to sort that. The same 26+ MB. So, it is not even about running too many piped things.</p><p>In the Openwrt router database, ~40 routers and ~40 computer boards out of total 488 have 128+ MB RAM. Probably the majority of Openwrt users use something with only 32-64 MB RAM.</p><p>You might maybe mention in the notes/guide something about &quot;high memory consumption at the update phase if all blocklists are enabled&quot;, so that users will not run into unexpected problems if they try to download all the lists. One can easily avoid the problem by either downloading only one of the two large lists (malwaredomains &amp; winhelp) or by installing GNU sort utility. (And of course, if the router has 128+ MB RAM, there is likely no problem at any phase.)&nbsp; My point is merely to decrease the user frustration by providing them info about the expected resource consumption and possible mitigations (do not download all lists, install GNU sort).</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 17</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=59803&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=59803&amp;p=3.html">3</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=59803&amp;p=17.html">17</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0.001 -->

</body>
</html>