<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Fair nat</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 4 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p61132">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">belrpr</div>
					<div class="post-datetime">
						2 Jan 2008, 14:55					</div>
				</div>
				<div class="post-content content">
					<p>Anyone has a good tutorial on how to implement fair nat?<br />Basicly I want my children to have to share the use of the internet.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p63814">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">belrpr</div>
					<div class="post-datetime">
						21 Feb 2008, 14:52					</div>
				</div>
				<div class="post-content content">
					<p>anyone,</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p63839">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">Wodin</div>
					<div class="post-datetime">
						21 Feb 2008, 20:18					</div>
				</div>
				<div class="post-content content">
					<p>Do you mean you want your children to get a fair share of the bandwidth?</p><p>In that case, QoS (Quality of Service) is what you&#039;re looking for:<br /><a href="http://wiki.openwrt.org/MiniHowtos/QoSHowto">QoSHowto</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p64304">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">belrpr</div>
					<div class="post-datetime">
						29 Feb 2008, 12:26					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Wodin wrote:</cite><blockquote><p>Do you mean you want your children to get a fair share of the bandwidth?</p><p>In that case, QoS (Quality of Service) is what you&#039;re looking for:<br /><a href="http://wiki.openwrt.org/MiniHowtos/QoSHowto">QoSHowto</a></p></blockquote></div><p>No the problem is that my oldest son is using 10 sites at the same time.<br />Or he is on msn, downloading etc.</p><p>And my other kids just open 1 page.<br />Then my oldest son will have 10/11 bandwith and my other kid just 1/11 of the available bandwith.</p><p>With fair nat both will have 50/50 bandwith.<br />Without fair nat it is connection based. The more connections the more bandwith.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p64307">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">frostschutz</div>
					<div class="post-datetime">
						29 Feb 2008, 12:42					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m using Fair NAT on OpenWRT, you can get the script from my page <a href="http://www.metamorpher.de/fairnat/">http://www.metamorpher.de/fairnat/</a> - see the OpenWRT version there.</p><p>You will however need some knowledge about Linux and QoS in order to customize it to your needs. Fair NAT is something I made for my personal use, I don&#039;t have the time to maintain it for general purpose use anymore.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p64312">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">belrpr</div>
					<div class="post-datetime">
						29 Feb 2008, 13:34					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>frostschutz wrote:</cite><blockquote><p>I&#039;m using Fair NAT on OpenWRT, you can get the script from my page <a href="http://www.metamorpher.de/fairnat/">http://www.metamorpher.de/fairnat/</a> - see the OpenWRT version there.</p><p>You will however need some knowledge about Linux and QoS in order to customize it to your needs. Fair NAT is something I made for my personal use, I don&#039;t have the time to maintain it for general purpose use anymore.</p></blockquote></div><p>I understand but trying to implement it on my work too now and you must define the users for the script. I am looking for a script that would do it dynamicly.</p><p>So if 3 users are connected all gets 33%<br />10 users then they get 10%</p><p>and that without changing the configs.<br />Willing to pay a programmer for it. So if anyone is interested u may pm me.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p64313">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">frostschutz</div>
					<div class="post-datetime">
						29 Feb 2008, 13:59					</div>
				</div>
				<div class="post-content content">
					<p>Well, HTB does it dynamically. Even though there are two users in my config, if only one is online he will get 100% because that&#039;s the way the scheduler works. So if you have 10 users max you can configure it for 10 users, and it will still work if only 3 are using it with 33% for each. That&#039;s the whole idea. Dynamically adding users on the fly would require some means of authentication or some other way that allows the router to detect when there is a new user, or old user no longer there. Plus you would have to re-create the shaping and iptables rules every time a user is added / removed. Such a feature was requested for Fair NAT once but I never got around to implementing it, and now I&#039;m not planning to do so either. For 10 users it shouldn&#039;t be necessary anyway, and if it&#039;s just for the kids / your home network, it&#039;s simply the wrong approach, as it adds too much complexity for very little profit.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p64889">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">belrpr</div>
					<div class="post-datetime">
						10 Mar 2008, 09:55					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>frostschutz wrote:</cite><blockquote><p>Well, HTB does it dynamically. Even though there are two users in my config, if only one is online he will get 100% because that&#039;s the way the scheduler works. So if you have 10 users max you can configure it for 10 users, and it will still work if only 3 are using it with 33% for each. That&#039;s the whole idea. Dynamically adding users on the fly would require some means of authentication or some other way that allows the router to detect when there is a new user, or old user no longer there. Plus you would have to re-create the shaping and iptables rules every time a user is added / removed. Such a feature was requested for Fair NAT once but I never got around to implementing it, and now I&#039;m not planning to do so either. For 10 users it shouldn&#039;t be necessary anyway, and if it&#039;s just for the kids / your home network, it&#039;s simply the wrong approach, as it adds too much complexity for very little profit.</p></blockquote></div><p>Ok it is ok for my kids but I want to implement the same thing for my chillispot.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p67637">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">Sigius</div>
					<div class="post-datetime">
						30 Apr 2008, 15:23					</div>
				</div>
				<div class="post-content content">
					<p>Hi Belrpr, not sure if the above is still an issue for you but you should be able to implement what you want using the esfq queing discipline. Basicly its sfq with the ability added to schedule fairly on a client basis (i.s.o a connection basis). Its provided by the package kmod_sched .&nbsp; I have not used it but intent to give it a try, for the same purpose as you mentioned (fair bandwidth sharing on a hotspot ). First however i&#039;ll try frostschutz fairnat (for two users) to get sort of a benchmark of what to expect.</p><p>Btw esfq is not yet part of the latest linux kernel (2.6.25)&nbsp; and it is not supported by shorewall. Whether it ever will or if the functionality will be integrated into sfq is still an open issue as far as I can tell.</p><p>PS: If it matters I&#039;m using kamikaze 7.09</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p67647">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">frostschutz</div>
					<div class="post-datetime">
						30 Apr 2008, 21:52					</div>
				</div>
				<div class="post-content content">
					<p>The following is guesswork as I never used esfq:</p><p>esfq should be able to handle many more clients than my fair nat HTB approach (since you don&#039;t have to create a class for every client), but you can&#039;t add traffic prioritization (because you can&#039;t create a class with subclasses for every client that does this in the HTB approach). You could do the traffic prioritization first but then it already won&#039;t be fair anymore, whoever uses more different kinds of bandwidth gets more bandwidth. I have only four static ip clients so I prefer the class based approach, as it gives you finer control over things. Of course that&#039;s only good if you know what to do when you have to control something. esfq on the other hand should be pretty much a zero config approach...</p><p>I&#039;d love to hear what worked out best for you in the end</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p67656">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">Sigius</div>
					<div class="post-datetime">
						1 May 2008, 05:50					</div>
				</div>
				<div class="post-content content">
					<p>Frostschutz, belrpr,</p><p>I did some test using a setup with two clients (read:laptops) :<br />Client A has 20 download sessions running, implemented with netcat, simulating a p2p user.<br />Client B has an ftp download in progress. Here is the summary of my testresults and the settings used.:</p><p>----------------------------------------------------------------------------------<br />Trafficshaping:None<br />Client B gets about 5% of the total bandwdith. This what I would expect as about 5% of the connects belong to B.<br />Settings:<br />&nbsp; &nbsp; &nbsp; &nbsp; tc qdisc add dev $DEVICE root handle 1: htb default 1<br />&nbsp; &nbsp; &nbsp; &nbsp; tc class add dev $DEVICE parent 1: classid 1:1 htb rate $TOTRATE&quot;kbit&quot; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ceil $TOTRATE&quot;kbit&quot; mpu 96 overhead 50 quantum 1600</p><p>----------------------------------------------------------------------------------<br />Trafficshaping:FairNat (my implementation of it)<br />Client B gets about 30% of the total bandwdith. Not sure why its not at 50% here. I would expect any bandwidth over USRRATE(x2) would be distributed fairly over A and B. .<br />Settings:<br />&nbsp; &nbsp; # Create the qdisc<br />&nbsp; &nbsp; &nbsp; &nbsp; tc qdisc add dev $DEVICE root handle 1: htb default 30<br />&nbsp; &nbsp; # Create the root class<br />&nbsp; &nbsp; &nbsp; &nbsp; tc class add dev $DEVICE parent 1: classid 1:1 htb rate $TOTRATE&quot;kbit&quot; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ceil $TOTRATE&quot;kbit&quot; mpu 96 overhead 50 quantum 1600<br />&nbsp; &nbsp; # &#039;local&#039; qdisc<br />&nbsp; &nbsp; &nbsp; &nbsp; tc class add dev $DEVICE parent 1:1 classid 1:30 htb rate $LOCRATE&quot;kbit&quot; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ceil $TOTRATE&quot;kbit&quot; mpu 96 overhead 50 quantum 1600<br />&nbsp; &nbsp; &nbsp; &nbsp; tc qdisc add dev $DEVICE parent 1:30 handle 300: prio<br />&nbsp; &nbsp; # Create class for clientA @ 243<br />&nbsp; &nbsp; &nbsp; &nbsp; tc class add dev $DEVICE parent 1:1 classid 1:10 htb rate $USRRATE&quot;kbit&quot; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ceil $TOTRATE&quot;kbit&quot; mpu 96 overhead 50 quantum 1600<br />&nbsp; &nbsp; &nbsp; &nbsp; tc qdisc add dev $DEVICE parent 1:10 handle 100: prio<br />&nbsp; &nbsp; &nbsp; &nbsp; tc filter add dev $DEVICE parent 1: prio 1 protocol ip handle 0x10 fw flowid 1:10<br />&nbsp; &nbsp; # Create class for ClientB @ 245<br />&nbsp; &nbsp; &nbsp; &nbsp; tc class add dev $DEVICE parent 1:1 classid 1:20 htb rate $USRRATE&quot;kbit&quot; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ceil $TOTRATE&quot;kbit&quot; mpu 96 overhead 50 quantum 1600<br />&nbsp; &nbsp; &nbsp; &nbsp; tc qdisc add dev $DEVICE parent 1:20 handle 200: prio<br />&nbsp; &nbsp; &nbsp; &nbsp; tc filter add dev $DEVICE parent 1: prio 1 protocol ip handle 0x20 fw flowid 1:20<br />&nbsp; &nbsp; # Now to mark the packets appropriately:<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -t mangle -A POSTROUTING -p tcp -d 192.168.163.243&nbsp; -j MARK --set-mark 0x10<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -t mangle -A POSTROUTING -p tcp -d 192.168.163.245&nbsp; -j MARK --set-mark 0x20<br />----------------------------------------------------------------------------------<br />Trafficshaping:ESFQ<br />Client B gets about 50% of the total bandwdith. What I would expect<br />Settings:<br />&nbsp; &nbsp; # create the qdisc<br />&nbsp; &nbsp; &nbsp; &nbsp; tc qdisc add dev $DEVICE root handle 1: htb default 1<br />&nbsp; &nbsp; # create the root class<br />&nbsp; &nbsp; &nbsp; &nbsp; tc class add dev $DEVICE parent 1: classid 1:1 htb rate $TOTRATE&quot;kbit&quot; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ceil $TOTRATE&quot;kbit&quot; mpu 96 overhead 50 quantum 1600<br />&nbsp; &nbsp; &nbsp; &nbsp; tc qdisc add dev $DEVICE parent 1:1 handle 100: esfq hash dst perturb 20<br />----------------------------------------------------------------------------------</p><p>Prelimanary concusion is that esfq is quite fair indeed and like frostschutz said &#039;pretty much a zero config approach&#039; <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" />. Next step is to add traffic prioritization for ssh,acks, dns etc. I think I would indeed loose a bit of fairness that I would have using fairnat (as frostschutz points out above) but thats ok; Primarily I want my hotspot to be hogproof.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p67663">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">frostschutz</div>
					<div class="post-datetime">
						1 May 2008, 12:23					</div>
				</div>
				<div class="post-content content">
					<p>The marking rules confuse me just a little; did you shape download traffic only, since you&#039;re using -d $LOCALIP and not -s? (and tcp only?). Download control is inaccurate because you can&#039;t really influence what other people send to you. If it&#039;s upload, then it should be fair (if USRRATE*2+LOCRATE == TOTRATE in this case). If it&#039;s not, then TOTRATE may be too large (HTB believes it can send more than it actually can) or some packets may end up in the wrong class.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p67706">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">Sigius</div>
					<div class="post-datetime">
						2 May 2008, 02:34					</div>
				</div>
				<div class="post-content content">
					<p>To be clear the $DEVICE above is the lan-side device (br-lan on openwrt). I suspect this is a bad decision primarily because other examples I find on the internet sofar are always shaping on the wan device (and/or like yourself on imq). I am sure youre right in saying so but sofar I do not understand how &quot;Download control is inaccurate because you can&#039;t really influence what other people send to you&quot; ;&nbsp; Is it not the case that when I shape on the lan-side&nbsp; device using &#039;Trafficshaping:ESFQ&#039; above any traffic over the alloted share will be dropped and thus slows the download (i.e. the data comming in on the wan por ) by not sending an ack)&nbsp; ?</p><p>The &quot;-p tcp&quot; was indeed a mistake as I was also using udp (ftp) in my tests. All in all my measerument of 30% above using the fair nat approach can be safly disregarded as being unreliable:).</p><p>Another remarkable difference btw between Trafficshaping:None and&nbsp; Trafficshaping:ESFQ. If I start a download from one client (the other is inactive) then with the latter I get a very very stable download rate. With the first the rate is very erratic.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p67811">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">Sigius</div>
					<div class="post-datetime">
						4 May 2008, 15:16					</div>
				</div>
				<div class="post-content content">
					<p>After (quite) some experimenting I think below script is my final implementation of &#039;fair nat&#039; </p><p>-----------------------------------------------------------------<br />#!/bin/sh -x</p><p>LANDEV=br-lan<br />WANDEV=eth0.1<br />DOWNLINK=4000<br />UPLINK=600<br />HALFUPLINK=300<br />LOWLATENCY=&quot;1:10&quot;<br />SMALLACKS=&quot;1:20&quot;<br />BULK=&quot;1:30&quot;</p><br /><p>#UPLINK<br />&nbsp; &nbsp; tc qdisc add dev $WANDEV root handle 1: htb default 30<br />&nbsp; &nbsp; tc class add dev $WANDEV parent 1: classid 1:1 htb rate ${UPLINK}kbit burst 6k<br />&nbsp; &nbsp; tc class add dev $WANDEV parent 1:1 classid ${LOWLATENCY} htb rate 100kbit ceil ${HALFUPLINK}kbit burst 6k prio 1<br />&nbsp; &nbsp; tc class add dev $WANDEV parent 1:1 classid ${SMALLACKS}&nbsp; htb rate 100kbit ceil ${HALFUPLINK}kbit burst 6k prio 2<br />&nbsp; &nbsp; tc class add dev $WANDEV parent 1:1 classid ${BULK}&nbsp; &nbsp; &nbsp; &nbsp;htb rate 100kbit ceil ${UPLINK}kbit&nbsp; &nbsp; &nbsp;burst 6k prio 3</p><p>&nbsp; &nbsp; tc qdisc add dev $WANDEV parent ${LOWLATENCY} handle 10: pfifo limit 10<br />&nbsp; &nbsp; tc qdisc add dev $WANDEV parent ${SMALLACKS} handle 20: pfifo limit 10<br />&nbsp; &nbsp; tc qdisc add dev $WANDEV parent ${BULK} handle 30: esfq hash ctorigsrc perturb 10</p><br /><p>&nbsp; &nbsp; tc filter add dev $WANDEV protocol ip parent 1:0 prio 102 handle 0x10 fw classid ${LOWLATENCY}<br />&nbsp; &nbsp; tc filter add dev $WANDEV protocol ip parent 1:0 prio 102 handle 0x30 fw classid ${BULK}<br />&nbsp; &nbsp; tc filter add dev $WANDEV protocol ip parent 1:0 prio 101 u32 \<br />&nbsp; &nbsp; &nbsp; &nbsp; match ip protocol 6 0xff \<br />&nbsp; &nbsp; &nbsp; &nbsp; match u8 0x05 0x0f at 0 \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; match u16 0x0000 0xffc0 at 2 \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; match u8 0x10 0xff at 33 \<br />&nbsp; &nbsp; &nbsp; &nbsp; flowid ${SMALLACKS}</p><p>&nbsp; &nbsp; iptables -t mangle -A POSTROUTING -p tcp --dport 5900&nbsp; -j MARK --set-mark 0x10<br />&nbsp; &nbsp; iptables -t mangle -A POSTROUTING -p udp --dport 5900&nbsp; -j MARK --set-mark 0x10<br />&nbsp; &nbsp; iptables -t mangle -A POSTROUTING -p tcp --dport 21&nbsp; -j MARK --set-mark 0x10<br />&nbsp; &nbsp; iptables -t mangle -A POSTROUTING -p udp --dport 21&nbsp; -j MARK --set-mark 0x10<br />&nbsp; &nbsp; iptables -t mangle -A POSTROUTING -p tcp --sport 22&nbsp; -j MARK --set-mark 0x10<br />&nbsp; &nbsp; iptables -t mangle -A POSTROUTING -p tcp --dport 22&nbsp; -j MARK --set-mark 0x10<br />&nbsp; &nbsp; iptables -t mangle -A POSTROUTING -p udp --dport 22&nbsp; -j MARK --set-mark 0x10<br />&nbsp; &nbsp; iptables -t mangle -A POSTROUTING -p tcp --dport 23&nbsp; -j MARK --set-mark 0x10<br />&nbsp; &nbsp; iptables -t mangle -A POSTROUTING -p udp --dport 23&nbsp; -j MARK --set-mark 0x10<br />&nbsp; &nbsp; iptables -t mangle -A POSTROUTING -p tcp --dport 53&nbsp; -j MARK --set-mark 0x10<br />&nbsp; &nbsp; iptables -t mangle -A POSTROUTING -p udp --dport 53&nbsp; -j MARK --set-mark 0x10<br />&nbsp; &nbsp; iptables -t mangle -A POSTROUTING -p icmp&nbsp; &nbsp;-j MARK --set-mark 0x10</p><p>#DOWNLINK<br />&nbsp; &nbsp; tc qdisc add dev $LANDEV root handle 1: htb default 1<br />&nbsp; &nbsp; tc class add dev $LANDEV parent 1: classid 1:1 htb rate $DOWNLINK&quot;kbit&quot;<br />&nbsp; &nbsp; tc qdisc add dev $LANDEV parent 1:1 handle 100: esfq hash dst perturb 10<br />-----------------------------------------------------------------</p><p>Feel free to comment and point out where theres room for improvement or /corrections still.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>