<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Hourly network hiccups</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 29 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p87311">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">thunder</div>
					<div class="post-datetime">
						5 May 2009, 05:57					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>I installed Kamikaze 8.09 (the x-wrt version with webif+extras) on my WRT54G v1.1 yesterday.&nbsp; It seems to be working just fine, except about once an hour, seemingly at the half hour mark, I notice a network hiccup where my IM client reconnects to all my networks.&nbsp; I looked through syslog and some services are getting restarted every half hour.&nbsp; Here are the last two hours of logs:</p><p><a href="http://pastebin.com/m54cb19f5">http://pastebin.com/m54cb19f5</a></p><p>I&#039;m not really sure where to go from here, any advice would be appreciated!</p><p>Oh btw, the FAQ and Rules links on the forum are 404s <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>Dan</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p87312">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">thunder</div>
					<div class="post-datetime">
						5 May 2009, 06:15					</div>
				</div>
				<div class="post-content content">
					<p>Update:&nbsp; Well, it just happened again, off &quot;schedule&quot;.&nbsp; So perhaps the service restarts I see in the log are by design, and just a coincidence that they seemed to match previous hiccups?</p><p>At any rate, I definitely get regular disconnects, and I don&#039;t know where to look for clues.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p87348">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">netprince</div>
					<div class="post-datetime">
						5 May 2009, 16:38					</div>
				</div>
				<div class="post-content content">
					<p>Just curious, how long is your dhcp lease for?&nbsp; If for example your lease is for 60 minutes, your router will renew after 30 minutes.&nbsp; Perhaps the renewal is causing problems...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p87354">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">thunder</div>
					<div class="post-datetime">
						5 May 2009, 19:30					</div>
				</div>
				<div class="post-content content">
					<p>Good suggestion, but that&#039;s not it.&nbsp; Lease time is 720 minutes.&nbsp; All my clients listed at the bottom of the dhcp page expire in ~10-11 hours from now.</p><p>Is it possible faulty hardware is at work?&nbsp; I was not using my WRT54G at all previous to yesterday.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p87355">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">netprince</div>
					<div class="post-datetime">
						5 May 2009, 19:37					</div>
				</div>
				<div class="post-content content">
					<p>I was more interested in your lease from your ISP to your router.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p87357">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">thunder</div>
					<div class="post-datetime">
						5 May 2009, 19:56					</div>
				</div>
				<div class="post-content content">
					<p>Doh.&nbsp; So, I feel kind of silly, but I can&#039;t find that anywhere.&nbsp; Is that exposed via webif?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p87358">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">netprince</div>
					<div class="post-datetime">
						5 May 2009, 20:06					</div>
				</div>
				<div class="post-content content">
					<p>I dont know about webif, log in and use command line, try:</p><div class="codebox"><pre><code>ifdown wan; sleep 3; ifup wan</code></pre></div><p>watch for &#039;lease of x.x.x.x obtained, lease time [time is here]&#039;</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p87359">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">thunder</div>
					<div class="post-datetime">
						5 May 2009, 20:43					</div>
				</div>
				<div class="post-content content">
					<p>Indeed, lease time is 1800, I assume seconds, so 1/2hr.</p><p>Looking through the logs, it doesn&#039;t look like my ip is actually changing, but openwrt completely brings down the wan interface to renew dhcp.&nbsp; Can that be avoided?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p87363">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">netprince</div>
					<div class="post-datetime">
						5 May 2009, 20:55					</div>
				</div>
				<div class="post-content content">
					<p>We have been working on a new dhcp script which might help.&nbsp; It would be interesting to see if it helps in your situation.&nbsp; Here&#039;s what to do from your router:</p><div class="codebox"><pre><code>cd /usr/share/udhcpc/
cp default.script default.script.orig
wget http://quamquam.org/~jow/default.script
chmod a+x default.script</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p87499">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">thunder</div>
					<div class="post-datetime">
						7 May 2009, 08:36					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for the link!&nbsp; I&#039;ve just downloaded it, so you can remove it from your server if you like.</p><p>I&#039;ll let you know in a few hours/tomorrow if it makes my problem go away.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p87502">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">thunder</div>
					<div class="post-datetime">
						7 May 2009, 10:38					</div>
				</div>
				<div class="post-content content">
					<p>So far it doesn&#039;t appear to be making much of a difference.&nbsp; I&#039;ve seen a few hiccups since swapping in the new script.&nbsp; And I see the interface going down/back up in syslog:</p><p>May&nbsp; 7 07:15:20 OpenWrt daemon.notice miniupnpd[1997]: received signal 15, good-bye<br />May&nbsp; 7 07:15:20 OpenWrt user.notice upnp firewall: removing wan interface<br />May&nbsp; 7 07:15:21 OpenWrt user.notice upnp firewall: adding wan interface eth0.1(64.9.243.151)</p><p>I can spend some time this weekend to debug the script, if you think that would help.&nbsp; Or if you could give me some pointers of what else to look at, that would be great too.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p87538">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						7 May 2009, 15:54					</div>
				</div>
				<div class="post-content content">
					<p>Hi.</p><p>The lines above are just miniupnpd, it removes it&#039;s rules and inserts them again to prevent lingering rules if the wan ip changed.<br />Do you run your IM sessions over a port forward somehow?</p><p>~ JoW</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p87540">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">netprince</div>
					<div class="post-datetime">
						7 May 2009, 16:41					</div>
				</div>
				<div class="post-content content">
					<p>thunder, here is something else to try, add the action=renew line to the beginning of /etc/hotplug.d/iface/20-miniupnpd so it looks like this:</p><div class="codebox"><pre><code>#!/bin/sh

[ &quot;$ACTION&quot; = &quot;renew&quot; ] &amp;&amp; exit

/etc/init.d/miniupnpd enabled &amp;&amp; {
    killall -0 miniupnpd 2&gt;/dev/null &amp;&amp; {
        . /lib/miniupnpd/firewall.sh

        [ &quot;$ACTION&quot; = &quot;ifup&quot; ] &amp;&amp; {
            upnp_firewall_delif
            upnp_firewall_addif
        }

        [ &quot;$ACTION&quot; = &quot;ifdown&quot; ] &amp;&amp; {
            upnp_firewall_delif
        }
    } || {
        /etc/init.d/miniupnpd restart
    }
}</code></pre></div>											<p class="post-edited">(Last edited by <strong>netprince</strong> on 7 May 2009, 16:41)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p87560">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">buildster</div>
					<div class="post-datetime">
						7 May 2009, 22:28					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>thunder wrote:</cite><blockquote><p>So far it doesn&#039;t appear to be making much of a difference.&nbsp; I&#039;ve seen a few hiccups since swapping in the new script.&nbsp; And I see the interface going down/back up in syslog:</p><p>May&nbsp; 7 07:15:20 OpenWrt daemon.notice miniupnpd[1997]: received signal 15, good-bye<br />May&nbsp; 7 07:15:20 OpenWrt user.notice upnp firewall: removing wan interface<br />May&nbsp; 7 07:15:21 OpenWrt user.notice upnp firewall: adding wan interface eth0.1(64.9.243.151)</p><p>I can spend some time this weekend to debug the script, if you think that would help.&nbsp; Or if you could give me some pointers of what else to look at, that would be great too.</p></blockquote></div><p>If I have to guess, your ISP (or just udhcpc) doesn&#039;t do &quot;renew&quot; when a 30-minute lease is expired. Instead, it does &quot;deconfig&quot; and &quot;bound&quot; in this order. You can confirm it by adding script /etc/hotplug.d/iface/00-event-dump:</p><div class="codebox"><pre><code>echo -- $(date) -- &gt;&gt; /tmp/hotevent.log
set &gt;&gt; /tmp/hotevent.log
echo ===== &gt;&gt;/tmp/hotevent.log
echo &gt;&gt; /tmp/hotevent.log</code></pre></div><p>In /tmp/hotevent.log, you should see exactly whether &quot;update&quot; or &quot;ifdown&quot;/&quot;ifup&quot; was invoked. That latter brings your wan all way down and then up... thus a hiccup. If not, modify hotplug.d/iface scripts to work with &quot;update&quot; events.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p87562">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">thunder</div>
					<div class="post-datetime">
						7 May 2009, 22:50					</div>
				</div>
				<div class="post-content content">
					<p>Hey guys, thanks for the suggestions.&nbsp; I&#039;ll try them out as soon as I get a chance.</p><p>FWIW, I&#039;m not using port forwarding for IM.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p87717">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">thunder</div>
					<div class="post-datetime">
						11 May 2009, 04:06					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ve confirmed using the script from comment #14 that it&#039;s doing a full ifdown/ifup.&nbsp; But I&#039;m not really sure what to tweak to make it ignore whatever my isp is saying and do an update instead.</p><p>`find /etc|xargs grep ifdown` leads me to believe ifdown would occur in 3 cases:</p><p>* ppp event<br />* /etc/inid.d/network stop<br />* When shutting down, /etc/rc.d will stop the network (there are no runlevels, right?)</p><p>The first and last don&#039;t apply in this case (I&#039;m not using ppp, and I&#039;m not shutting down the router), which leaves something explicitly calling `/etc/init.d/network stop`... but I can&#039;t find anything that does that.&nbsp; Should I be looking elsewhere, or have I overlooked something in /etc?&nbsp; The /etc/hotplug.d/iface/ scripts don&#039;t seem to cause an ifdown, only react to one.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>