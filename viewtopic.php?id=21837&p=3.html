<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> AR8316 Switch Support</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 7 Oct 2014 and 7 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 3 of 9</div><nav><ul><li><a href="viewtopic.php%3Fid=21837&amp;p=1.html">1</a></li><li><a href="viewtopic.php%3Fid=21837&amp;p=2.html">2</a></li><li class="pagination-current"><span>3</span></li><li><a href="viewtopic.php%3Fid=21837&amp;p=4.html">4</a></li><li><a href="viewtopic.php%3Fid=21837&amp;p=5.html">5</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=21837&amp;p=9.html">9</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p104522">
				<div class="post-metadata">
					<div class="post-num">Post #51</div>
					<div class="post-author">flaxrt</div>
					<div class="post-datetime">
						11 Mar 2010, 19:47					</div>
				</div>
				<div class="post-content content">
					<p>Hope this helps:<br/>The RB450G has 5 ethernet ports, numbered from left to right.<br/>Port 1 is identified as eth0 and member of br-lan.<br/>Ping to the subnet configured on eth1 works on all ports from 2 to 5.</p><p>This seems a bit reversed from the rs pro.<br/>I&#039;ve tested with both ping and tcpdump so I confirm the port numbering.</p><p>Thank you.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104529">
				<div class="post-metadata">
					<div class="post-num">Post #52</div>
					<div class="post-author">KanjiMonster</div>
					<div class="post-datetime">
						11 Mar 2010, 23:50					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>flaxrt wrote:</cite><blockquote><p>Hope this helps:<br/>The RB450G has 5 ethernet ports, numbered from left to right.<br/>Port 1 is identified as eth0 and member of br-lan.<br/>Ping to the subnet configured on eth1 works on all ports from 2 to 5.</p><p>This seems a bit reversed from the rs pro.<br/>I&#039;ve tested with both ping and tcpdump so I confirm the port numbering.<br/>Thank you.</p></blockquote></div><p>First of all, thank you very much for testing the patch on the rb 450g.</p><p>Could you try <a href="http://page.mi.fu-berlin.de/jgorski/openwrt/0001-Add-support-for-the-ar8316-switch_debug.patch">this patch</a>? It is almost the same as the previous, except it prints port status changes into the kernel log (using the switch internal port numbers).</p><p>This should tell you which external port label corresponds to which internal port.</p><p><strong>Edit</strong>: Btw, it would be really nice if you could test a &quot;cold boot&quot; from flash, since there were reports that no ethernet works when directly booting from flash.</p><p>KM</p>											<p class="post-edited">(Last edited by <strong>KanjiMonster</strong> on 12 Mar 2010, 01:21)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104536">
				<div class="post-metadata">
					<div class="post-num">Post #53</div>
					<div class="post-author">bradyzhu</div>
					<div class="post-datetime">
						12 Mar 2010, 08:52					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>KanjiMonster wrote:</cite><blockquote><div class="quotebox"><cite>flaxrt wrote:</cite><blockquote><p>Hope this helps:<br/>The RB450G has 5 ethernet ports, numbered from left to right.<br/>Port 1 is identified as eth0 and member of br-lan.<br/>Ping to the subnet configured on eth1 works on all ports from 2 to 5.</p><p>This seems a bit reversed from the rs pro.<br/>I&#039;ve tested with both ping and tcpdump so I confirm the port numbering.<br/>Thank you.</p></blockquote></div><p>First of all, thank you very much for testing the patch on the rb 450g.</p><p>Could you try <a href="http://page.mi.fu-berlin.de/jgorski/openwrt/0001-Add-support-for-the-ar8316-switch_debug.patch">this patch</a>? It is almost the same as the previous, except it prints port status changes into the kernel log (using the switch internal port numbers).</p><p>This should tell you which external port label corresponds to which internal port.</p><p><strong>Edit</strong>: Btw, it would be really nice if you could test a &quot;cold boot&quot; from flash, since there were reports that no ethernet works when directly booting from flash.</p><p>KM</p></blockquote></div><p>Here is the result for my RB450G:<br/>==&gt;Eth1<br/>ar8316: port 5 up (1000Mbps/Full duplex)<br/>eth0: link up (1000Mbps/Full duplex)<br/>br-lan: port 1(eth0) entering forwarding state<br/>ar8316: port 5 down</p><p>==&gt;Eth2<br/>eth0: link down<br/>br-lan: port 1(eth0) entering disabled state<br/>ar8316: port 1 up (1000Mbps/Full duplex)<br/>ar8316: port 1 down</p><p>==&gt;Eth3<br/>ar8316: port 4 up (1000Mbps/Full duplex)<br/>ar8316: port 4 down</p><p>==&gt;Eth4<br/>ar8316: port 3 up (1000Mbps/Full duplex)<br/>ar8316: port 3 down</p><p>==&gt;Eth5<br/>ar8316: port 2 up (1000Mbps/Full duplex)<br/>ar8316: port 2 down</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104558">
				<div class="post-metadata">
					<div class="post-num">Post #54</div>
					<div class="post-author">flaxrt</div>
					<div class="post-datetime">
						12 Mar 2010, 19:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bradyzhu wrote:</cite><blockquote><p>Here is the result for my RB450G:<br/>==&gt;Eth1<br/>ar8316: port 5 up (1000Mbps/Full duplex)<br/>eth0: link up (1000Mbps/Full duplex)<br/>br-lan: port 1(eth0) entering forwarding state<br/>ar8316: port 5 down</p><p>==&gt;Eth2<br/>eth0: link down<br/>br-lan: port 1(eth0) entering disabled state<br/>ar8316: port 1 up (1000Mbps/Full duplex)<br/>ar8316: port 1 down</p><p>==&gt;Eth3<br/>ar8316: port 4 up (1000Mbps/Full duplex)<br/>ar8316: port 4 down</p><p>==&gt;Eth4<br/>ar8316: port 3 up (1000Mbps/Full duplex)<br/>ar8316: port 3 down</p><p>==&gt;Eth5<br/>ar8316: port 2 up (1000Mbps/Full duplex)<br/>ar8316: port 2 down</p></blockquote></div><p>Same for me.<br/>I&#039;m browsing the other threads to understand how to flash the image and boot it so after the weekend I should have an answer regarding the cold boot situation.</p><p>Thank you</p><p>---Later that day<br/>when flash booted:<br/>ar8316: port 5 up (100Mbps/Full duplex)<br/>ar8316: port 5 down<br/>ar8316: port 1 up (100Mbps/Full duplex)<br/>ar8316: port 1 down<br/>ar8316: port 4 up (100Mbps/Full duplex)<br/>ar8316: port 4 down<br/>ar8316: port 3 up (100Mbps/Full duplex)<br/>ar8316: port 3 down<br/>ar8316: port 2 up (100Mbps/Full duplex)<br/>ar8316: port 2 down<br/>ar8316: port 2 down</p><p>ping works from all ports</p><p>---</p><p>Thank you KM for the switch and rabinnh for the partition size patch.</p>											<p class="post-edited">(Last edited by <strong>flaxrt</strong> on 12 Mar 2010, 20:48)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104561">
				<div class="post-metadata">
					<div class="post-num">Post #55</div>
					<div class="post-author">KanjiMonster</div>
					<div class="post-datetime">
						12 Mar 2010, 21:06					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>flaxrt wrote:</cite><blockquote><p>---Later that day<br/>when flash booted:<br/>ar8316: port 5 up (100Mbps/Full duplex)<br/>ar8316: port 5 down<br/>ar8316: port 1 up (100Mbps/Full duplex)<br/>ar8316: port 1 down<br/>ar8316: port 4 up (100Mbps/Full duplex)<br/>ar8316: port 4 down<br/>ar8316: port 3 up (100Mbps/Full duplex)<br/>ar8316: port 3 down<br/>ar8316: port 2 up (100Mbps/Full duplex)<br/>ar8316: port 2 down<br/>ar8316: port 2 down</p><p>ping works from all ports</p><p>---</p><p>Thank you KM for the switch and rabinnh for the partition size patch.</p></blockquote></div><p>Thank you for taking the time for testing.</p><p>Could you paste me the following lines from cold boot:<br/></p><div class="codebox"><pre><code>ar8316: updating reg 0x00008 from 0x81461bea to 0x81461bea
ar8316: updating reg 0x000b0 from 0xcc37cc37 to 0xcc37cc37
ar8316: updating reg 0x000b4 from 0xca37ca37 to 0xcc37cc37
ar8316: updating reg 0x000b8 from 0xca37ca37 to 0xca37ca37
ar8316: updating reg 0x000bc from 0x00000000 to 0x00000000
ar8316: updating phy4 dbg reg 0x12 from 0x4c0c to 0x480c
ar8316: updating phy4 dbg reg 0x00 from 0x824e to 0x824e
ar8316: updating phy4 dbg reg 0x05 from 0x3d47 to 0x3d47</code></pre></div><p>or say if there were the same (I&#039;m interested in the original values).</p><p>---</p><p><strong>Minor Update</strong></p><p>I updated <a href="http://page.mi.fu-berlin.de/jgorski/openwrt/0002-ar71xx-Add-the-ar8316-driver-to-rs-pro-rb-450g.patch">the second patch</a> that adds the switch configuration.</p><p>Changes:<br/>* RB-450G: Now the wan is again eth0 and eth1 is the lan again. I switched this previously because I didn&#039;t see that its already switched in the initialization routine of the routerboard.</p><p>KM</p>											<p class="post-edited">(Last edited by <strong>KanjiMonster</strong> on 12 Mar 2010, 21:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104584">
				<div class="post-metadata">
					<div class="post-num">Post #56</div>
					<div class="post-author">warm</div>
					<div class="post-datetime">
						13 Mar 2010, 05:08					</div>
				</div>
				<div class="post-content content">
					<p>KanjiMonster, pleace read private message. I can give You remote access to PC connected to rb450g by console and two eth.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104587">
				<div class="post-metadata">
					<div class="post-num">Post #57</div>
					<div class="post-author">bradyzhu</div>
					<div class="post-datetime">
						13 Mar 2010, 07:48					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>KanjiMonster wrote:</cite><blockquote><div class="quotebox"><cite>flaxrt wrote:</cite><blockquote><p>---Later that day<br/>when flash booted:<br/>ar8316: port 5 up (100Mbps/Full duplex)<br/>ar8316: port 5 down<br/>ar8316: port 1 up (100Mbps/Full duplex)<br/>ar8316: port 1 down<br/>ar8316: port 4 up (100Mbps/Full duplex)<br/>ar8316: port 4 down<br/>ar8316: port 3 up (100Mbps/Full duplex)<br/>ar8316: port 3 down<br/>ar8316: port 2 up (100Mbps/Full duplex)<br/>ar8316: port 2 down<br/>ar8316: port 2 down</p><p>ping works from all ports</p><p>---</p><p>Thank you KM for the switch and rabinnh for the partition size patch.</p></blockquote></div><p>Thank you for taking the time for testing.</p><p>Could you paste me the following lines from cold boot:<br/></p><div class="codebox"><pre><code>ar8316: updating reg 0x00008 from 0x81461bea to 0x81461bea
ar8316: updating reg 0x000b0 from 0xcc37cc37 to 0xcc37cc37
ar8316: updating reg 0x000b4 from 0xca37ca37 to 0xcc37cc37
ar8316: updating reg 0x000b8 from 0xca37ca37 to 0xca37ca37
ar8316: updating reg 0x000bc from 0x00000000 to 0x00000000
ar8316: updating phy4 dbg reg 0x12 from 0x4c0c to 0x480c
ar8316: updating phy4 dbg reg 0x00 from 0x824e to 0x824e
ar8316: updating phy4 dbg reg 0x05 from 0x3d47 to 0x3d47</code></pre></div><p>or say if there were the same (I&#039;m interested in the original values).</p><p>---</p><p><strong>Minor Update</strong></p><p>I updated <a href="http://page.mi.fu-berlin.de/jgorski/openwrt/0002-ar71xx-Add-the-ar8316-driver-to-rs-pro-rb-450g.patch">the second patch</a> that adds the switch configuration.</p><p>Changes:<br/>* RB-450G: Now the wan is again eth0 and eth1 is the lan again. I switched this previously because I didn&#039;t see that its already switched in the initialization routine of the routerboard.</p><p>KM</p></blockquote></div><p>ar8316: updating reg 0x00008 from 0x01061b60 to 0x81461bea<br/>ar8316: updating reg 0x000b0 from 0xcc00cc00 to 0xcc37cc37<br/>ar8316: updating reg 0x000b4 from 0xca35ca35 to 0xcc37cc37<br/>ar8316: updating reg 0x000b8 from 0xcf35cf35 to 0xca37ca37<br/>ar8316: updating reg 0x000bc from 0x00000000 to 0x00000000<br/>ar8316: updating phy4 dbg reg 0x12 from 0x4c0c to 0x480c<br/>ar8316: updating phy4 dbg reg 0x00 from 0x82ee to 0x824e<br/>ar8316: updating phy4 dbg reg 0x05 from 0x3c46 to 0x3d47</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104595">
				<div class="post-metadata">
					<div class="post-num">Post #58</div>
					<div class="post-author">KanjiMonster</div>
					<div class="post-datetime">
						13 Mar 2010, 14:38					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bradyzhu wrote:</cite><blockquote><p>ar8316: updating reg 0x00008 from 0x01061b60 to 0x81461bea<br/>ar8316: updating reg 0x000b0 from 0xcc00cc00 to 0xcc37cc37<br/>ar8316: updating reg 0x000b4 from 0xca35ca35 to 0xcc37cc37<br/>ar8316: updating reg 0x000b8 from 0xcf35cf35 to 0xca37ca37<br/>ar8316: updating reg 0x000bc from 0x00000000 to 0x00000000<br/>ar8316: updating phy4 dbg reg 0x12 from 0x4c0c to 0x480c<br/>ar8316: updating phy4 dbg reg 0x00 from 0x82ee to 0x824e<br/>ar8316: updating phy4 dbg reg 0x05 from 0x3c46 to 0x3d47</p></blockquote></div><p>Great. Using this information, here are updated patches:</p><p><strong>March 13 Version</strong><br/>Changelog:<br/>- <a href="http://page.mi.fu-berlin.de/jgorski/openwrt/0001-Add-support-for-the-ar8316-switch.patch">The ar8316 driver</a><br/>&nbsp; * The port status update is part of the regular version for now<br/>&nbsp; * Don&#039;t modify the LED registers, these seem to be always setup by the rb-450g <br/>&nbsp; * Don&#039;t do a hw init on the rs pro, this should speed up the boot there<br/>&nbsp; * Made the multicast fix ar8316 specific for now<br/>- <a href="http://page.mi.fu-berlin.de/jgorski/openwrt/0002-ar71xx-Add-the-ar8316-driver-to-rs-pro-rb-450g.patch">Network/profile configuration updates</a><br/>&nbsp; * Include the driver also in 2.6.33 and 2.6.34</p><p>KM</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104596">
				<div class="post-metadata">
					<div class="post-num">Post #59</div>
					<div class="post-author">flaxrt</div>
					<div class="post-datetime">
						13 Mar 2010, 14:50					</div>
				</div>
				<div class="post-content content">
					<p>eth0 is now wan , eth1 is in the lan bridge.<br/>The port order is the same ( 5,1,4,3,2 ).</p><p>Thank you.</p><p>PS: What do you usually use to test throughput ? I&#039;ve used iperf but not much option there for parallel connections and simulating multiple nat-ed ip&#039;s ...</p>											<p class="post-edited">(Last edited by <strong>flaxrt</strong> on 13 Mar 2010, 14:51)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104599">
				<div class="post-metadata">
					<div class="post-num">Post #60</div>
					<div class="post-author">KanjiMonster</div>
					<div class="post-datetime">
						13 Mar 2010, 15:34					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>flaxrt wrote:</cite><blockquote><p>eth0 is now wan , eth1 is in the lan bridge.<br/>The port order is the same ( 5,1,4,3,2 ).</p></blockquote></div><p>Thanks for the feedback. Unfortunately I can&#039;t think of an easy way to &quot;fix&quot; the port numbering.</p><p>The options I can think of are:<br/>* Making the switch a platform device, adding port mappings (external number -&gt; internal number), and supplying these as platform_data. Requires quite a bit of changes in the driver<br/>* Modifying switch.sh to allow an e.g. a switch.int_port_numbers = &#039;0 5 1 4 3 2&#039; to do the translation before sending them to swconfig<br/>* Creating a DSA driver (which currently has several drawback, like no wirespeed switching support), which allows the ports to appear as their own ethernet interfaces.</p><p>I currently would prefer option 2, which should be the easiest to implement (and can be developed directly on the device). </p><div class="quotebox"><cite>flaxrt wrote:</cite><blockquote><p>PS: What do you usually use to test throughput ? I&#039;ve used iperf but not much option there for parallel connections and simulating multiple nat-ed ip&#039;s ...</p></blockquote></div><p>I only used iperf until now. Using windows as my main OS really does limit my options there ;-).</p><p>KM</p>											<p class="post-edited">(Last edited by <strong>KanjiMonster</strong> on 13 Mar 2010, 15:34)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104602">
				<div class="post-metadata">
					<div class="post-num">Post #61</div>
					<div class="post-author">ByerRA</div>
					<div class="post-datetime">
						13 Mar 2010, 16:44					</div>
				</div>
				<div class="post-content content">
					<p>Great work, just was I was waiting for...</p><p>I&#039;ll give a run on my RouterStation Pro this weekend and see what I can break <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p><p>Thanks for all your work.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104619">
				<div class="post-metadata">
					<div class="post-num">Post #62</div>
					<div class="post-author">flaxrt</div>
					<div class="post-datetime">
						14 Mar 2010, 11:22					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>KanjiMonster wrote:</cite><blockquote><div class="quotebox"><cite>flaxrt wrote:</cite><blockquote><p>eth0 is now wan , eth1 is in the lan bridge.<br/>The port order is the same ( 5,1,4,3,2 ).</p></blockquote></div><p>Thanks for the feedback. Unfortunately I can&#039;t think of an easy way to &quot;fix&quot; the port numbering.</p><p>The options I can think of are:<br/>* Making the switch a platform device, adding port mappings (external number -&gt; internal number), and supplying these as platform_data. Requires quite a bit of changes in the driver<br/>* Modifying switch.sh to allow an e.g. a switch.int_port_numbers = &#039;0 5 1 4 3 2&#039; to do the translation before sending them to swconfig<br/>* Creating a DSA driver (which currently has several drawback, like no wirespeed switching support), which allows the ports to appear as their own ethernet interfaces.</p><p>I currently would prefer option 2, which should be the easiest to implement (and can be developed directly on the device). </p><div class="quotebox"><cite>flaxrt wrote:</cite><blockquote><p>PS: What do you usually use to test throughput ? I&#039;ve used iperf but not much option there for parallel connections and simulating multiple nat-ed ip&#039;s ...</p></blockquote></div><p>I only used iperf until now. Using windows as my main OS really does limit my options there ;-).</p><p>KM</p></blockquote></div><p>Regarding the switch &quot;issue&quot; I still have to read the docs as I am new to openwrt so I will not bug you for a while.</p><p>As for performance I&#039;ll wait until I can test it on a server with Ge adapters to see how it goes<br/>In 100 MBit it tested for 92.6Mb with Masquerade and 46% cpu load ( 0.10 system load ), using iperf with -P 200 -t 5M</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104622">
				<div class="post-metadata">
					<div class="post-num">Post #63</div>
					<div class="post-author">KanjiMonster</div>
					<div class="post-datetime">
						14 Mar 2010, 12:55					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>flaxrt wrote:</cite><blockquote><p>As for performance I&#039;ll wait until I can test it on a server with Ge adapters to see how it goes<br/>In 100 MBit it tested for 92.6Mb with Masquerade and 46% cpu load ( 0.10 system load ), using iperf with -P 200 -t 5M</p></blockquote></div><p>Sounds about right; I got ~200 Mbit with iperf and using an gbit connection between the rs pro and my pc.</p><p>KM</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104630">
				<div class="post-metadata">
					<div class="post-num">Post #64</div>
					<div class="post-author">KanjiMonster</div>
					<div class="post-datetime">
						14 Mar 2010, 17:07					</div>
				</div>
				<div class="post-content content">
					<p><strong>Sunday afternoon edition</strong></p><p>Just a minor update for the <a href="http://page.mi.fu-berlin.de/jgorski/openwrt/0002-ar71xx-Add-the-ar8316-driver-to-rs-pro-rb-450g.patch">configuration patch</a>:</p><p>* The switch section is now named with the interface name; having no name seemed to have confused luci (it didn&#039;t bother swconfig). That means that configuring the switch with luci should work in theory (didn&#039;t test this).</p><p>KM</p><p>Edit: <br/>No need to rebuild for this to work on device, just change in /etc/config/network<br/></p><div class="codebox"><pre><code>config switch
        option name     eth1
        option reset    1
        option enable_vlan 1</code></pre></div><p>to<br/></p><div class="codebox"><pre><code>config switch eth1
        option name     eth1
        option reset    1
        option enable_vlan 1</code></pre></div>											<p class="post-edited">(Last edited by <strong>KanjiMonster</strong> on 14 Mar 2010, 17:15)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104639">
				<div class="post-metadata">
					<div class="post-num">Post #65</div>
					<div class="post-author">vlx</div>
					<div class="post-datetime">
						14 Mar 2010, 20:37					</div>
				</div>
				<div class="post-content content">
					<p>I praise you KanjiMonster. I hope I could repay you at least by inviting you for some beer sometime <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/><br/>Finally it made my RouterStation PRO worth something..<br/>Bit sad that guys from community must develop these drivers, that should have been done by Atheros or Ubiquiti.. </p><p>I&#039;ve tested it lot this weekend and it works nicely.<br/>I&#039;ve tested tagged VLAN setup with your switch patch (each port in different VLAN), eth0 VLANs and bridging between VLANs. <br/>Only strange thing noticed so far is capturing packets with tcpdump. It captures few packets than pauses and this repeats.<br/>On wifi interface it works fine. But well it may be unrelated to your patch and is related to Atheros network driver.<br/>Will check on vanilla OpenWRT trunk later.</p><p>Thanks again,<br/>Vlado</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104654">
				<div class="post-metadata">
					<div class="post-num">Post #66</div>
					<div class="post-author">warm</div>
					<div class="post-datetime">
						15 Mar 2010, 09:23					</div>
				</div>
				<div class="post-content content">
					<p>I did some tests about routing performance. rb450g with openwrt can route about 23 kpps RX counter and 23 kpps TX (four &quot;ping -f&quot; in my PCs through rb450g). In Cisco kind of measurement it is 46 kpps total performance or so.</p><p>root@rb450g:~# lsmod <br/>Module&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Size&nbsp; Used by&nbsp; &nbsp; Not tainted<br/>sch_htb&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 12384&nbsp; 2 <br/>sch_sfq&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4416&nbsp; 2 <br/>cls_route&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5040&nbsp; 4 <br/>act_police&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3328&nbsp; 2 <br/>iptable_filter&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;768&nbsp; 0 <br/>ip_tables&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8464&nbsp; 1 iptable_filter<br/>x_tables&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9312&nbsp; 1 ip_tables<br/>leds_gpio&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1456&nbsp; 0 <br/>button_hotplug&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2576&nbsp; 0 <br/>gpio_buttons&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1968&nbsp; 0 <br/>input_polldev&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1360&nbsp; 1 gpio_buttons<br/>input_core&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16896&nbsp; 4 button_hotplug,gpio_buttons,input_polldev<br/>root@rb450g:~# </p><p>I unloaded all conntrack and nat modules. &quot;top&quot; was<br/>CPU:&nbsp; &nbsp;0% usr&nbsp; &nbsp;0% sys&nbsp; &nbsp;0% nic&nbsp; 13% idle&nbsp; &nbsp;0% io&nbsp; &nbsp;0% irq&nbsp; 86% sirq</p><p><a href="http://mikc.ru/files/docs/tests2010.pdf">http://mikc.ru/files/docs/tests2010.pdf</a> -- here is no exactly rb450 but rb400 and rb750G. So they at 3 times more (70-90kpps). They use Agilent N2X , I don&#039;t know how it works but they results in 2-3 times faster.</p><p>I&#039;ll try to use linux packet kernel generator but need some free time for this tests ...</p><p>My strange iperf results are:</p><p>1. [&nbsp; 3]&nbsp; 0.0-60.0 sec&nbsp; 2.37 GBytes&nbsp; &nbsp; 339 Mbits/sec &lt;- client is on eth0 (Eth1/PoE)<br/>CPU was about 75% sirq</p><p>2. [&nbsp; 3]&nbsp; 0.0-120.0 sec&nbsp; 8.62 GBytes&nbsp; &nbsp; 617 Mbits/sec &lt;- client in on eth1.10 (Eth2)<br/>CPU was about 95% sirq</p><p>Why such difference ? :-).</p><p>I have questions about vlan setup:</p><p>1. At this moment we can use 1-32 vlan tags and no other numbers, isn&#039;t it ?</p><p>2. The default generated config for vlan contains all ports, is it right ?<br/>I think it shoud to not contain port 5 (eth0)</p><p>config switch_vlan<br/>&nbsp; &nbsp; &nbsp; &nbsp; option device&nbsp; &nbsp;eth1<br/>&nbsp; &nbsp; &nbsp; &nbsp; option vlan&nbsp; &nbsp; &nbsp;1<br/>&nbsp; &nbsp; &nbsp; &nbsp; option ports&nbsp; &nbsp; &quot;0 1 2 3 4 5&quot; &lt;- 5 is eth0</p><p>Also I tried this test vlan 10</p><p>config switch_vlan<br/>&nbsp; &nbsp; &nbsp; &nbsp; option device&nbsp; &nbsp;eth1<br/>&nbsp; &nbsp; &nbsp; &nbsp; option vlan&nbsp; &nbsp; &nbsp;10<br/>&nbsp; &nbsp; &nbsp; &nbsp; option ports&nbsp; &nbsp; &quot;0t 1t 2t 3t 4t 5t&quot;</p><p>and eth0 does not see tag 10 packets by tcpdump, i.e. works right.</p><p>So there is 6 ports (0 1 2 3 4 5) , one of them internal (to eth1) , one is eth0. Configuration of some vlan should have five not six port numbers (0 1 2 3 4). Where am I misstaken ?</p><p>Has anyone right /etc/config/network example where ich port is separate l3 interface ?</p>											<p class="post-edited">(Last edited by <strong>warm</strong> on 15 Mar 2010, 11:22)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104659">
				<div class="post-metadata">
					<div class="post-num">Post #67</div>
					<div class="post-author">KanjiMonster</div>
					<div class="post-datetime">
						15 Mar 2010, 12:35					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>warm wrote:</cite><blockquote><p>I did some tests about routing performance. rb450g with openwrt can route about 23 kpps RX counter and 23 kpps TX (four &quot;ping -f&quot; in my PCs through rb450g). In Cisco kind of measurement it is 46 kpps total performance or so.</p></blockquote></div><p>Thanks for your testing. Do you see the same performance on the single eth0 port?</p><div class="quotebox"><cite>warm wrote:</cite><blockquote><p><a href="http://mikc.ru/files/docs/tests2010.pdf">http://mikc.ru/files/docs/tests2010.pdf</a> -- here is no exactly rb450 but rb400 and rb750G. So they at 3 times more (70-90kpps). They use Agilent N2X , I don&#039;t know how it works but they results in 2-3 times faster.</p></blockquote></div><p>It might have to do that I guess routeros is a specialized os, and they have access to data sheets, so they know hot to optimize their code.</p><br/><div class="quotebox"><cite>warm wrote:</cite><blockquote><p>I have questions about vlan setup:</p><p>1. At this moment we can use 1-32 vlan tags and no other numbers, isn&#039;t it ?</p></blockquote></div><p>Yeah, but I&#039;m hoping to fix that in the next days. For now, you can also just edit the ar8216.c and change the #define at the top (&#039;though you will get problems if you make it bigger than ~650).</p><div class="quotebox"><cite>warm wrote:</cite><blockquote><p>2. The default generated config for vlan contains all ports, is it right ?<br/>I think it shoud to not contain port 5 (eth0)</p><p>(...)</p><p>and eth0 does not see tag 10 packets by tcpdump, i.e. works right.</p><p>So there is 6 ports (0 1 2 3 4 5) , one of them internal (to eth1) , one is eth0. Configuration of some vlan should have five not six port numbers (0 1 2 3 4). Where am I misstaken ?</p></blockquote></div><p>As youself have noticed, the fifth port is separated; at least in default setup. But it looks like it can be made part of the switch again as the RouterOS offers this. Therefore I left it in there, also because it doesn&#039;t seem to cause harm.<br/>Perhaps I&#039;ll be able to figure out one day how its doing that (anybody with JTAG and a RB450G caring to read out some switch registers while RouterOS is loaded? ;-).</p><div class="quotebox"><blockquote><p>Has anyone right /etc/config/network example where ich port is separate l3 interface ?</p></blockquote></div><p>The following should work:</p><div class="codebox"><pre><code>config interface loopback
        option ifname   lo
        option proto    static
        option ipaddr   127.0.0.1
        option netmask  255.0.0.0

config interface port1
        option ifname   &quot;eth1.1&quot;
        option proto    static
        option ipaddr   192.168.1.1
        option netmask  255.255.255.0

config interface port2
        option ifname   &quot;eth1.2&quot;
        option proto    static
        option ipaddr   192.168.2.1
        option netmask  255.255.255.0

config interface port3
        option ifname   &quot;eth1.3&quot;
        option proto    static
        option ipaddr   192.168.3.1
        option netmask  255.255.255.0

config interface port4
        option ifname   &quot;eth1.4&quot;
        option proto    static
        option ipaddr   192.168.4.1
        option netmask  255.255.255.0

config interface wan
        option ifname   eth0
        option proto    dhcp

config switch eth1
        option name     eth1
        option reset    1
        option enable_vlan 1

config switch_vlan
        option device   eth1
        option vlan     1
        option ports    &quot;0t 1&quot;

config switch_vlan
        option device   eth1
        option vlan     2
        option ports    &quot;0t 2&quot;

config switch_vlan
        option device   eth1
        option vlan     3
        option ports    &quot;0t 3&quot;

config switch_vlan
        option device   eth1
        option vlan     4
        option ports    &quot;0t 4&quot;</code></pre></div><p>KM</p><p>P.S: Crititque (especially if I&#039;m writing stupid code ;) is always welcome :)</p>											<p class="post-edited">(Last edited by <strong>KanjiMonster</strong> on 15 Mar 2010, 12:45)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104660">
				<div class="post-metadata">
					<div class="post-num">Post #68</div>
					<div class="post-author">warm</div>
					<div class="post-datetime">
						15 Mar 2010, 13:14					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>KanjiMonster wrote:</cite><blockquote><div class="quotebox"><cite>warm wrote:</cite><blockquote><p>I did some tests about routing performance. rb450g with openwrt can route about 23 kpps RX counter and 23 kpps TX (four &quot;ping -f&quot; in my PCs through rb450g). In Cisco kind of measurement it is 46 kpps total performance or so.</p></blockquote></div><p>Thanks for your testing. Do you see the same performance on the single eth0 port?</p></blockquote></div><p>What do You mean on &quot;single eth0 port&quot; ? To create eth0.2 and eth0.3 and to do tests from eth0.2 to eth0.3 and vice versa ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104661">
				<div class="post-metadata">
					<div class="post-num">Post #69</div>
					<div class="post-author">KanjiMonster</div>
					<div class="post-datetime">
						15 Mar 2010, 13:29					</div>
				</div>
				<div class="post-content content">
					<p>I mean the wan port (&quot;eth1&quot;?, the switch port 5). It would be interesting to know whether there is a difference in packets/s between the single wan port and going through the switch.</p><p><strong>Finally figured out how to use the whole VID range <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile"/></strong></p><p>Using the example for the separate interfaces for the ports:<br/></p><div class="codebox"><pre><code>config interface loopback
        option ifname   lo
        option proto    static
        option ipaddr   127.0.0.1
        option netmask  255.0.0.0

config interface port1
        option ifname   &quot;eth1.100&quot;
        option proto    static
        option ipaddr   192.168.1.1
        option netmask  255.255.255.0

config interface port2
        option ifname   &quot;eth1.200&quot;
        option proto    static
        option ipaddr   192.168.2.1
        option netmask  255.255.255.0

config interface port3
        option ifname   &quot;eth1.300&quot;
        option proto    static
        option ipaddr   192.168.3.1
        option netmask  255.255.255.0

config interface port4
        option ifname   &quot;eth1.400&quot;
        option proto    static
        option ipaddr   192.168.4.1
        option netmask  255.255.255.0

config interface wan
        option ifname   eth0
        option proto    dhcp

config switch eth1
        option name     eth1
        option reset    1
        option enable_vlan 1

config switch_vlan
        option device   eth1
        option vlan     1
        option pvid     100
        option ports    &quot;0t 1&quot;

config switch_vlan
        option device   eth1
        option vlan     2
        option pvid     200
        option ports    &quot;0t 2&quot;

config switch_vlan
        option device   eth1
        option vlan     3
        option pvid     300
        option ports    &quot;0t 3&quot;

config switch_vlan
        option device   eth1
        option vlan     4
        option pvid     400
        option ports    &quot;0t 4&quot;</code></pre></div><p>This was too obvious.</p><p>So now the MAX_VLANS really *is* the maximum number of entries on the vlan table, not the highest VID.</p><p>KM</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104668">
				<div class="post-metadata">
					<div class="post-num">Post #70</div>
					<div class="post-author">warm</div>
					<div class="post-datetime">
						15 Mar 2010, 14:51					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>KanjiMonster wrote:</cite><blockquote><p>I mean the wan port (&quot;eth1&quot;?, the switch port 5). It would be interesting to know whether there is a difference in packets/s between the single wan port and going through the switch.</p><p><strong>Finally figured out how to use the whole VID range <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile"/></strong></p><p>Using the example for the separate interfaces for the ports:<br/></p><div class="codebox"><pre><code>config interface loopback
        option ifname   lo
        option proto    static
        option ipaddr   127.0.0.1
        option netmask  255.0.0.0

config interface port1
        option ifname   &quot;eth1.100&quot;
        option proto    static
        option ipaddr   192.168.1.1
        option netmask  255.255.255.0

config interface port2
        option ifname   &quot;eth1.200&quot;
        option proto    static
        option ipaddr   192.168.2.1
        option netmask  255.255.255.0

config interface port3
        option ifname   &quot;eth1.300&quot;
        option proto    static
        option ipaddr   192.168.3.1
        option netmask  255.255.255.0

config interface port4
        option ifname   &quot;eth1.400&quot;
        option proto    static
        option ipaddr   192.168.4.1
        option netmask  255.255.255.0

config interface wan
        option ifname   eth0
        option proto    dhcp

config switch eth1
        option name     eth1
        option reset    1
        option enable_vlan 1

config switch_vlan
        option device   eth1
        option vlan     1
        option pvid     100
        option ports    &quot;0t 1&quot;

config switch_vlan
        option device   eth1
        option vlan     2
        option pvid     200
        option ports    &quot;0t 2&quot;

config switch_vlan
        option device   eth1
        option vlan     3
        option pvid     300
        option ports    &quot;0t 3&quot;

config switch_vlan
        option device   eth1
        option vlan     4
        option pvid     400
        option ports    &quot;0t 4&quot;</code></pre></div><p>This was too obvious.</p><p>So now the MAX_VLANS really *is* the maximum number of entries on the vlan table, not the highest VID.</p><p>KM</p></blockquote></div><p>exactly this config does not work on my rb450g but it works without one zerro on pvid (10-40):-). Interface with wlan 40 works but with 100,200...400 no.</p><p>I find that I have different PCs on my tests so that is why results are different by direction. Now I always used one machine like iperf client (send traffic) and other like receiver. Resalts was the same regardless direction. I.e. eth1.10-&gt;eth1.40 = eth1.40-&gt;eth1.10 = 500Mbit.</p><p>So I have bad hardware to test gigabit :-).</p>											<p class="post-edited">(Last edited by <strong>warm</strong> on 15 Mar 2010, 14:52)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104669">
				<div class="post-metadata">
					<div class="post-num">Post #71</div>
					<div class="post-author">KanjiMonster</div>
					<div class="post-datetime">
						15 Mar 2010, 15:10					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>warm wrote:</cite><blockquote><p>exactly this config does not work on my rb450g but it works without one zerro on pvid (10-40):-). Interface with wlan 40 works but with 100,200...400 no.</p></blockquote></div><p>Mh, strange, its working fine on my routerstation (with one interface less of course).</p><p>I noticed that it doesn&#039;t always clean up correctly (sometimes there are still some bridges to remove with brctl, or there are still vlans configured) after changing /etc/config/network, and network stop &amp;&amp; network start isn&#039;t the same as network restart (the switch gets only reconfigured when restarting).</p><p>KM</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104676">
				<div class="post-metadata">
					<div class="post-num">Post #72</div>
					<div class="post-author">warm</div>
					<div class="post-datetime">
						15 Mar 2010, 17:50					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>KanjiMonster wrote:</cite><blockquote><p>Mh, strange, its working fine on my routerstation (with one interface less of course).</p><p>I noticed that it doesn&#039;t always clean up correctly (sometimes there are still some bridges to remove with brctl, or there are still vlans configured) after changing /etc/config/network, and network stop &amp;&amp; network start isn&#039;t the same as network restart (the switch gets only reconfigured when restarting).</p><p>KM</p></blockquote></div><p>Yes, now it works *after reboot* but I rebooted router in a first time too ... may be I did mistake somewhere in configs when tried first time. Also I noticed that output of &quot;swconfig dev eth1 show&quot; does not change after network stop and network start, it changes only after reboot.</p><p>All of this not so important, the main point is that router works :-). Is it time to include Your rare patches in trunk ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104695">
				<div class="post-metadata">
					<div class="post-num">Post #73</div>
					<div class="post-author">KanjiMonster</div>
					<div class="post-datetime">
						16 Mar 2010, 02:28					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>warm wrote:</cite><blockquote><p>Yes, now it works *after reboot* but I rebooted router in a first time too ... may be I did mistake somewhere in configs when tried first time. Also I noticed that output of &quot;swconfig dev eth1 show&quot; does not change after network stop and network start, it changes only after reboot.</p></blockquote></div><p>You were probably bitten by the problem that /etc/init.d/network start doesn&#039;t call setup_switch. This was fixed by nbd today.</p><div class="quotebox"><cite>warm wrote:</cite><blockquote><p>Is it time to include Your rare patches in trunk ?</p></blockquote></div><p>My plan is to do a sort-of release candidate (with cleaned up source) tomorrow here, for final testing. I&#039;ll be away till sunday (leipzig book fair), and if I come back and there are no further complains (or only minor ;-), I&#039;ll post it to openwrt-devel (in hope for some ar8216 testing). Then it (hopefully) shouldn&#039;t take long until the patches gets applied to trunk.</p><p>KM</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104696">
				<div class="post-metadata">
					<div class="post-num">Post #74</div>
					<div class="post-author">rabinnh</div>
					<div class="post-datetime">
						16 Mar 2010, 02:37					</div>
				</div>
				<div class="post-content content">
					<p>Kanji,</p><p>Thanks for all the hard work.</p><p>Which version of the kernel do I apply your patch to?&nbsp; I had a build tree with 2.6.30 and some of them didn&#039;t get applied.</p><p>Thanks,<br/>rabinnh</p><p>BTW, when they do go in the trunk, maybe we could actually have a Mikrotik/RB450G target ;-)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104697">
				<div class="post-metadata">
					<div class="post-num">Post #75</div>
					<div class="post-author">KanjiMonster</div>
					<div class="post-datetime">
						16 Mar 2010, 02:49					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>rabinnh wrote:</cite><blockquote><p>Which version of the kernel do I apply your patch to?&nbsp; I had a build tree with 2.6.30 and some of them didn&#039;t get applied.</p></blockquote></div><p>No kernel version specific except the config-* modifications, which only add the line<br/></p><div class="codebox"><pre><code>CONFIG_AR8216_PHY=y</code></pre></div><p>and thats all.</p><p>Everything else shouldn&#039;t depend on the kernel version.</p><p>KM</p>									</div>
			</article>

			
		
						<div class="notice">
				<p>Sorry, posts 76 to 75 are missing from our archive.</p>
			</div>
		
		
	
	<div class="pagination"><div class="pagination-number">Page 3 of 9</div><nav><ul><li><a href="viewtopic.php%3Fid=21837&amp;p=1.html">1</a></li><li><a href="viewtopic.php%3Fid=21837&amp;p=2.html">2</a></li><li class="pagination-current"><span>3</span></li><li><a href="viewtopic.php%3Fid=21837&amp;p=4.html">4</a></li><li><a href="viewtopic.php%3Fid=21837&amp;p=5.html">5</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=21837&amp;p=9.html">9</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>