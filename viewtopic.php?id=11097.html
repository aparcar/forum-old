<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> openvpn server mode almost works...</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 28 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p50105">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">compi</div>
					<div class="post-datetime">
						9 Jun 2007, 02:03					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>I&#039;m trying to implement an openvpn server on my wrt54g, and i&#039;m really almost there</p><p>I copied all the keys, and config files from my previously working debian based firewall pc, and the openvpn channel seems to work fine.</p><p>LAN is the usual 192.168.1.0/24 and i selected 192.168.31.0/24 for openvpn addresses. The connection builds up fine from the client and i can see the router on both 192.168.1.1 and 192.168.31.1 but that&#039;s all. Pinging machines on the LAN does not work, however if I&#039;m receiving Destination Host Unreachable from 192.168.31.1 (the router&#039;s tun0 interface address)</p><p>Here is my server.conf:<br /></p><div class="codebox"><pre><code>port 1194
proto udp

dev tun

ca ca.crt
cert compi.dyndns.org.crt
key compi.dyndns.org.key  # This file should be kept secret
dh dh1024.pem

server 192.168.31.0 255.255.255.0

ifconfig-pool-persist ipp.txt

push &quot;route 192.168.1.0 255.255.255.0&quot;

client-to-client

keepalive 10 120
comp-lzo
user nobody
group nogroup
persist-key
persist-tun
status openvpn-status.log
verb 3</code></pre></div><p>my firewall.user:<br /></p><div class="codebox"><pre><code>#!/bin/sh
# Copyright (C) 2006 OpenWrt.org

iptables -F input_rule
iptables -F output_rule
iptables -F forwarding_rule
iptables -t nat -F prerouting_rule
iptables -t nat -F postrouting_rule

# The following chains are for traffic directed at the IP of the
# WAN interface

iptables -F input_wan
iptables -F forwarding_wan
iptables -t nat -F prerouting_wan

### Open port to WAN
## -- This allows port 22 to be answered by (dropbear on) the router
iptables -t nat -A prerouting_wan -p tcp --dport 22 -j ACCEPT
iptables        -A input_wan      -p tcp --dport 22 -j ACCEPT

### OpenVPN
## allow connections from outside
iptables -t nat -A prerouting_wan -p udp --dport 1194 -j ACCEPT
iptables        -A input_wan      -p udp --dport 1194 -j ACCEPT

iptables -A INPUT   -i tun+ -j ACCEPT
iptables -A FORWARD -i tun+ -j ACCEPT
iptables -A INPUT   -i tap+ -j ACCEPT
iptables -A FORWARD -i tap+ -j ACCEPT

### Port forwarding
## -- This forwards port 8080 on the WAN to port 80 on 192.168.1.2
# iptables -t nat -A prerouting_wan -p tcp --dport 8080 -j DNAT --to 192.168.1.2:80
# iptables        -A forwarding_wan -p tcp --dport 80 -d 192.168.1.2 -j ACCEPT

### DMZ
## -- Connections to ports not handled above will be forwarded to 192.168.1.2
iptables -t nat -A prerouting_wan -j DNAT --to 192.168.1.2
iptables        -A forwarding_wan -d 192.168.1.2 -j ACCEPT</code></pre></div><p>And on the end here are the iptables rules as dumped by iptables-save:<br /></p><div class="codebox"><pre><code># Generated by iptables-save v1.3.3 on Fri Jun  8 23:00:07 2007
*nat
:NEW - [0:0]
:PREROUTING ACCEPT [80:6750]
:POSTROUTING ACCEPT [5:1714]
:OUTPUT ACCEPT [7:1429]
:postrouting_rule - [0:0]
:prerouting_rule - [0:0]
:prerouting_wan - [0:0]
-A NEW -m limit --limit 50/sec --limit-burst 100 -j RETURN 
-A NEW -j DROP 
-A PREROUTING -m state --state NEW -j NEW 
-A PREROUTING -j prerouting_rule 
-A PREROUTING -i vlan1 -j prerouting_wan 
-A POSTROUTING -j postrouting_rule 
-A POSTROUTING -o vlan1 -j MASQUERADE 
-A prerouting_wan -p tcp -m tcp --dport 22 -j ACCEPT 
-A prerouting_wan -p udp -m udp --dport 1194 -j ACCEPT 
-A prerouting_wan -j DNAT --to-destination 192.168.1.2 
COMMIT
# Completed on Fri Jun  8 23:00:07 2007
# Generated by iptables-save v1.3.3 on Fri Jun  8 23:00:07 2007
*mangle
:PREROUTING ACCEPT [1053:151837]
:INPUT ACCEPT [784:82831]
:FORWARD ACCEPT [211:59588]
:OUTPUT ACCEPT [668:111316]
:POSTROUTING ACCEPT [883:175957]
COMMIT
# Completed on Fri Jun  8 23:00:07 2007
# Generated by iptables-save v1.3.3 on Fri Jun  8 23:00:07 2007
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:LAN_ACCEPT - [0:0]
:OUTPUT DROP [0:0]
:forwarding_rule - [0:0]
:forwarding_wan - [0:0]
:input_rule - [0:0]
:input_wan - [0:0]
:output_rule - [0:0]
-A INPUT -m state --state INVALID -j DROP 
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT 
-A INPUT -p tcp -m tcp ! --tcp-option 2 --tcp-flags SYN SYN -j DROP 
-A INPUT -j input_rule 
-A INPUT -i vlan1 -j input_wan 
-A INPUT -j LAN_ACCEPT 
-A INPUT -p icmp -j ACCEPT 
-A INPUT -p gre -j ACCEPT 
-A INPUT -p tcp -j REJECT --reject-with tcp-reset 
-A INPUT -j REJECT --reject-with icmp-port-unreachable 
-A INPUT -i tun+ -j ACCEPT 
-A INPUT -i tap+ -j ACCEPT 
-A FORWARD -m state --state INVALID -j DROP 
-A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu 
-A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT 
-A FORWARD -j forwarding_rule 
-A FORWARD -i vlan1 -j forwarding_wan 
-A FORWARD -i br0 -o br0 -j ACCEPT 
-A FORWARD -i br0 -o vlan1 -j ACCEPT 
-A FORWARD -i tun+ -j ACCEPT 
-A FORWARD -i tap+ -j ACCEPT 
-A LAN_ACCEPT -i vlan1 -j RETURN 
-A LAN_ACCEPT -j ACCEPT 
-A OUTPUT -m state --state INVALID -j DROP 
-A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT 
-A OUTPUT -j output_rule 
-A OUTPUT -j ACCEPT 
-A OUTPUT -p tcp -j REJECT --reject-with tcp-reset 
-A OUTPUT -j REJECT --reject-with icmp-port-unreachable 
-A forwarding_wan -d 192.168.1.2 -j ACCEPT 
-A input_wan -p tcp -m tcp --dport 22 -j ACCEPT 
-A input_wan -p udp -m udp --dport 1194 -j ACCEPT 
COMMIT
# Completed on Fri Jun  8 23:00:07 2007</code></pre></div><p>the whole setup is based on <a href="http://wiki.openwrt.org/OpenVPNTunHowTo#head-e281b0ebfec1473ce2aa6403c662e001d5668d58">http://wiki.openwrt.org/OpenVPNTunHowTo â€¦ 01d5668d58</a></p><p>I&#039;m quite sure that the problem should be somewhere in the iptables rules, but i cannot find myself what did I do wrong.</p><p>Thanks in advance,</p><p>compi</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50114">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Bill_MI</div>
					<div class="post-datetime">
						9 Jun 2007, 06:08					</div>
				</div>
				<div class="post-content content">
					<p>Hi Compi,</p><p>There&#039;s a lot of ways to set up networks but I&#039;m reading between the lines that you want OpenVPN clients to access your LAN from the outside world coming in to the WRT54G WAN address... correct?</p><p>If so, you need to run *bridging* mode.&nbsp; The Wiki page you referenced has a link about bridging that may help.&nbsp; It says little about the fact it connects to the router but nowhere else - which is what you&#039;re getting.&nbsp; I think this may help...</p><p>In bridging mode the &#039;server&#039; line becomes a &#039;server-bridge&#039; line with most parameters - but clients get assigned regular LAN addresses (no need for 10.* or your 192.168.31 addresses).&nbsp; These are all on this server-bridge line.</p><p>The tap0 interface is typically created, bridged to the LAN and enabled in startup scripts.</p><p>I have a configuration I&#039;ve been using for over a year now that works in the fashion I describe:<br /><a href="http://forum.openwrt.org/viewtopic.php?id=9609">http://forum.openwrt.org/viewtopic.php?id=9609</a></p><p>Hope this helps</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50121">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">compi</div>
					<div class="post-datetime">
						9 Jun 2007, 10:26					</div>
				</div>
				<div class="post-content content">
					<p>Hi Bill,<br /></p><div class="quotebox"><cite>Bill_MI wrote:</cite><blockquote><p>There&#039;s a lot of ways to set up networks but I&#039;m reading between the lines that you want OpenVPN clients to access your LAN from the outside world coming in to the WRT54G WAN address... correct?</p></blockquote></div><p>That&#039;s the first part of the business. The second part is probably even more important: I want to be able to access the client (e.g my workstation at my workplace) from home. According the topology you&#039;re right, there is a subnet of 192.168.1.0/24 on the LAN i want to access, and y want to access the clients from.</p><div class="quotebox"><cite>Bil_MI wrote:</cite><blockquote><p>If so, you need to run *bridging* mode.&nbsp; The Wiki page you referenced has a link about bridging that may help.</p></blockquote></div><p>Bridging mode is surely one option, but in my case it is only an emergency route. I had a working routed mode setup on my previous&nbsp; debian based firewall and I&#039;d like to implement the same at first place, as I understand routing a lot better than bridging.<br /></p><div class="quotebox"><cite>Bill_MI wrote:</cite><blockquote><p>It says little about the fact it connects to the router but nowhere else - which is what you&#039;re getting.&nbsp; I think this may help...</p></blockquote></div><p>In the example config file on the wiki you can find:<br /></p><div class="quotebox"><blockquote><p>### (optional) make local network behind the VPN server accessible for the VPN clients<br />push &quot;route 192.168.1.0 255.255.255.0&quot;</p></blockquote></div><p>And there is also a paragraph about troubleshooting if the network behind the LAN not accessible from clients. And i had the same topology on my previous PC based firewall, so it should work I suppose. I suppose the routing is right : wrt54g leg of the vpn responds Destination Host Unreachable if i try to reach an IP with no computer behind it on the LAN, and this message stops as soon as I switch that PC on. I also verified the routing tables on both sides and they&#039;re fine, ip_forward is 1. Only one step remained which is a little bit over-complicated in WhiteRussian IMHO: iptables.</p><div class="quotebox"><cite>Bil_MI wrote:</cite><blockquote><p>In bridging mode the &#039;server&#039; line becomes a &#039;server-bridge&#039; line with most parameters - but clients get assigned regular LAN addresses (no need for 10.* or your 192.168.31 addresses).&nbsp; These are all on this server-bridge line.</p><p>The tap0 interface is typically created, bridged to the LAN and enabled in startup scripts.</p><p>I have a configuration I&#039;ve been using for over a year now that works in the fashion I describe:<br /><a href="http://forum.openwrt.org/viewtopic.php?id=9609">http://forum.openwrt.org/viewtopic.php?id=9609</a></p><p>Hope this helps</p></blockquote></div><p>Thanks, if the routed mode fails I&#039;ll go that way, but I cannot simply give it up without finding the reason.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50134">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">Bill_MI</div>
					<div class="post-datetime">
						9 Jun 2007, 15:56					</div>
				</div>
				<div class="post-content content">
					<p>Understood, Compi.&nbsp; This is far more tap/tun routing rules exercise which I&#039;ve avoided entirely with the simplicity of bridging. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50162">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">compi</div>
					<div class="post-datetime">
						10 Jun 2007, 02:23					</div>
				</div>
				<div class="post-content content">
					<p>just for those will have the same problem in the future:</p><p>Rules suggested to be inserted into firewall.user are far not enough. The wiki suggests these:</p><div class="codebox"><pre><code>iptables -A INPUT   -i tun+ -j ACCEPT
iptables -A FORWARD -i tun+ -j ACCEPT
iptables -A INPUT   -i tap+ -j ACCEPT
iptables -A FORWARD -i tap+ -j ACCEPT</code></pre></div><p>First of all, tap devices are used in bridged mode, routed mode uses only tun, hence tap rules are needless. Tun rules are incomplete. The correct rules are:<br /></p><div class="codebox"><pre><code>iptables -A INPUT   -i tun+ -j ACCEPT
iptables -A FORWARD -i tun+ -j ACCEPT
iptables -A FORWARD -o tun+ -j ACCEPT
iptables -A OUTPUT  -o tun+ -j ACCEPT</code></pre></div><p>After adding the two missing rule to my firewall.user, my routed mode vpn works flawlessly.</p><p>Thanks for the support and would someone correct the wiki please?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p53277">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">maddes.b</div>
					<div class="post-datetime">
						2 Aug 2007, 17:02					</div>
				</div>
				<div class="post-content content">
					<p>Hello compi,</p><p>I&#039;m one of the contributors of the TUN wiki page. The iptables definitions were taken from the original OpenVPN page.</p><p>Today I also experienced this problem (finally really using the VPN).<br />My assumption was that outgoing rules are missing and searched the forum.<br />So thanks for finding and testing the additional iptables definition.</p><p>Btw you&#039;re welcome to contribute to the wiki pages and correct this stuff yourself.<br />Everybody is allowed to register for the wiki and then edit or create new pages.<br />I will update the wiki page with your data. </p><p>Kind regards<br />Maddes</p>											<p class="post-edited">(Last edited by <strong>maddes.b</strong> on 2 Aug 2007, 17:06)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>