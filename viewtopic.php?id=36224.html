<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Packages over ip-rule table never reaching iptables postrouting chains</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 20 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p164609">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">cinober</div>
					<div class="post-datetime">
						16 Apr 2012, 00:08					</div>
				</div>
				<div class="post-content content">
					<p>or <br />Several international lans ipaliased on the same segment almost working.</p><p>I have spend quite some time after upgrading my network from ASUS<br />WL500gp-kamikaze to Netgear WNDR3800-Backfire-10.03.1 trying to config<br />several lans in paralel: one for most of the trafic as by default and a<br />couple of others to other countries to friends, providing eachother<br />public IP-TV. The problem started when I attempted to run iptables<br />postrouting masquerade for one ot the openvpn networks which provided<br />public IP of <a href="http://www.swissvpn.net">www.swissvpn.net</a>.</p><p>after all that hard work, when I was allmost done, I find out that<br />packets from ip-aliased lan that is supposed to connect over<br />openvpn masqueraded are never reaching the postrouting iptables where<br />they are to be masqueraded.</p><p>tcpdump to destination archive.ubintu.com from xen virtual machine<br />running &quot;apt-get update&quot; with<br />manually assigned C class address to route over swissvpn.net shows<br />packages leaving on tun2 interface with private source address (not<br />masqueraded). The same can be seen on counters on masquerading rule,<br />like no packages ever reached there.</p><p>Why are the packages routed over special ip-rule table never reaching<br />iptables postrouting chains?<br />Is is general linux-ip rule-iptables deficiency (very hard to beleive)?<br />Is it some config option missing in openwrt kernels?<br />Did I brake something in my config?</p><p>It has been very long time since I got such a wierd supprise using<br />linux-openwrt. So much hard work waisted, blocked by this last simple<br />small masquerading issue :-( .</p><p>I could run an extra x86 openvpn xen virtual machine just for this<br />swissvpn.net openvpn connection, without ip-rule. It works if I want<br />to route all traphic over vpn on Netgear WNDR3800 also, but it really<br />feells such a waist of resources, makes no sense.</p><p>Should I open a bugticket even if it might not be an openwrt bug?<br />I know this by far is no everyday question but I still hope somebody<br />will find it interesting enough to look into it.</p><br /><p>Sincerely yours<br />Cinober</p><p>=====<br />root@Iam:/etc# uci show network| sed -n &#039;/alias/,$ p&#039;<br />network.slan=alias<br />network.slan.interface=lan<br />network.slan.proto=static<br />network.slan.ipaddr=192.168.69.254<br />network.slan.netmask=255.255.255.0<br />network.swan=interface<br />network.swan.ifname=tun2<br />network.swan.proto=none</p><p>root@Iam:~# ip rule<br />0:&nbsp; &nbsp; &nbsp; from all lookup local<br />32764:&nbsp; from all to 192.168.69.0/24 lookup sw<br />32765:&nbsp; from 192.168.69.0/24 lookup sw<br />32766:&nbsp; from all lookup main<br />32767:&nbsp; from all lookup default</p><p>root@Iam:~# ip route list table sw<br />94.221.224.1 dev pppoe-wan&nbsp; scope link&nbsp; src 94.221.252.72<br />80.254.79.87 via 94.221.224.1 dev pppoe-wan<br />80.254.79.101 via 94.221.224.1 dev pppoe-wan<br />80.254.76.128/25 dev tun2&nbsp; scope link&nbsp; src 80.254.76.241<br />192.168.69.0/24 dev br-lan&nbsp; scope link&nbsp; src 192.168.69.254<br />127.0.0.0/8 dev lo&nbsp; scope link<br />default via 80.254.76.129 dev tun2</p><p>root@Iam:~# uci show openvpn.sw<br />openvpn.sw=openvpn<br />openvpn.sw.config=/etc/openvpn/swissvpn.ovpn<br />openvpn.sw.auth_user_pass=/etc/openvpn/swissvpn.acct<br />openvpn.sw.script_security=2<br />openvpn.sw.route_up=/etc/openvpn/sw.route_up<br />openvpn.sw.enable=1</p><p>root@Iam:~# cat /etc/openvpn/swissvpn.ovpn<br />dev tun2<br />client<br />proto tcp-client<br />remote connect-openvpn.swissvpn.net 443<br />ca /etc/openvpn/ca.swissvpn.crt<br />auth-user-pass /etc/openvpn/swissvpn.acct<br />reneg-sec 86400<br />ns-cert-type server</p><p>root@Iam:~# cat /etc/openvpn/swissvpn.acct<br />username<br />userPassword</p><p>=== BEGIN === /etc/openvpn/sw.route_up<br />#!/bin/sh -x<br /># sw.route_up<br /># opkg list_installed|grep -q &#039;^ip - &#039; || opkg install ip</p><p>local publicdns<br />#publicdns=&quot;8.8.8.8 8.8.4.4&quot;&nbsp; # google-public-dns-a.google.com google-public-dns-b.google.com</p><p>###clear default route redirection from openvpn 2.1...<br />#ip route delete default via $route_vpn_gateway dev $dev<br />##0.0.0.0/1 via 93.94.245.1 dev tun2&nbsp; #128.0.0.0/1 via 93.94.245.1 dev tun2<br />ip route show table main|grep &quot;^0.0.0.0/1 via $route_vpn_gateway dev $dev&quot; &amp;&amp; \<br />&nbsp; &nbsp; &nbsp; &nbsp; ip route del 0.0.0.0/1 via $route_vpn_gateway dev $dev table main<br />ip route show table main|grep &quot;^128.0.0.0/1 via $route_vpn_gateway dev $dev&quot; &amp;&amp; \<br />&nbsp; &nbsp; &nbsp; &nbsp; ip route del 128.0.0.0/1 via $route_vpn_gateway dev $dev table main</p><p>### Add new route table named same as net&nbsp; if missing<br />local net=$(echo $0|sed &#039;s|/etc/openvpn/||;s|\.route_up||&#039;) #local net=sw<br />grep -q &quot;^1 $net$&quot; /etc/iproute2/rt_tables || \<br />&nbsp; &nbsp; &nbsp; &nbsp; echo &quot;1 $net&quot; &gt;&gt; /etc/iproute2/rt_tables<br />#sed -i &quot;/^1 $net$/d&quot; /etc/iproute2/rt_tables<br />### Fix vpn default route routing table<br />local slan=slan<br />SLANIP=$(uci get network.$slan.ipaddr)<br />local slannet=$(ipcalc.sh $SLANIP $(uci get network.$slan.netmask)| \<br />&nbsp; &nbsp; &nbsp; &nbsp; sed -n &#039;/NETWORK=/{N;s/NETWORK=//;s/.PREFIX=/\//p;}&#039;)<br />###?###ip route add $slannet dev $dev src $ifconfig_local&nbsp; &nbsp; table $net<br />#80.254.79.87 via 92.72.16.1 dev pppoe-wan<br />###92.72.16.1 dev pppoe-wan&nbsp; proto kernel&nbsp; scope link&nbsp; src 92.72.29.196<br />#80.254.76.128/25 dev tun2&nbsp; proto kernel&nbsp; scope link&nbsp; src 80.254.76.197<br />###192.168.69.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.69.254<br />###192.168.100.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.100.254<br />###default via 92.72.16.1 dev pppoe-wan<br />#ip route del $slannet dev br-lan&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src $SLANIP table $net<br />#ip&nbsp; route add $slannet dev br-lan&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src $SLANIP table $net<br />local WANIF=$(uci -P/var/state get network.wan.ifname)<br />local WANIP=$(uci -P/var/state get network.wan.ipaddr)<br />local swnet=$(ipcalc.sh $ifconfig_local $ifconfig_netmask | \<br />&nbsp; &nbsp; &nbsp; &nbsp; sed -n &#039;/NETWORK=/{N;s/NETWORK=//;s/.PREFIX=/\//p;}&#039;)<br />ip&nbsp; route add $trusted_ip via $route_net_gateway dev $WANIF&nbsp; &nbsp; table $net<br />ip&nbsp; route add $route_net_gateway dev $WANIF src $WANIP&nbsp; &nbsp; table $net<br />ip&nbsp; route add $swnet dev $dev&nbsp; src $ifconfig_local&nbsp; &nbsp; table $net<br />ip&nbsp; route add $slannet dev br-lan&nbsp; src $SLANIP&nbsp; &nbsp; table $net<br />ip&nbsp; route add 127.0.0.0/8 dev lo&nbsp; &nbsp;table $net<br />echo ip&nbsp; route add $slannet dev br-lan&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src $SLANIP table $net &gt;&gt; \<br />&nbsp; &nbsp; &nbsp; &nbsp; /tmp/sw.route_up.log</p><p>#ip route add $slannet dev br-lan proto kernel src $SLANIP table $net<br />ip route add default via $route_vpn_gateway dev $dev&nbsp; table $net</p><p>### Add rules for new table<br />#32756:&nbsp; from all to 192.168.69.0/24 lookup sw<br />#32757:&nbsp; from 192.168.69.0/24 lookup sw<br />ip rule|grep -q &quot;from $slannet lookup $net *$&quot; || \<br />&nbsp; &nbsp; &nbsp; &nbsp; ip rule add from $slannet&nbsp; table $net<br />ip rule|grep -q &quot;from all to $slannet lookup $net *$&quot; || \<br />&nbsp; &nbsp; &nbsp; &nbsp; ip rule add to&nbsp; &nbsp;$slannet&nbsp; table $net</p><p>### Add assigned dns servers for vpn lan-s dnsmasq server<br />local nsno=$(uci show dhcp|sed -n &quot;s/dhcp.\@dnsmasq\[//; s/\]\.domain=$net\..*//p&quot;)<br />local cfg=$(uci show -X dhcp.@dnsmasq[$nsno]|sed -n &#039;s/^dhcp.//;s/=dnsmasq$//p&#039;)<br />local nsip<br />for nsip in $(set|sed -n &quot;s/&#039;$//;s/foreign_option_[0-9][0-9]*=&#039;//;s/dhcp-option DNS //p&quot;) $publicdns; do<br />&nbsp; &nbsp; &nbsp; &nbsp; grep -q &quot;nameserver $nsip$&quot; /tmp/resolv.$cfg.conf || \<br />&nbsp; &nbsp; &nbsp; &nbsp; echo nameserver $nsip &gt;&gt;/tmp/resolv.$cfg.conf<br />done</p><p>/bin/date &gt;&gt; /tmp/sw.route_up.log;set &gt;&gt; /tmp/sw.route_up.log</p><p>=== END ===</p><br /><p>=== BEGIN === /etc/firewall.user<br />### Allow OpenVPN connections<br />iptables -t nat -A prerouting_wan -p udp --dport 1194 -j ACCEPT<br />iptables&nbsp; &nbsp; &nbsp; &nbsp; -A input_wan&nbsp; &nbsp; &nbsp; -p udp --dport 1194 -j ACCEPT</p><p>iptables -A input_rule -i tun+ -j ACCEPT<br />iptables -A forwarding_rule -i tun+ -j ACCEPT<br />iptables -A forwarding_rule -o tun+ -j ACCEPT<br />iptables -A output_rule -o tun+ -j ACCEPT</p><p># Masquerade default route thorough tun0<br />iptables -t nat -A POSTROUTING -o tun+ -s 192.168.69.0/24 -j MASQUERADE</p><p>=== END ===</p><p>root@Iam:/etc# uci show dhcp| grep &quot;dnsmasq\[&quot;<br />dhcp.@dnsmasq[0]=dnsmasq<br />dhcp.@dnsmasq[0].domainneeded=1<br />dhcp.@dnsmasq[0].boguspriv=1<br />dhcp.@dnsmasq[0].filterwin2k=0<br />dhcp.@dnsmasq[0].localise_queries=1<br />dhcp.@dnsmasq[0].rebind_protection=1<br />dhcp.@dnsmasq[0].rebind_localhost=1<br />dhcp.@dnsmasq[0].expandhosts=1<br />dhcp.@dnsmasq[0].nonegcache=0<br />dhcp.@dnsmasq[0].authoritative=1<br />dhcp.@dnsmasq[0].readethers=1<br />dhcp.@dnsmasq[0].leasefile=/tmp/dhcp.leases<br />dhcp.@dnsmasq[0].domain=iam.lan<br />dhcp.@dnsmasq[0].local=/iam.lan/<br />dhcp.@dnsmasq[0].listen_address=127.0.0.1 192.168.100.254<br />dhcp.@dnsmasq[0].nonwildcard=1<br />dhcp.@dnsmasq[0].cachelocal=0<br />dhcp.@dnsmasq[0].resolvfile=/tmp/resolv.conf.auto<br />dhcp.@dnsmasq[1]=dnsmasq<br />dhcp.@dnsmasq[1].domainneeded=1<br />dhcp.@dnsmasq[1].boguspriv=1<br />dhcp.@dnsmasq[1].filterwin2k=1<br />dhcp.@dnsmasq[1].localise_queries=1<br />dhcp.@dnsmasq[1].rebind_protection=1<br />dhcp.@dnsmasq[1].expandhosts=1<br />dhcp.@dnsmasq[1].nonegcache=0<br />dhcp.@dnsmasq[1].domain=sw.lan<br />dhcp.@dnsmasq[1].local=/sw.lan/<br />dhcp.@dnsmasq[1].nonwildcard=1<br />dhcp.@dnsmasq[1].listen_address=192.168.69.254<br />dhcp.@dnsmasq[1].no_dhcp_interface=br-slan localhost<br />dhcp.@dnsmasq[1].leasefile=/tmp/dhcp.leases.sw<br />dhcp.@dnsmasq[1].cachelocal=0<br />dhcp.@dnsmasq[1].rebind_localhost=0</p><p>root@Iam:/etc# netstat&nbsp; -l -u<br />Active Internet connections (only servers)<br />Proto Recv-Q Send-Q Local Address&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Foreign Address&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;State<br />udp&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0 0.0.0.0:11&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:*<br />udp&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0 192.168.69.254:domain&nbsp; &nbsp;0.0.0.0:*<br />udp&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0 localhost.:domain&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0:*<br />udp&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0 iam.iam.lan:domain&nbsp; &nbsp; &nbsp; 0.0.0.0:*<br />udp&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0 0.0.0.0:bootps&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:*<br />udp&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0 0.0.0.0:bootps&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:*<br />udp&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0 0.0.0.0:65102&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0:*<br />netstat: /proc/net/udp6: No such file or directory</p><p>root@Iam:/etc# uci show network| sed -n &#039;/alias/,$ p&#039;<br />network.slan=alias<br />network.slan.interface=lan<br />network.slan.proto=static<br />network.slan.ipaddr=192.168.69.254<br />network.slan.netmask=255.255.255.0<br />network.swan=interface<br />network.swan.ifname=tun2<br />network.swan.proto=none</p><p>root@Iam:~# ip rule<br />0:&nbsp; &nbsp; &nbsp; from all lookup local<br />32764:&nbsp; from all to 192.168.69.0/24 lookup sw<br />32765:&nbsp; from 192.168.69.0/24 lookup sw<br />32766:&nbsp; from all lookup main<br />32767:&nbsp; from all lookup default</p><p>root@Iam:~# ip route list table sw<br />94.221.224.1 dev pppoe-wan&nbsp; scope link&nbsp; src 94.221.252.72<br />80.254.79.87 via 94.221.224.1 dev pppoe-wan<br />80.254.79.101 via 94.221.224.1 dev pppoe-wan<br />80.254.76.128/25 dev tun2&nbsp; scope link&nbsp; src 80.254.76.241<br />192.168.69.0/24 dev br-lan&nbsp; scope link&nbsp; src 192.168.69.254<br />127.0.0.0/8 dev lo&nbsp; scope link<br />default via 80.254.76.129 dev tun2</p><p>root@Iam:~# uci show openvpn.sw<br />openvpn.sw=openvpn<br />openvpn.sw.config=/etc/openvpn/swissvpn.ovpn<br />openvpn.sw.auth_user_pass=/etc/openvpn/swissvpn.acct<br />openvpn.sw.script_security=2<br />openvpn.sw.route_up=/etc/openvpn/sw.route_up<br />openvpn.sw.enable=1</p><p>root@Iam:~# cat /etc/openvpn/swissvpn.ovpn<br />dev tun2<br />client<br />proto tcp-client<br />remote connect-openvpn.swissvpn.net 443<br />ca /etc/openvpn/ca.swissvpn.crt<br />auth-user-pass /etc/openvpn/swissvpn.acct<br />reneg-sec 86400<br />ns-cert-type server</p><p>root@Iam:~# cat /etc/openvpn/swissvpn.acct<br />username<br />userPassword</p><p>=== BEGIN === /etc/openvpn/sw.route_up<br />#!/bin/sh -x<br /># sw.route_up<br /># opkg list_installed|grep -q &#039;^ip - &#039; || opkg install ip</p><p>local publicdns<br />#publicdns=&quot;8.8.8.8 8.8.4.4&quot;&nbsp; # google-public-dns-a.google.com google-public-dns-b.google.com</p><p>###clear default route redirection from openvpn 2.1...<br />#ip route delete default via $route_vpn_gateway dev $dev<br />##0.0.0.0/1 via 93.94.245.1 dev tun2&nbsp; #128.0.0.0/1 via 93.94.245.1 dev tun2<br />ip route show table main|grep &quot;^0.0.0.0/1 via $route_vpn_gateway dev $dev&quot; &amp;&amp; \<br />&nbsp; &nbsp; &nbsp; &nbsp; ip route del 0.0.0.0/1 via $route_vpn_gateway dev $dev table main<br />ip route show table main|grep &quot;^128.0.0.0/1 via $route_vpn_gateway dev $dev&quot; &amp;&amp; \<br />&nbsp; &nbsp; &nbsp; &nbsp; ip route del 128.0.0.0/1 via $route_vpn_gateway dev $dev table main</p><p>### Add new route table named same as net&nbsp; if missing<br />local net=$(echo $0|sed &#039;s|/etc/openvpn/||;s|\.route_up||&#039;) #local net=sw<br />grep -q &quot;^1 $net$&quot; /etc/iproute2/rt_tables || \<br />&nbsp; &nbsp; &nbsp; &nbsp; echo &quot;1 $net&quot; &gt;&gt; /etc/iproute2/rt_tables<br />#sed -i &quot;/^1 $net$/d&quot; /etc/iproute2/rt_tables</p><p>### Fix vpn default route routing table<br />local slan=slan<br />SLANIP=$(uci get network.$slan.ipaddr)<br />local slannet=$(ipcalc.sh $SLANIP $(uci get network.$slan.netmask)| \<br />&nbsp; &nbsp; &nbsp; &nbsp; sed -n &#039;/NETWORK=/{N;s/NETWORK=//;s/.PREFIX=/\//p;}&#039;)<br />###?###ip route add $slannet dev $dev src $ifconfig_local&nbsp; &nbsp; table $net<br />#80.254.79.87 via 92.72.16.1 dev pppoe-wan<br />###92.72.16.1 dev pppoe-wan&nbsp; proto kernel&nbsp; scope link&nbsp; src 92.72.29.196<br />#80.254.76.128/25 dev tun2&nbsp; proto kernel&nbsp; scope link&nbsp; src 80.254.76.197<br />###192.168.69.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.69.254<br />###192.168.100.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.100.254<br />###default via 92.72.16.1 dev pppoe-wan<br />#ip route del $slannet dev br-lan&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src $SLANIP table $net<br />#ip&nbsp; route add $slannet dev br-lan&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src $SLANIP table $net<br />local WANIF=$(uci -P/var/state get network.wan.ifname)<br />local WANIP=$(uci -P/var/state get network.wan.ipaddr)<br />local swnet=$(ipcalc.sh $ifconfig_local $ifconfig_netmask | \<br />&nbsp; &nbsp; &nbsp; &nbsp; sed -n &#039;/NETWORK=/{N;s/NETWORK=//;s/.PREFIX=/\//p;}&#039;)<br />ip&nbsp; route add $trusted_ip via $route_net_gateway dev $WANIF&nbsp; &nbsp; table $net<br />ip&nbsp; route add $route_net_gateway dev $WANIF src $WANIP&nbsp; &nbsp; table $net<br />ip&nbsp; route add $swnet dev $dev&nbsp; src $ifconfig_local&nbsp; &nbsp; table $net<br />ip&nbsp; route add $slannet dev br-lan&nbsp; src $SLANIP&nbsp; &nbsp; table $net<br />ip&nbsp; route add 127.0.0.0/8 dev lo&nbsp; &nbsp;table $net<br />echo ip&nbsp; route add $slannet dev br-lan&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src $SLANIP table $net &gt;&gt; \<br />&nbsp; &nbsp; &nbsp; &nbsp; /tmp/sw.route_up.log</p><p>#ip route add $slannet dev br-lan proto kernel src $SLANIP table $net<br />ip route add default via $route_vpn_gateway dev $dev&nbsp; table $net</p><p>### Add rules for new table<br />#32756:&nbsp; from all to 192.168.69.0/24 lookup sw<br />#32757:&nbsp; from 192.168.69.0/24 lookup sw<br />ip rule|grep -q &quot;from $slannet lookup $net *$&quot; || \<br />&nbsp; &nbsp; &nbsp; &nbsp; ip rule add from $slannet&nbsp; table $net<br />ip rule|grep -q &quot;from all to $slannet lookup $net *$&quot; || \<br />&nbsp; &nbsp; &nbsp; &nbsp; ip rule add to&nbsp; &nbsp;$slannet&nbsp; table $net</p><p>### Add assigned dns servers for vpn lan-s dnsmasq server<br />local nsno=$(uci show dhcp|sed -n &quot;s/dhcp.\@dnsmasq\[//; s/\]\.domain=$net\..*//p&quot;)<br />local cfg=$(uci show -X dhcp.@dnsmasq[$nsno]|sed -n &#039;s/^dhcp.//;s/=dnsmasq$//p&#039;)<br />local nsip<br />for nsip in $(set|sed -n &quot;s/&#039;$//;s/foreign_option_[0-9][0-9]*=&#039;//;s/dhcp-option DNS //p&quot;) $publicdns; do<br />&nbsp; &nbsp; &nbsp; &nbsp; grep -q &quot;nameserver $nsip$&quot; /tmp/resolv.$cfg.conf || \<br />&nbsp; &nbsp; &nbsp; &nbsp; echo nameserver $nsip &gt;&gt;/tmp/resolv.$cfg.conf<br />done</p><p>/bin/date &gt;&gt; /tmp/sw.route_up.log;set &gt;&gt; /tmp/sw.route_up.log</p><p>=== END ===</p><br /><p>=== BEGIN === /etc/firewall.user<br />### Allow OpenVPN connections<br />iptables -t nat -A prerouting_wan -p udp --dport 1194 -j ACCEPT<br />iptables&nbsp; &nbsp; &nbsp; &nbsp; -A input_wan&nbsp; &nbsp; &nbsp; -p udp --dport 1194 -j ACCEPT</p><p>iptables -A input_rule -i tun+ -j ACCEPT<br />iptables -A forwarding_rule -i tun+ -j ACCEPT<br />iptables -A forwarding_rule -o tun+ -j ACCEPT<br />iptables -A output_rule -o tun+ -j ACCEPT</p><p># Masquerade default route thorough tun0<br />iptables -t nat -A POSTROUTING -o tun+ -s 192.168.69.0/24 -j MASQUERADE</p><p>=== END ===</p><p>root@Iam:/etc# uci show dhcp| grep &quot;dnsmasq\[&quot;<br />dhcp.@dnsmasq[0]=dnsmasq<br />dhcp.@dnsmasq[0].domainneeded=1<br />dhcp.@dnsmasq[0].boguspriv=1<br />dhcp.@dnsmasq[0].filterwin2k=0<br />dhcp.@dnsmasq[0].localise_queries=1<br />dhcp.@dnsmasq[0].rebind_protection=1<br />dhcp.@dnsmasq[0].rebind_localhost=1<br />dhcp.@dnsmasq[0].expandhosts=1<br />dhcp.@dnsmasq[0].nonegcache=0<br />dhcp.@dnsmasq[0].authoritative=1<br />dhcp.@dnsmasq[0].readethers=1<br />dhcp.@dnsmasq[0].leasefile=/tmp/dhcp.leases<br />dhcp.@dnsmasq[0].domain=iam.lan<br />dhcp.@dnsmasq[0].local=/iam.lan/<br />dhcp.@dnsmasq[0].listen_address=127.0.0.1 192.168.100.254<br />dhcp.@dnsmasq[0].nonwildcard=1<br />dhcp.@dnsmasq[0].cachelocal=0<br />dhcp.@dnsmasq[0].resolvfile=/tmp/resolv.conf.auto<br />dhcp.@dnsmasq[1]=dnsmasq<br />dhcp.@dnsmasq[1].domainneeded=1<br />dhcp.@dnsmasq[1].boguspriv=1<br />dhcp.@dnsmasq[1].filterwin2k=1<br />dhcp.@dnsmasq[1].localise_queries=1<br />dhcp.@dnsmasq[1].rebind_protection=1<br />dhcp.@dnsmasq[1].expandhosts=1<br />dhcp.@dnsmasq[1].nonegcache=0<br />dhcp.@dnsmasq[1].domain=sw.lan<br />dhcp.@dnsmasq[1].local=/sw.lan/<br />dhcp.@dnsmasq[1].nonwildcard=1<br />dhcp.@dnsmasq[1].listen_address=192.168.69.254<br />dhcp.@dnsmasq[1].no_dhcp_interface=br-slan localhost<br />dhcp.@dnsmasq[1].leasefile=/tmp/dhcp.leases.sw<br />dhcp.@dnsmasq[1].cachelocal=0<br />dhcp.@dnsmasq[1].rebind_localhost=0</p><p>=== BEGIN === /etc/init.d/dnsmasq<br />#!/bin/sh /etc/rc.common<br /># Copyright (C) 2007 OpenWrt.org</p><p>NAME=&quot;dnsmasq&quot;<br />PROG=&quot;/usr/sbin/dnsmasq&quot;<br />START=60<br />debug=2</p><p>#FRSTDNS=$(uci -X show dhcp.@dnsmasq[0] | sed -n &#039;s/.*\.\([^=]*\)=dnsmasq/\1/p&#039;)<br />FRSTDNS=$(uci -X show dhcp.@dnsmasq[0] 2&gt;/dev/null|sed -n &#039;s/.*\.\([^=]*\)=dnsmasq/\1/p&#039;)<br />[ &quot;$FRSTDNS&quot; ] || FRSTDNS=$(uci -X show dhcp.@dnsmasq[]|sed -n &#039;s/.*\.\([^=]*\)=dnsmasq/\1/p&#039;)</p><p>dhcp_calc() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local ip=&quot;$1&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; local res=0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; while [ -n &quot;$ip&quot; ]; do<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; part=&quot;${ip%%.*}&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res=&quot;$(($res * 256))&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res=&quot;$(($res + $part))&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ &quot;${ip%.*}&quot; != &quot;$ip&quot; ] &amp;&amp; ip=&quot;${ip#*.}&quot; || ip=<br />&nbsp; &nbsp; &nbsp; &nbsp; done<br />&nbsp; &nbsp; &nbsp; &nbsp; echo &quot;$res&quot;<br />}</p><p>append_bool() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local section=&quot;$1&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; local option=&quot;$2&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; local value=&quot;$3&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; local _loctmp<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get_bool _loctmp &quot;$section&quot; &quot;$option&quot; 0<br />&nbsp; &nbsp; &nbsp; &nbsp; [ $_loctmp -gt 0 ] &amp;&amp; append args &quot;$value&quot;<br />}</p><p>append_parm() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local section=&quot;$1&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; local option=&quot;$2&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; local switch=&quot;$3&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; local default=&quot;$4&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; local _loctmp<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get _loctmp &quot;$section&quot; &quot;$option&quot; &quot;$default&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -z &quot;$_loctmp&quot; ] &amp;&amp; return 0<br />&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;$switch $_loctmp&quot;<br />}</p><p>append_server() {<br />&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;-S $1&quot;<br />}</p><p>append_interface() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local ifname=$(uci_get_state network &quot;$1&quot; ifname &quot;$1&quot;) dnsmasq_instance=&quot;$2&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;-i $ifname&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -z &quot;$debug&quot; ] || echo &quot;DEBUG&nbsp; [$dnsmasq_instance] Listen IF $ifname&quot;<br />}</p><p>append_notinterface() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local ifname=$(uci_get_state network &quot;$1&quot; ifname &quot;$1&quot;) dnsmasq_instance=&quot;$2&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;-I $ifname&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -z &quot;$debug&quot; ] || echo &quot;DEBUG&nbsp; [$dnsmasq_instance] Ignore IF $ifname&quot;<br />}</p><p>append_listen_address() {<br />&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;-a $1&quot;<br />}</p><p>append_no_dhcp_interface() {<br />&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;-2 $1&quot;<br />}</p><p>append_addnhosts() {<br />&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;-H $1&quot;<br />}</p><p>append_bogusnxdomain() {<br />&nbsp; &nbsp; &nbsp; &nbsp;append args &quot;-B $1&quot;<br />}</p><p>dnsmasq() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local cfg=&quot;$1&quot; args=&quot;&quot; resolv fxresolv DNS_SERVER enabled</p><p>&nbsp; &nbsp; &nbsp; &nbsp; local lanaddr<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get lanaddr &quot;lan&quot; ipaddr</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get_bool enabled &quot;$cfg&quot; enabled 1<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$enabled&quot; -eq 0 ] &amp;&amp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo &quot;Setup for dnsmasq: $cfg (disabled)&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp; &nbsp; echo &quot;Setup for dnsmasq: $cfg&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; # reset list of DOMAINS and DNS servers (for each dnsmasq instance)<br />&nbsp; &nbsp; &nbsp; &nbsp; DNS_SERVERS=&quot;&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; DOMAIN=&quot;&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get resolv &quot;$cfg&quot; &quot;resolvfile&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; echo &quot;resolv=$resolv=&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$resolv&quot; ] || echo fixiti resolv=<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$resolv&quot; ] || resolv=&quot;/tmp/resolv.${cfg}.conf&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; echo &quot;Default resolvfile: $resolv&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;-x /var/run/${NAME}.${cfg}.pid&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; authoritative &quot;-K&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; nodaemon &quot;-d&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; domainneeded &quot;-D&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; filterwin2k &quot;-f&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; nohosts &quot;-h&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; nonegcache &quot;-N&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; strictorder &quot;-o&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; logqueries &quot;-q&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; noresolv &quot;-R&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; localise_queries &quot;-y&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; readethers &quot;-Z&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; dbus &quot;-1&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; boguspriv &quot;-b&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; expandhosts &quot;-E&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; enable_tftp &quot;--enable-tftp&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; nonwildcard &quot;-z&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; append_parm &quot;$cfg&quot; cachesize &quot;-c&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_parm &quot;$cfg&quot; dnsforwardmax &quot;-0&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_parm &quot;$cfg&quot; port &quot;-p&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_parm &quot;$cfg&quot; ednspacket_max &quot;-P&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_parm &quot;$cfg&quot; dhcpleasemax &quot;-X&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_parm &quot;$cfg&quot; &quot;queryport&quot; &quot;-Q&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_parm &quot;$cfg&quot; &quot;domain&quot; &quot;-s&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_parm &quot;$cfg&quot; &quot;local&quot; &quot;-S&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_parm &quot;$cfg&quot; listen &quot;-a&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; config_list_foreach &quot;$cfg&quot; &quot;server&quot; append_server<br />&nbsp; &nbsp; &nbsp; &nbsp; config_list_foreach &quot;$cfg&quot; &quot;interface&quot; append_interface<br />&nbsp; &nbsp; &nbsp; &nbsp; config_list_foreach &quot;$cfg&quot; &quot;notinterface&quot; append_notinterface<br />&nbsp; &nbsp; &nbsp; &nbsp; config_list_foreach &quot;$cfg&quot; &quot;listen_address&quot; append_listen_address<br />&nbsp; &nbsp; &nbsp; &nbsp; config_list_foreach &quot;$cfg&quot; &quot;no_dhcp_interface&quot; append_no_dhcp_interface<br />&nbsp; &nbsp; &nbsp; &nbsp; config_list_foreach &quot;$cfg&quot; &quot;addnhosts&quot; append_addnhosts<br />&nbsp; &nbsp; &nbsp; &nbsp; config_list_foreach &quot;$cfg&quot; &quot;bogusnxdomain&quot; append_bogusnxdomain<br />&nbsp; &nbsp; &nbsp; &nbsp; append_parm &quot;$cfg&quot; &quot;leasefile&quot; &quot;-l&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_parm &quot;$cfg&quot; &quot;resolvfile&quot; &quot;-r&quot; &quot;$resolv&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; append_parm &quot;$cfg&quot; &quot;tftp_root&quot; &quot;--tftp-root&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; append_parm &quot;$cfg&quot; &quot;dhcp_boot&quot; &quot;--dhcp-boot&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get DOMAIN &quot;$cfg&quot; domain</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get_bool readethers &quot;$cfg&quot; readethers<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$readethers&quot; = &quot;1&quot; ] &amp;&amp; [ -e &quot;/etc/ethers&quot; ] || touch /etc/ethers</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get leasefile $cfg leasefile<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$leasefile&quot; ] &amp;&amp; [ -e &quot;$leasefile&quot; ] || touch &quot;$leasefile&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get_bool cachelocal &quot;$cfg&quot; cachelocal 1</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get hostsfile &quot;$cfg&quot; dhcphostsfile<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -e &quot;$hostsfile&quot; ] &amp;&amp; append args &quot;--dhcp-hostsfile=$hostsfile&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; local rebind<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get_bool rebind &quot;$cfg&quot; rebind_protection 1<br />&nbsp; &nbsp; &nbsp; &nbsp; [ $rebind -gt 0 ] &amp;&amp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; logger -t dnsmasq \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;DNS rebinding protection is active,&quot; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;will discard upstream RFC1918 responses!&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; append args &quot;--stop-dns-rebind&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local rebind_localhost<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; config_get_bool rebind_localhost &quot;$cfg&quot; rebind_localhost 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ $rebind_localhost -gt 0 ] &amp;&amp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; logger -t dnsmasq &quot;Allowing 127.0.0.0/8 responses&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; append args &quot;--rebind-localhost-ok&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; append_rebind_domain() {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; logger -t dnsmasq &quot;Allowing RFC1918 responses for domain $1&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; append args &quot;--rebind-domain-ok=$1&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; config_list_foreach &quot;$cfg&quot; rebind_domain append_rebind_domain<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; config_foreach dhcp_host_add host $cfg<br />&nbsp; &nbsp; &nbsp; &nbsp; config_foreach filter_dnsmasq boot dhcp_boot_add $cfg<br />&nbsp; &nbsp; &nbsp; &nbsp; config_foreach filter_dnsmasq mac dhcp_mac_add $cfg<br />&nbsp; &nbsp; &nbsp; &nbsp; config_foreach filter_dnsmasq vendorclass dhcp_vendorclass_add $cfg<br />&nbsp; &nbsp; &nbsp; &nbsp; config_foreach filter_dnsmasq userclass dhcp_userclass_add $cfg<br />&nbsp; &nbsp; &nbsp; &nbsp; config_foreach filter_dnsmasq circuitid dhcp_circuitid_add $cfg<br />&nbsp; &nbsp; &nbsp; &nbsp; config_foreach filter_dnsmasq remoteid dhcp_remoteid_add $cfg<br />&nbsp; &nbsp; &nbsp; &nbsp; config_foreach filter_dnsmasq subscrid dhcp_subscrid_add $cfg<br />&nbsp; &nbsp; &nbsp; &nbsp; config_foreach filter_dnsmasq domain dhcp_domain_add $cfg<br />&nbsp; &nbsp; &nbsp; &nbsp; config_foreach filter_dnsmasq dhcp dhcp_add $cfg</p><p>&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$debug&quot; -ge 1 ] &amp;&amp; echo &quot;DEBUG&nbsp; &nbsp; &nbsp; &nbsp;[$cfg] resolv=$resolv&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; # add own hostname<br />&nbsp; &nbsp; &nbsp; &nbsp; local ownip<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$cfg&quot; = &quot;$FRSTDNS&quot; ] &amp;&amp; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ownip=&quot;$lanaddr&quot; || \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ownip=&quot;$(uci get dhcp.$cfg.listen_address | cut -d&#039; &#039; -f1)&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -z &quot;$ownip&quot; ] || {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local hostname=&quot;$(uci_get system.@system[0].hostname)&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dhcp_domain_add &quot;$cfg&quot; &quot;${hostname:-OpenWrt}&quot; &quot;$ownip&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$debug&quot; -ge 1 ] &amp;&amp; echo &quot;DEBUG&nbsp; &nbsp;dhcp_domain_add \&quot;$cfg\&quot; \&quot;${hostname:-OpenWrt}\&quot; \&quot;$ownip\&quot;&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$debug&quot; -ge 1 ] &amp;&amp; echo &quot;DEBUG&nbsp; &nbsp;[$cfg] ownip=$ownip&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$cfg&quot; = &quot;$FRSTDNS&quot; ] &amp;&amp; fxresolv=/tmp/resolv.conf || fxresolv=$resolv</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $PROG $args &amp;&amp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rm -f $fxresolv<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$DOMAIN&quot; ] &amp;&amp; echo &quot;search $DOMAIN&quot; &gt;&gt; $fxresolv<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$cfg&quot; = &quot;$FRSTDNS&quot; ] &amp;&amp; DNS_SERVERS=&quot;$DNS_SERVERS 127.0.0.1&quot; || \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DNS_SERVERS=&quot;$DNS_SERVERS $ownip&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo &quot;&nbsp; [$cfg] Upstream DNS server(s): $DNS_SERVERS&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for DNS_SERVER in $DNS_SERVERS ; do<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo &quot;nameserver $DNS_SERVER&quot; &gt;&gt; $fxresolv<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; done<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$debug&quot; -ge 1 ] &amp;&amp; echo &quot;DEBUG&nbsp; &nbsp; &nbsp; &nbsp;[$cfg] dnsmasq $args&quot;<br />}</p><p>match_dnsmasq_instance() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local cfg=&quot;$1&quot; dnsmasq_instance=&quot;$2&quot; dnsmasq_cfg<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get dnsmasq_cfg &quot;$cfg&quot; &quot;dnsmasq_config&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$debug&quot; -ge 2 ] &amp;&amp; [ -z &quot;$dnsmasq_cfg&quot; ] &amp;&amp; echo &quot;DEBUG&nbsp; &nbsp; &nbsp; [$dnsmasq_instance] dnsmasq_config = undefined for cfg=$cfg&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -z &quot;$dnsmasq_cfg&quot; ] &amp;&amp; return 2</p><p>&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$debug&quot; -ge 2 ] &amp;&amp; [ &quot;$dnsmasq_cfg&quot; = &quot;dnsmasq_instance&quot; ] &amp;&amp; echo &quot;DEBUG&nbsp; &nbsp; [$dnsmasq_instance] dnsmasq_config = [$dnsmasq_cfg] for cfg=$cfg MATCHING instance&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$dnsmasq_cfg&quot; = &quot;$dnsmasq_instance&quot; ] &amp;&amp; return 1</p><p>&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$debug&quot; -ge 2 ] &amp;&amp; echo &quot;DEBUG&nbsp; &nbsp; &nbsp; &nbsp;[$dnsmasq_instance] dnsmasq_config = [$dnsmasq_cfg] for cfg=$cfg DIFFERENT instance&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; return 0<br />}</p><br /><p>filter_dnsmasq() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local function=&quot;$2&quot; cfg=&quot;$1&quot; dnsmasq_instance=&quot;$3&quot; match_dnsmasq<br />&nbsp; &nbsp; &nbsp; &nbsp; match_dnsmasq_instance $cfg $dnsmasq_instance<br />&nbsp; &nbsp; &nbsp; &nbsp; match_dnsmasq=$?<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$debug&quot; -ge 2 ] &amp;&amp; echo &quot;DEBUG&nbsp; &nbsp; &nbsp; &nbsp;[$dnsmasq_instance] Filtering for $function match_dnsmasq=$match_dnsmasq&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$match_dnsmasq&quot; -eq 0 ] &amp;&amp; return 0<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$debug&quot; -ge 1 ] &amp;&amp; echo &quot;DEBUG&nbsp; &nbsp; &nbsp; &nbsp;[$dnsmasq_instance] Calling $function&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; # call function<br />&nbsp; &nbsp; &nbsp; &nbsp; $function $cfg $dnsmasq_instance<br />}</p><p>dhcp_subscrid_add() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local cfg=&quot;$1&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get networkid &quot;$cfg&quot; networkid<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$networkid&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get subscriberid &quot;$cfg&quot; subscriberid<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$subscriberid&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;--dhcp-subscrid=$networkid,$subscriberid&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; dhcp_option_add &quot;$cfg&quot; &quot;$networkid&quot;<br />}</p><p>dhcp_remoteid_add() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local cfg=&quot;$1&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get networkid &quot;$cfg&quot; networkid<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$networkid&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get remoteid &quot;$cfg&quot; remoteid<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$remoteid&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;--dhcp-remoteid=$networkid,$remoteid&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; dhcp_option_add &quot;$cfg&quot; &quot;$networkid&quot;<br />}</p><p>dhcp_circuitid_add() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local cfg=&quot;$1&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get networkid &quot;$cfg&quot; networkid<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$networkid&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get circuitid &quot;$cfg&quot; circuitid<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$circuitid&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;--dhcp-circuitid=$networkid,$circuitid&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; dhcp_option_add &quot;$cfg&quot; &quot;$networkid&quot;<br />}</p><p>dhcp_userclass_add() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local cfg=&quot;$1&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get networkid &quot;$cfg&quot; networkid<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$networkid&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get userclass &quot;$cfg&quot; userclass<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$userclass&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;--dhcp-userclass=$networkid,$userclass&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; dhcp_option_add &quot;$cfg&quot; &quot;$networkid&quot;<br />}</p><p>dhcp_vendorclass_add() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local cfg=&quot;$1&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get networkid &quot;$cfg&quot; networkid<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$networkid&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get vendorclass &quot;$cfg&quot; vendorclass<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$vendorclass&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;--dhcp-vendorclass=$networkid,$vendorclass&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; dhcp_option_add &quot;$cfg&quot; &quot;$networkid&quot;<br />}</p><p>dhcp_host_add() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local cfg=&quot;$1&quot; dnsmasq_instance=&quot;$2&quot; ignore match_dnsmasq name macs mac networkid ip</p><p>&nbsp; &nbsp; &nbsp; &nbsp; match_dnsmasq_instance $cfg $dnsmasq_instance<br />&nbsp; &nbsp; &nbsp; &nbsp; match_dnsmasq=$?</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get ignore &quot;cfg&quot; ignore<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$debug&quot; -ge 2 ] &amp;&amp; echo &quot;DEBUG&nbsp; &nbsp; &nbsp; &nbsp;[$dnsmasq_instance] ignore=$ignore (from uci)&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; # if this entry belongs to another dnsmasq instance then ignore the mac address/lease!<br />&nbsp; &nbsp; &nbsp; &nbsp; # if someone sets ignore explicitly keep their selection<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$match_dnsmasq&quot; -eq 0 ] &amp;&amp; [ -z &quot;$ignore&quot; ] &amp;&amp; ignore=1 &amp;&amp; return<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$debug&quot; -ge 1 ] &amp;&amp; echo &quot;DEBUG&nbsp; &nbsp; &nbsp; &nbsp;[$dnsmasq_instance] ignore=$ignore&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get name &quot;$cfg&quot; name</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get networkid &quot;$cfg&quot; networkid</p><p>&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$networkid&quot; ] &amp;&amp; dhcp_option_add &quot;$cfg&quot; &quot;$networkid&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get ip &quot;$cfg&quot; ip<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$ip&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; macs=&quot;&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get mac &quot;$cfg&quot; mac<br />&nbsp; &nbsp; &nbsp; &nbsp; for m in $mac; do append macs &quot;$m&quot; &quot;,&quot;; done<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$macs&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;--dhcp-host=$macs,${networkid:+net:$networkid,}$ip${name:+,$name}${ignore:+,ignore}&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$ignore&quot; ] &amp;&amp; echo &quot;&nbsp; &nbsp; &nbsp; [$dnsmasq_instance] Ignore Host $name $mac&quot; &amp;&amp; return 0<br />&nbsp; &nbsp; &nbsp; &nbsp; echo &quot;&nbsp; [$dnsmasq_instance] Adding Host $name $mac&quot;<br />}</p><p>dhcp_mac_add() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local cfg=&quot;$1&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get networkid &quot;$cfg&quot; networkid<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$networkid&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get mac &quot;$cfg&quot; mac<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$mac&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;--dhcp-mac=$networkid,$mac&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; dhcp_option_add &quot;$cfg&quot; &quot;$networkid&quot;<br />}</p><p>dhcp_boot_add() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local cfg=&quot;$1&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get networkid &quot;$cfg&quot; networkid</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get filename &quot;$cfg&quot; filename<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$filename&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get servername &quot;$cfg&quot; servername<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$servername&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get serveraddress &quot;$cfg&quot; serveraddress<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$serveraddress&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;--dhcp-boot=${networkid:+net:$networkid,}$filename,$servername,$serveraddress&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; dhcp_option_add &quot;$cfg&quot; &quot;$networkid&quot;<br />}</p><br /><p>dhcp_add() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local cfg=&quot;$1&quot; dnsmasq_instance=&quot;$2&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; echo &quot;&nbsp; [$dnsmasq_instance] Adding DHCP range $1&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get net &quot;$cfg&quot; interface<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$net&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get networkid &quot;$cfg&quot; networkid<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$networkid&quot; ] || networkid=&quot;$net&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get ifname &quot;$net&quot; ifname<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$ifname&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get dnsserver &quot;$net&quot; dns<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$debug&quot; -ge 2 ] &amp;&amp; echo &quot;DEBUG&nbsp; &nbsp; &nbsp; &nbsp;[$dnsmasq_instance] DNS servers=$dnsserver&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$cachelocal&quot; = &quot;0&quot; -a -n &quot;$dnsserver&quot; ] &amp;&amp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DNS_SERVERS=&quot;$DNS_SERVERS $dnsserver&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$debug&quot; -ge 1 ] &amp;&amp; echo &quot;DEBUG&nbsp; &nbsp; &nbsp; &nbsp;[$dnsmasq_instance] adding DNS server(s) $dnsserver to list: $DNS_SERVERS&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp; &nbsp; append_bool &quot;$cfg&quot; ignore &quot;-2 &#039;$ifname&#039;&quot; &amp;&amp; return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get proto &quot;$net&quot; proto<br />&nbsp; &nbsp; &nbsp; &nbsp; [ static = &quot;$proto&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get ipaddr &quot;$net&quot; ipaddr<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get netmask &quot;$cfg&quot; netmask<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$netmask&quot; ] || config_get netmask &quot;$net&quot; netmask</p><p>&nbsp; &nbsp; &nbsp; &nbsp; #check for an already active dhcp server on the interface, unless &#039;force&#039; is set<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get_bool force &quot;$cfg&quot; force 0<br />&nbsp; &nbsp; &nbsp; &nbsp; [ $force -gt 0 ] || {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; udhcpc -n -q -s /bin/true -t 1 -i $ifname &gt;&amp;- &amp;&amp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo &quot;WARNING: DHCP range ignored! A DHCP server is already present on interace $ifname.&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; logger -t dnsmasq -p WARN &quot;WARNING: DHCP range ignored! A DHCP server is already present on interface $ifname.&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get start &quot;$cfg&quot; start<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get limit &quot;$cfg&quot; limit<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get leasetime &quot;$cfg&quot; leasetime<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get options &quot;$cfg&quot; options<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get_bool dynamicdhcp &quot;$cfg&quot; dynamicdhcp 1</p><p>&nbsp; &nbsp; &nbsp; &nbsp; leasetime=&quot;${leasetime:-12h}&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; start=&quot;$(dhcp_calc &quot;${start:-100}&quot;)&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; limit=&quot;${limit:-150}&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; eval &quot;$(ipcalc.sh $ipaddr $netmask $start $limit)&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; if [ &quot;$dynamicdhcp&quot; = &quot;0&quot; ]; then END=&quot;static&quot;; fi<br />&nbsp; &nbsp; &nbsp; &nbsp; append args &quot;--dhcp-range=$networkid,$START,$END,$NETMASK,$leasetime${options:+ $options}&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; dhcp_option_add &quot;$cfg&quot; &quot;$networkid&quot;<br />}</p><p>dhcp_option_add() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local cfg=&quot;$1&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; local networkid=&quot;$2&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get dhcp_option &quot;$cfg&quot; dhcp_option<br />&nbsp; &nbsp; &nbsp; &nbsp; for o in $dhcp_option; do<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; append args &quot;-O $networkid&quot;,&quot;$o&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; done</p><p>}</p><p>dhcp_domain_add() {<br />&nbsp; &nbsp; &nbsp; &nbsp; local cfg=&quot;$1&quot; dnsmasq_instance=&quot;$2&quot;; [ &quot;$4&quot; ] || dnsmasq_instance=&quot;$1&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; local ip name names</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get names &quot;$cfg&quot; name &quot;$2&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$names&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get ip &quot;$cfg&quot; ip &quot;$3&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$ip&quot; ] || return 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; local oIFS=&quot;$IFS&quot;; IFS=&quot;.&quot;; set -- $ip; IFS=&quot;$oIFS&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; local raddr=&quot;${4:+$4.$3.$2.$1.in-addr.arpa}&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; for name in $names; do<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local fqdn=&quot;$name&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ &quot;${fqdn%.*}&quot; == &quot;$fqdn&quot; ] &amp;&amp; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fqdn=&quot;$fqdn${DOMAIN:+.$DOMAIN}&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo &quot;&nbsp; [$dnsmasq_instance] Adding DNS entry $fqdn to $ip&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; append args &quot;-A /$fqdn/$ip&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$raddr&quot; ] &amp;&amp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; append args &quot;--ptr-record=$raddr,$fqdn&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; raddr=&quot;&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; done<br />}</p><p>start() {<br />&nbsp; &nbsp; &nbsp; &nbsp; include /lib/network<br />&nbsp; &nbsp; &nbsp; &nbsp; scan_interfaces</p><p>&nbsp; &nbsp; &nbsp; &nbsp; local lanaddr<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get lanaddr &quot;lan&quot; ipaddr</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_load dhcp</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_foreach dnsmasq dnsmasq<br />}</p><p>stop() {<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -f /tmp/resolv.conf ] &amp;&amp; { #TODO rm all except first resolv files<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rm -f /tmp/resolv.conf<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ln -s /tmp/resolv.conf.auto /tmp/resolv.conf<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; #killing all server processes<br />&nbsp; &nbsp; &nbsp; &nbsp; local pidfile<br />&nbsp; &nbsp; &nbsp; &nbsp; for pidfile in `ls /var/run/${NAME}.*.pid 2&gt;/dev/null`<br />&nbsp; &nbsp; &nbsp; &nbsp; do<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo Stopping pid `cat $pidfile 2&gt;/dev/null`<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; start-stop-daemon -q -K -s KILL -p &quot;${pidfile}&quot; -n &quot;${NAME}&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rm -f &quot;${pidfile}&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; done<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -z &quot;${pidfile}&quot; ] &amp;&amp; echo &quot;${initscript}: no pid files.&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return 0<br />}<br />=== END ===</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>