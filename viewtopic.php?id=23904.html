<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Multi-WAN Load Balancing</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 29 Mar 2018 and 3 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 14</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=23904&amp;p=3.html">3</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=14.html">14</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p104650">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						15 Mar 2010, 05:35					</div>
				</div>
				<div class="post-content content">
					<p>This script can handle more than two wans, and provides QoS for the wan links if qos is enabled on each wan link.</p><p>If you&#039;re using the script from <a href="https://forum.openwrt.org/viewtopic.php?id=23199">https://forum.openwrt.org/viewtopic.php?id=23199</a>, make sure to remove it prior to installing this one. (opkg remove luci-app-dualwan, opkg remove dualwan)</p><p>The Multi-WAN agent script itself:<br /><a href="ftp://ftp.netlab7.com/multiwan_1.0.18.ipk">ftp://ftp.netlab7.com/multiwan_1.0.18.ipk</a></p><p>And it&#039;s corresponding Luci Configuration Module:<br /><a href="ftp://ftp.netlab7.com/luci-app-multiwan_1.0.16.ipk">ftp://ftp.netlab7.com/luci-app-multiwan_1.0.16.ipk</a></p><p>Update 1.0.18 - Changes per #7792 (Thanks buildster!): <br /> a) make the process-killing of multiwan agent work <br /> b) comment out a line of typo (fdown), which isn&#039;t needed anyway<br />&nbsp; &nbsp; &nbsp;because ifup does ifdown first<br /> c) run ifup in foreground because many heavy ifup processes<br />&nbsp; &nbsp; &nbsp;crash/restart the system, probably running out of memory<br /> d) introduce the specification of multiport (see iptables man page)<br />&nbsp; &nbsp; &nbsp;and the ability to specify source-ports, as well as<br />&nbsp; &nbsp; &nbsp;source-ports, or both<br /> e) show logger messages if debug is on</p><br /><p>Update: 1.0.17 - Copies all routes (except default) to multiwan routing tables for vpn/routing compatibility.</p><p>Any feedback is welcome, please let me know if anything doesn&#039;t work, or you run into any issues.</p><p>Thanks <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>											<p class="post-edited">(Last edited by <strong>SouthPawn</strong> on 14 Sep 2010, 21:55)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104652">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Dogge</div>
					<div class="post-datetime">
						15 Mar 2010, 08:58					</div>
				</div>
				<div class="post-content content">
					<p>I would really appreciate it if you provide diffs this time. Thanks.</p>											<p class="post-edited">(Last edited by <strong>Dogge</strong> on 15 Mar 2010, 09:00)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104657">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						15 Mar 2010, 10:05					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Dogge wrote:</cite><blockquote><p>I would really appreciate it if you provide diffs this time. Thanks.</p></blockquote></div><p>What would I be creating a diff against exactly?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104666">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">Dogge</div>
					<div class="post-datetime">
						15 Mar 2010, 14:37					</div>
				</div>
				<div class="post-content content">
					<p>Against the build-system with &#039;svn diff&#039;.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104674">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						15 Mar 2010, 17:33					</div>
				</div>
				<div class="post-content content">
					<p>You do realize it&#039;s a script right? And that there isn&#039;t really a build-system.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104675">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						15 Mar 2010, 17:44					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>SouthPawn wrote:</cite><blockquote><p>You do realize it&#039;s a script right? And that there isn&#039;t really a build-system.</p></blockquote></div><p>Well, providing patches is the standard procedure to get something included into trunk, also tracking changes is a pita with only binary packages provided (yes I know they contain just scripts and I could unpack and diff them).</p><p>Do you consider the multiwan stuff stable? In this case I&#039;d commit it to the LuCI repo as source package so that the buildbots can pick it up and provide it in future snapshots.</p><p>~ JoW</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104680">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						15 Mar 2010, 20:24					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>jow wrote:</cite><blockquote><div class="quotebox"><cite>SouthPawn wrote:</cite><blockquote><p>You do realize it&#039;s a script right? And that there isn&#039;t really a build-system.</p></blockquote></div><p>Well, providing patches is the standard procedure to get something included into trunk, also tracking changes is a pita with only binary packages provided (yes I know they contain just scripts and I could unpack and diff them).</p><p>Do you consider the multiwan stuff stable? In this case I&#039;d commit it to the LuCI repo as source package so that the buildbots can pick it up and provide it in future snapshots.</p><p>~ JoW</p></blockquote></div><p>Hey JoW,</p><p>Thanks for the info,</p><p>I am hoping to get some feedback on it first, positive or negative to make sure everything is working correctly, and running stable, currently I&#039;m testing it only on a single WAN so I want to make sure that things like the load balancer and what not are functioning correctly. (The script can and will work on a single WAN.)</p><p>Any information you could provide on the aforementioned items would be greatly appreciated as I have no expertise in that department.</p><p>Thanks Again,<br />-Craig</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104681">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">Dogge</div>
					<div class="post-datetime">
						15 Mar 2010, 20:31					</div>
				</div>
				<div class="post-content content">
					<p>If you provide a patch I can test with triple WAN (normal WAN, 3g as WAN and wireless as WAN)</p>											<p class="post-edited">(Last edited by <strong>Dogge</strong> on 15 Mar 2010, 20:33)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104683">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						15 Mar 2010, 21:11					</div>
				</div>
				<div class="post-content content">
					<p>Hi SouthPawn,</p><br /><p>Thanks for the nice script, will try it this weekend and report back. Nice to see triple (and more) wan feature!</p><p>Im curious to see how and why you are &quot;using&quot; QoS scripts... In my opinion the default OpenWRT QoS script/package works fine and needs no fidling, even with multiple wans.</p><br /><p>Thnx again <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104684">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						15 Mar 2010, 21:25					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hi SouthPawn,</p><br /><p>Thanks for the nice script, will try it this weekend and report back. Nice to see triple (and more) wan feature!</p><p>Im curious to see how and why you are &quot;using&quot; QoS scripts... In my opinion the default OpenWRT QoS script/package works fine and needs no fidling, even with multiple wans.</p><br /><p>Thnx again <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p></blockquote></div><p>Correct, but we need to mark the traffic to say which WAN to use, qos-scripts uses these same connection marks. So if we let it stay the way it is, nothing would receive QoS except traffic that was specifically unmarked. </p><p>Since all traffic is marked for their prospective routes, we need to adapt the QoS to deal with new connection marks. 0x1 0x2 0x3 0x4 (as qos-scripts uses for it&#039;s markings) becomes 0x11 0x12 0x13 0x14 for the first wan and 0x21 0x22 0x23 0x24 for the second wan, and we need to adapt the tc filters and ip rules to corrispond as well.</p><p>Kind Regards,<br />-Craig</p>											<p class="post-edited">(Last edited by <strong>SouthPawn</strong> on 15 Mar 2010, 21:30)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104685">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						15 Mar 2010, 21:44					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Dogge wrote:</cite><blockquote><p>If you provide a patch I can test with triple WAN (normal WAN, 3g as WAN and wireless as WAN)</p></blockquote></div><p>Please give me any guidance on this as possible, I&#039;m not sure how to do what you&#039;re asking. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Thanks Dogge,</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104687">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">mynetmemo</div>
					<div class="post-datetime">
						15 Mar 2010, 21:58					</div>
				</div>
				<div class="post-content content">
					<p>Dear SouthPawn,</p><div class="quotebox"><cite>SouthPawn wrote:</cite><blockquote><p>Any feedback is welcome, please let me know if anything doesn&#039;t work, or you run into any issues.</p></blockquote></div><p>Thank you so much for this release.</p><p>I use it in France with 2 ADSL lines (free.fr and orange.fr) and it works like a charm...</p>											<p class="post-edited">(Last edited by <strong>mynetmemo</strong> on 15 Mar 2010, 22:16)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104723">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">ulf_k</div>
					<div class="post-datetime">
						16 Mar 2010, 16:49					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mynetmemo wrote:</cite><blockquote><p>Dear SouthPawn,</p><div class="quotebox"><cite>SouthPawn wrote:</cite><blockquote><p>Any feedback is welcome, please let me know if anything doesn&#039;t work, or you run into any issues.</p></blockquote></div><p>Thank you so much for this release.</p><p>I use it in France with 2 ADSL lines (free.fr and orange.fr) and it works like a charm...</p></blockquote></div><p>hi,<br />i would like to know, if this works with ssh and/or ftp connections as well?<br />i am running a simple 3xmultiwan setup on a asus wl500gp based on ip and i have problems using ftp or ssh sessions, they will abort spontaneously.<br />here my script:<br /></p><div class="codebox"><pre><code>#!/bin/sh

. /etc/functions.sh
include /lib/network
sleep 120
scan_interfaces

config_get WAN1 wan1 ifname
config_get WAN1_IP wan1 ipaddr
config_get WAN1_GATEWAY wan1 gateway
config_get WAN2 wan2 ifname
config_get WAN2_IP wan2 ipaddr
config_get WAN2_GATEWAY wan2 gateway
config_get WAN3 wan3 ifname
config_get WAN3_IP wan3 ipaddr
config_get WAN3_GATEWAY wan3 gateway

###check if all 3 pppoe connections are up and running
if [ $WAN1_IP=&#039;217.xxx.yyy.zzz&#039; ] &amp; [ $WAN2_IP=&#039;217.xxx.yyy.zzz&#039; ] &amp; [ $WAN3_IP=&#039;217.xxx.yyy.zzz&#039; ];
then 
ip route add $WAN1_IP/32 dev $WAN1 src $WAN1_IP table wan1
ip route add default via $WAN1_GATEWAY table wan1
ip route add $WAN2_IP/32 dev $WAN2 src $WAN2_IP table wan2
ip route add default via $WAN2_GATEWAY table wan2
ip route add $WAN3_IP/32 dev $WAN3 src $WAN1_IP table wan3
ip route add default via $WAN3_GATEWAY table wan3
ip rule add from $WAN1_IP table wan1
ip rule add from $WAN2_IP table wan2
ip rule add from $WAN3_IP table wan3
ip route add default scope global nexthop via $WAN1_IP dev $WAN1 weight 1 nexthop via $WAN2_IP dev $WAN2 weight 1 nexthop via $WAN3_IP dev $WAN3 weight 1;
fi</code></pre></div><p>thanks ulf</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104731">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						16 Mar 2010, 18:31					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ulf_k wrote:</cite><blockquote><p>i would like to know, if this works with ssh and/or ftp connections as well?<br />i am running a simple 3xmultiwan setup on a asus wl500gp based on ip and i have problems using ftp or ssh sessions, they will abort spontaneously.</p></blockquote></div><p>This should work without problem, as the multiwan script uses connection marking in netfilter for traffic management. The first rule being restore any existing connection marks, which means it&#039;ll restore related connection marks as well. (Such as passive connections made following the initial connection)</p><p>FTP fails when trying to do the load balancing solely with iproute2, because it won&#039;t detect that the passive connection going out is actually related to the prior port 21 connection to the same server, and it&#039;ll try to throw it out the nexthop.</p><p>Netfilter is able to track these connections with nat helpers.</p>											<p class="post-edited">(Last edited by <strong>SouthPawn</strong> on 26 Mar 2010, 02:24)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104863">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						19 Mar 2010, 18:45					</div>
				</div>
				<div class="post-content content">
					<p>Hi Southpawn,</p><br /><p>Your script works like a charm! Thank you for that.</p><p>I dont use the luci interface, but only the wan agent script itself. Having some trouble figuring all options out. Maybe you could make the config file a little more self-explanatory? Like some more examples about selecting specific wan interface for certain traffic.</p><br /><p>Thank you !</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104864">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">Dogge</div>
					<div class="post-datetime">
						19 Mar 2010, 18:53					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>SouthPawn wrote:</cite><blockquote><p>Please give me any guidance on this as possible, I&#039;m not sure how to do what you&#039;re asking. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></blockquote></div><p>Checkout the build-system from subversion and integrate your package in the package feed. Then you can run &#039;svn diff&#039; and you will have a patch ready.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104866">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						19 Mar 2010, 20:03					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hi Southpawn,</p><br /><p>Your script works like a charm! Thank you for that.</p><p>I dont use the luci interface, but only the wan agent script itself. Having some trouble figuring all options out. Maybe you could make the config file a little more self-explanatory? Like some more examples about selecting specific wan interface for certain traffic.</p><br /><p>Thank you !</p></blockquote></div><div class="quotebox"><blockquote><p>config &#039;multiwan&#039; &#039;config&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;default_route&#039; &#039;balancer&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;resolv_conf&#039; &#039;/tmp/resolv.conf.auto&#039;</p><p>config &#039;interface&#039; &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;weight&#039; &#039;5&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_interval&#039; &#039;10&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;icmp_hosts&#039; &#039;dns&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;timeout&#039; &#039;3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_fail_retries&#039; &#039;3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_recovery_retries&#039; &#039;5&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;failover_to&#039; &#039;balancer&#039;</p><p>config &#039;interface&#039; &#039;wan2&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;weight&#039; &#039;5&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_interval&#039; &#039;10&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;icmp_hosts&#039; &#039;dns&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;timeout&#039; &#039;3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_fail_retries&#039; &#039;3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_recovery_retries&#039; &#039;5&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;failover_to&#039; &#039;wan3&#039;</p><p>config &#039;interface&#039; &#039;wan3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;weight&#039; &#039;disable&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_interval&#039; &#039;disable&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;icmp_hosts&#039; &#039;gateway&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;timeout&#039; &#039;3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_fail_retries&#039; &#039;3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_recovery_retries&#039; &#039;5&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;failover_to&#039; &#039;disable&#039;</p><p>config &#039;interface&#039; &#039;wan4&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;weight&#039; &#039;3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_interval&#039; &#039;20&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;icmp_hosts&#039; &#039;208.67.222.222 208.67.220.220&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;timeout&#039; &#039;3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_fail_retries&#039; &#039;3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_recovery_retries&#039; &#039;5&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;failover_to&#039; &#039;wan&#039;</p><p>config &#039;mwanfw&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;src&#039; &#039;192.168.1.0/24&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;dst&#039; &#039;<a href="ftp://ftp.netlab7.com">ftp.netlab7.com</a>&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;proto&#039; &#039;tcp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;ports&#039; &#039;21&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;wanrule&#039; &#039;wan4&#039;</p><p>config &#039;mwanfw&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;proto&#039; &#039;tcp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;ports&#039; &#039;21&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;wanrule&#039; &#039;wan2&#039;</p><p>config &#039;mwanfw&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;src&#039; &#039;192.168.0.3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;proto&#039; &#039;icmp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;wanrule&#039; &#039;wan&#039;</p><p>config &#039;mwanfw&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;dst&#039; &#039;<a href="http://www.whatismyip.com">www.whatismyip.com</a>&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;wanrule&#039; &#039;balancer&#039;</p></blockquote></div><p>Glad to hear it&#039;s working as expected! <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Does this shed some more light on the config file?</p><p>Thanks,<br />-Craig</p>											<p class="post-edited">(Last edited by <strong>SouthPawn</strong> on 19 Mar 2010, 22:59)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105066">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">Patrik85</div>
					<div class="post-datetime">
						23 Mar 2010, 10:03					</div>
				</div>
				<div class="post-content content">
					<p>Hi all,</p><p>I think I have got some issues getting the load balancer to do what I want :-)</p><p>First of all I want to thank SouthPawn for his nice work!</p><p>I have two ADSL lines with roughly 16MBit/s each. I configured two WAN interfaces to do PPPOE.<br />This is working so far. I am able to access the internet, but all the time only one WAN interface is used.</p><p>I tried downloading a Debian linux image via torrent. Multiple FTP / HTTP download.<br />Everytime only one WAN interface is used.</p><p>Please find attached some screenshots from my current config.</p><p>I guess I am missing something.<br />Thanks for your help in advance.</p><p><strong>Routes</strong><br />Concerning the &quot;route&quot; output I have a comment. I am sure that I sometimes saw two default routes. What would be the correct behavior?<br /><span class="postimg"><img src="http://img710.imageshack.us/img710/3076/routet.jpg" alt="http://img710.imageshack.us/img710/3076/routet.jpg" /></span></p><p><strong>Switch Config</strong><br /><span class="postimg"><img src="http://img195.imageshack.us/img195/1130/switchconfig.jpg" alt="http://img195.imageshack.us/img195/1130/switchconfig.jpg" /></span></p><p><strong>WAN Interfaces</strong><br />For the WAN interfaces - which zone must be used? I am using the same zone for both WAN interfaces.<br /><span class="postimg"><img src="http://img196.imageshack.us/img196/2954/wanl.jpg" alt="http://img196.imageshack.us/img196/2954/wanl.jpg" /></span><br /><span class="postimg"><img src="http://img92.imageshack.us/img92/8346/wan2.jpg" alt="http://img92.imageshack.us/img92/8346/wan2.jpg" /></span></p><p><strong>MultiWAN</strong><br /><span class="postimg"><img src="http://img704.imageshack.us/img704/3848/multiwan.jpg" alt="http://img704.imageshack.us/img704/3848/multiwan.jpg" /></span></p><p><strong>Interfaces Status</strong><br /><span class="postimg"><img src="http://img517.imageshack.us/img517/5677/statusinterfaces.jpg" alt="http://img517.imageshack.us/img517/5677/statusinterfaces.jpg" /></span></p><br /><p>Best regards,<br />Patrik</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105100">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						23 Mar 2010, 17:41					</div>
				</div>
				<div class="post-content content">
					<p>Hey Patrik, </p><p>Thank you for the kind words, go ahead and remove wan2 from the Multi-WAN configuration, and add in it&#039;s place wan1. <br />This should take care of it, let me know if there are any issues after this.</p><p>Thanks Patrik,<br />-Craig</p><p>P.S. That outgoing rule for everything to go to the load balancer is unnecessary, as you selected the default route to be the load balancer anyhow. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>											<p class="post-edited">(Last edited by <strong>SouthPawn</strong> on 23 Mar 2010, 18:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105113">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">Patrik85</div>
					<div class="post-datetime">
						23 Mar 2010, 21:18					</div>
				</div>
				<div class="post-content content">
					<p>Hey Craig,</p><p>thanks for your fast reply.<br />I did the config change and my /etc/config/multiwan looks like this now:</p><div class="quotebox"><blockquote><p>root@OpenWrt:~# cat /etc/config/multiwan</p><p>config &#039;multiwan&#039; &#039;config&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;default_route&#039; &#039;balancer&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;resolv_conf&#039; &#039;/tmp/resolv.conf.auto&#039;</p><p>config &#039;interface&#039; &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;weight&#039; &#039;5&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_interval&#039; &#039;10&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;timeout&#039; &#039;3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_fail_retries&#039; &#039;3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_recovery_retries&#039; &#039;5&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;failover_to&#039; &#039;disable&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;icmp_hosts&#039; &#039;disable&#039;</p><p>config &#039;interface&#039; &#039;wan1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;weight&#039; &#039;5&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_interval&#039; &#039;10&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;timeout&#039; &#039;3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_fail_retries&#039; &#039;3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;health_recovery_retries&#039; &#039;5&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;icmp_hosts&#039; &#039;disable&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;failover_to&#039; &#039;disable&#039;</p><p>config &#039;mwanfw&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;wanrule&#039; &#039;balancer&#039;</p></blockquote></div><p>routing table looks like this<br /></p><div class="quotebox"><blockquote><p>root@OpenWrt:~# route<br />Kernel IP routing table<br />Destination&nbsp; &nbsp; &nbsp;Gateway&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Genmask&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Flags Metric Ref&nbsp; &nbsp; Use Iface<br />217.0.116.36&nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.255 UH&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 ppp1<br />217.0.116.36&nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.255 UH&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 ppp0<br />192.168.2.0&nbsp; &nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 br-lan<br />default&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;217.0.116.36&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 ppp1<br />default&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;217.0.116.36&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 ppp0<br />root@OpenWrt:~#</p></blockquote></div><p>I am running 4 downloads from different http/ftp servers right now and still all traffic goes through WAN1 :-(</p><p>I dont know what I am doing wrong.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105118">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						23 Mar 2010, 22:24					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><blockquote><p>root@OpenWrt:~# route<br />Kernel IP routing table<br />Destination&nbsp; &nbsp; &nbsp;Gateway&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Genmask&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Flags Metric Ref&nbsp; &nbsp; Use Iface<br />217.0.116.36&nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.255 UH&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 ppp1<br />217.0.116.36&nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.255 UH&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 ppp0<br />192.168.2.0&nbsp; &nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 br-lan<br />default&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;217.0.116.36&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 ppp1<br />default&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;217.0.116.36&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 ppp0<br />root@OpenWrt:~#</p></blockquote></div><p>Looks like there is something wrong with your network setup. The gateways on both ppp interfaces have the same ip address... Dont think it is a multiwan issue. Try to get the routing table entries corrected by unsetting the &quot;replace default route&quot; setting, before enabling multiwan, to be sure it isn&#039;t a multiwan issue.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105122">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">Patrik85</div>
					<div class="post-datetime">
						23 Mar 2010, 23:13					</div>
				</div>
				<div class="post-content content">
					<p>I will uncheck the &quot;Let pppd replace the current default route to use the PPP interface after successful connect&quot; for both wan connections now.<br />The gateways of both WAN connections are probably the same because of the fact that I have got two ADSL lines from the same provider.<br />I will come back with an update shortly.</p><p>Thanks and best regards,<br />Patrik</p><p><strong>//edit</strong><br />Still the same issue. Nothing changes after clearing the checkboxes.</p><p>routing table did not change...</p><div class="codebox"><pre><code>root@OpenWrt:~# route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
217.0.116.36    *               255.255.255.255 UH    0      0        0 ppp1
217.0.116.36    *               255.255.255.255 UH    0      0        0 ppp0
192.168.2.0     *               255.255.255.0   U     0      0        0 br-lan
default         217.0.116.36    0.0.0.0         UG    0      0        0 ppp1
default         217.0.116.36    0.0.0.0         UG    0      0        0 ppp0</code></pre></div><p>any other ideas?</p>											<p class="post-edited">(Last edited by <strong>Patrik85</strong> on 23 Mar 2010, 23:22)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105124">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						23 Mar 2010, 23:41					</div>
				</div>
				<div class="post-content content">
					<p>I believe this issue is caused by both wan links being on the same subnet, sharing the same gateway.<br />I don&#039;t think there will be a workaround possible without introducing something to change that. (such as a another router behind one of the wans.)</p>											<p class="post-edited">(Last edited by <strong>SouthPawn</strong> on 24 Mar 2010, 00:23)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105127">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">Patrik85</div>
					<div class="post-datetime">
						24 Mar 2010, 00:35					</div>
				</div>
				<div class="post-content content">
					<p>I changed the config as follows with the result that still all traffic goes through wan1 :-(<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# cat /etc/config/multiwan

config &#039;multiwan&#039; &#039;config&#039;
        option &#039;default_route&#039; &#039;balancer&#039;
        option &#039;resolv_conf&#039; &#039;/tmp/resolv.conf.auto&#039;

config &#039;interface&#039; &#039;wan&#039;
        option &#039;weight&#039; &#039;5&#039;
        option &#039;health_interval&#039; &#039;10&#039;
        option &#039;timeout&#039; &#039;3&#039;
        option &#039;health_fail_retries&#039; &#039;3&#039;
        option &#039;health_recovery_retries&#039; &#039;5&#039;
        option &#039;failover_to&#039; &#039;disable&#039;
        option &#039;icmp_hosts&#039; &#039;disable&#039;

config &#039;interface&#039; &#039;wan1&#039;
        option &#039;weight&#039; &#039;5&#039;
        option &#039;health_interval&#039; &#039;10&#039;
        option &#039;timeout&#039; &#039;3&#039;
        option &#039;health_fail_retries&#039; &#039;3&#039;
        option &#039;health_recovery_retries&#039; &#039;5&#039;
        option &#039;icmp_hosts&#039; &#039;disable&#039;
        option &#039;failover_to&#039; &#039;disable&#039;

config &#039;mwanfw&#039;
        option &#039;wanrule&#039; &#039;wan&#039;

root@OpenWrt:~#</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105132">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						24 Mar 2010, 00:59					</div>
				</div>
				<div class="post-content content">
					<p>A solution to this would be to use the modem (if supported) or another router ahead of us to perform the natting, so that the router can differentiate the paths.</p><p>This doesn&#039;t necessarily mean you need to double nat, once the modem or router ahead is performing the natting, we can create static routes and disable the masquerading locally for the chosen wan link.</p><p>Or, you can just double nat the second uplink by simply sticking another router behind one of the modems.</p><p>This isn&#039;t a multiwan issue as its more of a general routing issue.</p>											<p class="post-edited">(Last edited by <strong>SouthPawn</strong> on 24 Mar 2010, 01:03)</p>
									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 14</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=23904&amp;p=3.html">3</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=14.html">14</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>