<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Belkin F5D7230-4 v2000</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 20 Apr 2018 and 28 Apr 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 3 of 3</div><nav><ul><li><a href="viewtopic.php%3Fid=4929&amp;p=1.html">1</a></li><li><a href="viewtopic.php%3Fid=4929&amp;p=2.html">2</a></li><li class="pagination-current"><span>3</span></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p26553">
				<div class="post-metadata">
					<div class="post-num">Post #51</div>
					<div class="post-author">jimparis</div>
					<div class="post-datetime">
						4 May 2006, 19:29					</div>
				</div>
				<div class="post-content content">
					<p>Not sure, I think that should be all you need to do.&nbsp; Did you do this with a clean build?&nbsp; Once it creates the patched<br />kernel tree, it won&#039;t recreate it when the patches change.&nbsp; You could try starting fresh, or maybe just apply the patch to build_mipsel/linux manually.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p26581">
				<div class="post-metadata">
					<div class="post-num">Post #52</div>
					<div class="post-author">TheEagle</div>
					<div class="post-datetime">
						4 May 2006, 23:04					</div>
				</div>
				<div class="post-content content">
					<p>Yes I downloaded everything fresh from SVN then copied the patch. However, I already applied it manually, and indeed it seems to be much more stable. But there was another problem, with the current kamikaze build there was some strange behaviour, especially if i used an ImageBuilder image. If it worked at all, the configuration of the bridge was all screwed up. I finally took the new compiled kernel and it&#039;s modules and inserted them into the ImageBuilder version I used before.</p><p>Have to test it for a few days to see if it&#039;s completely stable. Thank you VERY much for sharing your knowledge.</p><p>@fruitloaf: will send you an updated version of the image builder when I find the time.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p26585">
				<div class="post-metadata">
					<div class="post-num">Post #53</div>
					<div class="post-author">fruitloaf</div>
					<div class="post-datetime">
						5 May 2006, 00:12					</div>
				</div>
				<div class="post-content content">
					<p>Fantastic, don&#039;t worry about speed though I&#039;m swamped with exams at the moment so I&#039;ve not been able to do more than follow this thread at the moment. </p><p>It looks good at the moment though, between OpenWRT and DDmicro there could be a useful firmware for the Belkin yet.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p26597">
				<div class="post-metadata">
					<div class="post-num">Post #54</div>
					<div class="post-author">star882</div>
					<div class="post-datetime">
						5 May 2006, 05:00					</div>
				</div>
				<div class="post-content content">
					<p>I just wired up the USB port for my v2000. I&#039;m planning to connect an old 2.5&quot; HDD in an enclosure to it. How do I extract the OpenWRT image to copy to the ext3 partition on the USB HDD? And how do I make a &quot;bootloader&quot; image to boot from USB?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p26622">
				<div class="post-metadata">
					<div class="post-num">Post #55</div>
					<div class="post-author">TheEagle</div>
					<div class="post-datetime">
						5 May 2006, 10:56					</div>
				</div>
				<div class="post-content content">
					<p><a href="http://wiki.openwrt.org/UsbStorageHowto?highlight=%28HowTo%29">http://wiki.openwrt.org/UsbStorageHowto … 28HowTo%29</a></p><p>Think thats what you are looking for.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p26754">
				<div class="post-metadata">
					<div class="post-num">Post #56</div>
					<div class="post-author">star882</div>
					<div class="post-datetime">
						8 May 2006, 04:21					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>jimparis wrote:</cite><blockquote><p>Kernel patch: Add driver for serial flash</p><p>The F5D7230-4 v2000 router has a serial flash chip rather than the much more common parallel flash.&nbsp; The &quot;sflash&quot; MTD driver included in the original Broadcom and Belkin source releases is missing from OpenWRT.&nbsp; This patch re-adds that driver.</p><div class="codebox"><pre><code>Index: trunk/openwrt/target/linux/brcm-2.4/config
===================================================================
--- trunk/openwrt/target/linux/brcm-2.4/config  (revision 3440)
+++ trunk/openwrt/target/linux/brcm-2.4/config  (working copy)
@@ -246,6 +246,7 @@
 #
 # Self-contained MTD device drivers
 #
+CONFIG_MTD_SFLASH=y
 # CONFIG_MTD_PMC551 is not set
 # CONFIG_MTD_SLRAM is not set
 # CONFIG_MTD_MTDRAM is not set
Index: trunk/openwrt/target/linux/brcm-2.4/patches/051-sflash.patch
===================================================================
--- trunk/openwrt/target/linux/brcm-2.4/patches/051-sflash.patch        (revision 0)
+++ trunk/openwrt/target/linux/brcm-2.4/patches/051-sflash.patch        (revision 0)
@@ -0,0 +1,333 @@
+diff -urN linux-2.4.32.orig/drivers/mtd/devices/Config.in linux-2.4.32/drivers/mtd/devices/Config.in
+--- linux-2.4.32.orig/drivers/mtd/devices/Config.in    2006-03-22 18:16:57.000000000 -0500
++++ linux-2.4.32/drivers/mtd/devices/Config.in 2006-03-22 18:06:49.000000000 -0500
+@@ -5,6 +5,7 @@
+ mainmenu_option next_comment
+ 
+ comment &#039;Self-contained MTD device drivers&#039;
++bool &#039;  Broadcom Chipcommon Serial Flash support&#039; CONFIG_MTD_SFLASH
+ dep_tristate &#039;  Ramix PMC551 PCI Mezzanine RAM card support&#039; CONFIG_MTD_PMC551 $CONFIG_MTD $CONFIG_PCI
+ if [ &quot;$CONFIG_MTD_PMC551&quot; = &quot;y&quot; -o  &quot;$CONFIG_MTD_PMC551&quot; = &quot;m&quot; ]; then
+    bool &#039;    PMC551 256M DRAM Bugfix&#039; CONFIG_MTD_PMC551_BUGFIX
+diff -urN linux-2.4.32.orig/drivers/mtd/devices/Makefile linux-2.4.32/drivers/mtd/devices/Makefile
+--- linux-2.4.32.orig/drivers/mtd/devices/Makefile     2006-03-22 18:16:57.000000000 -0500
++++ linux-2.4.32/drivers/mtd/devices/Makefile  2006-03-22 18:06:49.000000000 -0500
+@@ -3,6 +3,8 @@
+ #
+ # $Id: Makefile,v 1.4 2001/06/26 21:10:05 spse Exp $
+ 
++EXTRA_CFLAGS := -I$(TOPDIR)/arch/mips/bcm947xx/include
++
+ O_TARGET      := devlink.o
+ 
+ #                       *** BIG UGLY NOTE ***
+@@ -12,6 +14,7 @@
+ # here where previously there was none.  We now have to ensure that
+ # doc200[01].o are linked before docprobe.o
+ 
++obj-$(CONFIG_MTD_SFLASH)      += sflash.o
+ obj-$(CONFIG_MTD_DOC1000)     += doc1000.o
+ obj-$(CONFIG_MTD_DOC2000)     += doc2000.o
+ obj-$(CONFIG_MTD_DOC2001)     += doc2001.o
+diff -urN linux-2.4.32.orig/drivers/mtd/devices/sflash.c linux-2.4.32/drivers/mtd/devices/sflash.c
+--- linux-2.4.32.orig/drivers/mtd/devices/sflash.c     1969-12-31 19:00:00.000000000 -0500
++++ linux-2.4.32/drivers/mtd/devices/sflash.c  2006-03-22 18:17:12.000000000 -0500
+@@ -0,0 +1,298 @@
++/*
++ * Broadcom SiliconBackplane chipcommon serial flash interface
++ *
++ * Copyright 2001-2003, Broadcom Corporation   
++ * All Rights Reserved.   
++ *    
++ * THIS SOFTWARE IS OFFERED &quot;AS IS&quot;, AND BROADCOM GRANTS NO WARRANTIES OF ANY   
++ * KIND, EXPRESS OR IMPLIED, BY STATUTE, COMMUNICATION OR OTHERWISE. BROADCOM   
++ * SPECIFICALLY DISCLAIMS ANY IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS   
++ * FOR A SPECIFIC PURPOSE OR NONINFRINGEMENT CONCERNING THIS SOFTWARE.   
++ *
++ * $Id: sflash.c,v 1.1.1.3 2003/11/10 17:43:38 hyin Exp $
++ */
++
++#include &lt;linux/config.h&gt;
++#include &lt;linux/module.h&gt;
++#include &lt;linux/slab.h&gt;
++#include &lt;linux/ioport.h&gt;
++#include &lt;linux/mtd/compatmac.h&gt;
++#include &lt;linux/mtd/mtd.h&gt;
++#include &lt;linux/mtd/partitions.h&gt;
++#include &lt;linux/errno.h&gt;
++#include &lt;linux/pci.h&gt;
++#include &lt;linux/delay.h&gt;
++#include &lt;asm/io.h&gt;
++
++#ifdef CONFIG_MTD_PARTITIONS
++#include &lt;linux/mtd/mtd.h&gt;
++#include &lt;linux/mtd/partitions.h&gt;
++#include &lt;linux/minix_fs.h&gt;
++#include &lt;linux/ext2_fs.h&gt;
++#include &lt;linux/romfs_fs.h&gt;
++#include &lt;linux/cramfs_fs.h&gt;
++#include &lt;linux/jffs2.h&gt;
++#endif
++
++#include &lt;typedefs.h&gt;
++#include &lt;bcmdevs.h&gt;
++#include &lt;bcmutils.h&gt;
++#include &lt;osl.h&gt;
++#include &lt;bcmutils.h&gt;
++#include &lt;bcmnvram.h&gt;
++#include &lt;sbconfig.h&gt;
++#include &lt;sbchipc.h&gt;
++#include &lt;sflash.h&gt;
++#include &lt;trxhdr.h&gt;
++
++#ifdef CONFIG_MTD_PARTITIONS
++extern struct mtd_partition * init_mtd_partitions(struct mtd_info *mtd, size_t size);
++#endif
++
++struct sflash_mtd {
++      chipcregs_t *cc;
++      struct semaphore lock;
++      struct mtd_info mtd;
++      struct mtd_erase_region_info regions[1];
++};
++
++/* Private global state */
++static struct sflash_mtd sflash;
++
++static int
++sflash_mtd_poll(struct sflash_mtd *sflash, unsigned int offset, int timeout)
++{
++      int now = jiffies;
++      int ret = 0;
++
++      for (;;) {
++              if (!sflash_poll(sflash-&gt;cc, offset)) {
++                      ret = 0;
++                      break;
++              }
++              if (time_after(jiffies, now + timeout)) {
++                      printk(KERN_ERR &quot;sflash: timeout\n&quot;);
++                      ret = -ETIMEDOUT;
++                      break;
++              }
++              if (current-&gt;need_resched) {
++                      set_current_state(TASK_UNINTERRUPTIBLE);
++                      schedule_timeout(timeout / 10);
++              } else
++                      udelay(1);
++      }
++
++      return ret;
++}
++
++static int
++sflash_mtd_read(struct mtd_info *mtd, loff_t from, size_t len, size_t *retlen, u_char *buf)
++{
++      struct sflash_mtd *sflash = (struct sflash_mtd *) mtd-&gt;priv;
++      int bytes, ret = 0;
++
++      /* Check address range */
++      if (!len)
++              return 0;
++      if ((from + len) &gt; mtd-&gt;size)
++              return -EINVAL;
++
++      down(&amp;sflash-&gt;lock);
++
++      *retlen = 0;
++      while (len) {
++              if ((bytes = sflash_read(sflash-&gt;cc, (uint) from, len, buf)) &lt; 0) {
++                      ret = bytes;
++                      break;
++              }
++              from += (loff_t) bytes;
++              len -= bytes;
++              buf += bytes;
++              *retlen += bytes;
++      }
++
++      up(&amp;sflash-&gt;lock);
++
++      return ret;
++}
++
++static int
++sflash_mtd_write(struct mtd_info *mtd, loff_t to, size_t len, size_t *retlen, const u_char *buf)
++{
++      struct sflash_mtd *sflash = (struct sflash_mtd *) mtd-&gt;priv;
++      int bytes, ret = 0;
++
++      /* Check address range */
++      if (!len)
++              return 0;
++      if ((to + len) &gt; mtd-&gt;size)
++              return -EINVAL;
++
++      down(&amp;sflash-&gt;lock);
++
++      *retlen = 0;
++      while (len) {
++              if ((bytes = sflash_write(sflash-&gt;cc, (uint) to, len, buf)) &lt; 0) {
++                      ret = bytes;
++                      break;
++              }
++              if ((ret = sflash_mtd_poll(sflash, (unsigned int) to, HZ / 10)))
++                      break;
++              to += (loff_t) bytes;
++              len -= bytes;
++              buf += bytes;
++              *retlen += bytes;
++      }
++
++      up(&amp;sflash-&gt;lock);
++
++      return ret;
++}
++
++static int
++sflash_mtd_erase(struct mtd_info *mtd, struct erase_info *erase)
++{
++      struct sflash_mtd *sflash = (struct sflash_mtd *) mtd-&gt;priv;
++      int i, j, ret = 0;
++      unsigned int addr, len;
++
++      /* Check address range */
++      if (!erase-&gt;len)
++              return 0;
++      if ((erase-&gt;addr + erase-&gt;len) &gt; mtd-&gt;size)
++              return -EINVAL;
++
++      addr = erase-&gt;addr;
++      len = erase-&gt;len;
++
++      down(&amp;sflash-&gt;lock);
++
++      /* Ensure that requested region is aligned */
++      for (i = 0; i &lt; mtd-&gt;numeraseregions; i++) {
++              for (j = 0; j &lt; mtd-&gt;eraseregions[i].numblocks; j++) {
++                      if (addr == mtd-&gt;eraseregions[i].offset + mtd-&gt;eraseregions[i].erasesize * j &amp;&amp;
++                          len &gt;= mtd-&gt;eraseregions[i].erasesize) {
++                              if ((ret = sflash_erase(sflash-&gt;cc, addr)) &lt; 0)
++                                      break;
++                              if ((ret = sflash_mtd_poll(sflash, addr, 10 * HZ)))
++                                      break;
++                              addr += mtd-&gt;eraseregions[i].erasesize;
++                              len -= mtd-&gt;eraseregions[i].erasesize;
++                      }
++              }
++              if (ret)
++                      break;
++      }
++
++      up(&amp;sflash-&gt;lock);
++
++      /* Set erase status */
++      if (ret)
++              erase-&gt;state = MTD_ERASE_FAILED;
++      else 
++              erase-&gt;state = MTD_ERASE_DONE;
++
++      /* Call erase callback */
++      if (erase-&gt;callback)
++              erase-&gt;callback(erase);
++
++      return ret;
++}
++
++#if LINUX_VERSION_CODE &lt; 0x20212 &amp;&amp; defined(MODULE)
++#define sflash_mtd_init init_module
++#define sflash_mtd_exit cleanup_module
++#endif
++
++mod_init_t
++sflash_mtd_init(void)
++{
++      struct pci_dev *pdev;
++      int ret = 0;
++      struct sflash *info;
++      uint bank, i;
++#ifdef CONFIG_MTD_PARTITIONS
++      struct mtd_partition *parts;
++#endif
++
++      if (!(pdev = pci_find_device(VENDOR_BROADCOM, SB_CC, NULL))) {
++              printk(KERN_ERR &quot;sflash: chipcommon not found\n&quot;);
++              return -ENODEV;
++      }
++
++      memset(&amp;sflash, 0, sizeof(struct sflash_mtd));
++      init_MUTEX(&amp;sflash.lock);
++
++      /* Map registers and flash base */
++      if (!(sflash.cc = ioremap_nocache(pci_resource_start(pdev, 0),
++                                        pci_resource_len(pdev, 0)))) {
++              printk(KERN_ERR &quot;sflash: error mapping registers\n&quot;);
++              ret = -EIO;
++              goto fail;
++      }
++
++      /* Initialize serial flash access */
++      info = sflash_init(sflash.cc);
++
++      if (!info) {
++              printk(KERN_ERR &quot;sflash: found no supported devices\n&quot;);
++              ret = -ENODEV;
++              goto fail;
++      }
++
++      /* Setup banks */
++      sflash.regions[0].offset = 0;
++      sflash.regions[0].erasesize = info-&gt;blocksize;
++      sflash.regions[0].numblocks = info-&gt;numblocks;
++      if (sflash.regions[0].erasesize &gt; sflash.mtd.erasesize)
++              sflash.mtd.erasesize = sflash.regions[0].erasesize;
++      if (sflash.regions[0].erasesize * sflash.regions[0].numblocks) {
++              sflash.mtd.size += sflash.regions[0].erasesize * sflash.regions[0].numblocks;
++      }
++      sflash.mtd.numeraseregions = 1;
++      ASSERT(sflash.mtd.size == info-&gt;size);
++
++      /* Register with MTD */
++      sflash.mtd.name = &quot;sflash&quot;;
++      sflash.mtd.type = MTD_NORFLASH;
++      sflash.mtd.flags = MTD_CAP_NORFLASH;
++      sflash.mtd.eraseregions = sflash.regions;
++      sflash.mtd.module = THIS_MODULE;
++      sflash.mtd.erase = sflash_mtd_erase;
++      sflash.mtd.read = sflash_mtd_read;
++      sflash.mtd.write = sflash_mtd_write;
++      sflash.mtd.priv = &amp;sflash;
++
++#ifdef CONFIG_MTD_PARTITIONS
++      parts = init_mtd_partitions(&amp;sflash.mtd, sflash.mtd.size);
++      for (i = 0; parts[i].name; i++);
++      ret = add_mtd_partitions(&amp;sflash.mtd, parts, i);
++#else
++      ret = add_mtd_device(&amp;sflash.mtd);
++#endif
++      if (ret) {
++              printk(KERN_ERR &quot;sflash: add_mtd failed\n&quot;);
++              goto fail;
++      }
++
++      return 0;
++
++ fail:
++      if (sflash.cc)
++              iounmap((void *) sflash.cc);
++      return ret;
++}
++
++mod_exit_t
++sflash_mtd_exit(void)
++{
++#ifdef CONFIG_MTD_PARTITIONS
++      del_mtd_partitions(&amp;sflash.mtd);
++#else
++      del_mtd_device(&amp;sflash.mtd);
++#endif
++      iounmap((void *) sflash.cc);
++}
++
++module_init(sflash_mtd_init);
++module_exit(sflash_mtd_exit);</code></pre></div><p>Download: <a href="http://jim.sh/~jim/openwrt-patches/svn-02-sflash.patch">svn-02-sflash.patch</a></p></blockquote></div><p>How am I supposed to use the patch? It doesn&#039;t appear to work.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p27114">
				<div class="post-metadata">
					<div class="post-num">Post #57</div>
					<div class="post-author">malbert76</div>
					<div class="post-datetime">
						13 May 2006, 13:46					</div>
				</div>
				<div class="post-content content">
					<p>dd-wrt now supports the f5d7230-4 v1444 and other belkin.</p><p>Please check: <a href="http://www.dd-wrt.com">http://www.dd-wrt.com</a>/</p><p>i hope openwrt will do the same soon!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p34811">
				<div class="post-metadata">
					<div class="post-num">Post #58</div>
					<div class="post-author">Seth7</div>
					<div class="post-datetime">
						3 Oct 2006, 09:47					</div>
				</div>
				<div class="post-content content">
					<p>Sorry .. but it did brick my V2000 , or it off in some odd IP address that i havent found yet ...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p81669">
				<div class="post-metadata">
					<div class="post-num">Post #59</div>
					<div class="post-author">Trax</div>
					<div class="post-datetime">
						11 Feb 2009, 23:25					</div>
				</div>
				<div class="post-content content">
					<p>Any progress on this unit?<br />I got one (for free) and would like to use it with OpenWrt</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p82520">
				<div class="post-metadata">
					<div class="post-num">Post #60</div>
					<div class="post-author">frank33</div>
					<div class="post-datetime">
						24 Feb 2009, 00:56					</div>
				</div>
				<div class="post-content content">
					<p>The kernel sflash driver is not working on current kamikaze ... It&#039;s in the wrong directory, should be in /arch/mips/bcm947xx..<br />The actual kernel module is not included and what Jimparis made doesn&#039;t work anymore .. as do the other versions of /drivers/mtd/devices/sflash.c floating around the net..</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107782">
				<div class="post-metadata">
					<div class="post-num">Post #61</div>
					<div class="post-author">ps2chiper</div>
					<div class="post-datetime">
						24 Apr 2010, 22:00					</div>
				</div>
				<div class="post-content content">
					<p>It should be fixed now.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p125591">
				<div class="post-metadata">
					<div class="post-num">Post #62</div>
					<div class="post-author">soilfish</div>
					<div class="post-datetime">
						16 Jan 2011, 08:57					</div>
				</div>
				<div class="post-content content">
					<p>This v2000 router doesn&#039;t have a parallel flash chip -----If i change the flash to 32mb and ram to 64mb it can work with openwrt? ..but i don not konw any code about linux or the other if i supply the flash and ram version any one can make me a fireware-_- I can replace the flash and ram by my self!! anyone can help me ?</p>											<p class="post-edited">(Last edited by <strong>soilfish</strong> on 16 Jan 2011, 09:00)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 3 of 3</div><nav><ul><li><a href="viewtopic.php%3Fid=4929&amp;p=1.html">1</a></li><li><a href="viewtopic.php%3Fid=4929&amp;p=2.html">2</a></li><li class="pagination-current"><span>3</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>