<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> A qos script that really works!</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 1 Apr 2018 and 30 Apr 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 17 of 20</div><nav><ul><li><a href="viewtopic.php%3Fid=4112&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=4112&amp;p=15.html">15</a></li><li><a href="viewtopic.php%3Fid=4112&amp;p=16.html">16</a></li><li class="pagination-current"><span>17</span></li><li><a href="viewtopic.php%3Fid=4112&amp;p=18.html">18</a></li><li><a href="viewtopic.php%3Fid=4112&amp;p=19.html">19</a></li><li><a href="viewtopic.php%3Fid=4112&amp;p=20.html">20</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p35086">
				<div class="post-metadata">
					<div class="post-num">Post #401</div>
					<div class="post-author">jp</div>
					<div class="post-datetime">
						9 Oct 2006, 04:25					</div>
				</div>
				<div class="post-content content">
					<p>I tried both, and I&#039;m not sure if I see any difference.<br />One thing that happened is that with ndb&#039;s scripts I had a huge latency for HTTP, but I suspect this has more to do with my ISP than anything else. I&#039;m running Rudy&#039;s sripts now to see if the latency problem persists.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p35087">
				<div class="post-metadata">
					<div class="post-num">Post #402</div>
					<div class="post-author">db90h</div>
					<div class="post-datetime">
						9 Oct 2006, 04:41					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>jp wrote:</cite><blockquote><p>I tried both, and I&#039;m not sure if I see any difference.<br />One thing that happened is that with ndb&#039;s scripts I had a huge latency for HTTP, but I suspect this has more to do with my ISP than anything else. I&#039;m running Rudy&#039;s sripts now to see if the latency problem persists.</p></blockquote></div><p>Please let me know the results. I too believe its probably not related to nbd&#039;s scrripts. I know that I prefer the configuration format of nbd&#039;s scripts, but Rudy&#039;s scripts are so popular that there is surely some good reason people prefer them. </p><p>It seems ridiculous for us to support two QoS scripts in webif^2, so I am even considering just choosing one and going with it. We already have a page to configure Rudy&#039;s scripts, but it needs some work according to the author. Of course, if both scripts used a compatible configuration file format (or a translator existed) this wouldn&#039;t be an issue.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p35103">
				<div class="post-metadata">
					<div class="post-num">Post #403</div>
					<div class="post-author">jp</div>
					<div class="post-datetime">
						9 Oct 2006, 11:53					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><blockquote><p>It seems ridiculous for us to support two QoS scripts in webif^2, so I am even considering just choosing one and going with it.</p></blockquote></div><p>Well... I wouldn&#039;t say it&#039;s ridiculous. I think that since both are used by so many people, both could be supported (unless it makes thinks to complex for you, of course). You have a set of functions that are implemented in different ways for each script -- as if you were writing classes derived from an abstract one, I suppose?</p><p>-- jp</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p35115">
				<div class="post-metadata">
					<div class="post-num">Post #404</div>
					<div class="post-author">thepeople</div>
					<div class="post-datetime">
						9 Oct 2006, 16:23					</div>
				</div>
				<div class="post-content content">
					<p>The loading and saving of the settings will have to be rewritten for nbd&#039;s scripts. We have the functions already there for nbd&#039;s config file format (thanks nbd) it just needs to be written.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p35165">
				<div class="post-metadata">
					<div class="post-num">Post #405</div>
					<div class="post-author">db90h</div>
					<div class="post-datetime">
						10 Oct 2006, 10:42					</div>
				</div>
				<div class="post-content content">
					<p>jp, I do agree that in theory we can use a common page with abstracted load/save code.</p><p>As with everything, its a matter of work. So I suppose the final decision will come down to if anyone does this work or not <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" />. We&#039;ll do something with nbd&#039;s scripts, I guess.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p35469">
				<div class="post-metadata">
					<div class="post-num">Post #406</div>
					<div class="post-author">mcdonald</div>
					<div class="post-datetime">
						16 Oct 2006, 01:24					</div>
				</div>
				<div class="post-content content">
					<p>I just installed rudy&#039;s QoS scripts. I measured my line speed at dslreports.com/stest and got 9120 down / 360 up. Then I put in the conf file 8200 down / 324 up (90% of measured max). Then I did the speed test again and found that my speed is now 5548 down / 297 up. Is this the normal behavior of QoS? I would expect it to be able to use the set bandwidth to its fullest since I do not have any other traffic.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p35709">
				<div class="post-metadata">
					<div class="post-num">Post #407</div>
					<div class="post-author">phat_bastard</div>
					<div class="post-datetime">
						19 Oct 2006, 22:30					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ll just install manually and get the necessary scripts off the router, but just FYI... trying to use the qos-re package in imagebuilder I get:</p><div class="codebox"><pre><code>Unpacking qos-re...Done.
Configuring qos-re...env: /etc/hotplug.d/iface/20-qos: No such file or directory</code></pre></div><p>Edit: however odd, the 20-qos script is in fact there when I flashed the firmware, so no matter... <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>											<p class="post-edited">(Last edited by <strong>phat_bastard</strong> on 19 Oct 2006, 23:20)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p35731">
				<div class="post-metadata">
					<div class="post-num">Post #408</div>
					<div class="post-author">db90h</div>
					<div class="post-datetime">
						20 Oct 2006, 06:26					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mcdonald wrote:</cite><blockquote><p>I just installed rudy&#039;s QoS scripts. I measured my line speed at dslreports.com/stest and got 9120 down / 360 up. Then I put in the conf file 8200 down / 324 up (90% of measured max). Then I did the speed test again and found that my speed is now 5548 down / 297 up. Is this the normal behavior of QoS? I would expect it to be able to use the set bandwidth to its fullest since I do not have any other traffic.</p></blockquote></div><p>We&#039;ll assume these results are accurate (a big assumption for an internet bandwidth test). It is possible that the addition of the QoS scripts caused additional overhead that lowered your maximum sustained WAN throughput. You could test this theory a number of ways. One would be to disable any l7 filters, include ipp2p. Then see if the speed improves or not. Another possible, but less certain test would be to overclock your router and see if there is a proportional gain in throughput (assuming CPU and/or backplane clock speed is a limiting factor).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p35840">
				<div class="post-metadata">
					<div class="post-num">Post #409</div>
					<div class="post-author">TeKa</div>
					<div class="post-datetime">
						22 Oct 2006, 13:34					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>I&#039;d like to know if it s possible to dedicate 100Kb for the VoIP without knowing my bandwith.<br />I move a lot with my WRT, I dont want to always set the bandwith !!</p><p>Is it possible ??!!</p><p>Thank you</p><p>Bye</p>											<p class="post-edited">(Last edited by <strong>TeKa</strong> on 26 Oct 2006, 14:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p36424">
				<div class="post-metadata">
					<div class="post-num">Post #410</div>
					<div class="post-author">rudy</div>
					<div class="post-datetime">
						2 Nov 2006, 10:01					</div>
				</div>
				<div class="post-content content">
					<p>Hi jf,</p><p>Just noticed your post, sorry about the delay(went without internet connection for 3 months due to some provider mess up...).</p><p>Adding a port number to the the ip address is an interesting suggestion. Will look into this for an upcoming release.</p><p>Rudy.</p><div class="quotebox"><cite>jp wrote:</cite><blockquote><p>Hi Rudy.<br />I&#039;ve been using your package, and it works really well.</p><p>But is there a way to specify that traffic to/from a compination of IP and port should get into PRIO, for example?<br />I don&#039;t want to get all trafic from one IP as prioritized, because that computer also does FTP and download updates from MS, etc. On the other hand, I don&#039;t want to set all HTTP traffic to PRIO, because other computers do bulk HTTP transfers, and that would break QoS completely.</p><p>So... Would it be easy to add support for something like this?</p><p>PRIO=&quot;192.168.1.100:80&quot;</p><p>That would be really great!</p><p>-- jp</p></blockquote></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p36509">
				<div class="post-metadata">
					<div class="post-num">Post #411</div>
					<div class="post-author">rudy</div>
					<div class="post-datetime">
						3 Nov 2006, 16:40					</div>
				</div>
				<div class="post-content content">
					<p>Version 1.05 of qos-re is now available. It includes the option to specify a port number or port range along with an IP address. This will help prioritize traffic to and from a multipurpose server with different services, such as http and ftp, running concurrently.</p><p>Install with:<br /></p><div class="codebox"><pre><code>ipkg install http://files.eschauzier.org/qos-re_1.05_all.ipk</code></pre></div><p>The changelog:<br />1. Added option to specify port number or port range with IP address based matching<br />2. Changed documentation in qos.conf to reflect new option</p><p>The hfsc version of the v1.05 script is also available, install with:<br /></p><div class="codebox"><pre><code>ipkg install http://files.eschauzier.org/qos-re-hfsc_1.05_all.ipk</code></pre></div><p>The changelog is the same as for qos-re.</p><p>To obtain the new /etc/qos.conf file with updated documention on the new IP ports option, make sure you answer Yes during installation when asked to overwrite the existing file. Also, you may need to remove existing packages when installing a package with a new name (e.g. qos-re-hfsc over qos-re). In both cases the original /etc/qos.conf will be lost, so please make sure you save a copy of the current configuration file.</p><p>After modifying /etc/qos.conf, you will need to run <strong>qos-start</strong> to load the new settings. The command <strong>qos-stat</strong> is available to check the current QoS status.</p><p>The bare scripts and config file can be found here:<br />HTB version of the script: <a href="http://files.eschauzier.org/whiterussian/20-qos-htb">20-qos-htb</a><br />HFSC version of the script: <a href="http://files.eschauzier.org/whiterussian/20-qos-hfsc">20-qos-hfsc</a><br />Default configuration file for both versions: <a href="http://files.eschauzier.org/qos.conf">qos.conf</a></p>											<p class="post-edited">(Last edited by <strong>rudy</strong> on 30 Dec 2011, 11:00)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p36537">
				<div class="post-metadata">
					<div class="post-num">Post #412</div>
					<div class="post-author">stevevai</div>
					<div class="post-datetime">
						4 Nov 2006, 11:14					</div>
				</div>
				<div class="post-content content">
					<p>i would like to congratulate and say thank you to rudy for this great script.</p><p>i have a wifi internet at home (max 385kbps, slow actually) and i have to share it with a room mate. problem is that he leaves his pc downloading files from torrent sites all day leaving me a small portion of the bandwidth. i tried blocking p2p and said that the router was broken. now he&#039;s suspicious about it. </p><p>thanks to your script, now i can use the internet and set 10 percent of the whole bandwidth for p2p (even with many p2p connections, the combined download speed for p2p is just 38.5kbps).</p><p>here&#039;s my script:</p><p>TCP_BULK=&quot;0:&quot;<br />UDP_BULK=&quot;0:&quot;</p><p>TCP_PRIO=&quot;22 23 53 80 443 1863 5050&quot;</p><p>tc class add dev $LAN parent 1:1 classid 1:10 htb rate $(($DOWNLOAD*1/10))kbit ceil ${DOWNLOAD*10/100}kbit burst $D_BURST cburst $D_BURST prio 0<br />tc class add dev $LAN parent 1:1 classid 1:20 htb rate $(($DOWNLOAD*1/100))kbit ceil $(($DOWNLOAD*5/100))kbit burst $D_BURST cburst $D_BURST prio 1</p><p>it&#039;s not that i hate p2p. i use it only when i have a very fast connection and i&#039;m not causing any problems with other users sharing the same connection</p><p>regards......steve</p>											<p class="post-edited">(Last edited by <strong>stevevai</strong> on 4 Nov 2006, 11:17)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p36545">
				<div class="post-metadata">
					<div class="post-num">Post #413</div>
					<div class="post-author">rudy</div>
					<div class="post-datetime">
						4 Nov 2006, 12:36					</div>
				</div>
				<div class="post-content content">
					<p>Good to hear the script is working for you!</p><p>Just for my information, what is the reason you made the changes to the two tc lines in the script? Didn&#039;t the default config work for you? With the default configuration, I&#039;d expect the script to do exactly what you are looking for. In fact, it seems it would have the added benefit that when you are not using the shared internet connection, your roommate can run his p2p at near full speed, only to back off once you get online.</p><p>I am probably overlooking something, please let me know.</p><div class="quotebox"><cite>stevevai wrote:</cite><blockquote><p>thanks to your script, now i can use the internet and set 10 percent of the whole bandwidth for p2p (even with many p2p connections, the combined download speed for p2p is just 38.5kbps).</p><p>here&#039;s my script:</p><p>TCP_BULK=&quot;0:&quot;<br />UDP_BULK=&quot;0:&quot;</p><p>TCP_PRIO=&quot;22 23 53 80 443 1863 5050&quot;</p><p>tc class add dev $LAN parent 1:1 classid 1:10 htb rate $(($DOWNLOAD*1/10))kbit ceil ${DOWNLOAD*10/100}kbit burst $D_BURST cburst $D_BURST prio 0<br />tc class add dev $LAN parent 1:1 classid 1:20 htb rate $(($DOWNLOAD*1/100))kbit ceil $(($DOWNLOAD*5/100))kbit burst $D_BURST cburst $D_BURST prio 1</p></blockquote></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p36588">
				<div class="post-metadata">
					<div class="post-num">Post #414</div>
					<div class="post-author">stevevai</div>
					<div class="post-datetime">
						5 Nov 2006, 02:07					</div>
				</div>
				<div class="post-content content">
					<p>i&#039;ve been experimenting with the settings last night (running bittorent while testing the bandwidth speed) and here is my latest setting</p><p>tc class add dev $LAN parent 1:1 classid 1:10 htb rate $(($DOWNLOAD*8/10))kbit ceil ${DOWNLOAD}kbit burst $D_BURST cburst $D_BURST prio 0<br />tc class add dev $LAN parent 1:1 classid 1:20 htb rate $(($DOWNLOAD*2/10))kbit ceil $(($DOWNLOAD*8/100))kbit burst $D_BURST cburst $D_BURST prio 1</p><p>i have to set it this way so that the bandwidth speed test result is still around 300kbps and to discourage my room mate to use p2p while were not upgrading to a dsl line. also our there is only one active cellsite in our area (the others are still being fixed due to last storm) and sometimes the bandwidth drops terribly.</p><p>thanks for the concern rudy! <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>											<p class="post-edited">(Last edited by <strong>stevevai</strong> on 5 Nov 2006, 02:10)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p37130">
				<div class="post-metadata">
					<div class="post-num">Post #415</div>
					<div class="post-author">garageguy</div>
					<div class="post-datetime">
						14 Nov 2006, 09:17					</div>
				</div>
				<div class="post-content content">
					<p>Is there a way to customize the mark values that the qos script is using?</p><p>I am attempting to run both qos-re_1.04 and nocatsplash.&nbsp; Both of these like to mark<br />some packets with MARK set 0x4 for quite different purposes and as a result they<br />seem to be stepping on each other&#039;s toes.</p><p>Thanks in advance for any help!</p><p>--Paul</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p37136">
				<div class="post-metadata">
					<div class="post-num">Post #416</div>
					<div class="post-author">rudy</div>
					<div class="post-datetime">
						14 Nov 2006, 10:21					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>garageguy wrote:</cite><blockquote><p>Is there a way to customize the mark values that the qos script is using?</p></blockquote></div><p>You will need to modify both the sections that marks the packets, and the part that catches the marked packets. Lines that mark the packets look like:<br /></p><div class="codebox"><pre><code>iptables -t mangle -A mark_chain -m mark --mark 0 -p udp --dport $PORT -j MARK --set-mark 1
iptables -t mangle -A mark_chain -m mark --mark 0 -p udp --dport $PORT -j MARK --set-mark 2
iptables -t mangle -A mark_chain -m mark --mark 0 -p udp --dport $PORT -j MARK --set-mark 4</code></pre></div><p>You&#039;ll need to change the number after &#039;--set-mark&#039; (e.g. add 10)</p><p>while lines for catching the marked packets look like:<br /></p><div class="codebox"><pre><code>tc filter add dev $QOS_IF parent 1: prio 1 protocol ip handle 1 fw flowid 1:10
tc filter add dev $QOS_IF parent 1: prio 2 protocol ip handle 2 fw flowid 1:20
tc filter add dev $QOS_IF parent 1: prio 3 protocol ip handle 3 fw flowid 1:30
tc filter add dev $QOS_IF parent 1: prio 4 protocol ip handle 4 fw flowid 1:40</code></pre></div><p>Here you need to change the number following &#039;handle&#039;. Make sure it still matches the number as it was marked. Consistently adding 10 will do the trick.</p><p>Finally, you may want the edit the debug section:<br /></p><div class="codebox"><pre><code>[ &quot;$DEBUG&quot; -eq 1 ] &amp;&amp; iptables -t mangle -A egress_chain -m mark --mark 1 -j LOG --log-prefix egress_1::
[ &quot;$DEBUG&quot; -eq 1 ] &amp;&amp; iptables -t mangle -A egress_chain -m mark --mark 2 -j LOG --log-prefix egress_2::
[ &quot;$DEBUG&quot; -eq 1 ] &amp;&amp; iptables -t mangle -A egress_chain -m mark --mark 3 -j LOG --log-prefix egress_3::
[ &quot;$DEBUG&quot; -eq 1 ] &amp;&amp; iptables -t mangle -A egress_chain -m mark --mark 4 -j LOG --log-prefix egress_4::</code></pre></div><p>These lines require you to change both the number following &#039;--mark&#039; and following egress_/ingress_. Make sure you don&#039;t change the &#039;--mark 0&#039; lines.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p37143">
				<div class="post-metadata">
					<div class="post-num">Post #417</div>
					<div class="post-author">jp</div>
					<div class="post-datetime">
						14 Nov 2006, 11:41					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><blockquote><p>Version 1.05 of qos-re is now available. It includes the option to specify a port number or port range along with an IP address.</p></blockquote></div><p>THANKS!!! :-)<br />Really -- your work has been great, rudy!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p37165">
				<div class="post-metadata">
					<div class="post-num">Post #418</div>
					<div class="post-author">landerx</div>
					<div class="post-datetime">
						14 Nov 2006, 16:27					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>I was reading in some QOS furoms, and they swear that incoming bandwidth shaping by IP must be done on local LAN interface (they call it green interface).</p><p>In the case of a regular WRT54G in AP mode, i think it is BR0 (bridge between lan and wlan).</p><p>What they argue if we do NAT, IMQ &amp; WAN interfaces won&#039;t be aware of local IP addressing so mangle rules won&#039;t have any effect on marking traffic.</p><p>My question is, if set IP_EXPR=&quot;192.168.1.23&quot; (my VOIP device), is it going have any effect on incoming bandwidth shaping with your qos-script (hfsc or htb)?</p><p>May be you are doing something different, or I really don&#039;t know ... just trying to make sense.</p><br /><p>Thank you very much for your great work on the scripts. They have been very useful on keeping my pals torrent&#039;s from taking over my DSL line <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" />.</p><p>Than you again, and best regards.</p><br /><p>Homero Leal</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p37168">
				<div class="post-metadata">
					<div class="post-num">Post #419</div>
					<div class="post-author">rudy</div>
					<div class="post-datetime">
						14 Nov 2006, 17:56					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>landerx wrote:</cite><blockquote><p>I was reading in some QOS furoms, and they swear that incoming bandwidth shaping by IP must be done on local LAN interface (they call it green interface).<br />What they argue if we do NAT, IMQ &amp; WAN interfaces won&#039;t be aware of local IP addressing so mangle rules won&#039;t have any effect on marking traffic.</p></blockquote></div><p>The qos-re script proves these &quot;unidentified sources&quot; wrong <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><div class="quotebox"><cite>landerx wrote:</cite><blockquote><p>My question is, if set IP_EXPR=&quot;192.168.1.23&quot; (my VOIP device), is it going have any effect on incoming bandwidth shaping with your qos-script (hfsc or htb)?</p></blockquote></div><p>Absolutely. This is how I use the script, with excellent results. No breakups of the VoIP even with the heaviest downloads.</p><div class="quotebox"><cite>landerx wrote:</cite><blockquote><p>May be you are doing something different, or I really don&#039;t know ... just trying to make sense.</p></blockquote></div><p>What can I say; let me know if it works for you...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p37205">
				<div class="post-metadata">
					<div class="post-num">Post #420</div>
					<div class="post-author">landerx</div>
					<div class="post-datetime">
						15 Nov 2006, 02:14					</div>
				</div>
				<div class="post-content content">
					<p>That was quick. Thank you for your fast response!!! </p><p>VOIP works sometimes, but sometimes it works not.</p><p>I&#039;m suspecting my DSL provider has a very variable bandwidth over the time, and this may be the problem.</p><p>Sometimes i have 800kbit download, sometimes 720kbit.</p><p>Is there any way to have downlaod and upload bandwidth adjusting depending on the actual rate?</p><p>I heard about some scipts wich measure ping time, and then do some calculations in order to adjust the bandwidth limits, but haven&#039;t tested any of them.</p><p>And by the way, I did a &quot;iptables -L -t mangle -v -n&quot; and found this result on the mark chain:</p><p>Chain mark_chain (2 references)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />1054K&nbsp; 483M CONNMARK&nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK match 0x0 CONNMARK restore <br />&nbsp; 309 19391 MARK&nbsp; &nbsp; &nbsp; &nbsp;udp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK match 0x0 udp dpt:53 MARK set 0x2 <br />&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0 MARK&nbsp; &nbsp; &nbsp; &nbsp;tcp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK match 0x0 tcp dpt:22 MARK set 0x2 <br />&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0 MARK&nbsp; &nbsp; &nbsp; &nbsp;tcp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK match 0x0 tcp dpt:23 MARK set 0x2 <br />&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0 MARK&nbsp; &nbsp; &nbsp; &nbsp;tcp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK match 0x0 tcp dpt:5900 MARK set 0x2 <br />&nbsp; &nbsp; 1&nbsp; &nbsp; 48 MARK&nbsp; &nbsp; &nbsp; &nbsp;tcp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK match 0x0 tcp dpt:53 MARK set 0x2 <br />&nbsp; &nbsp;34&nbsp; 1752 MARK&nbsp; &nbsp; &nbsp; &nbsp;tcp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK match 0x0 tcp dpt:9239 MARK set 0x2 <br /> 116K 9851K MARK&nbsp; &nbsp; &nbsp; &nbsp;udp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK match 0x0 udp dpts:1024:65535 MARK set 0x4 <br />20554 1016K MARK&nbsp; &nbsp; &nbsp; &nbsp;tcp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK match 0x0 tcp dpts:1024:65535 MARK set 0x4 <br />&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0 MARK&nbsp; &nbsp; &nbsp; &nbsp;tcp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK match 0x0 tcp dpt:21 MARK set 0x4 <br /><strong>&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK match 0x0 ipp2p v0.8.1_rc1 --ipp2p MARK set 0x4 </strong><br /><strong>&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK match 0x0 LAYER7 l7proto ares MARK set 0x4 </strong><br /> 6215&nbsp; 321K MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK match 0x0 MARK set 0x3 <br />1064K&nbsp; 489M CONNMARK&nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CONNMARK save&nbsp; <br />16821 1022K MARK&nbsp; &nbsp; &nbsp; &nbsp;icmp --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK set 0x1 <br />&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0 MARK&nbsp; &nbsp; &nbsp; &nbsp;58&nbsp; &nbsp;--&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK set 0x1 </p><br /><p>According to this, ipp2p and l7proto rules aren&#039;t having any effect... right?, since packets and bytes are 0.</p><p>Any idea of what could be happening? Most of the time, Ares is the p2p client used in this pc&#039;s.</p><p>Also, &quot;CONNMARK save&quot; has 1064K packets and 489M bytes wich sounds somekind of strange</p><p>If ares is not being detected by ipp2p or l7 filters, then should it be marked by mark 0x03?</p><p>May be so many questions for a single post, sorry for that.</p><p>Thank you in advance and best regards.</p><br /><p>Homero Leal</p>											<p class="post-edited">(Last edited by <strong>landerx</strong> on 15 Nov 2006, 02:22)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p37227">
				<div class="post-metadata">
					<div class="post-num">Post #421</div>
					<div class="post-author">rudy</div>
					<div class="post-datetime">
						15 Nov 2006, 11:48					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>landerx wrote:</cite><blockquote><p>I&#039;m suspecting my DSL provider has a very variable bandwidth over the time, and this may be the problem.<br />Sometimes i have 800kbit download, sometimes 720kbit.<br />Is there any way to have downlaod and upload bandwidth adjusting depending on the actual rate?</p></blockquote></div><p>There are some efforts that are geared specifically to wireless connections with variable bit rates. None that I am aware of are mature enough that you want to use them on your OpenWRT router, though.</p><div class="quotebox"><cite>landerx wrote:</cite><blockquote><p><strong>0&nbsp; &nbsp; &nbsp;0 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK match 0x0 ipp2p v0.8.1_rc1 --ipp2p MARK set 0x4<br />0&nbsp; &nbsp; &nbsp;0 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK match 0x0 LAYER7 l7proto ares MARK set 0x4</strong><br />According to this, ipp2p and l7proto rules aren&#039;t having any effect... right?, since packets and bytes are 0.</p><p>Any idea of what could be happening? Most of the time, Ares is the p2p client used in this pc&#039;s.</p></blockquote></div><p>I don&#039;t think ipp2p and l7proto identify Ares traffic well. You may want to try the --ares option to ipp2p (may require additional modules, I haven&#039;t tested this). For l7 the option for Ares is --l7proto ares (again, this will probably require you to load additional modules).<br />Anyway, if you are using the default port for Ares (UDP port 32285), I&#039;d expect the high port rules to catch the traffic and mark it as bulk. This would explain the high data volume on these rules:<br /></p><div class="codebox"><pre><code>116K 9851K MARK       udp  --  *      *       0.0.0.0/0            0.0.0.0/0           MARK match 0x0 udp dpts:1024:65535 MARK set 0x4
20554 1016K MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           MARK match 0x0 tcp dpts:1024:65535 MARK set 0x4</code></pre></div><p>Checking /proc/net/ip_conntrack will give you more insight in how connections are marked. You may also want to enable the debug mode, which will log each packet with its marking to logread.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p37540">
				<div class="post-metadata">
					<div class="post-num">Post #422</div>
					<div class="post-author">garageguy</div>
					<div class="post-datetime">
						21 Nov 2006, 07:30					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>rudy wrote:</cite><blockquote><div class="quotebox"><cite>garageguy wrote:</cite><blockquote><p>Is there a way to customize the mark values that the qos script is using?</p></blockquote></div><p>You will need to modify both the sections that marks the packets, and the part that catches the marked packets.</p></blockquote></div><p>Thanks, Rudy, works good now.</p><p>Some comments: </p><p>1.&nbsp; To make it easier for 20-qos to work with other things that are using iptables to mark packets,<br />maybe the mark values could be specified in qos.conf?</p><p>2.&nbsp; Along those lines, qos-stop seems to flush the entire mangle table, not just rules used by qos.<br />This seems to make it hard for other packet marking apps to play with qos.</p><p>3.&nbsp; Wondering why qos installs under /etc/hotplug.d/iface and not /etc/init.d?&nbsp; As with the other<br />comments, I don&#039;t really know the issues here, I&#039;m just more used to dealing with init.d scripts to <br />customize OpenWRT.</p><p>Thanks again,</p><p>--Paul</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p37663">
				<div class="post-metadata">
					<div class="post-num">Post #423</div>
					<div class="post-author">rudy</div>
					<div class="post-datetime">
						23 Nov 2006, 12:02					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>garageguy wrote:</cite><blockquote><div class="quotebox"><cite>rudy wrote:</cite><blockquote><div class="quotebox"><cite>garageguy wrote:</cite><blockquote><p>Is there a way to customize the mark values that the qos script is using?</p></blockquote></div><p>You will need to modify both the sections that marks the packets, and the part that catches the marked packets.</p></blockquote></div><p>Thanks, Rudy, works good now.</p></blockquote></div><p>Great!</p><div class="quotebox"><cite>garageguy wrote:</cite><blockquote><p>1.&nbsp; To make it easier for 20-qos to work with other things that are using iptables to mark packets,<br />maybe the mark values could be specified in qos.conf?</p></blockquote></div><p>I don&#039;t think I want to go that way. It seems to me it would needlessly complicate configuration for 99.9% of the users who simply want QoS that is easy to configure and reliable. The remaining 0.1% who want the QoS scripts to work with other iptables applications, will need to deal with all sorts of issues anyway, manually changing the mark values in the script most likely being the least of them <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><div class="quotebox"><cite>garageguy wrote:</cite><blockquote><p>2.&nbsp; Along those lines, qos-stop seems to flush the entire mangle table, not just rules used by qos.<br />This seems to make it hard for other packet marking apps to play with qos.</p></blockquote></div><p>Case in point. You will need to make sure all the iptables mangle rules are updated after a qos-stop, reboot or any other event that clears the mangle table.</p><div class="quotebox"><cite>garageguy wrote:</cite><blockquote><p>3.&nbsp; Wondering why qos installs under /etc/hotplug.d/iface and not /etc/init.d?&nbsp; As with the other<br />comments, I don&#039;t really know the issues here, I&#039;m just more used to dealing with init.d scripts to <br />customize OpenWRT.</p></blockquote></div><p>There has been some discussion on this in this thread (it is getting quite long, I know...). The main reason for 20-qos to be in hotplug is for PPP connections. Only once the PPP connection comes up, do we have our WAN interface available.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p38940">
				<div class="post-metadata">
					<div class="post-num">Post #424</div>
					<div class="post-author">trappedinaustin</div>
					<div class="post-datetime">
						16 Dec 2006, 00:32					</div>
				</div>
				<div class="post-content content">
					<p>Hi.&nbsp; Thanks for this great QoS script and the support.&nbsp; I&#039;ve learned a lot reading this thread.&nbsp; </p><p>I have your latest scripts installed and I think they are set up correctly.&nbsp; I can see the mark=4 in the conntrack table on my bittorrent traffic and mark=1 on my web traffic.&nbsp; I have tested my connection speed multiple times and think i have the upload and download speeds set correctly.&nbsp; Unfortunately, my web browsing is still much worse with bittorrent on.&nbsp; I would say pages take almost twice as long to load with bittorrent on.&nbsp; The QoS is definitely helping; without it, the web is unusable while DLing.&nbsp; I think i have a crappy cable modem connection (RoadRunner, Austin, TX) and the download and upload is very &#039;bursty&#039; sometimes with a few seconds no bandwidth at all.&nbsp; Could this be confusing the algorithm?&nbsp; I know the point of your script is to provide a good web experience without killing download speeds, but I am willing to give up more bittorrent speed for a faster web.&nbsp; Is there a way to edit the script so that if any priority traffic is detected, all the bulk traffic gets killed for a minute or so?&nbsp; I would like 90-100% of the bandwidth to go to the web when I am using it and I dont care about DL speed.&nbsp; It is called &quot;bulk&quot; after all.&nbsp; I think this would improve things and over the course of 24 hours I dont think my DL speed would suffer much because I am only using the web for a few hours a day.&nbsp; Any ideas on how to do something like this?&nbsp; Thanks!!</p><p>Martin</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p38956">
				<div class="post-metadata">
					<div class="post-num">Post #425</div>
					<div class="post-author">ziggurat29</div>
					<div class="post-datetime">
						16 Dec 2006, 06:20					</div>
				</div>
				<div class="post-content content">
					<p>trapped in austin:<br />I&#039;m in Austin too (well, Cear Park), using RoadRunner, and I am successfully running using these scripts.&nbsp; I have about 30 torrents going on now and am able to browse quite happily.&nbsp; Here is my qos.conf in case it helps:</p><div class="quotebox"><blockquote><p>DOWNLOAD=4940</p><p>UPLOAD=320</p><p>L7_BULK=&quot;&quot;<br />L7_PRIO=&quot;&quot;<br />L7_EXPR=&quot;&quot;</p><p>IPP2P_BULK=&quot;ipp2p&quot;<br />IPP2P_PRIO=&quot;&quot;<br />IPP2P_EXPR=&quot;&quot;</p><p>TCP_BULK=&quot;1024:&quot;<br />UDP_BULK=&quot;1024:&quot;</p><p>TCP_PRIO=&quot;21 22 80 443 1111 1194 3389 5800 5900&quot;<br />UDP_PRIO=&quot;&quot;</p><p>TCP_EXPR=&quot;53&quot;<br />UDP_EXPR=&quot;53&quot;</p><p>DSCP_BULK=&quot;&quot;<br />DSCP_PRIO=&quot;&quot;<br />DSCP_EXPR=&quot;&quot;</p><p>IP_BULK=&quot;&quot;<br />IP_PRIO=&quot;&quot;<br />IP_EXPR=&quot;&quot;</p><p>UDP_LENGTH=256</p><p>DEBUG=0</p></blockquote></div><p>This is pretty much stock except for the port I chose for priority traffic and the bandwidth settings.<br />The most important thing I think is the UPLOAD setting.&nbsp; If you set this too high, it doesn&#039;t do any useful throttling.&nbsp; If you set it too low, then you are artificially limiting yourself.&nbsp; When I chose those settings, I used several bandwidth tests to try and figure out what is best.&nbsp; Depending on what part of town you&#039;re in maybe you could raise that....</p><p>(edit)</p><p>Oh, forgot to mention -- for me I also have to fiddle with some contrack settings.</p><p>edit /etc/sysctl.conf add/change:<br />&nbsp; net.ipv4.ip_conntrack_max=2048<br />&nbsp; net.ipv4.netfilter.ip_conntrack_tcp_timeout_established=120<br />&nbsp; net.ipv4.netfilter.ip_conntrack_udp_timeout_stream=120<br />&nbsp; net.ipv4.tcp_westwood=1</p><p>If I don&#039;t do that, then I&#039;ll have things like sporadic timeouts while surfing etc.&nbsp; This because the table fills up with improperly closed connections from the p2p, and the default timeouts to age them out are something like days.&nbsp; This makes them minutes.</p>											<p class="post-edited">(Last edited by <strong>ziggurat29</strong> on 16 Dec 2006, 16:28)</p>
									</div>
			</article>

			
		
						<div class="notice">
				<p>Sorry, posts 426 to 425 are missing from our archive.</p>
			</div>
		
		
	
	<div class="pagination"><div class="pagination-number">Page 17 of 20</div><nav><ul><li><a href="viewtopic.php%3Fid=4112&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=4112&amp;p=15.html">15</a></li><li><a href="viewtopic.php%3Fid=4112&amp;p=16.html">16</a></li><li class="pagination-current"><span>17</span></li><li><a href="viewtopic.php%3Fid=4112&amp;p=18.html">18</a></li><li><a href="viewtopic.php%3Fid=4112&amp;p=19.html">19</a></li><li><a href="viewtopic.php%3Fid=4112&amp;p=20.html">20</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>