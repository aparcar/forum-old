<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> 8.09.1 booting from USB stick</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 7 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p92582">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">8472</div>
					<div class="post-datetime">
						12 Aug 2009, 21:28					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>Is there already somebody who managed to boot 8.09.1 from external device like USB stick?<br />I think right now it doesn&#039;t matter what kind of router you have, because I think this process should be similar by most of them.</p><p>My router is Asus WL-500W, and I would like to boot from the USB stick.<br />I&#039;ve followed this HowTo (even though i know it was made for the previous 7.09 version, but I&#039;ve adapted what I could, like replacing that &#039;ipkg&#039; with &#039;opkg&#039; , etc. ...):<br />&nbsp; &nbsp; <a href="http://wiki.openwrt.org/oldwiki/openwrtdocs/kamikazeconfiguration/packagesonexternalmediahowto?s">http://wiki.openwrt.org/oldwiki/openwrt â€¦ diahowto?s</a>[]=500w</p><p>I&#039;ve done everything as described, but the system won&#039;t start from the USB stick. Always booting from the router&#039;s flash drive.<br />This is how does it looks like after the boot:<br /></p><div class="codebox"><pre><code># df -h
Filesystem                Size      Used Available Use% Mounted on
rootfs                    1.6M      1.6M         0 100% /
/dev/root                 1.6M      1.6M         0 100% /rom
tmpfs                    14.9M    400.0k     14.5M   3% /tmp
/dev/mtdblock/4           5.7M      2.8M      2.9M  49% /jffs
mini_fo:/jffs             1.6M      1.6M         0 100% /


# mount
rootfs on / type rootfs (rw)
/dev/root on /rom type squashfs (ro)
none on /dev type devfs (rw)
proc on /proc type proc (rw)
tmpfs on /tmp type tmpfs (rw,nosuid,nodev)
devpts on /dev/pts type devpts (rw)
/dev/mtdblock/4 on /jffs type jffs2 (rw)
mini_fo:/jffs on / type mini_fo (rw)
none on /proc/bus/usb type usbfs (rw)</code></pre></div><p>Does everybody have clue what&#039;s wrong, why doesn&#039;t it boot from the USB stick and how to solve it?</p><p>thx in advance for any help</p><br /><p><strong>p.s. sorry for placing it to a wrong forum</strong></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p92613">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">8472</div>
					<div class="post-datetime">
						13 Aug 2009, 14:55					</div>
				</div>
				<div class="post-content content">
					<p>Problem resolved.</p><p>After some examination of openwrt wiki I&#039;ve found a way how to boot 8.09.1 on a router from external drive.</p><p><strong>1.</strong><br />Install necessary kernel modules for your external drive and FS <em>(in my case USB stick and the ext3 FS)</em><br /></p><div class="codebox"><pre><code>opkg update
opkg install kmod-fs-ext2 kmod-fs-ext3 fdisk e2fsprogs kmod-usb2 kmod-usb-storage kmod-usb-ohci kmod-usb-uhci kmod-usb-uhci-iv</code></pre></div><p>After installing the modules, you should either reboot the device or load the installed modules manually using the <strong>insmod</strong> command.</p><p><strong>2.</strong><br />Prepare the partition of your ext. device using the </p><div class="codebox"><pre><code>fdisk /dev/scsi/host0/bus0/target0/lun0/part1</code></pre></div><p>and format it </p><div class="codebox"><pre><code>mkfs.ext3 /dev/scsi/host0/bus0/target0/lun0/part1</code></pre></div><p><strong>*** Replace the &quot;/dev/scsi/host0/bus0/target0/lun0/part1&quot; device with your own if differs ***</strong></p><p><strong>3.</strong><br />Now copy everything from the flash to the USB device<br />mount it<br /></p><div class="codebox"><pre><code>mount -t ext3 /dev/scsi/host0/bus0/target0/lun0/part1 /mnt</code></pre></div><p><strong>*** Replace the &quot;/dev/scsi/host0/bus0/target0/lun0/part1&quot; device with your own if differs ***</strong><br />now, we need to mount the root contents somewhere so we can copy them without copying /mnt and /proc to the new usb device<br /></p><div class="codebox"><pre><code>mkdir /tmp/root</code></pre></div><p>if you&#039;re using squashfs, you want to copy the squashfs contents, not the jffs symlinks, so use the command:<br /></p><div class="codebox"><pre><code>mount -o bind /rom /tmp/root</code></pre></div><p>now /tmp/root contains the root filesystem with no extra directories mounted so we just copy this to the usb device<br /></p><div class="codebox"><pre><code>cp /tmp/root/* /mnt -a</code></pre></div><p>and now we unmount both the usb and our /tmp/root<br /></p><div class="codebox"><pre><code>umount /tmp/root
umount /mnt</code></pre></div><p><strong>4.</strong><br />Next, remove the <strong>/sbin/init</strong> from the JFFS partition (this is just a symlink to BusyBox anyway):<br /></p><div class="codebox"><pre><code>rm /sbin/init</code></pre></div><p>And replace it with this script:<br /></p><div class="codebox"><pre><code>#!/bin/sh
# change this to your boot partition
boot_dev=&quot;/dev/scsi/host0/bus0/target0/lun0/part1&quot;
# *** Replace the &quot;/dev/scsi/host0/bus0/target0/lun0/part1&quot; device with your own if differs ***
# install needed modules for usb and the ext3 filesystem
# **NOTE** for usb2.0 replace &quot;uhci&quot; with &quot;ehci-hcd&quot;
# **NOTE** for ohci chipsets replace &quot;uhci&quot; with &quot;usb-ohci&quot;
for module in usbcore ehci-hcd scsi_mod sd_mod usb-storage jbd ext3; do {
        insmod $module
}; done
# this may need to be higher if your disk is slow to initialize
sleep 10s
# mount the usb stick
mount &quot;$boot_dev&quot; /mnt
# if everything looks ok, do the pivot root
[ -x /mnt/sbin/init ] &amp;&amp; {
        mount -o move /proc /mnt/proc &amp;&amp; \
        pivot_root /mnt /mnt/mnt &amp;&amp; {
                mount -o move /mnt/dev /dev
                mount -o move /mnt/tmp /tmp
                mount -o move /mnt/jffs /jffs 2&gt;&amp;-
                mount -o move /mnt/sys /sys 2&gt;&amp;-
        }
}
# finally, run the real init (from USB hopefully).
exec /bin/busybox init</code></pre></div><p>Make sure your new <strong>/sbin/init</strong> is executable:<br /></p><div class="codebox"><pre><code>chmod a+x /sbin/init</code></pre></div><p>Now just reboot, and if you did everything right it should boot from the USB device automatically.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p92654">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">Mavy</div>
					<div class="post-datetime">
						14 Aug 2009, 09:42					</div>
				</div>
				<div class="post-content content">
					<p>A better way would be to change the pre-init script to allow booting from both.</p><p>The following script checks if the USB drive is bootable. If its not it will boot from flash.</p><div class="codebox"><pre><code>#!/bin/sh
# Copyright (C) 2006 OpenWrt.org
export PATH=/bin:/sbin:/usr/bin:/usr/sbin
. /etc/diag.sh

failsafe_ip() {
    ifconfig $ifname 192.168.1.1 netmask 255.255.255.0 broadcast 192.168.1.255 up
}

failsafe() {
    [ -n &quot;$ifname&quot; ] &amp;&amp; grep &quot;$ifname&quot; /proc/net/dev &gt;/dev/null &amp;&amp; {
        failsafe_ip
        netmsg 192.168.1.255 &quot;Entering Failsafe!&quot;
        telnetd -l /bin/login.sh &lt;&gt; /dev/null 2&gt;&amp;1
    }
    lock /tmp/.failsafe
    ash --login
}

mount_usb() {
        boot_dev=&quot;/dev/sda2&quot;
        mount_point=&quot;/mnt&quot;

        echo &quot;# Loading modules for usb&quot;
        insmod usbcore
        insmod ehci-hcd
        insmod scsi_mod
        insmod sd_mod
        insmod jbd
        insmod ext2
        insmod ext3
        insmod usb-storage

        echo &quot;# Waiting for devices to come up&quot;
        sleep 10

        [ -e $boot_dev ] || {
          echo &quot;$boot_dev NOT found&quot;
          return 1
        }
        echo &quot;# $boot_dev found&quot;

        mount -o rw $boot_dev $mount_point || {
          echo &quot;mount $boot_dev $mount_point failed&quot;
          return 1
        }
        echo &quot;# $boot_dev mounted on $mount_point&quot;

        [ -e $mount_point/usb.boot ] || {
          echo &quot;Missing file /usb.boot on media - NOT bootable, umounting.&quot;
          umount $mount_point
          return 1
        }
        echo &quot;# Medium seems to be bootable&quot;

        mount -o move /proc $mount_point/proc &amp;&amp; \
          pivot_root $mount_point $mount_point/rom &amp;&amp; {
            mount -o move /rom/dev /dev
            mount -o move /rom/sys /sys
            mount -o move /rom/tmp /tmp
          }
        echo &quot;# Changed root to USB medium&quot;

        return 0
}

mount proc /proc -t proc
mount sysfs /sys -t sysfs

size=$(awk &#039;/MemTotal:/ {l=5242880;mt=($2*1024);print((s=mt/2)&lt;l)&amp;&amp;(mt&gt;l)?mt-l:s}&#039; /proc/meminfo)
mount tmpfs /tmp -t tmpfs -o size=$size,nosuid,nodev,mode=1777

if grep devfs /proc/filesystems &gt; /dev/null; then
    mount devfs /dev -t devfs
    M0=/dev/pty/m0
    M1=/dev/pty/m1
    HOTPLUG=/sbin/hotplug-call

elif [ -x /sbin/hotplug2 ]; then
    mount -t tmpfs tmpfs /dev -o size=512K
    mknod /dev/console c 5 1
    /sbin/hotplug2 --set-worker /lib/hotplug2/worker_fork.so --set-rules-file /etc/hotplug2-init.rules --no-persistent --set-coldplug-cmd /sbin/udevtrigger
    /sbin/hotplug2 --set-worker /lib/hotplug2/worker_fork.so --set-rules-file /etc/hotplug2-init.rules --persistent &amp;
    M0=/dev/ptmx
    M1=/dev/ptmx
    HOTPLUG=

elif [ -x /sbin/udevd ]; then
    mount -n -t tmpfs -o mode=0755 udev /dev
    /sbin/udevd --daemon
    /sbin/udevtrigger
    /sbin/udevsettle
    M0=/dev/pty/ptmx
    M1=/dev/pty/ptmx
    HOTPLUG=
fi

mkdir -p /dev/pts /dev/shm
mount devpts /dev/pts -t devpts

# the shell really doesn&#039;t like having stdin/out closed
# that&#039;s why we use /dev/pty/m0 and m1 as replacement
# for /dev/console if there&#039;s no serial console available
dd if=/dev/console of=/dev/null bs=1 count=0 &gt;/dev/null 2&gt;/dev/null &amp;&amp; {
    M0=/dev/console
    M1=/dev/console
}

exec &lt;$M0 &gt;$M1 2&gt;&amp;0

echo &quot;- preinit -&quot;
echo &quot;Press CTRL-C for failsafe&quot;
trap &#039;FAILSAFE=true&#039; INT
trap &#039;FAILSAFE=true&#039; USR1
[ -e /etc/preinit.arch ] &amp;&amp; . /etc/preinit.arch
set_state preinit
echo &quot;$HOTPLUG&quot; &gt; /proc/sys/kernel/hotplug
export FAILSAFE
eval ${FAILSAFE:+failsafe}
lock -w /tmp/.failsafe

if [ -z &quot;$INITRAMFS&quot; ]; then
    mount_usb || mount_root
    [ -f /sysupgrade.tgz ] &amp;&amp; {
        echo &quot;- config restore -&quot;
        cd /
        mv sysupgrade.tgz /tmp
        tar xzf /tmp/sysupgrade.tgz
        rm -f /tmp/sysupgrade.tgz
        sync
    }

    echo &quot;- init -&quot;
    
    exec /sbin/init
fi</code></pre></div><p>This way if anything happens to the usb drive you still have basic access to openwrt to fix the problem.</p>											<p class="post-edited">(Last edited by <strong>Mavy</strong> on 14 Aug 2009, 09:44)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p92728">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">Kartman</div>
					<div class="post-datetime">
						16 Aug 2009, 14:49					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m having an issue with this procedure on a Dlink DIR-320 with brcm-2.4-generic built with the required options to locate the flash in the required address and enabling USB.</p><div class="codebox"><pre><code>#!/bin/sh
boot_dev=&quot;/dev/scsi/host0/bus0/target0/lun0/part1&quot;
for module in usbcore ehci-hcd scsi_mod sd_mod usb-storage jbd ext2 ext3 ; do {
        insmod $module
}; done
sleep 4s

mount -t ext3 &quot;$boot_dev&quot; /mnt
 [ -x /mnt/sbin/init ] &amp;&amp; {
        mount -o move /proc /mnt/proc &amp;&amp; \
        pivot_root /mnt /mnt/mnt &amp;&amp; {
                mount -o move /mnt/dev /dev
                mount -o move /mnt/tmp /tmp
                mount -o move /mnt/jffs2 /jffs2 2&gt;&amp;-
                mount -o move /mnt/sys /sys 2&gt;&amp;-
        }
 }</code></pre></div><p>When executing this script I get the following message:<br />mount: /proc is not a block device</p><p>It would seem to me there&#039;s something wrong with the mount to move to /proc link across.</p><p>The USB key has been partitioned and formatted along with the files copied across as per the instructions. A directory of /mnt/proc exists on the USB key and is empty.</p><p>Can anyone shed any light onto what the problem might be?</p>											<p class="post-edited">(Last edited by <strong>Kartman</strong> on 16 Aug 2009, 14:53)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94036">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">dhkaufman</div>
					<div class="post-datetime">
						10 Sep 2009, 18:03					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Mavy wrote:</cite><blockquote><p>A better way would be to change the pre-init script to allow booting from both.</p><p>The following script checks if the USB drive is bootable.</p><p>--snip--</p><p>This way if anything happens to the usb drive you still have basic access to openwrt to fix the problem.</p></blockquote></div><p>Yes! But, I would go a few steps further:</p><p>1. I want to be able to *control* whether the router boots from USB or flash<br />2. I *don&#039;t* want to hardcode where the USB drive is (/dev/sda2 in your code that I snipped). The router should find it for me.<br />3. I never want to mount an ext2 or ext3 filesystem without at least preening (fsck -p) it</p><p>Finally, I want to know what the script did. So I wrote a souped-up pivotroot, outlined in these blog posts: <a href="http://www.kaufmanfamily.net/blog/2009/08/pivotroot-intro">http://www.kaufmanfamily.net/blog/2009/ â€¦ root-intro</a> and <a href="http://www.kaufmanfamily.net/blog/2009/08/a-better-pivotroot-for-openwrt">http://www.kaufmanfamily.net/blog/2009/ â€¦ or-openwrt</a> . If you skip the blog posts, that&#039;s fine, but note that I added a few requirements for packages to load (e2fsprog) and directories on both filesystems (/flash).</p><p>This goes in /etc/init.d/pivotroot:<br /></p><div class="codebox"><pre><code>#!/bin/sh
# From http://oldwiki.openwrt.org/UsbStorageHowto.html - DHK 7/14/09
#
# Greatly enhanced to select among (maybe) several USB Mass Storage devices
# Assumes that the root fs will be on an ext3 filesystem in partition 1,
# and looks for /flash and /jffs in the root directory. Also assumes that
# mounting and checking each candidate device is harmless. Runs e2fsck
# over partitions before mounting them; note that this causes spurious
# date-related complaints every time, since time has not been synchronized
# yet at the time pivotroot is run.
#
# Output from this script is stashed at /tmp/pivotroot.log.
#
# DHK 7/23/2009

# Set Power LED flashing while we look for OpenWRT root
if [ -f /etc/diag.sh ]; then
  LED=1
  . /etc/diag.sh
  POW=`cat /proc/diag/led/power`
  set_led power f
fi

# install needed modules for usb and the ext3 filesystem
# We could defer loading the filesystem modules until we know there&#039;s a useful partition.
# **NOTE** for usb2.0 replace &quot;uhci&quot; with &quot;ehci_hcd&quot;
# **NOTE** for ohci chipsets replace &quot;uhci&quot; with &quot;usb-ohci&quot;
# **NOTE** for WL-500gP usb-uhci not usb-ohci
echo -n &quot;pivotroot loading kernel modules: &quot;
for module in usbcore usb-uhci scsi_mod sd_mod usb-storage ext2 jbd ext3 ; do {
  echo -n &quot;$module &quot;
  insmod $module
}; done
echo
# this may need to be higher if your disk is slow to initialize
sleep 4s

PART1=`find /dev/scsi -name part1`

if [ -z $PART1 ]; then
  echo No partitions, skipping pivotroot
else
  # Look for a mountable USB stick with, maybe, OpenWRT on it
  for dev in $PART1; do
    echo pivotroot checking $dev
    e2fsck -p $dev
    fsck=$?
    echo fsck status is $fsck
    if [ $fsck -eq 2 ]; then
      echo Corrected errors on $dev, need to reboot
      sleep 5
      reboot
    elif [ $fsck -eq 1 ]; then
      echo Corrected errors on $dev
    elif [ $fsck -gt 2 ]; then
      echo No usable filesystem on $dev
      continue
    fi
    echo Mounting $dev
    mount -t ext3 $dev /flash
    mt=$?
    if [ $mt -eq 0 ]; then
      if [ -x /flash/sbin/init -a -d /flash/jffs -a -d /flash/flash ]; then
        echo Found OpenWRT root on $dev
        # Side-effect - leave /flash mounted
        break;
      else
        echo &quot;Missing /sbin/init, /jffs, or /flash (mount status was $mt)&quot;
        [ -x /flash/sbin/init ] || echo Failed -x /sbin/init
        [ -d /flash/flash ]     || echo Failed -x /flash
        [ -d /flash/jffs ]      || echo Failed -x /jffs
        umount $dev
      fi
    else
      echo mount status is $mt
    fi
  done

  # if everything looks ok, do the pivot root
  [ -x /flash/sbin/init ] &amp;&amp; {
          mount -o move /proc /flash/proc &amp;&amp; \
          pivot_root /flash /flash/flash &amp;&amp; {
                  mount -o move /flash/dev /dev
                  mount -o move /flash/tmp /tmp
                  mount -o move /flash/jffs2 /jffs2 2&gt;&amp;-
                  mount -o move /flash/sys /sys 2&gt;&amp;-
          }
  }
fi

# Restore Power LED to previous state
[ $LED -eq 1 ] &amp;&amp; set_led power $POW</code></pre></div><p>This goes in /etc/init.d/rcS:</p><div class="codebox"><pre><code># Improved from http://oldwiki.openwrt.org/UsbStorageHowto.html
# Switch the root filesystem to USB, if present
# DHK 7/14/09
if [ $2 == &quot;boot&quot; -a -x /etc/init.d/pivotroot ] ; then
        /etc/init.d/pivotroot &gt; /tmp/pivotroot.log
fi</code></pre></div>											<p class="post-edited">(Last edited by <strong>dhkaufman</strong> on 10 Sep 2009, 18:08)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94688">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">forest_gump</div>
					<div class="post-datetime">
						20 Sep 2009, 17:43					</div>
				</div>
				<div class="post-content content">
					<p>This how to does not work for me as it should be :-( ,&nbsp; I tryed this how to on Linksys-nslu2 , .... but after some head scratching I have successed! <br />So I dont know if it is right or wrong but it just works fine, so here is what I have done:</p><p>I have followed this how to strictly but my init script is called /sbin/init.busb , and the original init script is left as it was by default i.e. unchanged!</p><div class="codebox"><pre><code>#!/bin/sh
# change this to your boot partition
boot_dev=&quot;/dev/sda1&quot;
# *** Replace the &quot;/dev/scsi/host0/bus0/target0/lun0/part1&quot; device with your ow$
# install needed modules for usb and the ext3 filesystem
# **NOTE** for usb2.0 replace &quot;uhci&quot; with &quot;ehci-hcd&quot;
# **NOTE** for ohci chipsets replace &quot;uhci&quot; with &quot;usb-ohci&quot;
for module in usbcore ehci-hcd uhci-hcd ohci-hcd scsi_mod usb-storage jbd ext3;$
        insmod $module
}; done
# this may need to be higher if your disk is slow to initialize
sleep 5s
# mount the usb stick
mount $boot_dev /mnt
# if everything looks ok, do the pivot root
[ -x /mnt/sbin/init ] &amp;&amp; {
        mount -o move /proc /mnt/proc &amp;&amp; \
        pivot_root /mnt /mnt/mnt &amp;&amp; {
                mount -o move /mnt/dev /dev
                mount -o move /mnt/tmp /tmp
                mount -o move /mnt/jffs /jffs 2&gt;&amp;-
                mount -o move /mnt/sys /sys 2&gt;&amp;-
        }
}
# finally, run the real init (from USB hopefully).
exec /bin/busybox init</code></pre></div><p>After that I modified /etc/init.d/done script , just added an execution line to init.bsub script, here is:</p><div class="codebox"><pre><code>#!/bin/sh /etc/rc.common
# Copyright (C) 2006 OpenWrt.org

START=95
boot() {
        [ -d /tmp/root ] &amp;&amp; {
                lock /tmp/.switch2jffs
                firstboot switch2jffs
                lock -u /tmp/.switch2jffs
        }

        # set leds to normal state
        . /etc/diag.sh
        set_state done
        ./sbin/init.busb
}</code></pre></div><p>So finally after&nbsp; reboot I have this:</p><div class="codebox"><pre><code>root@OpenWrt:~# df
Filesystem           1k-blocks      Used Available Use% Mounted on
rootfs                  432260     19161    390781   5% /
/dev/root                 1472      1472         0 100% /mnt/rom
/dev/mtdblock5            4992      2576      2416  52% /jffs
mini_fo:/jffs             1472      1472         0 100% /mnt
/dev/sda1               432260     19161    390781   5% /mnt/mnt/usbdrive
/dev/sda1               432260     19161    390781   5% /</code></pre></div><p>That is all, please let somebody linux-guru tell me wheter I can rely on this system ?!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94804">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">misha680</div>
					<div class="post-datetime">
						22 Sep 2009, 21:07					</div>
				</div>
				<div class="post-content content">
					<p>Hi guys. Are any of you using the 2.6 kernel btw?</p><p>I am using the command from the Wiki<br /></p><div class="codebox"><pre><code>/sbin/hotplug2 --override --persistent --max-children 1 --no-coldplug &amp;</code></pre></div><p>but it gives me a missing worker name error.<br />Thank you<br />Misha</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p96776">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						3 Nov 2009, 03:45					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dhkaufman wrote:</cite><blockquote><p>Finally, I want to know what the script did. So I wrote a souped-up pivotroot, outlined in these blog posts: <a href="http://www.kaufmanfamily.net/blog/2009/08/pivotroot-intro">http://www.kaufmanfamily.net/blog/2009/ â€¦ root-intro</a> and <a href="http://www.kaufmanfamily.net/blog/2009/08/a-better-pivotroot-for-openwrt">http://www.kaufmanfamily.net/blog/2009/ â€¦ or-openwrt</a> . If you skip the blog posts, that&#039;s fine, but note that I added a few requirements for packages to load (e2fsprog) and directories on both filesystems (/flash).</p></blockquote></div><p>When I tried to access the above blog links, the links spitted out this <strong>Error establishing a database connection</strong>. Can you please fix the links?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p96778">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">dhkaufman</div>
					<div class="post-datetime">
						3 Nov 2009, 04:53					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mazilo wrote:</cite><blockquote><p>When I tried to access the above blog links, the links spitted out this <strong>Error establishing a database connection</strong>. Can you please fix the links?</p></blockquote></div><p>Sorry about that. All fixed now.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p96779">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">dhkaufman</div>
					<div class="post-datetime">
						3 Nov 2009, 05:03					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>forest_gump wrote:</cite><blockquote><p>This how to does not work for me as it should be :-( ,&nbsp; I tryed this how to on Linksys-nslu2 , .... but after some head scratching I have successed! <br />So I dont know if it is right or wrong but it just works fine, so here is what I have done:</p><p>I have followed this how to strictly but my init script is called /sbin/init.busb , and the original init script is left as it was by default i.e. unchanged!</p><p>...snip...</p><p>After that I modified /etc/init.d/done script , just added an execution line to init.bsub script, here is:</p><p>...snip...</p><p>So finally after&nbsp; reboot I have this:</p><p>...snip...</p><p>That is all, please let somebody linux-guru tell me wheter I can rely on this system ?!</p></blockquote></div><p>You can use the system, and it will be fine, but it will be confusing when you update your software or change your configuration.</p><p>What you have done is to make your system boot up entirely out of flash, then at the last second switch to the USB filesystem. So you have one set of system configuration, startup scripts, etc, on USB and another on flash - that is common to all these pivotroot setups. But the startup scripts that will get updated by the system tools - the ones on the USB filesystem - are not the ones that will run at system startup - system startup still runs off of flash. For example, if you add a new software package, and want it to start at system boot time, the startup script in /etc/init.d will be in the &quot;wrong&quot; /etc/init.d, and the software package won&#039;t start. By the time you pivot to the USB root, you&#039;ve already run whatever startup scripts were in flash.</p><p>The other approaches do the pivot much sooner in the bootup process, so that fairly little code is run out of flash, and rather a lot is run off USB. That way the system is less confusing to maintain.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p96780">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						3 Nov 2009, 05:08					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dhkaufman wrote:</cite><blockquote><div class="quotebox"><cite>mazilo wrote:</cite><blockquote><p>When I tried to access the above blog links, the links spitted out this <strong>Error establishing a database connection</strong>. Can you please fix the links?</p></blockquote></div><p>Sorry about that. All fixed now.</p></blockquote></div><p>Many thanks for your quick response. I guess I will give it a try with the <em>better</em> pivotroot (2nd link).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97583">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						18 Nov 2009, 19:09					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dhkaufman wrote:</cite><blockquote><p>Sorry about that. All fixed now.</p></blockquote></div><p>On your <a href="http://www.kaufmanfamily.net/blog/2009/08/a-better-pivotroot-for-openwrt">blog</a>, I am not sure if this is a bug or not; however, I noticed an inconsistency of using /jffs ([ -d /flash/jffs ] || echo Failed -x /jffs) and /jffs<strong>2</strong> (mount -o move /flash/jffs<strong>2</strong> /jffs<strong>2</strong> 2&gt;&amp;-) as shown below:<br /></p><div class="codebox"><pre><code>        echo &quot;Missing /sbin/init, /jffs, or /flash (mount status was $mt)&quot;
        [ -x /flash/sbin/init ] || echo Failed -x /sbin/init
        [ -d /flash/flash ]     || echo Failed -x /flash
        [ -d /flash/jffs ]      || echo Failed -x /jffs
        umount $dev
      fi
    else
      echo mount status is $mt
    fi
  done

  # if everything looks ok, do the pivot root
  [ -x /flash/sbin/init ] &amp;&amp; {
          mount -o move /proc /flash/proc &amp;&amp; \
          pivot_root /flash /flash/flash &amp;&amp; {
                  mount -o move /flash/dev /dev
                  mount -o move /flash/tmp /tmp
                  mount -o move /flash/jffs2 /jffs2 2&gt;&amp;-
                  mount -o move /flash/sys /sys 2&gt;&amp;-
          }
  }</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97684">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						20 Nov 2009, 17:48					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>8472 wrote:</cite><blockquote><p>f you&#039;re using squashfs, you want to copy the squashfs contents, not the jffs symlinks, so use the command:<br /></p><div class="codebox"><pre><code>mount -o bind /rom /tmp/root</code></pre></div><p>now /tmp/root contains the root filesystem with no extra directories mounted so we just copy this to the usb device</p></blockquote></div><p>I don&#039;t see any partition(s) mounted under /rom directory. So, is the above step necessary and can&#039;t one just do a straight <em>cp -a /rom /mnt</em>?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97745">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">dhkaufman</div>
					<div class="post-datetime">
						22 Nov 2009, 03:02					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mazilo wrote:</cite><blockquote><p>On your <a href="http://www.kaufmanfamily.net/blog/2009/08/a-better-pivotroot-for-openwrt">blog</a>, I am not sure if this is a bug or not; however, I noticed an inconsistency of using /jffs ([ -d /flash/jffs ] || echo Failed -x /jffs) and /jffs<strong>2</strong> (mount -o move /flash/jffs<strong>2</strong> /jffs<strong>2</strong> 2&gt;&amp;-)</p></blockquote></div><p>Yup, that looks like a bug. Based on the two systems I just looked at quickly, it should be jffs everywhere. I&#039;m not sure where the jffs2 snuck in.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97800">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						22 Nov 2009, 23:28					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dhkaufman wrote:</cite><blockquote><div class="quotebox"><cite>mazilo wrote:</cite><blockquote><p>On your <a href="http://www.kaufmanfamily.net/blog/2009/08/a-better-pivotroot-for-openwrt">blog</a>, I am not sure if this is a bug or not; however, I noticed an inconsistency of using /jffs ([ -d /flash/jffs ] || echo Failed -x /jffs) and /jffs<strong>2</strong> (mount -o move /flash/jffs<strong>2</strong> /jffs<strong>2</strong> 2&gt;&amp;-)</p></blockquote></div><p>Yup, that looks like a bug. Based on the two systems I just looked at quickly, it should be jffs everywhere. I&#039;m not sure where the jffs2 snuck in.</p></blockquote></div><p>I hope you got your <a href="http://www.kaufmanfamily.net/blog/2009/08/a-better-pivotroot-for-openwrt">blog</a> updated with bug fixes. Thanks.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p98391">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">dhkaufman</div>
					<div class="post-datetime">
						6 Dec 2009, 19:29					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dhkaufman wrote:</cite><blockquote><div class="quotebox"><cite>mazilo wrote:</cite><blockquote><p>On your <a href="http://www.kaufmanfamily.net/blog/2009/08/a-better-pivotroot-for-openwrt">blog</a>, I am not sure if this is a bug or not; however, I noticed an inconsistency of using /jffs ([ -d /flash/jffs ] || echo Failed -x /jffs) and /jffs<strong>2</strong> (mount -o move /flash/jffs<strong>2</strong> /jffs<strong>2</strong> 2&gt;&amp;-)</p></blockquote></div><p>Yup, that looks like a bug. Based on the two systems I just looked at quickly, it should be jffs everywhere. I&#039;m not sure where the jffs2 snuck in.</p></blockquote></div><p>I finally got a chance to look at this more closely, and I don&#039;t think it&#039;s a bug after all. There are two different things going on here: First, my pivotroot script uses the presence of a /jffs directory to decide whether a partition holds a valid OpenWRT image. Second, in the actual pivot, the filesystem mounted on the /jffs2 directory (if any) is moved to the new root.</p><p>In fact, my OpenWRTs don&#039;t have a filesystem mounted on /jffs2, but they do have a filesystem mounted on /jffs. That filesystem gets mounted by startup scripts that run after pivotroot, so it&#039;s correct that pivotroot doesn&#039;t pivot /jffs.</p><p>The code that moves /jffs2 comes from the OpenWRT wiki. I&#039;m hesitant to change it, since it may be important on hardware that I don&#039;t have.</p><p>The only possible bug I see here is that maybe the presence of /jffs is a bad indicator of a valid OpenWRT system....</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p98474">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						8 Dec 2009, 03:41					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for your explanations and am sure others will appreciate that.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p101057">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">lizby</div>
					<div class="post-datetime">
						21 Jan 2010, 05:13					</div>
				</div>
				<div class="post-content content">
					<p>@dhkaufman--your blog post links are now dead (for me).&nbsp; If you&#039;re around, can you update the links or post your investigations here?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p101113">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">dhkaufman</div>
					<div class="post-datetime">
						21 Jan 2010, 18:47					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>lizby wrote:</cite><blockquote><p>@dhkaufman--your blog post links are now dead (for me).&nbsp; If you&#039;re around, can you update the links or post your investigations here?</p></blockquote></div><p>My blog got stomped by a Wordpress upgrade, but it&#039;s back now. Sorry for the outage.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p101156">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">lizby</div>
					<div class="post-datetime">
						22 Jan 2010, 05:47					</div>
				</div>
				<div class="post-content content">
					<p>@dhkaufman ... and any others</p><p>I have not succeeded in getting this to work on boot-up.&nbsp; After copying files from /rom to the usb drive, if I run your code from the command line, modified to look only at &quot;/dev/sda1&quot;, then it does the pivotroot successfully.&nbsp; When invoked from rcS, pivotroot.log says &quot;No partitions, skipping pivotroot&quot;.&nbsp; I tried increasing the number of seconds, without success.</p><p>I tried forest_gump&#039;s method of doing the pivotroot as the last command in /etc/init.d/done.&nbsp; I think it probably pivoted ok, but I was unable to login--it didn&#039;t like my password.&nbsp; Removing the USB drive and rebooting got me back to a working system.</p><p>Perhaps in looking for &quot;/dev/sda1&quot; I am looking too early in the boot process.&nbsp; I didn&#039;t understand the &quot;/dev/scsi&quot; in the find command in the script.&nbsp; (Is that architecture-related? I&#039;m doing this on a WL-520gU--brcm47xx.)&nbsp; Perhaps it&#039;s related to a point in time in the boot process, but there is no /dev/scsi anything in my system after booting with a usb drive--but there is a &quot;/dev/sda1&quot;.</p><p>Your instructions say to put the code which calls pivotroot into /etc/init.d/rcS before the &quot;LOGGER=cat&quot; line.&nbsp; It didn&#039;t find a device (/dev/sda1).</p><p>I feel like I&#039;m fairly close, but I&#039;m not quite there.&nbsp; Any suggestions would be appreciated.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p101204">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">dhkaufman</div>
					<div class="post-datetime">
						22 Jan 2010, 21:40					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>lizby wrote:</cite><blockquote><p>Perhaps in looking for &quot;/dev/sda1&quot; I am looking too early in the boot process.&nbsp; I didn&#039;t understand the &quot;/dev/scsi&quot; in the find command in the script.&nbsp; (Is that architecture-related? I&#039;m doing this on a WL-520gU--brcm47xx.)&nbsp; Perhaps it&#039;s related to a point in time in the boot process, but there is no /dev/scsi anything in my system after booting with a usb drive--but there is a &quot;/dev/sda1&quot;.</p></blockquote></div><p>@lizby,</p><p>What OpenWRT release/kernel are you running? What kind of USB drive are you using? I am running Kamikaze 8.09 and 8.09.1 on an ASUS WL-520gU - actually I have done this trick on three of them. On my systems, a USB thumb drive always shows up as /dev/scsi/host0/bus0/target0/lun0 .</p><p>If I had your scenario, I would change the line in my pivtoroot script with the &quot;find&quot; command to be <br /></p><div class="codebox"><pre><code>PART1=/dev/sd?1</code></pre></div><p>which should do the same job: list all the partition-1s on the system. Maybe that&#039;s what you already did.</p><p>Another possibility is that your drive isn&#039;t recognized until the system boots further, because you don&#039;t have the right modules loaded in pivotroot. Look at the output of lsmod, and compare it to the modules listed in the pivotroot script, and see if anything important-looking is missing. Sorry I can&#039;t be more specific.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p101208">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">lizby</div>
					<div class="post-datetime">
						22 Jan 2010, 23:14					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m using trunk--tried both download of latest and self-built after svn up.&nbsp; I&#039;ve seen many mentions of scsi, but my NSLU2 systems have always had the hard drive come up as /dev/sd?1--to the best of my imperfect recollection.&nbsp; I just started using the WL-520gU in December, and on that they have always come up the same.&nbsp; I just today installed a download of trunk on a brand new WL-500gPv2, and got the same--usb recognized as /dev/sda1.&nbsp; I&#039;ve been using a Kingston 2gb usb drive.&nbsp; It is recognized with a non-pivotroot boot, so I don&#039;t think there is a problem with that drive.&nbsp; I&#039;ll try another one, tho.</p><p>I had not originally conned the obvious, that the insmod loop was there to load the modules which would cause the usb drive to be recognized, and if it was not recognized after that, then something was missing.&nbsp; I&#039;ve been banging on that today, but it hasn&#039;t fallen into place yet.&nbsp; I trust I will get there by persuing that path.&nbsp; Thanks for your suggestions.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p101565">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">lizby</div>
					<div class="post-datetime">
						28 Jan 2010, 04:22					</div>
				</div>
				<div class="post-content content">
					<p>I have not been able to get pivotroot to work on my WL-520gU at the point where dhkaufman put it (before &quot;LOGGER=&quot; in /etc/init.d/rcS).&nbsp; With the serial cable, I can see that it is putting out messages to just the point before where it says &quot;Please press enter to activate this console&quot;.&nbsp; The boot process doesn&#039;t complete and the only way out is to reflash.</p><p>So I have tried to combine dhkaufman&#039;s code with the process used by forest_gump, putting the pivot root into /etc/init.d/done, after everything else has been done.&nbsp; This appears to do the pivotroot, but with the caveats mentioned in the thread. </p><p>The packages installed are kmod-usb-core kmod-usb-storage kmod-usb2 kmod-fs-ext2 kmod-fs-ext3 kmod-usb-ohci e2fsprogs.&nbsp; openssh-sftp-server is not required but is small and makes it easier to copy files to the router.</p><p>I have mounted the usb drive, formatted as ext3, on a directory named &quot;usb&quot;.&nbsp; Here is the code I used to format the drive and copy the internal flash to it (assuming that the drive is /dev/sda1 and partitioned as linux).<br /></p><div class="codebox"><pre><code>umount /dev/sda1
mkfs.ext3 /dev/sda1
mkdir -p /tmp/root
mount -o bind /rom /tmp/root
mount /dev/sda1 /usb
cp /tmp/root/* /usb -a
sync
echo &quot;This is usb drive /dev/sda1 to be mounted on /usb&quot; &gt; /usb/sda1.dsk
umount /tmp/root
umount /usb</code></pre></div><p>Here is df output with no usb drive plugged in:<br /></p><div class="codebox"><pre><code>Filesystem           1K-blocks      Used Available Use% Mounted on
/dev/root                 1920      1920         0 100% /rom
tmpfs                     6784        32      6752   0% /tmp
tmpfs                      512         4       508   1% /dev
/dev/mtdblock3            1152       204       948  18% /jffs
mini_fo:/jffs             1920      1920         0 100% /</code></pre></div><p>I put the call to pivotroot into /etc/init.d/done (and enabled it)</p><div class="codebox"><pre><code>START=95
boot() {
        [ -d /tmp/root ] &amp;&amp; {
                lock /tmp/.switch2jffs
                firstboot switch2jffs
                lock -u /tmp/.switch2jffs
        }

        # process user commands
        [ -f /etc/rc.local ] &amp;&amp; {
                sh /etc/rc.local
        }
        # pivotroot to usb, if available -- added
        /etc/init.d/pivotroot

        # set leds to normal state
        . /etc/diag.sh
        set_state done
}</code></pre></div><p>Here is my pivotroot code:<br /></p><div class="codebox"><pre><code># using some of dhkaufman&#039;s code from
# https://forum.openwrt.org/viewtopic.php?id=21377
# look for usb drive as /dev/sda1; if found, unmount, e2fsck, if no error, boot
  DRIVE=`ls /dev/sda1`

  if [ -z $DRIVE ]; then
    echo No partitions, skipping pivotroot
  else
    umount $DRIVE
    e2fsck -p $DRIVE
    fsstat=$?
    echo e2fsck status is $fsstat
    if [ $fsstat -eq 2 ]; then
      echo Corrected errors on $DRIVE, need to reboot
      sleep 5
      reboot
    elif [ $fsstat -eq 1 ]; then
      echo Corrected errors on $DRIVE
    elif [ $fsstat -gt 2 ]; then
      echo No usable filesystem on $DRIVE
    fi
    echo Mounting $DRIVE
    mount -t ext3 $DRIVE /usb
    mt=$?
    if [ $mt -eq 0 ]; then
      if [ -x /usb/sbin/init -a -d /usb/jffs -a -d /usb/usb ]; then
        echo Found OpenWRT root on $DRIVE
   # Side-effect - leave /usb mounted
      else
        echo &quot;Missing /sbin/init, /jffs, or /usb (mount status was $mt)&quot;
        [ -x /usb/sbin/init ] || echo Failed -x /sbin/init
        [ -d /usb/usb ]     || echo Failed -x /usb
        [ -d /usb/jffs ]      || echo Failed -x /jffs
        umount $DRIVE
      fi
    else
      echo mount status is $mt
    fi
  fi
#if everything looks ok, do the pivot root
  [ -x /usb/sbin/init ] &amp;&amp; {
     mount -o move /proc /usb/proc &amp;&amp; \
     pivot_root /usb /usb/usb &amp;&amp; {
       mount -o move /usb/dev /dev
       mount -o move /usb/tmp /tmp
       mount -o move /usb/jffs2 /jffs2 2&gt;&amp;-
       mount -o move /usb/sys /sys 2&gt;&amp;-
     }
   }</code></pre></div><p>Here is the output from df when the device is booted with the usb drive in:<br /></p><div class="codebox"><pre><code>Filesystem           1K-blocks      Used Available Use% Mounted on
/dev/root                 1920      1920         0 100% /usb/rom
tmpfs                     6784        32      6752   0% /tmp
tmpfs                      512         0       512   0% /dev
/dev/mtdblock3            1152       208       944  18% /usb/jffs
mini_fo:/jffs             1920      1920         0 100% /usb
/dev/sda1              1924720     42988   1783960   2% /</code></pre></div><p>Is anything evidently wrong with this?</p><p>A couple of problems.&nbsp; I would be stuck on this process as implemented without the serial cable.&nbsp; When I tried to log in, I kept getting &quot;Access denied&quot;.&nbsp; Using the serial console, I ran &quot;passwd&quot; and set it to the same thing that I used for the device without the usb drive.&nbsp; Then I could get in with the normal ssh client (putty, in my instance).&nbsp; What causes this and how can it be avoided so that this process could be followed by someone without a serial cable?</p><p>Second problem: the date isn&#039;t correct.&nbsp; ntpclient is running with the correct paramaters, but the date is wrong--based on Unix zero date.&nbsp; How can this be fixed?<br /></p><div class="codebox"><pre><code>root@wl63:~# date
Wed Dec 31 19:10:30 EST 1969
root@wl63:~# ps | grep ntpclient
  754 root       832 S    /usr/sbin/ntpclient -i 600 -s -l -D -p 123 -h 0.openw</code></pre></div><p>New packages are going to the usb drive.&nbsp; I did &quot;opkg update&quot; and &quot;opkg install nano&quot;, and could use nano.&nbsp; After rebooting without the usb drive, I couldn&#039;t use nano, which is good because that indicates that it wasn&#039;t installed to the internal flash.</p><p>So, this method is close, but not perfect.&nbsp; Any suggestions would be appreciated.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p101568">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						28 Jan 2010, 06:27					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>lizby wrote:</cite><blockquote><p>Any suggestions would be appreciated.</p></blockquote></div><p>AFAIC, pivoroot should be called before <em>run_scripts</em> by /etc/init.d/rcS so that the system will boot off of the USB partition. If you call pivotroot at the end of the booting process, perhaps the /proc FS on your USB partition doesn&#039;t longer reflect to the boot information contained on the pivoted /rom/proc FS.</p><p>FYI, the /etc/init.d/rcS file on my WGT634U device which clearly indicates how pivoroot is called is shown below for your convenience:<br /></p><div class="codebox"><pre><code>#!/bin/sh
# Copyright (C) 2006 OpenWrt.org

run_scripts() {
      for i in /etc/rc.d/$1*; do
              [ -x $i ] &amp;&amp; $i $2 2&gt;&amp;1
      done | $LOGGER
}

LOGGER=&quot;cat&quot;
[ -x /usr/bin/logger ] &amp;&amp; LOGGER=&quot;logger -s -p 6 -t sysinit&quot;

#
# Switch to pivoroot if available
#
if [ &quot;$2&quot; == &quot;boot&quot; -a -x /etc/init.d/pivotroot ] ; then
      echo &quot;[`date`]: Pivot root log created.&quot; &gt; /tmp/pivotroot.log
      /etc/init.d/pivotroot &gt;&gt; /tmp/pivotroot.log
fi

if [ &quot;$1&quot; == &quot;S&quot; ]; then
      run_scripts &quot;$1&quot; &quot;$2&quot; &amp;
else
      run_scripts &quot;$1&quot; &quot;$2&quot;
fi</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p101720">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">lizby</div>
					<div class="post-datetime">
						29 Jan 2010, 21:22					</div>
				</div>
				<div class="post-content content">
					<p>@mazilo--thanks for pointing out that the pivotroot process I used might leave inconsistancies in the pivoted system.&nbsp; As far as I understand it, except for issues related to smaller flash and ram, the WL-520gU should be able to run what the WGT634U does, so could you post your pivotroot code?</p>											<p class="post-edited">(Last edited by <strong>lizby</strong> on 29 Jan 2010, 21:23)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>