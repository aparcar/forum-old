<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Multi-WAN Load Balancing</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 29 Mar 2018 and 3 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 9 of 14</div><nav><ul><li><a href="viewtopic.php%3Fid=23904&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=7.html">7</a></li><li><a href="viewtopic.php%3Fid=23904&amp;p=8.html">8</a></li><li class="pagination-current"><span>9</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=10.html">10</a></li><li><a href="viewtopic.php%3Fid=23904&amp;p=11.html">11</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=14.html">14</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p114068">
				<div class="post-metadata">
					<div class="post-num">Post #201</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						30 Jul 2010, 09:55					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>potsmaster wrote:</cite><blockquote><p><strong>VPN Routes</strong></p><p>I am trying to use multiwan just for failover and I need to set up several routes via VPN devices (e.g. tap0) that should bypass the multiwan rules.&nbsp; &nbsp;I could not get this to work with 1.0.16-0--the multiwan script only picks up &quot;scope link&quot; routes from the main routing table and ignores others, and it does not seem like the multiwan traffic rules support this.</p><p>The patch below causes routes which do not have link scope but do have a &quot;via&quot; attribute to be picked up as well.&nbsp; Can you consider adding this to the next release, or letting me know if there&#039;s a better way to do this?&nbsp; I also posted a ticket (<a href="https://dev.openwrt.org/ticket/7613">https://dev.openwrt.org/ticket/7613</a>).</p><p>Thanks.</p><p>Chris</p><div class="codebox"><pre><code>--- multiwan.orig
+++ multiwan
@@ -661,7 +661,7 @@
 
         for TABLE in 170
         do
-                ip route | grep link | grep -Ev ^default | while read ROUTE
+                ip route | egrep &#039;link| via &#039; | grep -Ev ^default | while read ROUTE
                 do
                 ip route add table $TABLE to $ROUTE
                 done
@@ -748,7 +748,7 @@
 
         for TABLE in $(expr $i + 170)
         do
-                ip route | grep link | grep -Ev ^default | while read ROUTE
+                ip route | egrep &#039;link| via &#039; | grep -Ev ^default | while read ROUTE
                 do
                 ip route add table $TABLE to $ROUTE
                 done</code></pre></div></blockquote></div><p>1.0.17 should take care of this, let me know if it does not.</p><p>Thanks,<br />-Craig</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p114189">
				<div class="post-metadata">
					<div class="post-num">Post #202</div>
					<div class="post-author">blubbi321</div>
					<div class="post-datetime">
						1 Aug 2010, 20:50					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>SouthPawn wrote:</cite><blockquote><div class="quotebox"><cite>blubbi321 wrote:</cite><blockquote><p>ok, ive changed my configuration to have three nets now. lan on the router, wan - pointing to my internet connection, wlan - pointing to another internet connection.</p><p>since it is still not working - i can see traffic getting split using tcpdump, but clients dont get to see said traffic - i wanted to ask if you got any kind of documentation that i could use to debug what is going wrong?</p></blockquote></div><p>Sorry, still working on creating better documentation, however in the meantime one thing I&#039;d suggest is that atleast for firewall settings they are similar on both wan interfaces, including masquerading, icmp, etc..</p></blockquote></div><p>ok, working now. thanks for your reply!</p><p>hope to see some documentation soon <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p114325">
				<div class="post-metadata">
					<div class="post-num">Post #203</div>
					<div class="post-author">glic3rinu</div>
					<div class="post-datetime">
						3 Aug 2010, 20:59					</div>
				</div>
				<div class="post-content content">
					<p>luci-app-multiwan_1.0.16.ipk what exactly adds to LuCi interface? Because after the installation of this module I&#039;ve not seen anything related to &quot;multiwan&quot; in LuCi web interface. </p><p>Thanks!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p114468">
				<div class="post-metadata">
					<div class="post-num">Post #204</div>
					<div class="post-author">_bryan</div>
					<div class="post-datetime">
						5 Aug 2010, 05:25					</div>
				</div>
				<div class="post-content content">
					<p>thanks for your multiwan.</p><p>I have trouble to use this with three wan.<br />I use PPPOE adsl, in my place it is possible to dial use the same username/password with the same physical line.<br />use this it is very easy to add up the bandwidth.<br />the adsl modem was connected to the router&#039;s wan port, I use macvlan to make virtual wan link to router&#039;s wan.<br />I named these to wan2,wan3 etc.<br />when there are two wan (wan ,wan2) everything is ok with multiwan,but when there are&nbsp; three wan(wan ,wan2 wan3), only few chance to add up wan3&#039;s bandwidth. because the three wan dial up at the same time and sometimes they get the same gatway. <br />I also try three wan with dhcp ,it sees the same.<br />you chan see this</p><br /><div class="codebox"><pre><code>root@OpenWrt:~# route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.1.0     *               255.255.255.0   U     0      0        0 br-lan
10.98.131.0     *               255.255.255.0   U     0      0        0 eth1.1
10.98.131.0     *               255.255.255.0   U     0      0        0 eth2
10.98.131.0     *               255.255.255.0   U     0      0        0 eth3
default         10.98.131.254   0.0.0.0         UG    0      0        0 eth1.1
now I use 1.0.17 ,the route table is like this with 1.0.16
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.1.0     *               255.255.255.0   U     0      0        0 br-lan
10.98.131.0     *               255.255.255.0   U     0      0        0 eth1.1
10.98.131.0     *               255.255.255.0   U     0      0        0 eth2
10.98.131.0     *               255.255.255.0   U     0      0        0 eth3
default         10.98.131.254   0.0.0.0         UG    0      0        0 eth1.1
default         10.98.131.254   0.0.0.0         UG    0      0        0 eth2
default         10.98.131.254   0.0.0.0         UG    0      0        0 eth3
root@OpenWrt:~# ip route
192.168.1.0/24 dev br-lan  src 192.168.1.1
10.98.131.0/24 dev eth1.1  src 10.98.131.42
10.98.131.0/24 dev eth2  src 10.98.131.87
10.98.131.0/24 dev eth3  src 10.98.131.91
default via 10.98.131.254 dev eth1.1</code></pre></div><p>this is /etc/config/network</p><div class="codebox"><pre><code>root@OpenWrt:/etc/config# vi network
        option &#039;nat&#039; &#039;1&#039;
        option &#039;gateway&#039; &#039;192.168.1.1&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;
        option &#039;dns&#039; &#039;202.106.196.115 202.96.64.38&#039;

config &#039;interface&#039; &#039;wan&#039;
        option &#039;ifname&#039; &#039;eth1.1&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;
        option &#039;proto&#039; &#039;dhcp&#039;

config &#039;interface&#039; &#039;wan2&#039;
        option &#039;ifname&#039; &#039;eth2&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;
        option &#039;proto&#039; &#039;dhcp&#039;

config &#039;interface&#039; &#039;wan3&#039;
        option &#039;ifname&#039; &#039;eth3&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;
        option &#039;proto&#039; &#039;dhcp&#039;
- network 48/50 96%

config &#039;switch&#039; &#039;eth1&#039;
        option &#039;reset&#039; &#039;1&#039;
        option &#039;enable_vlan&#039; &#039;1&#039;

config &#039;switch_vlan&#039;
        option &#039;device&#039; &#039;eth1&#039;
        option &#039;vlan&#039; &#039;0&#039;
        option &#039;ports&#039; &#039;0 1 2 5*&#039;

config &#039;switch_vlan&#039;
        option &#039;device&#039; &#039;eth1&#039;
        option &#039;vlan&#039; &#039;1&#039;
        option &#039;ports&#039; &#039;3 5*&#039;

config &#039;interface&#039; &#039;loopback&#039;
        option &#039;ifname&#039; &#039;lo&#039;
        option &#039;proto&#039; &#039;static&#039;
        option &#039;ipaddr&#039; &#039;127.0.0.1&#039;
        option &#039;netmask&#039; &#039;255.0.0.0&#039;

config &#039;interface&#039; &#039;lan&#039;
        option &#039;type&#039; &#039;bridge&#039;
        option &#039;ifname&#039; &#039;eth1.0&#039;
        option &#039;proto&#039; &#039;static&#039;
        option &#039;ipaddr&#039; &#039;192.168.1.1&#039;
        option &#039;netmask&#039; &#039;255.255.255.0&#039;
        option &#039;nat&#039; &#039;1&#039;
        option &#039;gateway&#039; &#039;192.168.1.1&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;
        option &#039;dns&#039; &#039;202.106.196.115 202.96.64.38&#039;

config &#039;interface&#039; &#039;wan&#039;
        option &#039;ifname&#039; &#039;eth1.1&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;
        option &#039;proto&#039; &#039;dhcp&#039;

config &#039;interface&#039; &#039;wan2&#039;
        option &#039;ifname&#039; &#039;eth2&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;
        option &#039;proto&#039; &#039;dhcp&#039;

config &#039;interface&#039; &#039;wan3&#039;
        option &#039;ifname&#039; &#039;eth3&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;
        option &#039;proto&#039; &#039;dhcp&#039;</code></pre></div><p>this is /etc/config/multiwan</p><div class="codebox"><pre><code>root@OpenWrt:/etc/config# vi multiwan

config &#039;multiwan&#039; &#039;config&#039;
        option &#039;default_route&#039; &#039;balancer&#039;

config &#039;interface&#039; &#039;wan&#039;
        option &#039;weight&#039; &#039;3&#039;
        option &#039;health_interval&#039; &#039;10&#039;
        option &#039;icmp_hosts&#039; &#039;dns&#039;
        option &#039;timeout&#039; &#039;3&#039;
        option &#039;health_fail_retries&#039; &#039;3&#039;
        option &#039;health_recovery_retries&#039; &#039;5&#039;
        option &#039;dns&#039; &#039;auto&#039;
        option &#039;failover_to&#039; &#039;balancer&#039;

config &#039;interface&#039; &#039;wan2&#039;
        option &#039;weight&#039; &#039;3&#039;
        option &#039;health_interval&#039; &#039;10&#039;
        option &#039;icmp_hosts&#039; &#039;dns&#039;
        option &#039;timeout&#039; &#039;3&#039;
        option &#039;health_fail_retries&#039; &#039;3&#039;
        option &#039;health_recovery_retries&#039; &#039;5&#039;
        option &#039;failover_to&#039; &#039;balancer&#039;
        option &#039;dns&#039; &#039;auto&#039;

config &#039;interface&#039; &#039;wan3&#039;
        option &#039;weight&#039; &#039;4&#039;
        option &#039;health_interval&#039; &#039;10&#039;
        option &#039;icmp_hosts&#039; &#039;dns&#039;
        option &#039;timeout&#039; &#039;3&#039;
        option &#039;health_fail_retries&#039; &#039;3&#039;
        option &#039;health_recovery_retries&#039; &#039;5&#039;
        option &#039;failover_to&#039; &#039;balancer&#039;
        option &#039;dns&#039; &#039;auto&#039;

config &#039;mwanfw&#039;
        option &#039;wanrule&#039; &#039;balancer&#039;</code></pre></div><p>some guy at local forum told me that restart multiwan(/etc/init.d/multiwan restart) can solve this problem , I tryed it seem like what he said.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p114538">
				<div class="post-metadata">
					<div class="post-num">Post #205</div>
					<div class="post-author">huglester</div>
					<div class="post-datetime">
						5 Aug 2010, 20:05					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>huglester wrote:</cite><blockquote><div class="codebox"><pre><code> tcpdump -ni eth0.3
00:31:49.680112 IP 192.168.0.101 &gt; 8.8.4.4: ICMP echo request, id 8015, seq 0, length 64
00:31:49.708319 IP 8.8.4.4 &gt; 192.168.0.101: ICMP echo reply, id 8015, seq 0, length 64
00:31:50.816975 IP 192.168.0.101.40315 &gt; 8.8.4.4.53: 3459+ A? gg.google.com. (31)
00:31:50.882518 IP 8.8.4.4.53 &gt; 192.168.0.101.40315: 3459 7/0/0 CNAME[|domain]</code></pre></div><p>Thnaks for spending your time on me...</p></blockquote></div><div class="quotebox"><cite>SouthPawn wrote:</cite><blockquote><p>Sorry for the delayed reply, and you may have already answered this, but when you reverse the wans in the config file, does the failure stay with the primary or is it always wan that fails?</p><p>If so, I&#039;d be sure to check the firewall settings and make sure they are identical for both devices.</p></blockquote></div><p>Helo again!<br />I&#039;m also sorry for the delay, was away.. And want to continue the discution.</p><p>After your recommendations about looking into firewall, I looked inside the<br />/etc/config/firewall, and decided to add these lines:</p><div class="codebox"><pre><code>config &#039;forwarding&#039;
        option &#039;src&#039; &#039;lan&#039;
        option &#039;dest&#039; &#039;wan2&#039;

config &#039;rule&#039;
        option &#039;src&#039; &#039;wan2&#039;
        option &#039;proto&#039; &#039;udp&#039;
        option &#039;dest_port&#039; &#039;68&#039;
        option &#039;target&#039; &#039;ACCEPT&#039;

config &#039;rule&#039;
        option &#039;src&#039; &#039;wan2&#039;
        option &#039;proto&#039; &#039;icmp&#039;
        option &#039;icmp_type&#039; &#039;echo-request&#039;
        option &#039;target&#039; &#039;ACCEPT&#039;

config &#039;zone&#039;
        option &#039;name&#039; &#039;wan2&#039;
        option &#039;output&#039; &#039;ACCEPT&#039;
        option &#039;masq&#039; &#039;1&#039;
        option &#039;mtu_fix&#039; &#039;1&#039;
        option &#039;input&#039; &#039;DROP&#039;
        option &#039;forward&#039; &#039;DROP&#039;</code></pre></div><p>before:<br /></p><div class="codebox"><pre><code>config &#039;include&#039;
        option &#039;path&#039; &#039;/etc/firewall.user&#039;</code></pre></div><p>Now I don&#039;t see DNS request delays.. I&#039;m only two hours under this settins, but with earlier settings even after 2-5minutes internet started timing out, and WANs were &#039;failing&#039;</p><p>I&#039;ll post back the results, later, when I test this settings under 200MBit internet load <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> </p><p>Thanks SouthPawn for this cute package <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" />!</p><p>cheers,<br />Jaroslav</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p114560">
				<div class="post-metadata">
					<div class="post-num">Post #206</div>
					<div class="post-author">huglester</div>
					<div class="post-datetime">
						6 Aug 2010, 00:16					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>well I must say smth strange is still happening here...:(</p><p>logread |grep WAN<br />shows smth like this:<br /></p><div class="codebox"><pre><code># logread  | grep WAN
Aug  5 20:27:13 tplink user.notice root: [Multi-WAN Notice]: Succesfully Initialized on Thu, 05 Aug 2010 20:27:13 +0300.
Aug  5 20:48:23 tplink user.notice root: [Multi-WAN Notice]: wan2 has failed and is currently offline.
Aug  5 20:49:28 tplink user.notice root: [Multi-WAN Notice]: wan2 has recovered and is back online!
Aug  5 20:50:06 tplink user.notice root: [Multi-WAN Notice]: wan2 has failed and is currently offline.
Aug  5 23:18:54 tplink user.notice root: [Multi-WAN Notice]: wan has failed and is currently offline.
Aug  5 23:21:17 tplink user.notice root: [Multi-WAN Notice]: wan has recovered and is back online!
Aug  5 23:25:25 tplink user.notice root: [Multi-WAN Notice]: wan has failed and is currently offline.
Aug  5 23:26:55 tplink user.notice root: [Multi-WAN Notice]: wan has recovered and is back online!
Aug  5 23:30:43 tplink user.notice root: [Multi-WAN Notice]: wan has failed and is currently offline.
Aug  5 23:33:58 tplink user.notice root: [Multi-WAN Notice]: wan has recovered and is back online!
Aug  5 23:47:01 tplink user.notice root: [Multi-WAN Notice]: wan has failed and is currently offline.
Aug  5 23:47:52 tplink user.notice root: [Multi-WAN Notice]: wan has recovered and is back online!
Aug  5 23:51:20 tplink user.notice root: [Multi-WAN Notice]: wan has failed and is currently offline.
Aug  5 23:53:43 tplink user.notice root: [Multi-WAN Notice]: wan has recovered and is back online!</code></pre></div><div class="codebox"><pre><code>Edit, these lines appeared not long ago:
Aug  6 00:16:31 tplink user.notice root: [Multi-WAN Notice]: wan has failed and is currently offline.
Aug  6 00:17:35 tplink user.notice root: [Multi-WAN Notice]: wan has recovered and is back online!
Aug  6 00:28:52 tplink user.notice root: [Multi-WAN Notice]: wan2 has recovered and is back online!</code></pre></div><p>For example now, I&#039;m pinging for ~30 minutes: ping -c 1 -W 3 -I eth0.3 8.8.8.8<br />(eth0.3 is wan2) - and I am not getting ANY reply...</p><p>If I reboot the router, the wan2 interface will work for some time...</p><p>Thanks for your ideas guys</p>											<p class="post-edited">(Last edited by <strong>huglester</strong> on 6 Aug 2010, 00:38)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115136">
				<div class="post-metadata">
					<div class="post-num">Post #207</div>
					<div class="post-author">andyballon</div>
					<div class="post-datetime">
						13 Aug 2010, 18:07					</div>
				</div>
				<div class="post-content content">
					<p>@huglester - have you tried extending ping timeout to more than 3 secs? (Health Monitor ICMP Timeout) looks like a lossy connection to me.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115137">
				<div class="post-metadata">
					<div class="post-num">Post #208</div>
					<div class="post-author">huglester</div>
					<div class="post-datetime">
						13 Aug 2010, 18:18					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>andyballon wrote:</cite><blockquote><p>@huglester - have you tried extending ping timeout to more than 3 secs? (Health Monitor ICMP Timeout) looks like a lossy connection to me.</p></blockquote></div><p>Hello. I have not tried, but the problem is that even when I tried pinging the gateway of WAN/WAN2 - they are timing out ....</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115168">
				<div class="post-metadata">
					<div class="post-num">Post #209</div>
					<div class="post-author">andyballon</div>
					<div class="post-datetime">
						14 Aug 2010, 11:35					</div>
				</div>
				<div class="post-content content">
					<p>oh. try setting it to a higher value. sometimes multiwan thinks the interface is down and tries to fix it and things go wrong. that&#039;s why you can&#039;t ping the gateways.<br />it&#039;s also &quot; option &#039;timeout&#039; &#039;3&#039; &quot; in the config file. try 5secs.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115330">
				<div class="post-metadata">
					<div class="post-num">Post #210</div>
					<div class="post-author">huglester</div>
					<div class="post-datetime">
						16 Aug 2010, 21:20					</div>
				</div>
				<div class="post-content content">
					<p>Hello Andy,</p><p>sorry for the delay and thanks for suggestions. Well I tried them, situation is in some way better, I&#039;ll explain:</p><p>Setting these settings to higher values, does not bring the interfaces&nbsp; down so often, but I see that sometime I ust have no internet connection.<br />After digging for more informations, I found out, that when I have no internet connection (to some hosts) I see that WAN or WAN2 is timing out ...</p><p>After some more investigation, I found out, that for example, traffic via WAN interface is dropping about 10-15% of pings, but when I have removed WAN2 - and logs showed that WAN2 has failed,<br />traffic via WAN interface gave me 0% of ping loss, I tried reviewing the code, since I know iptables a little. But here I see that I can&#039;t solve this problem by myself...</p><p>Thank You!</p><p>huglester</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115407">
				<div class="post-metadata">
					<div class="post-num">Post #211</div>
					<div class="post-author">andyballon</div>
					<div class="post-datetime">
						17 Aug 2010, 16:56					</div>
				</div>
				<div class="post-content content">
					<p>hmmm.... that is odd. are you pinging a host name or an ip address? try pinging 8.8.8.8 and see if you get lost packets. if you can ping that without lost packets then maybe it&#039;s your dns that&#039;s causing the problem.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115508">
				<div class="post-metadata">
					<div class="post-num">Post #212</div>
					<div class="post-author">buildster</div>
					<div class="post-datetime">
						19 Aug 2010, 09:18					</div>
				</div>
				<div class="post-content content">
					<p>Hey Craig,</p><p>You have a wonderful script for multiple wan configuration. I&#039;ve been hacking something like your balancer and mwanfw for ~2 years. But nothing like this real thing! Therefore, I&#039;m jumping your wagon and making a few contributions... see <a href="https://dev.openwrt.org/ticket/7792">https://dev.openwrt.org/ticket/7792</a></p><p>Beside those minor improvements, I wonder the memory footprint of the script can be reduced? When the script manages triple wan&#039;s on my little thin WHR-HP-G54 with only 16 MB memory,&nbsp; 4 multiwan agents, plus an instance of wpa_supplicant and openvpn server, make it impossible to download a page with ssl curl. It actually runs out of memory and crashes/restarts the little wimp. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>It will be nice if only one agent is needed to manage multiple wan&#039;s.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115527">
				<div class="post-metadata">
					<div class="post-num">Post #213</div>
					<div class="post-author">huglester</div>
					<div class="post-datetime">
						19 Aug 2010, 14:52					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>andyballon wrote:</cite><blockquote><p>hmmm.... that is odd. are you pinging a host name or an ip address? try pinging 8.8.8.8 and see if you get lost packets. if you can ping that without lost packets then maybe it&#039;s your dns that&#039;s causing the problem.</p></blockquote></div><p>Hello Andy and others <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />It&#039;s me again... Thanks for taking so much of your time to look into my problem! </p><p>Well I was playing with this multiwan thingie for serveral hours and came to sollution, that this can be my VLAN issue.<br />Maybe I have configured them wrong....</p><p>Because: when I restarted router, I managed to get IP in the range of WAN, I could even ping a GATEWAN of WAN, (ttl was 64), and it should be 63, because I was behind the router...<br />So maybe I could paste ne network config, so you experts could take a look at it? </p><p>/etc/config/network<br /></p><div class="codebox"><pre><code>config &#039;interface&#039; &#039;loopback&#039;
       option &#039;ifname&#039;   &#039;lo&#039;
       option &#039;proto&#039;    &#039;static&#039;
       option &#039;ipaddr&#039;   &#039;127.0.0.1&#039;
       option &#039;netmask&#039;  &#039;255.0.0.0&#039;

config &#039;interface&#039; &#039;lan&#039;
        option &#039;ifname&#039;   &#039;eth0.1&#039;
        option &#039;type&#039;     &#039;bridge&#039;
        option &#039;proto&#039;    &#039;static&#039;
        option &#039;ipaddr&#039;   &#039;192.168.1.1&#039;
        option &#039;netmask&#039;  &#039;255.255.255.0&#039;

config &#039;interface&#039; &#039;wan&#039;
        option &#039;ifname&#039; &#039;eth0.2&#039;
        option &#039;proto&#039; &#039;dhcp&#039;
        option &#039;dns&#039; &#039;8.8.8.8&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;

config &#039;interface&#039; &#039;wan2&#039;
        option &#039;ifname&#039; &#039;eth0.3&#039;
        option &#039;dns&#039; &#039;8.8.4.4&#039;
        option &#039;proto&#039; &#039;dhcp&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;

config &#039;switch&#039;
    option &#039;name&#039; &#039;rtl8366rb&#039;
        option &#039;reset&#039; &#039;1&#039;
        option &#039;enable_vlan&#039; &#039;1&#039;

config &#039;switch_vlan&#039;
        option &#039;device&#039; &#039;rtl8366rb&#039;
        option &#039;vlan&#039; &#039;1&#039;
        option &#039;ports&#039; &#039;2 3 4 5t&#039;

config &#039;switch_vlan&#039;
        option &#039;device&#039; &#039;rtl8366rb&#039;
        option &#039;vlan&#039; &#039;2&#039;
        option &#039;ports&#039; &#039;0 5t&#039;

config &#039;switch_vlan&#039;
        option &#039;device&#039; &#039;rtl8366rb&#039;
        option &#039;vlan&#039; &#039;3&#039;
        option &#039;ports&#039; &#039;1 5t&#039;</code></pre></div><p>WAN is connected to WAN port<br />and WAN2 is connected to Port #1</p><p>What do you guys think of this config? is there anything I could change or maybe there are some obvious &#039;errors&#039;? </p><p>Thank you!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115593">
				<div class="post-metadata">
					<div class="post-num">Post #214</div>
					<div class="post-author">mzguanglin</div>
					<div class="post-datetime">
						20 Aug 2010, 17:28					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for your multiwan.<br />It works well in my rg100a-aa residential gateway with 2 internet connection.</p><p>However, I get trouble while trying to compile the sources into the final image.</p><p>I&#039;d like to compile the two packages into the openwrt-RG100A_DB120-jffs2-128k-cfe.bin file. The source of multiwan_1.0.12.ipk can be found at <a href="https://dev.openwrt.org/browser/packages/net/multiwan">https://dev.openwrt.org/browser/packages/net/multiwan</a>, and luci-app-multiwan_1.0.12d.ipk found at <a href="http://luci.subsignal.org/trac/browser/luci/trunk/applications/luci-multiwan">http://luci.subsignal.org/trac/browser/ … i-multiwan</a>.</p><p>Here is my approach.</p><p>&nbsp; &nbsp;0. cd ~/<br />&nbsp; &nbsp;1. svn checkout svn://svn.openwrt.org/openwrt/branches/backfire<br />&nbsp; &nbsp;2. cd backfire<br />&nbsp; &nbsp;3. ./scripts/feeds update -a<br />&nbsp; &nbsp;4. ./scripts/feeds install -a<br />&nbsp; &nbsp;5. make menuconfig, bcm63xx, add libpthread and libpcap<br />&nbsp; &nbsp;6. make<br />&nbsp; &nbsp;7. copy ./bin/bcm63xx/openwrt-RG100A_DB120-jffs2-128k-cfe.bin to another directory, it works quite well in my rg100a-aa router<br />&nbsp; &nbsp;8. cp feed.conf.default feed.conf<br />&nbsp; &nbsp;9. vi feed.conf , replace &quot;src-svn luci <a href="http://svn.luci.subsignal.org/luci/tags/0.9.0/contrib/package\">http://svn.luci.subsignal.org/luci/tags/0.9.0/contrib/package&quot;</a> by &quot;src-svn luci <a href="http://svn.luci.subsignal.org/luci/trunk/contrib/package\">http://svn.luci.subsignal.org/luci/trunk/contrib/package&quot;</a> which has luci-multiwan source codes.<br />&nbsp; &nbsp;10. rm -rf feeds/luci* <br />&nbsp; &nbsp;11. ./scripts/feeds update luci<br />&nbsp; &nbsp;12. make menuconfig, add luci-multiwan<br />&nbsp; &nbsp;13. make<br />&nbsp; &nbsp;14. get new&nbsp; ./bin/bcm63xx/openwrt-RG100A_DB120-jffs2-128k-cfe.bin, but it doesn&#039;t work in my rg100a-aa router. Evenmore, I coudn&#039;t get icmp reply by ping 192.168.1.1 command.</p><p>The strangest thing occured when I upload the early compiled firmware into rg100a-a router and opkg ./bin/bcm63xx/packages/luci-app-multiwan_0.9+svn6240-1_brcm63xx.ipk as long as ./bin/bcm63xx/packages/multiwan_1.0.17-0_brcm63xx.ipk. Those two packages work quite well now!</p><p>I&#039;m puzzled why those two packages works well while installing them by opkg, but bad while packing them into image file?</p><p>Counld anyone help?</p>											<p class="post-edited">(Last edited by <strong>mzguanglin</strong> on 20 Aug 2010, 17:30)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115703">
				<div class="post-metadata">
					<div class="post-num">Post #215</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						23 Aug 2010, 09:32					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>buildster wrote:</cite><blockquote><p>Hey Craig,</p><p>You have a wonderful script for multiple wan configuration. I&#039;ve been hacking something like your balancer and mwanfw for ~2 years. But nothing like this real thing! Therefore, I&#039;m jumping your wagon and making a few contributions... see <a href="https://dev.openwrt.org/ticket/7792">https://dev.openwrt.org/ticket/7792</a></p><p>Beside those minor improvements, I wonder the memory footprint of the script can be reduced? When the script manages triple wan&#039;s on my little thin WHR-HP-G54 with only 16 MB memory,&nbsp; 4 multiwan agents, plus an instance of wpa_supplicant and openvpn server, make it impossible to download a page with ssl curl. It actually runs out of memory and crashes/restarts the little wimp. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>It will be nice if only one agent is needed to manage multiple wan&#039;s.</p></blockquote></div><p>Hey buildster, I&#039;m looking over some of the changes you submitted in that ticket. (was away on vaca.)<br />Anyhow, yeah I&#039;ve been looking towards possibly making a stand-alone health-monitor as a means of reducing the overhead required for monitoring the active wan links.</p>											<p class="post-edited">(Last edited by <strong>SouthPawn</strong> on 23 Aug 2010, 09:34)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115750">
				<div class="post-metadata">
					<div class="post-num">Post #216</div>
					<div class="post-author">buildster</div>
					<div class="post-datetime">
						23 Aug 2010, 21:29					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>SouthPawn wrote:</cite><blockquote><p>Hey buildster, I&#039;m looking over some of the changes you submitted in that ticket. (was away on vaca.)<br />Anyhow, yeah I&#039;ve been looking towards possibly making a stand-alone health-monitor as a means of reducing the overhead required for monitoring the active wan links.</p></blockquote></div><p>Hope you had a wonderful vacation. It&#039;s cool that you&#039;re looking for a means of reducing the overhead! I just started, over the weekend, experimenting changes toward this objective based on your job queue design.</p><p>Would you help me understand the script better? There are 5 types of tasks: fail, pass, acquire, refresh, and monitor (a wan&#039;s health). In term of task scheduling, should any priority be given to a certain type of task over another, or will first-in-first-out be fine? Are any duplicates for a particular group possible (and disallowed) in the job queue?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115790">
				<div class="post-metadata">
					<div class="post-num">Post #217</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						24 Aug 2010, 11:39					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>buildster wrote:</cite><blockquote><div class="quotebox"><cite>SouthPawn wrote:</cite><blockquote><p>Hey buildster, I&#039;m looking over some of the changes you submitted in that ticket. (was away on vaca.)<br />Anyhow, yeah I&#039;ve been looking towards possibly making a stand-alone health-monitor as a means of reducing the overhead required for monitoring the active wan links.</p></blockquote></div><p>Hope you had a wonderful vacation. It&#039;s cool that you&#039;re looking for a means of reducing the overhead! I just started, over the weekend, experimenting changes toward this objective based on your job queue design.</p><p>Would you help me understand the script better? There are 5 types of tasks: fail, pass, acquire, refresh, and monitor (a wan&#039;s health). In term of task scheduling, should any priority be given to a certain type of task over another, or will first-in-first-out be fine? Are any duplicates for a particular group possible (and disallowed) in the job queue?</p></blockquote></div><p>Well, the way it&#039;s structured is there is a background task launched for each wan, it&#039;s only job is to ping the hosts it&#039;s told to ping and check to make sure no ips have changed on it, this then writes a jobqueue file in /tmp/.mwan as to whether it passed or failed.</p><p>A third background task is launched that reads the file and calls adds to the failover count, recovery count or reacquisition of information from the wan link, and periodically checks to make sure the iptables rules are still in place.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115987">
				<div class="post-metadata">
					<div class="post-num">Post #218</div>
					<div class="post-author">bauman</div>
					<div class="post-datetime">
						27 Aug 2010, 15:15					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for the great multi-wan package. I am using it for failover only (no load balancing) with 2 WAN connections. It would be really useful if it could send myself a notification email whenever the primary WAN goes down. Would this be hard to implement?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116021">
				<div class="post-metadata">
					<div class="post-num">Post #219</div>
					<div class="post-author">tysonedwards</div>
					<div class="post-datetime">
						28 Aug 2010, 04:36					</div>
				</div>
				<div class="post-content content">
					<p>IIRC, link failure detection notifications already exist within one of the two Statistics apps for OpenWrt.<br />All that one needs to do is set up your OK, INFO, WARN, CRIT states and then assign which conditions need mailings.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116684">
				<div class="post-metadata">
					<div class="post-num">Post #220</div>
					<div class="post-author">renoir</div>
					<div class="post-datetime">
						8 Sep 2010, 13:04					</div>
				</div>
				<div class="post-content content">
					<p>Thank you so much! This is what I&#039;ve been waiting for!</p><p>I run the script (1.0.17) on a Dlink DIR-825 with backfire 10.03, with a wireless-DSL link as default route and a (very slow, 384k) ADSL link as failover with quite a few traffic rules. It works just fine! Asterisk and Openvpn server that are run on the same router have their routes automatically adjusted after a short delay (depending on settings not relying on this script). It&#039;s just fantastic!</p><p>However I might have discovered a minor bug. The health monitor intervall setting seems to be broken. No matter what value is set, it sends a ping evey second. Not that this is interfering with normal operation, but it is a waste of resources and renders the setting quite pointless.</p><p>Greetings,<br />renoir.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116723">
				<div class="post-metadata">
					<div class="post-num">Post #221</div>
					<div class="post-author">buildster</div>
					<div class="post-datetime">
						8 Sep 2010, 22:47					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>renoir wrote:</cite><blockquote><p>However I might have discovered a minor bug. The health monitor intervall setting seems to be broken. No matter what value is set, it sends a ping evey second. Not that this is interfering with normal operation, but it is a waste of resources and renders the setting quite pointless.</p><p>Greetings,<br />renoir.</p></blockquote></div><p>I can see a ping per second if health_interval is missing or &quot;intervall&quot; is misspelled. Also every second the script will check whether the iptables rules are still in place.</p><p>By the way, speaking about resources, I&#039;m experimenting changes that reduce the load/overhead of monitoring multiple wan&#039;s.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116732">
				<div class="post-metadata">
					<div class="post-num">Post #222</div>
					<div class="post-author">renoir</div>
					<div class="post-datetime">
						9 Sep 2010, 01:05					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>buildster wrote:</cite><blockquote><p>I can see a ping per second if health_interval is missing or &quot;intervall&quot; is misspelled.</p></blockquote></div><p>I checked my config file, no spelling mistakes. Still sends a ping every second...</p><p>Resources again, I noticed that the script runs n+1 agents for n WANs...</p><p>For performance, on a WRT54GS v1.1 running at 216 MHz, 2.4 kernel, wan speed maxed out at 9mbit while the script was running, with 2 active wans (pppoe), no load balancing. With the script not running, it reached 12 mbit which equals to the maximum speed I get from my ISP.</p><p>The DIR-825 doesn&#039;t show this bottleneck (not even noticeable load), but it runs at 680 MHz...</p><p>What is your approach to reduce load, if I may ask?</p><p>Greetings,<br />renoir.</p>											<p class="post-edited">(Last edited by <strong>renoir</strong> on 9 Sep 2010, 01:17)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116741">
				<div class="post-metadata">
					<div class="post-num">Post #223</div>
					<div class="post-author">buildster</div>
					<div class="post-datetime">
						9 Sep 2010, 09:45					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>renoir wrote:</cite><blockquote><div class="quotebox"><cite>buildster wrote:</cite><blockquote><p>I can see a ping per second if health_interval is missing or &quot;intervall&quot; is misspelled.</p></blockquote></div><p>I checked my config file, no spelling mistakes. Still sends a ping every second...</p><p>Resources again, I noticed that the script runs n+1 agents for n WANs...</p><p>For performance, on a WRT54GS v1.1 running at 216 MHz, 2.4 kernel, wan speed maxed out at 9mbit while the script was running, with 2 active wans (pppoe), no load balancing. With the script not running, it reached 12 mbit which equals to the maximum speed I get from my ISP.</p><p>The DIR-825 doesn&#039;t show this bottleneck (not even noticeable load), but it runs at 680 MHz...</p><p>What is your approach to reduce load, if I may ask?</p><p>Greetings,<br />renoir.</p></blockquote></div><p>I take my previous statement back. If health_interval is missing, it means ping is disabled--you won&#039;t see n+1 agents, but just 1 agent. I don&#039;t know how a ping every second comes about. Only another background process (the 1, not the n) wakes up every second, checking on iptables.</p><p>As for load reduction, I&#039;m testing changes to the script on a WHR-HP-G54 (200 MHz CPU, 16 MB memory).... the load average is around 0.10 most of the time for 3 wan&#039;s, with a 2~4 minutes delay in updating health status. They&#039;re useful for thin routers if anyone is interested in making corresponding changes in luci-app-multiwan...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p117071">
				<div class="post-metadata">
					<div class="post-num">Post #224</div>
					<div class="post-author">greal</div>
					<div class="post-datetime">
						14 Sep 2010, 00:05					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>Does any one have this multiwan running on D-Link DIR-825? I cannot get it working and cant find any howtos how to exactly do it with this device. I have one 200Mbit cable connection with DHCP and other 50/30Mbit VDSL2 with static ip-address. I would like to setup the cable connection so that it is on the LAN4 port on the switch and it would be only used by one port (torrents, heh).</p><p>Then the VDSL2 connection would be the primary connection and ALL the other traffic except the torrent-port would be routed via it.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p117561">
				<div class="post-metadata">
					<div class="post-num">Post #225</div>
					<div class="post-author">blubbi321</div>
					<div class="post-datetime">
						20 Sep 2010, 16:51					</div>
				</div>
				<div class="post-content content">
					<p>question to southpawn: is it possible to (easily) modify the script in a way so that one can use multiple gateways (on the same network) without having to use multiple network interfaces?</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 9 of 14</div><nav><ul><li><a href="viewtopic.php%3Fid=23904&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=7.html">7</a></li><li><a href="viewtopic.php%3Fid=23904&amp;p=8.html">8</a></li><li class="pagination-current"><span>9</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=10.html">10</a></li><li><a href="viewtopic.php%3Fid=23904&amp;p=11.html">11</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=14.html">14</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0.001 -->

</body>
</html>