<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> ipsec connecting 2 subnets over WAN</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 29 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p368692">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">techjohnny</div>
					<div class="post-datetime">
						23 Nov 2017, 06:37					</div>
				</div>
				<div class="post-content content">
					<p>Site LS has Kerio Control box, the connection was working fine with the default config with Linux IPSEC, but I&#039;m trying to consolidate our Tomato router and Linux machine running ipsec.</p><p>This is the error message on my OpenWRT router: </p><p>ERROR: exchange Identity Protection not allowed in any applicable rmconf.</p><p>I confirmed that the mode is main, and even tried aggressive, but same results.<br />I have manually set IKE, KEYEXCHANGE, and ESP to match the other firewall (Kerio Control), but it still will not connect.&nbsp; &nbsp;</p><p>I have even disabled the firewall in OpenWrt temporarily to test.</p><p>Here&#039;s an ipsec statusall</p><p>Status of IKE charon daemon (strongSwan 5.3.2, Linux 3.18.20, armv7l):<br />&nbsp; uptime: 111 seconds, since Nov 22 20:28:24 2017<br />&nbsp; malloc: sbrk 233472, mmap 0, used 227464, free 6008<br />&nbsp; worker threads: 9 of 16 idle, 7/0/0/0 working, job queue: 0/0/0/0, scheduled: 5<br />&nbsp; loaded plugins: charon test-vectors ldap pkcs11 aes des blowfish sha1 sha2 md4 md5 random nonce x509 revocation constraints pubkey pkcs1 pkcs8 pgp dnskey pem openssl gcrypt af-alg fips-prf gmp agent xcbc cmac hmac ctr ccm gcm curl mysql sqlite attr kernel-netlink resolve socket-default farp stroke smp updown eap-identity eap-md5 eap-mschapv2 eap-radius xauth-generic xauth-eap dhcp whitelist led duplicheck uci addrblock unity<br />Listening IP addresses:<br />&nbsp; 192.168.2.20<br />&nbsp; wan ip<br />&nbsp; 2603:3023:510:7600:4694:fcff:fe34:61b8<br />&nbsp; 2603:3023:510:7600::f5c2<br />&nbsp; 10.8.0.1<br />Connections:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ls:&nbsp; 192.168.2.20...kerio firewall&nbsp; IKEv1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ls:&nbsp; &nbsp;local:&nbsp; [cbw] uses pre-shared key authentication<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ls:&nbsp; &nbsp;remote: [control] uses pre-shared key authentication<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ls:&nbsp; &nbsp;child:&nbsp; 192.168.2.0/24 === 192.168.1.0/24 TUNNEL<br />Security Associations (1 up, 0 connecting):<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ls[1]: CONNECTING, 192.168.2.20[%any]...kerio firewall[%any]<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ls[1]: IKEv1 SPIs: 28c9e983e3c58168_i* 0000000000000000_r<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ls[1]: Tasks queued: QUICK_MODE<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ls[1]: Tasks active: ISAKMP_VENDOR ISAKMP_CERT_PRE MAIN_MODE ISAKMP_CERT_POST ISAKMP_NATD</p><p>Here&#039;s my ipsec.conf<br />config setup<br />&nbsp; &nbsp; &nbsp; &nbsp; # strictcrlpolicy=yes<br />&nbsp; &nbsp; &nbsp; &nbsp; # uniqueids = no</p><p># Add connections here.</p><p># Sample VPN connections</p><p>conn ls<br />&nbsp; &nbsp; &nbsp; &nbsp; left=192.168.2.20<br />&nbsp; &nbsp; &nbsp; &nbsp; leftsubnet=192.168.2.0/24<br />&nbsp; &nbsp; &nbsp; &nbsp; leftid=cbw<br />&nbsp; &nbsp; &nbsp; &nbsp; rightid=control<br />&nbsp; &nbsp; &nbsp; &nbsp; right=kerio ip<br />&nbsp; &nbsp; &nbsp; &nbsp; rightsubnet=192.168.1.0/24<br />&nbsp; &nbsp; &nbsp; &nbsp; auto=start<br />&nbsp; &nbsp; &nbsp; &nbsp; authby=secret<br />&nbsp; &nbsp; &nbsp; &nbsp; keyexchange=ikev1<br />&nbsp; &nbsp; &nbsp; &nbsp; ike=aes128-sha1-modp2048,3des-sha1-modp1536<br />&nbsp; &nbsp; &nbsp; &nbsp; esp=aes128-sha1,3des-sha1</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>