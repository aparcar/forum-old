<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> blocking outbound bittorrent connections</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 30 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p112942">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">aport</div>
					<div class="post-datetime">
						12 Jul 2010, 04:10					</div>
				</div>
				<div class="post-content content">
					<p>a member of my network likes to torrent. All day, every day. Unfortunately he uses public trackers and does not throttle himself. So, I&#039;ve been throttling the traffic on the router. Which is all fine and dandy...</p><p>However, with the recent press about RIAA and MPAA suing individuals for uploading copyrighted materials, I am legitimately concerned. The solution is to simply block all outbound bittorrent connections.</p><p>I assume I can do this with iptables and l7proto... which is what I&#039;m using to mark packets in the mangle table for traffic shaping. What would the rules look like to simply drop the connections? Only outbound connections should be dropped, inbound is fine. So far legal action has only been taken against those uploading copyrighted materials.</p><p>Thanks!</p>											<p class="post-edited">(Last edited by <strong>aport</strong> on 12 Jul 2010, 04:12)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p112943">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">playdude</div>
					<div class="post-datetime">
						12 Jul 2010, 04:49					</div>
				</div>
				<div class="post-content content">
					<p>One question. Are you trying to do this manually or using package qos-scripts? I played a bit with qos-scripts by changing options in /etc/config/qos and there was a part mentioning torrent in that file. If you&#039;re not using qos-scripts, might be worth checking it out.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p112945">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">aport</div>
					<div class="post-datetime">
						12 Jul 2010, 06:21					</div>
				</div>
				<div class="post-content content">
					<p>I wish to this manually, eg<br /></p><div class="codebox"><pre><code>iptables -A FORWARD -m layer7 --l7proto bittorrent -j DROP</code></pre></div><p>the above rule does not work FYI.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p112962">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						12 Jul 2010, 15:15					</div>
				</div>
				<div class="post-content content">
					<p>aport, you might want to look into &quot;freifunk-p2pblock&quot; in the LuCI feed. Its a firewall addon designed to block outgoing p2p traffic and works without the gui as well.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p113000">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">aport</div>
					<div class="post-datetime">
						12 Jul 2010, 20:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>jow wrote:</cite><blockquote><p>aport, you might want to look into &quot;freifunk-p2pblock&quot; in the LuCI feed. Its a firewall addon designed to block outgoing p2p traffic and works without the gui as well.</p></blockquote></div><p>jow, once again thank you very much <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120148">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">mofa</div>
					<div class="post-datetime">
						1 Nov 2010, 14:30					</div>
				</div>
				<div class="post-content content">
					<p>freifunk-p2pblock doesn&#039;t block anything. i want also block ingoing p2p traffic.<br />i put<br /></p><div class="codebox"><pre><code>iptables -A FORWARD -m layer7 --l7proto bittorrent -j DROP</code></pre></div><p>into /etc/firewall.user, but it doesn&#039;t work either.</p><p>any idea?</p><p>cheers<br />mofa</p>											<p class="post-edited">(Last edited by <strong>mofa</strong> on 1 Nov 2010, 14:48)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120150">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						1 Nov 2010, 14:44					</div>
				</div>
				<div class="post-content content">
					<p>-I instead of -A</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120153">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">mofa</div>
					<div class="post-datetime">
						1 Nov 2010, 14:58					</div>
				</div>
				<div class="post-content content">
					<p>changing -A to -I doesn&#039;t change anything. It doesn&#039;t block in- and outgoing traffic.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120155">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">written_direcon</div>
					<div class="post-datetime">
						1 Nov 2010, 15:07					</div>
				</div>
				<div class="post-content content">
					<p>You have the <em>l7-protocols</em> package installed?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120156">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">mofa</div>
					<div class="post-datetime">
						1 Nov 2010, 15:12					</div>
				</div>
				<div class="post-content content">
					<div class="codebox"><pre><code>Package l7-protocols (2009-05-28-1) installed in root is up to date.</code></pre></div><p>is there a way to put the rule into /etc/config/firewall insted of /etc/firewall.user ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120157">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">written_direcon</div>
					<div class="post-datetime">
						1 Nov 2010, 15:24					</div>
				</div>
				<div class="post-content content">
					<p>aport, install the <em>freifunk-p2pblock</em> package. It also installs the <em>iptables-mod-filter</em>, <em>l7-protocols</em> and <em>iptables-mod-conntrack-extra</em> packages as a dependency. Then you can use /etc/config/freifunk_p2pblock for the configuration in UCI.</p><p>As stated in post #5 it also works without the LuCI frontend.</p>											<p class="post-edited">(Last edited by <strong>written_direcon</strong> on 1 Nov 2010, 15:26)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120159">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">mofa</div>
					<div class="post-datetime">
						1 Nov 2010, 15:37					</div>
				</div>
				<div class="post-content content">
					<p>i installed freifunk-p2pblock again. and after starting it with /etc/init.d/freifunk-p2pblock start i got </p><div class="codebox"><pre><code>Try `iptables -h&#039; or &#039;iptables --help&#039; for more information.
iptables v1.4.6: Couldn&#039;t load match `ipp2p&#039;:File not found</code></pre></div><p>then i commented out the line with </p><div class="codebox"><pre><code>option &#039;ipp2p&#039; &#039;edk dc kazaa gnu bit ares soul winmx apple&#039;</code></pre></div><p>in /etc/config/freifunk_p2pblock because i didn&#039;t find a package with ipp2p. after that i got it started and it seems to block outgoing traffic.<br />is there a way to block ingoing traffic also?</p><p>EDIT: at least it slows down ingoing traffic to ~ 3 KiB/s</p>											<p class="post-edited">(Last edited by <strong>mofa</strong> on 1 Nov 2010, 15:56)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120166">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">written_direcon</div>
					<div class="post-datetime">
						1 Nov 2010, 17:14					</div>
				</div>
				<div class="post-content content">
					<p>To get the <em>freifunk-p2pblock</em> package working do:</p><div class="codebox"><pre><code>opkg update
opkg install freifunk-p2pblock iptables-mod-ipp2p libxtables kmod-ipt-compat-xtables

/etc/init.d/freifunk-p2pblock start
/etc/init.d/freifunk-p2pblock enable</code></pre></div><p><strong>logread</strong><br /></p><div class="codebox"><pre><code>Jan  1 00:19:25 OpenWrt user.notice freifunk-p2pblock: starting p2pblock...
Jan  1 00:19:25 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I FORWARD -i eth0 -p tcp --sport 1024:65535 --dport 1024:65535 -j p2pblock&#039;
Jan  1 00:19:25 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I FORWARD -i eth0 -p udp --sport 1024:65535 --dport 1024:65535 -j p2pblock&#039;
Jan  1 00:19:25 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m recent --rdest --rcheck --name P2PBLOCK --seconds 60 --hitcount 3 -j DROP&#039;
Jan  1 00:19:25 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m recent --rdest --rcheck --name P2PBLOCK --seconds 60 --hitcount 3 -m limi&#039;
Jan  1 00:19:25 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m layer7 --l7proto edonkey -m recent --rdest --set --name P2PBLOCK&#039;
Jan  1 00:19:25 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m layer7 --l7proto edonkey -m limit --limit 1/minute -j LOG --log-prefix P2&#039;
Jan  1 00:19:25 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m layer7 --l7proto bittorrent -m recent --rdest --set --name P2PBLOCK&#039;
Jan  1 00:19:25 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m layer7 --l7proto bittorrent -m limit --limit 1/minute -j LOG --log-prefix&#039;
Jan  1 00:19:25 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m layer7 --l7proto fasttrack -m recent --rdest --set --name P2PBLOCK&#039;
Jan  1 00:19:25 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m layer7 --l7proto fasttrack -m limit --limit 1/minute -j LOG --log-prefix &#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --edk -m recent --rdest --set --name P2PBLOCK&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --edk -m limit --limit 1/minute -j LOG --log-prefix P2PBLOCK-seen-e&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --dc -m recent --rdest --set --name P2PBLOCK&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --dc -m limit --limit 1/minute -j LOG --log-prefix P2PBLOCK-seen-dc&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --kazaa -m recent --rdest --set --name P2PBLOCK&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --kazaa -m limit --limit 1/minute -j LOG --log-prefix P2PBLOCK-seen&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --gnu -m recent --rdest --set --name P2PBLOCK&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --gnu -m limit --limit 1/minute -j LOG --log-prefix P2PBLOCK-seen-g&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --bit -m recent --rdest --set --name P2PBLOCK&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --bit -m limit --limit 1/minute -j LOG --log-prefix P2PBLOCK-seen-b&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --ares -m recent --rdest --set --name P2PBLOCK&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --ares -m limit --limit 1/minute -j LOG --log-prefix P2PBLOCK-seen-&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --soul -m recent --rdest --set --name P2PBLOCK&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --soul -m limit --limit 1/minute -j LOG --log-prefix P2PBLOCK-seen-&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --winmx -m recent --rdest --set --name P2PBLOCK&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --winmx -m limit --limit 1/minute -j LOG --log-prefix P2PBLOCK-seen&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --apple -m recent --rdest --set --name P2PBLOCK&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: set &#039;iptables -I p2pblock -m ipp2p --apple -m limit --limit 1/minute -j LOG --log-prefix P2PBLOCK-seen&#039;
Jan  1 00:19:26 OpenWrt user.notice freifunk-p2pblock: Done.</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120167">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">mofa</div>
					<div class="post-datetime">
						1 Nov 2010, 17:16					</div>
				</div>
				<div class="post-content content">
					<p>After i did</p><p>opkg update<br />opkg install iptables-mod-ipp2p&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p><p>i got:<br /></p><div class="codebox"><pre><code>                                                                                  
Collected errors:                                                                                                                              
 * opkg_install_cmd: Cannot install package iptables-mod-ipp2p.</code></pre></div><p>im using backfire 10.03 / brcm-2.4</p><p>EDIT: also kmod-ipt-compat-xtables is not available</p>											<p class="post-edited">(Last edited by <strong>mofa</strong> on 1 Nov 2010, 17:18)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120168">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">written_direcon</div>
					<div class="post-datetime">
						1 Nov 2010, 17:28					</div>
				</div>
				<div class="post-content content">
					<p>Yeah, xtables is not there on OpenWrt with a 2.4 Kernel.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120191">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">mofa</div>
					<div class="post-datetime">
						2 Nov 2010, 01:59					</div>
				</div>
				<div class="post-content content">
					<p>i flashed the openwrt-brcm47xx-squashfs.trx image with a 2.6 kernel (asus wl500gp v1)<br />now all packages are available and freifunk-p2pblock starts without complaining. THANKS!<br />outgoing connections seems to be blocked and ingoing are very slow (2-10 kiB/s instead of ~1MB/s). how can i block them completely?</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>