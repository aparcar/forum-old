<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> IPsec ?</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 28 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p216">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">bitkocher</div>
					<div class="post-datetime">
						22 Apr 2004, 00:49					</div>
				</div>
				<div class="post-content content">
					<p>Are there any plans to integrate IPsec into Openwrt ? It seems FreeSwan would be a good choice, because kernel 2.4.20 ist perfectly supported. Possibly a wrt54g version 2 is required because OpenSSL and FreeSwan need many space...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p219">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Void Main</div>
					<div class="post-datetime">
						22 Apr 2004, 06:24					</div>
				</div>
				<div class="post-content content">
					<p>I would be curious if there would be enough CPU to do IPSEC. Maybe at low bandwidth but this thing only shows up with about 83 bogomips. I think you need at least 85 to do IPSEC. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> This is complete speculation on my part though, I don&#039;t have any facts or supporting data. On the other hand, it seems to do WEP pretty well so I dunno.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p278">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">ipv4</div>
					<div class="post-datetime">
						30 Apr 2004, 13:32					</div>
				</div>
				<div class="post-content content">
					<p>I read ipcop is using it in their LFS distro that runs on old &quot;junk&quot; PCs. Might be somthing to check out.</p><p>-Chris</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p301">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">bitkocher</div>
					<div class="post-datetime">
						2 May 2004, 19:28					</div>
				</div>
				<div class="post-content content">
					<p>Hi, I think WRT54g 2.0 is fast enough for IPsec. Super FreeSwan seems to be a reasonable solution, if it fits into wrts flash. Otherwise I would employ a NFS server ;-)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p459">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">LetoAms</div>
					<div class="post-datetime">
						21 May 2004, 00:59					</div>
				</div>
				<div class="post-content content">
					<p>add to your ipkg:</p><p>src openswan <a href="ftp://ftp.openswan.org/openswan/binaries/openwrt/buildroot-20040509/ipkg/">ftp://ftp.openswan.org/openswan/binarie … 0509/ipkg/</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</p><p>run &quot;ipkg update&quot;<br />run &quot;ipkg install mawk gmp openswan-module openswan&quot;</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p2257">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">bitkocher</div>
					<div class="post-datetime">
						24 Sep 2004, 11:18					</div>
				</div>
				<div class="post-content content">
					<p>OpenWRT/OpenSwan enabled WRT54G to run as 100$ IPsec gateway now :-) Speed is ok for 3 MBit/s DSL line. I will try it now with my existing OpenSwan config, which uses X509 certificates.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p2258">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">chimpanzee</div>
					<div class="post-datetime">
						24 Sep 2004, 11:33					</div>
				</div>
				<div class="post-content content">
					<p>is that using DES ? I am waiting for 2.2 so I can use AES which should be faster.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p2259">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">PolarWolf</div>
					<div class="post-datetime">
						24 Sep 2004, 12:47					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><blockquote><p>is that using DES ? I am waiting for 2.2 so I can use AES which should be faster.</p></blockquote></div><p>If you look through the posts on this subject right here in this forum, you&#039;d have seen the post about performance too (<a href="http://openwrt.org/forum/viewtopic.php?t=191">http://openwrt.org/forum/viewtopic.php?t=191</a>). 3DES runs about 1.5mbps, AES about 2.6mbps. Fine for a not-too-broadband broadband connection, but pretty useless for high speed wireless.</p><p>So, in reponse to the original poster, yes it is possible to ipsec with your WRT54G. I&#039;d recommend a v2.x, though an 1.x should work too. Browse through the forum for lots more info on this subject, plenty has been said (and done) in this area.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p2260">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">PolarWolf</div>
					<div class="post-datetime">
						24 Sep 2004, 12:56					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><blockquote><p>add to your ipkg:</p><p>src openswan <a href="ftp://ftp.openswan.org/openswan/binaries/openwrt/buildroot-20040509/ipkg/">ftp://ftp.openswan.org/openswan/binarie … 0509/ipkg/</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</p><p>run &quot;ipkg update&quot;<br />run &quot;ipkg install mawk gmp openswan-module openswan&quot;</p></blockquote></div><p>These are a bit old, Paul. When are the 2.2.0 packages planned to arrive? I can provide these over the weekend if people are waiting for them...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p2268">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">bitkocher</div>
					<div class="post-datetime">
						25 Sep 2004, 15:01					</div>
				</div>
				<div class="post-content content">
					<p>Some files are missing, ipsec setup start complains about missing id an tr...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p2271">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">PolarWolf</div>
					<div class="post-datetime">
						25 Sep 2004, 19:07					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><blockquote><p>Some files are missing, ipsec setup start complains about missing id an tr...</p></blockquote></div><p>Yeah, you will have to recompile openwrt (well, busybox actually) to include those, or modify the openswan scripts to not use these tools. You can snag openswan packages from <a href="http://www.linuxops.net/ipkg/">http://www.linuxops.net/ipkg/</a> which have this problem solved (albeit have some others).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p2302">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">bitkocher</div>
					<div class="post-datetime">
						28 Sep 2004, 13:31					</div>
				</div>
				<div class="post-content content">
					<p>Are there any known problems regarding reading connection entries from /etc/ipsec.conf ?<br /></p><div class="codebox"><pre><code>Sep 28 12:13:38 193.17.17.98  pluto[4462]: Starting Pluto (Openswan Version 2.2.0 X.509-1.5.4 PLUTO_USES_KEYRR)
Sep 28 12:13:38 193.17.17.98  pluto[4462]:   including NAT-Traversal patch (Version 0.6c) [disabled]
Sep 28 12:13:38 193.17.17.98  pluto[4462]: ike_alg_register_enc(): Activating OAKLEY_AES_CBC: Ok (ret=0)
Sep 28 12:13:38 193.17.17.98  pluto[4462]: Changing to directory &#039;/etc/ipsec.d/cacerts&#039;
Sep 28 12:13:38 193.17.17.98  pluto[4462]:   loaded CA cert file &#039;cacert.pem&#039; (1302 bytes)
Sep 28 12:13:38 193.17.17.98  pluto[4462]: Changing to directory &#039;/etc/ipsec.d/aacerts&#039;
Sep 28 12:13:38 193.17.17.98  pluto[4462]: Changing to directory &#039;/etc/ipsec.d/ocspcerts&#039;
Sep 28 12:13:38 193.17.17.98  pluto[4462]: Changing to directory &#039;/etc/ipsec.d/crls&#039;
Sep 28 12:13:38 193.17.17.98  pluto[4462]:   loaded crl file &#039;crl.wlan.pem&#039; (524 bytes)
Sep 28 12:13:43 193.17.17.98  pluto[4462]: listening for IKE messages
Sep 28 12:13:43 193.17.17.98  pluto[4462]: adding interface ipsec0/vlan1 193.17.17.98
Sep 28 12:13:43 193.17.17.98  pluto[4462]: adding interface ipsec1/br0 192.168.1.1
Sep 28 12:13:43 193.17.17.98  pluto[4462]: loading secrets from &quot;/etc/ipsec.secrets&quot;
Sep 28 12:13:43 193.17.17.98  pluto[4462]:   loaded private key file &#039;/etc/ipsec.d/private/wrt54gs-0001-key.pem&#039; (963 bytes)</code></pre></div><p>That looks good, but connection defined in /etc/ipsec.conf is missing. Passphrase in /etc/ipsec.secret matches privat key file. Problem is, somewhere messages like that should appear:<br /></p><div class="codebox"><pre><code>Sep 28 12:19:24 cf-eth-gw pluto[13875]:   loaded host cert file &#039;/etc/ipsec.d/certs/cf-eth-gw-cert-0001.pe
m&#039; (1957 bytes)
Sep 28 12:19:24 cf-eth-gw pluto[13875]:   loaded host cert file &#039;/etc/ipsec.d/certs/labpc02-cert.pem&#039; (195
7 bytes)
Sep 28 12:19:24 cf-eth-gw pluto[13875]: added connection description &quot;labpc02&quot;</code></pre></div><p>Output above is taken from log of a running OpenSwan installation on x86 PC.</p><p>ipsec auto --up labpc02 fails with message 021 no connection named &quot;labpc02&quot;<br />Same config file works on x86 OpenSwan PC. Connection definition of wrt54gs:<br /></p><div class="codebox"><pre><code>version 2.0

config setup
        # Debug-logging controls:  &quot;none&quot; for (almost) none, &quot;all&quot; for lots.
        # klipsdebug=none
        # plutodebug=&quot;control parsing&quot;
        uniqueids=no
        interfaces=&quot;ipsec0=vlan1 ipsec1=br0&quot;
        klipsdebug=none
        plutodebug=none

conn labpc02
        type=tunnel
        keyingtries=0
        authby=rsasig
        auto=start
        # Left security gateway, subnet behind it, next hop toward right.
        left=193.17.17.98
        leftsubnet=192.168.1.0/24
        leftrsasigkey=%cert
        leftid=&quot;/C=de/...&quot;
        leftcert=/etc/ipsec.d/certs/wrt54gs-0001-cert.pem
        # Right security gateway, subnet behind it, next hop toward left.
        right=193.17.17.99
        rightsubnet=192.168.254.0/24
        rightrsasigkey=%cert
        rightid=&quot;/C=de/....&quot;
        rightcert=/etc/ipsec.d/certs/labpc02-cert.pem</code></pre></div><p>Do you have a working example, which is known to be running on OpenWRT ?</p><p>Christian</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p2304">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">PolarWolf</div>
					<div class="post-datetime">
						28 Sep 2004, 19:23					</div>
				</div>
				<div class="post-content content">
					<p>The config as you posted looks ok to me.</p><p>I do have a working config, except it&#039;s on a router which is switched off, at about 2000km north from here :-)&nbsp; I have yet to flash my WRT54GS with OpenWRT to set up the VPN connection again.</p><p>At any rate, I created openswan 2.2.0 packages, which you can find at <a href="http://www.linuxops.net/ipkg/">http://www.linuxops.net/ipkg/</a></p><p>Due to the fact that I don&#039;t have openwrt handy at this time, I haven&#039;t been able to test them. They&#039;re built against an older release of openwrt, but I don&#039;t really expect any problems arising from that. If so, let me know, and I&#039;ll recreate them using a more recent buildroot. Some bugs will still be in these packages as I haven&#039;t really looked any deeper into things yet. Ergo, /var/lock, /var/lock/subsys and /var/run still need to exist, some scripts might have problems with being run under ash, and dirname and friends are still being relied on here and there.</p><p>On a brighter note, the dependency on `tr` and `id` have been removed. Keep an eye out for new packages as I might be able to put in some work to fix various issues soon.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p2316">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">bitkocher</div>
					<div class="post-datetime">
						29 Sep 2004, 11:29					</div>
				</div>
				<div class="post-content content">
					<p>I updated to your new pkgs, but same result: Connection definitions in /etc/ipsec.conf are not loaded.<br />Some tests with strongawk on WRT54G ran into same results. Debugging of some ipsec scripts showed different behaviour of mawk and gawk.<br />Now I created my first two ipkg packages:<br />GNU awk and strongswan.<br />GNU AWK is a big file (500 KByte) named gawk, which is running on WRT54GS now. That solved the problem but creates a new problem: mawk is smaller (175k) than GNU awk, so two solutions needs to be considered:</p><p>Ignore that and change requirements for OpenSwan from WRT54G to WRT54GS. People who are using WRT54G will hate us, but easiest way for us ;-)</p><p>Rewrite all awk scripts in /usr/lib/ipsec so they will run on mawk or - better - on internal busybox awk.</p><p>My works yielded into a port of StrongSwan, which support more encryption methonds than OpenSwan. Minus of StronSwan is a quite bigger footprint. I am not sure if it makes sense to maintain StronSwan for OpenWRT. Any other opinions ?</p><p>Strongswan is a 1MB+ package, that is ok for WRT54GS, but not for WRT54G.</p><p>Well, following output looks much better:</p><div class="codebox"><pre><code>root@OpenWrt:/etc# ipsec auto --statusall
000 interface ipsec1/vlan0 192.168.1.1
000 interface ipsec0/vlan1 193.17.17.98
000 %myid = (none)
000 debug none
000
000 &quot;sample&quot;: 192.168.1.0/24===193.17.17.98...193.17.17.97[@cf-eth-gw]===192.168.0.0/24; unrouted; erouteowner: #0
000 &quot;sample&quot;:   ike_life: 3600s; ipsec_life: 28800s; rekey_margin: 540s; rekey_fuzz: 100%; keyingtries: 0
000 &quot;sample&quot;:   policy: RSASIG+ENCRYPT+TUNNEL+PFS; prio: 24,24; interface: vlan1;
000 &quot;sample&quot;:   newest ISAKMP SA: #0; newest IPsec SA: #0;
000 &quot;sample&quot;:   IKE algorithms wanted: 5_000-1-5, 5_000-1-2, 5_000-2-5, 5_000-2-2,
000 &quot;sample&quot;:   IKE algorithms found:  5_192-1_128-5, 5_192-1_128-2, 5_192-2_160-5, 5_192-2_160-2,
000 &quot;sample&quot;:   ESP algorithms wanted: 3_000-1, 3_000-2,
000 &quot;sample&quot;:   ESP algorithms loaded: 3_168-1_128, 3_168-2_160,
000
000</code></pre></div><p>and it is fully operational:</p><div class="codebox"><pre><code>root@OpenWrt:~# ipsec auto --up sample
104 &quot;sample&quot; #1: STATE_MAIN_I1: initiate
003 &quot;sample&quot; #1: ignoring Vendor ID payload [strongSwan 2.2.1]
003 &quot;sample&quot; #1: received Vendor ID payload [Dead Peer Detection]
106 &quot;sample&quot; #1: STATE_MAIN_I2: sent MI2, expecting MR2
108 &quot;sample&quot; #1: STATE_MAIN_I3: sent MI3, expecting MR3
004 &quot;sample&quot; #1: STATE_MAIN_I4: ISAKMP SA established
112 &quot;sample&quot; #2: STATE_QUICK_I1: initiate
004 &quot;sample&quot; #2: STATE_QUICK_I2: sent QI2, IPsec SA established {ESP=&gt;0xd8e23d87 &lt;0xea2cbb46}</code></pre></div><p>To-Do:<br />Either modifying OpenSwan scripts to run with (m)awk or install gawk and replace /usr/bin/awk-&gt;/rom... to /usr/bin/awk-&gt;/usr/bin/gawk.<br />Some more testing on OpenSwan/StrongSwan on WRT54G(S)</p><p>Some questions to community:</p><p>Is anybody interested in ipkg packages of:<br />- gawk<br />- StrongSwan<br />?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p2361">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">bitkocher</div>
					<div class="post-datetime">
						1 Oct 2004, 12:23					</div>
				</div>
				<div class="post-content content">
					<p>Following bugs in OpenSwan package are discovered:</p><p><strong>Critical:</strong><br />OpenSwan cannot setup connections without gawk. Prerequisite mawk is not valid. It should be replaced by gawk.<br /></p><div class="codebox"><pre><code>cd /usr/bin
rm awk
ln -s gawk awk</code></pre></div><p>after installation of gawk makes OpenSwan 2.2.0 operational.</p><p><strong>Not critical</strong><br />/usr/libexec/ipsec is a dead softlink. It should be relinked to /etc/init.d/S50ipsec</p><p><strong>Interoperabiliy issues</strong><br />If Quagga is installed, Quagga detects ipsec&lt;x&gt; interfaces. That means dynamic routing may break if OpenSwan uses interfaces, which are required by Quagga. Unfortunally that is true for most cases :-( This problem is not specific to OpenWRT, it is a general problem with kernel 2.4.x. That problem no longer exists with kernel 2.6.x ipsec implementation.</p><p>An analysis of Quaggas behaviour enables a workaround. Quagga loads interfaces in alphabetical order, so iproute2 package will help us :-)<br /></p><div class="codebox"><pre><code>ifconfig vlan1 down
ip link set vlan1 name a_wan
ifconfig a_wan up
ip route add default via &lt;your default route&gt; dev a_wan</code></pre></div><p>This must be done <strong>before</strong> OpenSwan is started</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p2363">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">PolarWolf</div>
					<div class="post-datetime">
						1 Oct 2004, 12:37					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><blockquote><p>Following bugs in OpenSwan package are discovered:</p><p><strong>Critical:</strong><br />OpenSwan cannot setup connections without gawk. Prerequisite mawk is not valid. It should be replaced by gawk.<br /></p><div class="codebox"><pre><code>cd /usr/bin
rm awk
ln -s gawk awk</code></pre></div><p><br />after installation of gawk makes OpenSwan 2.2.0 operational.</p></blockquote></div><p></p><p>Actually, now you mentioned awk...you&#039;re aware that the package you installed mawk with didn&#039;t replace the symlink either, right? This might explain your problems with it (and also explain why noone else seems to have them). This is a bug in the mawk package, btw.</p><p>On a side note, I indeed have an intention of trying to translate all the mawk dependant stuff so that the internal awk can handle it. I hope it&#039;s possible, saves a few bytes.</p></blockquote></div><p><br /><strong>Not critical</strong><br />/usr/libexec/ipsec is a dead softlink. It should be relinked to /etc/init.d/S50ipsec</p></blockquote></div><p></p><p>I&#039;ll look into it.</p><div class="quotebox"><blockquote><p><strong>Interoperabiliy issues</strong><br />If Quagga is installed, Quagga detects ipsec&lt;x&gt; interfaces. That means dynamic routing may break if OpenSwan uses interfaces, which are required by Quagga. Unfortunally that is true for most cases :-( This problem is not specific to OpenWRT, it is a general problem with kernel 2.4.x. That problem no longer exists with kernel 2.6.x ipsec implementation.</p></blockquote></div><p></p><p>I&#039;ve been using quagga in concert with {free,open}swan on 2.4 kernels for ages. In fact, I depend on it. Your interoperability issue is at best a configuration issue on the quagga end of things.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>