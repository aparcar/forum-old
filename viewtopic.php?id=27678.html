<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> WR1043ND - AP and STA problem (linked to eduroam)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 5 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p123005">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">sovvy</div>
					<div class="post-datetime">
						10 Dec 2010, 19:39					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>I currently have a TL-WR1043ND, flashed with backfire 10.03.1 rc4. What I&#039;m attempting to do is create a sustained connection to my universities eduroam wireless network (as connection to the internet), and also transmit an AP for my wireless clients to connect to - fairly straightforward. However, I&#039;m having difficulties.</p><p>Previously, I did this with a WRT54GL using wpa_supplicant; unfortunately, I could only use the 2.6 kernel and thus could not have a connection to eduroam and have the router transmit as an AP because of wireless driver issues, but I was able to connect using near-enough the instructions here: <a href="http://blog.jozjan.net/2008/12/wrt54gl-as-8021x-client-aka.html">http://blog.jozjan.net/2008/12/wrt54gl- â€¦ t-aka.html</a> </p><p>From what I gather, I can do what I had to do seperately with wpa_supplicant within /etc/config/wireless; I attempted to do this, and according to iwconfig I have established a connection, but ifconfig reports that I don&#039;t have an IP address, and I can&#039;t seem to use &quot;udhcpc -i wlan1&quot; (wlan1 being the sta connection) to gain one from the universities dhcp. All it says is &#039;Sending discover...&#039; three times. </p><p>I don&#039;t quite know what I&#039;m doing wrong here, any suggestions?</p><p>Thanks for your help!</p>											<p class="post-edited">(Last edited by <strong>sovvy</strong> on 10 Dec 2010, 19:41)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123024">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						11 Dec 2010, 03:39					</div>
				</div>
				<div class="post-content content">
					<p>Follow &quot;<a href="https://forum.openwrt.org/viewtopic.php?id=27631">OpenWrt/ tplink 841 nd routed client help</a>&quot; to create a routed client. Then add an additional ap to the wireless configuration.</p><p>For WRT54GL, you should install brcm-2.4 firmware.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123035">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">sovvy</div>
					<div class="post-datetime">
						11 Dec 2010, 11:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>fyi wrote:</cite><blockquote><p>Follow &quot;<a href="https://forum.openwrt.org/viewtopic.php?id=27631">OpenWrt/ tplink 841 nd routed client help</a>&quot; to create a routed client. Then add an additional ap to the wireless configuration.</p><p>For WRT54GL, you should install brcm-2.4 firmware.</p></blockquote></div><p>Hey - cheers for that. That worked pretty much fine up until creating a new ap; without it, I was assigned an IP straight away after using &#039;wifi up&#039; on wlan0 for my sta connection. however, once I add the ap to the config, the sta is assigned to wlan1 and all i get is &#039;udhcpc: bind: no such device&#039; (not sure what that is referring to) and &#039;sending discover&#039;. I can see in iwconfig that the connection is stable, but I just can&#039;t get an assigned IP.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123036">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">sovvy</div>
					<div class="post-datetime">
						11 Dec 2010, 11:26					</div>
				</div>
				<div class="post-content content">
					<p>On that note - I think I&#039;ve recognised the problem (possibly). To access my universities wifi, I have to have my mac address registered. I registered the mac address of the wireless device for my router, but for wlan1, its changed slightly - unfortunately, trying to edit it to match the new mac results in failure as it &#039;isn&#039;t recognised&#039;. Any ideas? :S</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123093">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">sovvy</div>
					<div class="post-datetime">
						12 Dec 2010, 12:49					</div>
				</div>
				<div class="post-content content">
					<p>This is a strange problem - and I do think it may have something to do with mac address assignments, but I can&#039;t seem to adequately change it. Macchanger will do it, but I still have the problem with udhcpc basically timing out. For now, I may just have to use my 54GL as the AP.</p>											<p class="post-edited">(Last edited by <strong>sovvy</strong> on 12 Dec 2010, 12:50)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123129">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						13 Dec 2010, 03:27					</div>
				</div>
				<div class="post-content content">
					<p>Please provide the /etc/config/wireless and /etc/config/network.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123150">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">sovvy</div>
					<div class="post-datetime">
						13 Dec 2010, 11:44					</div>
				</div>
				<div class="post-content content">
					<p>Sure thing.</p><p>/etc/config/wireless:</p><br /><p>config &#039;wifi-device&#039; &#039;radio0&#039;<br />&nbsp; &nbsp; option &#039;type&#039; &#039;mac80211&#039;<br />&nbsp; &nbsp; option &#039;macaddr&#039; &#039;94:0c:6d:##:##:##&#039;<br />&nbsp; &nbsp; list &#039;ht_capab&#039; &#039;SHORT-GI-40&#039;<br />&nbsp; &nbsp; list &#039;ht_capab&#039; &#039;DSSS_CCK-40&#039;<br />&nbsp; &nbsp; option &#039;disabled&#039; &#039;0&#039;<br />&nbsp; &nbsp; option &#039;channel&#039; &#039;6&#039;<br />&nbsp; &nbsp; option &#039;txpower&#039; &#039;27&#039;<br />&nbsp; &nbsp; option &#039;hwmode&#039; &#039;11ng&#039;<br />&nbsp; &nbsp; option &#039;htmode&#039; &#039;HT20&#039;</p><p>config &#039;wifi-iface&#039;<br />&nbsp; &nbsp; option &#039;device&#039; &#039;radio0&#039;<br />&nbsp; &nbsp; option &#039;network&#039; &#039;wan&#039;<br />&nbsp; &nbsp; option &#039;mode&#039; &#039;sta&#039;<br />&nbsp; &nbsp; option &#039;ssid&#039; &#039;eduroam&#039;<br />&nbsp; &nbsp; option &#039;encryption&#039; &#039;wpa+tkip+ccmp&#039;<br />&nbsp; &nbsp; option &#039;eap_type&#039; &#039;peap&#039;<br />&nbsp; &nbsp; option &#039;auth&#039; &#039;MSCHAPV2&#039;<br />&nbsp; &nbsp; option &#039;identity&#039; &#039;**@**.**&#039;<br />&nbsp; &nbsp; option &#039;password&#039; &#039;*******&#039;</p><p>config &#039;wifi-iface&#039;<br />&nbsp; &nbsp; option &#039;device&#039; &#039;radio0&#039;<br />&nbsp; &nbsp; option &#039;network&#039; &#039;lan&#039;<br />&nbsp; &nbsp; option &#039;mode&#039; &#039;ap&#039;<br />&nbsp; &nbsp; option &#039;ssid&#039; &#039;OpenWrt&#039;<br />&nbsp; &nbsp; option &#039;encryption&#039; &#039;mixed-psk+tkip+ccmp&#039;<br />&nbsp; &nbsp; option &#039;key&#039; &#039;*****&#039;</p><p>---</p><p>/etc/config/network:</p><br /><p>config &#039;interface&#039; &#039;loopback&#039;<br />&nbsp; &nbsp; option &#039;ifname&#039; &#039;lo&#039;<br />&nbsp; &nbsp; option &#039;proto&#039; &#039;static&#039;<br />&nbsp; &nbsp; option &#039;ipaddr&#039; &#039;127.0.0.1&#039;<br />&nbsp; &nbsp; option &#039;netmask&#039; &#039;255.0.0.0&#039;</p><p>config &#039;interface&#039; &#039;lan&#039;<br />&nbsp; &nbsp; option &#039;ifname&#039; &#039;eth0.1&#039;<br />&nbsp; &nbsp; option &#039;type&#039; &#039;bridge&#039;<br />&nbsp; &nbsp; option &#039;proto&#039; &#039;static&#039;<br />&nbsp; &nbsp; option &#039;ipaddr&#039; &#039;192.168.1.1&#039;<br />&nbsp; &nbsp; option &#039;netmask&#039; &#039;255.255.255.0&#039;</p><p>config &#039;interface&#039; &#039;wan&#039;<br />&nbsp; &nbsp; option &#039;proto&#039; &#039;dhcp&#039;<br />&nbsp; &nbsp; option &#039;defaultroute&#039; &#039;0&#039;<br />&nbsp; &nbsp; option &#039;peerdns&#039; &#039;0&#039;</p><p>config &#039;switch&#039;<br />&nbsp; &nbsp; option &#039;name&#039; &#039;rtl8366rb&#039;<br />&nbsp; &nbsp; option &#039;reset&#039; &#039;1&#039;<br />&nbsp; &nbsp; option &#039;enable_vlan&#039; &#039;1&#039;</p><p>config &#039;switch_vlan&#039;<br />&nbsp; &nbsp; option &#039;device&#039; &#039;rtl8366rb&#039;<br />&nbsp; &nbsp; option &#039;vlan&#039; &#039;1&#039;<br />&nbsp; &nbsp; option &#039;ports&#039; &#039;1 2 3 4 5t&#039;</p><p>config &#039;switch_vlan&#039;<br />&nbsp; &nbsp; option &#039;device&#039; &#039;rtl8366rb&#039;<br />&nbsp; &nbsp; option &#039;vlan&#039; &#039;2&#039;<br />&nbsp; &nbsp; option &#039;ports&#039; &#039;0 5t&#039;</p><br /><p>---</p><p>Hope it helps!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123153">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						13 Dec 2010, 12:54					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>sovvy wrote:</cite><blockquote><p>On that note - I think I&#039;ve recognised the problem (possibly). To access my universities wifi, I have to have my mac address registered.</p></blockquote></div><p>What do you mean and which mac address did you register? If the sta is assigned to wlan1, you should have it registered, not wlan0.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123154">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">sovvy</div>
					<div class="post-datetime">
						13 Dec 2010, 13:00					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>fyi wrote:</cite><blockquote><div class="quotebox"><cite>sovvy wrote:</cite><blockquote><p>On that note - I think I&#039;ve recognised the problem (possibly). To access my universities wifi, I have to have my mac address registered.</p></blockquote></div><p>What do you mean and which mac address did you register? If the sta is assigned to wlan1, you should have it registered, not wlan0.</p></blockquote></div><p>To gain access to my university internet, you have to register all mac addresses used; I originally registered wlan0 when I was just using the router as a station, but I can&#039;t register wlan1 with my university as the stupid online form my university provides to register mac&#039;s says that the mac address &#039;isnt recognised&#039; - I&#039;m assuming because the first part identifies the manufacturer, and that is the section that changes - 9A:0C:6D:xx:xx:xx instead of the original 94:0C:6D:xx:xx:xx. I can&#039;t seem to change it properly, either - macchanger will change it but it doesn&#039;t have any effect. I can authenticate with the eduroam AP regardless, but I just don&#039;t get assigned an IP because of the mac issue I think.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123163">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">KillaB</div>
					<div class="post-datetime">
						13 Dec 2010, 15:42					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>sovvy wrote:</cite><blockquote><p>I originally registered wlan0 when I was just using the router as a station</p></blockquote></div><p>From the above statement, it sounds like things were working when you only had one wlan interface? Is the MAC still correct on wlan0? and is wlan1 the only interface with an &quot;improper&quot; address?<br />I don&#039;t run multiple wlan interfaces at the moment, but if the above is true, I&#039;m guessing that your AP is coming up before your STA interface and therefore assigning wlan0 to your AP. I&#039;m not sure of any way to force an wlan0 to your STA config, but maybe someone else here has an answer.</p><p>Please keep in mind that the MAC listed under radio0 cannot be changed from what is found by the &quot;wifi detect&quot; script. It is required for communication to the switch.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123164">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">coreyo</div>
					<div class="post-datetime">
						13 Dec 2010, 16:18					</div>
				</div>
				<div class="post-content content">
					<p>Hi Sovvy,<br />&nbsp; &nbsp; I have the same model that I use as my sandbox.&nbsp; If you troll further down the forum you&#039;ll see that I have a similar post.&nbsp; The problem that I had was due to the fact that the &#039;auto&#039; channel feature has not yet been implemented for this radio&#039;s kernel module.&nbsp; In my post, I also linked to a developer&#039;s confirmation of this.&nbsp; The option is there, but it doesn&#039;t work.&nbsp; In order for this to work, you&#039;ll need to configure the main radio setup and specify the same channel as the access point to which you are trying to connect.&nbsp; Then, create a virtual interface on that radio in master &quot;AP&quot; mode and set it up to your specifications.&nbsp; Both interfaces will have to run on that same channel, FYI.&nbsp; Not he most efficient way, but it will get the job done.&nbsp; Hope this helps.&nbsp; Here&#039;s a link to the post:</p><p><a href="https://forum.openwrt.org/viewtopic.php?id=27019">https://forum.openwrt.org/viewtopic.php?id=27019</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123226">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">sovvy</div>
					<div class="post-datetime">
						14 Dec 2010, 11:01					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>KillaB wrote:</cite><blockquote><div class="quotebox"><cite>sovvy wrote:</cite><blockquote><p>I originally registered wlan0 when I was just using the router as a station</p></blockquote></div><p>From the above statement, it sounds like things were working when you only had one wlan interface? Is the MAC still correct on wlan0? and is wlan1 the only interface with an &quot;improper&quot; address?<br />I don&#039;t run multiple wlan interfaces at the moment, but if the above is true, I&#039;m guessing that your AP is coming up before your STA interface and therefore assigning wlan0 to your AP. I&#039;m not sure of any way to force an wlan0 to your STA config, but maybe someone else here has an answer.</p><p>Please keep in mind that the MAC listed under radio0 cannot be changed from what is found by the &quot;wifi detect&quot; script. It is required for communication to the switch.</p></blockquote></div><p>The MAC is still correct on wlan0, its just wlan1 that is the issue. Forcing the AP to come up after STA would be the answer, like you said, but I don&#039;t have a clue how to do it (or if its possible!). I did try to set the wan macaddr in /etc/config/network, which did work to change it in ifconfig, but did not solve my problem. </p><div class="quotebox"><cite>coreyo wrote:</cite><blockquote><p>Hi Sovvy,<br />&nbsp; &nbsp; I have the same model that I use as my sandbox.&nbsp; If you troll further down the forum you&#039;ll see that I have a similar post.&nbsp; The problem that I had was due to the fact that the &#039;auto&#039; channel feature has not yet been implemented for this radio&#039;s kernel module.&nbsp; In my post, I also linked to a developer&#039;s confirmation of this.&nbsp; The option is there, but it doesn&#039;t work.&nbsp; In order for this to work, you&#039;ll need to configure the main radio setup and specify the same channel as the access point to which you are trying to connect.&nbsp; Then, create a virtual interface on that radio in master &quot;AP&quot; mode and set it up to your specifications.&nbsp; Both interfaces will have to run on that same channel, FYI.&nbsp; Not he most efficient way, but it will get the job done.&nbsp; Hope this helps.&nbsp; Here&#039;s a link to the post:</p><p><a href="https://forum.openwrt.org/viewtopic.php?id=27019">https://forum.openwrt.org/viewtopic.php?id=27019</a></p></blockquote></div><p>Cheers for this, but I&#039;m not sure if its too applicable to my situation; I&#039;ve statically set my wifi radio channel to match the channel of the eduroam network i&#039;m trying to connect to; the connection does authenticate, I just can&#039;t get a dhcp lease. Thanks though!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123234">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">KillaB</div>
					<div class="post-datetime">
						14 Dec 2010, 14:42					</div>
				</div>
				<div class="post-content content">
					<p>In /etc/config/wireless, you currently have STA defined before AP.<br />Try reversing the order similar to coreyo&#039;s example.</p><p>I&#039;m not saying it&#039;s going to work, but it&#039;s worth a shot.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123236">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">sovvy</div>
					<div class="post-datetime">
						14 Dec 2010, 15:15					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>KillaB wrote:</cite><blockquote><p>In /etc/config/wireless, you currently have STA defined before AP.<br />Try reversing the order similar to coreyo&#039;s example.</p><p>I&#039;m not saying it&#039;s going to work, but it&#039;s worth a shot.</p></blockquote></div><p>Sadly, I moved them around before and it didn&#039;t chang eanything. We&#039;re on the same wavelength though, <img src="https://forum.openwrt.org/img/smilies/tongue.png" width="15" height="15" alt="tongue" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123300">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						15 Dec 2010, 18:03					</div>
				</div>
				<div class="post-content content">
					<p>Read &quot;enable_mac80211()&quot; in &quot;/lib/wifi/mac80211.sh&quot;. Maybe you&#039;ll find out how to let sta come up before ap.</p><p>In my Fonera+ running Kamikaze, sta always comes up before ap.</p><p><strong>/lib/wifi/madwifi.sh</strong>:<br /></p><div class="codebox"><pre><code>enable_atheros() {
    local device=&quot;$1&quot;

    config_get regdomain &quot;$device&quot; regdomain
    [ -n &quot;$regdomain&quot; ] &amp;&amp; echo &quot;$regdomain&quot; &gt; /proc/sys/dev/$device/regdomain

    config_get country &quot;$device&quot; country
    [ -z &quot;$country&quot; ] &amp;&amp; country=&quot;0&quot;
    echo &quot;$country&quot; &gt; /proc/sys/dev/$device/countrycode

    config_get_bool outdoor &quot;$device&quot; outdoor &quot;0&quot;
    echo &quot;$outdoor&quot; &gt; /proc/sys/dev/$device/outdoor

    config_get channel &quot;$device&quot; channel
    config_get vifs &quot;$device&quot; vifs
    config_get txpower &quot;$device&quot; txpower

    [ auto = &quot;$channel&quot; ] &amp;&amp; channel=0

    config_get_bool antdiv &quot;$device&quot; diversity
    config_get antrx &quot;$device&quot; rxantenna
    config_get anttx &quot;$device&quot; txantenna
    config_get_bool softled &quot;$device&quot; softled 1

    devname=&quot;$(cat /proc/sys/dev/$device/dev_name)&quot;
    local antgpio=
    local invert=
    case &quot;$devname&quot; in
        NanoStation2) antgpio=7; invert=1;;
        NanoStation5) antgpio=1; invert=1;;
        &quot;NanoStation Loco2&quot;) antgpio=2;;
    esac
    if [ -n &quot;$invert&quot; ]; then
        _set=&quot;clear&quot;
        _clear=&quot;set&quot;
    else
        _set=&quot;set&quot;
        _clear=&quot;clear&quot;
    fi
    if [ -n &quot;$antgpio&quot; ]; then
        softled=0
        config_get antenna &quot;$device&quot; antenna
        case &quot;$antenna&quot; in
            external) antdiv=0; antrx=1; anttx=1 ;;
            horizontal) antdiv=0; antrx=1; anttx=1 ;;
            vertical) antdiv=0; antrx=2; anttx=2 ;;
            auto) antdiv=1; antrx=0; anttx=0 ;;
        esac
            
        [ -x &quot;$(which gpioctl 2&gt;/dev/null)&quot; ] || antenna=
        gpioctl &quot;dirout&quot; &quot;$antgpio&quot; &gt;/dev/null 2&gt;&amp;1
        case &quot;$antenna&quot; in
            horizontal|vertical|auto)
                gpioctl &quot;$_clear&quot; &quot;$antgpio&quot; &gt;/dev/null 2&gt;&amp;1
            ;;
            external)
                gpioctl &quot;$_set&quot; &quot;$antgpio&quot; &gt;/dev/null 2&gt;&amp;1
            ;;
        esac
    fi

    [ -n &quot;$antdiv&quot; ] &amp;&amp; sysctl -w dev.&quot;$device&quot;.diversity=&quot;$antdiv&quot; &gt;&amp;-
    [ -n &quot;$antrx&quot; ] &amp;&amp; sysctl -w dev.&quot;$device&quot;.rxantenna=&quot;$antrx&quot; &gt;&amp;-
    [ -n &quot;$anttx&quot; ] &amp;&amp; sysctl -w dev.&quot;$device&quot;.txantenna=&quot;$anttx&quot; &gt;&amp;-
    [ -n &quot;$softled&quot; ] &amp;&amp; sysctl -w dev.&quot;$device&quot;.softled=&quot;$softled&quot; &gt;&amp;-

    config_get distance &quot;$device&quot; distance
    [ -n &quot;$distance&quot; ] &amp;&amp; sysctl -w dev.&quot;$device&quot;.distance=&quot;$distance&quot; &gt;&amp;-

    for vif in $vifs; do
        local start_hostapd= vif_txpower= nosbeacon=
        config_get ifname &quot;$vif&quot; ifname
        config_get enc &quot;$vif&quot; encryption
        config_get eap_type &quot;$vif&quot; eap_type
        config_get mode &quot;$vif&quot; mode
        
        case &quot;$mode&quot; in
            sta) config_get_bool nosbeacon &quot;$device&quot; nosbeacon;;
            adhoc) config_get_bool nosbeacon &quot;$vif&quot; sw_merge 1;;
        esac
        
        [ &quot;$nosbeacon&quot; = 1 ] || nosbeacon=&quot;&quot;
        ifname=$(wlanconfig &quot;$ifname&quot; create wlandev &quot;$device&quot; wlanmode &quot;$mode&quot; ${nosbeacon:+nosbeacon})
        [ $? -ne 0 ] &amp;&amp; {
            echo &quot;enable_atheros($device): Failed to set up $mode vif $ifname&quot; &gt;&amp;2
            continue
        }
        config_set &quot;$vif&quot; ifname &quot;$ifname&quot;

        config_get hwmode &quot;$device&quot; hwmode
        [ -z &quot;$hwmode&quot; ] &amp;&amp; config_get hwmode &quot;$device&quot; mode

        pureg=0
        case &quot;$hwmode&quot; in
            *b) hwmode=11b;;
            *bg) hwmode=11g;;
            *g) hwmode=11g; pureg=1;;
            *gdt) hwmode=11gdt;;
            *a) hwmode=11a;;
            *adt) hwmode=11adt;;
            *ast) hwmode=11ast;;
            *fh) hwmode=fh;;
            *) hwmode=auto;;
        esac
        iwpriv &quot;$ifname&quot; mode &quot;$hwmode&quot;
        iwpriv &quot;$ifname&quot; pureg &quot;$pureg&quot;

        iwconfig &quot;$ifname&quot; channel &quot;$channel&quot; &gt;/dev/null 2&gt;/dev/null 

        config_get_bool hidden &quot;$vif&quot; hidden 0
        iwpriv &quot;$ifname&quot; hide_ssid &quot;$hidden&quot;

        config_get ff &quot;$vif&quot; ff
        if [ -n &quot;$ff&quot; ]; then
            iwpriv &quot;$ifname&quot; ff &quot;$ff&quot;
        fi

        config_get wds &quot;$vif&quot; wds
        case &quot;$wds&quot; in
            1|on|enabled) wds=1;;
            *) wds=0;;
        esac
        iwpriv &quot;$ifname&quot; wds &quot;$wds&quot; &gt;/dev/null 2&gt;&amp;1

        [ &quot;$mode&quot; = ap -a &quot;$wds&quot; = 1 ] &amp;&amp; {
            config_get_bool wdssep &quot;$vif&quot; wdssep 1
            [ -n &quot;$wdssep&quot; ] &amp;&amp; iwpriv &quot;$ifname&quot; wdssep &quot;$wdssep&quot;
        }

        case &quot;$enc&quot; in
            WEP|wep)
                for idx in 1 2 3 4; do
                    config_get key &quot;$vif&quot; &quot;key${idx}&quot;
                    iwconfig &quot;$ifname&quot; enc &quot;[$idx]&quot; &quot;${key:-off}&quot;
                done
                config_get key &quot;$vif&quot; key
                key=&quot;${key:-1}&quot;
                case &quot;$key&quot; in
                    [1234]) iwconfig &quot;$ifname&quot; enc &quot;[$key]&quot;;;
                    *) iwconfig &quot;$ifname&quot; enc &quot;$key&quot;;;
                esac
            ;;
            psk*|wpa*)
                start_hostapd=1
                config_get key &quot;$vif&quot; key
            ;;
        esac

        case &quot;$mode&quot; in
            sta|adhoc|ahdemo)
                config_get addr &quot;$vif&quot; bssid
                [ -z &quot;$addr&quot; ] || { 
                    iwconfig &quot;$ifname&quot; ap &quot;$addr&quot;
                }
            ;;
        esac

        config_get_bool uapsd &quot;$vif&quot; uapsd 0
        iwpriv &quot;$ifname&quot; uapsd &quot;$uapsd&quot;

        config_get_bool bgscan &quot;$vif&quot; bgscan
        [ -n &quot;$bgscan&quot; ] &amp;&amp; iwpriv &quot;$ifname&quot; bgscan &quot;$bgscan&quot;

        config_get rate &quot;$vif&quot; rate
        [ -n &quot;$rate&quot; ] &amp;&amp; iwconfig &quot;$ifname&quot; rate &quot;${rate%%.*}&quot;

        config_get mcast_rate &quot;$vif&quot; mcast_rate
        [ -n &quot;$mcast_rate&quot; ] &amp;&amp; iwpriv &quot;$ifname&quot; mcast_rate &quot;${mcast_rate%%.*}&quot;

        config_get frag &quot;$vif&quot; frag
        [ -n &quot;$frag&quot; ] &amp;&amp; iwconfig &quot;$ifname&quot; frag &quot;${frag%%.*}&quot;

        config_get rts &quot;$vif&quot; rts
        [ -n &quot;$rts&quot; ] &amp;&amp; iwconfig &quot;$ifname&quot; rts &quot;${rts%%.*}&quot;

        config_get_bool comp &quot;$vif&quot; compression 0
        iwpriv &quot;$ifname&quot; compression &quot;$comp&quot; &gt;/dev/null 2&gt;&amp;1

        config_get_bool minrate &quot;$vif&quot; minrate
        [ -n &quot;$minrate&quot; ] &amp;&amp; iwpriv &quot;$ifname&quot; minrate &quot;$minrate&quot;

        config_get_bool maxrate &quot;$vif&quot; maxrate
        [ -n &quot;$maxrate&quot; ] &amp;&amp; iwpriv &quot;$ifname&quot; maxrate &quot;$maxrate&quot;

        config_get_bool burst &quot;$vif&quot; bursting
        [ -n &quot;$burst&quot; ] &amp;&amp; iwpriv &quot;$ifname&quot; burst &quot;$burst&quot;

        config_get_bool wmm &quot;$vif&quot; wmm
        [ -n &quot;$wmm&quot; ] &amp;&amp; iwpriv &quot;$ifname&quot; wmm &quot;$wmm&quot;

        config_get_bool xr &quot;$vif&quot; xr
        [ -n &quot;$xr&quot; ] &amp;&amp; iwpriv &quot;$ifname&quot; xr &quot;$xr&quot;

        config_get_bool ar &quot;$vif&quot; ar
        [ -n &quot;$ar&quot; ] &amp;&amp; iwpriv &quot;$ifname&quot; ar &quot;$ar&quot;

        config_get_bool beacon_power &quot;$vif&quot; beacon_power
        [ -n &quot;$beacon_power&quot; ] &amp;&amp; iwpriv &quot;$ifname&quot; beacon_pwr &quot;$beacon_power&quot;

        config_get_bool doth &quot;$vif&quot; doth 0
        [ -n &quot;$doth&quot; ] &amp;&amp; iwpriv &quot;$ifname&quot; doth &quot;$doth&quot;

        config_get_bool probereq &quot;$vif&quot; probereq
        [ -n &quot;$probereq&quot; ] &amp;&amp; iwpriv &quot;$ifname&quot; probereq &quot;$probereq&quot;

        config_get maclist &quot;$vif&quot; maclist
        [ -n &quot;$maclist&quot; ] &amp;&amp; {
            # flush MAC list
            iwpriv &quot;$ifname&quot; maccmd 3
            for mac in $maclist; do
                iwpriv &quot;$ifname&quot; addmac &quot;$mac&quot;
            done
        }

        config_get macpolicy &quot;$vif&quot; macpolicy
        case &quot;$macpolicy&quot; in
            allow)
                iwpriv &quot;$ifname&quot; maccmd 1
            ;;
            deny)
                iwpriv &quot;$ifname&quot; maccmd 2
            ;;
            *)
                # default deny policy if mac list exists
                [ -n &quot;$maclist&quot; ] &amp;&amp; iwpriv &quot;$ifname&quot; maccmd 2
            ;;
        esac

        ifconfig &quot;$ifname&quot; up

        local net_cfg bridge
        net_cfg=&quot;$(find_net_config &quot;$vif&quot;)&quot;
        [ -z &quot;$net_cfg&quot; ] || {
            bridge=&quot;$(bridge_interface &quot;$net_cfg&quot;)&quot;
            config_set &quot;$vif&quot; bridge &quot;$bridge&quot;
            start_net &quot;$ifname&quot; &quot;$net_cfg&quot;
        }

        config_get ssid &quot;$vif&quot; ssid
        [ -n &quot;$ssid&quot; ] &amp;&amp; {
            iwconfig &quot;$ifname&quot; essid on
            iwconfig &quot;$ifname&quot; essid &quot;$ssid&quot;
        }

        set_wifi_up &quot;$vif&quot; &quot;$ifname&quot;

        # TXPower settings only work if device is up already
        # while atheros hardware theoretically is capable of per-vif (even per-packet) txpower
        # adjustment it does not work with the current atheros hal/madwifi driver

        config_get vif_txpower &quot;$vif&quot; txpower
        # use vif_txpower (from wifi-iface) instead of txpower (from wifi-device) if
        # the latter doesn&#039;t exist
        txpower=&quot;${txpower:-$vif_txpower}&quot;
        [ -z &quot;$txpower&quot; ] || iwconfig &quot;$ifname&quot; txpower &quot;${txpower%%.*}&quot;

        case &quot;$mode&quot; in
            ap)
                config_get_bool isolate &quot;$vif&quot; isolate 0
                iwpriv &quot;$ifname&quot; ap_bridge &quot;$((isolate^1))&quot;

                if [ -n &quot;$start_hostapd&quot; ] &amp;&amp; eval &quot;type hostapd_setup_vif&quot; 2&gt;/dev/null &gt;/dev/null; then
                    hostapd_setup_vif &quot;$vif&quot; madwifi || {
                        echo &quot;enable_atheros($device): Failed to set up hostapd for interface $ifname&quot; &gt;&amp;2
                        # make sure this wifi interface won&#039;t accidentally stay open without encryption
                        ifconfig &quot;$ifname&quot; down
                        wlanconfig &quot;$ifname&quot; destroy
                        continue
                    }
                fi
            ;;
            wds|sta)
                if eval &quot;type wpa_supplicant_setup_vif&quot; 2&gt;/dev/null &gt;/dev/null; then
                    wpa_supplicant_setup_vif &quot;$vif&quot; madwifi || {
                        echo &quot;enable_atheros($device): Failed to set up wpa_supplicant for interface $ifname&quot; &gt;&amp;2
                        ifconfig &quot;$ifname&quot; down
                        wlanconfig &quot;$ifname&quot; destroy
                        continue
                    }
                fi
            ;;
        esac
    done
}</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123314">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">sovvy</div>
					<div class="post-datetime">
						15 Dec 2010, 20:56					</div>
				</div>
				<div class="post-content content">
					<p>Damn! It actually works!</p><p>I had a poke around /lib/wifi/mac80211.sh, changed &#039;local mac_2&#039; and while it didnt have quite the right effect (I simply typed in the mac it should have had; I didn&#039;t have the time or patience to try and get my head around the code properly!) it does force wlan1 to have the &#039;proper&#039; mac and wlan0 gets a dodgily assigned mac instead. While a bit of a dodgy hack, it works! </p><p>I can now finally put my WRT54GL to other uses (there are PLENTY of public wifis in the neighbourhood..); although I do have a concern - 1 radio should manage both wireless ap and sta traffic fine without too much of a problem, shouldn&#039;t it? </p><p>Thanks fyi, and everyone else, you&#039;ve been a real help! Hopefully this&#039;ll help other people in the future.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123888">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						24 Dec 2010, 19:39					</div>
				</div>
				<div class="post-content content">
					<p><strong>/lib/wifi/mac80211.sh</strong>:<br /></p><div class="codebox"><pre><code>scan_mac80211() {
    config_set &quot;$device&quot; vifs &quot;${ap:+$ap }${adhoc:+$adhoc }${sta:+$sta }${monitor:+$monitor }${mesh:+$mesh}&quot;
}</code></pre></div><p><strong>/lib/wifi/madwifi.sh</strong>:<br /></p><div class="codebox"><pre><code>scan_atheros() {
    config_set &quot;$device&quot; vifs &quot;${sta:+$sta }${ap:+$ap }${adhoc:+$adhoc }${ahdemo:+$ahdemo }${wds:+$wds }${monitor:+$monitor}&quot;
}</code></pre></div><p>The option &quot;<strong>vifs</strong>&quot; controls the virtual interfaces being initialized. Change the sequence of &quot;<strong>${sta:+$sta }</strong>&quot; and &quot;<strong>${ap:+$ap }</strong>&quot; and you can change the mac addresses of the vifs. I think it&#039;s better to have sta initialized before ap.</p><p><a href="http://downloads.openwrt.org/snapshots/trunk/docs/openwrt.html#x1-120001.2.2">OpenWrt manual</a><br /></p><div class="quotebox"><blockquote><p><strong>Limitations</strong>: There are certain limitations when combining modes. Only the following mode combinations are supported:</p><p>&nbsp; &nbsp; * <strong>Broadcom</strong>:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o <strong>1x</strong> sta, <strong>0-3x</strong> ap<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o <strong>1-4x</strong> ap<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o <strong>1x</strong> adhoc<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o <strong>1x</strong> monitor</p><p>&nbsp; &nbsp; &nbsp; WDS links can only be used in pure AP mode and cannot use WEP (except when sharing the settings with the master interface, which is done automatically).<br />&nbsp; &nbsp; * <strong>Atheros</strong>:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o <strong>1x</strong> sta, <strong>0-Nx</strong> ap<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o <strong>1-Nx</strong> ap<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o <strong>1x</strong> adhoc</p><p>&nbsp; &nbsp; &nbsp; N is the maximum number of VAPs that the module allows, it defaults to 4, but can be changed by loading the module with the maxvaps=N parameter.</p></blockquote></div>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>