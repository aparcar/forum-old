<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Howto: Compiling source in buildroot</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 29 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p236">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">Blackvel</div>
					<div class="post-datetime">
						24 Apr 2004, 15:29					</div>
				</div>
				<div class="post-content content">
					<p>I need</p><p>- zebra<br />- iptables-p2p<br />- iproute2 (tc + htb3.6 patch)</p><p>to compile.</p><p>I&#039;m an absolut linux developer newbiew. Don&#039;t expect from me, that I understand a Makefile or the ipkg-build script very well.<br />So for the moment, even reading thru all informations I have, I get no clue, how to achieve what I want.<br />I&#039;m sure you can point me out some principles I can follow.</p><p>1.0 Common<br />What would I have to change in source&#039;s Makefile (maybe there is not only one Makefile, but more Makefiles in different directories when multiple binaries and also multiple .so files have to be created).</p><p>How can I point the progs Makefile to uclibc-gcc (crosscompile for WRT) ?<br />Do I have to change anything ?<br />If they refer already ${GCC}, will it work without any change ?</p><p>1. Zebra<br />I want to compile that in buildroot, so my thought was, just to copy some already existing .mk file and creating a zebra.mk.</p><p>I changed the names, path&#039;s, binary targets, etc.</p><p>How can I pass the zebra configure script some options like --enable-multipath and also disabling RIP, OSPFv3, etc. ?<br />Do I have to create my own .config file and also how can I pass this to zebra configure script ?</p><p>2. Iproute2<br />There is a tc in ./build_mipsel/WRT54GS/release/src/linux/linux/drivers/tc<br />. How to exlude this from openwrt-code.bin ?</p><p>How to include iproute2 (htb3.6 patched) tc ?<br />I would have to change the Makefiles in iproute2 , that only tc get&#039;s compiled ?<br />I finally have sources for iproute2 and htb3.6 patch.</p><p>3. iptables-p2p<br />There is no binary for IPTABLES-P2P_BINARY, IPTABLES-P2P_BINARY_TARGET which I could change buildroot/make/iptables-p2p.mk to, because there are only created some .so files.<br />One libipt_p2p.so for /usr/lib/iptables and one ipt_p2p.o for /lib/kernel/2.4.20.<br />They get created by make process from different directories with multiple Makefiles.</p><p>Do I have to care for my iptables-p2p.mk to these or is this just straightforward like compiling normal programs ?</p><p>Thanx for your tips.<br />There is really a lack (also for that ipkg-build script which I don&#039;t understand also) on informations how to go on, once you have openwrt running <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Feel free just to quote my text and add very short help.</p><p>I really hope you can help me&nbsp; <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" />&nbsp; <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" />&nbsp; <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" />&nbsp; <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" />&nbsp; <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" />&nbsp; <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" />&nbsp; <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> </p><p>Blackvel</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p249">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Blackvel</div>
					<div class="post-datetime">
						28 Apr 2004, 20:41					</div>
				</div>
				<div class="post-content content">
					<p>So far a compile for latest quagga and also iproute2 worked after problems 4 days long.<br />I still have some problems getting them fully to run, but hey, I&#039;m one step further.<br />It&#039;s very surprisingly for me, that really noone did give me any feedback on this too advanced topics for me(I guess basic topics for a linux guru).</p><p>These are the real problems for people, so they probably don&#039;t think ever on using OpenWRT.<br />If you as a group can not write simple enough Compiling Howto&#039;s or even reply on such basic questions, then please don&#039;t expect that there will be many people focusing on such products.<br />What helps a running OpenWRT on WRT (my congratulations to the very simple buildroot make process btw), when you can&#039;t get programs compiled for it/on it.</p><p>The feature of package installations help here not much, when most packages are not available yet <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />The slogan &quot;Newbies do not have to apply&quot; seems to come here very true even when you (not really a newbie) got openWRT running very fine.</p><p>Why do you people make that lots of work for coding that wonderful firmware when people probably have to refuse working with it, just because of problems like I had ? <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Anyway I have to say, the support which I got on IRC channel #wrt54g on irc.freenode.net so far is really overwhelming, also mostly short questions is the key.<br />I want to thank you all (you know who you are!) for the support and help and ideas. Also for your patience.<br />I know, it&#039;s all the complicated stuff that I have to get working all time <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Comming back to my own solutions....<br /></p><div class="quotebox"><blockquote><p>1.0 Common<br />What would I have to change in source&#039;s Makefile (maybe there is not only one Makefile, but more Makefiles in different directories when multiple binaries and also multiple .so files have to be created).</p><p>How can I point the progs Makefile to uclibc-gcc (crosscompile for WRT) ?<br />Do I have to change anything ?<br />If they refer already ${GCC}, will it work without any change ?</p></blockquote></div><p>One way which works quite good, is to call make &lt;target&gt; in buildroot directly. So make in fact make calls normal Makefile, which also sets some stuff for crosscompile (e.g TARGET_CC, TARGET_CROSS, STRIP, TARGET_CONFIGURE_OPTS for PATH to AR, AS, LD, NM, CC, GCC, RANLIB).<br />The Makefile does include make/*.mk, so if you have created a quagga.mk, it will be included.</p><div class="quotebox"><blockquote><p>1. Zebra<br />I want to compile that in buildroot, so my thought was, just to copy some already existing .mk file and creating a zebra.mk.</p><p>I changed the names, path&#039;s, binary targets, etc.</p><p>How can I pass the zebra configure script some options like --enable-multipath and also disabling RIP, OSPFv3, etc. ?<br />Do I have to create my own .config file and also how can I pass this to zebra configure script ?</p></blockquote></div><p>I left out zebra 0.94 and instead of switched to quagga zebra fork now.<br />If there is any bugfix, then it is in quagga instead of zebra.<br />Configuration (configure, make, also zebra.conf, ospfd.conf) is the same as in zebra.</p><p>Normally calling from buildroot directory make quagga probably works.<br />Just make sure, you have set in quagga.mk all GCC, LD, RANLIB, STRIP stuff. If you haven&#039;t, compile will probably abort with very weird errors,<br />e.g wrong index on xxx.a (which is wrong ranlib used) or any other stuff<br />which is an indicator that Makefiles from quagga (there is more than one in each directory!) is directly refering CC=gcc, LD=ld, STRIP=strip etc.</p><p>For quagga this was no problem. If you are compiling iproute2 you would have to deleted from iproute2/Makefile line CC=gcc and edit iproute2/lib/Makefile and change some line with ar xxxxx .... to $(AR).</p><p>Here is my quagga.mk from buildroot/make:</p><div class="codebox"><pre><code>#############################################################
#
# Quagga 0.96.4
#
#############################################################

QUAGGA_SOURCE=quagga-0.96.4.tar.gz
QUAGGA_SITE=ftp://ftp.quagga.net/download
QUAGGA_DIR=$(BUILD_DIR)/packages/quagga-0.96.4
QUAGGA_BINARY=zebra
QUAGGA_BINARY2=ospfd
QUAGGA_TARGET_BINARY=usr/sbin/zebra
QUAGGA_TARGET_BINARY2=usr/sbin/ospfd

$(DL_DIR)/$(QUAGGA_SOURCE):
    $(WGET) -P $(DL_DIR) $(QUAGGA_SITE)/$(QUAGGA_SOURCE)

$(QUAGGA_DIR)/.source: $(DL_DIR)/$(QUAGGA_SOURCE)
    zcat $(DL_DIR)/$(QUAGGA_SOURCE) | tar -C $(BUILD_DIR)/packages -xvf -
    $(SOURCE_DIR)/patch-kernel.sh $(QUAGGA_DIR) $(SOURCE_DIR) quagga-*.patch
    touch $(QUAGGA_DIR)/.source

$(QUAGGA_DIR)/.configured: $(QUAGGA_DIR)/.source
    (cd $(QUAGGA_DIR); rm -rf config.cache; 
        $(TARGET_CONFIGURE_OPTS) 
        ./configure 
        --host=mipsel-unknown-linux-gnu 
        --bindir=/usr/bin --sbindir=/usr/sbin --libexecdir=/usr/lib 
        --datadir=/usr/share --sysconfdir=/etc --libdir=/usr/lib 
        --disable-ipv6 --disable-bgpd --disable-ripd 
        --disable-ripngd --disable-ospf6d --disable-bgp-announce 
        --disable-ospfapi --disable-ospfclient --disable-ospf-te 
        --disable-rtadv --disable-vtysh --disable-snmp --disable-nssa 
        --disable-opaque-lsa 
        --enable-multipath=0 
        --enable-user=root --enable-group=root 
    );
    touch $(QUAGGA_DIR)/.configured

$(QUAGGA_DIR)/$(QUAGGA_BINARY): $(QUAGGA_DIR)/.configured
    $(MAKE) CC=$(TARGET_CC) CFLAGS=&quot;$(TARGET_CFLAGS)&quot; 
        AR=$(TARGET_CROSS)ar AS=$(TARGET_CROSS)as LD=$(TARGET_CROSS)ld 
        NM=$(TARGET_CROSS)nm RANLIB=$(TARGET_CROSS)ranlib 
        CPP=$(TARGET_CROSS)cpp STRIP=$(TARGET_CROSS)strip 
        BINDIR=/usr/sbin MANDIR=/usr/man -C $(QUAGGA_DIR)

$(TARGET_DIR)/$(QUAGGA_TARGET_BINARY): $(QUAGGA_DIR)/$(QUAGGA_BINARY)
    $(MAKE) BINDIR=/usr/sbin MANDIR=/usr/man 
        DESTDIR=$(TARGET_DIR) -C $(QUAGGA_DIR) install
    $(STRIP) $(TARGET_DIR)/$(QUAGGA_TARGET_BINARY)
    $(STRIP) $(TARGET_DIR)/$(QUAGGA_TARGET_BINARY2)
    rm -Rf $(TARGET_DIR)/usr/man

quagga: uclibc $(TARGET_DIR)/$(QUAGGA_TARGET_BINARY)

quagga-source: $(DL_DIR)/$(QUAGGA_SOURCE)

quagga-clean:
    #$(MAKE) prefix=$(TARGET_DIR)/usr -C $(QUAGGA_DIR) uninstall
    -$(MAKE) -C $(QUAGGA_DIR) clean

quagga-dirclean:
    rm -rf $(QUAGGA_DIR)</code></pre></div><p>Important notes:<br />1. You have to call configure for quagga. As you can see I already call configure will all crosscompiler references like GCC, LD.<br />This is very sweet, since all quagga Makefiles have then the right references.<br />2. Note, there exists a problem cd $(QUAGGA_DIR) and configure.<br />To get calling configure from quagga.mk working, you have exactly to follow this:<br />(cd $(QUAGGA_DIR); $(TARGET_CONFIGURE_OPTS) ./configure --options );<br />If you don&#039;t use (cd; configure ); the configure command won&#039;t be found.<br />If you choose to use instead of $(QUAGGA_DIR)/configure all Makefiles won&#039;t be created in $(QUAGGA_DIR) but instead of in buildroot !!!!<br />3. Don&#039;t forget to strip the compiled binaries zebra and ospfd in my case.<br />I forgot to add $(STRIP) $(TARGET_DIR)/usr/sbin/ospfd and so the file was 2,3MB! Thanx to coder for this tip!</p><p>4. Don&#039;t forget that also zebra.conf.sample and ospfd.conf.sample will be copied to buildroot/build_mipsel/root/etc <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>5. It took me more than 1 day to find out, how to get configure working with crosscompile.<br />You really have to set --host for crosscompile, otherwise quagga/zebra won&#039;t let you pass GCC, LD, RANLIB crosscompiler stuff.<br />It actively complains about this then!</p><p>On my redhat 9 system I had quite big problems, passing not all crosscompiler options to configure, so configure was actually trying to compile one file on my system, and this wasn&#039;t working.</p><p>Also it took me about 1-2 days to find out, what host type I have to pass in.<br />I tried with --host=mipsel.<br />Wonder if this had worked in any kind! NO!</p><p>The damn configure script then thought I was compile for a FreeBSD system so it included rt_socket.c instead of linux netlink, so it was complaining all the time for unknown constants like RTM_ADD, RTM_DELETE which just are not in zebra, but seem to be in kernel header files for FreeBSD.</p><p>As I found out, that there is in zebra directory a config.sub which can find you the right hostname according to INSTALL (first of course I just looked in the file directly , but I had no chance to find out the logic; yes, damn newbies, they think complex even it can be done easily!).</p><p>[root@agelinux quagga-0.96.4]# ./config.sub mipsel<br />mipsel-unknown-elf<br />[root@agelinux quagga-0.96.4]# ./config.sub mipsel-linux<br /><strong>mipsel-unknown-linux-gnu</strong><br />[root@agelinux quagga-0.96.4]#</p><p>So mipsel-linux found me the right mipsel-unknown-linux-gnu crosscompiler.</p><div class="quotebox"><blockquote><p>2. Iproute2<br />There is a tc in ./build_mipsel/WRT54GS/release/src/linux/linux/drivers/tc<br />. How to exlude this from openwrt-code.bin ?</p></blockquote></div><p>I have not done this yet.<br />iproute2.mk creates tc in buildroot/build_mipsel/root/usr/sbin. Just copy tc from that directory to your WRT.</p><div class="quotebox"><blockquote><p>How to include iproute2 (htb3.6 patched) tc ?<br />I would have to change the Makefiles in iproute2 , that only tc get&#039;s compiled ?<br />I finally have sources for iproute2 and htb3.6 patch.</p></blockquote></div><p>Probably by adding the target in buildroot/Makefile or was it buildroot/Makefile-OpenWRT ? <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />Just comment out this line :<br />#TARGETS+=iproute2 <br />Then at least iproute2 will be compiled when a normal make for openwrt is running.<br />I guess this does not already include it into openwrt-code.bin.</p><p>Don&#039;t forget for iproute2 to change the Makefiles (especially lib/Makefile) to poing to all crosscompiler stuff, e.g ar.<br />So it should be not ar, but instead of $(AR).</p><p>Here is my iproute2.mk, there where several bugs in.</p><div class="codebox"><pre><code>################################################
# iproute2
#
###############################################

IPROUTE2_DIR=$(BUILD_DIR)/packages/iproute2
LINUX_DIR=/home/blackvel/buildroot/build_mipsel/linux

IPROUTE2_SOURCE_URL=ftp://ftp.inr.ac.ru/ip-routing/
IPROUTE2_SOURCE=iproute2-2.4.7-now-ss010824.tar.gz

#Use the debian source for now, as the .ru site has availability problems
#IPROUTE2_SOURCE_URL=http://ftp.debian.org/debian/pool/main/i/iproute/
#IPROUTE2_SOURCE=iproute_20010824.orig.tar.gz
#IPROUTE2_PATCH=iproute_20010824-13.diff.gz
IPROUTE2_PATCH=htb3.6_tc.patch

$(DL_DIR)/$(IPROUTE2_SOURCE):
     $(WGET) -P $(DL_DIR) $(IPROUTE2_SOURCE_URL)$(IPROUTE2_SOURCE)

iproute2-source: $(DL_DIR)/$(IPROUTE2_SOURCE) #$(DL_DIR)/$(IPROUTE2_PATCH)

$(IPROUTE2_DIR)/.unpacked: $(DL_DIR)/$(IPROUTE2_SOURCE) #$(DL_DIR)/$(IPROUTE2_PATCH)
    rm -rf $(IPROUTE2_DIR).orig $(IPROUTE2_DIR)
    zcat $(DL_DIR)/$(IPROUTE2_SOURCE) | tar -C $(BUILD_DIR)/packages -xvf -
    #zcat $(DL_DIR)/$(IPROUTE2_PATCH) | patch -p1 -d $(IPROUTE2_DIR)
    touch $(IPROUTE2_DIR)/.unpacked

$(IPROUTE2_DIR)/.patched : $(IPROUTE2_DIR)/.unpacked
    $(SOURCE_DIR)/patch-kernel.sh $(IPROUTE2_DIR) $(SOURCE_DIR) $(IPROUTE2_PATCH)
    touch $(IPROUTE2_DIR)/.patched

$(IPROUTE2_DIR)/.configured: $(IPROUTE2_DIR)/.patched
    $(SED) &quot;s,-I/usr/include/db3,,&quot; $(IPROUTE2_DIR)/Makefile
    $(SED) &quot;s,^KERNEL_INCLUDE.*,KERNEL_INCLUDE=$(LINUX_DIR)/include,&quot; 
        $(IPROUTE2_DIR)/Makefile
    $(SED) &quot;s,^LIBC_INCLUDE.*,LIBC_INCLUDE=$(STAGING_DIR)/include,&quot; 
        $(IPROUTE2_DIR)/Makefile
    # For now disable compiling of the misc directory because it seems to fail
    rm -rf $(IPROUTE2_DIR)/misc 
    $(SED) &quot;s, misc,,&quot; $(IPROUTE2_DIR)/Makefile

    # set configured mode
    touch $(IPROUTE2_DIR)/.configured
    # end of configured mode

$(IPROUTE2_DIR)/tc/tc: $(IPROUTE2_DIR)/.configured
    # Entering make of tc
    $(MAKE) CC=$(TARGET_CC) 
        AR=$(TARGET_CROSS)ar AS=$(TARGET_CROSS)as LD=$(TARGET_CROSS)ld 
        NM=$(TARGET_CROSS)nm RANLIB=$(TARGET_CROSS)ranlib 
        CPP=$(TARGET_CROSS)cpp STRIP=$(TARGET_CROSS)strip 
        KERNEL_INCLUDE=$(LINUX_DIR)/include -C $(IPROUTE2_DIR)

$(TARGET_DIR)/usr/sbin/tc: $(IPROUTE2_DIR)/tc/tc
        # Copy The tc binary
    cp -af $(IPROUTE2_DIR)/tc/tc $(TARGET_DIR)/usr/sbin/
    $(STRIP) $(TARGET_DIR)/usr/sbin/tc

iproute2: $(TARGET_DIR)/usr/sbin/tc 

iproute2-clean:
    $(MAKE) -C $(IPROUTE2_DIR) clean

iproute2-dirclean:
    rm -rf $(IPROUTE2_DIR)</code></pre></div><p>Note: for iproute2-clean there is no uninstall target in iproute2 package, only clean!<br />This Makefile does not only build tc, but also all other iproute2 stuff.<br />in buildroot/build_mipsel/iproute2/Makefile there is no special tc target yet!</p><p>Be sure to have a clean iproute2.mk, this means, do not use normal spaces in vi before commands like $(MAKE) in target $(IPROUTE2_DIR)/tc/tc: .<br />I had this problem (tab use is very okay!) and my make just didn&#039;t run.</p><div class="quotebox"><blockquote><p>3. iptables-p2p<br />There is no binary for IPTABLES-P2P_BINARY, IPTABLES-P2P_BINARY_TARGET which I could change buildroot/make/iptables-p2p.mk to, because there are only created some .so files.<br />One libipt_p2p.so for /usr/lib/iptables and one ipt_p2p.o for /lib/kernel/2.4.20.<br />They get created by make process from different directories with multiple Makefiles.</p><p>Do I have to care for my iptables-p2p.mk to these or is this just straightforward like compiling normal programs ?</p></blockquote></div><p>Haven&#039;t compiled iptables-p2p yet.</p><p>But from my 4 days experience now, the TARGET and BINARY_TARGET are just an identifier for the makefile with what target part should be started or what part has to come before that special part.</p><p>So I would suggest to point the TARGET1 and TARGET2 binaries to libipt_p2p.so and ipt_p2p.o with the correct path directions to buildroot/build_mipsel/packages/iptables-p2p/xxxxx.</p><p>Then you can modify the TARGET_BINARY target to copy the files to $(TARGET_DIR) and the appropriate directories which are /usr/lib/iptables and /lib/kernel/2.4.20.</p><p>Before this make sure, Makefiles are not using any ar, strip, ranlib stuff directly. Replace in Makefiles by $(AR), $(STRIP), $(RANLIB), etc.</p><p>Don&#039;t worry for the multiple pathes in iptables-p2p, so multiple files from multiple directories have to be created.<br />iptables-p2p/Makefile handles this automatically by calling $(MAKE) -c &lt;directories&gt;.<br />This was also quite good working for quagga <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>For all package.mk files the slogan is :<br />Copy the file first into buildroot/sources/dl <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Hope this helps the other people with that advanced openwrt topics <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />To create a package with ipkg-build, having all the binaries already compiled, shouldn&#039;t be a problem anymore really.</p><p>Feel free to ask if you have any problems.</p><p>Blackvel</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p252">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">Blackvel</div>
					<div class="post-datetime">
						28 Apr 2004, 23:17					</div>
				</div>
				<div class="post-content content">
					<p>one additional tip for Makefile hacking of program sources.</p><p>Instead of doing this all on yourself, you can also use in e.g iproute2.mk:</p><p>$(SED) &quot;s, ar rcs,$(TARGET_CROSS)ar rcs&quot; $(IPROUTE2_DIR)/lib/Makefile</p><p>This replaces (more substitutes) by SED the &quot;ar rcs&quot; by &quot;/home/user/buildroot/build_mipsel/staging_dir/bin/mipsel-linux-uclibc-ar rcs&quot; in /home/user/buildroot/build_mipsel/packages/iproute2/lib/Makefile (in my case, maybe just build_mipsel/iproute2.... in your case).</p><p>With this you can replace in a very easy way Makefiles which are hardcoded to gcc, ar, ranlib crosscompiling stuff.</p><p>Not always a GCC=xxx environment passing helps for a configure or make process <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>Keep prepared.</p><p>Blackvel</p><p>BTW: Thanx to lwiddif for this great tip!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p271">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">Blackvel</div>
					<div class="post-datetime">
						30 Apr 2004, 00:39					</div>
				</div>
				<div class="post-content content">
					<p>Have got iptables-p2p compiled finally.</p><p>If you also plan this, you mostly want to change the makefiles in iptables-p2p/iptables/Makefile and iptables-p2p/kernel/Makefile directly.</p><p>Biggest problems I had where KERNEL_INCLUDES in kernel/Makefile.</p><p>iptables/Makefile:<br /></p><div class="codebox"><pre><code>SOURCES = 
    libipt_p2p.c

OBJECTS = 
    $(SOURCES:%.c=%.o)

TARGET = 
    libipt_p2p.so

###############################################################################

# We don&#039;t really require gcc, I&#039;m just being lazy
CC=/home/blackvel/buildroot/build_mipsel/staging_dir/bin/mipsel-linux-uclibc-gcc

# I can&#039;t believe we have to do this...a better way, please!
SED=/home/blackvel/buildroot/build_mipsel/staging_dir/bin/sed -i -e
BUILD_DIR=/home/blackvel/buildroot/build_mipsel
IPTABLES_VERSION=iptables-1.2.9
CFLAGS=-O2 -Wall
CPPFLAGS = 
    -DIPTABLES_VERSION=&quot;$(IPTABLES_VERSION)&quot; -I../common -I$(BUILD_DIR)/$(IPTABLES_VERSION)/include

###############################################################################

all: $(TARGET)

$(TARGET): $(OBJECTS)
    $(LD) -shared -o $@ $(OBJECTS)

clean:
    $(RM) $(OBJECTS)
    $(RM) $(TARGET)</code></pre></div><p>Yes I know, it&#039;s not yet that all sweet. Feel free to make it better <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> At least it works.</p><p>I had to add for CPPFLAGS the second include, otherwise it couldn&#039;t find my&nbsp; headers.<br />Also I figgled with setting BUILD_ROOT, probably some cool env variable can be passed by iptables-p2p.mk to Makefiles.</p><p>kernel/Makefile:</p><div class="codebox"><pre><code>###############################################################################

SOURCES = 
    main.c 
    match_bittorrent.c 
    match_dc.c 
    match_edonkey.c 
    match_http.c

OBJECTS = 
    $(SOURCES:%.c=%.o)

TARGET_24 = ipt_p2p.o
TARGET_26 = ipt_p2p.ko

###############################################################################

CFLAGS=-O3 
KERNELDIR=/home/blackvel/buildroot/build_mipsel/WRT54GS/release/src/linux/linux
KERNELINC = 
    $(KERNELDIR)/include

# This is not pretty. How can we do this better?
ifdef P2P_COMMON
    INCLUDES+=-I$(P2P_COMMON)
endif

PWD = 
    $(shell pwd)

COMMON = 
    $(PWD)/../common

INCLUDES += 
    -I$(COMMON) 
    -I$(KERNELINC) 
    -I$(KERNELINC)/asm/mach-default

CPPFLAGS += 
    -D__KERNEL__ -DMODULE $(INCLUDES)

###############################################################################
# Common Stuff
###############################################################################

all: linux-2.4


.PHONY: clean

clean:
    $(RM) $(OBJECTS)
    $(RM) $(TARGET_24)
    $(RM) $(TARGET_26)
    $(RM) .*.o.cmd
    $(RM) .*.ko.cmd
    $(RM) ipt_p2p.mod.*


###############################################################################
# Linux 2.4 Stuff
###############################################################################

linux-2.4: $(TARGET_24)

$(TARGET_24): $(OBJECTS)
    $(LD) -r -o $@ $(OBJECTS)

###############################################################################
# Linux 2.6 Stuff
###############################################################################

obj-m := ipt_p2p.o
ipt_p2p-objs := $(OBJECTS)

linux-2.6: $(TARGET_26)

$(TARGET_26):
    $(MAKE) -C $(KERNELDIR) SUBDIRS=$(PWD) P2P_COMMON=$(COMMON) modules</code></pre></div><p>I changed specially KERNELDIR.<br />Make sure ld and rm are set to ${LD}, ${RM}.<br />If you are a profi, then pass KERNEL_DIR from iptables-p2p.mk or use the right SED commands.<br />After playing a while with SED, I give up.<br />I don&#039;t personally need 100% perfect solutions, but more fast ones <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>make/iptables-p2p.mk:<br /></p><div class="codebox"><pre><code>#############################################################
#
# iptables-p2p module for P2P Traffic
#
#############################################################

IPTABLES_P2P_SOURCE=iptables-p2p-0.3.0a.tar.gz
IPTABLES_P2P_SITE=http://sourceforge.net/
IPTABLES_P2P_DIR=$(BUILD_DIR)/packages/iptables-p2p-0.3.0a
IPTABLES_P2P_BINARY1=iptables/libipt_p2p.so
IPTABLES_P2P_TARGET_BINARY1=usr/lib/iptables/libipt_p2p.so
IPTABLES_P2P_BINARY2=kernel/ipt_p2p.o
IPTABLES_P2P_TARGET_BINARY2=lib/modules/2.4.20/ipt_p2p.o

$(DL_DIR)/$(IPTABLES_P2P_SOURCE):
    $(WGET) -P $(DL_DIR) $(IPTABLES_P2P_SITE)/$(IPTABLES_P2P_SOURCE)

$(IPTABLES_P2P_DIR)/.source: $(DL_DIR)/$(IPTABLES_P2P_SOURCE)
    zcat $(DL_DIR)/$(IPTABLES_P2P_SOURCE) | tar -C $(BUILD_DIR)/packages -xvf -
    #$(SOURCE_DIR)/patch-kernel.sh $(IPTABLES_P2P_DIR) $(SOURCE_DIR) iptables-p2p-*.patch
    touch $(IPTABLES_P2P_DIR)/.source

$(IPTABLES_P2P_DIR)/$(IPTABLES_P2P_BINARY1): $(IPTABLES_P2P_DIR)/.source
    $(SED) &quot;s,CC=cc,CC=$(CC),&quot; $(IPTABLES_P2P_DIR)/iptables/Makefile
    $(SED) &quot;s,SED=sed,SED=$(SED),&quot; $(IPTABLES_P2P_DIR)/iptables/Makefile
    $(SED) &quot;s,CC=cc,CC=$(CC),&quot; $(IPTABLES_P2P_DIR)/kernel/Makefile
    $(SED) &quot;s,^KERNEL_DIR.*,KERNEL_DIR=$(LINUX_DIR),&quot; 
        $(IPTABLES_P2P_DIR)/kernel/Makefile
    $(MAKE) CC=$(TARGET_CC) CFLAGS=&quot;$(TARGET_CFLAGS)&quot; LD=$(TARGET_CROSS)ld RM=$(TARGET_CROSS)rm 
        BINDIR=/sbin/ MANDIR=/usr/man -C $(IPTABLES_P2P_DIR)

$(TARGET_DIR)/$(IPTABLES_P2P_TARGET_BINARY1): $(IPTABLES_P2P_DIR)/$(IPTABLES_P2P_BINARY1)
    cp -af $(IPTABLES_P2P_DIR)/$(IPTABLES_P2P_BINARY1) $(TARGET_DIR)/$(IPTABLES_P2P_TARGET_BINARY1)
    cp -af $(IPTABLES_P2P_DIR)/$(IPTABLES_P2P_BINARY2) $(TARGET_DIR)/$(IPTABLES_P2P_TARGET_BINARY2)
    $(STRIP) $(TARGET_DIR)/$(IPTABLES_P2P_TARGET_BINARY1)
    $(STRIP) $(TARGET_DIR)/$(IPTABLES_P2P_TARGET_BINARY2)
    rm -Rf $(TARGET_DIR)/usr/man

iptables-p2p: uclibc $(TARGET_DIR)/$(IPTABLES_P2P_TARGET_BINARY1)

iptables-p2p-source: $(DL_DIR)/$(IPTABLES_P2P_SOURCE)

iptables-p2p-clean:
    $(MAKE) -C $(IPTABLES_P2P_DIR) clean

iptables-p2p-dirclean:
    rm -rf $(IPTABLES_P2P_DIR)</code></pre></div><p>Note: This code aint perfect yet.<br />I don&#039;t like the approach of having a BINARY_1 target but also copying BINARY_2 file to TARGET_DIR.<br />But anyway it&#039;s a fast 80% working solution which compiles <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />Also all SED command&#039;s are not yet working since the original Makefiles use very weird setups like<br />CC = <br />&lt;TAB&gt;cc</p><p>As you can see I pass this line for compile :<br />$(MAKE) CC=$(TARGET_CC) CFLAGS=&quot;$(TARGET_CFLAGS)&quot; LD=$(TARGET_CROSS)ld RM=$(TARGET_CROSS</p><p>Without crosscompile ld and rm the Makefile runs into a problem.</p><p>You can also use the more common solution :<br />$(TARGET_CONFIGURE_OPTS)</p><p>See if it works also.</p><p>NOTE:<br />You will have to compile extension CONNMARK from iptables-1.2.9 to get p2p marking and qos class matching working.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p272">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">Blackvel</div>
					<div class="post-datetime">
						30 Apr 2004, 00:43					</div>
				</div>
				<div class="post-content content">
					<p>Just change in buildroot/build_mipsel/iptables-1.2.9/extensions/Makefile<br />PF_EXT_SLIB:=</p><p>I suggest to copy the whole line openwrt has created by openwrt-iptables-extension.patch (for the basic iptables libs).</p><p>This is, how the line looks to me right now:</p><p>PF_EXT_SLIB:=icmp iprange mark multiport standard state tcp udp DNAT LOG MARK MASQUERADE REDIRECT REJECT SNAT TCPMSS connlimit connmark conntrack length limit mac mark tcpmss tos CONNMARK DNAT TOS</p><p>You can rely on the first line where all unused extensions are listed.<br />If you plan to use iptables-p2p you need at least CONNMARK, connmark.</p><p>Don&#039;t forget to uncomment #PF_EXT_SLIB <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Jump to buildroot and enter &quot;make iproute2&quot;.</p><p>This will copy all new extensions as stripped to buildroot/root/usr/lib/iptables.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p317">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">Blackvel</div>
					<div class="post-datetime">
						3 May 2004, 22:02					</div>
				</div>
				<div class="post-content content">
					<p><strong>Important:</strong><br />If you plan to use ipkg, you should NOT let xxx.mk copy binary from build_mipsel/packages/xxx to $TARGET_DIR which is build_mipsel/root.</p><p>I got told 5 minutes ago by mbm, that this actually means the binary will be included in squash_fs, that is openwrt.bin.</p><p>I don&#039;t think that this is the plan for yourself with all stuff like quagga, tc, etc.</p><p>I only can think for this if you want to replace some files like tc (having tc htb patched).</p><p>Maybe a huge .bin file would be useful if you are configuring a OpenWRT router for your friend and you don&#039;t want to move all ipkg&#039;es manually on router (here also would help a ./setup.sh script!).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p1583">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">itwerx</div>
					<div class="post-datetime">
						16 Aug 2004, 23:30					</div>
				</div>
				<div class="post-content content">
					<p>I wish I&#039;d found this thread a week ago!&nbsp; <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />&nbsp; &nbsp;If you don&#039;t mind I&#039;m going to work through all of this (and make sure it works for me!&nbsp; <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> and then maybe re-post it as a step-by-step HOWTO (maybe on the WIKI).</p><br /><p>Thanks again!</p><p>- Michael</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p1704">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">Blackvel</div>
					<div class="post-datetime">
						21 Aug 2004, 19:52					</div>
				</div>
				<div class="post-content content">
					<p>Thank you for your input <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I&#039;m glad someone can make use of it. Therefore I wrote it for the OpenWRT newbies like I was <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Feel free to create a more user friendly, real WIKI from it.</p><p>Blackvel</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p2368">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">case</div>
					<div class="post-datetime">
						1 Oct 2004, 21:17					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><blockquote><p>If you don&#039;t mind I&#039;m going to work through all of this (and make sure it works for me!&nbsp; <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> and then maybe re-post it as a step-by-step HOWTO (maybe on the WIKI).</p></blockquote></div><p>And? Any results? I just joined because of blackvels good work. I would be very interested...</p><p>Anyway, Blackvel, more testers, more fun!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p2402">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">case</div>
					<div class="post-datetime">
						3 Oct 2004, 20:08					</div>
				</div>
				<div class="post-content content">
					<p>I have tested the makefiles and they all compile after:</p><p>1. Adding a directory named packages in build_mipsel (Why that actually?)</p><p>2. Changing download-url&#039;s and tarball-version-number, updating the software that way. I have compiled Quagga 0.9.5 without problems.</p><p>3. Making sure that make-variables like $(SED), $(AR) are set correctly. Otherwise the make-process will fail. An error is that you need to define $(SED) before using it. I have built iproute2 before iptables-p2p. $(SED) is not defined then. I suggest to define $(SED) in buildroot/Makefile. I still prefer a much more simple solution:</p><p>4. As I have suggested in <a href="http://openwrt.org/forum/viewtopic.php?t=430">http://openwrt.org/forum/viewtopic.php?t=430</a> I use a preconfigure target i.e. in each of the two *.mk-files to simply copy pre-edited makefiles to like iptables-1.2.9/kernel/Makefile.<br />So you can keep the pre-edited files in i.e. buildroot/sources/customize, make all targets clean and re-run make without the need to edit all the files that need to be changed again.</p><p>Anyway, at least it compiles. Now I still need to test...!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p2532">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">Blackvel</div>
					<div class="post-datetime">
						12 Oct 2004, 14:02					</div>
				</div>
				<div class="post-content content">
					<p>Yes, you are right.<br />Using this method has the biggest drawback, that you have to edit the Makefile after unpacking / configuring the sources from time to time.</p><p>A real SED/AWK crack can probably edit the openwrt .mk files so that all &quot;wrong stuff&quot; gets replaced in the programs Makefiles by SED automatically.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>