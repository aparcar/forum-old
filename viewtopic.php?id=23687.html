<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Modded DI-604 Ver.E3 ?</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 15 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p103326">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">geekgirl</div>
					<div class="post-datetime">
						20 Feb 2010, 05:30					</div>
				</div>
				<div class="post-content content">
					<p>I bought two of the D-Link DI-604 <strong>Ver.E3 REFURBISHED</strong> router about 5-6 years ago (for ~ $15USD each), 1 of which I&#039;m still using, and the other kept as a spare (both still fully functional) <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>I noticed there&#039;s no mention at all of the DI-604 Rev. E* on <a href="http://wiki.openwrt.org/oldwiki/unsupported">http://wiki.openwrt.org/oldwiki/unsupported</a><br />and thought of doing a little research (and later opening its guts to see what was refurbished)</p><p>Closest and most helpful matches were:</p><p>1. in the &quot;noMMU-based hardware&quot; table, brief details on &quot;DLINK DI-604 rev E&quot; at:<br /><a href="http://hri.sourceforge.net/hw/index.html">http://hri.sourceforge.net/hw/index.html</a><br />Mentions:<br /></p><div class="quotebox"><blockquote><p>OEM ID:GLWRT-CG0-B10<br />Marvell 88E6208 (ARM9 CPU at 133 MHz)<br />1M Flash (MX 29LV800BTC-90)<br />8M SDRAM<br />JTAG header<br /><strong>Serial header (UART?)</strong><br />ThreadX<br />Firmware in ARJ format</p></blockquote></div><p>(ThreadX-based firmware?)<br />and link to (#2) &quot;Jerome&#039;s details&quot;</p><p>2. Jerome&#039;s details, page titled &quot;Dlink DI-604 rev E internals&quot;: <a href="http://www.ljmsite.com/tech/DLink_DI-604/">http://www.ljmsite.com/tech/DLink_DI-604/</a><br />Same info as #1, except it adds a little more specific info, like the &quot;Altera EPM3032A&quot; PLD chip?<br />Jerome&#039;s page also contains a clear picture of the PCB: <a href="http://www.ljmsite.com/tech/DLink_DI-604/DI-604.jpg">http://www.ljmsite.com/tech/DLink_DI-604/DI-604.jpg</a></p><p>3. DI-604 Rev E1, E3 (non-refurbished) comparison:<br /><a href="http://www.dslreports.com/forum/remark,15693750">http://www.dslreports.com/forum/remark,15693750</a><br />Looks like main difference is 88E6208 is up to 133Mhz and 88E6218 is up to 150Mhz.</p><p>---</p><p><strong>I opened my REFURBISHED DI-604 Ver.E3 to compare, and found almost same PCB layout, except for a few (notable) differences:</strong></p><p><strong>Board Version: WL WRT CG4 B10 - Ver:V1.0 - with &quot;B11&quot; hand-written over it with black marker, since it was &quot;refurbished&quot;</strong> (instead of GLWRT-CG0-B10)</p><p><strong>Marvel 88E6218-LGO Chip</strong> (instead of the Marvell 88E6208)<br /><a href="http://www.datasheetarchive.com/pdf-datasheets/Datasheets-17/DSA-328306.pdf">http://www.datasheetarchive.com/pdf-dat … 328306.pdf</a><br />Brief description from the datasheet:<br /><strong>ARM9E CPU at up to 150 MHz (ARM9E CPU with DSP processor instruction extensions)</strong></p><p>RAM: ISSI IS42S32200B-6T<br /><a href="http://pdf1.alldatasheet.com/datasheet-pdf/view/107234/ISSI/IS42S32200B-6T.html">http://pdf1.alldatasheet.com/datasheet- … 0B-6T.html</a><br />Brief description from the datasheet:<br /><strong>512K Bits x 32 Bits x 4 Banks (64MB)<br />Clock frequency: 166, 143 MHz</strong></p><p>Unfortunately, however, same <strong>&quot;MX 29LV800BTC-90&quot; 1MB Flash (AMD/Macronix?)</strong> <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /><br /><a href="http://www.macronix.com/web/P_flash.nsf/bf3add4f68988391c825667100209fa5/ebaae9d6cdabf1c8482569d1001d6d07/$FILE/MX29LV800T-B,MX29LV800AT-AB-2.2.pdf">http://www.macronix.com/web/P_flash.nsf … AB-2.2.pdf</a><br /><a href="http://www.amd.com/us-en/assets/content_type/white_papers_and_tech_docs/21490.pdf">http://www.amd.com/us-en/assets/content … /21490.pdf</a></p><p>Original Router firmware version: 3.38<br /><strong>Latest Router firmware version: 3.53<br />Size: 917,504 bytes</strong></p><p>----</p><p>Found what looks like a replica of this board/router in in page 17 of the following pdf:</p><p>(Exploiting embedded systems)<br /><a href="http://www.blackhat.com/presentations/bh-europe-06/bh-eu-06-Jack.pdf">http://www.blackhat.com/presentations/b … 6-Jack.pdf</a></p><p>Only differences I think is the RAM chip (the one pictured has the original IC-Mart 8MB SDRAM) and the soldered JTAG interface/connector - connected to an ARM Multi-ICE / In-Circuit emulator (of course I don&#039;t own one myself).</p><p>Page 5 shows the older version of this board (GLWRT-CG0-B10, w/ Marvell 88E6208), but very similar to the one I have - which is on page 17 - and pinpoints the Serial/UART port location <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>Page 10 - The Marvell 88E6218:<br /></p><div class="quotebox"><blockquote><p>Processor is ARM9E based, running at 150Mhz, 7 switch ports, 1MB embedded memory, 16 GPIO ports, 1 UART. Supports both the ARM and THUMB instruction set.</p></blockquote></div><p>Page 22 - Firmware Reversing:<br /></p><div class="quotebox"><blockquote><p>The DI-604 firmware is compressed and check-summed to verify original firmware. Checksum routine is simple to find by reversing &quot;upload firmware&quot; code snippet. A small tool was written to patch firmware after modification - any hacked firmware may be uploaded.</p></blockquote></div><p>Personal Note: I believe the UPnP stack overflow vulnerability (mentioned on page 26) was fixed in latest firmware (3.53) from D-Link, I always have UPnP disabled anyway since reading a few years back about the widespread flaws in its implementations which could allow it to be used as a step-stone to bypass firewall filters <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>----</p><p>A somewhat related article on <strong>&quot;DLINK DI-604 rev A&quot;, though DIFFERENT rev/ver &amp; HW (ARM7TDMI based ADM5106 SoC)</strong>:<br /><a href="http://hri.sourceforge.net/di_604/">http://hri.sourceforge.net/di_604/</a><br />Has a small section at the bottom about reverse engineering the firmware:</p><p>Flash details (bootloader, initialisation and so on)<br /><a href="http://hri.sourceforge.net/di_604/flash_mem.html">http://hri.sourceforge.net/di_604/flash_mem.html</a><br />A bit old (Mar 2004), Flash image with firmaware version 2.10 flash.bin , but gives a general idea <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>from &quot;Procedure to restore original firmware&quot; page: <a href="http://hri.sourceforge.net/di_604/reflash.html">http://hri.sourceforge.net/di_604/reflash.html</a><br /></p><div class="quotebox"><blockquote><p>You don&#039;t have to worry about making a paper weight out of your DI-604 by flashing it with test firmware. It has a tiny flash program saved in the boot sector of the flash that cannot be overwritten. You can restore your flash by doing the following:</p><p>&nbsp; &nbsp;1. Get firmware from DLINK website (of course, duh!)<br />&nbsp; &nbsp;2. Power off the router<br />&nbsp; &nbsp;3. Give your computer a static IP address of 192.168.0.100.<br />&nbsp; &nbsp;4. Push and hold the reset button down with a paper clip or something similar.<br />&nbsp; &nbsp;5. While holding the reset button down plug the router back in and keep holding the reset button down for 10 seconds.<br />&nbsp; &nbsp;6. Open a browser and go to <a href="http://192.168.0.1">http://192.168.0.1</a> </p><p>You should see a simple web page with and edit box, a browse button and a send button. Use this to flash your router with the DLink firmware and all should be well again.</p></blockquote></div><p><strong>This is the same behavior as my DI-604 Rev.E3, as I&#039;ve done this before a few times (D-Link calls it &quot;Crashing Router&quot; for de-bricking it), and quite comforting to know I could always fall back to that. TFTP is also possible and I&#039;ve done before (after &quot;crashing&quot; the router) iirc..</strong> <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>----</p><p><strong><span class="bbu">Conclusion:</span></strong></p><p>1. Even with 64MB SDRAM , the 1MB Flash makes it impossible to add (even minimal) support for this ARM9E based router? Do I get a cookie at least? <img src="https://forum.openwrt.org/img/smilies/tongue.png" width="15" height="15" alt="tongue" /></p><p>If not /impossible/ to build and load a &quot;micro&quot; or stripped-down openwrt for it:</p><p>2a. Would it be sensible?<br />2b. Can I tap into the UART port on this board with a &quot;modified&quot; mobile phone serial cable? or would I still need to built a MAX232 adapter?</p><p>----</p><p>N.B.:<br />Though by all means I&#039;m no expert, I&#039;ve worked a little bit with embedded systems before (and participated in development of what was previously known as LRP - Linux Router Project), have an intermediate background knowledge in linux kernel dev / programming, and fairly long experience in network arch &amp; net administration. </p><p>I&#039;ve been reading a lot about OpenWRT and some of the forum&#039;s dev threads (and played around with derivatives such as ddwrt few years back) and have been quite impressed by it, and so I thought maybe this would be a good start for me to experiment, at least until I get other hardware to play with..</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p103330">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">geekgirl</div>
					<div class="post-datetime">
						20 Feb 2010, 07:25					</div>
				</div>
				<div class="post-content content">
					<p>After helpless retries to take a semi-decent picutre, I failed (crappy 3MP generic cam), so I just photoshop&#039;ed it, just for reference</p><p><span class="postimg"><img src="http://i49.tinypic.com/e66dee.jpg" alt="http://i49.tinypic.com/e66dee.jpg" /></span></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p103348">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						20 Feb 2010, 15:05					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>geekgirl wrote:</cite><blockquote><p><strong>512K Bits x 32 Bits x 4 Banks (64MB)</strong></p></blockquote></div><p>R U definitely sure this is a 64MB and not a 64Mb?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p103350">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">geekgirl</div>
					<div class="post-datetime">
						20 Feb 2010, 15:15					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mazilo wrote:</cite><blockquote><div class="quotebox"><cite>geekgirl wrote:</cite><blockquote><p><strong>512K Bits x 32 Bits x 4 Banks (64MB)</strong></p></blockquote></div><p>R U definitely sure this is a 64MB and not a 64Mb?</p></blockquote></div><p>you&#039;re right, it is a 64Mbit... so, that makes is a 8MB chip (64Mbit / 8bits = 8MB) ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p103362">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						20 Feb 2010, 17:29					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>geekgirl wrote:</cite><blockquote><div class="quotebox"><cite>mazilo wrote:</cite><blockquote><div class="quotebox"><cite>geekgirl wrote:</cite><blockquote><p><strong>512K Bits x 32 Bits x 4 Banks (64MB)</strong></p></blockquote></div><p>R U definitely sure this is a 64MB and not a 64Mb?</p></blockquote></div><p>you&#039;re right, it is a 64Mbit... so, that makes is a 8MB chip (64Mbit / 8bits = 8MB) ?</p></blockquote></div><p>Yes, 64Mb = 8MB.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p103427">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">geekgirl</div>
					<div class="post-datetime">
						21 Feb 2010, 10:21					</div>
				</div>
				<div class="post-content content">
					<p>Bad news..</p><p>I was reading up unicorn&#039;s instructions about disassembling and reassembling the DI-624 firmware (which is very similar to the DI-604, from my observations) <a href="https://forum.openwrt.org/viewtopic.php?pid=60218#p60218">https://forum.openwrt.org/viewtopic.php … 218#p60218</a></p><p>And while doing a little search , I found some info that stated that VDI-604 (Verizon&#039;s firmware for the DI-604 + QoS support) could be cross-flashed on the DI-604... here:<br /><a href="http://www.antifart.com/2006/09/02/d-link-di-604-firmware-rev-e.html">http://www.antifart.com/2006/09/02/d-li … rev-e.html</a></p><p>I figured what the heck, its a old spare, if I could get some QoS control on the thing, I&#039;d be more than happy..</p><p>I followed the link on the said page to verizon&#039;s VDI-604 firmware download page, did a little snooping around inside the ARJ-packed NML.MEM , and in fact, found a few static pages with many references to QoS options etc. and so I was thrilled to try it. Checksum seemed very similar to the D-Link&#039;s original firmware, and since many have cross-flashed the VDI-604-loaded versions with D-Link&#039;s, I figured it is A-OK ..</p><p>Verizon&#039;s supplied &quot;VDI-604_110ddm_Tue_2_Aug_2005.bin&quot;, however, would not be accepted through D-Link&#039;s firmware upgrade screen, resulting with a clueless error like &quot;the setting file is not compatible&quot; 8) Crash recovery firmware upgrade &amp; TFTP in crash recovery mode didn&#039;t seem to flash the firmware either.</p><p>So I downgraded from D-Link&#039;s official latest &quot;3.53&quot; version to 3.52, then 3.51, then 3.39, followed by retries to flash the VDI firmware, both in the normal admin interface, in crash recovery mode&#039;s firmware upgrade http page and via ftp, no luck..</p><p>eventually found this page: <a href="http://fioswatch.com/downloads/dlink-VDI-604/">http://fioswatch.com/downloads/dlink-VDI-604/</a> with a few older VDI firmware images, and 1 slightly newer (110ddm sept 2005). The newer one didn&#039;t work, nor the 107, nor the 105 (which doesn&#039;t follow the checksum as all the others)..</p><p>I eventually gave up, and thought well, just put back original firmware to get out of crash recovery mode. But... I can no longer do that <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>Normally, in crash recovery mode, once I upload /correct/ firmware, the upload (either via the http server or tftp) would take 2-3 seconds, the routers lights all flash once, then router reboots and comes back up in normal mode.<br />However, now upload stops soon as it begins - does not complete, web page times out, or if done via tftp, tftp times out soon after the put request, evident from a bit of wireshark analysis, client gets RST packet soon after a few packets are sent to upload firmware, and I can no longer ping the router, then I have to manually unplug power to restart the router, gets me back in recovery mode (HTTP and tftp open and accessible), but same issue persists.</p><p>I tried numerous times with different &quot;original&quot; firmware versions, various resetting cycles, but router connectivity dies at the moment I try to upload /ANY/ firmware (original or VDI one)..</p><p>Its a bit frustrating due to not having UART or JTAG connectivity. I sort of gave up for now. JTAG seems a bit too expensive of an investments for such a piece of junk, but serial is doable, if I can figure out the pinout of the serial port on the board, without having to buy an oscilloscope.. <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>any ideas? perhaps a faulty flash chip or &quot;stuck bits&quot;?</p><p>thx</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p103433">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">geekgirl</div>
					<div class="post-datetime">
						21 Feb 2010, 15:29					</div>
				</div>
				<div class="post-content content">
					<p>After closer inspection, I don&#039;t think there&#039;s a UART port on this board as some sources said..</p><p>JP1 (8pin) matches the pinout schematic for PLD-JTAG header here:<br /><a href="http://www.jtagtest.com/pinouts/pld-jtag">http://www.jtagtest.com/pinouts/pld-jtag</a></p><p>and the JP4 (2x5) right beneath JP1 matches the pinout schematic for AVR JTAG header here:<br /><a href="http://www.jtagtest.com/pinouts/altera_byteblaster">http://www.jtagtest.com/pinouts/altera_byteblaster</a></p><p>and both of the above make sense due to mention of &quot;Altera&quot; and the presence of the Altera PLD Chip..</p><p>And JP2 (2x10) indeed looks like a standard ARM-20 JTAG Header:<br /><a href="http://www.jtagtest.com/pinouts/arm20">http://www.jtagtest.com/pinouts/arm20</a></p><p>Another schematic of the ARM-20 here:<br /><a href="http://www.olimex.com/dev/images/arm-jtag-layout.gif">http://www.olimex.com/dev/images/arm-jtag-layout.gif</a></p><p>Datasheet on ARM-JTAG:<br /><a href="http://www.olimex.com/dev/pdf/arm-jtag.pdf">http://www.olimex.com/dev/pdf/arm-jtag.pdf</a></p><p>Unfortunately, there&#039;s no mention of the ARM-20 &quot;poor-man&#039;s&quot; parallel cable (or schematic for it) on openwrt&#039;s wiki, neither the jtag page nor the AR7 page <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /><br /><a href="http://nuwiki.openwrt.org/oldwiki/openwrtdocs/customizing/hardware/jtag_cable">http://nuwiki.openwrt.org/oldwiki/openw … jtag_cable</a><br /><a href="http://nuwiki.openwrt.org/oldwiki/AR7Port">http://nuwiki.openwrt.org/oldwiki/AR7Port</a></p><p>Though seems readily available and cheap (I&#039;m not in the US, far from it):<br /><a href="http://www.sparkfun.com/commerce/product_info.php?products_id=275">http://www.sparkfun.com/commerce/produc … cts_id=275</a><br /><a href="http://microcontrollershop.com/product_info.php?products_id=589">http://microcontrollershop.com/product_ … cts_id=589</a></p><p><strong>Would love to see a schematic of that (ARM-20) cable, similar to the one from jtag_cable openwrt wiki page</strong> (which seems to be originally from <a href="http://ar7.wikispaces.com/JTAG">http://ar7.wikispaces.com/JTAG</a> )</p><p>Any clues / pointers&nbsp; on that would be very much appreciated.. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><br /><p>From one of the previously referenced threads, particularly one of unicorn&#039;s posts, this seems quite interesting to try:</p><div class="quotebox"><blockquote><p>1Mb flash wont be a problem if you are planning to boot from the network.<br />My version of redboot with network support is only 70k, and i&#039;m sure it&#039;s not the best.</p><p>...</p><p>If i had only 1Mb flash i would find 3 unused GPIOs onboard and glue-in any SD/MMC flash with the root file system.<br />Actually, i&#039;m not sure i would even try to fit kernel or rootfs on this flash - i dont think it&#039;ll be very hard to add support<br />for a custom SD flash driver to the redboot.</p></blockquote></div><p>Of course, the case here is different. I&#039;m not sure what a &quot;ThreadX&quot; based router like this one would use for a boot loader.. custom one? Also, without a Serial console it would be quite difficult to try to implement I think.. Too bad, ugh.. This is probably the end of this endeavor <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>