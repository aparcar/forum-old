<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Severe usb-ohci error</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 22 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p73507">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">shawnperkins</div>
					<div class="post-datetime">
						18 Sep 2008, 19:16					</div>
				</div>
				<div class="post-content content">
					<p>Hi Guys,</p><p>I&#039;m trying to make use of a USB to serial adapter PL2303 on an Asus WL-520GU. (BCM5354) I checked out yesterday&#039;s trunk build, and it appeared to have the patches applied from bug 3803. When the router boots it sees the serial adapter and and assigns it to /dev/usb/tts/0. Things start off fine until I blast it with some traffic to test stability. After 5-10 minutes I receive the following message:</p><br /><p>usb-ohci.c: OHCI Unrecoverable Error, controller usb-00:03.0 disabled<br />__alloc_pages: 0-order allocation failed (gfp=0x20/0)<br />__alloc_pages: 0-order allocation failed (gfp=0x20/0)<br />__alloc_pages: 0-order allocation failed (gfp=0x20/0)<br />__alloc_pages: 0-order allocation failed (gfp=0x20/0)</p><br /><p>When this happens I lose the serial port and all network connectivity, luckily I have a console connected to /dev/tts/0 so that I am able to record the error message. A reboot is required to get things working again. Please let me know if you have any trouble reproducing this one, I can reliably reproduce it on my end.</p><p>Also, I have noticed that this problem is causing some sort of memory leak. The system memory is slowly depleted from boot up until the problem occurs. Typing &#039;free&#039; reveals that the system has gone from having 3mb of free ram to approximately 1mb of free ram. The only app I am running is ser2net, and my test script simply sends data via telnet to the input port which is forwarded to /dev/usb/tts/0. Memory is not reallocated when ser2net is killed.</p><p>Comments or suggestions welcome, attached is the log output after a fresh reboot. Any help would be greatly appreciated.</p><p>Thanks,<br />Shawn</p><br /><br /><br /><br /><br /><p>CFE version 1.0.37 for BCM947XX (32bit,SP,LE)<br />Build Date: Mon Apr 16 14:41:05 CST 2007 (root@localhost.localdomain)<br />Copyright (C) 2000,2001,2002,2003 Broadcom Corporation.</p><p>Initializing Arena<br />Initializing Devices.<br />Boot partition size = 131072(0x20000)<br />et0: Broadcom BCM47xx 10/100 Mbps Ethernet Controller 4.130.23.0<br />CPU type 0x29029: 240MHz<br />Total memory: 16384 KBytes</p><p>Total memory used by CFE:&nbsp; 0x80400000 - 0x8049A790 (632720)<br />Initialized Data:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x80430720 - 0x80432D10 (9712)<br />BSS Area:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x80432D10 - 0x80434790 (6784)<br />Local Heap:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x80434790 - 0x80498790 (409600)<br />Stack Area:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x80498790 - 0x8049A790 (8192)<br />Text (code) segment:&nbsp; &nbsp; &nbsp; &nbsp;0x80400000 - 0x80430720 (198432)<br />Boot area (physical):&nbsp; &nbsp; &nbsp; 0x0049B000 - 0x004DB000<br />Relocation Factor:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;I:00000000 - D:00000000</p><p>Null Rescue Flag.<br />Loader:raw Filesys:tftp Dev:(null) File:: Options:(null)<br />Loading: TFTP Server.<br />Failed.<br />Could not load :: Error<br />Loader:raw Filesys:raw Dev:flash0.os File: Options:(null)<br />Loading: .. 3760 bytes read<br />Entry at 0x80001000<br />Starting program at 0x80001000<br />CPU revision is: 00029029<br />Primary instruction cache 16kB, physically tagged, 4-way, linesize 16 bytes.<br />Primary data cache 16kB, 2-way, linesize 16 bytes.<br />Linux version 2.4.35.4 (shawn@localhost.localdomain) (gcc version 3.4.6 (OpenWrt-2.0)) #43 Thu Sep 18 12:10:52 EDT 2008<br />Setting the PFC to its default value<br />Determined physical RAM map:<br /> memory: 01000000 @ 00000000 (usable)<br />On node 0 totalpages: 4096<br />zone(0): 4096 pages.<br />zone(1): 0 pages.<br />zone(2): 0 pages.<br />Kernel command line: root=/dev/mtdblock2 rootfstype=squashfs,jffs2 init=/etc/preinit noinitrd console=ttyS0,115200<br />CPU: BCM5354 rev 2 at 240 MHz<br />Using 120.000 MHz high precision timer.<br />Calibrating delay loop... 238.38 BogoMIPS<br />Memory: 14208k/16384k available (1474k kernel code, 2176k reserved, 100k data, 88k init, 0k highmem)<br />Dentry cache hash table entries: 2048 (order: 2, 16384 bytes)<br />Inode cache hash table entries: 1024 (order: 1, 8192 bytes)<br />Mount cache hash table entries: 512 (order: 0, 4096 bytes)<br />Buffer cache hash table entries: 1024 (order: 0, 4096 bytes)<br />Page-cache hash table entries: 4096 (order: 2, 16384 bytes)<br />Checking for &#039;wait&#039; instruction...&nbsp; unavailable.<br />POSIX conformance testing by UNIFIX<br />PCI: no core<br />PCI: Fixing up bus 0<br />Linux NET4.0 for Linux 2.4<br />Based upon Swansea University Computer Society NET3.039<br />Initializing RT netlink socket<br />Starting kswapd<br />Registering mini_fo version $Id$<br />devfs: v1.12c (20020818) Richard Gooch (rgooch@atnf.csiro.au)<br />devfs: boot_options: 0x1<br />JFFS2 version 2.1. (C) 2001 Red Hat, Inc., designed by Axis Communications AB.<br />squashfs: version 3.0 (2006/03/15) Phillip Lougher<br />pty: 256 Unix98 ptys configured<br />Serial driver version 5.05c (2001-07-08) with MANY_PORTS SHARE_IRQ SERIAL_PCI enabled<br />ttyS00 at 0xb8000300 (irq = 3) is a 16550A<br />ttyS01 at 0xb8000400 (irq = 3) is a 16550A<br />b44.c:v0.93 (Mar, 2004)<br />eth0: Broadcom 47xx 10/100BaseT Ethernet 00:1f:c6:44:36:7e<br /> Amd/Fujitsu Extended Query Table v1.1 at 0x0040<br />number of CFI chips: 1<br />cfi_cmdset_0002: Disabling fast programming due to code brokenness.<br />Flash device: 0x400000 at 0x1c000000<br />bootloader size: 131072<br />Physically mapped flash: Filesystem type: squashfs, size=0x1bd134<br />Creating 5 MTD partitions on &quot;Physically mapped flash&quot;:<br />0x00000000-0x00020000 : &quot;cfe&quot;<br />0x00020000-0x003f0000 : &quot;linux&quot;<br />0x0009ec00-0x00260000 : &quot;rootfs&quot;<br />mtd: partition &quot;rootfs&quot; doesn&#039;t start on an erase block boundary -- force read-only<br />0x003f0000-0x00400000 : &quot;nvram&quot;<br />0x00260000-0x003f0000 : &quot;rootfs_data&quot;<br />Initializing Cryptographic API<br />NET4: Linux TCP/IP 1.0 for NET4.0<br />IP Protocols: ICMP, UDP, TCP, IGMP<br />IP: routing cache hash table of 512 buckets, 4Kbytes<br />TCP: Hash tables configured (established 1024 bind 2048)<br />ip_conntrack version 2.1 (5953 buckets, 5953 max) - 344 bytes per conntrack<br />ip_tables: (C) 2000-2002 Netfilter core team<br />NET4: Unix domain sockets 1.0/SMP for Linux NET4.0.<br />NET4: Ethernet Bridge 008 for NET4.0<br />802.1Q VLAN Support v1.8 Ben Greear &lt;greearb@candelatech.com&gt;<br />All bugs added by David S. Miller &lt;davem@redhat.com&gt;<br />VFS: Mounted root (squashfs filesystem) readonly.<br />Mounted devfs on /dev<br />Freeing unused kernel memory: 88k freed<br />Algorithmics/MIPS FPU Emulator v1.5<br />mount: mounting sysfs on /sys failed: No such device<br />mount: mounting devfs on /dev failed: Device or resource busy<br />- preinit -<br />Press CTRL-C for failsafe<br />diag: Detected &#039;ASUS WL-520gU&#039;<br />b44: eth0: Link is up at 100 Mbps, full duplex.<br />b44: eth0: Flow control is off for TX and off for RX.<br />roboswitch: Probing device eth0: found!<br />switch-robo&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5084&nbsp; &nbsp;0 (unused)<br />switching to jffs2<br />mini_fo: using base directory: /<br />mini_fo: using storage directory: /jffs<br />- init -</p><p>Please press Enter to activate this console. jffs2.bbc: SIZE compression mode activated.<br />b44: eth0: Link is up at 100 Mbps, full duplex.<br />b44: eth0: Flow control is off for TX and off for RX.<br />BFL_ENETADM not set in boardflags. Use force=1 to ignore.<br />usb.c: registered new driver usbdevfs<br />usb.c: registered new driver hub<br />device eth0.0 entered promiscuous mode<br />eth0.0: dev_set_promiscuity(master, 1)<br />device eth0 entered promiscuous mode<br />br-lan: port 1(eth0.0) entering learning state<br />br-lan: port 1(eth0.0) entering forwarding state<br />br-lan: topology change detected, propagating<br />PCI/DMA<br />wl0: wlc_attach: chiprev 2 coreunit 0 corerev 13 cccap 0x104007ea maccap 0x30482205 band 2.4G, phy_type 5 phy_rev 0 ana_rev 6<br />wl0: Broadcom BCM4318 802.11 Wireless Controller 4.150.10.5<br />CSLIP: code copyright 1989 Regents of the University of California<br />PPP generic driver version 2.4.2<br />ipt_time loading<br />lp: driver loaded but no devices found<br />Software Watchdog Timer: 0.05, timer margin: 60 sec<br />SB USB20H init<br />SB COREREV: 2<br />SB USB20H resetting<br />USB20H fcr: 0x64<br />USB20H shim cr: 0x8f7<br />usb-ohci.c: USB OHCI at membase 0xb8003000, IRQ 6<br />usb-ohci.c: usb-00:03.0, PCI device 14e4:471a<br />usb.c: new USB bus registered, assigned bus number 1<br />hub.c: USB hub found<br />hub.c: 2 ports detected<br />usb.c: registered new driver serial<br />usbserial.c: USB Serial support registered for Generic<br />usbserial.c: USB Serial Driver core v1.4<br />usbserial.c: USB Serial support registered for PL-2303<br />pl2303.c: Prolific PL2303 USB to serial adaptor driver v0.10.1<br />hub.c: new USB device 00:03.0-1, assigned address 2<br />usbserial.c: PL-2303 converter detected<br />usbserial.c: PL-2303 converter now attached to ttyUSB0 (or usb/tts/0 for devfs)</p><br /><br /><p>BusyBox v1.11.1 (2008-09-18 01:26:33 EDT) built-in shell (ash)<br />Enter &#039;help&#039; for a list of built-in commands.</p><p>&nbsp; _______&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;________&nbsp; &nbsp; &nbsp; &nbsp; __<br /> |&nbsp; &nbsp; &nbsp; &nbsp;|.-----.-----.-----.|&nbsp; |&nbsp; |&nbsp; |.----.|&nbsp; |_<br /> |&nbsp; &nbsp;-&nbsp; &nbsp;||&nbsp; _&nbsp; |&nbsp; -__|&nbsp; &nbsp; &nbsp;||&nbsp; |&nbsp; |&nbsp; ||&nbsp; &nbsp;_||&nbsp; &nbsp;_|<br /> |_______||&nbsp; &nbsp;__|_____|__|__||________||__|&nbsp; |____|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |__| W I R E L E S S&nbsp; &nbsp;F R E E D O M<br /> KAMIKAZE (bleeding edge, r12620) -------------------<br />&nbsp; * 10 oz Vodka&nbsp; &nbsp; &nbsp; &nbsp;Shake well with ice and strain<br />&nbsp; * 10 oz Triple sec&nbsp; mixture into 10 shot glasses.<br />&nbsp; * 10 oz lime juice&nbsp; Salute!<br /> ---------------------------------------------------<br />root@OpenWrt:/#</p>											<p class="post-edited">(Last edited by <strong>shawnperkins</strong> on 19 Sep 2008, 17:51)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73650">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">mightyohm</div>
					<div class="post-datetime">
						21 Sep 2008, 20:41					</div>
				</div>
				<div class="post-content content">
					<p>Any luck with this?&nbsp; I know a lot of others have had issues with USB on this box.</p><p>I&#039;m trying to decide if the 520 would make a good streaming audio box but not if the USB support is wonky.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73653">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">shawnperkins</div>
					<div class="post-datetime">
						22 Sep 2008, 00:33					</div>
				</div>
				<div class="post-content content">
					<p>No luck so far. It looks like things are close, perhaps it is something simple, I&quot;m really not sure. I would even give a donation of $100.00 via Paypal to anyone who could provide a patch for this one if it&#039;s fixed within a week or so.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73680">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">fmay</div>
					<div class="post-datetime">
						22 Sep 2008, 16:37					</div>
				</div>
				<div class="post-content content">
					<p>If the follow lines are added to the pcibios_enable_device function (pcibios.c) , it probably works better in the wl520gu (Sbrown&#039;s hint)....</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tmp = 0x00fe00fe;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; writel(tmp, (ulong)regs + 0x894);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp = readl((uintptr)regs + 0x894);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; printk(&quot;USB20H syn01 register : 0x%x\n&quot;, tmp);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp = 0x1;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; writel(tmp, (ulong)regs + 0x89c);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp = readl((uintptr)regs + 0x89c);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; printk(&quot;USB20H syn03 register : 0x%x\n&quot;, tmp);</p><p>But, in the same way...</p><p>usb-ohci.c: OHCI Unrecoverable Error, controller usb-00:03.0 disabled<br />usbserial.c: generic_write - port 0: failed submitting write urb (-143)<br />usbserial.c: generic_write - port 0: failed submitting write urb (-143)<br />usbserial.c: generic_write - port 0: failed submitting write urb (-143)<br />usbserial.c: generic_write - port 0: failed submitting write urb (-143)<br />.<br />.<br />.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73685">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">shawnperkins</div>
					<div class="post-datetime">
						22 Sep 2008, 18:19					</div>
				</div>
				<div class="post-content content">
					<p>Hi Guys,</p><p>First I want to thank you for getting back to me so quickly on this, I appreciate it.</p><p>I tried sbrowns hint with not very much success. I added the code to pcibios.c see below. (lines 343-351...I think this is the correct placement)</p><p>I also tried replacing lines 328-340 with lines 343-351 and it crashed a lot sooner when I did this.</p><p>This time I have more debug information....when the problem occurred, the information below was displayed on the local console.</p><p>Thanks again for the assistance on this one.<br />Shawn</p><br /><br /><br /><br /><p>usb-ohci.c: OHCI Unrecoverable Error, controller usb-00:03.0 disabled<br />pl2303.c: pl2303_write - failed submitting write urb, error -143<br />pl2303.c: pl2303_open - failed submitting read urb, error -143<br />usbserial.c: __serial_close - port 0: not open<br />pl2303.c: pl2303_open - failed submitting read urb, error -143<br />usbserial.c: __serial_close - port 0: not open<br />pl2303.c: pl2303_open - failed submitting read urb, error -143<br />Unable to handle kernel paging request at virtual address 00000024, epc == c01d2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 374, ra == c01d2300<br />Oops in fault.c::do_page_fault, line 206:<br />$0 : 00000000 1000fc00 00000000 18e4bbe9 8082b998 8094dd10 8094dd18 ffff00ff<br />$8 : 8094dfe0 0000fc00 00000000 8018b000 801ad2a4 03ffffff 801ad4a8 000fffff<br />$16: 80779020 80779080 8082b000 80779000 80788b40 c01d0000 00000000 80788b40<br />$24: 801ad6ac 8001bd0c&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8094c000 8094dd38 00409fb4 c01d2300<br />Hi : 00000000<br />Lo : 00000006<br />epc&nbsp; &nbsp;: c01d2374&nbsp; &nbsp; Tainted: P<br />Status: 1000fc03<br />Cause : 00000008<br />PrId&nbsp; : 00029029<br />Process ser2net (pid: 650, stackpage=8094c000)<br />Stack:&nbsp; &nbsp; 8094a660 800985fc ffffff71 8023f0c8 8082b000 00000000 80788b40<br /> 00000000 8094a660 801b0730 800988f8 8009873c 00000000 80030664 00001000<br /> 8094dda8 8082b000 8082b000 c01d4b28 8082b000 80a78740 00000000 80779000<br /> 80779020 80779000 8082b000 00000001 00000000 c01d0000 80788b40 80779000<br /> c01d20b8 00000000 00000000 00000000 1000fc00 ffffffb9 00000800 80788b40<br /> 00000882 ...<br />Call Trace:&nbsp; &nbsp;[&lt;800985fc&gt;] [&lt;800988f8&gt;] [&lt;8009873c&gt;] [&lt;80030664&gt;] [&lt;c01d4b28&gt;]<br /> [&lt;c01d20b8&gt;] [&lt;8009a788&gt;] [&lt;8009a6f8&gt;] [&lt;80043524&gt;] [&lt;800442f8&gt;] [&lt;80043c60&gt;]<br /> [&lt;800cc794&gt;] [&lt;8006bb4c&gt;] [&lt;8004478c&gt;] [&lt;80044774&gt;] [&lt;80037120&gt;] [&lt;80037280&gt;]<br /> [&lt;8004a698&gt;] [&lt;800c4eec&gt;] [&lt;80037518&gt;] [&lt;80008a60&gt;] [&lt;80008bc0&gt;] [&lt;8005bb0c&gt;]</p><p>Code: ae020058&nbsp; 8e020004&nbsp; 8c420008 &lt;8c420024&gt; 10400005&nbsp; 02802821&nbsp; 0040f809&nbsp; 0200&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2021&nbsp; 080748f6<br />root@OpenWrt:/#</p><br /><br /><br /><br /><br /><p>pcibios.c</p><br /><p>324&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* PRxxxx: War for 5354 failures. */<br />325&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (corerev == 1 || corerev == 2) {<br />326&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;uint32 tmp;<br />327<br />328&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* Change Flush control reg */<br />329&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tmp = readl((uintptr)regs + 0x400);<br />330&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tmp &amp;= ~8;<br />331&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;writel(tmp, (uintptr)regs + 0x400);<br />332&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tmp = readl((uintptr)regs + 0x400);<br />333&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;printk(KERN_INFO &quot;USB20H fcr: 0x%x\n&quot;, tmp);<br />334<br />335&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* Change Shim control reg */<br />336&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tmp = readl((uintptr)regs + 0x304);<br />337&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tmp &amp;= ~0x100;<br />338&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;writel(tmp, (uintptr)regs + 0x304);<br />339&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tmp = readl((uintptr)regs + 0x304);<br />340&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;printk(KERN_INFO &quot;USB20H shim cr: 0x%x\n&quot;, tmp);<br />341<br />342<br />343&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tmp = 0x00fe00fe;<br />344&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;writel(tmp, (ulong)regs + 0x894);<br />345&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tmp = readl((uintptr)regs + 0x894);<br />346&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;printk(&quot;USB20H syn01 register : 0x%x\n&quot;, tmp);<br />347<br />348&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tmp = 0x1;<br />349&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;writel(tmp, (ulong)regs + 0x89c);<br />350&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tmp = readl((uintptr)regs + 0x89c);<br />351&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;printk(&quot;USB20H syn03 register : 0x%x\n&quot;, tmp);</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73730">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">shawnperkins</div>
					<div class="post-datetime">
						23 Sep 2008, 07:03					</div>
				</div>
				<div class="post-content content">
					<p>Dear fmay,</p><p>if you or sbrown need a wl-520gu, I have an extra one with a direct serial port wired up....say the word and I&#039;ll throw it in the mail tomorrow....yours to keep of course <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73750">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">sbrown</div>
					<div class="post-datetime">
						23 Sep 2008, 12:19					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m not so sure that the problem is with the usb subsystem and not the usbserial and/or pl2303. I&#039;ve tried several disk drives on my &#039;gu using both the ohci and ehci drivers and haven&#039;t had problems. They have a lot higher data rate than a serial adapter.</p><p>I just looked at the history of usbserial and pl2303 in kernel.org&#039;s 2.4 git tree (2.4.37-rc1). The version of pl2303 has substantial changes and usbserial has added a few missing lock/unlocks. The comments by the author of the pl2303 patch are really interesting.</p><div class="codebox"><pre><code>I experienced major major data loss on a PL-2303 USB-serial converter
under 2.4.36, which I remedied by back-porting the pl2303.c from the
latest 2.6 kernel tree.

Here&#039;s a new patch, which is more complete than my previous one.
It&#039;s based on the 2.6.24.1.

There&#039;s a lot of trivial white-space changes and some things that have
been moved, which make the patch rather larger than it could be.  I
didn&#039;t include those changes before, but have now in order that the
driver be closer to the 2.6 driver.  It&#039;ll never be identical, of course.

Note, too, that the 2.6 driver (and thus the patched 2.4) includes a 1k
circular buffer which rather duplicates a buffer in the 2.4 usbserial.c;
2.6&#039;s usb-serial has had that buffer removed.  As the buffer resolves
loss of the occasional putchar (e.g. from n_tty&#039;s opost), it is
important and correct, even in 2.4.

Speaking as a user, I no longer see any problems with PL2303, and I
think this is okay to release.</code></pre></div><p>Somebody with a pl2303 adapter might want to see if this solves the problem.<br />Steve</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73761">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">fmay</div>
					<div class="post-datetime">
						23 Sep 2008, 15:46					</div>
				</div>
				<div class="post-content content">
					<p>Shawn</p><p>try it:</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tmp = 0x00fe00fe;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; writel(tmp, (uintptr)regs + 0x894);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp = readl((uintptr)regs + 0x894);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; printk(&quot;USB20H syn01 register : 0x%x\n&quot;, tmp);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp = readl((uintptr)regs + 0x89c);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp |= 0x1;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; writel(tmp, (uintptr)regs + 0x89c);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp = readl((uintptr)regs + 0x89c);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; printk(&quot;USB20H syn03 register : 0x%x\n&quot;, tmp);</p><p>let us to know your results.</p><p>It doesn&#039;t resolve my problem yet, but it does work better with the EHCI.</p><br /><br /><p>-------------------------------------------------------------------------------------<br />usb-ohci.c: OHCI Unrecoverable Error, controller usb-00:03.0 disabled<br />usb-ohci.c: hcca branch int&nbsp; 0( 0): ed: 11082;<br />-------------------------------------------------------------------------------------</p>											<p class="post-edited">(Last edited by <strong>fmay</strong> on 25 Sep 2008, 00:13)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73776">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">shawnperkins</div>
					<div class="post-datetime">
						23 Sep 2008, 21:26					</div>
				</div>
				<div class="post-content content">
					<p>Hi Guys,</p><p>I tried applying the patch for pl2303.c and pl2303.h and received a bunch of errors. So I obtained the files with the patch already applied from kernel 2.4.37-rc1 and built a new image...and got the same results. </p><p>usb-ohci.c: OHCI Unrecoverable Error, controller usb-00:03.0 disabled</p><p>The files modified were located in:</p><p>./build_dir/linux-brcm-2.4/linux-2.4.35.4/drivers/usb/serial/</p><br /><p>I then tried fmays suggestion, and again got the same results.</p><p>usb-ohci.c: OHCI Unrecoverable Error, controller usb-00:03.0 disabled</p><br /><br /><p>Just to verify, I&#039;m applying this changes to:</p><p>/build_dir/linux-brcm-2.4/linux-2.4.35.4/arch/mips/bcm947xx/pcibios.c</p><p>and I&#039;m also deleting the .o files in these directories just in case.</p><p>Thanks,<br />Shawn</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73819">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">sbrown</div>
					<div class="post-datetime">
						24 Sep 2008, 15:02					</div>
				</div>
				<div class="post-content content">
					<p>I found a Prolific usb dongle (067b/2303) in the junk drawer and ran several experiments comparing the gpv2 and the gu. Both use the same chip, except the gpv2 has a hub. On the gu, if I cat even a small file to the usb dongle, I get the well known unrecoverable usb error. On the gpv2, the usb dongle fails to enumerate (error -32). I&#039;m running the same image on both. Disks enumerate, mount and function on both.</p><p>I tried 2.6 (svn 12660) w/ the ehci/ohci patch I posted on the openwrt-dev list last summer with the added initializations from fmay&#039;s earlier post. The serial adapter works with both the gpv2 and gu. Disks also work. </p><p>The disk controller and the prolific dongle both have two bulk endpoints. The only difference is that dongle also has an interrupt endpoint. </p><p>I&#039;m starting to think that this is a bug in either the usb or usb serial code that has been fixed and not back ported to 2.4.</p><p>If somebody can suggested a more definitive torture test, I&#039;ll try that. </p><p>Steve</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73826">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">shawnperkins</div>
					<div class="post-datetime">
						24 Sep 2008, 18:18					</div>
				</div>
				<div class="post-content content">
					<p>Hi Steve,</p><p>Here are the steps to reproduce:</p><p>1. Make sure ser2net is selected when you do a &#039;make menuconfig&#039; this is located within the &#039;network&#039; menu</p><p>2. load the new image, telnet to the system and replace /etc/ser2net.conf with the following line:</p><p>4500:raw:0:/dev/usb/tts/0:19200 NONE 1STOPBIT 8DATABITS</p><p>3. Start ser2net from the command line: &#039;ser2net -u -n -p 4200 &amp;&#039;</p><p>4. Create a file called &#039;/jffs/test.sh&#039; and place the following within the file:</p><br /><p>#!/bin/sh</p><p>while [ 1 ]</p><p>do<br />telnet localhost 4500 &lt;/etc/passwd<br />sleep 1<br />done</p><p>4. chmod 755 /jffs/test.sh</p><p>5. Sent data to ser2net (port 4500) by starting the test script &#039;./test.sh &amp;&#039;</p><p>6. To really beat things up, start another three sessions of test.sh &#039;./test.sh &amp;&#039; &#039;./test.sh&amp;&#039; &#039;./test.sh&#039;</p><p>7. To verify that data is actually being sent to ser2net, log on to the monitor port and watch the data come through: &#039;telnet &lt;router IP&gt; 4200&#039; and from the -&gt; prompt type &#039;monitor tcp 4500&#039; you will then be able to verify the data that the test scripts are sending</p><p>8. While this is happening, you can type &#039;free&#039; to watch the available memory disappear</p><br /><p>Within five to ten minutes or so you should see the crash. If it does not happen type &#039;killall test.sh&#039; then restart the test scripts, this will give it a good kick</p><p>Please note: when the OHCI error occurs, you will lose all network connectivity, the only was to see the errors is with a local console attached to /dev/tts/0</p><br /><p>Let me know if you have any problems reproducing.</p><br /><p>Also a couple of notes, may or may not be relevant: I was able to get the USB 2.0 storage working perfectly with Kamikaze 2.4 kernel a month or so ago. I beat the heck out of it and it didn&#039;t even miss a beat. This however that does not use OHCI if I remember correctly. Also on Whiterussian 0.9 with an Asus 500GPv1, the Pl2303 has been working perfectly for months. </p><br /><p>Thanks,<br />Shawn</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73829">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">sbrown</div>
					<div class="post-datetime">
						24 Sep 2008, 19:29					</div>
				</div>
				<div class="post-content content">
					<p>Shawn,</p><p>Thanks. I&#039;ll give it a try and report.</p><p>FWIW: If you rmmod ehci-hcd, the disk will use the ohci driver. You can look at /proc/bus/usb/devices to confirm that it enumerates at 12Mhz.</p><p>Steve</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73834">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">shawnperkins</div>
					<div class="post-datetime">
						24 Sep 2008, 20:46					</div>
				</div>
				<div class="post-content content">
					<p>Hi Steve,</p><p>I did a rmmod on my other router running the usb disk....that system is running v12230 with some patches.</p><p>cat /proc/bus/usb/devices provides the following information:</p><p>T:&nbsp; Bus=01 Lev=00 Prnt=00 Port=00 Cnt=00 Dev#=&nbsp; 1 Spd=12&nbsp; MxCh= 2<br />B:&nbsp; Alloc=&nbsp; 0/900 us ( 0%), #Int=&nbsp; 0, #Iso=&nbsp; 0<br />D:&nbsp; Ver= 1.10 Cls=09(hub&nbsp; ) Sub=00 Prot=00 MxPS= 8 #Cfgs=&nbsp; 1<br />P:&nbsp; Vendor=0000 ProdID=0000 Rev= 0.00<br />S:&nbsp; Product=USB OHCI Root Hub<br />S:&nbsp; SerialNumber=b8003000<br />C:* #Ifs= 1 Cfg#= 1 Atr=40 MxPwr=&nbsp; 0mA<br />I:&nbsp; If#= 0 Alt= 0 #EPs= 1 Cls=09(hub&nbsp; ) Sub=00 Prot=00 Driver=hub<br />E:&nbsp; Ad=81(I) Atr=03(Int.) MxPS=&nbsp; &nbsp;2 Ivl=255ms</p><br /><p>I also tried my test on my other 520gu running build 12230. This system has a solid USB storage system. When running the serial test with OHCI it fails the same way build 12632 does.</p><br /><p>Thanks,<br />Shawn</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73839">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">sbrown</div>
					<div class="post-datetime">
						24 Sep 2008, 22:47					</div>
				</div>
				<div class="post-content content">
					<p>Paydirt. I get a continuous output of the following sequence.</p><div class="codebox"><pre><code>handlers:                                                                       
[&lt;c00857d8&gt;] (usb_hcd_irq+0x0/0x154 [usbcore])                                  
[&lt;c00857d8&gt;] (usb_hcd_irq+0x0/0x154 [usbcore])                                  
Disabling IRQ #5                                                                
irq 5: nobody cared (try booting with the &quot;irqpoll&quot; option)                     
Call Trace:                                                                     
[&lt;800094c4&gt;] dump_stack+0x8/0x34                                                
[&lt;8005108c&gt;] __report_bad_irq+0x4c/0xac                                         
[&lt;80051354&gt;] note_interrupt+0x268/0x2d4                                         
[&lt;8005184c&gt;] handle_percpu_irq+0x74/0xac                                        
[&lt;80001e10&gt;] plat_irq_dispatch+0x168/0x1d8                                      
[&lt;80002ca4&gt;] ret_from_irq+0x0/0x4                                               
[&lt;8002b454&gt;] __do_softirq+0x4c/0x100                                            
[&lt;8002b564&gt;] do_softirq+0x5c/0x94                                               
[&lt;80001e28&gt;] plat_irq_dispatch+0x180/0x1d8                                      
[&lt;80002ca4&gt;] ret_from_irq+0x0/0x4                                               
[&lt;8006ed3c&gt;] do_mmap_pgoff+0x14/0x334                                           
[&lt;8000834c&gt;] old_mmap+0x9c/0x150                                                
[&lt;8000b4b0&gt;] stack_done+0x20/0x3c</code></pre></div><p>At least this might be easier to track down.</p><p>The test ran on the gpv2 for 20min w/o problems.</p><p>Next, I put the 4 port hub in my monitor between the dongle and the gu. It&#039;s been running for an hour w/o a problem. The free memory is stable at 1960k. It explains why the gpv2 doesn&#039;t have the problem. </p><p>Steve</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73843">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">fmay</div>
					<div class="post-datetime">
						25 Sep 2008, 01:07					</div>
				</div>
				<div class="post-content content">
					<p>Very sensible problem:</p><p>/ # cat /proc/meminfo<br />&nbsp; &nbsp; &nbsp; &nbsp; total:&nbsp; &nbsp; used:&nbsp; &nbsp; free:&nbsp; shared: buffers:&nbsp; cached:<br />Mem:&nbsp; 14639104 13848576&nbsp; &nbsp;790528&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; 1372160&nbsp; 3702784<br />Swap:&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0<br />MemTotal:&nbsp; &nbsp; &nbsp; &nbsp; 14296 kB<br />MemFree:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;772 kB<br />MemShared:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 kB<br />Buffers:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1340 kB<br />Cached:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3616 kB<br />SwapCached:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 kB<br />Active:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2424 kB<br />Inactive:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2564 kB<br />HighTotal:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 kB<br />HighFree:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 kB<br />LowTotal:&nbsp; &nbsp; &nbsp; &nbsp; 14296 kB<br />LowFree:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;772 kB<br />SwapTotal:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 kB<br />SwapFree:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 kB</p><br /><p>After two seconds and before it freeze:</p><p>/ # cat /proc/meminfo<br />&nbsp; &nbsp; &nbsp; &nbsp; total:&nbsp; &nbsp; used:&nbsp; &nbsp; free:&nbsp; shared: buffers:&nbsp; cached:<br />Mem:&nbsp; 14639104 14376960&nbsp; &nbsp;262144&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; 1478656&nbsp; 4091904<br />Swap:&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0<br />MemTotal:&nbsp; &nbsp; &nbsp; &nbsp; 14296 kB<br />MemFree:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;256 kB<br />MemShared:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 kB<br />Buffers:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1444 kB<br />Cached:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3996 kB<br />SwapCached:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 kB<br />Active:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2644 kB<br />Inactive:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2832 kB<br />HighTotal:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 kB<br />HighFree:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 kB<br />LowTotal:&nbsp; &nbsp; &nbsp; &nbsp; 14296 kB<br />LowFree:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;256 kB<br />SwapTotal:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 kB<br />SwapFree:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 kB</p>											<p class="post-edited">(Last edited by <strong>fmay</strong> on 25 Sep 2008, 15:16)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73938">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">sbrown</div>
					<div class="post-datetime">
						27 Sep 2008, 00:48					</div>
				</div>
				<div class="post-content content">
					<p>Here&#039;s some more detail on the failure.</p><p>So far,</p><p> - The UE is claimed to most often be caused a dma failure. </p><p> - Both the hub I used as well as the one in the gpv2 has a &quot;transaction translator&quot; that converts the 12meg transaction to a 480meg transaction. Thus, with the hub, the serial dongle is handled by the ehci, not the ohci driver. This is confirmed by the debug output when using either hub. So, the problem seems specific to the ohci part of the core.</p><p> - I searched the histories in the kernel.org git repository and cannot find anything that might bare on this problem subsequent to the 2.6.25.6 kernel used by Openwrt. I suppose I could have missed something. </p><p> - I doubt I can get much interest on the linux-usb list unless the failure is demonstrated on a current kernel. Updating Openwrt to a 2.6.27-rcx tree is, at least for me, non-trivial.</p><p> - Lastly, I don&#039;t understand where the irq 5 complaint is coming from. It looks like this is an unhandled usb interrupt. I put a printk in the ohci interrupt handler where it exits with a&nbsp; IRQ_NOTMINE. It never went off.</p><p>Anybody have an idea of where to go from here?</p><p>Steve</p><br /><div class="codebox"><pre><code>ohci_hcd ssb0:1: OHCI Unrecoverable Error, disabled
ohci_hcd ssb0:1: OHCI controller state
ohci_hcd ssb0:1: OHCI 1.0, NO legacy support registers
ohci_hcd ssb0:1: control 0x0af HCFS=operational BLE IE PLE CBSR=3
ohci_hcd ssb0:1: cmdstatus 0x00004 SOC=0 BLF
ohci_hcd ssb0:1: intrstatus 0x00000030 FNO UE
ohci_hcd ssb0:1: intrenable 0x8000005e MIE RHSC UE RD SF WDH
ohci_hcd ssb0:1: ed_controlhead 00bbe000
ohci_hcd ssb0:1: ed_bulkhead 00bbe040
ohci_hcd ssb0:1: ed_bulkcurrent 3c1f8000
ohci_hcd ssb0:1: hcca frame #9de4
ohci_hcd ssb0:1: roothub.a 02001202 POTPGT=2 NOCP NPS NDP=2(2)
ohci_hcd ssb0:1: roothub.b 00000000 PPCM=0000 DR=0000
ohci_hcd ssb0:1: roothub.status 00008000 DRWE
ohci_hcd ssb0:1: roothub.portstatus [0] 0x00000103 PPS PES CCS
ohci_hcd ssb0:1: roothub.portstatus [1] 0x00000100 PPS
ohci_hcd ssb0:1: HC died; cleaning up
irq 5: nobody cared (try booting with the &quot;irqpoll&quot; option)
Call Trace:
[&lt;80009524&gt;] dump_stack+0x8/0x34
[&lt;8004f79c&gt;] __report_bad_irq+0x4c/0xac
[&lt;8004fa64&gt;] note_interrupt+0x268/0x2d4
[&lt;8004ff5c&gt;] handle_percpu_irq+0x74/0xac
[&lt;80001e10&gt;] plat_irq_dispatch+0x168/0x1d8
[&lt;80002cc4&gt;] ret_from_irq+0x0/0x4
[&lt;8007b51c&gt;] cache_alloc_debugcheck_after+0x190/0x230
[&lt;8007d678&gt;] kmem_cache_alloc+0x1d8/0x220
[&lt;8016dd30&gt;] __alloc_skb+0x58/0x148
[&lt;801b7a14&gt;] tcp_send_ack+0x38/0x104
[&lt;801bb078&gt;] tcp_delack_timer+0x180/0x284
[&lt;8002e8f8&gt;] run_timer_softirq+0x158/0x1fc
[&lt;80029ae4&gt;] __do_softirq+0x78/0x100
[&lt;80029bc8&gt;] do_softirq+0x5c/0x94
[&lt;80001e28&gt;] plat_irq_dispatch+0x180/0x1d8
[&lt;80002cc4&gt;] ret_from_irq+0x0/0x4
[&lt;8007ad50&gt;] check_poison_obj+0x50/0x214
[&lt;8007b3cc&gt;] cache_alloc_debugcheck_after+0x40/0x230
[&lt;8007d678&gt;] kmem_cache_alloc+0x1d8/0x220
[&lt;8008b008&gt;] getname+0x20/0xd4
[&lt;8007f294&gt;] do_sys_open+0x30/0xcc
[&lt;8000b510&gt;] stack_done+0x20/0x3c

handlers:
[&lt;c0087230&gt;] (usb_hcd_irq+0x0/0x214 [usbcore])
[&lt;c0087230&gt;] (usb_hcd_irq+0x0/0x214 [usbcore])
Disabling IRQ #5</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73960">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">shawnperkins</div>
					<div class="post-datetime">
						27 Sep 2008, 19:44					</div>
				</div>
				<div class="post-content content">
					<p>Hi Steve,</p><p>From what I understand, the radio doesn&#039;t work with the 2.6 kernel on the BCM5354. This would make it very difficult for me to upgrade as well.</p><p>I heard a report of someone getting the radio to run in client mode, although I tried with no success. Client mode is all I currently need for my project, if someone could shed some light on this it would be greatly appreciated.</p><p>In the mean time, hopefully someone can point us in the right direction to getting this one resolved.</p><p>Thanks,<br />Shawn</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p73989">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">sbrown</div>
					<div class="post-datetime">
						28 Sep 2008, 13:52					</div>
				</div>
				<div class="post-content content">
					<p>Shawn,</p><p>The idea is to use a more current kernel to track down the problem and then backport it to 2.4. I think a more current one will provide a better debugging environment and the likelihood of getting help from the linux-usb gang.</p><p>Also, I tested an Alix board (x86) with both 2.6.25.16 and 2.6.27-rc6. It also has an OHCI interface. Neither version exhibited the usb problem or presumed memory leak. At this point, the problem is probably either a) ohci hardware, b) ssb driver code, c) ssb-specific parts of the usb code or d) some corner case in the usb code. My suspicion is the last one. The ohci code has lots of workarounds for specific controller bugs. Maybe it needs one more. I&#039;ve extensively tested several disk controllers using the ohci (not ehci) driver and can&#039;t get them to fail.&nbsp; One explanation is that something in the handling of interrupt endpoints plus a bug in the ohci hardware is causing this. The disk controllers don&#039;t have an interrupt endpoint.</p><p>I&#039;m going to revisit getting a current kernel to run on my gu. Getting help on linux-usb for an old kernel and weird hardware is unlikely.</p><p>I&#039;m sure open to suggestions,</p><p>Steve</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p74290">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">sbrown</div>
					<div class="post-datetime">
						5 Oct 2008, 21:42					</div>
				</div>
				<div class="post-content content">
					<p>An update. </p><p>I&#039;m using a 2.6.25.26 kernel with the ehci driver not configured. </p><p>The problem seems to be caused by a bogus value in the ohci controller&#039;s ed_bulkcurrent reg. In the above dump it was 3c1f8000. There was never anything allocated at that location, so the controller goes looking for td&#039;s, probably gets a bus error and reports a UE. It&#039;s downhill from there. All the failures are similar in that there is a random bad value in the ed_bulkcurrent reg. There are routines in ohci-dbg to dump the bulk queue. I&#039;m trying to get them hooked up to see if the bad address is in the data structures or just the controller reg. </p><p>If anybody is familiar with this stuff, I could sure use some help. I still don&#039;t have anything worth posting to linux-usb.</p><p>Steve</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75053">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">shawnperkins</div>
					<div class="post-datetime">
						20 Oct 2008, 20:17					</div>
				</div>
				<div class="post-content content">
					<p>Hi Steve,</p><p>I&#039;m willing to hire someone to fix this problem if possible. I will in return make sure the fix get&#039;s incorporated with SVN for others to make use of. Any suggestions as to who may be willing to spend some time on this one?</p><p>Thanks,<br />Shawn</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75096">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">sbrown</div>
					<div class="post-datetime">
						21 Oct 2008, 04:06					</div>
				</div>
				<div class="post-content content">
					<p>I reproduced the problem on 2.6.27 and posted the result to linux-usb on 10/15. I got no reply. </p><p>It appears to me that the problem is a bug in the ohci core. A dump of the queue at the time of the error shows a reasonable looking ed, but the ed_bulkcurrent register in the controller is bogus. The UE is caused when the controller tries to load data referenced by that reg. The address isn&#039;t in the address space, the controller gets a bus error and sets the UE interrupt. My reading the spec is that the loading of this reg is under control of the hardware. A zero is written to it by ohci-q and ohci-hcd to initialize the controller.&nbsp; Otherwise, it&#039;s untouched. There is only one ed in the queue. I&#039;ve got no idea how the reg gets screwed up.</p><p>Other circumstantial evidence.<br />&nbsp; - The ohci controller on my Alix will run the test for hours without problem. This would seem to eliminate the ohci&nbsp; and serial drivers.<br />&nbsp; - The ehci core and the hub w/ a transaction translator on the 500gpv2 will also run the test without problem. This would seem to also suggest that the serial driver is not the problem.</p><p>I&#039;m not sure where to go.</p><p>Steve</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p76188">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">shawnperkins</div>
					<div class="post-datetime">
						10 Nov 2008, 18:31					</div>
				</div>
				<div class="post-content content">
					<p>Hi Steve,</p><p>Do you think I&#039;d have better luck using a FTDI based USB to serial adapter?</p><p>There are some available with the FT232R chip, they claim that they are USB 2.0, and EHCI host controller compatible. If this is the case, from the way I understand this issue, they should load up the EHCI driver and work fine. Any thoughts on this?</p><p>I&#039;ve attached a bit more info on the chip below, let me know what you think.</p><p>Thanks,<br />Shawn</p><p><a href="http://www.ftdichip.com/Products/FT232R.htm">http://www.ftdichip.com/Products/FT232R.htm</a></p><br /><br /><p>- Single chip USB to asynchronous serial data transfer interface.<br />- Entire USB protocol handled on the chip - No USB-specific firmware programming required.<br />- UART interface support for 7 or 8 data bits, 1 or 2 stop bits and odd / even / mark / space / no parity.<br />- Fully assisted hardware or X-On / X-Off software handshaking.<br />- Data transfer rates from 300 baud to 3 Megabaud (RS422 / RS485 and at TTL levels) and 300 baud to 1 Megabaud (RS232).<br />- In-built support for event characters and line break condition.<br />- New USB FTDIChip-IDâ„¢ feature.<br />- New configurable CBUS I/O pins.<br />- Auto transmit buffer control for RS485 applications.<br />- Transmit and receive LED drive signals.<br />- New 48MHz, 24MHz,12MHz, and 6MHz clock output signal Options for driving external MCU or FPGA.<br />- FIFO receive and transmit buffers for high data throughput.<br />- 256 Byte receive buffer and 128 Byte transmit buffer utilising buffer smoothing technology to allow for high data throughput.<br />- Adjustable receive buffer timeout.<br />- Synchronous and asynchronous bit bang mode interface options with RD# and WR# strobes.<br />- New CBUS bit bang mode option.<br />- Integrated 1024 bit internal EEPROM for I/O configuration and storing USB VID, PID, serial number and product description strings.<br />- Device supplied preprogrammed with unique USB serial number.<br />- Support for USB suspend / resume.<br />- Support for bus powered, self powered, and high-power bus powered USB configurations.<br />- Integrated 3.3V level converter for USB I/O .<br />- Integrated level converter on UART and CBUS for interfacing to 5V - 1.8V Logic.<br />- True 5V / 3.3V / 2.8V / 1.8V CMOS drive output and TTL input.<br />- High I/O pin output drive option.<br />- Integrated USB resistors.<br />- Integrated power-on-reset circuit.<br />- Fully integrated clock - no external crystal, oscillator, or resonator required.<br />- Fully integrated AVCC supply filtering - No separate AVCC pin and no external R-C filter required.<br />- UART signal inversion option.<br />- USB bulk transfer mode.<br />- 3.3V to 5.25V Single Supply Operation.<br />- Low operating and USB suspend current.<br />- Low USB bandwidth consumption.<br />- UHCI / OHCI / EHCI host controller compatible.<br />- USB 2.0 Full Speed compatible.<br />- -40Â°C to 85Â°C extended operating temperature range.<br />- Available in compact Pb-free 28 Pin SSOP and QFN-32 packages (both RoHS compliant).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p76193">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">sbrown</div>
					<div class="post-datetime">
						10 Nov 2008, 19:37					</div>
				</div>
				<div class="post-content content">
					<p>I have one of these and use it as the console interface for my 520gu. It has 3.3v I/O. It doesn&#039;t have rs232 level converters. Also, it only enumerates as a 12MHz device. I unloaded my pc&#039;s uhci driver and plugged it in. It won&#039;t enumerate w/ just the ehci driver. </p><p>I&#039;m still convinced that there is a bug in the usb2 core in the 5354. I just don&#039;t know how to identify it. The &quot;memory leak&quot; is probably a clue and is probably caused by the core bug. I have an Alix 3c2 that also has a ohci controller. It and the ohci and pl2303 drivers run without any problem with the same usb serial dongle. I appreciate one is mips and the other i386, but can&#039;t imagine that has anything to do with the problem. When I have a time, I&#039;ll see if I can figure out if the memory disappearing in the ohci driver, the pl23203 driver or the ser/net program. </p><p>Steve</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p76195">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">shawnperkins</div>
					<div class="post-datetime">
						10 Nov 2008, 19:43					</div>
				</div>
				<div class="post-content content">
					<p>Steve,</p><p>Thanks for the info.</p><p>Again, I appreciate all of the time you put in to this one.</p><p>Shawn</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p76958">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">shawnperkins</div>
					<div class="post-datetime">
						24 Nov 2008, 00:19					</div>
				</div>
				<div class="post-content content">
					<p>Steve,</p><p>Here is a strange one...I&#039;m now using a Belkin F5U109 USB to serial adapter with OHCI and guess what....it works fine....no problems, no memory leaks, and I beat the daylights out of it for three days straight! I&#039;ll attach the DMESG log below.</p><p>I also tried a FTDI converter with the FT232BL chip. No luck, runs about 20 seconds, the quits. Although they claim that you can set it to run in 2.0 mode, it always grabs the OHCI driver and won&#039;t run with the EHCI.</p><p>I wonder why the Belkin runs ok? I just wish this little guy wasn&#039;t twenty something bucks and hard so hard to find. <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>Thanks,<br />Shawn</p><br /><br /><p>SB USB20H init<br />SB COREREV: 2<br />SB USB20H resetting<br />USB20H fcr: 0x64<br />USB20H shim cr: 0x8f7<br />PCI: Setting latency timer of device 00:03.0 to 64<br />usb-ohci.c: USB OHCI at membase 0xb8003000, IRQ 6<br />usb-ohci.c: usb-00:03.0, PCI device 14e4:471a<br />usb.c: new USB bus registered, assigned bus number 1<br />usb.c: kmalloc IF 80de7c60, numif 1<br />usb.c: new device strings: Mfr=0, Product=2, SerialNumber=1<br />usb.c: USB device number 1 default language ID 0x0<br />Product: USB OHCI Root Hub<br />SerialNumber: b8003000<br />hub.c: USB hub found<br />hub.c: 2 ports detected<br />hub.c: standalone hub<br />hub.c: ganged power switching<br />hub.c: no over-current protection<br />hub.c: Port indicators are not supported<br />hub.c: power on to power good time: 4ms<br />hub.c: hub controller current requirement: 0mA<br />hub.c: port removable status: RR<br />hub.c: local power source is good<br />hub.c: no over-current condition exists<br />hub.c: enabling power on all ports<br />usb.c: hub driver claimed interface 80de7c60<br />usb.c: kusbd: /sbin/hotplug-call add 1<br />hub.c: port 1, portstatus 101, change 1, 12 Mb/s<br />hub.c: port 1 connection change<br />hub.c: port 1, portstatus 101, change 1, 12 Mb/s<br />usb.c: registered new driver serial<br />usbserial.c: USB Serial support registered for Generic<br />usbserial.c: USB Serial Driver core v1.4<br />hub.c: port 1, portstatus 101, change 0, 12 Mb/s<br />hub.c: port 1, portstatus 101, change 0, 12 Mb/s<br />usbserial.c: USB Serial support registered for MCT U232<br />mct_u232.c: Magic Control Technology USB-RS232 converter driver z2.0<br />hub.c: port 1, portstatus 101, change 0, 12 Mb/s<br />hub.c: port 1, portstatus 101, change 0, 12 Mb/s<br />hub.c: port 1, portstatus 103, change 10, 12 Mb/s<br />hub.c: new USB device 00:03.0-1, assigned address 2<br />usb.c: kmalloc IF 80de73e0, numif 1<br />usb.c: new device strings: Mfr=1, Product=2, SerialNumber=3<br />usb.c: USB device number 2 default language ID 0x409<br />Manufacturer: Belkin USB PDA Adapter<br />Product: Belkin Components<br />SerialNumber: 762841<br />usbserial.c: MCT U232 converter detected<br />usbserial.c: MCT U232 converter now attached to ttyUSB0 (or usb/tts/0 for devfs)<br />usb.c: serial driver claimed interface 80de73e0<br />usb.c: kusbd: /sbin/hotplug-call add 2<br />hub.c: port 2, portstatus 100, change 0, 12 Mb/s<br />usbserial.c: USB Serial support registered for PL-2303<br />pl2303.c: Prolific PL2303 USB to serial adaptor driver v0.10.1</p>											<p class="post-edited">(Last edited by <strong>shawnperkins</strong> on 24 Nov 2008, 00:21)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>