<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> [Solved] Strange issue with sqm-scripts</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 28 Apr 2018 and 30 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=64812&amp;p=2.html">2</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p323767">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">m45t3r</div>
					<div class="post-datetime">
						14 May 2016, 04:15					</div>
				</div>
				<div class="post-content content">
					<p>Hi</p><p>I am trying to setup sqm-scripts in my home network. We are using an ADSL2+ from a brazillian ISP (GVT), 15/1Mbps. My router is a TL-WR941NDv3(.6) and the ISP ADSL2+ router is a DSL-2740E (that is setup in bridge mode, so the PPPoE connection is managed by TL-WR941ND). I am using a custom compiled version of Barrier Breaker to save space (I can post my .config file if it helps), however I tried a similar build with Chaos Calmer (disabling IPv6 because in CC there isn&#039;t sufficient space for luci+luci-app-sqm and IPv6 support) and the result is similar.</p><p>The strange thing is, I setup everything correctly according to the <a href="https://wiki.openwrt.org/doc/howto/sqm">Wiki</a>: I measured my speed using <a href="http://www.speedtest.net/">SpeedTest</a>, setup my Download/Upload speed to 90% of the speed measured there, used defaults from Queue Discipline tab, put ATM in Link Layer Adaptation and set overhead to 44. However, my Download speed slowed to a crawl: something like 600<strong>kbps</strong> in SpeedTest (my normal speed is something like 15000kbps). <a href="https://www.dslreports.com/speedtest">DSLReports</a> didn&#039;t even finish the test, and the bufferbloat skyrocket to something like 500ms+. I tried to disable Link Layer Adaptation, reduce both my Download and Upload speed (to 80%, and in one case even 60% of measured speed), however it does not seem to fix the issue.</p><p>What I find curious is if I set my Upload speed to 0 in sqm-scripts it seems to works. I have a small impact in speed (10000/700 vs 15000/1000 without sqm) and DSLReports finishes properly giving me a A for Bufferbloat. Setting Download speed to 0 too does not make much difference compared to the calculated value that I obtained before (15000*0.9=13500).</p><p>So I want to know if setting Upload to 0 is ok (and maybe Download too) or is there something wrong that I missed in my setup. I can provide additional information if it helps.</p>											<p class="post-edited">(Last edited by <strong>m45t3r</strong> on 17 May 2016, 18:49)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323847">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">m45t3r</div>
					<div class="post-datetime">
						14 May 2016, 18:28					</div>
				</div>
				<div class="post-content content">
					<p>Well, just something I forget: I tried to set my interface to eth0 and wan. It is not really clear to me what is the correct interface to set sqm-scripts (I think it is eth0, however I am not sure).</p>											<p class="post-edited">(Last edited by <strong>m45t3r</strong> on 14 May 2016, 18:31)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323882">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						14 May 2016, 23:39					</div>
				</div>
				<div class="post-content content">
					<p>Hi m45t3r,</p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>Hi</p><p>I am trying to setup sqm-scripts in my home network. We are using an ADSL2+ from a brazillian ISP (GVT), 15/1Mbps. My router is a TL-WR941NDv3(.6) and the ISP ADSL2+ router is a DSL-2740E (that is setup in bridge mode, so the PPPoE connection is managed by TL-WR941ND). I am using a custom compiled version of Barrier Breaker to save space (I can post my .config file if it helps), however I tried a similar build with Chaos Calmer (disabling IPv6 because in CC there isn&#039;t sufficient space for luci+luci-app-sqm and IPv6 support) and the result is similar.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; I would recommend to try to update to the most recent sqm-scripts version manually, no matter whether you use BB or CC (as I believe only trunk/DD has a recent version in the repository). The following link should show you how to do this: <a href="https://github.com/tohojo/sqm-scripts">https://github.com/tohojo/sqm-scripts</a><br />&nbsp; &nbsp; &nbsp; &nbsp; Please note that the most recent version will allow to create a debugging log file that might be quite interesting...<br /></p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>The strange thing is, I setup everything correctly according to the <a href="https://wiki.openwrt.org/doc/howto/sqm">Wiki</a>: I measured my speed using <a href="http://www.speedtest.net/">SpeedTest</a>, setup my Download/Upload speed to 90% of the speed measured there, used defaults from Queue Discipline tab, put ATM in Link Layer Adaptation and set overhead to 44.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; 44 is typically not a bad starting point, but if you really want to figure out how much overhead is used, have a look at <a href="https://github.com/moeller0/ATM_overhead_detector">https://github.com/moeller0/ATM_overhead_detector</a> to measure your actual overhead (note this should not be the reason for your issues). But if you use the link layer adjustments on an ATM link you should start with say 90% of the link rate not the measured rate as the ATM link layer adjustment effectively will reduce the bandwidth by roughly 10% (to account for ATM&#039;s 48/53 encoding), but the measured rates have these 10% already figured in, so I recommend to start with 90% of link rate and reduce that further if latency under load is still to high.</p><p>&nbsp; &nbsp; &nbsp; &nbsp;Could you please post the result from running the following commands on the router (via ssh):<br />cat /etc/config/sqm<br />tc -d qdisc<br />/etc/init.d/sqm stop<br />/etc/init.d/sqm start</p><p>Also have a look at the output of &quot;top -d 1&quot; and look at the second line from the top, which will look similar to:<br />Mem: 43364K used, 17324K free, 1556K shrd, 11464K buff, 4804K cached<br />CPU:&nbsp; &nbsp;0% usr&nbsp; &nbsp;1% sys&nbsp; &nbsp;0% nic&nbsp; 98% idle&nbsp; &nbsp;0% io&nbsp; &nbsp;0% irq&nbsp; &nbsp;0% sirq</p><p>Then run a speedtest and look at the values of idle and sirq, if under load idle is at 0% and sirq high than your router might be overloaded by the SQM and WLAN? load, if not we should have a decent chance of improving matters... (note press control-c to end top again.) I would be amazed though if your router would not be able to shape traffic at the combined 6 Mbps your link seems to require.</p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>However, my Download speed slowed to a crawl: something like 600<strong>kbps</strong> in SpeedTest (my normal speed is something like 15000kbps). <a href="https://www.dslreports.com/speedtest">DSLReports</a> didn&#039;t even finish the test, and the bufferbloat skyrocket to something like 500ms+. I tried to disable Link Layer Adaptation, reduce both my Download and Upload speed (to 80%, and in one case even 60% of measured speed), however it does not seem to fix the issue.</p><p>What I find curious is if I set my Upload speed to 0 in sqm-scripts it seems to works. I have a small impact in speed (10000/700 vs 15000/1000 without sqm) and DSLReports finishes properly giving me a A for Bufferbloat. Setting Download speed to 0 too does not make much difference compared to the calculated value that I obtained before (15000*0.9=13500).</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; Setting the bandwidth for one direction to zero effectively disables sqm in that direction, so this points at the uplink direction being the culprit, setting both to zero should be exactly equal to sqm being disabled completely...<br /></p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>So I want to know if setting Upload to 0 is ok (and maybe Download too) or is there something wrong that I missed in my setup. I can provide additional information if it helps.</p></blockquote></div><p>Well setting both to 0 is just an opaque way of disabling sqm completely... So given that downstream shaping seems to work okay we should concentrate on the upstream (which in theory should be easier <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /> ). Could you please post the information I asked for above? Hopefully we can fix this issue for you...</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>											<p class="post-edited">(Last edited by <strong>moeller0</strong> on 14 May 2016, 23:39)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323884">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						14 May 2016, 23:40					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>Well, just something I forget: I tried to set my interface to eth0 and wan. It is not really clear to me what is the correct interface to set sqm-scripts (I think it is eth0, however I am not sure).</p></blockquote></div><p>Interesting, on CC and trunk I would have assumed the correct interface to be pppoe-wan, maybe after updating sqm-scripts from github pppoe-wan appears in the interface selection list?</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323901">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">m45t3r</div>
					<div class="post-datetime">
						15 May 2016, 00:56					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for the help.</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; I would recommend to try to update to the most recent sqm-scripts version manually, no matter whether you use BB or CC (as I believe only trunk/DD has a recent version in the repository). The following link should show you how to do this: <a href="https://github.com/tohojo/sqm-scripts">https://github.com/tohojo/sqm-scripts</a><br />&nbsp; &nbsp; &nbsp; &nbsp; Please note that the most recent version will allow to create a debugging log file that might be quite interesting...</p></blockquote></div><p>I will try to backport just this package to BB. I tried to compile DD however even disabling IPv6 was not enough to fit everything I needed in my image (that is basically luci, luci-app-sqm and luci-app-upnp), since my router has only 4MB of Flash. Even CC is too big for my router since I want to setup IPv6 (it seems my ISP finally supports it, since I got an IPv6 when I tried my custom compiled BB with IPv6 support).</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; 44 is typically not a bad starting point, but if you really want to figure out how much overhead is used, have a look at <a href="https://github.com/moeller0/ATM_overhead_detector">https://github.com/moeller0/ATM_overhead_detector</a> to measure your actual overhead (note this should not be the reason for your issues). But if you use the link layer adjustments on an ATM link you should start with say 90% of the link rate not the measured rate as the ATM link layer adjustment effectively will reduce the bandwidth by roughly 10% (to account for ATM&#039;s 48/53 encoding), but the measured rates have these 10% already figured in, so I recommend to start with 90% of link rate and reduce that further if latency under load is still to high.</p></blockquote></div><p>I will try to measure the actual overhead, however even disabling this option resulted in the same problem.</p><p>And I tried reducing Download/Upload speed to 80% of the measured speed and even reduced my upload speed to 60% when I discovered the problem was only when Upload speed was anything different of 0. I still had the same issue of having a absurdly low download speed after sqm was on.</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp;Could you please post the result from running the following commands on the router (via ssh):<br />cat /etc/config/sqm<br />tc -d qdisc<br />/etc/init.d/sqm stop<br />/etc/init.d/sqm start</p><p>Also have a look at the output of &quot;top -d 1&quot; and look at the second line from the top, which will look similar to:<br />Mem: 43364K used, 17324K free, 1556K shrd, 11464K buff, 4804K cached<br />CPU:&nbsp; &nbsp;0% usr&nbsp; &nbsp;1% sys&nbsp; &nbsp;0% nic&nbsp; 98% idle&nbsp; &nbsp;0% io&nbsp; &nbsp;0% irq&nbsp; &nbsp;0% sirq</p><p>Then run a speedtest and look at the values of idle and sirq, if under load idle is at 0% and sirq high than your router might be overloaded by the SQM and WLAN? load, if not we should have a decent chance of improving matters... (note press control-c to end top again.) I would be amazed though if your router would not be able to shape traffic at the combined 6 Mbps your link seems to require.</p></blockquote></div><p>I will do it when I have some spare time. I need to have everyone in the house sleeping or something or I will have angry users saying that the &quot;internet is not working&quot; for them. For now I got back to Gargoyle since it seems to be working fine.</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; Setting the bandwidth for one direction to zero effectively disables sqm in that direction, so this points at the uplink direction being the culprit, setting both to zero should be exactly equal to sqm being disabled completely...</p></blockquote></div><p>From what I understand from documentation, yes. However, even putting 0 in both Download and Upload I still had some effect in bufferbloat and total bandwidth. With sqm disabled I have 13500/1000 kbps of bandwidth and get an C~D in bufferbloat in DSLReports test. With sqm enabled and both Download and Upload in 0 I got 10000/700 of bandwidth and an A in bufferbloat in DSLReports.</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>Interesting, on CC and trunk I would have assumed the correct interface to be pppoe-wan, maybe after updating sqm-scripts from github pppoe-wan appears in the interface selection list?</p></blockquote></div><p>I remember I tried this one too when I was testing another time, and still had the same issue. Anyway, maybe it would be better to improve the documentation in the Wiki if pppoe-wan is the correct interface? The documentation is confusing in this part.</p>											<p class="post-edited">(Last edited by <strong>m45t3r</strong> on 15 May 2016, 01:01)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323903">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						15 May 2016, 01:05					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>Thanks for the help.<br />I remember I tried this one too when I was testing another time, and still had the same issue. Anyway, maybe it would be better to improve the documentation in the Wiki if pppoe-wan is the correct interface? The documentation is confusing in this part.</p></blockquote></div><p>Well, the correct interface really depends on what a user wants to do, so there is no &quot;a priori&quot; right or wrong it really depends on what one wants to do. The wiki (which I have no write access to) could maybe use a few more examples, but given that older sqm-scripts version will not even list pppoe-XXX devices in the first place I believe user confusion can not be fully avoided...</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323904">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">m45t3r</div>
					<div class="post-datetime">
						15 May 2016, 01:13					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>Thanks for the help.<br />I remember I tried this one too when I was testing another time, and still had the same issue. Anyway, maybe it would be better to improve the documentation in the Wiki if pppoe-wan is the correct interface? The documentation is confusing in this part.</p></blockquote></div><p>Well, the correct interface really depends on what a user wants to do, so there is no &quot;a priori&quot; right or wrong it really depends on what one wants to do. The wiki (which I have no write access to) could maybe use a few more examples, but given that older sqm-scripts version will not even list pppoe-XXX devices in the first place I believe user confusion can not be fully avoided...</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p></blockquote></div><p>Well, it does list pppoe-wan, I did not try because I thought it was the wrong interface.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323905">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						15 May 2016, 01:24					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>Thanks for the help.</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp;Could you please post the result from running the following commands on the router (via ssh):<br />cat /etc/config/sqm<br />tc -d qdisc<br />/etc/init.d/sqm stop<br />/etc/init.d/sqm start</p><p>Also have a look at the output of &quot;top -d 1&quot; and look at the second line from the top, which will look similar to:<br />Mem: 43364K used, 17324K free, 1556K shrd, 11464K buff, 4804K cached<br />CPU:&nbsp; &nbsp;0% usr&nbsp; &nbsp;1% sys&nbsp; &nbsp;0% nic&nbsp; 98% idle&nbsp; &nbsp;0% io&nbsp; &nbsp;0% irq&nbsp; &nbsp;0% sirq</p><p>Then run a speedtest and look at the values of idle and sirq, if under load idle is at 0% and sirq high than your router might be overloaded by the SQM and WLAN? load, if not we should have a decent chance of improving matters... (note press control-c to end top again.) I would be amazed though if your router would not be able to shape traffic at the combined 6 Mbps your link seems to require.</p></blockquote></div><p>I will do it when I have some spare time. I need to have everyone in the house sleeping or something or I will have angry users saying that the &quot;internet is not working&quot; for them. For now I got back to Gargoyle since it seems to be working fine.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; At least the first two will have no affect on the network availability and your users will not notice at all (or you have bigger issues than sqm configuration <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /> ) The 3rd and fourth will simply shortly diasbale and re-enable sqm internet connectivity will be preserved, out of courtesy I would not run this while everyone else saturates the network, but even then this will probably not be noticeable to users of your network... The final speed test while watching top output, is best run during low useage times though.<br /></p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; Setting the bandwidth for one direction to zero effectively disables sqm in that direction, so this points at the uplink direction being the culprit, setting both to zero should be exactly equal to sqm being disabled completely...</p></blockquote></div><p>From what I understand from documentation, yes. However, even putting 0 in both Download and Upload I still had some effect in bufferbloat and total bandwidth. With sqm disabled I have 13500/1000 kbps of bandwidth and get an C~D in bufferbloat in DSLReports test. With sqm enabled and both Download and Upload in 0 I got 10000/700 of bandwidth and an A in bufferbloat in DSLReports.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; Well, I just checked, we actually still do some iptables things when both are set to zero... Do you by any chance also have qos-scripts installed and enabled or gargoyle for that matter?<br /></p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>Interesting, on CC and trunk I would have assumed the correct interface to be pppoe-wan, maybe after updating sqm-scripts from github pppoe-wan appears in the interface selection list?</p></blockquote></div><p>I remember I tried this one too when I was testing another time, and still had the same issue. Anyway, maybe it would be better to improve the documentation in the Wiki if pppoe-wan is the correct interface? The documentation is confusing in this part.</p></blockquote></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323907">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">m45t3r</div>
					<div class="post-datetime">
						15 May 2016, 01:31					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; At least the first two will have no affect on the network availability and your users will not notice at all (or you have bigger issues than sqm configuration <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /> ) The 3rd and fourth will simply shortly diasbale and re-enable sqm internet connectivity will be preserved, out of courtesy I would not run this while everyone else saturates the network, but even then this will probably not be noticeable to users of your network... The final speed test while watching top output, is best run during low useage times though.</p></blockquote></div><p>The actual problem is that I need to first change my firmware (I am using Gargoyle now), port every configuration from Gargoyle to OpenWRT and after that I can test these changes. This means that the internet when I am testing this configuration is unrealiable and there is another person in the house that play Dota2, and he does not like when the internet is unrealible <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" />.</p><p>Actually, the fact that he plays Dota2 and I play LoL and Tree of Savior is the main motive that I am running Gargoyle/OpenWRT in my home router. It was unbearable to play when someone started to watch YouTube, download torrents, etc.</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; Well, I just checked, we actually still do some iptables things when both are set to zero... Do you by any chance also have qos-scripts installed and enabled or gargoyle for that matter?</p></blockquote></div><p>Nope, just checked and there is no qos-scripts installed. Gargoyle is my other firmware, so when I install OpenWRT there is no trace of Gargoyle anyome.</p>											<p class="post-edited">(Last edited by <strong>m45t3r</strong> on 15 May 2016, 08:52)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323927">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">m45t3r</div>
					<div class="post-datetime">
						15 May 2016, 08:54					</div>
				</div>
				<div class="post-content content">
					<p>So I run the ATM test, got the following results:<br /><a href="http://imgur.com/a/7t4st">http://imgur.com/a/7t4st</a></p><p>And according to <a href="https://web.archive.org/web/20150606220856/http://ace-host.stuart.id.au/russell/files/tc/tc-atm/">here</a> I should set my Link Overhead to 40?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323939">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						15 May 2016, 11:05					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>Thanks for the help.<br />I remember I tried this one too when I was testing another time, and still had the same issue. Anyway, maybe it would be better to improve the documentation in the Wiki if pppoe-wan is the correct interface? The documentation is confusing in this part.</p></blockquote></div><p>Well, the correct interface really depends on what a user wants to do, so there is no &quot;a priori&quot; right or wrong it really depends on what one wants to do. The wiki (which I have no write access to) could maybe use a few more examples, but given that older sqm-scripts version will not even list pppoe-XXX devices in the first place I believe user confusion can not be fully avoided...</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p></blockquote></div><p>Well, it does list pppoe-wan, I did not try because I thought it was the wrong interface.</p></blockquote></div><p>Ah good that pppoe-wan shows up. So assuming pppoe-wan actually uses eth0, you can instantiate sqm on either interface, only the sorting into multiple tiers only works if you use pppoe-wan (in this specific case) as our filters currently can not look past the PPPoE headers. So pppoe-wan is prefereable if you want to use say simple.qos instead of simplest.qos...</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323941">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						15 May 2016, 11:16					</div>
				</div>
				<div class="post-content content">
					<p>Hi m45t3r,</p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; At least the first two will have no affect on the network availability and your users will not notice at all (or you have bigger issues than sqm configuration <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /> ) The 3rd and fourth will simply shortly diasbale and re-enable sqm internet connectivity will be preserved, out of courtesy I would not run this while everyone else saturates the network, but even then this will probably not be noticeable to users of your network... The final speed test while watching top output, is best run during low useage times though.</p></blockquote></div><p>The actual problem is that I need to first change my firmware (I am using Gargoyle now), port every configuration from Gargoyle to OpenWRT and after that I can test these changes. This means that the internet when I am testing this configuration is unrealiable and there is another person in the house that play Dota2, and he does not like when the internet is unrealible <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" />.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; Ah, I see ad agree that is a network disruption long enough to warrant scheduling it into light usage times and coordinate with other users. BTW you can make a copy of the &quot;/overlay/&quot; directory of your router just after installing and configuring openwrt, and then after a reflash simply copy the saved /overlay back onto the router and reboot. That will give you all your configurations back, but this will only work as long as the old and new openwrt versions stay reasonably close. <br /></p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>Actually, the fact that he plays Dota2 and I play LoL and Tree of Savior is the main motive that I am running Gargoyle/OpenWRT in my home router. It was unbearable to play when someone started to watch YouTube, download torrents, etc.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; Please note that currently SQM does not work too well with heavy bit-torrents, we have an experimental qdisc, called cake. that promises to solve that problem, but not enough data to proof it actually does (cake also requires you to build your own firmware...)<br /></p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><br /><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; Well, I just checked, we actually still do some iptables things when both are set to zero... Do you by any chance also have qos-scripts installed and enabled or gargoyle for that matter?</p></blockquote></div><p>Nope, just checked and there is no qos-scripts installed. Gargoyle is my other firmware, so when I install OpenWRT there is no trace of Gargoyle anyome.</p></blockquote></div><p>Good, as running different qos/sqm instances concurrently on the same interface will not work (running them on different physical interfaces will be fine). So that looks like a pure sqm hick-up you are encountering, at least we can ignore qos and gargoyle as culprits <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" />.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323944">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						15 May 2016, 11:30					</div>
				</div>
				<div class="post-content content">
					<p>Hi m45t3r,</p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>So I run the ATM test, got the following results:<br /><a href="http://imgur.com/a/7t4st">http://imgur.com/a/7t4st</a></p><p>And according to <a href="https://web.archive.org/web/20150606220856/http://ace-host.stuart.id.au/russell/files/tc/tc-atm/">here</a> I should set my Link Overhead to 40?</p></blockquote></div><p>So this is weird, this clearly is an ATM link (but you knew that before <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /> ) but I have never seen an overhead of 39 being detected/reported. Could I ask you to repeat the measurement with a higher number of repetition (like 10 times more?)) just to be sure sure about the value? If the actual overhead is reliably and repeatedly reported as 39 then I would set it to 39, not 40. BTW the reason why I believe in empirically determining the overhead is exactly because ISPs have a lot of leeway in setting up their systems...<br />&nbsp; &nbsp; &nbsp; &nbsp; BUT the kernel often adds a bit overhead by itself automatically which should be accounted for, reducing the overhead setting from the nominal 39... (not taking this into account will only cost you a bit of bandwidth, but will not affect the latency under load; if the overhead is selected too low however, latency under load will suffer while bandwidth is spared) I am happy to help you get this set correctly, but this certainly is secondary to your real issue, so in short the overhead of 44 you used, certainly should not have affected latency under load adversely.</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p324301">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">m45t3r</div>
					<div class="post-datetime">
						17 May 2016, 16:40					</div>
				</div>
				<div class="post-content content">
					<p>So I tried again today (sorry for the late reply, needed sometime alone in the house when nobody was using the internet). Did everything the same as I did last time, the only change is that I used pppoe-wan instead of wan in interface. And it seems to work.</p><p>I may optimize the configuration later (for example, trying to calculate the overhead again), however for now I am very happy with the results. Thanks @moeller0.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p324308">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">m45t3r</div>
					<div class="post-datetime">
						17 May 2016, 17:46					</div>
				</div>
				<div class="post-content content">
					<p>It seems to be working great. Even better than Gargoyle QoS.</p><p>Trying to download Ubuntu ISO via torrent in one notebook and League of Legends running in another one. League of Legends ping vary from 43-48 if only download is stressed, or , 43-60 if upload is stressed too. Gargoyle used to vary more. And my torrent speed is even greater (1,4MB/s, where in Gargoyle I would get 1MB/s). I can even open YouTube, it will reduce the resolution however will start to play almost instantly.</p><p>Sqm is really great, thanks for the developers.</p>											<p class="post-edited">(Last edited by <strong>m45t3r</strong> on 17 May 2016, 17:48)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p324311">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						17 May 2016, 18:00					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>So I tried again today (sorry for the late reply, needed sometime alone in the house when nobody was using the internet). Did everything the same as I did last time, the only change is that I used pppoe-wan instead of wan in interface. And it seems to work.</p><p>I may optimize the configuration later (for example, trying to calculate the overhead again), however for now I am very happy with the results. Thanks @moeller0.</p></blockquote></div><br /><p>Hi m45ter,</p><p>excellent, great that it works. It seems I need to contact Rich to amend the wiki to make it clear that on a ppoe link the pppoe-XXX interface should be used... <br />&nbsp; &nbsp; &nbsp; &nbsp; If you should want to revisit the overhead determination just post onto anew thread, I will try to respond there as well.</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p324312">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						17 May 2016, 18:02					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>It seems to be working great. Even better than Gargoyle QoS.</p><p>Trying to download Ubuntu ISO via torrent in one notebook and League of Legends running in another one. League of Legends ping vary from 43-48 if only download is stressed, or , 43-60 if upload is stressed too. Gargoyle used to vary more. And my torrent speed is even greater (1,4MB/s, where in Gargoyle I would get 1MB/s). I can even open YouTube, it will reduce the resolution however will start to play almost instantly.</p><p>Sqm is really great, thanks for the developers.</p></blockquote></div><br /><p>Now that is great to hear, but in case this will detoriate over time, please do not hesitate to resurrect this thread. If you consider this solved for now it would be excellent if you could add a &quot;[SOLVED]&quot; to the topic, so people finding this via google/search will directly see that this might lead to a solution <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p324319">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">m45t3r</div>
					<div class="post-datetime">
						17 May 2016, 18:49					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>Now that is great to hear, but in case this will detoriate over time, please do not hesitate to resurrect this thread. If you consider this solved for now it would be excellent if you could add a &quot;[SOLVED]&quot; to the topic, so people finding this via google/search will directly see that this might lead to a solution <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p></blockquote></div><p>Done <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" />.</p>											<p class="post-edited">(Last edited by <strong>m45t3r</strong> on 17 May 2016, 18:49)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p325869">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">m45t3r</div>
					<div class="post-datetime">
						26 May 2016, 02:37					</div>
				</div>
				<div class="post-content content">
					<p>Well, I switched to CC now, because fq_codel does not seem to help too much with torrents. While downloading torrents seems fine, uploading them seems to increase the latency very bad (I got 10k of ping one time when playing games while another tenant was using torrent).</p><p>So I included cake using ceropackages-3.10 repository, build the lastest CC trunk, and I am using sqm-scripts with cake as queue discipline. One quick test with torrent focused in upload and cake seems to be working much better: the ping jitter is higher when the line is under load (compared to fq_codel),&nbsp; varying from 40~65ms (and some outliners of 90ms), however at least it does not drop packets like crazy and get pings of 200~400ms.</p><p>I am curious about the difference of queue setup scripts for cake, though. There is layer_cake and piece_of_cake, and I did not found descriptions about them anywhere in the internet of the difference between them (except of the small description that acompany them, not really helpful though). Looking at the code, seems that piece_of_cake is much simpler, while layer_cake tries to set some kind of multiple queue? This queue (diffserv4), as far I understand searching online, is what may help cake fight torrents? Can someone enlighten me?</p><p>For now I am testing piece_of_cake, I am having some difficults on generating traffic in torrent (read: need a torrent with a good number of leechers) to test how effective it is against torrents. My test above was mostly with layer_cake, however I did not like the comments in layer_cake script (some of them are scary things like &quot;I think this is not necessary anymore&quot; or other things like that).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p325924">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						26 May 2016, 11:17					</div>
				</div>
				<div class="post-content content">
					<p>Hi m45t3r,</p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>Well, I switched to CC now, because fq_codel does not seem to help too much with torrents. While downloading torrents seems fine, uploading them seems to increase the latency very bad (I got 10k of ping one time when playing games while another tenant was using torrent).</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; This is somewhat strange as typically the upload direction is easier to control, but torrents are a pain for flow-fair queueing...<br /></p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>So I included cake using ceropackages-3.10 repository, build the lastest CC trunk, and I am using sqm-scripts with cake as queue discipline. One quick test with torrent focused in upload and cake seems to be working much better: the ping jitter is higher when the line is under load (compared to fq_codel),&nbsp; varying from 40~65ms (and some outliners of 90ms), however at least it does not drop packets like crazy and get pings of 200~400ms.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; Great that cake works for you. Especially since you have one of the critical torrent test-cases at hand! Now it would be intersting if you could remind me what king of router you use (especially which CPU and how much RAM) and how the torrenter is connected (via WIFI/WLAN or via LAN)?<br />&nbsp; &nbsp; &nbsp; &nbsp; It would be intersting to see the output of:<br />tc -d qdisc # this will show the general configuration of the cake instances<br />tc -s qdisc # this will yield usage statistics for the cake instances<br />top -n 1 # this will (hopefully) show whether your load already saturates your CPU<br />tc qdisc add cake help # this will show which key-words your tc/cake combination will accept<br />both for a quite network as well as with heavy torrenting going on... Cake has a new mode called triple-isolate that promises to keep torrents better in check, and I am curious whether your cake built is recent enough, if the output of the last command looks like:<br /></p><div class="codebox"><pre><code>user@router:~# tc qdisc add cake help
Usage: ... cake [ bandwidth RATE | unlimited* | autorate_ingress ]
                [ rtt TIME | datacentre | lan | metro | regional | internet* | oceanic | satellite | interplanetary ]
                [ besteffort | precedence | diffserv8 | diffserv4* ]
                [ flowblind | srchost | dsthost | hosts | flows* | dual-srchost | dual-dsthost | triple-isolate ]
                [ atm | noatm* ] [ overhead N | conservative | raw* ]
                [ wash | nowash* ]
                [ memlimit LIMIT ]
    (* marks defaults)</code></pre></div><p>So, if it contains the &quot;triple-isolate&quot; keyword, could I convince you to put that word into both of the two fields in the sqm luci app that read &quot;Advanced option string to pass to the ingress/egress queueing disciplines; no error checking, use very carefully.&quot; And then test the router behaviour and feel under load again, please?<br /></p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>I am curious about the difference of queue setup scripts for cake, though. There is layer_cake and piece_of_cake, and I did not found descriptions about them anywhere in the internet of the difference between them (except of the small description that acompany them, not really helpful though). Looking at the code, seems that piece_of_cake is much simpler, while layer_cake tries to set some kind of multiple queue? This queue (diffserv4), as far I understand searching online, is what may help cake fight torrents? Can someone enlighten me?</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; piece_of_cake is simply a single one-tier cake instance on both ingress and egress, it does not get much simpler than that. layer_cake is a multi-tier setup (layers refer priority bands in this &quot;pun&quot; of a name, cake itself calls these &quot;tins&quot; as cake can come in tins, but better not in queues or buckets <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" />) where the mapping between tier/layer is based on DSCP markings in the packets. Unfortunately none of the popular bit-torrent clients allows the user to actually set DSCP marks and hence this multi-tin design which (also works without cake in simple.qos) does not really help with the torrent issue. Side-note torrent developers have established a nice UDP-based protocol that will take increased queue duration as a congestion signal and will scale traffic back to stay in the back ground, unfortunately any AQM worth its salt will eradicate the obscene increases in queue latency and so torrent traffic will happily keep flooding your link...<br /></p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>For now I am testing piece_of_cake, I am having some difficults on generating traffic in torrent (read: need a torrent with a good number of leechers) to test how effective it is against torrents. My test above was mostly with layer_cake, however I did not like the comments in layer_cake script (some of them are scary things like &quot;I think this is not necessary anymore&quot; or other things like that).</p></blockquote></div><p>Actually the only interesting comment left is:<br />&nbsp; &nbsp;# Not sure if this will work. Encapsulation is a problem period<br />&nbsp; &nbsp; ipt -t mangle -I PREROUTING -i vtun+ -p tcp -j MARK --set-mark 0x2/${IPT_MASK} # tcp tunnels need ordering<br />and I truly do not know whether that works so I agree with the comment, maybe it is time to remove that line and see whether anybody complains <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /><br />Please keep testing this, we really need a good torrent work-out for cake to see whether triple-isolate finally manages to squash this issue..</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p326501">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">m45t3r</div>
					<div class="post-datetime">
						30 May 2016, 22:33					</div>
				</div>
				<div class="post-content content">
					<p>Ok, I think I said too soon. Got a new test case, I could load both download AND upload using torrents (seeding multiple recent anime torrents, downloading Ubuntu 16.04 desktop and server images). Cake does maintained a low ping, however I started to have tons of package loss or something (League of Legends started to have &quot;You have been disconnected&quot; messages, Tree of Savior got really unresponsible, both with relatively low pings when I could actually ping, web pages was having delays of 10 seconds+).</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; This is somewhat strange as typically the upload direction is easier to control, but torrents are a pain for flow-fair queueing...</p></blockquote></div><p>Maybe it was only download and I was mistaking with upload, don&#039;t remember. At least with cake, only upload at full load does not seem to impact the internet too much, however download at full load (torrent in both cases) does.</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; Great that cake works for you. Especially since you have one of the critical torrent test-cases at hand! Now it would be intersting if you could remind me what king of router you use (especially which CPU and how much RAM) and how the torrenter is connected (via WIFI/WLAN or via LAN)?</p></blockquote></div><p>It is a <a href="https://wiki.openwrt.org/toh/tp-link/tl-wr941nd">TL-WR941NDv3.6</a>. An AR9103 CPU at 400MHz, 32MB of RAM. I did not experience any load in CPU even at full load of my ADSL2+ line (14Mbps/1Mbps, so around 15Mbps of total bandwidth), remember seeing top and was still at 0~1% of CPU usage. My PC is connected using Ethernet LAN.</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; It would be intersting to see the output of:<br />tc -d qdisc # this will show the general configuration of the cake instances<br />tc -s qdisc # this will yield usage statistics for the cake instances<br />top -n 1 # this will (hopefully) show whether your load already saturates your CPU<br />tc qdisc add cake help # this will show which key-words your tc/cake combination will accept<br />both for a quite network as well as with heavy torrenting going on... Cake has a new mode called triple-isolate that promises to keep torrents better in check, and I am curious whether your cake built is recent enough, if the output of the last command looks like:<br /></p><div class="codebox"><pre><code>user@router:~# tc qdisc add cake help
Usage: ... cake [ bandwidth RATE | unlimited* | autorate_ingress ]
                [ rtt TIME | datacentre | lan | metro | regional | internet* | oceanic | satellite | interplanetary ]
                [ besteffort | precedence | diffserv8 | diffserv4* ]
                [ flowblind | srchost | dsthost | hosts | flows* | dual-srchost | dual-dsthost | triple-isolate ]
                [ atm | noatm* ] [ overhead N | conservative | raw* ]
                [ wash | nowash* ]
                [ memlimit LIMIT ]
    (* marks defaults)</code></pre></div><p>So, if it contains the &quot;triple-isolate&quot; keyword, could I convince you to put that word into both of the two fields in the sqm luci app that read &quot;Advanced option string to pass to the ingress/egress queueing disciplines; no error checking, use very carefully.&quot; And then test the router behaviour and feel under load again, please?</p></blockquote></div><p>Yeah it does:</p><div class="codebox"><pre><code>Usage: ... cake [ bandwidth RATE | unlimited* | autorate_ingress ]
                [ rtt TIME | datacentre | lan | metro | regional | internet* | oceanic | satellite | interplanetary ]
                [ besteffort | precedence | diffserv8 | diffserv4* ]
                [ flowblind | srchost | dsthost | hosts | flows* | dual-srchost | dual-dsthost | triple-isolate ]
                [ atm | noatm* ] [ overhead N | conservative | raw* ]
                [ wash | nowash* ]
                [ memlimit LIMIT ]
    (* marks defaults)</code></pre></div><p>I will try it, lets hope it solves my problem (because even Gargoyle is having an issue to maintain my internet usable at this situation).</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; piece_of_cake is simply a single one-tier cake instance on both ingress and egress, it does not get much simpler than that. layer_cake is a multi-tier setup (layers refer priority bands in this &quot;pun&quot; of a name, cake itself calls these &quot;tins&quot; as cake can come in tins, but better not in queues or buckets <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" />) where the mapping between tier/layer is based on DSCP markings in the packets. Unfortunately none of the popular bit-torrent clients allows the user to actually set DSCP marks and hence this multi-tin design which (also works without cake in simple.qos) does not really help with the torrent issue. Side-note torrent developers have established a nice UDP-based protocol that will take increased queue duration as a congestion signal and will scale traffic back to stay in the back ground, unfortunately any AQM worth its salt will eradicate the obscene increases in queue latency and so torrent traffic will happily keep flooding your link...</p></blockquote></div><p>So I will set piece_of_cake for now, and will include the triple-isolate to see if it helps. Thanks.</p><p>P.S.: sorry for the late reply, I unsubscribed from this topic after I got fq_codel working. Subscribed again so I can answer faster.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p326502">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">m45t3r</div>
					<div class="post-datetime">
						30 May 2016, 22:35					</div>
				</div>
				<div class="post-content content">
					<p>So here we go:</p><div class="codebox"><pre><code>root@PensionatoButui:/usr/lib/sqm# tc qdisc
qdisc fq_codel 0: dev eth0 root refcnt 2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc mq 0: dev wlan0 root 
qdisc fq_codel 0: dev wlan0 parent :1 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc fq_codel 0: dev wlan0 parent :2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc fq_codel 0: dev wlan0 parent :3 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc fq_codel 0: dev wlan0 parent :4 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc cake 800d: dev pppoe-wan root refcnt 2 bandwidth 850Kbit besteffort triple-isolate rtt 100.0ms raw 
qdisc ingress ffff: dev pppoe-wan parent ffff:fff1 ---------------- 
qdisc cake 800e: dev ifb4pppoe-wan root refcnt 2 bandwidth 13500Kbit besteffort triple-isolate rtt 100.0ms raw </code></pre></div><p>I will try to reproduce my test above (loading both upload and download with torrents) and will report back.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p326506">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						30 May 2016, 23:20					</div>
				</div>
				<div class="post-content content">
					<p>Hi m45t3r,</p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>Ok, I think I said too soon.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp;Too bad.<br /></p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p> Got a new test case, I could load both download AND upload using torrents (seeding multiple recent anime torrents, downloading Ubuntu 16.04 desktop and server images).</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp;Good, that is pretty much (one of) the worst case scenario(s) so if that works reasonably well, you should be okay.<br /></p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p> Cake does maintained a low ping,</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; That sounds also like cake is at least doing something.<br /></p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>however I started to have tons of package loss or something (League of Legends started to have &quot;You have been disconnected&quot; messages, Tree of Savior got really unresponsible, both with relatively low pings when I could actually ping, web pages was having delays of 10 seconds+).</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; I believe there have been a few fixes to cake most recently that probably are not in your version, that might help a bit, I recall some symptoms were multi second stalls...<br /></p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><br /><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; This is somewhat strange as typically the upload direction is easier to control, but torrents are a pain for flow-fair queueing...</p></blockquote></div><p>Maybe it was only download and I was mistaking with upload, don&#039;t remember. At least with cake, only upload at full load does not seem to impact the internet too much, however download at full load (torrent in both cases) does.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; Interesting, ingress.download shaping is more approximate than egress/uplink shaping in general, how does this work if you ridiculously over-shape the downstream to say 7000Kbps? Downstream shaping works better the larger the difference between real bottleneck link and artificial bottleneck is. As in reality the shaper throttle sits on the wrong end of the problematic over-sized and under-managed buffers (typically on the ISP side either at the DSLAM or at the BRAS) Maybe you could give that a try and then slowly increase bandwidth again to find a trade-off you are happy with?<br /></p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; Great that cake works for you. Especially since you have one of the critical torrent test-cases at hand! Now it would be intersting if you could remind me what king of router you use (especially which CPU and how much RAM) and how the torrenter is connected (via WIFI/WLAN or via LAN)?</p></blockquote></div><p>It is a <a href="https://wiki.openwrt.org/toh/tp-link/tl-wr941nd">TL-WR941NDv3.6</a>. An AR9103 CPU at 400MHz, 32MB of RAM. I did not experience any load in CPU even at full load of my ADSL2+ line (14Mbps/1Mbps, so around 15Mbps of total bandwidth), remember seeing top and was still at 0~1% of CPU usage. My PC is connected using Ethernet LAN.</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; Okay that is a bit anemic, but for your connection it seems plenty. BTW when testing with top, please look at the idle value and calculate CPU usaga as 100-idle.<br /></p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; It would be intersting to see the output of:<br />tc -d qdisc # this will show the general configuration of the cake instances<br />tc -s qdisc # this will yield usage statistics for the cake instances<br />top -n 1 # this will (hopefully) show whether your load already saturates your CPU<br />tc qdisc add cake help # this will show which key-words your tc/cake combination will accept<br />both for a quite network as well as with heavy torrenting going on... Cake has a new mode called triple-isolate that promises to keep torrents better in check, and I am curious whether your cake built is recent enough, if the output of the last command looks like:<br /></p><div class="codebox"><pre><code>user@router:~# tc qdisc add cake help
Usage: ... cake [ bandwidth RATE | unlimited* | autorate_ingress ]
                [ rtt TIME | datacentre | lan | metro | regional | internet* | oceanic | satellite | interplanetary ]
                [ besteffort | precedence | diffserv8 | diffserv4* ]
                [ flowblind | srchost | dsthost | hosts | flows* | dual-srchost | dual-dsthost | triple-isolate ]
                [ atm | noatm* ] [ overhead N | conservative | raw* ]
                [ wash | nowash* ]
                [ memlimit LIMIT ]
    (* marks defaults)</code></pre></div><p>So, if it contains the &quot;triple-isolate&quot; keyword, could I convince you to put that word into both of the two fields in the sqm luci app that read &quot;Advanced option string to pass to the ingress/egress queueing disciplines; no error checking, use very carefully.&quot; And then test the router behaviour and feel under load again, please?</p></blockquote></div><p>Yeah it does:</p><div class="codebox"><pre><code>Usage: ... cake [ bandwidth RATE | unlimited* | autorate_ingress ]
                [ rtt TIME | datacentre | lan | metro | regional | internet* | oceanic | satellite | interplanetary ]
                [ besteffort | precedence | diffserv8 | diffserv4* ]
                [ flowblind | srchost | dsthost | hosts | flows* | dual-srchost | dual-dsthost | triple-isolate ]
                [ atm | noatm* ] [ overhead N | conservative | raw* ]
                [ wash | nowash* ]
                [ memlimit LIMIT ]
    (* marks defaults)</code></pre></div><p>I will try it, lets hope it solves my problem (because even Gargoyle is having an issue to maintain my internet usable at this situation).</p></blockquote></div><p>&nbsp; &nbsp; &nbsp; &nbsp; I would be delighted to learn whether it does or does not work/improve things for you.<br /></p><div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><br /><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; piece_of_cake is simply a single one-tier cake instance on both ingress and egress, it does not get much simpler than that. layer_cake is a multi-tier setup (layers refer priority bands in this &quot;pun&quot; of a name, cake itself calls these &quot;tins&quot; as cake can come in tins, but better not in queues or buckets <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" />) where the mapping between tier/layer is based on DSCP markings in the packets. Unfortunately none of the popular bit-torrent clients allows the user to actually set DSCP marks and hence this multi-tin design which (also works without cake in simple.qos) does not really help with the torrent issue. Side-note torrent developers have established a nice UDP-based protocol that will take increased queue duration as a congestion signal and will scale traffic back to stay in the back ground, unfortunately any AQM worth its salt will eradicate the obscene increases in queue latency and so torrent traffic will happily keep flooding your link...</p></blockquote></div><p>So I will set piece_of_cake for now, and will include the triple-isolate to see if it helps. Thanks.</p><p>P.S.: sorry for the late reply, I unsubscribed from this topic after I got fq_codel working. Subscribed again so I can answer faster.</p></blockquote></div><p>No need to apologize, this is, I believe, a hobby for most of us, so needs to fit in with more important tasks/work...</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp; M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p326507">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">moeller0</div>
					<div class="post-datetime">
						30 May 2016, 23:22					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>m45t3r wrote:</cite><blockquote><p>So here we go:</p><div class="codebox"><pre><code>root@PensionatoButui:/usr/lib/sqm# tc qdisc
qdisc fq_codel 0: dev eth0 root refcnt 2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc mq 0: dev wlan0 root 
qdisc fq_codel 0: dev wlan0 parent :1 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc fq_codel 0: dev wlan0 parent :2 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc fq_codel 0: dev wlan0 parent :3 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc fq_codel 0: dev wlan0 parent :4 limit 1024p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
qdisc cake 800d: dev pppoe-wan root refcnt 2 bandwidth 850Kbit besteffort triple-isolate rtt 100.0ms raw 
qdisc ingress ffff: dev pppoe-wan parent ffff:fff1 ---------------- 
qdisc cake 800e: dev ifb4pppoe-wan root refcnt 2 bandwidth 13500Kbit besteffort triple-isolate rtt 100.0ms raw </code></pre></div><p>I will try to reproduce my test above (loading both upload and download with torrents) and will report back.</p></blockquote></div><p>This looks promising, thanks for testing this!</p><p>Best Regards<br />&nbsp; &nbsp; &nbsp; &nbsp;M.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p326520">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">m45t3r</div>
					<div class="post-datetime">
						31 May 2016, 00:38					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>H<br />&nbsp; &nbsp; &nbsp; &nbsp; I believe there have been a few fixes to cake most recently that probably are not in your version, that might help a bit, I recall some symptoms were multi second stalls...</p></blockquote></div><p>I can try <a href="https://github.com/antoinedeschenes/openwrt-sqm">this repository</a> instead of ceropackages-3.10, it seems to have an up-to-date cake module. However I can&#039;t really try DD since I don&#039;t have much Flash.</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; Interesting, ingress.download shaping is more approximate than egress/uplink shaping in general, how does this work if you ridiculously over-shape the downstream to say 7000Kbps? Downstream shaping works better the larger the difference between real bottleneck link and artificial bottleneck is. As in reality the shaper throttle sits on the wrong end of the problematic over-sized and under-managed buffers (typically on the ISP side either at the DSLAM or at the BRAS) Maybe you could give that a try and then slowly increase bandwidth again to find a trade-off you are happy with?</p></blockquote></div><p>I tried 7000, League of Legends (a game that uses UDP packets) can still get disconnects. HTTP seems fine, though.</p><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; Okay that is a bit anemic, but for your connection it seems plenty. BTW when testing with top, please look at the idle value and calculate CPU usaga as 100-idle.</p></blockquote></div><p>I get something like this at load:<br /></p><div class="codebox"><pre><code>Mem: 24980K used, 4132K free, 596K shrd, 1748K buff, 5148K cached
CPU:   0% usr   0% sys   0% nic  78% idle   0% io   0% irq  20% sirq
Load average: 0.01 0.12 0.11 2/42 4270</code></pre></div><div class="quotebox"><cite>moeller0 wrote:</cite><blockquote><p>&nbsp; &nbsp; &nbsp; &nbsp; I would be delighted to learn whether it does or does not work/improve things for you.</p></blockquote></div><p>It does not seem to make much of difference. Reducing the ingress rate seems to help more than this option. However only reducing ingress rate does not help in League of Legends, only HTTP/HTTPS</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=64812&amp;p=2.html">2</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0.001 -->

</body>
</html>