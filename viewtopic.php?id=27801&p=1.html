<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Bricked WAG160Nv2 - bootloader says Download mode1111 ... press enter</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 2 Oct 2014 and 30 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 3</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=27801&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=27801&amp;p=3.html">3</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p123616">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">james.harper</div>
					<div class="post-datetime">
						21 Dec 2010, 12:28					</div>
				</div>
				<div class="post-content content">
					<p>I tried a 96358 image on a WAG160Nv2. The first few images linux said that the board wasn&#039;t supported on boot, but now it doesn&#039;t get that far and the bootloader says something like (yes, the spelling and grammer is exactly as printed on the serial console):</p><p>no pid2<br/>FIRMWARE HAD BEEN DESTORYED!!</p><p>Without prompting to press a key to drop into CFE.</p><p>The IP address 192.168.1.1 is pingable at this point but a TCP and UDP scan shows nothing is opened. The router does not send any packets either.</p><p>If i hold in the reset button on boot I get:</p><p>get pid at0xbfc0ff80<br/>SerialNumber53534831304b34303031333600<br/>Language:1000<br/>PinCode:3333363832323335<br/>bffe1000:a55a<br/>Download mode1111 ... press enter to stop</p><p>I&#039;m wondering if &#039;Download mode1111&#039; might mean I have an opportunity to load a new firmware via the serial port. I&#039;ve tried xmodem and a few other protocols but it never handshakes. Is JTAG (if it exists on this model) my only remaining option? I did take copies of the mtd images before I flashed anything.</p><p>thanks</p><p>James</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123655">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">james.harper</div>
					<div class="post-datetime">
						21 Dec 2010, 23:43					</div>
				</div>
				<div class="post-content content">
					<p>Full output on boot:</p><div class="codebox"><pre><code>CFE version 1.0.37-5.4 for BCM96358 (32bit,SP,BE)
Build Date: 2009å¹´ 03æ 31æ¥ ææäº 17:07:55 CST (root@localhost.localdomain)
Copyright (C) 2000-2005 Broadcom Corporation.

Boot Address 0xbfc00000

Initializing Arena.
Initializing Devices.
Parallel flash device: name MX29LV320AB, id 0x22a8, size 4096KB
798
875
0x6:0x11f
0x6:0x108
0x6:0x108
CPU type 0x2A010: 300MHz, Bus: 133MHz, Ref: 64MHz
Total memory: 33554432 bytes (32MB)

Total memory used by CFE:  0x80401000 - 0x80533000 (1253376)
Initialized Data:          0x8041C0E0 - 0x8041CDD0 (3312)
BSS Area:                  0x8041CDD0 - 0x80431000 (82480)
Local Heap:                0x80431000 - 0x80531000 (1048576)
Stack Area:                0x80531000 - 0x80533000 (8192)
Text (code) segment:       0x80401000 - 0x8041C0D8 (110808)
Boot area (physical):      0x00533000 - 0x00573000
Relocation Factor:         I:00000000 - D:00000000

Board IP address                  : 192.168.1.1
Host IP address                   : 192.168.1.253
Gateway IP address                :
Run from flash/host (f/h)         : f
Default host run file name        : vmlinux.lzma.cfe
Default host flash file name      : bcm963xx_fs_kernel
Boot delay (0-9 seconds)          : 1
Board Id Name                     : 96358GW
Psi size in KB                    : 24
Number of MAC Addresses (1-32)    : 10
Base MAC Address                  : 00:22:6b:ff:8c:f1
Ethernet PHY Type                 : Internal
Memory size in MB                 : 32
CMT Thread Number                 : 0

no pid2
WARNING!! - FIRMWARE HAD BEEN DESTORYED!!
            YOU NEED RE-DOWNLOAD FIRMWARE!!</code></pre></div><p>and when I hold down the reset button on boot:</p><div class="codebox"><pre><code>CFE version 1.0.37-5.4 for BCM96358 (32bit,SP,BE)
Build Date: 2009å¹´ 03æ 31æ¥ ææäº 17:07:55 CST (root@localhost.localdomain)
Copyright (C) 2000-2005 Broadcom Corporation.

Boot Address 0xbfc00000

Initializing Arena.
Initializing Devices.
Parallel flash device: name MX29LV320AB, id 0x22a8, size 4096KB
798
875
0x6:0x11f
0x6:0x108
0x6:0x108
CPU type 0x2A010: 300MHz, Bus: 133MHz, Ref: 64MHz
Total memory: 33554432 bytes (32MB)

Total memory used by CFE:  0x80401000 - 0x80533000 (1253376)
Initialized Data:          0x8041C0E0 - 0x8041CDD0 (3312)
BSS Area:                  0x8041CDD0 - 0x80431000 (82480)
Local Heap:                0x80431000 - 0x80531000 (1048576)
Stack Area:                0x80531000 - 0x80533000 (8192)
Text (code) segment:       0x80401000 - 0x8041C0D8 (110808)
Boot area (physical):      0x00533000 - 0x00573000
Relocation Factor:         I:00000000 - D:00000000

Board IP address                  : 192.168.1.1
Host IP address                   : 192.168.1.253
Gateway IP address                :
Run from flash/host (f/h)         : f
Default host run file name        : vmlinux.lzma.cfe
Default host flash file name      : bcm963xx_fs_kernel
Boot delay (0-9 seconds)          : 1
Board Id Name                     : 96358GW
Psi size in KB                    : 24
Number of MAC Addresses (1-32)    : 10
Base MAC Address                  : 00:22:6b:ff:8c:f1
Ethernet PHY Type                 : Internal
Memory size in MB                 : 32
CMT Thread Number                 : 0

get pid at0xbfc0ff80
SerialNumber53534831304b34303031333600
Language:1000
PinCode:3333363832323335
bffe1000:a55a
Download mode1111 ... press enter to stop</code></pre></div><p>Any suggestions?? Is this CFE giving me this or something else?</p><p>thanks</p><p>James</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123689">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">jal2</div>
					<div class="post-datetime">
						22 Dec 2010, 11:28					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>james.harper wrote:</cite><blockquote><p>Any suggestions?? Is this CFE giving me this or something else?</p></blockquote></div><p>I&#039;d guess this is the CFE. I doubt that the download mode refers to some protocol on the serial line,<br/>it&#039;s rather tftp over ethernet. Have you tried to upload a firmware using tftp?<br/></p><div class="codebox"><pre><code>tftp -i 192.168.1.1 put firmware.bin</code></pre></div><p>You might have to set your host&#039;s IP address to 192.168.1.253 before. If this doesn&#039;t work,<br/>sniff the ethernet on the LAN ports during power up. If you see any tftp requests from the device,<br/>you must run a tftp server on the host and provide the firmware in the requested filename.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123694">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						22 Dec 2010, 12:18					</div>
				</div>
				<div class="post-content content">
					<p>Run a tftp server at 192.168.1.253. File name should be bcm963xx_fs_kernel. As its name implies, it contains only kernel and rootfs (and a 256-byte header). In order to strip off the necessary part from the Linksys firmware, you need to understand the <a href="http://skaya.enix.org/wiki/FirmwareFormat">firmware format</a>.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123698">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">jal2</div>
					<div class="post-datetime">
						22 Dec 2010, 12:54					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>fyi wrote:</cite><blockquote><p>Run a tftp server at 192.168.1.253. File name should be bcm963xx_fs_kernel. As its name implies, it contains only kernel and rootfs (and a 256-byte header). In order to strip off the necessary part from the Linksys firmware, you need to understand the <a href="http://skaya.enix.org/wiki/FirmwareFormat">firmware format</a>.</p></blockquote></div><p>I had&nbsp; a look into <a href="http://downloads.linksysbycisco.com/downloads/firmware/1224645224484/WAG160Nv2-EU-ANNEXA-ETSI-2.00.20-code.zip">a annex.a firmware for the EU</a>. Seems like it starts with the loader and the header described in the link above is located at offset 0x10000. Do you really need to strip anything off?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123701">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">james.harper</div>
					<div class="post-datetime">
						22 Dec 2010, 13:32					</div>
				</div>
				<div class="post-content content">
					<p>Once in that crashed state it responds to pings but nothing else. Not tftp or anything else.</p><p>I have obtained the WRT54G DeBrick software (HairyDairyMaid) tool and have added 6358 to the list and it probes correctly about 80% of the time and I just get a garbled dump. I&#039;m using an unbuffered cable though and the docs do say that while it works on the WRT54G it is unknown if it could work on anything else.</p><p>I&#039;m going to tinker with the timings and hopefully will have something working before bedtime <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123706">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">jal2</div>
					<div class="post-datetime">
						22 Dec 2010, 14:26					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>james.harper wrote:</cite><blockquote><p>Once in that crashed state it responds to pings but nothing else. Not tftp or anything else.</p><p>I have obtained the WRT54G DeBrick software (HairyDairyMaid) tool and have added 6358 to the list and it probes correctly about 80% of the time and I just get a garbled dump. I&#039;m using an unbuffered cable though and the docs do say that while it works on the WRT54G it is unknown if it could work on anything else.</p><p>I&#039;m going to tinker with the timings and hopefully will have something working before bedtime <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p></blockquote></div><p>I recently used tjtag 3.0.1 with the DG834ND (BCM6358 inside), but with a wiggler clone. Tjtag supports the 6358 out of the box.<br/>IMHO cable lengths are critical with the unbuffered adapter. Keep them as short as possible.</p><p>Have you sniffed the ethernet traffic from the board during power up?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123708">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">james.harper</div>
					<div class="post-datetime">
						22 Dec 2010, 14:30					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>jal2 wrote:</cite><blockquote><p>I recently used tjtag 3.0.1 with the DG834ND (BCM6358 inside), but with a wiggler clone. Tjtag supports the 6358 out of the box.<br/>IMHO cable lengths are critical with the unbuffered adapter. Keep them as short as possible.</p></blockquote></div><p>Yeah I think mine might be too long. The openwrt docs suggest 15cm as a maximum and i&#039;m probably over that.</p><div class="quotebox"><cite>jal2 wrote:</cite><blockquote><p>Have you sniffed the ethernet traffic from the board during power up?</p></blockquote></div><p>Yes. Wireshark with the device plugged into my laptop. Nothing. It&#039;s really screwed now though since I flashed it with my dodgy jtag cable!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123746">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">jal2</div>
					<div class="post-datetime">
						23 Dec 2010, 00:17					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>james.harper wrote:</cite><blockquote><p>It&#039;s really screwed now though since I flashed it with my dodgy jtag cable!</p></blockquote></div><p>Any output on the serial port?<br/>If you want to stick to the unbuffered cable, use the shortest cable possible - on both sides of the adapter, i.e. to the parallel port as well.<br/>Try to use another PC to run the JTAG tool, if possible. Use another power supply for the target.<br/>You may also try <a href="http://www.tiaowiki.com/w/TJTAG">tjtag</a>.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123751">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">james.harper</div>
					<div class="post-datetime">
						23 Dec 2010, 00:52					</div>
				</div>
				<div class="post-content content">
					<p>No output from the serial port. Flash is completely scambled.</p><p>I cut off the cable to shorten it and found that the ground wire had come loose (or more likely, i&#039;d forgotten to attach it). Surprising it worked at all <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123755">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">james.harper</div>
					<div class="post-datetime">
						23 Dec 2010, 01:15					</div>
				</div>
				<div class="post-content content">
					<p>It&#039;s amazing how much better it works with the ground wire attached <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p><p>I have reflashed CFE with the original image but i&#039;m back to getting &quot;WARNING!! - FIRMWARE HAD BEEN DESTORYED!!&quot; messages and cannot see a way to break into CFE. I thought I was getting this because I&#039;d wiped CFE but now that CFE is back and I&#039;m getting the same thing I guess that&#039;s not the case. Any suggestions? It would suck to have to flash with JTAG every time!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123758">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">james.harper</div>
					<div class="post-datetime">
						23 Dec 2010, 03:00					</div>
				</div>
				<div class="post-content content">
					<p>I am now of the opinion that there is a bug in my CFE that causes it to crash when the rest of the firmware isn&#039;t entirely perfect. How can I get a later version than &quot;CFE version 1.0.37-5.4 for BCM96358 (32bit,SP,BE)&quot;?</p><p>I assume that the regular openwrt images don&#039;t include a CFE image.</p><p>thanks</p><p>James</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123762">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						23 Dec 2010, 05:25					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>jal2 wrote:</cite><blockquote><div class="quotebox"><cite>fyi wrote:</cite><blockquote><p>Run a tftp server at 192.168.1.253. File name should be bcm963xx_fs_kernel. As its name implies, it contains only kernel and rootfs (and a 256-byte header). In order to strip off the necessary part from the Linksys firmware, you need to understand the <a href="http://skaya.enix.org/wiki/FirmwareFormat">firmware format</a>.</p></blockquote></div><p>I had&nbsp; a look into <a href="http://downloads.linksysbycisco.com/downloads/firmware/1224645224484/WAG160Nv2-EU-ANNEXA-ETSI-2.00.20-code.zip">a annex.a firmware for the EU</a>. Seems like it starts with the loader and the header described in the link above is located at offset 0x10000. Do you really need to strip anything off?</p></blockquote></div><p>Yes. I suppose you can verify it by dumping the first 256 bytes of mtd &quot;kernel&quot;.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123786">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">jal2</div>
					<div class="post-datetime">
						23 Dec 2010, 10:54					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>fyi wrote:</cite><blockquote><div class="quotebox"><cite>jal2 wrote:</cite><blockquote><div class="quotebox"><cite>fyi wrote:</cite><blockquote><p>Run a tftp server at 192.168.1.253. File name should be bcm963xx_fs_kernel. As its name implies, it contains only kernel and rootfs (and a 256-byte header). In order to strip off the necessary part from the Linksys firmware, you need to understand the <a href="http://skaya.enix.org/wiki/FirmwareFormat">firmware format</a>.</p></blockquote></div><p>I had&nbsp; a look into <a href="http://downloads.linksysbycisco.com/downloads/firmware/1224645224484/WAG160Nv2-EU-ANNEXA-ETSI-2.00.20-code.zip">a annex.a firmware for the EU</a>. Seems like it starts with the loader and the header described in the link above is located at offset 0x10000. Do you really need to strip anything off?</p></blockquote></div><p>Yes. I suppose you can verify it by dumping the first 256 bytes of mtd &quot;kernel&quot;.</p></blockquote></div><p>Sure, but my question was if the tftp server in the bootloader of a WAG160N can handle the vendor firmware format (without any stripping needed), which starts with the CFE itself and contains the header at offset 0x10000? This looks like a plain copy of the complete flash.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123788">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">jal2</div>
					<div class="post-datetime">
						23 Dec 2010, 11:07					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>james.harper wrote:</cite><blockquote><p>I am now of the opinion that there is a bug in my CFE that causes it to crash when the rest of the firmware isn&#039;t entirely perfect. How can I get a later version than &quot;CFE version 1.0.37-5.4 for BCM96358 (32bit,SP,BE)&quot;?</p><p>I assume that the regular openwrt images don&#039;t include a CFE image.</p></blockquote></div><p>The vendor firmware (link above) seems to contain a CFE in the first 64KB. Difficult to tell the version, as it is compressed. You may run a binary diff to your CFE dump from the JTAG, which is probably in little endian, i.e. need to be swapped. I doubt that it is a new version.</p><p>I&#039;d rather prefer to find out where pid2 is located and which value it should have in order to fix the openwrt images.<br/>From your posting the first pid is at 0xbfc0ff80, i.e. at the end of the CFE. I&#039;d guess pid2 is located in the header, i.e. the first 256 byte of the<br/>openwrt images. Which openwrt image did you try last time?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123789">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">james.harper</div>
					<div class="post-datetime">
						23 Dec 2010, 11:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><blockquote><p>I&#039;d rather prefer to find out where pid2 is located and which value it should have in order to fix the openwrt images.<br/>From your posting the first pid is at 0xbfc0ff80, i.e. at the end of the CFE. I&#039;d guess pid2 is located in the header, i.e. the first 256 byte of the<br/>openwrt images. Which openwrt image did you try last time?</p></blockquote></div><p>Stupidly, I didn&#039;t take note which was the image that broke it. It *might* have been openwrt-DSL2740B-squashfs-cfe.bin (DSL2740B appears to be a 96358 build) but i&#039;m not sure.</p><p>I left it flashing the original image back again (i copied all the /dev/mtdblockX images), so hopefully i&#039;ll at least have CFE working again.</p><p>I don&#039;t know what a pid2 is, nor why it would stop CFE from working. Can you explain or is there a doc somewhere?</p><p>thanks</p><p>James</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123805">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">jal2</div>
					<div class="post-datetime">
						23 Dec 2010, 13:43					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>james.harper wrote:</cite><blockquote><p>Stupidly, I didn&#039;t take note which was the image that broke it. It *might* have been openwrt-DSL2740B-squashfs-cfe.bin (DSL2740B appears to be a 96358 build) but i&#039;m not sure.</p><p>I left it flashing the original image back again (i copied all the /dev/mtdblockX images), so hopefully i&#039;ll at least have CFE working again.</p><p>I don&#039;t know what a pid2 is, nor why it would stop CFE from working. Can you explain or is there a doc somewhere?</p></blockquote></div><p>I assume that pid and pid2 are magic numbers in the flash at defined locations.<br/>pid is located at the end of the bootloader at offset 0xff80, where the CFE from the vendor firmware contains the string &quot;sErCoMm&quot;. Both serve to detect invalid flash content, however I wonder what the bootloader will do if pid was changed.<br/>pid2 may be located in the 256 byte header following the bootloader. I&#039;ve compared the first 62 bytes of the header from openwrt-DSL2740B-squashfs-cfe.bin and from the vendor firmware, they appear to be the same. So you either flashed a different image or the header got changed during the firmware update.</p><p>I&#039;d love to look at the 256 byte header at 0xbfc10000 in both the working and non-working case.<br/>You may also try to flash openwrt-DSL2740B-squashfs-cfe.bin to this address via JTAG, after your CFE was restored.</p><p>I don&#039;t know how much time you want to spend on this issue, I&#039;ll get a WAG160N during the next weeks and could try this myself.</p><p>I&#039;m really surprised that you don&#039;t run into endian problems, thought that the HairyDairyMaid tool stores the binaries in little endian mode (tjtag 3.0.1 does for sure), while the mtdblock images are in big endian.</p>											<p class="post-edited">(Last edited by <strong>jal2</strong> on 23 Dec 2010, 13:45)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123811">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						23 Dec 2010, 16:03					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>jal2 wrote:</cite><blockquote><p>I&#039;m really surprised that you don&#039;t run into endian problems, thought that the HairyDairyMaid tool stores the binaries in little endian mode (tjtag 3.0.1 does for sure), while the mtdblock images are in big endian.</p></blockquote></div><p><a href="https://forum.openwrt.org/viewtopic.php?pid=120859#p120859">Install Python and run &quot;python rvs-dword.py [file_to_reverse]&quot;.</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123826">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">james.harper</div>
					<div class="post-datetime">
						23 Dec 2010, 23:02					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>jal2 wrote:</cite><blockquote><p>You may also try to flash openwrt-DSL2740B-squashfs-cfe.bin to this address via JTAG, after your CFE was restored.</p></blockquote></div><p>I&#039;m pretty sure I tried DSL2740B. CFE still worked but linux complained that it couldn&#039;t find the board.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123834">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">james.harper</div>
					<div class="post-datetime">
						24 Dec 2010, 01:27					</div>
				</div>
				<div class="post-content content">
					<p>JTAG flash finally completed and it&#039;s booting again. I think I need to put the nvram and ath_data partitions back still.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123837">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">jal2</div>
					<div class="post-datetime">
						24 Dec 2010, 01:43					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>james.harper wrote:</cite><blockquote><div class="quotebox"><cite>jal2 wrote:</cite><blockquote><p>You may also try to flash openwrt-DSL2740B-squashfs-cfe.bin to this address via JTAG, after your CFE was restored.</p></blockquote></div><p>I&#039;m pretty sure I tried DSL2740B. CFE still worked but linux complained that it couldn&#039;t find the board.</p></blockquote></div><p>So the DSL2740B wasn&#039;t the last image flashed, i.e. the one which let the CFE fail? You flashed some other images afterwards?<br/>Then the pid2 could well be the board id or the router model in the header at flash offset 0x10000. They are at<br/>offset 0x10026 (board id, 6 bytes, string &quot;6358&quot; in the vendor firmware) and offset 0x1002c (router model, 16 byte, string &quot;96358GW&quot;).</p><p>With the DSL2740B image you got an error during boot from the Linux kernel?</p>											<p class="post-edited">(Last edited by <strong>jal2</strong> on 24 Dec 2010, 01:44)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123840">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">james.harper</div>
					<div class="post-datetime">
						24 Dec 2010, 02:14					</div>
				</div>
				<div class="post-content content">
					<p>I just flashed openwrt-96358GW-squashfs-bc310-cfe.bin that I found from this thread <a href="https://forum.openwrt.org/viewtopic.php?id=19601">https://forum.openwrt.org/viewtopic.php?id=19601</a> and it booted up just fine, but then on the next reboot I&#039;m right back where I started with:</p><p>no pid2<br/>WARNING!! - FIRMWARE HAD BEEN DESTORYED!!<br/>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; YOU NEED RE-DOWNLOAD FIRMWARE!!</p><p>So i&#039;m wondering now if I did actually find a bootable image last time and wasn&#039;t watching the serial port when it booted up, and that when it formats jffs2 it wipes the pid area?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123841">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">jal2</div>
					<div class="post-datetime">
						24 Dec 2010, 02:29					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>james.harper wrote:</cite><blockquote><p>I just flashed openwrt-96358GW-squashfs-bc310-cfe.bin that I found from this thread <a href="https://forum.openwrt.org/viewtopic.php?id=19601">https://forum.openwrt.org/viewtopic.php?id=19601</a> and it booted up just fine, but then on the next reboot I&#039;m right back where I started with:</p><p>no pid2<br/>WARNING!! - FIRMWARE HAD BEEN DESTORYED!!<br/>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; YOU NEED RE-DOWNLOAD FIRMWARE!!</p><p>So i&#039;m wondering now if I did actually find a bootable image last time and wasn&#039;t watching the serial port when it booted up, and that when it formats jffs2 it wipes the pid area?</p></blockquote></div><p>This may be the case. Do you have a log of the first boot of this firmware?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123842">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">james.harper</div>
					<div class="post-datetime">
						24 Dec 2010, 02:45					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>jal2 wrote:</cite><blockquote><p>This may be the case. Do you have a log of the first boot of this firmware?</p></blockquote></div><div class="codebox"><pre><code>CFE&gt; f
Loading 192.168.1.100:bcm963xx_fs_kernel ...
Finished loading 2686980 bytes

Flashing root file system and kernel at 0xbfc10000: ..........................................

.
*** Image flash done *** !
Resetting board...

CFE version 1.0.37-5.4 for BCM96358 (32bit,SP,BE)
Build Date: 2009å¹´ 03æ 31æ¥ ææäº 17:07:55 CST (root@localhost.localdomain)
Copyright (C) 2000-2005 Broadcom Corporation.

Boot Address 0xbfc00000

Initializing Arena.
Initializing Devices.
Parallel flash device: name MX29LV320AB, id 0x22a8, size 4096KB
798
875
0x6:0x11f
0x6:0x108
0x6:0x108
CPU type 0x2A010: 300MHz, Bus: 133MHz, Ref: 64MHz
Total memory: 33554432 bytes (32MB)

Total memory used by CFE:  0x80401000 - 0x80533000 (1253376)
Initialized Data:          0x8041C0E0 - 0x8041CDD0 (3312)
BSS Area:                  0x8041CDD0 - 0x80431000 (82480)
Local Heap:                0x80431000 - 0x80531000 (1048576)
Stack Area:                0x80531000 - 0x80533000 (8192)
Text (code) segment:       0x80401000 - 0x8041C0D8 (110808)
Boot area (physical):      0x00533000 - 0x00573000
Relocation Factor:         I:00000000 - D:00000000

Board IP address                  : 192.168.1.1
Host IP address                   : 192.168.1.100
Gateway IP address                :
Run from flash/host (f/h)         : f
Default host run file name        : vmlinux
Default host flash file name      : bcm963xx_fs_kernel
Boot delay (0-9 seconds)          : 9
Board Id Name                     : 96358GW
Psi size in KB                    : 24
Number of MAC Addresses (1-32)    : 10
Base MAC Address                  : 00:22:6b:ff:8c:f1
Ethernet PHY Type                 : Internal
Memory size in MB                 : 32
CMT Thread Number                 : 0

get pid2 at0xbffbd00b
pid checked!
*** Press any key to stop auto run (9 seconds) ***
Auto run second count down: 0
Code Address: 0x80010000, Entry Address: 0x80010000
Decompression OK!
Entry at 0x80010000
Closing network.
Starting program at 0x80010000
Linux version 2.6.32.9 (virus@Virion) (gcc version 4.3.3 (GCC) ) #18 Mon Mar 15 16:16:55 CET 2010
Detected Broadcom 0x6358 CPU revision a1
CPU frequency is 300 MHz
32MB of RAM installed
registering 40 GPIOs
board_bcm963xx: CFE version: 1.0.37-5.4
bootconsole [early0] enabled
CPU revision is: 0002a010 (Broadcom BCM6358)
board_bcm963xx: board name: 96358GW
Determined physical RAM map:
 memory: 02000000 @ 00000000 (usable)
Initrd not found or empty - disabling initrd
Zone PFN ranges:
  Normal   0x00000000 -&gt; 0x00002000
Movable zone start PFN for each node
early_node_map[1] active PFN ranges
    0: 0x00000000 -&gt; 0x00002000
Built 1 zonelists in Zone order, mobility grouping on.  Total pages: 8128
Kernel command line: root=/dev/mtdblock2 rootfstype=squashfs,jffs2 noinitrd console=ttyS0,115200
PID hash table entries: 128 (order: -3, 512 bytes)
Dentry cache hash table entries: 4096 (order: 2, 16384 bytes)
Inode-cache hash table entries: 2048 (order: 1, 8192 bytes)
Primary instruction cache 32kB, VIPT, 2-way, linesize 16 bytes.
Primary data cache 16kB, 2-way, VIPT, cache aliases, linesize 16 bytes
Memory: 29724k/32768k available (2050k kernel code, 3044k reserved, 363k data, 136k init, 0k highmem)
Hierarchical RCU implementation.
NR_IRQS:128
Calibrating delay loop... 299.00 BogoMIPS (lpj=598016)
Mount-cache hash table entries: 512
NET: Registered protocol family 16
ath: Register ath_data_device at address 0x1ffe1000
registering PCI controller with io_map_base unset
bio: create slab &lt;bio-0&gt; at 0
Switching to clocksource MIPS
NET: Registered protocol family 2
IP route cache hash table entries: 1024 (order: 0, 4096 bytes)
TCP established hash table entries: 1024 (order: 1, 8192 bytes)
TCP bind hash table entries: 1024 (order: 0, 4096 bytes)
TCP: Hash tables configured (established 1024 bind 1024)
TCP reno registered
NET: Registered protocol family 1
audit: initializing netlink socket (disabled)
type=2000 audit(0.197:1): initialized
squashfs: version 4.0 (2009/01/31) Phillip Lougher
Registering mini_fo version $Id$
JFFS2 version 2.2. (NAND) (SUMMARY)  Â© 2001-2006 Red Hat, Inc.
msgmni has been set to 58
io scheduler noop registered
io scheduler deadline registered (default)
gpiodev: gpio device registered with major 254
gpiodev: gpio platform device registered with access mask FFFFFFFF
bcm63xx_uart.0: ttyS0 at MMIO 0xfffe0100 (irq = 10) is a bcm63xx_uart
console [ttyS0] enabled, bootconsole disabled
console [ttyS0] enabled, bootconsole disabled
bcm963xx_flash: 0x00400000 at 0x1fc00000
bcm963xx: Found 1 x16 devices at 0x0 in 16-bit bank
 Amd/Fujitsu Extended Query Table at 0x0040
number of CFI chips: 1
cfi_cmdset_0002: Disabling erase-suspend-program due to code brokenness.
bcm963xx_flash: Read Signature value of CFE1CFE1
bcm963xx_flash: CFE bootloader detected
bcm963xx_flash: CFE boot tag found with version 6, board type 96358GW, and tagid bc310.
bcm963xx_flash: Partition 0 is CFE offset 81ce1e48 and length 0
bcm963xx_flash: Partition 1 is kernel offset d2b and length 0
bcm963xx_flash: Partition 2 is rootfs offset d6c and length 0
bcm963xx_flash: Partition 3 is ath_data offset dad and length 0
bcm963xx_flash: Partition 4 is nvram offset df0 and length 0
bcm963xx_flash: Spare partition is 2a0000 offset and length 150000
Creating 5 MTD partitions on &quot;bcm963xx&quot;:
0x000000000000-0x000000010000 : &quot;CFE&quot;
0x000000010100-0x0000000f0000 : &quot;kernel&quot;
mtd: partition &quot;kernel&quot; must either start or end on erase block boundary or be smaller than an erase block -- forcing read-only
0x0000000f0000-0x0000003e0000 : &quot;rootfs&quot;
mtd: partition &quot;rootfs&quot; set to be root filesystem
mtd: partition &quot;rootfs_data&quot; created automatically, ofs=2A0000, len=140000
0x0000002a0000-0x0000003e0000 : &quot;rootfs_data&quot;
0x0000003e0000-0x0000003f0000 : &quot;ath_data&quot;
0x0000003f0000-0x000000400000 : &quot;nvram&quot;
bcm63xx_enet MII bus: probed
bcm63xx_wdt started, timer margin: 30 sec
TCP westwood registered
NET: Registered protocol family 17
802.1Q VLAN Support v1.8 Ben Greear &lt;greearb@candelatech.com&gt;
All bugs added by David S. Miller &lt;davem@redhat.com&gt;
VFS: Mounted root (squashfs filesystem) readonly on device 31:2.
Freeing unused kernel memory: 136k freed
Please be patient, while OpenWrt loads ...
- preinit -
Press f&lt;ENTER&gt; to enter failsafe mode
- regular preinit -
jffs2 not ready yet; using ramdisk
mini_fo: using base directory: /
mini_fo: using storage directory: /tmp/root
- init -

Please press Enter to activate this console. bcm63xx_enet bcm63xx_enet.0: attached PHY at address 1 [Broadcom BCM63XX (2)]
eth1: link forced UP - 100/full - flow control off/off
device eth1 entered promiscuous mode
br-lan: port 1(eth1) entering forwarding state
Generic kernel compatibility enabled based on linux-next next-20100113
cfg80211: Calling CRDA to update world regulatory domain
roboswitch: Probing device eth0: Failed to enable switch
roboswitch: Probing device eth1: found a 5325! It&#039;s a 5350.
cfg80211: World regulatory domain updated:
    (start_freq - end_freq @ bandwidth), (max_antenna_gain, max_eirp)
    (2402000 KHz - 2472000 KHz @ 40000 KHz), (300 mBi, 2000 mBm)
    (2457000 KHz - 2482000 KHz @ 20000 KHz), (300 mBi, 2000 mBm)
    (2474000 KHz - 2494000 KHz @ 20000 KHz), (300 mBi, 2000 mBm)
    (5170000 KHz - 5250000 KHz @ 40000 KHz), (300 mBi, 2000 mBm)
    (5735000 KHz - 5835000 KHz @ 40000 KHz), (300 mBi, 2000 mBm)
PCI: Enabling device 0000:00:01.0 (0000 -&gt; 0002)
 # reading ath_data
ath9k 0000:00:01.0: Failed to initialize device
ath9k: probe of 0000:00:01.0 failed with error -22
PPP generic driver version 2.4.2
ip_tables: (C) 2000-2006 Netfilter Core Team
NET: Registered protocol family 24
nf_conntrack version 0.5.0 (466 buckets, 1864 max)
ath_hal: module license &#039;Proprietary&#039; taints kernel.
Disabling lock debugging due to kernel taint
ath_hal: 2009-05-08 (AR5210, AR5211, AR5212, AR5416, RF5111, RF5112, RF2413, RF5413, RF2133, RF2425, REGOPS_FUNC, XR)
ath_pci: trunk
wlan: trunk
wlan: mac acl policy registered
ath_rate_minstrel: Minstrel automatic rate control algorithm 1.2 (trunk)
ath_rate_minstrel: look around rate set to 10%
ath_rate_minstrel: EWMA rolloff level set to 75%
ath_rate_minstrel: max segment size in the mrr set to 6000 us
jffs2_scan_eraseblock(): End of filesystem marker found at 0x0
jffs2_build_filesystem(): unlocking the mtd device... done.
jffs2_build_filesystem(): erasing all blocks after the end marker... done.
mini_fo: using base directory: /
mini_fo: using storage directory: /jffs



BusyBox v1.15.3 (2010-03-13 12:19:49 CET) built-in shell (ash)
Enter &#039;help&#039; for a list of built-in commands.

  _______                     ________        __
 |       |.-----.-----.-----.|  |  |  |.----.|  |_
 |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|
 |_______||   __|_____|__|__||________||__|  |____|
          |__| W I R E L E S S   F R E E D O M
 KAMIKAZE (bleeding edge, r20018) ------------------
  * 10 oz Vodka       Shake well with ice and strain
  * 10 oz Triple sec  mixture into 10 shot glasses.
  * 10 oz lime juice  Salute!
 ---------------------------------------------------
root@OpenWrt:/# reboot
root@OpenWrt:/# br-lan: port 1(eth1) entering disabled state
device eth1 left promiscuous mode
br-lan: port 1(eth1) entering disabled state
bcm63xx_wdt: Unexpected close, not stopping watchdog!
Restarting system.
triggering watchdog soft-reset...


CFE version 1.0.37-5.4 for BCM96358 (32bit,SP,BE)
Build Date: 2009å¹´ 03æ 31æ¥ ææäº 17:07:55 CST (root@localhost.localdomain)
Copyright (C) 2000-2005 Broadcom Corporation.

Boot Address 0xbfc00000

Initializing Arena.
Initializing Devices.
Parallel flash device: name MX29LV320AB, id 0x22a8, size 4096KB
798
875
0x6:0x11f
0x6:0x108
0x6:0x108
CPU type 0x2A010: 300MHz, Bus: 133MHz, Ref: 64MHz
Total memory: 33554432 bytes (32MB)

Total memory used by CFE:  0x80401000 - 0x80533000 (1253376)
Initialized Data:          0x8041C0E0 - 0x8041CDD0 (3312)
BSS Area:                  0x8041CDD0 - 0x80431000 (82480)
Local Heap:                0x80431000 - 0x80531000 (1048576)
Stack Area:                0x80531000 - 0x80533000 (8192)
Text (code) segment:       0x80401000 - 0x8041C0D8 (110808)
Boot area (physical):      0x00533000 - 0x00573000
Relocation Factor:         I:00000000 - D:00000000

Board IP address                  : 192.168.1.1
Host IP address                   : 192.168.1.100
Gateway IP address                :
Run from flash/host (f/h)         : f
Default host run file name        : vmlinux
Default host flash file name      : bcm963xx_fs_kernel
Boot delay (0-9 seconds)          : 9
Board Id Name                     : 96358GW
Psi size in KB                    : 24
Number of MAC Addresses (1-32)    : 10
Base MAC Address                  : 00:22:6b:ff:8c:f1
Ethernet PHY Type                 : Internal
Memory size in MB                 : 32
CMT Thread Number                 : 0

no pid2
WARNING!! - FIRMWARE HAD BEEN DESTORYED!!
            YOU NEED RE-DOWNLOAD FIRMWARE!!</code></pre></div><p>Some bytes in CFE were definitely changed but I don&#039;t know yet when that happened.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123844">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">james.harper</div>
					<div class="post-datetime">
						24 Dec 2010, 03:05					</div>
				</div>
				<div class="post-content content">
					<p>If I flash the first 256 bytes at offset 0x10000 into the flash (eg the &#039;tag&#039; area) with 0xff, then reboot, then re-read, it now contains:<br/></p><div class="codebox"><pre><code># hd pid2.out
00000000  00 00 00 00 ff ff 00 00  00 00 ff ff 00 00 00 00  |....ÿÿ....ÿÿ....|
00000010  ff ff 00 00 ff ff ff ff  00 00 00 00 ff ff ff ff  |ÿÿ..ÿÿÿÿ....ÿÿÿÿ|
00000020  00 51 00 52 00 59 00 02  00 00 00 40 00 00 00 00  |.Q.R.Y.....@....|
00000030  00 00 00 00 00 00 00 27  00 36 00 00 00 00 00 04  |.......&#039;.6......|
00000040  00 00 00 0a 00 00 00 05  00 00 00 04 00 00 00 16  |................|
00000050  00 02 00 00 00 00 00 00  00 02 00 07 00 00 00 20  |............... |
00000060  00 00 00 3e 00 00 00 00  00 01 00 00 00 00 00 00  |...&gt;............|
00000070  00 00 00 00 00 00 00 00  00 00 ff ff ff ff ff ff  |..........ÿÿÿÿÿÿ|
00000080  00 50 00 52 00 49 00 31  00 31 00 00 00 02 00 04  |.P.R.I.1.1......|
00000090  00 01 00 04 00 00 00 00  00 00 00 a5 00 b5 00 02  |...........¥.µ..|
000000a0  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |ÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿ|
*
000000c0  ff ff ff ff ff ff ff 55  00 00 ff ff 00 00 00 00  |ÿÿÿÿÿÿÿU..ÿÿ....|
000000d0  ff ff 00 00 00 00 00 00  00 00 ff ff 00 00 00 00  |ÿÿ........ÿÿ....|
000000e0  00 00 00 00 00 00 00 00  00 00 ff ff 00 00 ff ff  |..........ÿÿ..ÿÿ|
000000f0  ff ff ff ff ff 55 ff 55  ff 55 ff ff ff ff ff 55  |ÿÿÿÿÿUÿUÿUÿÿÿÿÿU|</code></pre></div><p>and even if I copy the first 8K back from the original mdtblock1 backup I took, some of that initial area still gets scrambled. It looks like it&#039;s rewriting a checksum or something and maybe corrupting itself?</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 3</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=27801&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=27801&amp;p=3.html">3</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>