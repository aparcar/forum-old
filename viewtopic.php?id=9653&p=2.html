<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Optimized version of mmc.c</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 5 Jun 2014 and 7 Mar 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 2 of 7</div><nav><ul><li><a href="viewtopic.php%3Fid=9653&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=9653&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=9653&amp;p=4.html">4</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=9653&amp;p=7.html">7</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p43908">
				<div class="post-metadata">
					<div class="post-num">Post #26</div>
					<div class="post-author">Kevin</div>
					<div class="post-datetime">
						7 Mar 2007, 22:12					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Cyril wrote:</cite><blockquote><p>Look twice.</p><p>SD_DI is sent. That means data input bit is 1.<br/>8 times =&gt; data is 0xFF.</p><p>If you&#039;re interested in MMC protocol : <a href="http://elm-chan.org/docs/mmc/mmc_e.html">http://elm-chan.org/docs/mmc/mmc_e.html</a> .</p></blockquote></div><p>thanks for clerifying that <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p><div class="quotebox"><blockquote><p>And to answer differently : there are many cases in the MMC protocol where you just have to cycle the clock :<br/>- to read data<br/>- when the MMC is in busy state<br/>- when your are waiting for it to respond to a command.<br/>- while initing it.<br/>- ...</p></blockquote></div><p>in which case you&#039;d expect a test (and/)or action to be preformed every clock cycle.. I didn&#039;t notice that you were just sending the same data 8 times</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p43911">
				<div class="post-metadata">
					<div class="post-num">Post #27</div>
					<div class="post-author">Cyril</div>
					<div class="post-datetime">
						7 Mar 2007, 22:37					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>kevin wrote:</cite><blockquote><p>in which case you&#039;d expect a test (and/)or action to be preformed every clock cycle.. I didn&#039;t notice that you were just sending the same data 8 times</p></blockquote></div><p>Is it a question ?</p><p>Kevin, if you want me to explain some parts of the code, can you do it by PM ? And please, be more precise ! <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p><p>Will you try to code some addons (like buffering) or is this only curiosity ? In that last case, sorry but i don&#039;t have that time.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p43912">
				<div class="post-metadata">
					<div class="post-num">Post #28</div>
					<div class="post-author">Kevin</div>
					<div class="post-datetime">
						7 Mar 2007, 22:44					</div>
				</div>
				<div class="post-content content">
					<p>it wasn&#039;t a question, no.&nbsp; if I do any coding it will be porting the driver to 2.6 and to different hardware, not optimization immediately, but right now i&#039;m just reading up on mmc/ linux driver development and looking for other people to do it <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p43915">
				<div class="post-metadata">
					<div class="post-num">Post #29</div>
					<div class="post-author">Cyril</div>
					<div class="post-datetime">
						7 Mar 2007, 23:23					</div>
				</div>
				<div class="post-content content">
					<p>For nicefile (and others) about 4GB support :</p><p>I thought that 2GB limit was due to the SPI protocol but in fact it is not.<br/>SPI seems limited to 4GB (unsigned 32bit int).</p><p>Though it is a software limit and i may have found the problem in the code.<br/>One address conversion in the code is calculated from signed integers then the result may be a signed int even if the result is stored in an unsigned int.</p><p>I have corrected this line but i don&#039;t know if 4GB now work as i don&#039;t have that a huge card.</p><p><span style="color: #FF0000"><strong>Can someone try it ? PM me.</strong></span></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p43958">
				<div class="post-metadata">
					<div class="post-num">Post #30</div>
					<div class="post-author">Kevin</div>
					<div class="post-datetime">
						8 Mar 2007, 19:55					</div>
				</div>
				<div class="post-content content">
					<p>I shouldn&#039;t have to mention this considering the context of all this discussion is gpl released code from linksys, fon, etc, but you should, and must, release the source code for any gpled binaries you release.&nbsp; sorry to bring it up like this, but this is one of those things that really gets under my skin.&nbsp; if your worried about keeping the&nbsp; official source.. copy paste.. stable, I recommend you put the .c files on a web server with version codes.&nbsp; would help for looking through the changes made too.</p><p>I remember someone before worked out a fix for 4gb spi support, but lost the code (and binaries, for that matter), in a hard drive crash. glad to see it working, maybe, again <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p>											<p class="post-edited">(Last edited by <strong>Kevin</strong> on 8 Mar 2007, 19:58)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p43965">
				<div class="post-metadata">
					<div class="post-num">Post #31</div>
					<div class="post-author">Cyril</div>
					<div class="post-datetime">
						8 Mar 2007, 21:27					</div>
				</div>
				<div class="post-content content">
					<p>Kevin,</p><p>thanks for this comment but what i do here is experimental.<br/>1.2 is stable and is released.</p><p>For the rest, i don&#039;t have time to make a cvs env.</p><p>Maybe in the near future.</p><p>And any help is apprecieted.<br/>Please don&#039;t give me advices like that in the near future. If GPL is under your skin; contribute and don&#039;t talk too much. Thanks.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p43970">
				<div class="post-metadata">
					<div class="post-num">Post #32</div>
					<div class="post-author">Kevin</div>
					<div class="post-datetime">
						8 Mar 2007, 22:22					</div>
				</div>
				<div class="post-content content">
					<p>i&#039;d be glad to set up a web server or cvs repository if you need one, but that&#039;s not really the issue.<br/>In this case, it&#039;s the LAW. I don&#039;t see any reason to ignore it, either. you&#039;d get more testing if you just put up a .c file. I personally have been just copying the source from your first post every time I wanted to play with it, and have completely ignored the binaries.&nbsp; as I said, I hate to bring it up like this, as the most likely result is driving people away, but it really shouldn&#039;t be happening.<br/>i&#039;ll contribute once i&#039;m finished reading my book on the subject, thanks <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/> (really)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p44334">
				<div class="post-metadata">
					<div class="post-num">Post #33</div>
					<div class="post-author">lemonteh</div>
					<div class="post-datetime">
						13 Mar 2007, 20:12					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m excited at the improved speed! Is there going to be a version for the buffalo routers? Can someone post a link to it? The gpio pins are</p><p>GPIO3 SD_CLK<br/>GPIO6 DO <br/>GPIO7 SD_CS <br/>GPIO5 DI</p><p>Thank you! <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p44481">
				<div class="post-metadata">
					<div class="post-num">Post #34</div>
					<div class="post-author">freezer2k</div>
					<div class="post-datetime">
						15 Mar 2007, 16:48					</div>
				</div>
				<div class="post-content content">
					<p>Hi everybody!</p><p>Is there an MMC/SD card compatibility list for the MMC gpio mod?</p><p>I soldered yesterday a card, but it didnt responded to anything. I measured voltage and 3.3V was at the VDD contact of the MMC Card ( used an 1GB MMC plus Extremmemory card). </p><p>While try to load the driver dmesg/logread shows this:</p><p>mmc Hardware init<br/>[INFO] mmc_card_init: powering card on. sending 80 CLK<br/>[INFO] mmc_card_init: resetting card (CMD0)<br/>[FATAL] mmc_card_init: invalid response from card: ff found, waiting for 01<br/>[INFO] mmc_card_init: powering card on. sending 80 CLK<br/>[INFO] mmc_card_init: resetting card (CMD0)<br/>[FATAL] mmc_card_init: invalid response from card: ff found, waiting for 01<br/>mmc: error in mmc_card_init (1)<br/>mmc: error in mmc_init (-1)</p><p>Funny thing is....this comes up with and without card soldered...so no change at all!</p><p>I&#039;m using 1.3.1 driver with whiterussian RC6. Also tried different values for mp_max_init_tries .. but no change.</p><p>I&#039;ve got an WRT54G V. 2.0 and did the mod @ <a href="http://kiel.kool.dk/">http://kiel.kool.dk</a>/</p><p>I don&#039;t know what might be wrong there...except that maybe the card is just not comaptible.... so please post which card worked for you or not!</p><p>Maybe we should start an new thread for this...</p><br/><p>Freezer</p>											<p class="post-edited">(Last edited by <strong>freezer2k</strong> on 15 Mar 2007, 17:05)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p44486">
				<div class="post-metadata">
					<div class="post-num">Post #35</div>
					<div class="post-author">pagano</div>
					<div class="post-datetime">
						15 Mar 2007, 18:29					</div>
				</div>
				<div class="post-content content">
					<p>Answered in <a href="http://forum.openwrt.org/viewtopic.php?pid=43816#p43816">http://forum.openwrt.org/viewtopic.php?pid=43816#p43816</a><br/>Test it. I had same dmesg/log error and it works.</p><p>insmod mmc.o mp_max_init_tries=30000</p><p>Cyril, tanks for leave the zoooommm mmc driver ;-)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p44494">
				<div class="post-metadata">
					<div class="post-num">Post #36</div>
					<div class="post-author">Cyril</div>
					<div class="post-datetime">
						15 Mar 2007, 19:03					</div>
				</div>
				<div class="post-content content">
					<p>Hello.</p><p>Sorry for the long time without news but holidays are finished for me <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/><br/>I am now at work for 14 hours a day ... pfff</p><br/><p>I am currently testing some other ways to speed things up. Maybe you will get news soon ... and sources for 1.3.2 on a fresh CVS server.</p><br/><div class="quotebox"><cite>lemonteh wrote:</cite><blockquote><p>I&#039;m excited at the improved speed! Is there going to be a version for the buffalo routers? Can someone post a link to it? The gpio pins are</p><p>GPIO3 SD_CLK<br/>GPIO6 DO<br/>GPIO7 SD_CS<br/>GPIO5 DI</p></blockquote></div><p>I will do it this evening and will post the binary.</p><div class="quotebox"><cite>freezer2k wrote:</cite><blockquote><p>I&#039;ve got an WRT54G V. 2.0 and did the mod @ <a href="http://kiel.kool.dk/">http://kiel.kool.dk</a>/<br/>I don&#039;t know what might be wrong there...except that maybe the card is just not comaptible.... so please post which card worked for you or not!<br/>Maybe we should start an new thread for this...</p></blockquote></div><p>insmod mmc.o mp_max_init_tries=30000 will not work for you.<br/>For it to work, you need a message like : card not initialized after xxxxx tries.</p><p>What I can tell you is that you need the GPIO5 binary and double check your solder points.</p><p>I think that ANY card is compatible with this first phase of Initialization that blocks you (At protocol level I mean).<br/>Maybe GPIO&#039;s voltage are not enough.<br/>Maybe 80 CLK is not enough.<br/>Or maybe the clock frequency is too fast for the card. <br/>I can try to export a new parameter to alter this number ?</p><p>I will do it this evening.</p><p>Can you give me the reference of this SD ?</p>											<p class="post-edited">(Last edited by <strong>Cyril</strong> on 15 Mar 2007, 19:05)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p44506">
				<div class="post-metadata">
					<div class="post-num">Post #37</div>
					<div class="post-author">freezer2k</div>
					<div class="post-datetime">
						15 Mar 2007, 20:50					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>Yes i tested it with the GPIO5 Version.</p><p>I didn&#039;t found a real datasheet for this card, but if you look here:</p><p><a href="http://www.extrememory.com/index.cfm?lc=products&amp;nc=pmenue&amp;pageID=6">http://www.extrememory.com/index.cfm?lc=products&amp;nc=pmenue&amp;pageID=6</a></p><p>Its the second card (1GB version) &quot;MMC plus PREMIUM&quot;</p><p>Also: <a href="http://kiel.kool.dk/pics/solderpoint_1_annotated.jpg">http://kiel.kool.dk/pics/solderpoint_1_annotated.jpg</a></p><p>Is it correct that the DI-connect has to be soldered behind the RP3 IC, in front of the ADM chip? Because the three red lines are all pointing to the front pins of RP3.. and two of three wires are also connected to the front pins. I soldered it like it is to see on the picture: DI behind the RP3 and the two other wires in front of... is this correct?</p><p>Greetings,<br/>Freezer</p>											<p class="post-edited">(Last edited by <strong>freezer2k</strong> on 15 Mar 2007, 20:58)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p44517">
				<div class="post-metadata">
					<div class="post-num">Post #38</div>
					<div class="post-author">Cyril</div>
					<div class="post-datetime">
						16 Mar 2007, 00:54					</div>
				</div>
				<div class="post-content content">
					<p>Hi.</p><p>for buffalos, I have posted a binary on heading post.</p><p>freezer2k :<br/>try to play with mp_max_pwr_on_clocks . Do go to high. 200 must be enough.<br/>If it don&#039;t work, report me, i will search for other hypothesis.<br/>I will look anyway to your docs and questions for tomorrow.</p><p>Cyril</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p44840">
				<div class="post-metadata">
					<div class="post-num">Post #39</div>
					<div class="post-author">abraXxl</div>
					<div class="post-datetime">
						20 Mar 2007, 15:03					</div>
				</div>
				<div class="post-content content">
					<p>hi cyrill !</p><p>good work, with your mmc-mod driver i have less problems with root on the mmc card.<br/>I used the How-To from the USBStorageHowTo in the Wiki.<br/>My device is an WRT54GS v1.0 GS.</p><p>Some things mention:<br/>a) I have to configure the switch before loading the the mmc.o an mounting the fs on the SD card as root. Reading from the device is not possible afterwards anymore, with a bunch of kernel messages on tts/0. Sounds clear to me because of using the GPIOs to program the switch are used for the mmc-mod, too.<br/>I suggest trying to re-init the card after some reading problems.</p><p>b) I can cause kernel oopses with sometime hanging router, when I do the steps in sequence<br/> 1) insmod mmc.o with card inserted<br/> 2) using SD card (fdisk or mount)<br/> 3) unmounting and unloading mmc.o<br/> 4) insmod mmc.o with card inserted<br/> - now defvs complains that some device nodes those already exist<br/> 5) using SD card with user space program like fdisk, e2fsck or mke2fs no matter using part1 or disc device node.</p><p>I can reproduce that with 1.2, 1.3.1, 1.3.2</p><p>c) after using mmc.o (1.2, 1.3.1, 1.3.2) and soft rebooting the router boots auto-magically in failsafe. <br/>I have no guess why. can you give me a hint ?</p><p>danke and cya</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p44913">
				<div class="post-metadata">
					<div class="post-num">Post #40</div>
					<div class="post-author">Cyril</div>
					<div class="post-datetime">
						21 Mar 2007, 14:00					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>abraXxl wrote:</cite><blockquote><p>Some things mention:<br/>a) I have to configure the switch before loading the the mmc.o an mounting the fs on the SD card as root. Reading from the device is not possible afterwards anymore, with a bunch of kernel messages on tts/0. Sounds clear to me because of using the GPIOs to program the switch are used for the mmc-mod, too.<br/>I suggest trying to re-init the card after some reading problems.</p></blockquote></div><p>OK. In the TODO list</p><div class="quotebox"><cite>abraXxl wrote:</cite><blockquote><p>b) I can cause kernel oopses with sometime hanging router, when I do the steps in sequence<br/> 1) insmod mmc.o with card inserted<br/> 2) using SD card (fdisk or mount)<br/> 3) unmounting and unloading mmc.o<br/> 4) insmod mmc.o with card inserted<br/> - now defvs complains that some device nodes those already exist<br/> 5) using SD card with user space program like fdisk, e2fsck or mke2fs no matter using part1 or disc device node.</p></blockquote></div><p>idem</p><br/><div class="quotebox"><cite>abraXxl wrote:</cite><blockquote><p>c) after using mmc.o (1.2, 1.3.1, 1.3.2) and soft rebooting the router boots auto-magically in failsafe. <br/>I have no guess why. can you give me a hint ?</p></blockquote></div><p>i don&#039;t know. Is 1.3.3 correcting things ?</p><br/><p>for freezer2k and MMC owners:<br/>I have read in specification that initialization phase must be done with a clock of 400Khz max for MMC compatibility.<br/>Sure it is a blocking problem. 400Khz max frequency is in TODO list for next version. (Out in a few hours/days)<br/>freezer2k : have you checked your soldering ? Is it working now ? Or are you still waiting for a fix ?</p><br/><p>Cyril</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p45042">
				<div class="post-metadata">
					<div class="post-num">Post #41</div>
					<div class="post-author">shadsec</div>
					<div class="post-datetime">
						23 Mar 2007, 04:47					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>After finding out the gpio points for my WRT54G *v1.0* I have been trying to use mmc.o with no luck:</p><p>(whiterussian 0.9 - clean flash)<br/>root@OpenWrt:/# insmod ./mmc.o<br/>Using ./mmc.o<br/>Segmentation fault</p><p>Dump:</p><br/><p>mmc Hardware init<br/>Data bus error, epc == c00b0f18, ra == c00b0f0c<br/>Oops in traps.c::do_be, line 385:<br/>$0 : 00000000 1000fc00 b8000060 c00b0000 b8000068 00000000 0000001f 8037a420<br/>$8 : 00000000 00001890 00001890 0000187b 801a0000 801a0000 801a0000 00000001<br/>$16: 00000000 80013514 100df418 80010000 00000060 c00b0000 c00b0000 100dde68<br/>$24: ba2e8ba3 801a95d4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;80eb0000 80eb1e30 00000007 c00b0f0c<br/>Hi : 00000000<br/>Lo : 000005a0<br/>epc&nbsp; &nbsp;: c00b0f18&nbsp; &nbsp; Tainted: P<br/>Status: 1000fc03<br/>Cause : 0000001c<br/>PrId&nbsp; : 00024000<br/>Process insmod (pid: 604, stackpage=80eb0000)<br/>Stack:&nbsp; &nbsp; 100df418 00000001 801e0000 1000fc01 000de000 0000001a 8002c4bc<br/> 8002c3a0 1000fc01 c00b0000 100df418 ffffffea 00000060 809c6b60 00000007<br/> c00b0000 100df418 ffffffea 00000060 809c6b60 80957000 100dde68 80014978<br/> 80014898 80239800 000001f2 000007df 00000002 00000060 c00e3000 c00b0060<br/> 00001e48 00000000 00000000 00000000 00000000 00000000 00000000 00000000<br/> 00000000 ...<br/>Call Trace:&nbsp; &nbsp;[&lt;8002c4bc&gt;] [&lt;8002c3a0&gt;] [&lt;80014978&gt;] [&lt;80014898&gt;] [&lt;c00b0060&gt;]<br/> [&lt;80008a00&gt;] [&lt;8005bdac&gt;]</p><p>Code: 3c03c00b&nbsp; 8c641604&nbsp; 3c03c00b &lt;8c820000&gt; 344200a8&nbsp; 304200ef&nbsp; ac820000&nbsp; 8c641600&nbsp; 3c02c00b</p><p>Apparently this is due to some gpio structure diference for v1.0 than other versions,&nbsp; as mbm and nbd pointed out. They suggested that, since diag correctly manages gpios in this model from diag.c could be seen what needed to be changed in mmc. But my knowledge of C is very limited.</p><p>The only thing i could figure out is that, this is the difference in the structure:</p><p>&lt;&lt;from diag.c&gt;&gt;<br/>[WRT54GV1] = {<br/>118 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.name&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= &quot;Linksys WRT54G V1.x&quot;,<br/>119 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.buttons&nbsp; &nbsp; &nbsp; &nbsp; = {<br/>120 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ .name = &quot;reset&quot;,&nbsp; &nbsp; &nbsp; .gpio = 1 &lt;&lt; 6 },<br/>121 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;},<br/>122 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.leds&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= {<br/>123 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ .name = &quot;diag&quot;,&nbsp; &nbsp; &nbsp; &nbsp;.gpio = 0x13 | GPIO_TYPE_EXTIF, .polarity = NORMAL },<br/>124 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ .name = &quot;dmz&quot;,&nbsp; &nbsp; &nbsp; &nbsp; .gpio = 0x12 | GPIO_TYPE_EXTIF, .polarity = NORMAL },<br/>125 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;},<br/>126 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;},<br/>127 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[WRT54G] = {<br/>128 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.name&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= &quot;Linksys WRT54G/GS/GL&quot;,<br/>129 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.buttons&nbsp; &nbsp; &nbsp; &nbsp; = {<br/>130 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ .name = &quot;reset&quot;,&nbsp; &nbsp; &nbsp; .gpio = 1 &lt;&lt; 6 },<br/>131 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ .name = &quot;ses&quot;,&nbsp; &nbsp; &nbsp; &nbsp; .gpio = 1 &lt;&lt; 4 },<br/>132 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;},<br/>133 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.leds&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= {<br/>134 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ .name = &quot;power&quot;,&nbsp; &nbsp; &nbsp; .gpio = 1 &lt;&lt; 1, .polarity = NORMAL },<br/>135 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ .name = &quot;dmz&quot;,&nbsp; &nbsp; &nbsp; &nbsp; .gpio = 1 &lt;&lt; 7, .polarity = REVERSE },<br/>136 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ .name = &quot;ses_white&quot;,&nbsp; .gpio = 1 &lt;&lt; 2, .polarity = REVERSE },<br/>137 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ .name = &quot;ses_orange&quot;, .gpio = 1 &lt;&lt; 3, .polarity = REVERSE },<br/>138 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ .name = &quot;wlan&quot;,&nbsp; &nbsp; &nbsp; &nbsp;.gpio = 1 &lt;&lt; 0, .polarity = REVERSE },<br/>139 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;},<br/>140 &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;},</p><p>&lt;&lt;from diag.h&gt;&gt;<br/>107 &nbsp; &nbsp; #define GPIO_TYPE_NORMAL&nbsp; &nbsp; &nbsp; &nbsp; (0x0 &lt;&lt; 24)<br/>108 &nbsp; &nbsp; #define GPIO_TYPE_EXTIF&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(0x1 &lt;&lt; 24)</p><p>So I though that if GPIO 7 was being hadled in such a different way, and I had another two extra gpios to use, it would be just easier to swap GPIO 7 for GPIO 6 and forget about the &quot;different&quot; gpio... So i changed it like:</p><p>#define SD_DI 0x20<br/>#define SD_DO 0x10<br/>#define SD_CLK 0x08<br/>#define SD_CS 0x40&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;- I changed gpio 7 for gpio 6 which is available on my board (and also gpio 1 - no serial in this model)<br/>with a gpiomask of 0x5c .....</p><p>No luck, once again it seg faults... Probably I just dont understant it and what I am trying doesnt make sense...</p><p>Cyril perhaps could you fix it to work with V1.0? </p><p>I don&#039;t know what else to do.</p><p>I would supposse that it should work just not using gpio 7 because, also when using the gpio utility for locating the gpio points all were correctly located and operating except gpio 7 and gpio 0, even though writing to /proc/diag/led/DMZ or DIAG would correctly change the led. (but no action using gpio utility).</p><p>I hope something of this makes any sense to anyone and comes a fix. Thanks for the great work!</p><p>P.D.: The same problem happens with V1.1. Another guy (_trine) also figured the gpio points for that board but mmc behaviour is the same as in v1.0.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p45127">
				<div class="post-metadata">
					<div class="post-num">Post #42</div>
					<div class="post-author">Cyril</div>
					<div class="post-datetime">
						24 Mar 2007, 23:15					</div>
				</div>
				<div class="post-content content">
					<p>Hello.</p><p>I&#039;ve released a new version (v1.3.4) with these changes :<br/>* MMC init backward compatibility added (frequency limited to 380KHz)<br/>* MMC CID register parsing. It now shows product serial number, product manufacturer, product name, product version, and product release date in the dmesg.</p><p>shadsec : don&#039;t know WRT54G v1. problem. Do you have links to posts/info that I can read ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p45132">
				<div class="post-metadata">
					<div class="post-num">Post #43</div>
					<div class="post-author">shadsec</div>
					<div class="post-datetime">
						25 Mar 2007, 00:31					</div>
				</div>
				<div class="post-content content">
					<p>Hi Cyril!</p><p>There&#039;s no info on SD mod for the v1.x, thats why we had to find where the gpios where for v1.0 and v1.1 boards. Using the gpio utility we found gpios # 1, 2, 3, 4, 5 and 6, all available to use for anything. GPIO 7 and GPIO 0 (if that is diag led) are also probably available because, though unable to find it using gpio utility, the leds get lit by diag when &quot;echo &quot;1&quot; &gt; /prov/diag/leds/DMZ&#039;. </p><p>The reason why we couldn&#039;t make it lit using gpio utility perhaps it is the same as mmc not working... probably both gpio utility and mmc try to &quot;control&quot; it the same way as for v2.0+ WRT&#039;s. Diag works on them because it uses a different structure for WRTGV1 (see my previous post).</p><p>I woulnt mind using different gpios for the SD mod, as many are available and already located on this version (it has no serial so I guess that freeds more), but I tried changing the source to use others, recompiled, and still segmentation fault.</p><p>My understanding is that it was never before tried to use mmc on a WRT54g v1.x, or at least I was unable to find any info on it. The good thing is that diag.c knows how to &quot;work&quot; gpios on this model and it would be a good reference. </p><p>From what I can see, It seems that the polarity is reversed for GPIO7 and also does an EXTIF call that seems to mask the bits differently. Also, other GPIO&#039;s are not defined since they are available but not USED on this model. Perhaps it would be needed to define them before loading mmc module? Please forgive my lack of knowledge about this but I know very little C and have tried all I can do.</p><p>It would be great if you could take a look at that difference in diag.c /diag.h and make a fix for V1.x.</p><p>Again, thanks for the good work!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p45157">
				<div class="post-metadata">
					<div class="post-num">Post #44</div>
					<div class="post-author">Cyril</div>
					<div class="post-datetime">
						25 Mar 2007, 13:32					</div>
				</div>
				<div class="post-content content">
					<p>Hi shadsec</p><div class="quotebox"><cite>shadsec wrote:</cite><blockquote><p>Hi Cyril!<br/>It would be great if you could take a look at that difference in diag.c /diag.h and make a fix for V1.x.</p></blockquote></div><p>Thanks for your advice. I have read the code.<br/>It works the same way than the gpio utility : it uses broadcom closed (or i haven&#039;t found the source code in the kernel) sb_gpio* functions.<br/>The only difference is what you have spotted out : GPIOs bits outputted to gpio register are different.</p><p>The problem with this mmc driver is that we don&#039;t use sb_gpio* broadcom functions because they are too slow.<br/>We are using a hard coded set of addresses instead : 0xb8000060, 0xb8000064, 0xb8000068 to read and write from/to GPIOs.<br/>You got a kernel oops (Segmentation fault) because your router is trying to use an address that doesn&#039;t exist :<br/>$0 : 00000000 1000fc00 <strong>b8000060</strong> c00b0000 <strong>b8000068</strong> 00000000 0000001f 8037a420</p><p>I don&#039;t know where in the address space we have to read/write for your version.<br/>Maybe someone can try do disassemble/reverse closed broadcom binary to find this out.</p><p>mbm ?</p><p>[edit]<br/>Oops: i have found the source of what i called closed gpio functions. Arf.<br/>It is in drivers/net/hnd/sbutils.c !<br/>I am looking at it.</p>											<p class="post-edited">(Last edited by <strong>Cyril</strong> on 25 Mar 2007, 13:52)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p45158">
				<div class="post-metadata">
					<div class="post-num">Post #45</div>
					<div class="post-author">jnjn</div>
					<div class="post-datetime">
						25 Mar 2007, 14:00					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>shadsec wrote:</cite><blockquote><p>Hi Cyril!</p><p>It would be great if you could take a look at that difference in diag.c /diag.h and make a fix for V1.x.</p></blockquote></div><p>hi shadsec. i&#039;ve modified the original mmc driver to support 4702 units (linksys v1 and many baffulo units).<br/>i believe you can find the source in this forum. and yes, it&#039;s slower than the unmodified one, but the best thing is, it realy works.<br/>the source code is here:<br/><a href="http://forum.openwrt.org/viewtopic.php?id=7081">http://forum.openwrt.org/viewtopic.php?id=7081</a></p>											<p class="post-edited">(Last edited by <strong>jnjn</strong> on 25 Mar 2007, 14:15)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p45161">
				<div class="post-metadata">
					<div class="post-num">Post #46</div>
					<div class="post-author">abra</div>
					<div class="post-datetime">
						25 Mar 2007, 14:20					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Cyril wrote:</cite><blockquote><div class="quotebox"><cite>abraXxl wrote:</cite><blockquote><p>b) I can cause kernel oopses with sometime hanging router, when I do the steps in sequence<br/> 1) insmod mmc.o with card inserted<br/> 2) using SD card (fdisk or mount)<br/> 3) unmounting and unloading mmc.o<br/> 4) insmod mmc.o with card inserted<br/> - now defvs complains that some device nodes those already exist<br/> 5) using SD card with user space program like fdisk, e2fsck or mke2fs no matter using part1 or disc device node.</p></blockquote></div></blockquote></div><p>I can&#039;t reproduce it for 1.3.3. But i notice that in /dev/mmc/ the number of discX is increasing each time when i reload (unload then load) the module. I can only use disc0 directory. <br/>When i use fdisk or busybox mount on discX (X&gt;0) they say &quot;no such file or directory&quot;.</p><div class="quotebox"><cite>Cyril wrote:</cite><blockquote><div class="quotebox"><cite>abraXxl wrote:</cite><blockquote><p>c) after using mmc.o (1.2, 1.3.1, 1.3.2) and soft rebooting the router boots auto-magically in failsafe. <br/>I have no guess why. can you give me a hint ?</p></blockquote></div><p>i don&#039;t know. Is 1.3.3 correcting things ?</p></blockquote></div><p>Regarding issue c) I read a bit in /etc/preinit to understand, when OpenWrt should go in safe mode.<br/>It is a trick with hotplug. <br/>While in preinit hotplug events are sent to /sbin/hotplug.failsafe, which sends on button events SIGUSR1 to 1 (/etc/preinit).<br/>Setting FAILSAFE=yes in failsafe via trap. So that eval ${FAILSAFE:+failsafe} executes the failsafe function.<br/>For some case the mmc mod still sends hotplug events after reboot.</p><p>Is it because SD-Card is still active and the gpiomask is reset after reboot ? <br/>Are the hotplug events the answers of the card to switch configuration in /etc/preinit ?<br/>Some other suggestions ?</p><p>Is it possible to trap reboot in module ? To do one of the following: let the SD card sleep and/or reset the gpio pins to boot up settings ?</p><p>cya</p>											<p class="post-edited">(Last edited by <strong>abra</strong> on 25 Mar 2007, 14:25)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p45207">
				<div class="post-metadata">
					<div class="post-num">Post #47</div>
					<div class="post-author">Cyril</div>
					<div class="post-datetime">
						26 Mar 2007, 00:07					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>abraXxl wrote:</cite><blockquote><p>Is it because SD-Card is still active and the gpiomask is reset after reboot ? <br/>Are the hotplug events the answers of the card to switch configuration in /etc/preinit ?<br/>Some other suggestions ?</p></blockquote></div><p>Thanks for all your technical info. Maybe it will help someone (maybe me ?) to find a solution to your problem.</p><p>I am very happy with this entire topic because I am sure there is still a lot to do with this driver :<br/>* better compatibility<br/>* better stability<br/>* maybe some performance improvements.</p><p>The real problem is allways the same ... TIME ! I have tried to look at some stuff (WRT54G v1 compatibility) this week end<br/>and it is already finished ...</p><p>About performance subject :<br/>* WRT54G v1 uses EXTIF (external interface) to control GPIOs. I don&#039;t know how EXTIF performs in read/write speed. I will test and I will certainly post a version for this router this week.<br/>* others use I think PCI (via a SOC Core called ChipCommon). Thats why clock frequency is limited to 16MHz (33MHz/2) at burst speed (in real world it is less than 10MHz because the CPU must do some calculations : arithmetic OR / AND ...).</p><p>- Maybe EXTIF is faster than PCI so I will definitely look at it...<br/>- There is maybe a way to use GPIOs using DMA interface so that CPU is not involved in transfers ? Does someone have an idea about this subject ?</p><p>See ya</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p45239">
				<div class="post-metadata">
					<div class="post-num">Post #48</div>
					<div class="post-author">shadsec</div>
					<div class="post-datetime">
						26 Mar 2007, 17:53					</div>
				</div>
				<div class="post-content content">
					<p>Hi Cyril!</p><div class="quotebox"><cite>Cyril wrote:</cite><blockquote><p>* WRT54G v1 uses EXTIF (external interface) to control GPIOs. I don&#039;t know how EXTIF performs in read/write speed. I will test and I will certainly post a version for this router this week.<br/>- Maybe EXTIF is faster than PCI so I will definitely look at it...</p></blockquote></div><p>Glad to hear that! Even if it isn&#039;t as fast as the other way it will be great to have mmc support for V1.x</p><p>I have everything ready to test it as soon as you have the code <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p><p>Thanks again</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p45242">
				<div class="post-metadata">
					<div class="post-num">Post #49</div>
					<div class="post-author">shadsec</div>
					<div class="post-datetime">
						26 Mar 2007, 18:06					</div>
				</div>
				<div class="post-content content">
					<p>Hi jnjn!</p><div class="quotebox"><cite>jnjn wrote:</cite><blockquote><p>hi shadsec. i&#039;ve modified the original mmc driver to support 4702 units (linksys v1 and many baffulo units).<br/>i believe you can find the source in this forum. and yes, it&#039;s slower than the unmodified one, but the best thing is, it realy works.<br/>the source code is here:<br/><a href="http://forum.openwrt.org/viewtopic.php?id=7081">http://forum.openwrt.org/viewtopic.php?id=7081</a></p></blockquote></div><p>I am not sure if it works for me... After changing the paths in Makefile I made it to compile (not without a big bunch of warnings) and tried it.</p><p>The good thing is that it loaded smoothly, but:</p><p>mmc_driver_init: devfs_register_blkdev start<br/>mmc_driver_init: devfs_register_blkdev finished, major_nr=121, rc=0<br/>mmc_driver_init: blk_init_queue started<br/>mmc_driver_init: blk_init_queue finished<br/>mmc_driver_init: add_gendisk finished<br/>mmc_driver_init: mmc_check_media start<br/>mmc_check_media: old_state=mmc_media_detect=0<br/>mmc_check_media: mmc_init start<br/>mmc_init: mmc_hardware_init start<br/>mmc Hardware init<br/>rc=0<br/>mmc_hardware_init: gpio_outen_jnjn = 45. finished<br/>2_port_state_jnjn=245<br/>//set di/clk/cs to low state finished.<br/>3_port_state_jnjn=209<br/>mmc Card init<br/>4_port_state_jnjn=241<br/>5_port_state_jnjn=213<br/>r = mmc_spi_io(0xff) = 255<br/>r = mmc_spi_io(0xff) = 255<br/>r = mmc_spi_io(0xff) = 255<br/>r = mmc_spi_io(0xff) = 255<br/>r = mmc_spi_io(0xff) = 255<br/>r = mmc_spi_io(0xff) = 255<br/>r = mmc_spi_io(0xff) = 255<br/>r = mmc_spi_io(0xff) = 255<br/>mmc Card init<br/>4_port_state_jnjn=245<br/>5_port_state_jnjn=213<br/>r = mmc_spi_io(0xff) = 255<br/>r = mmc_spi_io(0xff) = 255<br/>r = mmc_spi_io(0xff) = 255<br/>r = mmc_spi_io(0xff) = 255<br/>r = mmc_spi_io(0xff) = 255<br/>r = mmc_spi_io(0xff) = 255<br/>r = mmc_spi_io(0xff) = 255<br/>r = mmc_spi_io(0xff) = 255<br/>mmc: error in mmc_card_init (1)<br/>mmc: error in mmc_init (-1)<br/>mmc_driver_init: mmc_check_media exit</p><p>It says the same either if I have an SD card in the socket or not. </p><p>To make sure it wasnt my fault, I swapped gpios in my wiring and also in the source. Again the same result, except for a change in:</p><p>[original]<br/>mmc_hardware_init: gpio_outen_jnjn = 1. finished<br/>2_port_state_jnjn=209<br/>//set di/clk/cs to low state finished.<br/>3_port_state_jnjn=209<br/>mmc Card init<br/>4_port_state_jnjn=241<br/>5_port_state_jnjn=213</p><p>[Other gpios]<br/>mmc_hardware_init: gpio_outen_jnjn = 45. finished<br/>2_port_state_jnjn=245<br/>//set di/clk/cs to low state finished.<br/>3_port_state_jnjn=85<br/>mmc Card init<br/>4_port_state_jnjn=213<br/>5_port_state_jnjn=117</p><p>I think I didnt make any mistake in the wiring, but as it is untested I can&#039;t be positively sure. If you tell me this code should work for WRT54G V1.0 I will try again from scratch... Or perhaps from the output you can tell me what may be?</p><p>Thanks!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p45262">
				<div class="post-metadata">
					<div class="post-num">Post #50</div>
					<div class="post-author">Cyril</div>
					<div class="post-datetime">
						26 Mar 2007, 23:12					</div>
				</div>
				<div class="post-content content">
					<p>shadsec :</p><p>Hello. I got news for you.</p><p>But before:<br/>Please don&#039;t send output of another mmc driver version here as the post is only for the optimized version.&nbsp; It confuses users.<br/>You can post in the old jnjn post or try to call him in a private way. Thanks in advance.</p><p>For the news:<br/>Here is the source of a 1.3.5 version that searches at runtime for GPIO addresses specific to each router.<br/>Would you please test it and report me if it crashes like the 1.3.4 ?<br/>If not, please output the dmesg and I will finalize the version for tomorrow.<br/><a href="http://programmingstuff.free.fr/files/openwrt/whiterussian/mmc/1_3_5/src/">source of 1.3.5 work</a></p><p>Cyril</p>											<p class="post-edited">(Last edited by <strong>Cyril</strong> on 26 Mar 2007, 23:14)</p>
									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 2 of 7</div><nav><ul><li><a href="viewtopic.php%3Fid=9653&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=9653&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=9653&amp;p=4.html">4</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=9653&amp;p=7.html">7</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>