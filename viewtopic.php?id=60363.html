<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Ability to &quot;tee&quot; LuCI GUI commands to script file?</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 25 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p296396">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">richbhanover</div>
					<div class="post-datetime">
						17 Oct 2015, 17:31					</div>
				</div>
				<div class="post-content content">
					<p>I would find it useful to produce a script file of the LuCI commands that get issued when you use the LuCI web GUI.</p><p>That is, as I configure interfaces, set time zone, install packages, change other parameters via the GUI, I&#039;d also like to write those exact luci commands to a separate script file for replay at a later time.</p><p>Why?</p><p>- You can be sure of your configuration. You flash from stock/factory, then apply the script to make additional changes.</p><p>- When re-flashing the router, you don&#039;t have to worry about whether the upgrade image can use your earlier settings..</p><p>- You can version-control the script, so that changes are tracked.</p><p>- You can reliably pass along config&#039;s to others.</p><p>So: Is it possible to have the LuCI web gui write out all the commands that get sent to its command line?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p296443">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						17 Oct 2015, 23:51					</div>
				</div>
				<div class="post-content content">
					<p>Never heard of such functionality.</p><p>But most of the actual settings are set via uci, so you might check uci possibilities. Is there any way to save the not yet saved changes?<br />That does not apply to installing new packages etc.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p296444">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						17 Oct 2015, 23:53					</div>
				</div>
				<div class="post-content content">
					<p>it&#039;s possible to have a bash file with *uci* commands to set things up.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p296626">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">richbhanover</div>
					<div class="post-datetime">
						19 Oct 2015, 20:04					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>richbhanover wrote:</cite><blockquote><p>I would find it useful to produce a script file of the LuCI commands that get issued when you use the LuCI web GUI.</p></blockquote></div><p>D&#039;oh! I meant that I&#039;d like to produce a script file of the <strong>uci</strong> commands...</p><p>And yes, I&#039;d use those (automatically-collected) uci commands to create a bash/ash script that I could replay after flashing factory firmware...</p><p>So, to repeat my question: is there a way to write/capture all the <strong>uci</strong> commands that get generated by the LuCI web gui? Thanks.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p296633">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						19 Oct 2015, 20:42					</div>
				</div>
				<div class="post-content content">
					<p>Like I said in my first answer, I have not heard of that functionality being implemented. But below is two different approaches that may help you in your goal:</p><p>1)<br />The command &quot;uci changes&quot; is probably the closest to what you are looking for. That command displays the changes made but not yet committed to the actual config files in flash. E.g.<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# uci changes
luci_statistics.collectd_conntrack.enable=&#039;0&#039;
luci_statistics.collectd_interface.enable=&#039;0&#039;
-luci_statistics.collectd_interface.Interfaces
-luci_statistics.collectd_interface.IgnoreSelected</code></pre></div><p>If you do all your settings first using just &#039;save&#039; in Luci, all the settings will be &#039;unsaved changes&#039; and manually running &quot;uci changes&quot; from console will give you a list of the changes. You could save that list and edit it a bit to contain full uci commands (usually just add &quot;uci set &quot; to each line. Manual work, but could be done.</p><p>A proper solution for you might be to alter Luci&#039;s &quot;apply&quot; procedure to include an &quot;uci changes&quot; step before the actual apply and to store the commands into a log.</p><p>2)<br />Other approach might be to diff original config files to your config after the changes. If you have included all packages in a firmware compiled by yourself, the /rom/etc/config directory will contain the original configs. I have been using the script below to find out my changes compared to originals. The script uses uci to eliminate whitespace and comments etc.:<br /></p><div class="codebox"><pre><code>#!/bin/sh
cd /etc/config
for F in *
do
        echo
        echo &quot;===== $F =====&quot;
        uci -c /rom/etc/config export $F &gt;/tmp/$F.default 2&gt;/dev/null
        case $? in 0) ;; *) echo &#039;&gt;&gt; no default in /rom &lt;&lt;&#039; ;; esac
        uci export $F &gt;/tmp/$F.current
        diff /tmp/$F.default /tmp/$F.current
        rm -f /tmp/$F.default /tmp/$F.current
done</code></pre></div><p>That works for most config files, but not for network and wireless, as they are created on the fly at the first boot (at least in ar71xx).</p><p>The output is not the uci commands you are looking for, but still a concrete and rather compact comparison.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p296639">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">richbhanover</div>
					<div class="post-datetime">
						19 Oct 2015, 22:02					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>hnyman wrote:</cite><blockquote><p>Like I said in my first answer, I have not heard of that functionality being implemented. But below is two different approaches that may help you in your goal:</p><p>1)<br />The command &quot;uci changes&quot; is probably the closest to what you are looking for. That command displays the changes made but not yet committed to the actual config files in flash. E.g.<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# uci changes
luci_statistics.collectd_conntrack.enable=&#039;0&#039;
luci_statistics.collectd_interface.enable=&#039;0&#039;
-luci_statistics.collectd_interface.Interfaces
-luci_statistics.collectd_interface.IgnoreSelected</code></pre></div><p>If you do all your settings first using just &#039;save&#039; in Luci, all the settings will be &#039;unsaved changes&#039; and manually running &quot;uci changes&quot; from console will give you a list of the changes. You could save that list and edit it a bit to contain full uci commands (usually just add &quot;uci set &quot; to each line. Manual work, but could be done.</p><p>A proper solution for you might be to alter Luci&#039;s &quot;apply&quot; procedure to include an &quot;uci changes&quot; step before the actual apply and to store the commands into a log.</p></blockquote></div><p>This is BRILLIANT! Yes, there&#039;s a little bit of manual work required, but it eliminates the need for most of the translation between uci commands and the resulting config files (especially since I was worrying particularly about the /etc/config/wireless and /etc/config/network files.) </p><p>I&#039;ll post an update to this when I have more info. Thanks!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p296721">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						20 Oct 2015, 12:12					</div>
				</div>
				<div class="post-content content">
					<p>Thanks. A few more pointers you:</p><p>I started to create such a uci settings script two years ago, but I was not quite happy with the end result, so I have never maintained it properly.</p><p>I used &quot;uci show&quot; to find out the changes made&nbsp; (I compared ROM vs. current) and to display them in uci format:<br /></p><div class="codebox"><pre><code>#!/bin/sh
cd /etc/config
for F in *
do
        echo
        echo &quot;===== $F =====&quot;
        uci -c /rom/etc/config show $F | sort &gt;/tmp/$F.default 2&gt;/dev/null
        case $? in 0) ;; *) echo &#039;&gt;&gt; no default in /rom &lt;&lt;&#039; ;; esac
        uci show $F | sort &gt;/tmp/$F.current
        diff /tmp/$F.default /tmp/$F.current
done</code></pre></div><p>(the script in the previous example used &quot;uci export&quot;, this is &quot;uci show&quot;)</p><p>I then created the script for applying my settings.</p><p>Most of the changes are &quot;uci set &quot;, but some subsettings need to be &quot;uci add &quot; like e.g. creating a new firewall rule or a dhcp static definition:<br /></p><div class="codebox"><pre><code>+firewall.@rule[9].dest_ip=192.168.1.1
+firewall.@rule[9].dest_port=22
+firewall.@rule[9].name=wanSsh
+firewall.@rule[9].proto=tcp
+firewall.@rule[9].src=wan
+firewall.@rule[9].target=ACCEPT
+firewall.@rule[9]=rule

--&gt;

uci add firewall rule
uci set firewall.@rule[-1].target=ACCEPT
uci set firewall.@rule[-1].src=wan
uci set firewall.@rule[-1].proto=tcp
uci set firewall.@rule[-1].name=wanSsh
uci set firewall.@rule[-1].dest_port=22
uci set firewall.@rule[-1].dest_ip=192.168.1.1</code></pre></div><p>I created a script that fully applied my settings, but in the end I abandoned it. Currently I still include the few config files and ssh keys as an encrypted small archive in my community firmware. I can then extract my personal settings files with a simple command using a password. See <a href="https://forum.openwrt.org/viewtopic.php?pid=142896#p142896">https://forum.openwrt.org/viewtopic.php … 96#p142896</a></p>											<p class="post-edited">(Last edited by <strong>hnyman</strong> on 20 Oct 2015, 12:20)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>