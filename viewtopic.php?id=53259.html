<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Missing logs in syslog-ng3</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 30 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p250015">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">morfik</div>
					<div class="post-datetime">
						10 Oct 2014, 17:23					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ve been trying to set encrypted remote logging up, where my router is the client and sends logs to a debian server.&nbsp; My router is TP-Link TL-WR1043N/ND v2 and has OpenWrt Barrier Breaker (r42742) installed.</p><p>I configured syslog-ng3 to send logs using the following config file:</p><div class="codebox"><pre><code>@version:3.0

options {
    # disable the chained hostname format in logs
    chain_hostnames(off);
    
    # the time to wait before a died connection is re-established
    time_reopen (0);
    
    # the time to wait before an idle destination file is closed
    time_reap(0);
    
    # the number of lines buffered before written to file
    # you might want to increase this if your disk isn&#039;t catching with
    # all the log messages you get or if you want less disk activity
    # (say on a laptop)
    flush_lines(0);
    
    # the number of lines fitting in the output queue
    log_fifo_size(256);
    
    # enable or disable directory creation for destination files
    create_dirs(no);
    
    # default owner, group, and permissions for log files
    owner(root);
    perm(0600);
    #group(&quot;log&quot;);
    
    # default owner, group, and permissions for created directories
    #dir_owner(root);
    #dir_group(root);
    #dir_perm(0755);
    
    # enable or disable DNS usage
    # syslog-ng blocks on DNS queries, so enabling DNS may lead to
    # a Denial of Service attack
    use_dns(no);

    # maximum length of message in bytes
    # this is only limited by the program listening on the /dev/log Unix socket
    log_msg_size(1024);

    # Disable statistic log messages.
    stats_freq(0);
    
    # &quot;--MARK--&quot; entries in the log
    mark_freq (1800);
    
    keep_hostname(yes);
    use_fqdn(no);
    long_hostnames(on);
#    ts_format(iso);      #make ISO-8601 timestamps
};


source s_all {
    # message generated by Syslog-NG
    internal();
    # standard Linux log source (this is the default place for the syslog() function to send logs to)
    unix-stream(&quot;/dev/log&quot;);
    # messages from the kernel
    file(&quot;/proc/kmsg&quot; program_override(&quot;kernel&quot;));    
};

source s_localhost {
    tcp(ip(127.0.0.1) port(514));
    udp(ip(127.0.0.1) port(514));
};

destination d_messages {
    file(&quot;/var/log/messages&quot;);
};

destination d_network {
#    tcp( &quot;192.168.1.150&quot; port(514) );
    tcp( &quot;192.168.1.150&quot; port(514)
        tls( ca_dir(&quot;/etc/syslog-ng.cert&quot;)
            key_file(&quot;/etc/syslog-ng.cert/router.lh.key&quot;) 
            cert_file(&quot;/etc/syslog-ng.cert/router.lh.crt&quot;)
#            peer_verify(optional-untrusted)
            peer_verify(required-trusted)
            )
        );
};


log {
    source(s_all);
    source(s_localhost);
    destination(d_messages);
    destination(d_network);
};</code></pre></div><p>The connection works well and the logs are encrypted, but some logs are missing -- there&#039;s no cron and auth entries. When I type &quot;logread&quot;, I can see them.</p><p>I also tried to set the native logging up, just to check if that would work, by adding the following entries to /etc/config/system :</p><div class="codebox"><pre><code>config system
...
       option log_type &#039;file&#039;
       option log_file &#039;/var/log/messages&#039;
       option log_size &#039;64&#039;
       option log_ip   &#039;192.168.1.150&#039;
       option log_port &#039;514&#039;
       option log_proto &#039;tcp&#039;
#     option log_prefix &#039;router &#039;</code></pre></div><p>I couldn&#039;t enable encryption, but the setup also works, and this time, it sends full log including auth and cron. </p><p>Is there any way to enable auth, cron and some other facilities in syslog-ng3?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p250462">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">morfik</div>
					<div class="post-datetime">
						14 Oct 2014, 03:34					</div>
				</div>
				<div class="post-content content">
					<p>I found a solution. It looks like that the /etc/init.d/log script was eating most of the log, and that&#039;s why syslog-ng couldn&#039;t do its job. I disabled that script via &quot;/etc/init.d/log disable&quot;, and now the whole log goes to syslog-ng so it can be stored locally in the /var/log/messages file and also be sent via TLS tunnel to the other PC.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>