<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> network works on vmlinux but not on firmwared router</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 4 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p265474">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">deathangel908</div>
					<div class="post-datetime">
						14 Feb 2015, 13:01					</div>
				</div>
				<div class="post-content content">
					<p>Hi, I got a strange issue on my Mikrotik RB951-2hnd. To firmware this device you need to bootp on initramfs-vmlinux, erase partitions, scp rootfs and copy them to device. So I booted on vmlinux and network worked fine without any issues, I was able to copy files over ssh and firmware them and didn&#039;t even notice anything suspicious. </p><p>When I rebooted to just firmwared router I found out that my laptop didn&#039;t acquire an ip address from dhcp router&#039;s server. Lucky for me I have the uart port, so I logged via serial and system works properly.&nbsp; I uncomment wifi in /etc/network/wifi, and surprisingly I&#039;m able to connect the router via wifi, ping, scp files etc. I reboot the router with serial connected and noticed that there were not any <a href="http://textuploader.com/6q4e">kernel</a> error, nor <a href="http://textuploader.com/6qla">logread</a> errors either. <a href="http://textuploader.com/6ct8">ps</a> shows that all required processes seem to be running. </p><p>So I dig a bit deeper. I run tcpdump on openwrt and wireshark on my laptop (previusly scp package over wifi (cause it&#039;s the only working thing in my network) and installed it).My laptop sends packages to mikrotik including dhcprequest, but router&#039;s tcpdump shows only included in code section bellow. ps. I&#039;m using bleeding edge (latest developers revision)).</p><p>I also tried to firmware the router from downloads.openwrt.org image but it has the same issue (vmlinux-initramfs works on it too) . What should I try next? I don&#039;t even know where I should be looking for, because there&#039;re no errors. I also had been running openwrt on this device before (12.04), but I had some issues with rebooting every 5 hours nevertheless network worked perfectly.&nbsp; Seems like rebooting issue is gone now. </p><div class="codebox"><pre><code>[09:34:15.779328 IP6 fe80::d6ca:6dff:fe92:a47e &gt; ff02::1: HBH ICMP6, multicast listener querymax resp delay: 10000 addr: ::, length 24
09:34:15.869302 IP6 fe80::d6ca:6dff:fe92:a47e &gt; ff02::1:ff00:0: HBH ICMP6, multicast listener reportmax resp delay: 0 addr: ff02::1:ff00:0, length 24
09:34:19.719294 IP6 fe80::d6ca:6dff:fe92:a47e &gt; ff05::1:3: HBH ICMP6, multicast listener reportmax resp delay: 0 addr: ff05::1:3, length 24
09:34:22.059297 IP6 fe80::d6ca:6dff:fe92:a47e &gt; ff02::2: HBH ICMP6, multicast listener reportmax resp delay: 0 addr: ff02::2, length 24
09:34:23.479305 IP6 fe80::d6ca:6dff:fe92:a47e &gt; ff02::1:ff92:a47e: HBH ICMP6, multicast listener reportmax resp delay: 0 addr: ff02::1:ff92:a47e, length 24
09:34:23.559283 IP6 fe80::d6ca:6dff:fe92:a47e &gt; ff02::1:ff00:1: HBH ICMP6, multicast listener reportmax resp delay: 0 addr: ff02::1:ff00:1, length 24
09:34:24.139291 IP6 fe80::d6ca:6dff:fe92:a47e &gt; ff02::1:2: HBH ICMP6, multicast listener reportmax resp delay: 0 addr: ff02::1:2, length 24</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p265826">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">deathangel908</div>
					<div class="post-datetime">
						17 Feb 2015, 00:24					</div>
				</div>
				<div class="post-content content">
					<p>up</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p265840">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">mk24</div>
					<div class="post-datetime">
						17 Feb 2015, 03:03					</div>
				</div>
				<div class="post-content content">
					<p>Have you checked the switch and network configurations to make sure the ethernet port you are trying to use is in the lan and not the wan?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p265872">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">deathangel908</div>
					<div class="post-datetime">
						17 Feb 2015, 08:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mk24 wrote:</cite><blockquote><p>Have you checked the switch and network configurations to make sure the ethernet port you are trying to use is in the lan and not the wan?</p></blockquote></div><p>Sure, I even tried to diff rootfs on vmlinux-initramfs and live system. Those are the same. Sometimes I do receive ip address on wan, but ping throw wan doesn&#039;t work though. I tried static ip on my laptop, didn&#039;t work either. I think I just need to more tests with tcpdump or something (maybe compile image with debug info, but I don&#039;t know how to use debugging)</p>											<p class="post-edited">(Last edited by <strong>deathangel908</strong> on 17 Feb 2015, 08:29)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p266149">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">deathangel908</div>
					<div class="post-datetime">
						19 Feb 2015, 18:39					</div>
				</div>
				<div class="post-content content">
					<p>up</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p266761">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">deathangel908</div>
					<div class="post-datetime">
						24 Feb 2015, 17:50					</div>
				</div>
				<div class="post-content content">
					<p>up</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p267201">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">deathangel908</div>
					<div class="post-datetime">
						1 Mar 2015, 00:40					</div>
				</div>
				<div class="post-content content">
					<p>up</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p269079">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">metsys</div>
					<div class="post-datetime">
						18 Mar 2015, 04:01					</div>
				</div>
				<div class="post-content content">
					<p>Отпишись мне на мыло пожалуйста, есть некоторый опыт в борьбе с этой железякой<br />metsys@gmx.com</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p278190">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">deathangel908</div>
					<div class="post-datetime">
						30 May 2015, 18:58					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>metsys wrote:</cite><blockquote><p>Отпишись мне на мыло пожалуйста, есть некоторый опыт в борьбе с этой железякой<br />metsys@gmx.com</p></blockquote></div><p>Отписался!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p278409">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">deathangel908</div>
					<div class="post-datetime">
						1 Jun 2015, 12:40					</div>
				</div>
				<div class="post-content content">
					<p>Just firmwared chaos calmer image, Symptoms are the same, though wifi works fine. <br />I&#039;m able to connect to other network in `sta` client mode and work throw wifi. Everything but physical ethernet works.</p><p> It really seems like default configuration is messed up. <br /><a href="http://textuploader.com/70gg"> iptables -L -n </a> <br /><a href="http://textuploader.com/70uq"> /etc/config/network </a> - 1 wan. 2-5 lan (wifi in sta client mode)</p><p>When I connect a cable kernel tells me what port has been plugged in. So 1 is wan, 2-5 lan. Not sure about 0 - should be the cpu. Just checked again tcpdump, laptop sends dhcprequest but the router didn&#039;t receive any. What the heck? Why initramfs works ok and firmwared image is broken? </p><br /><p><strong>After plugging laptop (dhcp client) to lan port for 15 seconds ( plug out after) I see the followings</strong>:<br /></p><ul><li><p>Laptop send:&nbsp; 3 dhcp request and 9 icmpv6 </p></li><li><p>Laptop receive: 0 packages</p></li></ul><ul><li><p>router sends: None ? (ifconfig displays 4 packages but tcpdump doesn&#039;t catch them)&nbsp; </p></li><li><p>router receives: 2 icmp packages from Laptop sent list (listed below) </p></li></ul><div class="codebox"><pre><code>root@OpenWrt:/# tcpdump -vv -i eth0.3
tcpdump: WARNING: eth0.3: no IPv4 address assigned
tcpdump: listening on eth0.3, link-type EN10MB (Ethernet), capture size 65535 bytes
[ 1042.060000] Atheros AR8216/AR8236/AR8316 ag71xx-mdio.0:00: Port 2 is up
09:35:24.172637 IP6 (hlim 1, next-header Options (0) payload length: 36) :: &gt; ff02::16: HBH (rtalert: 0x0000) (padn) [icmp6 sum ok] ICMP6, m]
09:35:25.872843 IP6 (hlim 255, next-header ICMPv6 (58) payload length: 16) fe80::b2e3:928a:66b2:ff43 &gt; ff02::2: [icmp6 sum ok] ICMP6, router6
          source link-address option (1), length 8 (1): 5c:f9:dd:48:9e:89
            0x0000:  5cf9 dd48 9e89</code></pre></div><p> 5c:f9:dd:48:9e:89 /fe80::b2e3:928a:66b2:ff43 - laptop,&nbsp; d4:ca:6d:92:a4:7e / fe80::d6ca:6dff:fe92:a47e: - router</p><p><strong>Here&#039;s the scenario for static ip</strong><br />openwrt (static 192.168.2.1)<br /></p><div class="codebox"><pre><code>root@OpenWrt:/# ping 192.168.2.2
PING 192.168.2.2 (192.168.2.2): 56 data bytes
64 bytes from 192.168.2.2: seq=4 ttl=64 time=0.505 ms
64 bytes from 192.168.2.2: seq=21 ttl=64 time=0.489 ms
64 bytes from 192.168.2.2: seq=34 ttl=64 time=0.528 ms
64 bytes from 192.168.2.2: seq=39 ttl=64 time=0.512 ms
64 bytes from 192.168.2.2: seq=45 ttl=64 time=0.527 ms
64 bytes from 192.168.2.2: seq=48 ttl=64 time=0.549 ms
64 bytes from 192.168.2.2: seq=51 ttl=64 time=0.813 ms
^C
--- 192.168.2.2 ping statistics ---
56 packets transmitted, 7 packets received, 87% packet loss
round-trip min/avg/max = 0.489/0.560/0.813 ms</code></pre></div><p>laptop (static 192.168.2.2)<br /></p><div class="codebox"><pre><code>14:50:08:andrew:/home/andrew:0
: ping 192.168.2.1
PING 192.168.2.1 (192.168.2.1) 56(84) bytes of data.
From 192.168.2.2 icmp_seq=13 Destination Host Unreachable
From 192.168.2.2 icmp_seq=14 Destination Host Unreachable
From 192.168.2.2 icmp_seq=15 Destination Host Unreachable
^C
--- 192.168.2.1 ping statistics ---
100 packets transmitted, 0 received, +3 errors, 100% packet loss, time 99022ms
pipe 3
14:51:53:andrew:/home/andrew:1
: ping 192.168.2.1
PING 192.168.2.1 (192.168.2.1) 56(84) bytes of data.
^C
--- 192.168.2.1 ping statistics ---
29 packets transmitted, 0 received, 100% packet loss, time 28080ms</code></pre></div>											<p class="post-edited">(Last edited by <strong>deathangel908</strong> on 1 Jun 2015, 14:56)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297267">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">deathangel908</div>
					<div class="post-datetime">
						24 Oct 2015, 14:51					</div>
				</div>
				<div class="post-content content">
					<p>Ok i finally found the reason. Initramfs wasn&#039;t the key of success It turns out that ethernet ports only work if router was booted with pressed reset button. This is really bizarre...</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>