<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> [Howto](AAP) Automated Wifi network change if the current fails</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 1 Sep 2014 and 5 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 4 of 5</div><nav><ul><li><a href="viewtopic.php%3Fid=43352&amp;p=1.html">1</a></li><li><a href="viewtopic.php%3Fid=43352&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=43352&amp;p=3.html">3</a></li><li class="pagination-current"><span>4</span></li><li><a href="viewtopic.php%3Fid=43352&amp;p=5.html">5</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p298798">
				<div class="post-metadata">
					<div class="post-num">Post #76</div>
					<div class="post-author">phantnang</div>
					<div class="post-datetime">
						6 Nov 2015, 08:49					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dabyd64 wrote:</cite><blockquote><p>Reboot and it will check again, or mod the script as you like.<br />It won&#039;t check the wifi while being connected because it will break internet everytime.<br />It only checks when it fails, then if WiFi1 is found it will connected to it.</p></blockquote></div><p>thank your reply, dabyd64<br />but i&#039;m not well in linux&#039;s script. can you help me? add one more script for me, it check curent SSID for every hours if not SSID1 then execute scanning with your&#039;s script (without checking network status)!<br />sorry, i&#039;m not well english</p>											<p class="post-edited">(Last edited by <strong>phantnang</strong> on 6 Nov 2015, 10:20)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p298830">
				<div class="post-metadata">
					<div class="post-num">Post #77</div>
					<div class="post-author">dabyd64</div>
					<div class="post-datetime">
						6 Nov 2015, 16:36					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ll mod the current wifimgr script if that helps you.<br />Now it will scan using the wlan0 interface, meaning that it will not cut internet when scanning, but I&#039;ve not tested it thoroughly.</p><p>But keep in mind, that if the preferred network is enabled and not giving internet, everytime it scans, it will switch to that network, fail the internet checks and set a working network.<br />So, in that condition, it will give a short cut everytime it checks.<br />But if the network just dissapears, it will work silently.<br />Just replace your current wifiMgr.sh with this one: <a href="https://dl.dropboxusercontent.com/u/23958662/wifiMgrsh_1.0b.zip">Download</a></p>											<p class="post-edited">(Last edited by <strong>dabyd64</strong> on 6 Nov 2015, 16:37)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p299007">
				<div class="post-metadata">
					<div class="post-num">Post #78</div>
					<div class="post-author">phantnang</div>
					<div class="post-datetime">
						8 Nov 2015, 17:13					</div>
				</div>
				<div class="post-content content">
					<p>it can&#039;t change to SSID2 when SSID1 down but could reconnect SSID1 when it&#039;s up. Could you test and fix it for me? I propose one alternative is: adding another script, it execute &#039;wifiMgr.sh --force&#039; when current SSID not SSID1, &#039;Scheduled Tasks&#039; will execute this script for every hours with command &#039;0 * * * * ./this_script&#039;. but i don&#039;t know the syntax for this!<br />sorry my bad english<br />thank for your&#039;s all replies!</p>											<p class="post-edited">(Last edited by <strong>phantnang</strong> on 8 Nov 2015, 17:30)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p299018">
				<div class="post-metadata">
					<div class="post-num">Post #79</div>
					<div class="post-author">dabyd64</div>
					<div class="post-datetime">
						8 Nov 2015, 18:05					</div>
				</div>
				<div class="post-content content">
					<p>Post the logs of your tests<br />Logread | grep wifiMgr</p>											<p class="post-edited">(Last edited by <strong>dabyd64</strong> on 8 Nov 2015, 19:10)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p299159">
				<div class="post-metadata">
					<div class="post-num">Post #80</div>
					<div class="post-author">phantnang</div>
					<div class="post-datetime">
						9 Nov 2015, 20:29					</div>
				</div>
				<div class="post-content content">
					<p>shucks!!! the first test with wifimgr.sh is ok but after testing with openvpn i&#039;m renew config and it fail. i&#039;ll test it again when free time. thank you very much, dabyd64.</p>											<p class="post-edited">(Last edited by <strong>phantnang</strong> on 10 Nov 2015, 04:35)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p299980">
				<div class="post-metadata">
					<div class="post-num">Post #81</div>
					<div class="post-author">phantnang</div>
					<div class="post-datetime">
						16 Nov 2015, 04:09					</div>
				</div>
				<div class="post-content content">
					<p>wifiMgrsh_1.0b not work! it&#039; not change to preferred networks.</p><p>*my config file:<br />net1_ssid=&quot;15A3&quot;<br />net1_encrypt=&quot;psk2&quot;<br />net1_key=&quot;internet&quot;</p><p>net2_ssid=&quot;15A2&quot;<br />net2_encrypt=&quot;psk2&quot;<br />net2_key=&quot;internet&quot;</p><p>net3_ssid=&quot;OpenWifi&quot;<br />net3_encrypt=&quot;psk2&quot;<br />net3_key=&quot;internet&quot;</p><p>*the log is here:<br />Nov 16 02:04:46 OpenWrt user.notice root: WifiMgr: Network OK, preferred network not found.<br />Nov 16 02:05:46 OpenWrt user.notice root: WifiMgr: Checking network...<br />Nov 16 02:05:50 OpenWrt user.info sysinit: sh: missing ]<br />Nov 16 02:05:53 OpenWrt user.notice root: WifiMgr: Network OK, preferred network not found.<br />Nov 16 02:06:53 OpenWrt user.notice root: WifiMgr: Checking network...<br />Nov 16 02:06:57 OpenWrt user.info sysinit: sh: missing ]<br />Nov 16 02:06:59 OpenWrt user.notice root: WifiMgr: Network OK, but switching to preferred network.<br />Nov 16 02:06:59 OpenWrt user.notice root: WifiMgr: WifiMgr: Searching available networks...<br />Nov 16 02:06:59 OpenWrt user.notice root: WifiMgr: OpenWifi network found. Applying settings..\</p><p>p/s: how to edit your&#039;s script?? i only change &#039;google.es&#039; to &#039;google.com&#039;, it&#039;s fail!</p>											<p class="post-edited">(Last edited by <strong>phantnang</strong> on 16 Nov 2015, 04:23)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300297">
				<div class="post-metadata">
					<div class="post-num">Post #82</div>
					<div class="post-author">dabyd64</div>
					<div class="post-datetime">
						18 Nov 2015, 17:47					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>phantnang wrote:</cite><blockquote><p>wifiMgrsh_1.0b not work! it&#039; not change to preferred networks.<br />p/s: how to edit your&#039;s script?? i only change &#039;google.es&#039; to &#039;google.com&#039;, it&#039;s fail!</p></blockquote></div><p>Try this, I think I had done a small error <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> :<br /><a href="https://dl.dropboxusercontent.com/u/23958662/wifiMgr_1.0b.zip">https://dl.dropboxusercontent.com/u/239 â€¦ r_1.0b.zip</a></p><p>Also, now you can change your ping target, just edit &quot;PingTarget&quot; inside config <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p>											<p class="post-edited">(Last edited by <strong>dabyd64</strong> on 19 Nov 2015, 22:27)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300444">
				<div class="post-metadata">
					<div class="post-num">Post #83</div>
					<div class="post-author">phantnang</div>
					<div class="post-datetime">
						19 Nov 2015, 18:45					</div>
				</div>
				<div class="post-content content">
					<p>very thank you, dabyd64! it work well !!!!<br />but there&#039;s still &quot;google.es&quot; in script and &quot;PingTarget&quot; is not in config! it does not matter to me but I want more: suppose ssid1 is the first preferred network, ssid2 is 2nd, ssid3 is 3th....can you help me one more time. <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p>											<p class="post-edited">(Last edited by <strong>phantnang</strong> on 19 Nov 2015, 19:10)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300474">
				<div class="post-metadata">
					<div class="post-num">Post #84</div>
					<div class="post-author">dabyd64</div>
					<div class="post-datetime">
						19 Nov 2015, 22:26					</div>
				</div>
				<div class="post-content content">
					<p>Oops, I forgot to upload the corrected version! <img src="https://forum.openwrt.org/img/smilies/tongue.png" width="15" height="15" alt="tongue" /> <br />Try now!<br /><a href="https://dl.dropboxusercontent.com/u/23958662/wifimgr/wifiMgr_1.0b.zip">https://dl.dropboxusercontent.com/u/239 â€¦ r_1.0b.zip</a></p>											<p class="post-edited">(Last edited by <strong>dabyd64</strong> on 22 Apr 2016, 22:43)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300593">
				<div class="post-metadata">
					<div class="post-num">Post #85</div>
					<div class="post-author">phantnang</div>
					<div class="post-datetime">
						20 Nov 2015, 17:56					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dabyd64 wrote:</cite><blockquote><p>Try this, I think I had done a small error <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> :<br /><a href="https://dl.dropboxusercontent.com/u/23958662/wifiMgr_1.0b.zip">https://dl.dropboxusercontent.com/u/239 â€¦ r_1.0b.zip</a></p><p>Also, now you can change your ping target, just edit &quot;PingTarget&quot; inside config <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p></blockquote></div><p>I have tested it thoroughly, it work. however it still bugs in a few situations. perhaps i must make by myself! can you give me some resources about scripts on openwrt.</p><div class="quotebox"><cite>dabyd64 wrote:</cite><blockquote><p>Oops, I forgot to upload the corrected version! <img src="https://forum.openwrt.org/img/smilies/tongue.png" width="15" height="15" alt="tongue" /> <br />Try now!<br /><a href="https://dl.dropboxusercontent.com/u/23958662/wifiMgr_1.0b.zip">https://dl.dropboxusercontent.com/u/239 â€¦ r_1.0b.zip</a></p></blockquote></div><p>it don&#039;t work, can&#039;t change next wifi when current ssid down!<br />my log:<br />Nov 20 13:51:50 OpenWrt user.notice root: WifiMgr: Checking network...<br />Nov 20 13:52:04 OpenWrt user.notice root: WifiMgr: Network failed. Starting network change...<br />Nov 20 13:52:04 OpenWrt user.notice root: WifiMgr: Netchange return<br />Nov 20 13:52:04 OpenWrt user.notice root: WifiMgr: WifiMgr: Searching available networks...<br />Nov 20 13:53:05 OpenWrt user.notice root: WifiMgr: Checking network...<br />Nov 20 13:53:20 OpenWrt user.info sysinit: ping: can&#039;t create raw socket: Address family not supported by protocol<br />Nov 20 13:53:20 OpenWrt user.notice root: WifiMgr: Network failed. Starting network change...<br />Nov 20 13:53:20 OpenWrt user.notice root: WifiMgr: Netchange return<br />Nov 20 13:53:20 OpenWrt user.notice root: WifiMgr: WifiMgr: Searching available networks...<br />Nov 20 13:54:20 OpenWrt user.notice root: WifiMgr: Checking network...<br />Nov 20 13:54:50 OpenWrt user.info sysinit: ping: bad address &#039;google.com&#039;<br />Nov 20 13:54:50 OpenWrt user.notice root: WifiMgr: Network failed. Starting network change...<br />Nov 20 13:54:50 OpenWrt user.notice root: WifiMgr: Netchange return<br />Nov 20 13:54:50 OpenWrt user.notice root: WifiMgr: WifiMgr: Searching available networks...<br />Nov 20 13:55:35 OpenWrt daemon.info hostapd: wlan0: STA 9c:2a:70:1e:5e:1d IEEE 802.11: authenticated<br />Nov 20 13:55:35 OpenWrt daemon.info hostapd: wlan0: STA 9c:2a:70:1e:5e:1d IEEE 802.11: associated (aid 1)<br />Nov 20 13:55:35 OpenWrt daemon.info hostapd: wlan0: STA 9c:2a:70:1e:5e:1d WPA: pairwise key handshake completed (RSN)<br />Nov 20 13:55:35 OpenWrt daemon.info dnsmasq-dhcp[1464]: DHCPREQUEST(br-lan) 192.168.1.249 9c:2a:70:1e:5e:1d <br />Nov 20 13:55:35 OpenWrt daemon.info dnsmasq-dhcp[1464]: DHCPACK(br-lan) 192.168.1.249 9c:2a:70:1e:5e:1d PHONGVAN0304FTE<br />Nov 20 13:55:38 OpenWrt daemon.info dnsmasq-dhcp[1464]: DHCPINFORM(br-lan) 192.168.1.249 9c:2a:70:1e:5e:1d <br />Nov 20 13:55:38 OpenWrt daemon.info dnsmasq-dhcp[1464]: DHCPACK(br-lan) 192.168.1.249 9c:2a:70:1e:5e:1d PHONGVAN0304FTE<br />Nov 20 13:55:50 OpenWrt user.notice root: WifiMgr: Checking network...</p>											<p class="post-edited">(Last edited by <strong>phantnang</strong> on 20 Nov 2015, 17:58)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300622">
				<div class="post-metadata">
					<div class="post-num">Post #86</div>
					<div class="post-author">dabyd64</div>
					<div class="post-datetime">
						21 Nov 2015, 00:54					</div>
				</div>
				<div class="post-content content">
					<p>Edit: I saw the problem now.<br />I have to make different methods,&nbsp; when the ssid goes down, and when it&#039;s ok and we just&nbsp; want to check if the preferred network is available.<br />If the ssid goes down, also does the client interface, it breaks and no longer scans networks, so I have to disable the client mode in that case.<br />I think now it will work, redownload and try <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>											<p class="post-edited">(Last edited by <strong>dabyd64</strong> on 21 Nov 2015, 14:57)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300803">
				<div class="post-metadata">
					<div class="post-num">Post #87</div>
					<div class="post-author">phantnang</div>
					<div class="post-datetime">
						22 Nov 2015, 19:39					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dabyd64 wrote:</cite><blockquote><p>Edit: I saw the problem now.<br />I have to make different methods,&nbsp; when the ssid goes down, and when it&#039;s ok and we just&nbsp; want to check if the preferred network is available.<br />If the ssid goes down, also does the client interface, it breaks and no longer scans networks, so I have to disable the client mode in that case.<br />I think now it will work, redownload and try <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></blockquote></div><p>great! it seems to have worked perfectly! could you try another method for multi preferred SSID?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300812">
				<div class="post-metadata">
					<div class="post-num">Post #88</div>
					<div class="post-author">dabyd64</div>
					<div class="post-datetime">
						22 Nov 2015, 20:17					</div>
				</div>
				<div class="post-content content">
					<p>Just put your preferred ssids as ssid1,ssid2...<br />It will check always if you are on ssid1, if not, it will check if ssid1 is available and try to connect.<br />If ssid1 doesn&#039;t work, it will try the next preferred network, ssid2,ssid3, and so on.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300868">
				<div class="post-metadata">
					<div class="post-num">Post #89</div>
					<div class="post-author">phantnang</div>
					<div class="post-datetime">
						23 Nov 2015, 07:09					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dabyd64 wrote:</cite><blockquote><p>Just put your preferred ssids as ssid1,ssid2...<br />It will check always if you are on ssid1, if not, it will check if ssid1 is available and try to connect.<br />If ssid1 doesn&#039;t work, it will try the next preferred network, ssid2,ssid3, and so on.</p></blockquote></div><p>can you write for me? and fixing not connect to hidden SSID!</p>											<p class="post-edited">(Last edited by <strong>phantnang</strong> on 23 Nov 2015, 07:12)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p300918">
				<div class="post-metadata">
					<div class="post-num">Post #90</div>
					<div class="post-author">dabyd64</div>
					<div class="post-datetime">
						23 Nov 2015, 16:36					</div>
				</div>
				<div class="post-content content">
					<p>I don&#039;t know how to that, sorry...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p306721">
				<div class="post-metadata">
					<div class="post-num">Post #91</div>
					<div class="post-author">cabsandy</div>
					<div class="post-datetime">
						8 Jan 2016, 16:26					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dabyd64 wrote:</cite><blockquote><div class="quotebox"><cite>cabsandy wrote:</cite><blockquote><div class="quotebox"><cite>dabyd64 wrote:</cite><blockquote><p>No problem chaging that. I thought it would be the same as my wdr4900.<br />About the cronjob, it&#039;s easier that the current method, easy fix.<br />About the dual/single band compatibility, not that easy.<br />First, usually Broadcom and Ralink chipset give too many headaches, so this will be Atheros only...<br />Second, WiFi devices can have different names, ex.: wlan0 ath0 wlan1..I have to investigate how to detect this.<br />Let me check it out,<br />Cheers</p></blockquote></div><p>Thanks for that-I think the 3600 is Ralink-I think! Dont give yourself too much hassle, can always go back to a standalone unit! :-)</p></blockquote></div><br /><p>Nope, it has Atheros AR9344! <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /><br /><a href="http://wiki.openwrt.org/toh/tp-link/tl-wdr3600">http://wiki.openwrt.org/toh/tp-link/tl-wdr3600</a></p><p>Ok, I&#039;ve done it different.<br />Just &quot;config&quot; and &quot;ApScan.sh&quot;. Edit the config file and run ApScan.sh everytime you want to perform a scan, from cronjob or any other method you want to use.</p><p>I gave up on trying to detect the device, it probably would cause problems and give a lot of work.<br />So, different scripts for 2.4G only and dual band.<br />For 2.4G only devices, wlan0 is used.<br />For dual band WDR3600, wlan0 for 2.4G and wlan1 for 5G.<br />For dual band WDR4900, wlan1 for 2.4G and wlan0 for 5G.</p><p><a href="https://dl.dropboxusercontent.com/u/23958662/ApScan_v1.0b.zip"><strong>ApScan 1.0b</strong></a></p><p>Regards <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p></blockquote></div><p>Hi there- Happy New Year!</p><p>Been away for a while but finally found a spare unit to test this on-using the Apscan.sh from the WDR3600 folder, the script runs through the 2.4G scan and finds, and pings, the 2 networks in the config file. But it cannot find the 5G networks I have-I know the AP can see them, as when you do a manual scan from the Luci web interface, it see&#039;s the 5G SSID no problem.<br />Is there any logs or info I can supply that would help in troubleshooting this?</p><p>##Update 17-01-2015-looks like the 5G IS working now, in a different physical location! Not sure why, maybe my bad :-). Great little script.##</p><p>cheers</p><p>cabs</p>											<p class="post-edited">(Last edited by <strong>cabsandy</strong> on 17 Jan 2016, 13:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p306954">
				<div class="post-metadata">
					<div class="post-num">Post #92</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						10 Jan 2016, 03:49					</div>
				</div>
				<div class="post-content content">
					<p>Hi, I dropped the ball and did not select the subscribe checkbox so I missed your reply.<br /><a href="https://forum.openwrt.org/viewtopic.php?pid=295179#p295179">https://forum.openwrt.org/viewtopic.php â€¦ 79#p295179</a></p><p>I do really need the ability to wirelessly access the device if there is no STA\Client available.&nbsp; It carries a USB data device for sharing and the router would not be usable with this tool of there is no WAN, and as a result LAN.&nbsp; </p><p>I currently have the device setup with a button action to delete the STA config section completely when the STA goes away.&nbsp; I use the script from here in the button event, as opposed to the original intent of a startup script.&nbsp; <a href="https://forum.openwrt.org/viewtopic.php?pid=278230#p278230">https://forum.openwrt.org/viewtopic.php â€¦ 30#p278230</a>&nbsp; </p><p>If the function runs and finds no STA what would it do?</p><p>If I connect to a station not in the list, I am of the opinion, as it just pings and gets a success, it will leave all alone.</p><p>Additionally, are there any restrictions on the SSIDs and keys for characters?&nbsp; Specifically can one use other than A-Z and 0-9 in the SSID.</p><p>How difficult would it be to write the happenings to a log file in tmp.&nbsp; This post then makes it real easy to show the content on a tab in Luci. <a href="https://forum.openwrt.org/viewtopic.php?id=58715">https://forum.openwrt.org/viewtopic.php?id=58715</a></p><p>Is this tested on CC 15.05?</p>											<p class="post-edited">(Last edited by <strong>RangerZ</strong> on 10 Jan 2016, 03:50)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p306961">
				<div class="post-metadata">
					<div class="post-num">Post #93</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						10 Jan 2016, 05:55					</div>
				</div>
				<div class="post-content content">
					<p>I took the plunge and installed the tool, but having some issues.</p><p>In my case, the wireless file has the AP section before the STA section, and the tool is updating the AP section instead of the STA.&nbsp; </p><p>It also seems to have modified my firewall and network sections, removing the WAN from the network.&nbsp; I do not see a difference in the firewall, but the date and time are changed.</p><p>The big problem is I can not stop the program.</p><p>I tried /etc/init.d/wifiMgr stop and I get a response of &quot;no wifiMgr.sh found; none killed&quot;.<br />The controls in Luci also do not terminate the program.<br />I renamed the files to *off and seems to be back in control.</p><p>If I switch around the two wifi-iface sections, the tool appears to update the first wifi-iface, now for the STA.&nbsp; I think because my other tool removes the STA, when a new wifi-iface is created it&#039;s added after.&nbsp; I am guessing that you are not checking if you are updating the AP or the STA, and updating the first section in the file.</p><p>I am running CC15.05 on a GLI Ar-150.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p308219">
				<div class="post-metadata">
					<div class="post-num">Post #94</div>
					<div class="post-author">dabyd64</div>
					<div class="post-datetime">
						19 Jan 2016, 17:39					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>RangerZ wrote:</cite><blockquote><p>Hi, I dropped the ball and did not select the subscribe checkbox so I missed your reply.<br /><a href="https://forum.openwrt.org/viewtopic.php?pid=295179#p295179">https://forum.openwrt.org/viewtopic.php â€¦ 79#p295179</a></p><p>I do really need the ability to wirelessly access the device if there is no STA\Client available.&nbsp; It carries a USB data device for sharing and the router would not be usable with this tool of there is no WAN, and as a result LAN.&nbsp; </p><p>I currently have the device setup with a button action to delete the STA config section completely when the STA goes away.&nbsp; I use the script from here in the button event, as opposed to the original intent of a startup script.&nbsp; <a href="https://forum.openwrt.org/viewtopic.php?pid=278230#p278230">https://forum.openwrt.org/viewtopic.php â€¦ 30#p278230</a>&nbsp; </p><p>If the function runs and finds no STA what would it do?</p><p>If I connect to a station not in the list, I am of the opinion, as it just pings and gets a success, it will leave all alone.</p><p>Additionally, are there any restrictions on the SSIDs and keys for characters?&nbsp; Specifically can one use other than A-Z and 0-9 in the SSID.</p><p>How difficult would it be to write the happenings to a log file in tmp.&nbsp; This post then makes it real easy to show the content on a tab in Luci. <a href="https://forum.openwrt.org/viewtopic.php?id=58715">https://forum.openwrt.org/viewtopic.php?id=58715</a></p><p>Is this tested on CC 15.05?</p></blockquote></div><p>This scripts doesn&#039;t search &quot;stations&quot; or clients. Only Access points, tries to connect to them, and will loop endlessly if none are good.<br />It&#039;s very easy to write the script logs, just like:<br /></p><div class="codebox"><pre><code> logread | grep &quot;WifiMgr&quot; &gt;/tmp/wifiMgr.log</code></pre></div><p>That will paste all the wifiMgr related output in that file. Yes, it&#039;s tested on 15.05.<br />I have tested only on Atheros hardware, I won&#039;t try on other devices that I don&#039;t have.</p><br /><br /><br /><br /><br /><br /><br /><div class="quotebox"><cite>RangerZ wrote:</cite><blockquote><p>I took the plunge and installed the tool, but having some issues.</p><p>In my case, the wireless file has the AP section before the STA section, and the tool is updating the AP section instead of the STA.&nbsp; </p><p>It also seems to have modified my firewall and network sections, removing the WAN from the network.&nbsp; I do not see a difference in the firewall, but the date and time are changed.</p><p>The big problem is I can not stop the program.</p><p>I tried /etc/init.d/wifiMgr stop and I get a response of &quot;no wifiMgr.sh found; none killed&quot;.<br />The controls in Luci also do not terminate the program.<br />I renamed the files to *off and seems to be back in control.</p><p>If I switch around the two wifi-iface sections, the tool appears to update the first wifi-iface, now for the STA.&nbsp; I think because my other tool removes the STA, when a new wifi-iface is created it&#039;s added after.&nbsp; I am guessing that you are not checking if you are updating the AP or the STA, and updating the first section in the file.</p><p>I am running CC15.05 on a GLI Ar-150.</p></blockquote></div><p>If you are mixing different scripts, check them all. If I understand correctly, you have two wlan interfaces on a single radio device, in ap+sta (repeater) mode?<br />If so, make sure that the file /etc/config/wireless has the STA first, before the AP interface.<br />It just touches &quot;wireless.@wifi-iface[0]&quot;.<br />To check it, just type &quot;uci show wireless&quot; and paste the results, I guess that wifi-iface[0] is AP and wifi-iface[1] is STa in your case.<br />If so, just put them in reverse order in the config file.<br />The script doesn&#039;t have any action when it doesn&#039;t find the APs, it just searches until one works, that what it was created for.</p>											<p class="post-edited">(Last edited by <strong>dabyd64</strong> on 19 Jan 2016, 17:42)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p308353">
				<div class="post-metadata">
					<div class="post-num">Post #95</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						20 Jan 2016, 15:59					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for the followup.&nbsp; I have learned a bit since my post.&nbsp; There is one each WWAN and WLAN.&nbsp; I currently have the code removed, and will try to test again in a few days.</p><p>I am using a GLI AR150 with a button on it and currently have a button action to remove the STAtion (WWAN) on demand.&nbsp; This moves the WLAN to wifi-iface[0].&nbsp; I (think) I need this as I have found that I can not connect wirelessly to the WLAN if the WWAN (STA\client) is unavailable.&nbsp; I do not write code and not sure if changing the disabled from 0 to1 would do the same.</p><p>Regarding the tool set, I am of the opinion that if no WWAN (STA/client) is found in the list, that the existing config is left as is, and the WLAN will be unavailable, but have not been able to test this.&nbsp; I still want to use the device to share media even when there is no WWAN.&nbsp; This means that I need a cable to connect to the LAN side, and that does not work for phones or tablets (in a car for example).&nbsp; The button action addresses this.</p><p>Understanding this should I be able to change the wifi-iface[0] to wifi-iface[1] to remove the second entry?&nbsp; I expect so.</p><p>Also, if setting the disabled flag from 0 to 1 address the WLAN availability issue, then is it reasonable to have this as a step after the last entry in the list is found to be unavailable.&nbsp; It would also mean the disabled flag would need to be set to 0 when you replace the SSID, key and encryption?&nbsp; Will this still allow you to scan?</p><p>If this concept works, then I could replace the button function, but if I can keep it that&#039;s better.&nbsp; The inability to access the device is critical when there is not WWAN, and the backup is reassuring.&nbsp; What happens if there is no wifi-iface[1]?</p>											<p class="post-edited">(Last edited by <strong>RangerZ</strong> on 20 Jan 2016, 16:06)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p309131">
				<div class="post-metadata">
					<div class="post-num">Post #96</div>
					<div class="post-author">Max Hopper</div>
					<div class="post-datetime">
						27 Jan 2016, 00:05					</div>
				</div>
				<div class="post-content content">
					<p>Considering the script of <a href="https://forum.openwrt.org/profile.php?id=71471">dabyd64</a> with it&#039;s looping method which handles recovery from association failures, finding a definitive source for network topology changes became the goal. That was found in the ubus service.</p><p>Scripting to detect and recover from <strong>all</strong> failures, e.g., incorrect password or SSID, loss of association with a remote AP, etcetera, was written once the basics of ubus and the JSON scripting library, <em>jshn.sh</em>, were understood.</p><p>Herewith the steps and code:</p><p>Create a fallback &#039;AP-only&#039; configuration -<br /></p><div class="codebox"><pre><code>cp /etc/config/wireless /etc/config/wireless_AP</code></pre></div><p>Edit <em>/etc/config/wireless_AP</em>, delete the wifi-interface section containing the STA definition, and save.<br />Edit <em>/etc/config/wireless</em> adding a new section and save -<br /></p><div class="codebox"><pre><code>    config wifi-repeater &#039;STA_name&#039;
    option interface wwan # this is also the value of &#039;option network XXXX&#039; in the STA section
    option wait 15</code></pre></div><p>Create a directory for <strong>the script</strong> -<br /></p><div class="codebox"><pre><code>mkdir /usr/local/bin</code></pre></div><p>Place <strong>the script</strong> in <em>/usr/local/bin/revert_to_AP.sh</em> -<br /></p><div class="codebox"><pre><code>#!/bin/sh
# Restore wireless access to the local AP for STA (Client) failures (association or login) with a remote AP (revert to &#039;AP-only&#039;) configuration.
. /usr/share/libubox/jshn.sh
local _rc _sta_err
let _sta_err++
json_init
json_load $(ubus -S call network.interface.&quot;$2&quot; status)
json_get_var _rc up
while  [ $_rc = 0 ] || [ $ACTION = ifdown -a $_rc = 0 ]
    do
        if [ $((_sta_err * 3)) -ge $1 ]; then
            cp /etc/config/wireless /etc/config/wireless_AP+STA
            cp /etc/config/wireless_AP /etc/config/wireless
            wifi down
            wifi up
            sleep 3
            mv -f /etc/config/wireless_AP+STA /etc/config/wireless
            break
        fi
        sleep 3
        json_load $(ubus -S call network.interface.&quot;$2&quot; status)
        json_get_var _rc up
        let ++_sta_err
    done
json_cleanup</code></pre></div><p>N.B. <strong>the script</strong> will unconditionally restore the AP + STA configuration because it detects and recovers from <strong>all</strong> failures.</p><p>Place this filter script in <em>/etc/hotplug.d/net/99-recover-STA</em> -<br /></p><div class="codebox"><pre><code>#!/bin/sh
logger -t DEBUG -s &quot;hotplug (net): action=&#039;$ACTION&#039; devicename=&#039;$DEVICENAME&#039; devname=&#039;$DEVNAME&#039; devpath=&#039;$DEVPATH&#039; product=&#039;$PRODUCT&#039; type=&#039;$TYPE&#039; interface=&#039;$INTERFACE&#039;&quot;

. /usr/share/libubox/jshn.sh
local _wwan _wait _device _up
_wwan=$(uci -q get wireless.STA_name.interface)
[ -z &quot;$_wwan&quot; ] &amp;&amp; _wwan=wwan # &lt;-- a popular name for &#039;repeater STAs&#039;
_wait=$(uci -q get wireless.STA_name.wait)
[ -z &quot;$_wait&quot; ] &amp;&amp; _wait=15
json_init
# the interface is known but not the device
json_load $(ubus -S call network.interface.&quot;$_wwan&quot; status)
# the update to the ubus object might be delayed...
json_get_var _up up
[ &quot;$_up&quot; = 0 ] &amp;&amp; sleep $_wait &amp;&amp; json_load $(ubus -S call network.interface.&quot;$_wwan&quot; status)
# extract the device that is hosting the STA interface
json_get_var _device device
json_cleanup
if [ $_device -a &quot;$ACTION&quot; = add -a &quot;$INTERFACE&quot; = &quot;$_device&quot; ]; then
    /bin/sh /usr/local/bin/revert_to_AP.sh $_wait $_wwan
fi</code></pre></div><p>Place this filter script in <em>/etc/hotplug.d/iface/99-recover-STA</em> -<br /></p><div class="codebox"><pre><code>#!/bin/sh
logger -t DEBUG &quot;hotplug (iface): action=&#039;$ACTION&#039; devicename=&#039;$DEVICENAME&#039; devname=&#039;$DEVNAME&#039; devpath=&#039;$DEVPATH&#039; product=&#039;$PRODUCT&#039; type=&#039;$TYPE&#039; interface=&#039;$INTERFACE&#039;&quot;

local _wwan _wait
_wwan=$(uci -q get wireless.STA_name.interface)
[ -z &quot;$_wwan&quot; ] &amp;&amp; _wwan=wwan # &lt;-- a popular name for &#039;repeater STAs&#039;
_wait=$(uci -q get wireless.STA_name.wait)
[ -z &quot;$_wait&quot; ] &amp;&amp; _wait=15
if [ &quot;$ACTION&quot; = ifdown -a &quot;$INTERFACE&quot; = &quot;$_wwan&quot; ]; then
    /bin/sh /usr/local/bin/revert_to_AP.sh $_wait $_wwan
fi</code></pre></div><p>N.B. the <em>logger</em> commands in the filter scripts can safely be removed but are useful with</p><div class="codebox"><pre><code>logread -e DEBUG</code></pre></div><p>EDIT: replaced calls to <em>network_is_up</em> (<a href="https://dev.openwrt.org/ticket/21722">returns 0 when the target is unavailable</a>) with json calls<br />EDIT: placed comments in <em>99-recover-STA</em><br />EDIT: jow explained the operation of <em>network_is_up</em> and <em>network_flush_cache</em> <a href="https://dev.openwrt.org/ticket/21722">here</a> and closed the ticket &#039;<em>worksforme</em>&#039;</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p309308">
				<div class="post-metadata">
					<div class="post-num">Post #97</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						28 Jan 2016, 02:56					</div>
				</div>
				<div class="post-content content">
					<p>Max, thanks for your reply.&nbsp; I have to admit the code is beyond my skill set, so I would like to make sure I understand a few things that may be obvious to others.&nbsp; I do most of my work with WinSCP to edit and create files/folders/permissions.&nbsp; Let me know if this causes and issues.&nbsp; </p><p>You are asking me to add a 4th section to the wireless file as follows</p><div class="codebox"><pre><code>config wifi-device &#039;radio0&#039;
....

config wifi-iface
    option network &#039;lan&#039;
    ....

config wifi-iface &#039;sta&#039;
    option network &#039;wan&#039;
    ....

config wifi-repeater&#039; &#039;STA_[mynamehere]&#039;   (should match the &#039;sta&#039; above?)
    option interface wwan
    option wait 15</code></pre></div><p>I have the &quot;STA&quot; as wan, not wwan.&nbsp; Can I replace the wwan with wan?&nbsp; If I recall correctly, when I manually, in LuCi, connect to a new STAtion, the defaults would have me ending up with both a wan and wwan and one had no config.&nbsp; Don&#039;t remember and can not test right now, but want to avoid this when I manually config a new station NOT in the list of stations file.</p><p>Create a new directory structure under /usr called /loacl/bin and add the file revert_to_AP.sh<br />What permissions do I want on the folders and files? 0755?</p><p>Similar with 99-recover-STA to the respective hotplug.d sub-directories.&nbsp; No *.sh on the files.&nbsp; Same question on permissions please?</p><p>Do I run logread -e DEBUG from putty CLI? </p><p>Do I need to install something for the usbus service?</p><p>I assume that when dabyd64&#039;s code does not find a station that this will backup the wireless file to wireless_AP+STA and replace it with the contents of wireless_AP, and I will not need to use the code snippet from post 92, and indeed should not use this.</p><p>I am not clear if I can, under the design, add a station manually.&nbsp; Under dabyd64&#039;s code I &lt;b&gt;assumed&lt;/b&gt; that I could, and that as there was a valid ping to google nothing else would happen.&nbsp; I am not clear at what point your additional functions kick in.&nbsp; Can you please explain how these functions work in relation to the other code? </p><p>I have a new device on the way and will test on that.&nbsp; I have a working VPN client and don&#039;t want to mess that up (again).&nbsp; It will be a few days at least until I can tackle this.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p309346">
				<div class="post-metadata">
					<div class="post-num">Post #98</div>
					<div class="post-author">Max Hopper</div>
					<div class="post-datetime">
						28 Jan 2016, 08:32					</div>
				</div>
				<div class="post-content content">
					<p>Do not overthink this. And do bear in mind I ask nothing of anyone regarding this freely distributed work.</p><p><strong>the script</strong> is executed via the hotplug framework when network topology changes occur, with the filter scripts specifically targeting events concerning the STA(tion) interface (named in the option - &#039;interface&#039; of the additional section - &#039;wifi-repeater&#039;).</p><div class="codebox"><pre><code>    config wifi-repeater &#039;STA_name&#039; # a &#039;named&#039; section (referenced in the filter scripts)
    option interface wwan # matches value of STA configuration &#039;network&#039; option
    option wait 15</code></pre></div><p>BTW, my preference is to use accurate names, e.g., &#039;wwan&#039; to describe a <em>&#039;<strong>w</strong>ireless <strong>w</strong>ide <strong>a</strong>rea <strong>n</strong>etwork&#039;</em> rather than, e.g., &#039;wan&#039;, which is customarily cabled.</p><p>The additional UCI section is accurately named &#039;STA_name&#039;. Using a UCI &#039;type&#039; avoids the complication of having to iterate over each section - &#039;wifi-iface&#039;, which are generally &#039;anonymous&#039;, to discover the option - &#039;network&#039; of the STA(tion) interface. </p><p>Setting permissions is unnecessary when a script is invoked with the <strong>sh</strong>(ell) command.</p><p>&#039;logread&#039; is a command issued in the CLI (terminal session). It is optional to employ it.</p><p><a href="https://wiki.openwrt.org/doc/techref/ubus">ubus</a></p><div class="quotebox"><cite>RangerZ wrote:</cite><blockquote><p>I assume that when dabyd64&#039;s code does not find a station that this will backup the wireless file to wireless_AP+STA and replace it with the contents of wireless_AP, and I will not need to use the code snippet from post 92, and indeed should not use this.<br />I am not clear if I can, under the design, add a station manually.&nbsp; Under dabyd64&#039;s code I &lt;b&gt;assumed&lt;/b&gt; that I could, and that as there was a valid ping to google nothing else would happen.&nbsp; I am not clear at what point your additional functions kick in.&nbsp; Can you please explain how these functions work in relation to the other code?</p></blockquote></div><p><strong>the script</strong> replaces that of <a href="https://forum.openwrt.org/profile.php?id=71471">dabyd64</a>.</p><p>Regarding -</p><div class="quotebox"><cite>RangerZ wrote:</cite><blockquote><p>...add a station manually.</p></blockquote></div><p>Does this entail logging into the &#039;AP-only&#039; device and manipulating its configuration? And as a consequence the <em>dabyd64 looping solution</em>, continuously accessing a configuration registry (<em>/etc/config/wireless</em>?), attempts to establish a STA(tion) association with the added (updated?) section - &#039;wifi-iface&#039;?</p><p>N.B. here, one might correctly guess I have no experience with the <em>dabyd64 looping solution</em>.</p><p>The WLAN configuration in which <strong>the script</strong> was developed comprises 3X (remote) APs with identical SSIDs. Thus, following the loss of association with a remote AP and calling <strong>all</strong> the filter scripts found in <em>/etc/hotplug.d/iface</em> and <em>/etc/hotplug.d/net</em> via the hotplug framework, <em>netifd</em> attempts to re-establish the link. Finding one of the alike named APs, the STA(tion) interface is restored without intervention on the part of <strong>the script</strong> owing to the configurable option - &#039;wait&#039;. Should <em>netifd</em> fail to restore the STA(tion) interface within the option - &#039;wait&#039; period, <strong>the script</strong> restores wireless access to the AP(-only) and prepares the device for AP+STA operation at the next device initialisation.</p><p>Is it possible that <em>netifd</em> will attempt to associate with secondary configured STA(tion) section(s) - &#039;wifi-iface&#039; with unique option - &#039;ssid&#039;&nbsp; values?</p><div class="codebox"><pre><code>    config    wifi-iface
    option    network wwan
    option    mode sta
    option    ssid &#039;remote AP0&#039;
    ...

    config    wifi-iface
    option    network wwan
    option    mode sta
    option    ssid &#039;remote AP1&#039;
    ...

    config    wifi-iface
    option    network wwan
    option    mode sta
    option    ssid &#039;remote AP2&#039;
    ...</code></pre></div><p>This scenario is untested and probably not valid without issuing an intervening <em>ifup</em> command which directs <em>netifd</em> to reload configuration information amongst which is <em>/etc/config/wireless</em>. Your test results are awaited.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311281">
				<div class="post-metadata">
					<div class="post-num">Post #99</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						14 Feb 2016, 00:12					</div>
				</div>
				<div class="post-content content">
					<p>@Max Hopper</p><p>I have tried to implement your solution, however have not been able to make it work.&nbsp; </p><p>I configured the components and worked with a know functioning AP which I could easily power off.&nbsp; I ran this for a while and had the wireless file wifi-iface configured both with and without (I think the correct way) a name (STA_name).&nbsp; When I removed power from the configured AP, in neither case did the code create the wireless_AP+STA file or make any changes to the wireless file.&nbsp; I have included my configs and logreads.&nbsp; Maybe they will be of value or identify a configuration error on my side.</p><p>With the STA_name<br />wireless</p><div class="codebox"><pre><code>config wifi-device &#039;radio0&#039;
    option type &#039;mac80211&#039;
    option hwmode &#039;11g&#039;
    option path &#039;10180000.wmac&#039;
    option htmode &#039;HT20&#039;
    option txpower &#039;20&#039;
    option country &#039;US&#039;
    option channel &#039;7&#039;

config wifi-iface
    option device &#039;radio0&#039;
    option mode &#039;ap&#039;
    option ssid &#039;MLGW2&#039;
    option network &#039;lan&#039;
    option encryption &#039;psk2&#039;
    option key &#039;password&#039;
    option disabled &#039;0&#039;

config wifi-iface &#039;STA_name&#039;
    option network &#039;wwan&#039;
    option encryption &#039;psk2&#039;
    option device &#039;radio0&#039;
    option mode &#039;sta&#039;
    option ssid &#039;Galactica&#039;
    option key &#039;password&#039;
    option disabled &#039;0&#039;

config wifi-repeater &#039;STA_name&#039;
        option interface wwan # this is also the value of &#039;option network XXXX&#039; in the STA section
        option wait 15</code></pre></div><p>wireless_AP</p><div class="codebox"><pre><code>config wifi-device &#039;radio0&#039;
    option type &#039;mac80211&#039;
    option hwmode &#039;11g&#039;
    option path &#039;10180000.wmac&#039;
    option htmode &#039;HT20&#039;
    option txpower &#039;20&#039;
    option country &#039;US&#039;
    option channel &#039;7&#039;

config wifi-iface
    option device &#039;radio0&#039;
    option mode &#039;ap&#039;
    option ssid &#039;MLGW2&#039;
    option network &#039;lan&#039;
    option encryption &#039;psk2&#039;
    option key &#039;password&#039;
    option disabled &#039;0&#039;</code></pre></div><div class="codebox"><pre><code>/etc/hotplug.d/iface$ logread -e DEBUG
Thu Feb 11 20:56:25 2016 user.notice DEBUG: hotplug (net): action=&#039;add&#039; devicename=&#039;br-lan&#039; devname=&#039;&#039; devpath=&#039;/devices/virtual/net/br-lan&#039; product=&#039;&#039; type=&#039;&#039; interface=&#039;br-lan&#039; 
Thu Feb 11 20:56:25 2016 user.notice DEBUG: hotplug (net): action=&#039;add&#039; devicename=&#039;eth0.1&#039; devname=&#039;&#039; devpath=&#039;/devices/virtual/net/eth0.1&#039; product=&#039;&#039; type=&#039;&#039; interface=&#039;eth0.1&#039; 
Thu Feb 11 20:56:26 2016 user.notice DEBUG: hotplug (net): action=&#039;remove&#039; devicename=&#039;wlan0&#039; devname=&#039;&#039; devpath=&#039;/devices/10180000.wmac/net/wlan0&#039; product=&#039;&#039; type=&#039;&#039; interface=&#039;wlan0&#039; 
Thu Feb 11 20:56:27 2016 user.notice DEBUG: hotplug (net): action=&#039;add&#039; devicename=&#039;wlan0&#039; devname=&#039;&#039; devpath=&#039;/devices/10180000.wmac/net/wlan0&#039; product=&#039;&#039; type=&#039;&#039; interface=&#039;wlan0&#039; 
Thu Feb 11 20:56:29 2016 user.notice DEBUG: hotplug (iface): action=&#039;ifup&#039; devicename=&#039;&#039; devname=&#039;&#039; devpath=&#039;&#039; product=&#039;&#039; type=&#039;&#039; interface=&#039;lan&#039; 
Thu Feb 11 20:56:30 2016 user.notice DEBUG: hotplug (iface): action=&#039;ifup&#039; devicename=&#039;&#039; devname=&#039;&#039; devpath=&#039;&#039; product=&#039;&#039; type=&#039;&#039; interface=&#039;loopback&#039;</code></pre></div><p>Without the STA_name<br />wireless</p><div class="codebox"><pre><code>config wifi-device &#039;radio0&#039;
    option type &#039;mac80211&#039;
    option hwmode &#039;11g&#039;
    option path &#039;10180000.wmac&#039;
    option htmode &#039;HT20&#039;
    option txpower &#039;20&#039;
    option country &#039;US&#039;
    option channel &#039;7&#039;

config wifi-iface
    option device &#039;radio0&#039;
    option mode &#039;ap&#039;
    option ssid &#039;MLGW2&#039;
    option network &#039;lan&#039;
    option encryption &#039;psk2&#039;
    option key &#039;password&#039;
    option disabled &#039;0&#039;

config wifi-iface 
    option network &#039;wwan&#039;
    option encryption &#039;psk2&#039;
    option device &#039;radio0&#039;
    option mode &#039;sta&#039;
    option ssid &#039;Galactica&#039;
    option key &#039;password&#039;
    option disabled &#039;0&#039;

config wifi-repeater &#039;STA_name&#039;
        option interface wwan # this is also the value of &#039;option network XXXX&#039; in the STA section
        option wait 15</code></pre></div><div class="codebox"><pre><code>/etc/config$ logread -e DEBUG
Thu Feb 11 21:14:50 2016 user.notice DEBUG: hotplug (net): action=&#039;add&#039; devicename=&#039;br-lan&#039; devname=&#039;&#039; devpath=&#039;/devices/virtual/net/br-lan&#039; product=&#039;&#039; type=&#039;&#039; interface=&#039;br-lan&#039; 
Thu Feb 11 21:14:50 2016 user.notice DEBUG: hotplug (net): action=&#039;add&#039; devicename=&#039;eth0.1&#039; devname=&#039;&#039; devpath=&#039;/devices/virtual/net/eth0.1&#039; product=&#039;&#039; type=&#039;&#039; interface=&#039;eth0.1&#039; 
Thu Feb 11 21:14:50 2016 user.notice DEBUG: hotplug (net): action=&#039;remove&#039; devicename=&#039;wlan0&#039; devname=&#039;&#039; devpath=&#039;/devices/10180000.wmac/net/wlan0&#039; product=&#039;&#039; type=&#039;&#039; interface=&#039;wlan0&#039; 
Thu Feb 11 21:14:52 2016 user.notice DEBUG: hotplug (net): action=&#039;add&#039; devicename=&#039;wlan0&#039; devname=&#039;&#039; devpath=&#039;/devices/10180000.wmac/net/wlan0&#039; product=&#039;&#039; type=&#039;&#039; interface=&#039;wlan0&#039; 
Thu Feb 11 21:14:52 2016 user.notice DEBUG: hotplug (net): action=&#039;add&#039; devicename=&#039;wlan0-1&#039; devname=&#039;&#039; devpath=&#039;/devices/10180000.wmac/net/wlan0-1&#039; product=&#039;&#039; type=&#039;&#039; interface=&#039;wlan0-1&#039; 
Thu Feb 11 21:14:55 2016 user.notice DEBUG: hotplug (iface): action=&#039;ifup&#039; devicename=&#039;&#039; devname=&#039;&#039; devpath=&#039;&#039; product=&#039;&#039; type=&#039;&#039; interface=&#039;lan&#039; 
Thu Feb 11 21:14:55 2016 user.notice DEBUG: hotplug (iface): action=&#039;ifup&#039; devicename=&#039;&#039; devname=&#039;&#039; devpath=&#039;&#039; product=&#039;&#039; type=&#039;&#039; interface=&#039;loopback&#039; 
Thu Feb 11 21:16:08 2016 user.notice DEBUG: hotplug (iface): action=&#039;ifup&#039; devicename=&#039;&#039; devname=&#039;&#039; devpath=&#039;&#039; product=&#039;&#039; type=&#039;&#039; interface=&#039;wwan&#039; </code></pre></div><p>after a few minutes i reran the log read<br /></p><div class="codebox"><pre><code>/etc/config$ /etc/config$ logread -e DEBUG
-ash: /etc/config$: not found</code></pre></div><p>after rebooting the AP the logread returned no results or errors.<br /></p><div class="codebox"><pre><code>/etc/config$ /etc/config$ logread -e DEBUG</code></pre></div><p>I neglected to note exactly when, but at one point I looked at the Luci WiFi and found both wireless connections showing as disabled, but the config file said &quot;Status 0&quot;.&nbsp; Did not make any real sense to me.&nbsp; It&#039;s contradictory.</p><p>I am of the opinion that this solution does not meet the functional requirement I seek, and offered by the author of this post.&nbsp; It recovers a single AP, and I am not capable of enhancing it to validate the additional APs as you suggest.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311290">
				<div class="post-metadata">
					<div class="post-num">Post #100</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						14 Feb 2016, 01:07					</div>
				</div>
				<div class="post-content content">
					<p>@dabyd64</p><p>I have made a few modifications to your code and happy to say that I can now recover from a lost AP.&nbsp; I have added a line to set the wifi-iface status to 1 and back to 0 when enabled.</p><p>To help survive after adding a manual AP (via Luci Wifi Scan) I have also added a line to remove the BSSID.</p><p>There is now a variable which let the user set his own choice of location to ping against. </p><p>Finally I have added a sleep variable just before the first scan.&nbsp; I was finding that the search was frequently starting before the wireless was&nbsp; available and then one would need to wait an additional minute to find an AP.&nbsp; This finds an AP faster.</p><p>I have written a modified LuCi status page and directed the logs to this page.&nbsp; It&#039;s a simple copy and replace to implement.</p><p>I have added the package luci-app-commands to my router.&nbsp; This package lets one create a set of user defined buttons to execute shell functions.&nbsp; I created a button for each of the major APs I use with the force command.&nbsp; No need to leave the GUI and start a shell.</p><p>I have two issues.&nbsp; <br />1 - Reboot - It appears that the reboot function in LuCi does not work when this code is in place.&nbsp; If I remove the file in the init.d folder and restart all works well.&nbsp; I have solved this with the luci-app-commands and created a button for &quot;reboot -f&quot;<br />2 - I have been doing much of my testing with a Ethernet cable to my devices LAN port so I could use the wireless to manage the various test APs.&nbsp; I have noticed that many times the device&#039;s Ethernet times out, and that I need to enable the devices WLAN.</p><p>The first is somehow related to the code as it appears removing the file fixes the boot issue.&nbsp; I am unclear if the Reboot -f is somehow driving the second issue or if it is otherwise device related.</p><p>I am not sure either is will be a real issue in practice, as it&#039;s a travel router and will mostly get turned on and off with the power button.</p><p>I have posted the modified code here.&nbsp; <a href="http://www.gl-inet.com/forums/topic/wifimgr-tool-to-automaticaly-select-an-apstation-from-a-list-of-saved-aps/#post-11953">http://www.gl-inet.com/forums/topic/wif â€¦ post-11953</a></p><p>The code functions and has the reboot issue on both an AR71xx and MT7620N .</p>											<p class="post-edited">(Last edited by <strong>RangerZ</strong> on 14 Feb 2016, 01:13)</p>
									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 4 of 5</div><nav><ul><li><a href="viewtopic.php%3Fid=43352&amp;p=1.html">1</a></li><li><a href="viewtopic.php%3Fid=43352&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=43352&amp;p=3.html">3</a></li><li class="pagination-current"><span>4</span></li><li><a href="viewtopic.php%3Fid=43352&amp;p=5.html">5</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0.001 -->

</body>
</html>