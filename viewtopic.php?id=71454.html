<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> no routes with NAT over wifi</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 31 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p361745">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">bebo</div>
					<div class="post-datetime">
						10 Jul 2017, 14:41					</div>
				</div>
				<div class="post-content content">
					<p>Hi all,<br />I installed Chaos Calmer 15.05 on my DLink DIR300.</p><p>I followed the instructions in the guide doc/recipes/routedclient#using_masquerade to create a NATed subnet behind the DLink: here is a base schema</p><p>&nbsp; WWW &lt;-----------&gt; MODEM+AP &lt;---------------------&gt; DLink DIR300 with OWRT &lt;--------&gt; devices<br />(internet)&nbsp; &nbsp; &nbsp;ADSL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;192.168.1.1&nbsp; &nbsp; &nbsp; &nbsp;192.168.1.9&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 10.10.10.1&nbsp; &nbsp; &nbsp;10.10.10.*</p><p>The steps performed have been (maybe can be useful for someone else in the future, since the guide seems a bit outdated):</p><div class="codebox"><pre><code>uci del wireless.@wifi-device[0].disabled
uci del wireless.@wifi-iface[0].network
uci set wireless.@wifi-iface[0].mode=sta
uci commit wireless
wifi</code></pre></div><p>iwlist scan doesn&#039;t work anymore<br /></p><div class="codebox"><pre><code>iw dev wlan0 scan</code></pre></div><p>or<br /></p><div class="codebox"><pre><code>killall -9 wpa_supplicant
iw dev wlan0 scan</code></pre></div><p>in case a message &#039;resource is busy&#039; appears.</p><p>I use the info retrieved to setup the connection to the modem+AP on the wan interface:</p><div class="codebox"><pre><code>config wifi-device &#039;wlan0&#039;
        option type       &#039;mac80211&#039;
        option channel    &#039;12&#039;
        option hwmode     &#039;11g&#039;
        option path       &#039;10180000.wmac&#039;
        option htmode     &#039;HT20&#039;

config wifi-iface
        option device     &#039;wlan0&#039;
        option network    &#039;wan&#039;
        option ssid       &#039;Telecom-85785057&#039;
        option encryption &#039;psk&#039;
        option mode       &#039;sta&#039;
        option key        &#039;***&#039;</code></pre></div><p>Then I setup my network interfaces with the following changes:<br /></p><div class="codebox"><pre><code>config interface &#039;lan&#039;
        option ifname &#039;eth0.1&#039;
        option force_link &#039;1&#039;
        option macaddr &#039;14:d6:4d:83:40:2c&#039;
        option type &#039;bridge&#039;
        option proto &#039;static&#039;
#        option ipaddr &#039;192.168.1.1&#039;
        option ipaddr &#039;10.10.10.1&#039;
        option gateway &#039;192.168.1.1&#039;
        option netmask &#039;255.255.255.0&#039;
        option ip6assign &#039;60&#039;

config interface &#039;wan&#039;
#        option ifname &#039;eth0.2&#039;
        option force_link &#039;1&#039;
        option macaddr &#039;14:d6:4d:83:40:2d&#039;
#        option proto &#039;dhcp&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;192.168.1.9&#039;
        option gateway &#039;192.168.1.1&#039;
        option netmask &#039;255.255.255.0&#039;</code></pre></div><p>pay attention to comment out the ifname option in the config interface of the wan interface!</p><p>Then I load the networks with:<br /></p><div class="codebox"><pre><code>/etc/init.d/network reload</code></pre></div><br /><p>Enable the wan interface::<br /></p><div class="codebox"><pre><code>ifup wan
wifi</code></pre></div><p>Afterwards, I set up some rules in the firewall with:<br /></p><div class="codebox"><pre><code># Create firewall rules and redirection in /etc/config/network

    config rule
            option name             Allow_SSH_from_WAN
            option src              wan
            option dest_ip          192.168.1.9/32
            option dest_port        22
            option proto            tcp
            option target           ACCEPT

    config redirect
            option name             Redir_LuCI
            option src              wan
            option src_sport        *
            option src_dport        8080
            option dest_ip          10.10.10.1
            option dest_port        80
            option proto            tcp

    config redirect
            option name             Redir_device1
            option src              wan
            option src_sport        *
            option src_dport        80
            option dest_ip          10.10.10.18
            option dest_port        80
            option proto            tcp</code></pre></div><br /><p>Load the new rules with::</p><div class="codebox"><pre><code>/etc/init.d/firewall reload</code></pre></div><br /><p>The firewall rules work like a charm: being inside the 192.168.1.0/24 network I&#039;m able to access the LuCi interface of the DLink OWRT at the address: 192.168.1.9:8080 as expected.</p><p>The problem is that, inside the NATed network I cannot access the outside nor internet. E.g. when I try to ping or connect to a webserver outside the NATed network I get a:<br /></p><div class="codebox"><pre><code># wget -q -O - 64.182.208.183:80
wget: can&#039;t connect to remote host (64.182.208.183): No route to host</code></pre></div><p>(the result is the same even if I try to connect to a web server in the 192.168.1.0/24 network with # wget -q -O - 192.168.1.12:8080 )</p><p>The routing table is:<br /></p><div class="codebox"><pre><code># route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    0      0        0 wlan0
10.10.10.0      0.0.0.0         255.255.255.0   U     0      0        0 br-lan
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 wlan0</code></pre></div><br /><p>What am I missing? how should I implement a proper NAT?</p>											<p class="post-edited">(Last edited by <strong>bebo</strong> on 10 Jul 2017, 14:44)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p362124">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">bebo</div>
					<div class="post-datetime">
						16 Jul 2017, 22:03					</div>
				</div>
				<div class="post-content content">
					<p>Hi all!<br />still facing this issue, and I don&#039;t understand what&#039;s wrong.</p><p>The routing table is the following:<br /></p><div class="codebox"><pre><code># route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    0      0        0 wlan0
10.10.10.0      0.0.0.0         255.255.255.0   U     0      0        0 br-lan
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 wlan0</code></pre></div><p>but the funny part is that I can access the LuCi interface on the router and use the ssh connection using the redirecting rules applied in the firewall and I can access a webserver hosted in the NATed network at 10.10.10.19:80, so a route should exist in order for the packets to come back from the services in the 10.10.10.0/24 net to the 192.168.1.0/24 clients that requested them, right?</p><p>I do not know what and how to investigate further: any hint is appreciated.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p362213">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">Mijzelf</div>
					<div class="post-datetime">
						18 Jul 2017, 16:41					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bebo wrote:</cite><blockquote><p> I can access a webserver hosted in the NATed network at 10.10.10.19:80.</p></blockquote></div><p>From the 192.168.1.0/24 network, you mean? In that case you are NATting in the wrong direction. At least if you want to be able to access the 192.168.1.0/24 network from the 10.10.10.0/24 network.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p362216">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">bebo</div>
					<div class="post-datetime">
						18 Jul 2017, 16:56					</div>
				</div>
				<div class="post-content content">
					<p>Hi Mijzelf,</p><p>I&#039;m able to access the webserver located in the NATed network at 10.10.10.18:80 from the 192.168.1.0/24 network thanks to the firewall rule I set up:<br /></p><div class="codebox"><pre><code>    config redirect
            option name             Redir_device1
            option src              wan
            option src_sport        *
            option src_dport        80
            option dest_ip          10.10.10.18
            option dest_port        80
            option proto            tcp</code></pre></div><p>and it works like a charm, as well as the other two rules inserted for redirection displayed in the first post.</p><p>I beginning to think that the &quot;no route to host&quot; error message doesn&#039;t represent the true cause of the problem, because the packets coming from the webserver can reach my device in the 192... network: could it be that the firewall is currently dropping all the other types of connections?<br />how can I implement a proper NAT mechanism that allows me to access the 192... network and the internet, from the NATed network?</p><p>The complete /etc/config/firewall configuration is the following, note that I&#039;ve only added the last three rules:</p><div class="codebox"><pre><code># cat /etc/config/firewall 
config defaults
    option syn_flood    1
    option input        ACCEPT
    option output        ACCEPT
    option forward        REJECT
# Uncomment this line to disable ipv6 rules
#    option disable_ipv6    1

config zone
    option name        lan
    list   network        &#039;lan&#039;
    option input        ACCEPT
    option output        ACCEPT
    option forward        ACCEPT

config zone
    option name        wan
    list   network        &#039;wan&#039;
    list   network        &#039;wan6&#039;
    option input        REJECT
    option output        ACCEPT
    option forward        REJECT
    option masq        1
    option mtu_fix        1

config forwarding
    option src        lan
    option dest        wan

#config forwarding
#        option src              wan
#        option dest             lan


# We need to accept udp packets on port 68,
# see dev. openwrt .org/ticket/4108
config rule
    option name        Allow-DHCP-Renew
    option src        wan
    option proto        udp
    option dest_port    68
    option target        ACCEPT
    option family        ipv4

# Allow IPv4 ping
config rule
    option name        Allow-Ping
    option src        wan
    option proto        icmp
    option icmp_type    echo-request
    option family        ipv4
    option target        ACCEPT

config rule
    option name        Allow-IGMP
    option src        wan
    option proto        igmp
    option family        ipv4
    option target        ACCEPT

# Allow DHCPv6 replies
# see dev. openwrt .org/ticket/10381
config rule
    option name        Allow-DHCPv6
    option src        wan
    option proto        udp
    option src_ip        fe80::/10
    option src_port        547
    option dest_ip        fe80::/10
    option dest_port    546
    option family        ipv6
    option target        ACCEPT

config rule
    option name        Allow-MLD
    option src        wan
    option proto        icmp
    option src_ip        fe80::/10
    list icmp_type        &#039;130/0&#039;
    list icmp_type        &#039;131/0&#039;
    list icmp_type        &#039;132/0&#039;
    list icmp_type        &#039;143/0&#039;
    option family        ipv6
    option target        ACCEPT

# Allow essential incoming IPv6 ICMP traffic
config rule
    option name        Allow-ICMPv6-Input
    option src        wan
    option proto    icmp
    list icmp_type        echo-request
    list icmp_type        echo-reply
    list icmp_type        destination-unreachable
    list icmp_type        packet-too-big
    list icmp_type        time-exceeded
    list icmp_type        bad-header
    list icmp_type        unknown-header-type
    list icmp_type        router-solicitation
    list icmp_type        neighbour-solicitation
    list icmp_type        router-advertisement
    list icmp_type        neighbour-advertisement
    option limit        1000/sec
    option family        ipv6
    option target        ACCEPT

# Allow essential forwarded IPv6 ICMP traffic
config rule
    option name        Allow-ICMPv6-Forward
    option src        wan
    option dest        *
    option proto        icmp
    list icmp_type        echo-request
    list icmp_type        echo-reply
    list icmp_type        destination-unreachable
    list icmp_type        packet-too-big
    list icmp_type        time-exceeded
    list icmp_type        bad-header
    list icmp_type        unknown-header-type
    option limit        1000/sec
    option family        ipv6
    option target        ACCEPT

# include a file with users custom iptables rules
config include
    option path /etc/firewall.user





# do not allow a specific ip to access wan
#config rule
#    option src        lan
#    option src_ip    192.168.45.2
#    option dest        wan
#    option proto    tcp
#    option target    REJECT

# block a specific mac on wan
#config rule
#    option dest        wan
#    option src_mac    00:11:22:33:44:66
#    option target    REJECT

# block incoming ICMP traffic on a zone
#config rule
#    option src        lan
#    option proto    ICMP
#    option target    DROP

# port redirect port coming in on wan to lan
#config redirect
#    option src            wan
#    option src_dport    80
#    option dest            lan
#    option dest_ip        192.168.16.235
#    option dest_port    80
#    option proto        tcp

# port redirect of remapped ssh port (22001) on wan
#config redirect
#    option src        wan
#    option src_dport    22001
#    option dest        lan
#    option dest_port    22
#    option proto        tcp

# allow IPsec/ESP and ISAKMP passthrough
config rule
    option src        wan
    option dest        lan
    option proto        esp
    option target        ACCEPT

config rule
    option src        wan
    option dest        lan
    option dest_port    500
    option proto        udp
    option target        ACCEPT

### FULL CONFIG SECTIONS
#config rule
#    option src        lan
#    option src_ip    192.168.45.2
#    option src_mac    00:11:22:33:44:55
#    option src_port    80
#    option dest        wan
#    option dest_ip    194.25.2.129
#    option dest_port    120
#    option proto    tcp
#    option target    REJECT

#config redirect
#    option src        lan
#    option src_ip    192.168.45.2
#    option src_mac    00:11:22:33:44:55
#    option src_port        1024
#    option src_dport    80
#    option dest_ip    194.25.2.129
#    option dest_port    120
#    option proto    tcp

#### manual additions

    config rule
            option name             Allow_SSH_from_WAN
            option src              wan
            option dest_ip          192.168.1.9/32
            option dest_port        22
            option proto            tcp
            option target           ACCEPT

    config redirect
            option name             Redir_LuCI
            option src              wan
            option src_sport        *
            option src_dport        8080
            option dest             lan
            option dest_ip          10.10.10.1
            option dest_port        80
            option proto            tcp

    config redirect
            option name             Redir_batteries
            option src              wan
            option src_sport        *
            option src_dport        80
            option dest             lan
            option dest_ip          10.10.10.18
            option dest_port        80
            option proto            tcp

    config redirect
            option name             Redir_inverter
            option src              wan
            option src_sport        *
            option src_dport        12345
            option dest             lan
            option dest_ip          10.10.10.19
            option dest_port        80
            option proto            tcp</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p362236">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">Mijzelf</div>
					<div class="post-datetime">
						18 Jul 2017, 21:41					</div>
				</div>
				<div class="post-content content">
					<p>I think the problem is here:</p><div class="codebox"><pre><code>config interface &#039;lan&#039;
        option ifname &#039;eth0.1&#039;
&lt;snip&gt;
        option ipaddr &#039;10.10.10.1&#039;
        option gateway &#039;192.168.1.1&#039;</code></pre></div><p>That gateway is wrong. Interface &#039;lan&#039; doesn&#039;t have a gateway.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p362330">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">bebo</div>
					<div class="post-datetime">
						20 Jul 2017, 14:11					</div>
				</div>
				<div class="post-content content">
					<p>You were right, and your suggestion partially solved the problem.</p><p>Now I&#039;m able to ping and contact the devices on the 192.168.1.0/24 network, but not other addresses on internet.<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# /etc/init.d//network reload
root@OpenWrt:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    0      0        0 wlan0
10.10.10.0      0.0.0.0         255.255.255.0   U     0      0        0 br-lan
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 wlan0
root@OpenWrt:~# ifup wan
root@OpenWrt:~# wifi
root@OpenWrt:~# ping 192.168.1.1
PING 192.168.1.1 (192.168.1.1): 56 data bytes
64 bytes from 192.168.1.1: seq=0 ttl=64 time=2.002 ms
64 bytes from 192.168.1.1: seq=1 ttl=64 time=1.516 ms
64 bytes from 192.168.1.1: seq=2 ttl=64 time=1.486 ms
64 bytes from 192.168.1.1: seq=3 ttl=64 time=1.449 ms
64 bytes from 192.168.1.1: seq=4 ttl=64 time=1.509 ms
^C
--- 192.168.1.1 ping statistics ---
5 packets transmitted, 5 packets received, 0% packet loss
round-trip min/avg/max = 1.449/1.592/2.002 ms

root@OpenWrt:~# ping 192.168.1.12
PING 192.168.1.12 (192.168.1.12): 56 data bytes
64 bytes from 192.168.1.12: seq=0 ttl=64 time=3.161 ms
64 bytes from 192.168.1.12: seq=1 ttl=64 time=2.681 ms
^C
--- 192.168.1.12 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 2.681/2.921/3.161 ms

root@OpenWrt:~# ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8): 56 data bytes
^C
--- 8.8.8.8 ping statistics ---
13 packets transmitted, 0 packets received, 100% packet loss</code></pre></div><p>Moreover, I can &quot;browse&quot; the modem+router webpage with<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# wget -O - 192.168.1.1:80
Connecting to 192.168.1.1:80 (192.168.1.1:80)
-                    100% |*************************************************************************************************************|  5392   0:00:00 ETA
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.1//EN&quot; &quot;...&quot;&gt;
&lt;html&gt;
&lt;head&gt;</code></pre></div><p>but it seems that it can&#039;t route packets to other addresses on the 192../24 subnet, e.g. I cannot contact a webserver I opened on my own pc, even though I&#039;m able to ping it!<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# wget -O - 192.168.1.12:8000
Connecting to 192.168.1.12:8000 (192.168.1.12:8000)
wget: can&#039;t connect to remote host (192.168.1.12): No route to host

root@OpenWrt:~# ping 192.168.1.12
PING 192.168.1.12 (192.168.1.12): 56 data bytes
64 bytes from 192.168.1.12: seq=0 ttl=64 time=4.115 ms
64 bytes from 192.168.1.12: seq=1 ttl=64 time=2.608 ms
...</code></pre></div><p>This is the output of the firewall reload:<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# /etc/init.d/firewall reload
Warning: Unable to locate ipset utility, disabling ipset support
Warning: Option @redirect[0].src_sport is unknown
Warning: Section @redirect[0] (Redir_LuCI) has no target specified, defaulting to DNAT
Warning: Section @redirect[0] (Redir_LuCI) refers to a destination address on this router, assuming port redirection
Warning: Option @redirect[1].src_sport is unknown
Warning: Section @redirect[1] (Redir_batteries) has no target specified, defaulting to DNAT
Warning: Option @redirect[2].src_sport is unknown
Warning: Section @redirect[2] (Redir_inverter) has no target specified, defaulting to DNAT
 * Clearing IPv4 filter table
 * Clearing IPv4 nat table
 * Clearing IPv4 mangle table
 * Clearing IPv4 raw table
 * Populating IPv4 filter table
   * Zone &#039;lan&#039;
   * Zone &#039;wan&#039;
   * Rule &#039;Allow-DHCP-Renew&#039;
   * Rule &#039;Allow-Ping&#039;
   * Rule &#039;Allow-IGMP&#039;
   * Rule &#039;Allow_SSH_from_WAN&#039;
   * Rule #8
   * Rule #9
   * Redirect &#039;Redir_LuCI&#039;
   * Redirect &#039;Redir_batteries&#039;
   * Redirect &#039;Redir_inverter&#039;
   * Forward &#039;lan&#039; -&gt; &#039;wan&#039;
 * Populating IPv4 nat table
   * Zone &#039;lan&#039;
   * Zone &#039;wan&#039;
   * Redirect &#039;Redir_LuCI&#039;
   * Redirect &#039;Redir_batteries&#039;
   * Redirect &#039;Redir_inverter&#039;
 * Populating IPv4 mangle table
   * Zone &#039;lan&#039;
   * Zone &#039;wan&#039;
 * Populating IPv4 raw table
   * Zone &#039;lan&#039;
   * Zone &#039;wan&#039;
 * Clearing IPv6 filter table
 * Clearing IPv6 mangle table
 * Clearing IPv6 raw table
 * Populating IPv6 filter table
   * Zone &#039;lan&#039;
   * Zone &#039;wan&#039;
   * Rule &#039;Allow-DHCPv6&#039;
   * Rule &#039;Allow-MLD&#039;
   * Rule &#039;Allow-ICMPv6-Input&#039;
   * Rule &#039;Allow-ICMPv6-Forward&#039;
   * Rule &#039;Allow_SSH_from_WAN&#039;
     ! Skipping due to different family of ip address
   * Rule #8
   * Rule #9
   * Forward &#039;lan&#039; -&gt; &#039;wan&#039;
 * Populating IPv6 mangle table
   * Zone &#039;lan&#039;
   * Zone &#039;wan&#039;
 * Populating IPv6 raw table
   * Zone &#039;lan&#039;
   * Zone &#039;wan&#039;
 * Set tcp_ecn to off
 * Set tcp_syncookies to on
 * Set tcp_window_scaling to on</code></pre></div><p>maybe you guys can find out some misplaced rule.</p>											<p class="post-edited">(Last edited by <strong>bebo</strong> on 20 Jul 2017, 14:12)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p363929">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">bebo</div>
					<div class="post-datetime">
						18 Aug 2017, 18:04					</div>
				</div>
				<div class="post-content content">
					<p>Any more hint?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p363930">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">Mijzelf</div>
					<div class="post-datetime">
						18 Aug 2017, 18:37					</div>
				</div>
				<div class="post-content content">
					<p>As you can ping the clients in the 192.168.1.0/24 subnet, I think there is no routing issue for that subnet in your DLink..<br />For 8.8.8.8 you can try a traceroute.</p><p>For TCP accessing 192.168.1.0/24, my first idea it that it&#039;s somehow blocked in your &#039;MODEM+AP&#039; (which of course also contains a router+firewall).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p366694">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">bebo</div>
					<div class="post-datetime">
						14 Oct 2017, 03:09					</div>
				</div>
				<div class="post-content content">
					<p>Hi Mijzelf, sorry for the late reply. I&#039;m going to set up a dynamic dns to be able to reach the internal network from the internet.</p><div class="codebox"><pre><code># traceroute -n 8.8.8.8
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 38 byte packets
 1  192.168.1.1  3.005 ms !C  1.422 ms !C  2.093 ms !C

# traceroute -n 192.168.1.43
traceroute to 192.168.1.43 (192.168.1.43), 30 hops max, 38 byte packets
 1  192.168.1.43  2.897 ms !C  2.907 ms !C  3.985 ms !C</code></pre></div><p>It seems that ICMP isn&#039;t filtered by the openwrt router: this makes me believe it&#039;s something related to a restrictive firewall that blocks TCP connections.</p><p>I&#039;ve spawned a simple http server on the laptop (IP 192.168.1.43/24) I&#039;m using to connect to the router (through ssh), which has IP 192.168.1.9/24 in the inner network, and 10.10.10.1 in the NAT-ted network, and I tried downloading using wget:<br /></p><div class="codebox"><pre><code># wget 192.168.1.43:8000
Connecting to 192.168.1.43:8000 (192.168.1.43:8000)
wget: can&#039;t connect to remote host (192.168.1.43): No route to host</code></pre></div><p>Here&#039;s also my iptables, maybe you or someone else is able to spot a problem that does not allow my NAT-ted router to talk with other networks:<br /></p><div class="codebox"><pre><code># iptables -L
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
delegate_input  all  --  anywhere             anywhere            

Chain FORWARD (policy DROP)
target     prot opt source               destination         
delegate_forward  all  --  anywhere             anywhere            

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
delegate_output  all  --  anywhere             anywhere            

Chain delegate_forward (1 references)
target     prot opt source               destination         
forwarding_rule  all  --  anywhere             anywhere             /* user chain for forwarding */
ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
zone_lan_forward  all  --  anywhere             anywhere            
zone_wan_forward  all  --  anywhere             anywhere            
zone_wan_forward  all  --  anywhere             anywhere            
reject     all  --  anywhere             anywhere            

Chain delegate_input (1 references)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            
input_rule  all  --  anywhere             anywhere             /* user chain for input */
ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
syn_flood  tcp  --  anywhere             anywhere             tcp flags:FIN,SYN,RST,ACK/SYN
zone_lan_input  all  --  anywhere             anywhere            
zone_wan_input  all  --  anywhere             anywhere            
zone_wan_input  all  --  anywhere             anywhere            

Chain delegate_output (1 references)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            
output_rule  all  --  anywhere             anywhere             /* user chain for output */
ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
zone_lan_output  all  --  anywhere             anywhere            
zone_wan_output  all  --  anywhere             anywhere            
zone_wan_output  all  --  anywhere             anywhere            

Chain forwarding_lan_rule (1 references)
target     prot opt source               destination         

Chain forwarding_rule (1 references)
target     prot opt source               destination         

Chain forwarding_wan_rule (1 references)
target     prot opt source               destination         

Chain input_lan_rule (1 references)
target     prot opt source               destination         

Chain input_rule (1 references)
target     prot opt source               destination         

Chain input_wan_rule (1 references)
target     prot opt source               destination         

Chain output_lan_rule (1 references)
target     prot opt source               destination         

Chain output_rule (1 references)
target     prot opt source               destination         

Chain output_wan_rule (1 references)
target     prot opt source               destination         

Chain reject (5 references)
target     prot opt source               destination         
REJECT     tcp  --  anywhere             anywhere             reject-with tcp-reset
REJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable

Chain syn_flood (1 references)
target     prot opt source               destination         
RETURN     tcp  --  anywhere             anywhere             tcp flags:FIN,SYN,RST,ACK/SYN limit: avg 25/sec burst 50
DROP       all  --  anywhere             anywhere            

Chain zone_lan_dest_ACCEPT (4 references)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            

Chain zone_lan_forward (1 references)
target     prot opt source               destination         
forwarding_lan_rule  all  --  anywhere             anywhere             /* user chain for forwarding */
zone_wan_dest_ACCEPT  all  --  anywhere             anywhere             /* forwarding lan -&gt; wan */
ACCEPT     all  --  anywhere             anywhere             ctstate DNAT /* Accept port forwards */
zone_lan_dest_ACCEPT  all  --  anywhere             anywhere            

Chain zone_lan_input (1 references)
target     prot opt source               destination         
input_lan_rule  all  --  anywhere             anywhere             /* user chain for input */
ACCEPT     all  --  anywhere             anywhere             ctstate DNAT /* Accept port redirections */
zone_lan_src_ACCEPT  all  --  anywhere             anywhere            

Chain zone_lan_output (1 references)
target     prot opt source               destination         
output_lan_rule  all  --  anywhere             anywhere             /* user chain for output */
zone_lan_dest_ACCEPT  all  --  anywhere             anywhere            

Chain zone_lan_src_ACCEPT (1 references)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            

Chain zone_wan_dest_ACCEPT (2 references)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            
ACCEPT     all  --  anywhere             anywhere            

Chain zone_wan_dest_REJECT (1 references)
target     prot opt source               destination         
reject     all  --  anywhere             anywhere            
reject     all  --  anywhere             anywhere            

Chain zone_wan_forward (2 references)
target     prot opt source               destination         
forwarding_wan_rule  all  --  anywhere             anywhere             /* user chain for forwarding */
zone_lan_dest_ACCEPT  esp  --  anywhere             anywhere             /* @rule[8] */
zone_lan_dest_ACCEPT  udp  --  anywhere             anywhere             udp dpt:isakmp /* @rule[9] */
ACCEPT     all  --  anywhere             anywhere             ctstate DNAT /* Accept port forwards */
zone_wan_dest_REJECT  all  --  anywhere             anywhere            

Chain zone_wan_input (2 references)
target     prot opt source               destination         
input_wan_rule  all  --  anywhere             anywhere             /* user chain for input */
ACCEPT     udp  --  anywhere             anywhere             udp dpt:bootpc /* Allow-DHCP-Renew */
ACCEPT     icmp --  anywhere             anywhere             icmp echo-request /* Allow-Ping */
ACCEPT     igmp --  anywhere             anywhere             /* Allow-IGMP */
ACCEPT     tcp  --  anywhere             192.168.1.9          tcp dpt:ssh /* Allow_SSH_from_WAN */
ACCEPT     all  --  anywhere             anywhere             ctstate DNAT /* Accept port redirections */
zone_wan_src_REJECT  all  --  anywhere             anywhere            

Chain zone_wan_output (2 references)
target     prot opt source               destination         
output_wan_rule  all  --  anywhere             anywhere             /* user chain for output */
zone_wan_dest_ACCEPT  all  --  anywhere             anywhere            

Chain zone_wan_src_REJECT (1 references)
target     prot opt source               destination         
reject     all  --  anywhere             anywhere            
reject     all  --  anywhere             anywhere</code></pre></div><div class="quotebox"><blockquote><p>For TCP accessing 192.168.1.0/24, my first idea it that it&#039;s somehow blocked in your &#039;MODEM+AP&#039; (which of course also contains a router+firewall).</p></blockquote></div><p>It shouldn&#039;t be related to the main Modem+Router my ISP gave me: i haven&#039;t touched anything, and i have minimal control over it.<br />Moreover, I tried disabling its firewall protection, which &quot;disables control over TCP/UDP ports ...&quot;, for a second, but still I wasn&#039;t able to ping internet (while I was still able to ping the 192.168.1.0/24 network) and I wasn&#039;t able to download anything neither from the inner 192.../24 network or from internet.</p><p>Many thanks for your help guys!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p366695">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">bebo</div>
					<div class="post-datetime">
						14 Oct 2017, 03:16					</div>
				</div>
				<div class="post-content content">
					<p>Actually I&#039;ve seen on LuCi in the Firewall page that the general setting for forward was reject, and the NAT setting for the input and forward were set on reject.<br />I switched them to reject, saved, and did a </p><div class="codebox"><pre><code># /etc/init.d/firewall reload</code></pre></div><p>Now my iptables is as following:<br /></p><div class="codebox"><pre><code># iptables -L
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
delegate_input  all  --  anywhere             anywhere            

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         
delegate_forward  all  --  anywhere             anywhere            

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
delegate_output  all  --  anywhere             anywhere            

Chain delegate_forward (1 references)
target     prot opt source               destination         
forwarding_rule  all  --  anywhere             anywhere             /* user chain for forwarding */
ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
zone_lan_forward  all  --  anywhere             anywhere            
zone_wan_forward  all  --  anywhere             anywhere            
zone_wan_forward  all  --  anywhere             anywhere            

Chain delegate_input (1 references)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            
input_rule  all  --  anywhere             anywhere             /* user chain for input */
ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
syn_flood  tcp  --  anywhere             anywhere             tcp flags:FIN,SYN,RST,ACK/SYN
zone_lan_input  all  --  anywhere             anywhere            
zone_wan_input  all  --  anywhere             anywhere            
zone_wan_input  all  --  anywhere             anywhere            

Chain delegate_output (1 references)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            
output_rule  all  --  anywhere             anywhere             /* user chain for output */
ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
zone_lan_output  all  --  anywhere             anywhere            
zone_wan_output  all  --  anywhere             anywhere            
zone_wan_output  all  --  anywhere             anywhere            

Chain forwarding_lan_rule (1 references)
target     prot opt source               destination         

Chain forwarding_rule (1 references)
target     prot opt source               destination         

Chain forwarding_wan_rule (1 references)
target     prot opt source               destination         

Chain input_lan_rule (1 references)
target     prot opt source               destination         

Chain input_rule (1 references)
target     prot opt source               destination         

Chain input_wan_rule (1 references)
target     prot opt source               destination         

Chain output_lan_rule (1 references)
target     prot opt source               destination         

Chain output_rule (1 references)
target     prot opt source               destination         

Chain output_wan_rule (1 references)
target     prot opt source               destination         

Chain reject (0 references)
target     prot opt source               destination         
REJECT     tcp  --  anywhere             anywhere             reject-with tcp-reset
REJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable

Chain syn_flood (1 references)
target     prot opt source               destination         
RETURN     tcp  --  anywhere             anywhere             tcp flags:FIN,SYN,RST,ACK/SYN limit: avg 25/sec burst 50
DROP       all  --  anywhere             anywhere            

Chain zone_lan_dest_ACCEPT (4 references)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            

Chain zone_lan_forward (1 references)
target     prot opt source               destination         
forwarding_lan_rule  all  --  anywhere             anywhere             /* user chain for forwarding */
zone_wan_dest_ACCEPT  all  --  anywhere             anywhere             /* forwarding lan -&gt; wan */
ACCEPT     all  --  anywhere             anywhere             ctstate DNAT /* Accept port forwards */
zone_lan_dest_ACCEPT  all  --  anywhere             anywhere            

Chain zone_lan_input (1 references)
target     prot opt source               destination         
input_lan_rule  all  --  anywhere             anywhere             /* user chain for input */
ACCEPT     all  --  anywhere             anywhere             ctstate DNAT /* Accept port redirections */
zone_lan_src_ACCEPT  all  --  anywhere             anywhere            

Chain zone_lan_output (1 references)
target     prot opt source               destination         
output_lan_rule  all  --  anywhere             anywhere             /* user chain for output */
zone_lan_dest_ACCEPT  all  --  anywhere             anywhere            

Chain zone_lan_src_ACCEPT (1 references)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            

Chain zone_wan_dest_ACCEPT (3 references)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            
ACCEPT     all  --  anywhere             anywhere            

Chain zone_wan_forward (2 references)
target     prot opt source               destination         
forwarding_wan_rule  all  --  anywhere             anywhere             /* user chain for forwarding */
zone_lan_dest_ACCEPT  esp  --  anywhere             anywhere             /* @rule[8] */
zone_lan_dest_ACCEPT  udp  --  anywhere             anywhere             udp dpt:isakmp /* @rule[9] */
ACCEPT     all  --  anywhere             anywhere             ctstate DNAT /* Accept port forwards */
zone_wan_dest_ACCEPT  all  --  anywhere             anywhere            

Chain zone_wan_input (2 references)
target     prot opt source               destination         
input_wan_rule  all  --  anywhere             anywhere             /* user chain for input */
ACCEPT     udp  --  anywhere             anywhere             udp dpt:bootpc /* Allow-DHCP-Renew */
ACCEPT     icmp --  anywhere             anywhere             icmp echo-request /* Allow-Ping */
ACCEPT     igmp --  anywhere             anywhere             /* Allow-IGMP */
ACCEPT     tcp  --  anywhere             192.168.1.9          tcp dpt:ssh /* Allow_SSH_from_WAN */
ACCEPT     all  --  anywhere             anywhere             ctstate DNAT /* Accept port redirections */
zone_wan_src_ACCEPT  all  --  anywhere             anywhere            

Chain zone_wan_output (2 references)
target     prot opt source               destination         
output_wan_rule  all  --  anywhere             anywhere             /* user chain for output */
zone_wan_dest_ACCEPT  all  --  anywhere             anywhere            

Chain zone_wan_src_ACCEPT (1 references)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            
ACCEPT     all  --  anywhere             anywhere  </code></pre></div><p>but still I cannot ping the outside nor download anything.</p>											<p class="post-edited">(Last edited by <strong>bebo</strong> on 14 Oct 2017, 03:20)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p367313">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">bebo</div>
					<div class="post-datetime">
						24 Oct 2017, 22:06					</div>
				</div>
				<div class="post-content content">
					<p>Hi all!</p><div class="quotebox"><cite>Mijzelf wrote:</cite><blockquote><p>my first idea it that it&#039;s somehow blocked in your &#039;MODEM+AP&#039; (which of course also contains a router+firewall).</p></blockquote></div><p>You were right Mijzelf! the problem was that the modem my ISP gave me was restricting the communication with the outside world to a certain range of IPs.<br />Other than the DHCP range of addresses config, it has a range of addresses on which to perform the NAT: it was set to start from 192.168.1.10 up to .254, and the IP of the owrt router was 192.168.1.9.<br />Once I lowered it to start NATting from .2 it started navigating smoothly!</p><p>Thanks again guys for your help and patience, you rock&nbsp; <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>