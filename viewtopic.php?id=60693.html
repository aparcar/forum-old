<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> rootfs_data is readonly on BCM63xx (m25p80 soft protected) [SOLVED]</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 30 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p298364">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">vta</div>
					<div class="post-datetime">
						2 Nov 2015, 14:14					</div>
				</div>
				<div class="post-content content">
					<p>i have starnet ar800.<br />openwrt target is - Generic 96328avng.</p><div class="codebox"><pre><code>HELO
CPUI
L1CI
DRAM
----
PHYS
ZQDN
PHYE
DINT
LSYN
USYN
MSYN
LMBE
PASS
----
ZBSS
CODE
DATA
L12F
MAIN


CFE version 1.0.37-106.5 for BCM96328 (32bit,SP,BE)
Build Date: Wed Dec 29 15:47:48 CST 2010 (wanghuaijia@txcpyjeb)
Copyright (C) 2000-2009 Broadcom Corporation.

HS Serial flash device: name GD25Q32, id 0xc815 size 4096KB
Total Flash size: 4096K with 1024 sectors
FLASH_BASE                         = 0xb8000000

fInfo-&gt;flash_rootfs_start_offset   = 0x00010000

fInfo-&gt;flash_meta_start_blk        = 1016

fInfo-&gt;flash_syslog_start_blk      = 0
fInfo-&gt;flash_syslog_number_blk     = 0
fInfo-&gt;flash_syslog_length         = 0x0

fInfo-&gt;flash_backup_psi_start_blk  = 0
fInfo-&gt;flash_backup_psi_number_blk = 0

sp startAddr                        = 0xb83f8000
fInfo-&gt;flash_scratch_pad_start_blk  = 1016
fInfo-&gt;flash_scratch_pad_number_blk = 2
fInfo-&gt;flash_scratch_pad_length     = 0x2000
fInfo-&gt;flash_scratch_pad_blk_offset = 0x0

psi startAddr                      = b83fa000
fInfo-&gt;flash_persistent_start_blk  = 1018
fInfo-&gt;flash_persistent_number_blk = 6
fInfo-&gt;flash_persistent_length     = 0x6000
fInfo-&gt;flash_persistent_blk_offset = 0x0

Chip ID: BCM6328B0, MIPS: 320MHz, DDR: 320MHz, Bus: 160MHz
Main Thread: TP0
Memory Test Passed
Total Memory: 67108864 bytes (64MB)
Boot Address: 0xb8000000

Board IP address                  : 192.168.1.1:ffffff00  
Host IP address                   : 192.168.1.100  
Gateway IP address                :   
Run from flash/host (f/h)         : f  
Default host run file name        : vmlinux  
Default host flash file name      : bcm963xx_fs_kernel  
Boot delay (0-9 seconds)          : 1  
Board Id (0-3)                    : 96328A600  
Number of MAC Addresses (1-32)    : 11  
Base MAC Address                  : 00:1a:a9:b8:2f:71  
PSI Size (1-64) KBytes            : 24  
Enable Backup PSI [0|1]           : 0  
System Log Size (0-256) KBytes    : 0  
Main Thread Number [0|1]          : 0  
User&#039;s PSI Size (0-64) KBytes     : 0  
Voice Board Configuration (0-4)   : LE88276  

*** Press &#039;j&#039; or &#039;J&#039; to stop auto run (1 seconds) ***
Auto run second count down: 0
Booting from only image (0xb8010000) ...
Code Address: 0x80A00000, Entry Address: 0x80a00000
LZMA: Prossible old LZMA format, trying to decompress..
Decompression OK!
Entry at 0x80a00000
Closing network.
Disabling Switch ports.
Flushing Receive Buffers...
0 buffers found.
Closing DMA Channels.
Starting program at 0x80a00000
[    0.000000] Linux version 4.1.11 (vova@slayer) (gcc version 4.8.3 (OpenWrt/Linaro GCC 4.8-2014.04 r47278) ) #6 Sun Nov 1 21:10:14 YAKT 2015
[    0.000000] Detected Broadcom 0x6328 CPU revision b0
[    0.000000] CPU frequency is 320 MHz
[    0.000000] 64MB of RAM installed
[    0.000000] board_bcm963xx: Boot address 0xb8000000
[    0.000000] board_bcm963xx: CFE version: 1.0.37-106.5
[    0.000000] bcm63xx_nvram: nvram checksum failed, contents may be invalid (expected 00000000, got 0aef128b)
[    0.000000] bootconsole [early0] enabled
[    0.000000] CPU0 revision is: 0002a075 (Broadcom BMIPS4350)
[    0.000000] board: board name: 96328avng
[    0.000000] MIPS: machine is Broadcom BCM96328avng reference board
[    0.000000] Determined physical RAM map:
[    0.000000]  memory: 04000000 @ 00000000 (usable)
[    0.000000] Initrd not found or empty - disabling initrd
[    0.000000] Zone ranges:
[    0.000000]   Normal   [mem 0x0000000000000000-0x0000000003ffffff]
[    0.000000] Movable zone start for each node
[    0.000000] Early memory node ranges
[    0.000000]   node   0: [mem 0x0000000000000000-0x0000000003ffffff]
[    0.000000] Initmem setup node 0 [mem 0x0000000000000000-0x0000000003ffffff]
[    0.000000] Primary instruction cache 32kB, VIPT, 4-way, linesize 16 bytes.
[    0.000000] Primary data cache 32kB, 2-way, VIPT, cache aliases, linesize 16 bytes
[    0.000000] Built 1 zonelists in Zone order, mobility grouping on.  Total pages: 16256
[    0.000000] Kernel command line:  root=/dev/mtdblock2 rootfstype=squashfs,jffs2 noinitrd console=ttyS0,115200
[    0.000000] PID hash table entries: 256 (order: -2, 1024 bytes)
[    0.000000] Dentry cache hash table entries: 8192 (order: 3, 32768 bytes)
[    0.000000] Inode-cache hash table entries: 4096 (order: 2, 16384 bytes)
[    0.000000] Memory: 59588K/65536K available (2995K kernel code, 135K rwdata, 620K rodata, 1296K init, 193K bss, 5948K reserved, 0K cma-reserved)
[    0.000000] NR_IRQS:256
[    0.000000] clocksource MIPS: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 11945377789 ns
[    0.000018] sched_clock: 32 bits at 160MHz, resolution 6ns, wraps every 13421772796ns
[    0.008672] Calibrating delay loop... 319.74 BogoMIPS (lpj=639488)
[    0.050999] pid_max: default: 32768 minimum: 301
[    0.056427] Mount-cache hash table entries: 1024 (order: 0, 4096 bytes)
[    0.063221] Mountpoint-cache hash table entries: 1024 (order: 0, 4096 bytes)
[    0.078233] clocksource jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 7645041785100000 ns
[    0.089979] NET: Registered protocol family 16
[    0.330725] registering PCI controller with io_map_base unset
[    0.362056] PCI host bridge to bus 0000:00
[    0.366305] pci_bus 0000:00: root bus resource [mem 0x10f00000-0x10ffffff]
[    0.373370] pci_bus 0000:00: root bus resource [??? 0x00000000 flags 0x0]
[    0.380352] pci_bus 0000:00: root bus resource [??? 0x00000000 flags 0x0]
[    0.387339] pci_bus 0000:00: No busn resource found for root bus, will use [bus 00-ff]
[    0.396164] pci 0000:00:00.0: bridge configuration invalid ([bus 00-00]), reconfiguring
[    0.405587] pci 0000:00:00.0: BAR 8: assigned [mem 0x10f00000-0x10ffffff]
[    0.412604] pci 0000:01:00.0: BAR 0: assigned [mem 0x10f00000-0x10f03fff 64bit]
[    0.420135] pci 0000:00:00.0: PCI bridge to [bus 01]
[    0.425234] pci 0000:00:00.0:   bridge window [mem 0x10f00000-0x10ffffff]
[    0.433878] Switched to clocksource MIPS
[    0.441230] PCI: Enabling device 0000:00:00.0 (0000 -&gt; 0002)
[    0.447105] PCI: Enabling device 0000:01:00.0 (0000 -&gt; 0002)
[    0.452953] bcma: bus0: Found chip with id 0x4313, rev 0x01 and package 0x08
[    0.460243] bcma: bus0: Core 0 found: ChipCommon (manuf 0x4BF, id 0x800, rev 0x24, class 0x0)
[    0.469057] bcma: bus0: Core 1 found: IEEE 802.11 (manuf 0x4BF, id 0x812, rev 0x18, class 0x0)
[    0.477967] bcma: bus0: Core 2 found: PCIe (manuf 0x4BF, id 0x820, rev 0x11, class 0x0)
[    0.486301] bcma_fallback_sprom: pci bus/device num mismatch: expected 0/0, but got 1/0
[    0.511314] bcma: bus0: Bus registered
[    0.515806] NET: Registered protocol family 2
[    0.522606] TCP established hash table entries: 1024 (order: 0, 4096 bytes)
[    0.529905] TCP bind hash table entries: 1024 (order: 0, 4096 bytes)
[    0.536492] TCP: Hash tables configured (established 1024 bind 1024)
[    0.543504] UDP hash table entries: 256 (order: 0, 4096 bytes)
[    0.549600] UDP-Lite hash table entries: 256 (order: 0, 4096 bytes)
[    0.556805] NET: Registered protocol family 1
[    0.563872] futex hash table entries: 256 (order: -1, 3072 bytes)
[    0.574857] squashfs: version 4.0 (2009/01/31) Phillip Lougher
[    0.580911] jffs2: version 2.2 (NAND) (SUMMARY) (LZMA) (RTIME) (CMODE_PRIORITY) (c) 2001-2006 Red Hat, Inc.
[    0.594814] io scheduler noop registered
[    0.598897] io scheduler deadline registered (default)
[    0.606310] bcm63xx_uart.0: ttyS0 at MMIO 0xb0000100 (irq = 36, base_baud = 1562500) is a bcm63xx_uart
[    0.615958] console [ttyS0] enabled
[    0.615958] console [ttyS0] enabled
[    0.623119] bootconsole [early0] disabled
[    0.623119] bootconsole [early0] disabled
[    0.640826] m25p80 spi1.0: found gd25q32, expected m25p80
[    0.646415] m25p80 spi1.0: gd25q32 (4096 Kbytes)
[    0.651753] bcm63xxpart: CFE boot tag found with version 6 and board type 96328avng
[    0.659738] bcm63xxpart: Partition 0 is CFE offset 0 and length 10000
[    0.666384] bcm63xxpart: Partition 1 is kernel offset 10100 and length 141fcf
[    0.673704] bcm63xxpart: Partition 2 is rootfs offset 1520cf and length 29df31
[    0.681152] bcm63xxpart: Partition 3 is nvram offset 3f0000 and length 10000
[    0.688399] bcm63xxpart: Partition 4 is linux offset 10000 and length 3e0000
[    0.695654] 5 bcm63xxpart partitions found on MTD device spi1.0
[    0.701744] Creating 5 MTD partitions on &quot;spi1.0&quot;:
[    0.706690] 0x000000000000-0x000000010000 : &quot;CFE&quot;
[    0.713425] 0x000000010100-0x0000001520cf : &quot;kernel&quot;
[    0.720246] 0x0000001520cf-0x0000003f0000 : &quot;rootfs&quot;
[    0.727149] mtd: device 2 (rootfs) set to be root filesystem
[    0.736916] 1 squashfs-split partitions found on MTD device rootfs
[    0.743334] 0x0000002f0000-0x0000003f0000 : &quot;rootfs_data&quot;
[    0.750766] 0x0000003f0000-0x000000400000 : &quot;nvram&quot;
[    0.757582] 0x000000010000-0x0000003f0000 : &quot;linux&quot;
[    0.803137] b53_common: found switch: BCM63xx, rev 0
[    0.808828] bcm63xx-wdt bcm63xx-wdt:  started, timer margin: 30 sec
[    0.818644] NET: Registered protocol family 10
[    0.830462] NET: Registered protocol family 17
[    0.835202] bridge: automatic filtering via arp/ip/ip6tables has been deprecated. Update your scripts to load br_netfilter if you need this.
[    0.848232] 8021q: 802.1Q VLAN Support v1.8
[    0.865558] VFS: Mounted root (squashfs filesystem) readonly on device 31:2.
[    0.890398] Freeing unused kernel memory: 1296K (803bc000 - 80500000)
[    2.467317] init: Console is alive
[    2.471174] init: - watchdog -
[    3.475739] init: - preinit -
[    4.206263] bcm63xx_enetsw bcm63xx_enetsw.0: link UP on Port 1, 100Mbps, full-duplex
ip: RTNETLINK answers: File exists
[    4.290563] random: procd urandom read with 74 bits of entropy available
ip: RTNETLINK answers: File exists
Press the [f] key and hit [enter] to enter failsafe mode
Press the [1], [2], [3] or [4] key and hit [enter] to select the debug level
ip: RTNETLINK answers: File exists
[    7.610559] mount_root: jffs2 not ready yet, using temporary tmpfs overlay
[    7.665985] procd: - early -
[    7.669049] procd: - watchdog -
[    8.432454] procd: - ubus -
[    9.448367] procd: - init -
Please press Enter to activate this console.
[   10.607484] ip6_tables: (C) 2000-2006 Netfilter Core Team
[   10.645402] ip_tables: (C) 2000-2006 Netfilter Core Team
[   10.672489] nf_conntrack version 0.5.0 (951 buckets, 3804 max)
[   10.755391] xt_time: kernel timezone is -0000
[   10.785017] PPP generic driver version 2.4.2
[   10.794438] NET: Registered protocol family 24
[   12.995320] random: nonblocking pool is initialized
[   16.066229] bcm63xx_enetsw bcm63xx_enetsw.0: link UP on Port 1, 100Mbps, full-duplex
[   19.049808] jffs2_scan_eraseblock(): End of filesystem marker found at 0x0
[   19.067063] jffs2_build_filesystem(): unlocking the mtd device... done.
[   19.073809] jffs2_build_filesystem(): erasing all blocks after the end marker... 
[   19.599613] jffs2: Newly-erased block contained word 0x97b9ed8f at offset 0x00020000
[   19.619328] jffs2: Newly-erased block contained word 0x7b5ec1de at offset 0x00010000
[   19.635466] jffs2: Newly-erased block contained word 0xdeadc0de at offset 0x00000000
[   19.649915] done.
[   19.652034] jffs2: notice: (666) jffs2_build_xattr_subsystem: complete building xattr subsystem, 0 of xdatum (0 unchecked, 0 orphan) and 0 of xref (0 dead, 0 orph.
[   24.894228] bcm63xx_enetsw bcm63xx_enetsw.0: link UP on Port 1, 100Mbps, full-duplex
[   24.910387] device eth0.1 entered promiscuous mode
[   24.915350] device eth0 entered promiscuous mode
[   24.951594] br-lan: port 1(eth0.1) entered forwarding state
[   24.957402] br-lan: port 1(eth0.1) entered forwarding state
[   26.957906] br-lan: port 1(eth0.1) entered forwarding state



BusyBox v1.23.2 (2015-11-01 14:27:17 YAKT) built-in shell (ash)

  _______                     ________        __
 |       |.-----.-----.-----.|  |  |  |.----.|  |_
 |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|
 |_______||   __|_____|__|__||________||__|  |____|
          |__| W I R E L E S S   F R E E D O M
 -----------------------------------------------------
 DESIGNATED DRIVER (Bleeding Edge, r47278)
 -----------------------------------------------------
  * 2 oz. Orange Juice         Combine all juices in a
  * 2 oz. Pineapple Juice      tall glass filled with
  * 2 oz. Grapefruit Juice     ice, stir well.
  * 2 oz. Cranberry Juice
 -----------------------------------------------------
root@OpenWrt:/# </code></pre></div><p>no changes are saved after reboot.<br />any writes to /dev/mtd3 has no effect.</p><div class="codebox"><pre><code>root@OpenWrt:/# mtd unlock rootfs_data
Unlocking rootfs_data ...
root@OpenWrt:/# mtd erase rootfs_data
Unlocking rootfs_data ...
Erasing rootfs_data ...
root@OpenWrt:/# echo shit &gt; /dev/mtd3
root@OpenWrt:/# hexdump -n 32 /dev/mtd3
0000000 dead c0de ffff ffff ffff ffff ffff ffff
0000010 ffff ffff ffff ffff ffff ffff ffff ffff
0000020
root@OpenWrt:/# mount
/dev/root on /rom type squashfs (ro,relatime)
proc on /proc type proc (rw,nosuid,nodev,noexec,noatime)
sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,noatime)
tmpfs on /tmp type tmpfs (rw,nosuid,nodev,noatime)
tmpfs on /tmp/root type tmpfs (rw,noatime,mode=755)
tmpfs on /dev type tmpfs (rw,nosuid,relatime,size=512k,mode=755)
devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,mode=600)
debugfs on /sys/kernel/debug type debugfs (rw,noatime)
/dev/mtdblock3 on /overlay type jffs2 (rw,noatime)
overlayfs:/overlay on / type overlay (rw,noatime,lowerdir=/,upperdir=/overlay/upper,workdir=/overlay/work)
root@OpenWrt:/# df -h
Filesystem                Size      Used Available Use% Mounted on
/dev/root                 1.8M      1.8M         0 100% /rom
tmpfs                    29.7M     56.0K     29.7M   0% /tmp
tmpfs                    29.7M     24.0K     29.7M   0% /tmp/root
tmpfs                   512.0K         0    512.0K   0% /dev
/dev/mtdblock3            1.0M    396.0K    628.0K  39% /overlay
overlayfs:/overlay        1.0M    396.0K    628.0K  39% /</code></pre></div><p>It seems the device is still locked.<br />Any ideas?</p>											<p class="post-edited">(Last edited by <strong>vta</strong> on 31 Mar 2016, 11:27)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p317274">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">vta</div>
					<div class="post-datetime">
						29 Mar 2016, 18:33					</div>
				</div>
				<div class="post-content content">
					<p>After some digging, I found out that the flash chip (gd25q32) is in the software write protection mode on some reason while booting the system. Status register bits BP4-BP0 shows that the whole address space is protected. I am not sure if this is the result of some unexpected state of mtd subsystem or maybe the stock CFE bootloader configures the flash in this way.<br />I am not sure my solution is pretty correct, but it works for me.<br />Patching ./build_dir/target-mips_mips32_musl-1.1.14/linux-brcm63xx_generic/linux-4.1.16/drivers/mtd/devices/m25p80.c<br />Add this:<br /></p><div class="codebox"><pre><code>// m25p80.c device driver

void m25p80_ar800_postprobe(struct spi_device *spi)
{
    char buf[] = {0x06, 0x01, 0x24};
    struct spi_transfer t[2] = {};
    struct spi_message m;
    spi_message_init(&amp;m);
    t[0].tx_buf = buf;
    t[0].len = 1;
    t[0].cs_change = 1;
    spi_message_add_tail(&amp;t[0], &amp;m);
    t[1].tx_buf = buf + 1;
    t[1].len = 2;
    spi_message_add_tail(&amp;t[1], &amp;m);
    spi_sync(spi, &amp;m);

    printk(KERN_WARNING &quot;m25p80 unlock patch\n&quot;);
    mdelay(50);

}</code></pre></div><p>and call this before returning from m25p80_probe function:<br /></p><div class="codebox"><pre><code>// m25p80.c device driver
static int m25p_probe(struct spi_device *spi)
{
//
// .... cutted
//
    m25p80_ar800_postprobe(spi);
  
    return mtd_device_parse_register(&amp;nor-&gt;mtd,
            data ? data-&gt;part_probe_types : NULL, &amp;ppdata,
            data ? data-&gt;parts : NULL,
            data ? data-&gt;nr_parts : 0);
}</code></pre></div><p>This makes software protect of 0x0000-0xffff according to datasheet. This is CFE region on the device.</p><p>Upd: I faced strange behavior. When I comment printk line I get kernel panic. May be devs will comment this. Still not sure the correctness of chosen code place for chip unlock.</p><p>Upd2: Ok.You should wait after write status register, while WIP is 1. According to the datasheet&nbsp; tW (Write Status Register Cycle Time) which is 30ms at worst case for gd25q32 and 15ms for m25p80. So 50ms is more than enough.</p>											<p class="post-edited">(Last edited by <strong>vta</strong> on 31 Mar 2016, 11:46)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>