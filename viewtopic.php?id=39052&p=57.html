<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> mwan3; multi-wan policy routing (general topic)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 22 May 2013 and 6 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 57 of 65</div><nav><ul><li><a href="viewtopic.php%3Fid=39052&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=55.html">55</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=56.html">56</a></li><li class="pagination-current"><span>57</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=58.html">58</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=59.html">59</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p295501">
				<div class="post-metadata">
					<div class="post-num">Post #1401</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						9 Oct 2015, 22:15					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Philipp11 wrote:</cite><blockquote><p>It seems like the file is to be found in /bin/ip though.<br/>Would it be ok to edit your<br/>sbin/mwan3 to<br/></p><div class="codebox"><pre><code>#!/bin/sh
. /lib/functions.sh

IP=&quot;/usr/bin/ip -4&quot;
IPS=&quot;/usr/sbin/ipset&quot;
IPT=&quot;/usr/sbin/iptables -t mangle -w&quot;

help()
{</code></pre></div></blockquote></div><p>Yes go ahead. You have to edit the /etc/hotplug.d/iface/15-mwan3 as well. Thanks for pointing that out.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 9 Oct 2015, 22:21)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p295504">
				<div class="post-metadata">
					<div class="post-num">Post #1402</div>
					<div class="post-author">Philipp11</div>
					<div class="post-datetime">
						9 Oct 2015, 22:35					</div>
				</div>
				<div class="post-content content">
					<p>For reference : I&#039;m running trunk r47142&nbsp; now.</p><p>after restarting mwan3 i got some ipset errors :</p><div class="codebox"><pre><code>root@OpenWrt:~# mwan3 restart
ipset v6.24: The set with the given name does not exist
uci: Entry not found
uci: Entry not found
ipset v6.24: The set with the given name does not exist
uci: Entry not found
uci: Entry not found
ipset v6.24: The set with the given name does not exist
uci: Entry not found
uci: Entry not found</code></pre></div><p>Tracking still wasn&#039;t working and all WANs appear offline in the luci app (even though they&#039;re working)<br/>removed all track_ips, and voila my traffic passed through all gateways again.<br/>in the luci-app my gateways still showed up as offline even though tracking was disabled : <br/><span class="postimg"><img src="http://puu.sh/kEiDz/eff410ef54.png" alt="PunBB bbcode test"/></span><br/>In mwan3 the interfaces appear as online :<br/></p><div class="codebox"><pre><code>2
root@OpenWrt:~# mwan3 status
Interface status:
 interface wan is online
 interface wan2_1 is online
 interface wan2_2 is online

Policy balanced:
 wan2_1 (50%)
 wan2_2 (50%)

Policy balancedg2g3:
 unreachable

Policy express:
 wan2_2 (33%)
 wan2_1 (33%)
 wan (33%)

Policy wan2_only:
 wan2_1 (100%)

Policy wan2_wan:
 wan2_1 (100%)

Policy wan_only:
 wan (100%)

Policy wan_wan2:
 wan (100%)

Known networks:
 62.218.4.126
 192.168.20.0
 127.0.0.1
 192.168.20.37
 127.0.0.0
 192.168.0.255
 192.168.0.0
 127.0.0.0/8
 224.0.0.0/3
 192.168.20.255
 192.168.0.1
 86.32.217.1
 127.255.255.255
 192.168.0.0/24
 192.168.20.0/24
 192.168.20.38</code></pre></div><p>Traffic was also beeing routed again by mwan3 to macvlan1 and macvlan2.</p><p>What happened seconds later when i tryed to start another ping from macvlan1 made me sad : </p><div class="codebox"><pre><code>root@OpenWrt:~# ping -I macvlan1 google.at
PING google.at (64.15.113.182): 56 data bytes
^C
--- google.at ping statistics ---
59 packets transmitted, 0 packets received, 100% packet loss</code></pre></div><p>So apparently the moment mwan3 starts to route traffic the interface shuts down... but only one of them. macvlan2 is still working the same as it was in CC.</p><p>When i tryed to use your integrated diagnostic tools to gather some information to post here i stumbled upon some more problems related to IP, here a small cutting from my troubleshooting data with the ip-problems :</p><div class="codebox"><pre><code>Output of &quot;ip rule show&quot; : 

No data found

Output of &quot;ip route list table 1-250&quot; : 

No data found</code></pre></div><p>I guess that&#039;s also related to the moved path of ip<br/>When i manually enter these cvars i get a valid response :<br/></p><div class="codebox"><pre><code>root@OpenWrt:~# ip route list table 1-250
Error: argument &quot;1-250&quot; is wrong: table id value is invalid

root@OpenWrt:~# ip route list table 1
default via 62.218.4.126 dev pppoe-wan
root@OpenWrt:~# ip route list table 2
default via 192.168.20.4 dev macvlan1
root@OpenWrt:~# ip route list table 3
default via 192.168.20.1 dev macvlan2

root@OpenWrt:~# ip rule show
0:      from all lookup 128
1:      from all lookup local
1001:   from all iif pppoe-wan lookup main
1002:   from all iif macvlan1 lookup main
1003:   from all iif macvlan2 lookup main
2001:   from all fwmark 0x100/0xff00 lookup 1
2002:   from all fwmark 0x200/0xff00 lookup 2
2003:   from all fwmark 0x300/0xff00 lookup 3
2253:   from all fwmark 0xfd00/0xff00 blackhole
2254:   from all fwmark 0xfe00/0xff00 unreachable
32766:  from all lookup main
32767:  from all lookup default</code></pre></div><br/><p>Thats the whole log .. appears to be exactly the same as in CC<br/></p><div class="codebox"><pre><code>Software versions : 

OpenWrt - OpenWrt Designated Driver r47142
LuCI - git-15.278.60928-3289e13

mwan3 - 1.6-2
mwan3-luci - 1.4-3

Output of &quot;cat /etc/config/mwan3&quot; : 

config rule &#039;me&#039;
    option src_ip &#039;192.168.0.147&#039;
    option proto &#039;all&#039;
    option sticky &#039;0&#039;
    option use_policy &#039;wan_only&#039;

config rule &#039;server_balanced&#039;
    option proto &#039;all&#039;
    option sticky &#039;0&#039;
    option src_ip &#039;192.168.0.101&#039;
    option use_policy &#039;balanced&#039;

config rule &#039;dreamboxalwin&#039;
    option proto &#039;all&#039;
    option sticky &#039;0&#039;
    option src_ip &#039;192.168.0.111&#039;
    option use_policy &#039;wan_only&#039;

config rule &#039;dreamboxgerry&#039;
    option src_ip &#039;192.168.0.112&#039;
    option proto &#039;all&#039;
    option sticky &#039;0&#039;
    option use_policy &#039;wan_only&#039;

config rule &#039;dreamboxheidan&#039;
    option src_ip &#039;192.168.0.113&#039;
    option proto &#039;all&#039;
    option sticky &#039;0&#039;
    option use_policy &#039;wan_only&#039;

config rule &#039;udp&#039;
    option proto &#039;udp&#039;
    option sticky &#039;0&#039;
    option use_policy &#039;wan_only&#039;
    option src_ip &#039;192.168.0.123&#039;

config rule &#039;poe&#039;
    option dest_port &#039;6112&#039;
    option proto &#039;tcp&#039;
    option sticky &#039;0&#039;
    option use_policy &#039;wan_only&#039;

config rule &#039;csgo&#039;
    option use_policy &#039;wan_only&#039;
    option sticky &#039;0&#039;
    option proto &#039;udp&#039;
    option dest_port &#039;27000:29000,25162,9899,20006,9989,13000&#039;

config rule &#039;teamspeak&#039;
    option proto &#039;udp&#039;
    option use_policy &#039;wan_only&#039;
    option dest_port &#039;9987,1337&#039;

config rule &#039;default_rule&#039;
    option dest_ip &#039;0.0.0.0/0&#039;
    option proto &#039;all&#039;
    option sticky &#039;0&#039;
    option use_policy &#039;balanced&#039;

config rule &#039;sticky_even&#039;
    option src_ip &#039;0.0.0.0/0.0.0.1&#039;
    option dest_port &#039;443&#039;
    option proto &#039;tcp&#039;
    option use_policy &#039;wan_only&#039;

config rule &#039;sticky_odd&#039;
    option src_ip &#039;0.0.0.1/0.0.0.1&#039;
    option dest_port &#039;443&#039;
    option proto &#039;tcp&#039;
    option use_policy &#039;wan2_wan&#039;

config rule &#039;fifa&#039;
    option dest_port &#039;3659,9565,9570,9000:9999&#039;
    option use_policy &#039;wan_only&#039;
    option proto &#039;udp&#039;
    option src_ip &#039;192.168.0.123&#039;

config interface &#039;wan&#039;
    option enabled &#039;1&#039;
    option reliability &#039;2&#039;
    option count &#039;1&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;8&#039;

config interface &#039;wan2_1&#039;
    option reliability &#039;1&#039;
    option count &#039;1&#039;
    option down &#039;3&#039;
    option enabled &#039;1&#039;
    option timeout &#039;4&#039;
    option interval &#039;10&#039;
    option up &#039;1&#039;

config interface &#039;wan2_2&#039;

    option reliability &#039;1&#039;
    option count &#039;1&#039;
    option down &#039;3&#039;
    option enabled &#039;1&#039;
    option timeout &#039;4&#039;
    option interval &#039;10&#039;
    option up &#039;1&#039;

config member &#039;wan_m1_w3&#039;
    option interface &#039;wan&#039;
    option metric &#039;1&#039;
    option weight &#039;4&#039;

config member &#039;wan_m2_w3&#039;
    option interface &#039;wan&#039;
    option metric &#039;2&#039;
    option weight &#039;1&#039;

config member &#039;wan2_m1_w2&#039;
    option weight &#039;4&#039;
    option metric &#039;1&#039;
    option interface &#039;wan2_1&#039;

config member &#039;wan2_m2_w2&#039;
    option metric &#039;2&#039;
    option weight &#039;2&#039;
    option interface &#039;wan2_1&#039;

config policy &#039;wan_only&#039;
    list use_member &#039;wan_m1_w3&#039;
    option last_resort &#039;default&#039;

config policy &#039;wan2_only&#039;
    list use_member &#039;wan2_m1_w2&#039;

config policy &#039;balanced&#039;
    option last_resort &#039;default&#039;
    list use_member &#039;wan2_2_m1_w2&#039;
    list use_member &#039;wan2_m1_w2&#039;
    list use_member &#039;wan_m2_w3&#039;

config policy &#039;wan_wan2&#039;
    list use_member &#039;wan_m1_w3&#039;
    list use_member &#039;wan2_m2_w2+&#039;

config policy &#039;wan2_wan&#039;
    list use_member &#039;wan_m2_w3&#039;
    list use_member &#039;wan2_m1_w2&#039;

config policy &#039;balancedg2g3&#039;

config member &#039;wan2_2_m1_w2&#039;
    option interface &#039;wan2_2&#039;
    option weight &#039;4&#039;
    option metric &#039;1&#039;

config policy &#039;express&#039;
    list use_member &#039;wan_m1_w3&#039;
    list use_member &#039;wan2_m1_w2&#039;
    list use_member &#039;wan2_2_m1_w2&#039;

Output of &quot;cat /etc/config/network&quot; : 

config interface &#039;loopback&#039;
    option ifname &#039;lo&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;127.0.0.1&#039;
    option netmask &#039;255.0.0.0&#039;

config interface &#039;lan&#039;
    option ifname &#039;eth1.1&#039;
    option proto &#039;static&#039;
    option type &#039;bridge&#039;
    option ipaddr &#039;192.168.0.1&#039;
    option netmask &#039;255.255.255.0&#039;
    option dns &#039;8.8.8.8&#039;

config interface &#039;wan&#039;
    option proto &#039;pppoe&#039;
    USERNAME HIDDEN
    PASSWORD HIDDEN
    option metric &#039;10&#039;
    option _orig_ifname &#039;eth0&#039;
    option _orig_bridge &#039;false&#039;
    option ifname &#039;eth0&#039;

config interface &#039;wan2&#039;
    option ifname &#039;eth1.3&#039;
    option proto &#039;none&#039;

config device &#039;macvlan1&#039;
    option ifname &#039;eth1.3&#039;
    option type &#039;macvlan&#039;
    option name &#039;macvlan1&#039;
    option macaddr &#039;B0:48:7A:FF:36:95&#039;

config device &#039;macvlan2&#039;
    option ifname &#039;eth1.3&#039;
    option type &#039;macvlan&#039;
    option name &#039;macvlan2&#039;
    option macaddr &#039;B0:48:7A:FF:36:96&#039;

config interface &#039;wan2_1&#039;
    option ifname &#039;macvlan1&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;192.168.20.38&#039;
    option netmask &#039;255.255.255.0&#039;
    option gateway &#039;192.168.20.4&#039;
    option metric &#039;20&#039;
    option dns &#039;213.73.91.35 8.8.8.8&#039;

config interface &#039;wan2_2&#039;
    option ifname &#039;macvlan2&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;192.168.20.37&#039;
    option netmask &#039;255.255.255.0&#039;
    option metric &#039;30&#039;
    option dns &#039;213.73.91.35 8.8.8.8&#039;
    option gateway &#039;192.168.20.1&#039;

config switch
    option name &#039;switch0&#039;
    option reset &#039;1&#039;
    option enable_vlan &#039;1&#039;

config switch_vlan
    option device &#039;switch0&#039;
    option vlan &#039;1&#039;
    option vid &#039;1&#039;
    option ports &#039;0t 1 2 3&#039;

config switch_vlan
    option device &#039;switch0&#039;
    option vlan &#039;3&#039;
    option ports &#039;0t 4&#039;
    option vid &#039;3&#039;

config switch_vlan
    option device &#039;switch0&#039;
    option vlan &#039;2&#039;
    option ports &#039;5 6&#039;
    option vid &#039;2&#039;

Output of &quot;ifconfig&quot; : 

br-lan    Link encap:Ethernet  HWaddr 14:CC:20:A9:2E:36  
          inet addr:192.168.0.1  Bcast:192.168.0.255  Mask:255.255.255.0
          inet6 addr: fe80::16cc:20ff:fea9:2e36/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:120703 errors:0 dropped:2 overruns:0 frame:0
          TX packets:199184 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:10785739 (10.2 MiB)  TX bytes:240063187 (228.9 MiB)

eth0      Link encap:Ethernet  HWaddr 14:CC:20:A9:2E:37  
          inet6 addr: fe80::16cc:20ff:fea9:2e37/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:119784 errors:0 dropped:0 overruns:0 frame:0
          TX packets:67705 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:152984987 (145.8 MiB)  TX bytes:6905716 (6.5 MiB)
          Interrupt:4 

eth1      Link encap:Ethernet  HWaddr 14:CC:20:A9:2E:36  
          inet6 addr: fe80::16cc:20ff:fea9:2e36/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:379732 errors:0 dropped:1 overruns:2 frame:0
          TX packets:241153 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:109760421 (104.6 MiB)  TX bytes:245223112 (233.8 MiB)
          Interrupt:5 

eth1.1    Link encap:Ethernet  HWaddr 14:CC:20:A9:2E:36  
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:120766 errors:0 dropped:1 overruns:0 frame:0
          TX packets:198745 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:10787158 (10.2 MiB)  TX bytes:239967777 (228.8 MiB)

eth1.3    Link encap:Ethernet  HWaddr 14:CC:20:A9:2E:36  
          inet6 addr: fe80::16cc:20ff:fea9:2e36/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:257444 errors:0 dropped:0 overruns:0 frame:0
          TX packets:42389 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:92067969 (87.8 MiB)  TX bytes:4287973 (4.0 MiB)

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:112 errors:0 dropped:0 overruns:0 frame:0
          TX packets:112 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:8760 (8.5 KiB)  TX bytes:8760 (8.5 KiB)

macvlan1  Link encap:Ethernet  HWaddr B0:48:7A:FF:36:95  
          inet addr:192.168.20.38  Bcast:192.168.20.255  Mask:255.255.255.0
          inet6 addr: fe80::b248:7aff:feff:3695/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:189441 errors:0 dropped:0 overruns:0 frame:0
          TX packets:869 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:11368415 (10.8 MiB)  TX bytes:88505 (86.4 KiB)

macvlan2  Link encap:Ethernet  HWaddr B0:48:7A:FF:36:96  
          inet addr:192.168.20.37  Bcast:192.168.20.255  Mask:255.255.255.0
          inet6 addr: fe80::b248:7aff:feff:3696/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:257137 errors:0 dropped:0 overruns:0 frame:0
          TX packets:41513 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:95624752 (91.1 MiB)  TX bytes:4198730 (4.0 MiB)

pppoe-wan Link encap:Point-to-Point Protocol  
          inet addr:86.32.217.1  P-t-P:62.218.4.126  Mask:255.255.255.255
          UP POINTOPOINT RUNNING NOARP MULTICAST  MTU:1492  Metric:1
          RX packets:119004 errors:0 dropped:0 overruns:0 frame:0
          TX packets:66918 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:3 
          RX bytes:150319585 (143.3 MiB)  TX bytes:5409147 (5.1 MiB)

wlan0     Link encap:Ethernet  HWaddr 14:CC:20:A9:2E:36  
          inet6 addr: fe80::16cc:20ff:fea9:2e36/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:739 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1700 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:97312 (95.0 KiB)  TX bytes:253803 (247.8 KiB)

Output of &quot;route -n&quot; : 

Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         62.218.4.126    0.0.0.0         UG    10     0        0 pppoe-wan
0.0.0.0         192.168.20.4    0.0.0.0         UG    20     0        0 macvlan1
0.0.0.0         192.168.20.1    0.0.0.0         UG    30     0        0 macvlan2
62.218.4.126    0.0.0.0         255.255.255.255 UH    0      0        0 pppoe-wan
192.168.0.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan
192.168.20.0    0.0.0.0         255.255.255.0   U     20     0        0 macvlan1
192.168.20.0    0.0.0.0         255.255.255.0   U     30     0        0 macvlan2

Output of &quot;ip rule show&quot; : 

No data found

Output of &quot;ip route list table 1-250&quot; : 

No data found

Firewall default output policy (must be ACCEPT) : 

ACCEPT

Output of &quot;iptables -L -t mangle -v -n&quot; : 

Chain PREROUTING (policy ACCEPT 294K packets, 236M bytes)
 pkts bytes target     prot opt in     out     source               destination         
 306K  244M mwan3_hook  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
 294K  236M fwmark     all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain INPUT (policy ACCEPT 8967 packets, 1222K bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 285K packets, 234M bytes)
 pkts bytes target     prot opt in     out     source               destination         
 285K  234M mssfix     all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain OUTPUT (policy ACCEPT 13367 packets, 3749K bytes)
 pkts bytes target     prot opt in     out     source               destination         
13978 3855K mwan3_hook  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain POSTROUTING (policy ACCEPT 298K packets, 238M bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain fwmark (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain mssfix (1 references)
 pkts bytes target     prot opt in     out     source               destination         
  248 13128 TCPMSS     tcp  --  *      pppoe-wan  0.0.0.0/0            0.0.0.0/0            tcp flags:0x06/0x02 /* wan (mtu_fix) */ TCPMSS clamp to PMTU
  594 31352 TCPMSS     tcp  --  *      macvlan2  0.0.0.0/0            0.0.0.0/0            tcp flags:0x06/0x02 /* wan (mtu_fix) */ TCPMSS clamp to PMTU
    0     0 TCPMSS     tcp  --  *      eth1.3  0.0.0.0/0            0.0.0.0/0            tcp flags:0x06/0x02 /* wan (mtu_fix) */ TCPMSS clamp to PMTU
 1278 65392 TCPMSS     tcp  --  *      macvlan1  0.0.0.0/0            0.0.0.0/0            tcp flags:0x06/0x02 /* wan (mtu_fix) */ TCPMSS clamp to PMTU

Chain mwan3_connected (2 references)
 pkts bytes target     prot opt in     out     source               destination         
 164K  207M MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            match-set mwan3_connected dst MARK or 0xff00

Chain mwan3_hook (2 references)
 pkts bytes target     prot opt in     out     source               destination         
 320K  248M CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0            CONNMARK restore mask 0xff00
 5372  490K mwan3_ifaces  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00
 4261  400K mwan3_connected  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00
 3681  332K mwan3_track  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00
 3681  332K mwan3_rules  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00
 320K  248M CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0            CONNMARK save mask 0xff00
 260K  215M mwan3_connected  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match ! 0xff00/0xff00

Chain mwan3_iface_wan (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       all  --  pppoe-wan *       0.0.0.0/0            0.0.0.0/0            match-set mwan3_connected src mark match 0x0/0xff00 /* default */ MARK or 0xff00
  797 64938 MARK       all  --  pppoe-wan *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan */ MARK xset 0x100/0xff00

Chain mwan3_iface_wan2_1 (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    3   385 MARK       all  --  macvlan1 *       0.0.0.0/0            0.0.0.0/0            match-set mwan3_connected src mark match 0x0/0xff00 /* default */ MARK or 0xff00
    0     0 MARK       all  --  macvlan1 *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan2_1 */ MARK xset 0x200/0xff00

Chain mwan3_iface_wan2_2 (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    3   385 MARK       all  --  macvlan2 *       0.0.0.0/0            0.0.0.0/0            match-set mwan3_connected src mark match 0x0/0xff00 /* default */ MARK or 0xff00
  308 24654 MARK       all  --  macvlan2 *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan2_2 */ MARK xset 0x300/0xff00

Chain mwan3_ifaces (1 references)
 pkts bytes target     prot opt in     out     source               destination         
 5370  490K mwan3_iface_wan2_1  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00
 4803  434K mwan3_iface_wan2_2  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00
 4117  369K mwan3_iface_wan  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00

Chain mwan3_policy_balanced (2 references)
 pkts bytes target     prot opt in     out     source               destination         
  788 49399 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 statistic mode random probability 0.50000000000 /* wan2_1 4 8 */ MARK xset 0x200/0xff00
  874 57269 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan2_2 4 4 */ MARK xset 0x300/0xff00

Chain mwan3_policy_balancedg2g3 (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* unreachable */ MARK xset 0xfe00/0xff00

Chain mwan3_policy_express (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 statistic mode random probability 0.33300000010 /* wan2_2 4 12 */ MARK xset 0x300/0xff00
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 statistic mode random probability 0.50000000000 /* wan2_1 4 8 */ MARK xset 0x200/0xff00
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan 4 4 */ MARK xset 0x100/0xff00

Chain mwan3_policy_wan2_only (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan2_1 4 4 */ MARK xset 0x200/0xff00

Chain mwan3_policy_wan2_wan (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan2_1 4 4 */ MARK xset 0x200/0xff00

Chain mwan3_policy_wan_only (10 references)
 pkts bytes target     prot opt in     out     source               destination         
 1235  145K MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan 4 4 */ MARK xset 0x100/0xff00

Chain mwan3_policy_wan_wan2 (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan 4 4 */ MARK xset 0x100/0xff00

Chain mwan3_rules (1 references)
 pkts bytes target     prot opt in     out     source               destination         
  561 50132 mwan3_policy_wan_only  all  --  *      *       192.168.0.147        0.0.0.0/0            mark match 0x0/0xff00 /* me */
   10   673 mwan3_policy_balanced  all  --  *      *       192.168.0.101        0.0.0.0/0            mark match 0x0/0xff00 /* server_balanced */
    1   309 mwan3_policy_wan_only  all  --  *      *       192.168.0.111        0.0.0.0/0            mark match 0x0/0xff00 /* dreamboxalwin */
    1   309 mwan3_policy_wan_only  all  --  *      *       192.168.0.112        0.0.0.0/0            mark match 0x0/0xff00 /* dreamboxgerry */
    1   309 mwan3_policy_wan_only  all  --  *      *       192.168.0.113        0.0.0.0/0            mark match 0x0/0xff00 /* dreamboxheidan */
  512 86369 mwan3_policy_wan_only  udp  --  *      *       192.168.0.123        0.0.0.0/0            multiport sports 0:65535 multiport dports 0:65535 mark match 0x0/0xff00 /* udp */
    0     0 mwan3_policy_wan_only  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            multiport sports 0:65535 multiport dports 6112 mark match 0x0/0xff00 /* poe */
  159  7616 mwan3_policy_wan_only  udp  --  *      *       0.0.0.0/0            0.0.0.0/0            multiport sports 0:65535 multiport dports 27000:29000,25162,9899,20006,9989,13000 mark match 0x0/0xff00 /* csgo */
    0     0 mwan3_policy_wan_only  udp  --  *      *       0.0.0.0/0            0.0.0.0/0            multiport sports 0:65535 multiport dports 9987,1337 mark match 0x0/0xff00 /* teamspeak */
 1652  106K mwan3_policy_balanced  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* default_rule */
    0     0 mwan3_policy_wan_only  tcp  --  *      *       0.0.0.0/0.0.0.1      0.0.0.0/0            multiport sports 0:65535 multiport dports 443 mark match 0x0/0xff00 /* sticky_even */
    0     0 mwan3_policy_wan2_wan  tcp  --  *      *       0.0.0.1/0.0.0.1      0.0.0.0/0            multiport sports 0:65535 multiport dports 443 mark match 0x0/0xff00 /* sticky_odd */
    0     0 mwan3_policy_wan_only  udp  --  *      *       192.168.0.123        0.0.0.0/0            multiport sports 0:65535 multiport dports 3659,9565,9570,9000:9999 mark match 0x0/0xff00 /* fifa */

Chain mwan3_track (1 references)
 pkts bytes target     prot opt in     out     source               destination#</code></pre></div><p>Regarding macvlan I&#039;m really sad to see that using the newest trunk didn&#039;t help. <br/>I could maybe downgrade back to CC and compile it myself with the proposed changes in the troubleticket <img src="https://forum.openwrt.org/img/smilies/hmm.png" width="15" height="15" alt="hmm"/></p>											<p class="post-edited">(Last edited by <strong>Philipp11</strong> on 9 Oct 2015, 22:43)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p295506">
				<div class="post-metadata">
					<div class="post-num">Post #1403</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						9 Oct 2015, 22:39					</div>
				</div>
				<div class="post-content content">
					<p>Hmmm, have to look into this. Probably some things have changed in current trunk.</p><p>Maybe you could start over and use the Stable (Chaos Calmer) version in the mean time?</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 9 Oct 2015, 22:40)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p295507">
				<div class="post-metadata">
					<div class="post-num">Post #1404</div>
					<div class="post-author">Philipp11</div>
					<div class="post-datetime">
						9 Oct 2015, 22:48					</div>
				</div>
				<div class="post-content content">
					<p>Yep, going to do that.<br/>The stable version doesn&#039;t have the proposed fix from <a href="https://dev.openwrt.org/ticket/20556">https://dev.openwrt.org/ticket/20556</a> though.<br/>r46767 is the stable version, it apparently broke with r46436 and got fixed with r47042.<br/>Should i be looking into making my own build with the proposed changes or does it rather look like a different problem now that exactly the same problem persists in the most recent trunk?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p295508">
				<div class="post-metadata">
					<div class="post-num">Post #1405</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						9 Oct 2015, 22:53					</div>
				</div>
				<div class="post-content content">
					<p>Hard to tell, what i would suggest is revert the 303 patch and test some more with macvlans before installing mwan3. It is probably going to take you quite some time..</p><p>Maybe start bug ticket yourself?</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 9 Oct 2015, 22:55)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p295513">
				<div class="post-metadata">
					<div class="post-num">Post #1406</div>
					<div class="post-author">Philipp11</div>
					<div class="post-datetime">
						9 Oct 2015, 23:29					</div>
				</div>
				<div class="post-content content">
					<p>Yep<br/>Thanks for&nbsp; accompanying me up to this point and pointing me towards the right direction, there are several paths to explore now and I&#039;ll carefully scan through every single one of them and stop spaming your thread on the way <img src="https://forum.openwrt.org/img/smilies/tongue.png" width="15" height="15" alt="tongue"/>.<br/>Once i&nbsp; have a stable setup surrounding macvlan running or an answered bugticket and maybe even a solution i will definitely&nbsp; report back <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p><p>kudos to you!</p>											<p class="post-edited">(Last edited by <strong>Philipp11</strong> on 10 Oct 2015, 01:55)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p295536">
				<div class="post-metadata">
					<div class="post-num">Post #1407</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						10 Oct 2015, 05:33					</div>
				</div>
				<div class="post-content content">
					<p>I will be loading the new trunk this weekend to find out why the interfaces show as offline. I will upload to github soon.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p295552">
				<div class="post-metadata">
					<div class="post-num">Post #1408</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						10 Oct 2015, 15:39					</div>
				</div>
				<div class="post-content content">
					<p>I am getting the same thing with mwan3 on Barrier Breaker<br/>It is leaking processes and consuming CPU usage.<br/>Please fix this ASAP<br/>The following is the list of processes it is leaking 11% is the CPU usage</p><p>4136&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /usr/sbin/ip -4 rule list&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11%&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1%&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>4137&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; awk $1 == &quot;2254:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11%&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1%</p>											<p class="post-edited">(Last edited by <strong>alphasparc</strong> on 10 Oct 2015, 15:42)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p295727">
				<div class="post-metadata">
					<div class="post-num">Post #1409</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						12 Oct 2015, 08:35					</div>
				</div>
				<div class="post-content content">
					<p>I looked at mwan3-luci today and I now know which part of the Lua scripting is not working on trunk but I have no idea how to fix it.</p><p><a href="https://forum.openwrt.org/viewtopic.php?id=60262">https://forum.openwrt.org/viewtopic.php?id=60262</a></p>											<p class="post-edited">(Last edited by <strong>arfett</strong> on 12 Oct 2015, 08:35)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p295927">
				<div class="post-metadata">
					<div class="post-num">Post #1410</div>
					<div class="post-author">axishero</div>
					<div class="post-datetime">
						13 Oct 2015, 18:28					</div>
				</div>
				<div class="post-content content">
					<p>Very high cpu usage.Now I combine 2*15mbps VDSL with mwan3 lastest version on ASUS N16. Surfing webs is very laggy when downloading.<br/><span class="postimg"><img src="http://i11.tietuku.com/703799e9936a6e2f.png" alt="http://i11.tietuku.com/703799e9936a6e2f.png"/></span></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p296032">
				<div class="post-metadata">
					<div class="post-num">Post #1411</div>
					<div class="post-author">inquba</div>
					<div class="post-datetime">
						14 Oct 2015, 19:44					</div>
				</div>
				<div class="post-content content">
					<p>Hi adze I put this in the forum <a href="https://forum.openwrt.org/viewtopic.php?pid=296031#p296031">https://forum.openwrt.org/viewtopic.php … 31#p296031</a>&nbsp; &nbsp;thanks</p>											<p class="post-edited">(Last edited by <strong>inquba</strong> on 14 Oct 2015, 19:45)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p296419">
				<div class="post-metadata">
					<div class="post-num">Post #1412</div>
					<div class="post-author">salatiel</div>
					<div class="post-datetime">
						17 Oct 2015, 20:38					</div>
				</div>
				<div class="post-content content">
					<p>Hi guys! Nice to know there is a thread for discuss mwan3 .<br/>Well, i&#039;ve decided to use mwan3 to replace a very old script made by me to use dual wan.<br/>Unfortunatelly i am getting all kinds of problems, and maybe someone can help me. A few of them looks like a bug, so i am gonna describe them</p><p>Environment: CHAOS CALMER (Chaos Calmer, r47004) running on buffalo AG-300H</p><p>Problems:</p><p>#1 The moment the interface which holds the &#039;default gateway&#039; goes down, all local generated traffic stops routing. For example dnsmasq wont be able to resolv the names anymore, so the network appears to off for the users using the dnsmasq server.<br/>How to replicate:</p><p>Lets stop both wan and wan2<br/># idown wan ; ifdown wan2<br/># ip route<br/>192.168.254.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.254.1 <br/># ip rule<br/>0:&nbsp; &nbsp; from all lookup 128 <br/>1:&nbsp; &nbsp; from all lookup local <br/>2253:&nbsp; &nbsp; from all fwmark 0xfd00/0xff00 blackhole<br/>2254:&nbsp; &nbsp; from all fwmark 0xfe00/0xff00 unreachable<br/>32766:&nbsp; &nbsp; from all lookup main <br/>32767:&nbsp; &nbsp; from all lookup default </p><p>now lets enable wan<br/># ifup wan<br/># ip route<br/>default via 187.115.211.13 dev pppoe-wan&nbsp; proto static <br/>187.115.211.13 dev pppoe-wan&nbsp; proto kernel&nbsp; scope link&nbsp; src 177.135.34.67 <br/>192.168.254.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.254.1 <br/># ip rule<br/>0:&nbsp; &nbsp; from all lookup 128 <br/>1:&nbsp; &nbsp; from all lookup local <br/>1001:&nbsp; &nbsp; from all iif pppoe-wan lookup main <br/>2001:&nbsp; &nbsp; from all fwmark 0x100/0xff00 lookup 1 <br/>2253:&nbsp; &nbsp; from all fwmark 0xfd00/0xff00 blackhole<br/>2254:&nbsp; &nbsp; from all fwmark 0xfe00/0xff00 unreachable<br/>32766:&nbsp; &nbsp; from all lookup main <br/>32767:&nbsp; &nbsp; from all lookup default </p><p>We can see that the pppoe-wan default gateway became the default gateway<br/>now lets enable wan2</p><p># ip route<br/>default via 187.60.72.1 dev eth0.2&nbsp; proto static&nbsp; src 187.60.72.136 <br/>187.60.72.0/22 dev eth0.2&nbsp; proto kernel&nbsp; scope link&nbsp; src 187.60.72.136 <br/>187.60.72.1 dev eth0.2&nbsp; proto static&nbsp; scope link&nbsp; src 187.60.72.136 <br/>187.115.211.13 dev pppoe-wan&nbsp; proto kernel&nbsp; scope link&nbsp; src 177.135.34.67 <br/>192.168.254.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.254.1 <br/># ip rule<br/>0:&nbsp; &nbsp; from all lookup 128 <br/>1:&nbsp; &nbsp; from all lookup local <br/>1001:&nbsp; &nbsp; from all iif pppoe-wan lookup main <br/>1002:&nbsp; &nbsp; from all iif eth0.2 lookup main <br/>2001:&nbsp; &nbsp; from all fwmark 0x100/0xff00 lookup 1 <br/>2002:&nbsp; &nbsp; from all fwmark 0x200/0xff00 lookup 2 <br/>2253:&nbsp; &nbsp; from all fwmark 0xfd00/0xff00 blackhole<br/>2254:&nbsp; &nbsp; from all fwmark 0xfe00/0xff00 unreachable<br/>32766:&nbsp; &nbsp; from all lookup main <br/>32767:&nbsp; &nbsp; from all lookup default </p><p>Now the default gateway became the gateway from eth0.2 interface. No problem, since all the routing is done<br/>by the mark thing.<br/>The problems start if i disable wan2 interface, which holds the current default gateway.</p><p># ifdown wan2<br/># ip route<br/>187.115.211.13 dev pppoe-wan&nbsp; proto kernel&nbsp; scope link&nbsp; src 177.135.34.67 <br/>192.168.254.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.254.1 <br/># ip rule<br/>0:&nbsp; &nbsp; from all lookup 128 <br/>1:&nbsp; &nbsp; from all lookup local <br/>1001:&nbsp; &nbsp; from all iif pppoe-wan lookup main <br/>2001:&nbsp; &nbsp; from all fwmark 0x100/0xff00 lookup 1 <br/>2253:&nbsp; &nbsp; from all fwmark 0xfd00/0xff00 blackhole<br/>2254:&nbsp; &nbsp; from all fwmark 0xfe00/0xff00 unreachable<br/>32766:&nbsp; &nbsp; from all lookup main <br/>32767:&nbsp; &nbsp; from all lookup default </p><br/><p>Now linux does not have a &#039;global&#039; default gateway, so dnsmasq cant resolve names:<br/># ping <a href="http://www.google.com/">www.google.com</a><br/>ping: bad address &#039;<a href="http://www.google.com/">www.google.com</a>&#039;</p><p>if i add a dummy default gateway (any ip from my network even one not used) it will work again</p><p># ip route add default via&nbsp; 192.168.254.111 (ip not in use)<br/># ping <a href="http://www.google.com/">www.google.com</a> -c1 -w2<br/>PING <a href="http://www.google.com/">www.google.com</a> (177.43.170.110): 56 data bytes<br/>64 bytes from 177.43.170.110: seq=0 ttl=60 time=8.351 ms</p><p>This shows that linux requires ANY default gateway in main table to work</p><p>I was able to fix this problem using this patch: i created.<br/>It fixes two problems:<br/>1) when the interface goes down and the current gw is lost, it will set the default gw for the first default gw it founds in any other table<br/>2) It will stop complaining (a few times) with &quot;Could not find gateway for interface...&quot;</p><div class="codebox"><pre><code>--- 15-mwan3
+++ 15-mwan3.new
@@ -1,5 +1,11 @@
 #!/bin/sh
 
+
+source  /usr/share/libubox/jshn.sh
+source /lib/functions/network.sh
+
+
+
 mwan3_get_iface_id()
 {
     let iface_count++
@@ -363,16 +369,11 @@
     if [ $ACTION == &quot;ifup&quot; ]; then
         [ &quot;$enabled&quot; -eq 1 ] || return 0
 
-        while [ -z &quot;$($IP route list dev $DEVICE default | head -1)&quot; -a &quot;$counter&quot; -lt 10 ]; do
-            sleep 1
-            let counter++
-            if [ &quot;$counter&quot; -ge 10 ]; then
-                $LOG warn &quot;Could not find gateway for interface $INTERFACE ($DEVICE)&quot; &amp;&amp; return 0
-            fi
-        done
+        json_load &quot;$(ifstatus $INTERFACE)&quot;
+        network_get_gateway IFGW $INTERFACE
 
-        route_args=$($IP route list dev $DEVICE default | head -1 | sed &#039;/.*via \([^ ]*\) .*$/!d;s//via \1/;q&#039; | egrep &#039;[0-9]{1,3}(\.[0-9]{1,3}){3}&#039;)
-        route_args=&quot;$route_args dev $DEVICE&quot;
+        $LOG info gateway for interface $INTERFACE \(${DEVICE:-unknown}\) is $IFGW
+        route_args=&quot;via $IFGW dev $DEVICE&quot;
     fi
 
     while [ &quot;$(pgrep -f -o hotplug-call)&quot; -ne $$ -a &quot;$counter&quot; -lt 60 ]; do
@@ -391,7 +392,14 @@
     mwan3_set_iface_route
     mwan3_set_iface_rules
 
-    [ $ACTION == &quot;ifdown&quot; ] &amp;&amp; mwan3_set_iface_ipset
+    if [ $ACTION == &quot;ifdown&quot; ] ; then
+        mwan3_set_iface_ipset
+        if [ $(ip route | grep -c &#039;^default via&#039;) == 0 ] ; then # NO DEFAULT GATEWAY FOR LOCAL TRAFFIC
+            NEW_GW=$(ip route show table all | grep &#039;^default via&#039; | head -1 | cut -d &#039; &#039; -f 3)
+            [ -n &quot;$NEW_GW&quot; ] &amp;&amp; ip route add default via $NEW_GW || $LOG err No default gateway available
+        fi
+
+    fi
     [ $ACTION == &quot;ifup&quot; ] &amp;&amp; mwan3_track
 
     config_foreach mwan3_set_policies_iptables policy</code></pre></div><br/><p>#2 This is not exactly a bug, but maybe a feature request<br/># Local generated traffic should honor the interface it is bound to.</p><p>How to replicate:<br/>Lets stop both wan and wan2 interfaces, and test each one separately using the speedtest console client bind the source address to the right interface, just to become clear whats happening.<br/># ifdown wan<br/># ifdown wan2<br/># ifup wan<br/># speedtest_cli --server 5135&nbsp; --source $(getip pppoe-wan)<br/>Running speedtest.net console client<br/>Retrieving speedtest.net configuration...<br/>Retrieving speedtest.net server list...<br/>Testing from Global Village Telecom (177.135.36.245)...<br/>Testing download speed........................................<br/>Download: 48.05 Mbits/s<br/>Testing upload speed..................................................<br/>Upload: 5320.10 Kbits/s</p><br/><p># ifdown wan<br/># ifup wan2</p><p># speedtest_cli --server 5135&nbsp; --source $(getip eth0.2)<br/>Running speedtest.net console client<br/>Retrieving speedtest.net configuration...<br/>Retrieving speedtest.net server list...<br/>Testing from Cabo Servicos De Telecomunicacoes Ltda (187.60.72.136)...<br/>Testing download speed........................................<br/>Download: 5.92 Mbits/s<br/>Testing upload speed..................................................<br/>Upload: 402.48 Kbits/s</p><p>The results are as expected, my main link is 50Mbit/5Mbit band the backup link 6Mbit/512kbit</p><p># ifup wan (both interfaces are now up)</p><p># speedtest_cli --server 5135&nbsp; --source $(getip pppoe-wan)<br/>Running speedtest.net console client<br/>Retrieving speedtest.net configuration...<br/>Retrieving speedtest.net server list...<br/>Testing from Cabo Servicos De Telecomunicacoes Ltda (187.60.72.136)... -&gt; I asked to bound to main link (getip pppoe-wan), it appears to have bound to the backup IP<br/>Testing download speed........................................<br/>Download: 21.09 Mbits/s<br/>Testing upload speed..................................................<br/>Upload: 504.31 Kbits/s<br/>Very strange speeds.</p><br/><p>I think that behaviour for local generated traffic is causing the next bug<br/># Interface not holding the default gateway changes to offline after a while.<br/>After a while , the backup interface not holding the default gw just stop answering pings, and<br/>it is put in offline state.&nbsp; ()<br/># ip route<br/>default via 187.115.211.13 dev pppoe-wan&nbsp; proto static <br/># ping -I pppoe-wan 8.8.8.8 -c1<br/>PING 8.8.8.8 (8.8.8.8): 56 data bytes<br/>64 bytes from 8.8.8.8: seq=0 ttl=53 time=53.102 ms</p><p>--- 8.8.8.8 ping statistics ---<br/>1 packets transmitted, 1 packets received, 0% packet loss<br/>round-trip min/avg/max = 53.102/53.102/53.102 ms</p><p>#&nbsp; ping -I eth0.2 8.8.8.8 -w 2 -c1<br/>PING 8.8.8.8 (8.8.8.8): 56 data bytes</p><p>--- 8.8.8.8 ping statistics ---<br/>2 packets transmitted, 0 packets received, 100% packet loss</p><p>I known that the interface is up, answering the ping for its gateway<br/># ping -I eth0.2 187.60.72.1&nbsp; -w 2 -c1<br/>PING 187.60.72.1 (187.60.72.1): 56 data bytes<br/>64 bytes from 187.60.72.1: seq=0 ttl=255 time=9.696 ms</p><p>--- 187.60.72.1 ping statistics ---<br/>1 packets transmitted, 1 packets received, 0% packet loss<br/>round-trip min/avg/max = 9.696/9.696/9.696 ms</p><p>If i add the following rules the interface will work correctly:</p><p>ip rule add pref 501 oif pppoe-wan lookup 1<br/>ip rule add pref 502 oif eth0.2 lookup 2</p><br/><p># ip rule<br/>0:&nbsp; &nbsp; from all lookup 128 <br/>1:&nbsp; &nbsp; from all lookup local <br/>501:&nbsp; &nbsp; from all oif pppoe-wan lookup 1 <br/>502:&nbsp; &nbsp; from all oif eth0.2 lookup 2 <br/>1001:&nbsp; &nbsp; from all iif pppoe-wan lookup main <br/>1002:&nbsp; &nbsp; from all iif eth0.2 lookup main <br/>2001:&nbsp; &nbsp; from all fwmark 0x100/0xff00 lookup 1 <br/>2002:&nbsp; &nbsp; from all fwmark 0x200/0xff00 lookup 2 <br/>2253:&nbsp; &nbsp; from all fwmark 0xfd00/0xff00 blackhole<br/>2254:&nbsp; &nbsp; from all fwmark 0xfe00/0xff00 unreachable<br/>32766:&nbsp; &nbsp; from all lookup main <br/>32767:&nbsp; &nbsp; from all lookup default </p><p># ping -I eth0.2 8.8.8.8 -w 2 -c1<br/>PING 8.8.8.8 (8.8.8.8): 56 data bytes<br/>64 bytes from 8.8.8.8: seq=0 ttl=54 time=55.013 ms</p><p>--- 8.8.8.8 ping statistics ---<br/>1 packets transmitted, 1 packets received, 0% packet loss<br/>round-trip min/avg/max = 55.013/55.013/55.013 ms</p><p># ping -I pppoe-wan 8.8.8.8 -w 2 -c1<br/>PING 8.8.8.8 (8.8.8.8): 56 data bytes<br/>64 bytes from 8.8.8.8: seq=0 ttl=53 time=53.251 ms</p><p>--- 8.8.8.8 ping statistics ---<br/>1 packets transmitted, 1 packets received, 0% packet loss<br/>round-trip min/avg/max = 53.251/53.251/53.251 ms</p><br/><p>I dont have luci interface installed, all the configuration was done by editing config files.</p><p>Hope someone can help!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p296476">
				<div class="post-metadata">
					<div class="post-num">Post #1413</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						18 Oct 2015, 12:15					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>salatiel wrote:</cite><blockquote><p>i am getting all kinds of problems, and maybe someone can help me. A few of them looks like a bug, so i am gonna describe them</p><p>Problems:</p><p>#1 The moment the interface which holds the &#039;default gateway&#039; goes down, all local generated traffic stops routing. For example dnsmasq wont be able to resolv the names anymore, so the network appears to off for the users using the dnsmasq server.</p><p>This shows that linux requires ANY default gateway in main table to work</p><p>I was able to fix this problem using this patch: i created.<br/>It fixes two problems:<br/>1) when the interface goes down and the current gw is lost, it will set the default gw for the first default gw it founds in any other table<br/>2) It will stop complaining (a few times) with &quot;Could not find gateway for interface...&quot;</p></blockquote></div><p>Hi salatiel,</p><p>If you configure metrics (as described in the wiki) on all your wan interfaces, you would not have run into above problem. If you don&#039;t set metrics, new gateway settings will overwrite old gateway settings and routing information get lost. Please add metrics and try again.</p><br/><div class="quotebox"><cite>salatiel wrote:</cite><blockquote><p>#2 This is not exactly a bug, but maybe a feature request<br/># Local generated traffic should honor the interface it is bound to.</p></blockquote></div><p>It is already available to you in mwan3. You only need to create a mwan3 rule per wan interface. See wiki for more info.</p><p>Edit: all the extra&#039;s you configured yourself are totally unneeded. This is probably that you know a lot about linux routing and not so much about mwan3 (yet). Then when you face some routing hurdles with mwan3, you like to fix them with scripting. My advice is to read wiki once again, cause the issues you describe are very general, much seen issues.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 18 Oct 2015, 12:20)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p296487">
				<div class="post-metadata">
					<div class="post-num">Post #1414</div>
					<div class="post-author">salatiel</div>
					<div class="post-datetime">
						18 Oct 2015, 14:58					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adze, thanks for your reply. The metric thing did the trick. I&#039;ve read the wiki (<a href="http://wiki.openwrt.org/doc/howto/mwan3">http://wiki.openwrt.org/doc/howto/mwan3</a>) a few times and i am starting to understand. But could you please elaborate more the part that you say:</p><div class="quotebox"><blockquote><p># Local generated traffic should honor the interface it is bound to.<br/>It is already available to you in mwan3. You only need to create a mwan3 rule per wan interface. See wiki for more info.</p></blockquote></div><div class="codebox"><pre><code>config rule &#039;Mailserver_uses_wan3_only&#039;
        option src_ip &#039;172.16.1.20&#039;
        option proto &#039;all&#039;
        option use_policy &#039;wan3_only&#039;</code></pre></div><p>I think you refer to this snippet above, but how can i make it work with dhcp ?<br/>Both WANs i use have dynamic ip.</p><p>btw, i forgot to ask, can i have&nbsp; multiple &quot;option src_ip&quot; in some rule or i have to create several small rules ?</p>											<p class="post-edited">(Last edited by <strong>salatiel</strong> on 18 Oct 2015, 15:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p296604">
				<div class="post-metadata">
					<div class="post-num">Post #1415</div>
					<div class="post-author">JohnV</div>
					<div class="post-datetime">
						19 Oct 2015, 17:12					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>I just upgraded our custom OpenWRT build to use CC and the latest set of packages.</p><p>I am seeing a &quot;new&quot; behaviour, but perhaps it is normal for CC.&nbsp; I am posting here as it seems to directly impact and effect MWAN3.</p><p>We use a 4G radio with the ncm protocol scripts.&nbsp; We have customized these scripts quite a bit.&nbsp; The second WAN is a wired connection to the router.&nbsp; The MWAN config is quite simple.&nbsp; Only one WAN is active at a time.</p><p>When the ncm interface comes up, we seem to be getting a second routing table created &quot;2&quot; with the default route.&nbsp; When we were using BB and older packages, this did not happen.&nbsp; Not sure why it&#039;s happening, or if it is a problem but don&#039;t understand why all of a sudden a second routing table is being created, when I don&#039;t think we need it.</p><p>Here is the table before the NCM device is brought up:</p><div class="codebox"><pre><code>#ip route show table main
10.10.10.0/24 dev br-lan  proto kernel  scope link  src 10.10.10.1 
10.10.30.0/24 dev wlan0-1  proto kernel  scope link  src 10.10.30.1

# ip route show table 2</code></pre></div><p>After the ncm interface is brought up:</p><div class="codebox"><pre><code># ip route show table main
default via 10.13.101.50 dev wwan0  proto static  metric 10 
10.10.10.0/24 dev br-lan  proto kernel  scope link  src 10.10.10.1 
10.10.30.0/24 dev wlan0-1  proto kernel  scope link  src 10.10.30.1 
10.13.101.50 dev wwan0  proto static  scope link  metric 10 

# ip route show table 2
default via 10.13.101.50 dev wwan0 </code></pre></div><p>Now, in this state, MWAN status page shows as it should and seems to be working.</p><p>As a test, I &quot;flushed&quot; routing table 2.&nbsp; When I do this, MWAN shows an error on the status page which leads me to think this table has something to do with MWAN??</p><p>Any point in the right direction would be great!</p><p>Edit:&nbsp; To clarify one thing.&nbsp; I first noticed this extra routing table because of Luci and the Routes page.&nbsp; Perhaps it was a change in Luci that now displays these extra tables even though they have been there in BB also.....?</p>											<p class="post-edited">(Last edited by <strong>JohnV</strong> on 19 Oct 2015, 17:22)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p296684">
				<div class="post-metadata">
					<div class="post-num">Post #1416</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						20 Oct 2015, 03:20					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>JohnV wrote:</cite><blockquote><p>Hi,<br/>I am seeing a &quot;new&quot; behaviour, but perhaps it is normal for CC.&nbsp; I am posting here as it seems to directly impact and effect MWAN3.</p></blockquote></div><p>Current versions of mwan3 create a routing table for each interface in the same order as the config (I think the mwan3 config.)</p><p>Table 1 for the first interface, table 2 for the second interface, etc. These tables are populated and flushed by the hotplug scripts on ifup/ifdown events.</p>											<p class="post-edited">(Last edited by <strong>arfett</strong> on 20 Oct 2015, 03:22)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p296766">
				<div class="post-metadata">
					<div class="post-num">Post #1417</div>
					<div class="post-author">JohnV</div>
					<div class="post-datetime">
						20 Oct 2015, 17:48					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for the clarification on the routing tables.</p><p>I have one additional issue/question with my migration to CC.</p><p>I have a Luci page that changes a mwan3 rule based on a UI selection.&nbsp; With BB, when this change was saved, the rule was updated, interfaces went down/up, mwan3 seemed to restart, and everything was A-OK.&nbsp; Data followed the rules updated in mwan3.</p><p>With CC, when the same Luci code is applied, the rule is updated, but when I look at the Detailed Status there is no traffic displayed on either rule, and the rules are not being enforced as all traffic seems to go out wan even if wan2 is specified in the rule.&nbsp; If I reboot the router, when it comes up, everything is working OK.</p><p>Here is the code I use to change the rule, nothing special:</p><div class="codebox"><pre><code>    if value == &quot;wifi&quot; then
        m.uci:set(&quot;mwan3&quot;, &quot;guest_rule&quot;, &quot;use_policy&quot;, &quot;wan_only&quot;)
    else
        m.uci:set(&quot;mwan3&quot;, &quot;guest_rule&quot;, &quot;use_policy&quot;, &quot;wan2_wan&quot;)
    end
    
    m.uci:save(&quot;mwan3&quot;)</code></pre></div><p>Here is the status from MWAN that shows no data flowing:</p><div class="codebox"><pre><code>Active rules:
    0     0 - wan2_wan  all  --  *      *       10.10.30.0/24        0.0.0.0/0            
    0     0 - wan2_wan  all  --  *      *       0.0.0.0/0            0.0.0.0/0</code></pre></div><p>After reboot, as I wrote, it works fine and traffic flows as it should and the stats on the Detailed Status page update normally.</p><br/><p>It would appear that something needs to get flushed or restarted manually to get everything working again after the rule change from my Luci page.....&nbsp; Any ideas on what it might be?</p><p>If I can provide additional config to help diagnose just let me know.&nbsp; And thank you!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p296773">
				<div class="post-metadata">
					<div class="post-num">Post #1418</div>
					<div class="post-author">JohnV</div>
					<div class="post-datetime">
						20 Oct 2015, 19:21					</div>
				</div>
				<div class="post-content content">
					<p>I have been doing some more testing, and the results are inconsistent.&nbsp; Sometimes when I make the rule change mwan3 comes back OK and everything works as it should.&nbsp; More often then not however, mwan3 comes back in an odd state.</p><p>The &quot;error&quot; results are not consistent however.&nbsp; One time after changing the rule, the detailed status showed no Known Networks even through the routing tables all looked OK.&nbsp; Neither wan nor wan2 were working however.</p><div class="codebox"><pre><code>Interface status:
 interface wan is online
 interface wan2 is online

Policy wan2_only:
 wan2 (100%)

Policy wan2_wan:
 wan2 (100%)

Policy wan_only:
 wan (100%)

Policy wan_wan2:
 wan (100%)

Known networks:

Active rules:
  153  9652 - wan_only  all  --  *      *       10.10.30.0/24        0.0.0.0/0            
  418 24363 - wan2_wan  all  --  *      *       0.0.0.0/0            0.0.0.0/0</code></pre></div>											<p class="post-edited">(Last edited by <strong>JohnV</strong> on 21 Oct 2015, 01:02)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p296928">
				<div class="post-metadata">
					<div class="post-num">Post #1419</div>
					<div class="post-author">JohnV</div>
					<div class="post-datetime">
						21 Oct 2015, 20:56					</div>
				</div>
				<div class="post-content content">
					<p>I sorted the issue by adding a &quot;sleep 1&quot; in the mwan restart function in /usr/sbin/mwan3.</p><p>This seems to be working.</p><p>Must be some conflict when a bunch of UCI changes are made at once and the interfaces are all coming back up.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297224">
				<div class="post-metadata">
					<div class="post-num">Post #1420</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						24 Oct 2015, 01:20					</div>
				</div>
				<div class="post-content content">
					<p>Update to fix mwan3-luci on trunk:</p><p><a href="https://github.com/openwrt/packages/pull/1888">https://github.com/openwrt/packages/pull/1888</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297257">
				<div class="post-metadata">
					<div class="post-num">Post #1421</div>
					<div class="post-author">salatiel</div>
					<div class="post-datetime">
						24 Oct 2015, 12:48					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>salatiel wrote:</cite><blockquote><p>Hi Adze, thanks for your reply. The metric thing did the trick. I&#039;ve read the wiki (<a href="http://wiki.openwrt.org/doc/howto/mwan3">http://wiki.openwrt.org/doc/howto/mwan3</a>) a few times and i am starting to understand. But could you please elaborate more the part that you say:</p><div class="quotebox"><blockquote><p># Local generated traffic should honor the interface it is bound to.<br/>It is already available to you in mwan3. You only need to create a mwan3 rule per wan interface. See wiki for more info.</p></blockquote></div><div class="codebox"><pre><code>config rule &#039;Mailserver_uses_wan3_only&#039;
        option src_ip &#039;172.16.1.20&#039;
        option proto &#039;all&#039;
        option use_policy &#039;wan3_only&#039;</code></pre></div><p>I think you refer to this snippet above, but how can i make it work with dhcp ?<br/>Both WANs i use have dynamic ip.</p><p>btw, i forgot to ask, can i have&nbsp; multiple &quot;option src_ip&quot; in some rule or i have to create several small rules ?</p></blockquote></div><p>Hello, ideas on the dhcp thing?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297294">
				<div class="post-metadata">
					<div class="post-num">Post #1422</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						24 Oct 2015, 20:52					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>salatiel wrote:</cite><blockquote><p>Hello, ideas on the dhcp thing?</p></blockquote></div><p>What is the issue you&#039;re having with DHCP? DHCP is handled by OpenWrt and goes out a particular interface and comes back to it. You don&#039;t need any mwan3 rules for your WAN interface DHCP.</p>											<p class="post-edited">(Last edited by <strong>arfett</strong> on 24 Oct 2015, 20:53)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297296">
				<div class="post-metadata">
					<div class="post-num">Post #1423</div>
					<div class="post-author">salatiel</div>
					<div class="post-datetime">
						24 Oct 2015, 21:00					</div>
				</div>
				<div class="post-content content">
					<p>Hi arfett, since i quote just part of the text i think you misunderstood me.<br/>I was having problems with local traffic bound to a specific interface still being balanced, so Adze told me i should create a rule with source ip being my wan ip address. It works great this way, but since my wan ip is dynamic, i have to change the rule all the time. Maybe there was a way to do it.<br/>Anyway, i have created a little patch to allow option src_ip &#039;wan&#039; and option src_ip &#039;wan2&#039; and it resolves the current ip address on the hotplug event.</p><p>I will post here , maybe someone finds useful.</p><div class="codebox"><pre><code>--- 15-mwan3
+++ 15-mwan3.new
@@ -1,5 +1,7 @@
 #!/bin/sh
 
+. /lib/functions/network.sh
+
 mwan3_get_iface_id()
 {
     let iface_count++
@@ -293,6 +295,14 @@
     config_get use_policy $1 use_policy
 
     rule=&quot;$1&quot;
+
+    if  ! echo &quot;$src_ip&quot; | grep -E &quot;[0-9]{1,3}(\.[0-9]{1,3}){3}&quot; &amp;&gt;/dev/null ; then
+        iface=$src_ip
+        network_get_ipaddr src_ip $src_ip
+        [ -n &quot;$src_ip&quot; ] || return 0
+        $LOG info Using \&#039;$src_ip\&#039; from $iface as source ip for rule $rule.
+    fi
+
 
     if [ &quot;$rule&quot; != $(echo &quot;$rule&quot; | cut -c1-15) ]; then
         $LOG warn &quot;Rule $rule exceeds max of 15 chars. Not setting rule&quot; &amp;&amp; return 0</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p298230">
				<div class="post-metadata">
					<div class="post-num">Post #1424</div>
					<div class="post-author">trumee</div>
					<div class="post-datetime">
						1 Nov 2015, 17:29					</div>
				</div>
				<div class="post-content content">
					<p>I have a Netgear WNDR 3700 connected to an ADSL modem and a 3g usb stick. I would like to failover from ADSL to 3G when the former goes down. The openwrt version is&nbsp; CHAOS CALMER (15.05, r46767)</p><p>I get the following error on starting mwan3. Also, when the ADSL cable is pulled out and re-inserted the ADSL connection doesnt come back on. Any idea what could be wrong?</p><div class="codebox"><pre><code>#mwan3 start
uci: Entry not found
uci: Entry not found
uci: Entry not found
uci: Entry not found</code></pre></div><p>My network<br/></p><div class="codebox"><pre><code>#/etc/config/network
config interface &#039;wan&#039;
        option ifname &#039;eth1&#039;
        option _orig_ifname &#039;eth1&#039;
        option _orig_bridge &#039;false&#039;
        option proto &#039;pppoe&#039;
        option username &#039;username&#039;
        option password &#039;password&#039;
        option metric &#039;10&#039;
        option peerdns &#039;0&#039;
        option dns &#039;8.8.8.8 218.248.255.204&#039;

config interface &#039;wan2&#039;
        option proto &#039;3g&#039;
        option device &#039;/dev/ttyUSB0&#039;
        option apn &#039;www&#039;
        option dialnumber &#039;*99#&#039;
        option service &#039;umts&#039;
        option metric &#039;20&#039;</code></pre></div><p>Routes<br/></p><div class="codebox"><pre><code># route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         113.192.16.1    0.0.0.0         UG    10     0        0 pppoe-wan
0.0.0.0         11.65.64.65     0.0.0.0         UG    20     0        0 3g-wan2
11.65.64.65     0.0.0.0         255.255.255.255 UH    0      0        0 3g-wan2
113.192.16.1    0.0.0.0         255.255.255.255 UH    0      0        0 pppoe-wan
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan</code></pre></div><p>mwan<br/></p><div class="codebox"><pre><code>#/etc/config/mwan3
config interface &#039;wan&#039;
        option enabled &#039;1&#039;
        list track_ip &#039;8.8.4.4&#039;
        list track_ip &#039;8.8.8.8&#039;
        list track_ip &#039;208.67.222.222&#039;
        list track_ip &#039;208.67.220.220&#039;
        option reliability &#039;2&#039;
        option count &#039;1&#039;
        option timeout &#039;2&#039;
        option interval &#039;5&#039;
        option down &#039;3&#039;
        option up &#039;8&#039;

config interface &#039;wan2&#039;
        option enabled &#039;1&#039;
        list track_ip &#039;8.8.8.8&#039;
        list track_ip &#039;208.67.220.220&#039;
        option reliability &#039;1&#039;
        option count &#039;1&#039;
        option timeout &#039;2&#039;
        option interval &#039;5&#039;
        option down &#039;3&#039;
        option up &#039;8&#039;

config member &#039;wan_m1_w3&#039;
        option interface &#039;wan&#039;
        option metric &#039;1&#039;
        option weight &#039;3&#039;

config member &#039;wan_m2_w3&#039;
        option interface &#039;wan&#039;
        option metric &#039;2&#039;
        option weight &#039;3&#039;

config member &#039;wan2_m1_w2&#039;
        option interface &#039;wan2&#039;
        option metric &#039;1&#039;
        option weight &#039;2&#039;

config member &#039;wan2_m2_w2&#039;
        option interface &#039;wan2&#039;
        option metric &#039;2&#039;
        option weight &#039;2&#039;

config policy &#039;wan_only&#039;
        list use_member &#039;wan_m1_w3&#039;

config policy &#039;wan2_only&#039;
        list use_member &#039;wan2_m1_w2&#039;

config policy &#039;balanced&#039;
        list use_member &#039;wan_m1_w3&#039;
        list use_member &#039;wan2_m1_w2&#039;

config policy &#039;wan_wan2&#039;
        list use_member &#039;wan_m1_w3&#039;
        list use_member &#039;wan2_m2_w2&#039;

config policy &#039;wan2_wan&#039;
        list use_member &#039;wan_m2_w3&#039;
        list use_member &#039;wan2_m1_w2&#039;


config rule &#039;default_rule&#039;
        option dest_ip &#039;0.0.0.0/0&#039;
        option use_policy &#039;wan_wan2&#039;</code></pre></div><p>mwan3 status<br/></p><div class="codebox"><pre><code># mwan3 status
Interface status:
 interface wan is online (tracking active)
 interface wan2 is online (tracking active)

Policy balanced:
 wan2 (40%)
 wan (60%)

Policy wan2_only:
 wan2 (100%)

Policy wan2_wan:
 wan2 (100%)

Policy wan_only:
 wan (100%)

Policy wan_wan2:
 wan (100%)

Known networks:
 127.0.0.0/8
 192.168.1.1
 127.0.0.1
 127.255.255.255
 224.0.0.0/3
 113.192.16.49
 192.168.1.255
 192.168.1.0/24
 127.0.0.0
 11.65.64.65
 192.168.1.0
 105.205.21.4
 113.192.16.1

Active rules:
  291 19862 - wan_wan2  all  --  *      *       0.0.0.0/0            0.0.0.0/0 </code></pre></div>											<p class="post-edited">(Last edited by <strong>trumee</strong> on 1 Nov 2015, 17:29)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p298244">
				<div class="post-metadata">
					<div class="post-num">Post #1425</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						1 Nov 2015, 19:37					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>trumee wrote:</cite><blockquote><p>I get the following error on starting mwan3. Also, when the ADSL cable is pulled out and re-inserted the ADSL connection doesnt come back on. Any idea what could be wrong?</p><div class="codebox"><pre><code>#mwan3 start
uci: Entry not found
uci: Entry not found
uci: Entry not found
uci: Entry not found</code></pre></div></blockquote></div><p>You are using an old version of mwan3 probably.</p>											<p class="post-edited">(Last edited by <strong>arfett</strong> on 1 Nov 2015, 19:37)</p>
									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 57 of 65</div><nav><ul><li><a href="viewtopic.php%3Fid=39052&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=55.html">55</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=56.html">56</a></li><li class="pagination-current"><span>57</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=58.html">58</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=59.html">59</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0.001 -->

</body>
</html>