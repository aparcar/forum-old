<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Client and AP: AP goes down when Client not available</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 20 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p188698">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">warchild</div>
					<div class="post-datetime">
						12 Jan 2013, 19:51					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>I&#039;ve set up my router as a routing client though LuCI with 2 wireless networks, one as client (wwan) and another as ap/master (all in similar way as uqbar did - <a href="https://forum.openwrt.org/viewtopic.php?pid=175185#p175185).">https://forum.openwrt.org/viewtopic.php â€¦ #p175185).</a></p><p>Everything is working fine when the client is available: both my LAN and W-LAN machines can talk to each other and access the internet through WWAN (a mobile hotspot). <strong>But</strong>, when I turn off the mobile hotspot the ap network shuts down. I would like the ap network to remain up so my wireless machines can still access the wired ones (like my NAS). Is this possible?</p><p><span class="bbu">I&#039;m using:</span><br />TP-Link TL-WR841N/ND v8.2<br />OpenWrt Attitude Adjustment 12.09-beta2 / LuCI 0.11 Branch (0.11+svn9402)</p><p>When I turn off the mobile hotspot, the log shows:<br />Jan 12 16:14:29 OpenWrt kern.info kernel: [29825.010000] br-lan: port 2(wlan0) entered disabled state</p><p><span class="bbu">/etc/config/wireless</span><br /></p><div class="codebox"><pre><code>config wifi-device &#039;radio0&#039;
    option type &#039;mac80211&#039;
    option macaddr &#039;a0:f3:c1:35:7f:36&#039;
    option hwmode &#039;11ng&#039;
    list ht_capab &#039;LDPC&#039;
    list ht_capab &#039;SHORT-GI-20&#039;
    list ht_capab &#039;SHORT-GI-40&#039;
    list ht_capab &#039;TX-STBC&#039;
    list ht_capab &#039;RX-STBC1&#039;
    list ht_capab &#039;DSSS_CCK-40&#039;
    option txpower &#039;27&#039;
    option country &#039;US&#039;
    option distance &#039;4&#039;
    option htmode &#039;HT40+&#039;
    option channel &#039;auto&#039;

config wifi-iface
    option network &#039;wwan&#039;
    option ssid &#039;WARLESS&#039;
    option encryption &#039;psk2&#039;
    option device &#039;radio0&#039;
    option mode &#039;sta&#039;
    option bssid &#039;5C:0A:5B:F0:C9:58&#039;
    option key &#039;key&#039;

config wifi-iface
    option device &#039;radio0&#039;
    option mode &#039;ap&#039;
    option ssid &#039;WARLESS-TP&#039;
    option network &#039;lan&#039;
    option encryption &#039;psk-mixed&#039;
    option key &#039;key&#039;</code></pre></div><p><span class="bbu">/etc/config/network</span><br /></p><div class="codebox"><pre><code>config interface &#039;loopback&#039;
    option ifname &#039;lo&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;127.0.0.1&#039;
    option netmask &#039;255.0.0.0&#039;

config interface &#039;lan&#039;
    option ifname &#039;eth1&#039;
    option type &#039;bridge&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;192.168.1.1&#039;
    option netmask &#039;255.255.255.0&#039;

config interface &#039;wan&#039;
    option ifname &#039;eth0&#039;
    option proto &#039;dhcp&#039;

config switch
    option name &#039;switch0&#039;
    option reset &#039;1&#039;
    option enable_vlan &#039;1&#039;

config switch_vlan
    option device &#039;switch0&#039;
    option vlan &#039;1&#039;
    option ports &#039;0 1 2 3 4&#039;

config interface &#039;wwan&#039;
    option proto &#039;dhcp&#039;</code></pre></div><p>Any help would be appreciated, thanks.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p188699">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">nebbia88</div>
					<div class="post-datetime">
						12 Jan 2013, 19:59					</div>
				</div>
				<div class="post-content content">
					<p><a href="https://dev.openwrt.org/ticket/12000">https://dev.openwrt.org/ticket/12000</a><br /><a href="https://dev.openwrt.org/ticket/12018">https://dev.openwrt.org/ticket/12018</a><br /><a href="https://dev.openwrt.org/ticket/12300">https://dev.openwrt.org/ticket/12300</a></p><p>???</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p188701">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">warchild</div>
					<div class="post-datetime">
						12 Jan 2013, 20:08					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>nebbia88 wrote:</cite><blockquote><p><a href="https://dev.openwrt.org/ticket/12000">https://dev.openwrt.org/ticket/12000</a><br /><a href="https://dev.openwrt.org/ticket/12018">https://dev.openwrt.org/ticket/12018</a><br /><a href="https://dev.openwrt.org/ticket/12300">https://dev.openwrt.org/ticket/12300</a></p><p>???</p></blockquote></div><p>Failed to spot those, thank you nebbia88!</p><div class="quotebox"><cite>ticket12000 wrote:</cite><blockquote><p>If wpa_supplicant looses the connection it will go into an active scan cycle which renders the wiphy unusable for ap mode operation, therefore the ap is taken down if the sta looses its association. That is nothing that can be fixed easily and there are no current plans to solve this.</p></blockquote></div><p>Makes sense.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p188711">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">warchild</div>
					<div class="post-datetime">
						12 Jan 2013, 21:51					</div>
				</div>
				<div class="post-content content">
					<p>Found a sort of workaround for this.</p><p>Based on <a href="http://wiki.openwrt.org/doc/howto/hardware.button">http://wiki.openwrt.org/doc/howto/hardware.button</a> I&#039;ve configured the WPS button to enable/disable the client network. When client is disabled ap works as expected. I even use the WPS led to signal which state is on <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>Loving OpenWrt, a big thank you to all developers and community!</p>											<p class="post-edited">(Last edited by <strong>warchild</strong> on 12 Jan 2013, 22:00)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p188722">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">nebbia88</div>
					<div class="post-datetime">
						13 Jan 2013, 00:29					</div>
				</div>
				<div class="post-content content">
					<p>great idea!<br />can you post the details of how you configured button?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p188725">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">warchild</div>
					<div class="post-datetime">
						13 Jan 2013, 00:49					</div>
				</div>
				<div class="post-content content">
					<p>Sure.</p><p>I&#039;ve followed all the steps in <a href="http://wiki.openwrt.org/doc/howto/hardware.button">http://wiki.openwrt.org/doc/howto/hardware.button</a> only changing the handler on system config file, instead of:<br /></p><div class="codebox"><pre><code>uci set system.@button[-1].handler=&#039;logger BTN_1 pressed&#039;</code></pre></div><p>I&#039;ve used:<br /></p><div class="codebox"><pre><code>uci set system.@button[-1].handler=&#039;/sbin/woggle&#039;</code></pre></div><p>My /sbin/woggle is inspired on the one in <a href="http://wiki.openwrt.org/doc/howto/wifitoggle.">http://wiki.openwrt.org/doc/howto/wifitoggle.</a> Only had to change the interface name and led path.</p><div class="codebox"><pre><code>#!/bin/sh

case &quot;$(uci get wireless.@wifi-iface[0].disabled)&quot; in
    1)
        uci set wireless.@wifi-iface[0].disabled=0
        wifi
        echo 0 &gt; /sys/class/leds/tp-link\:green\:qss/brightness
    ;;
    *)
        uci set wireless.@wifi-iface[0].disabled=1
        wifi
        echo 1 &gt; /sys/class/leds/tp-link\:green\:qss/brightness
    ;;
esac</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p221253">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">apollo</div>
					<div class="post-datetime">
						30 Dec 2013, 16:17					</div>
				</div>
				<div class="post-content content">
					<p>Thanks, this works quite well! I&#039;ve used <a href="http://grade2linux.wordpress.com/2013/05/12/tp-link-tl-wr1043nd-openwrt-ch09_buttons/">http://grade2linux.wordpress.com/2013/0 â€¦ 9_buttons/</a> to get the button working. Also changed the behaviour: When the led is on, I can connect to the net and vise versa.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p221314">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">eeff11</div>
					<div class="post-datetime">
						31 Dec 2013, 07:01					</div>
				</div>
				<div class="post-content content">
					<p>Great, enough info.</p><p>Thanks.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p242163">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">alexey_t</div>
					<div class="post-datetime">
						30 Jul 2014, 15:56					</div>
				</div>
				<div class="post-content content">
					<p>Hi</p><p>I have the same problem. Before I find this post I make this video which is describing the problem.</p><p><a href="https://www.youtube.com/watch?v=bXpmvVAo1RY">https://www.youtube.com/watch?v=bXpmvVAo1RY</a></p><p><span class="postimg"><img src="http://cl.ly/image/3h0i2M2F2o2D/problem.jpg" alt="video" /></span></p><br /><p>This is very important for my project to solve this bug. <br />User needs ability to change wifi settings even WIFI spot is not available/broken and ect.</p><p>Developers, please fix it.</p><p>------<br />BARRIER BREAKER (v1.0a, r40512)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p256423">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">sersh</div>
					<div class="post-datetime">
						3 Dec 2014, 16:02					</div>
				</div>
				<div class="post-content content">
					<p>warchild, great workaround!</p><p>Implementing this, I came across <a href="http://wiki.openwrt.org/doc/uci/wifitoggle">wifitoggle</a> package, which is versatile script to toggle Wi-Fi with a button.</p><br /><p>Here is my setup to toggle particular Wi-Fi interface and use QSS led to give feedback about network activity on that interface.</p><br /><p><strong>/etc/config/wifitoggle</strong><br /></p><div class="codebox"><pre><code>config wifitoggle
    option button &#039;wps&#039;
    option persistent &#039;1&#039;
    option timer &#039;0&#039;
    option led_sysfs &#039;tp-link:green:qss&#039;
    option led_enable_trigger &#039;netdev&#039;
    option led_enable_mode &#039;link tx rx&#039;
    option led_enable_dev &#039;wlan0&#039;
    option device &#039;ap-network&#039;
    option wifi_type &#039;iface&#039;</code></pre></div><p><strong>/etc/config/wireless</strong></p><div class="codebox"><pre><code>[..]
config wifi-iface &#039;ap-network&#039;
    option network &#039;wwan&#039;
    option ssid &#039;NETWORK&#039;
    option encryption &#039;psk2&#039;
    option device &#039;radio0&#039;
    option mode &#039;sta&#039;
    option bssid &#039;00:11:22:33:44:55&#039;
    option key &#039;passkey&#039;
    option disabled &#039;0&#039;
[..]</code></pre></div><p>Also I had to apply <a href="http://patchwork.openwrt.org/patch/1855/">this patch</a> on /etc/hotplug.d/button/50-wifitoggle so the script can handle specific wireless interface instead of disabling the whole radio completely.</p><br /><p><strong>UPDATE:</strong></p><p>Here is the patchâ€™s code since the original URL may not work.</p><div class="codebox"><pre><code>--- files/wifitoggle.hotplug.ori        2012-02-11 15:21:42.637259964 +0000
+++ files/wifitoggle.hotplug    2012-02-11 15:25:05.168970488 +0000
@@ -37,7 +37,7 @@

         config_load wireless
-        config_foreach save_wireless wifi-device
+        config_foreach save_wireless wifi-$wifi_type
         wifi
 }

@@ -141,6 +141,7 @@
        config_get_bool led_disable_default $1 led_disable_default &quot;0&quot;
        config_get led_disable_delayon $1 led_disable_delayon
        config_get led_disable_delayoff $1 led_disable_delayoff
+       config_get wifi_type $1 wifi_type &quot;device&quot;

         [ &quot;$ACTION&quot; = &quot;$action&quot; -a &quot;$BUTTON&quot; = &quot;$button&quot; ] &amp;&amp; {

@@ -149,7 +150,7 @@
                if [ &quot;$device&quot; = &quot;all&quot; ]
                then
                        config_load wireless
-                       config_foreach load_wireless wifi-device
+                       config_foreach load_wireless wifi-$wifi_type
                else
                        disabled=&quot;$(uci get wireless.&quot;$device&quot;.disabled)&quot;
                fi</code></pre></div>											<p class="post-edited">(Last edited by <strong>sersh</strong> on 22 Jan 2015, 00:33)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262354">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">openwrt_bizmail</div>
					<div class="post-datetime">
						21 Jan 2015, 22:20					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m trying to solve this problem on a GL.iNet router which only has one button.&nbsp; The normal function of the button is to toggle wifi on an off with a short press.&nbsp; I want to reprogram it to disable the client network.</p><p>I think the that the solutions provided above worked on the older hotplug system, but I&#039;m not sure that they are still the best way to do it with the current procd system.</p><p>Looking at the button actions in /etc/rc.button, it looks like I should be able to modify /etc/rc.button/rfkill to fix this.&nbsp; Here&#039;s the code in that file:</p><div class="codebox"><pre><code>#!/bin/sh

[ &quot;${ACTION}&quot; = &quot;released&quot; -o -n &quot;${TYPE}&quot; ] || exit 0

. /lib/functions.sh

local rfkill_state=0

wifi_rfkill_set() {
    uci set wireless.$1.disabled=$rfkill_state
}

wifi_rfkill_check() {
    local disabled
    config_get disabled $1 disabled
    [ &quot;$disabled&quot; = &quot;1&quot; ] || rfkill_state=1
}

config_load wireless
case &quot;${TYPE}&quot; in
&quot;switch&quot;)
    [ &quot;${ACTION}&quot; = &quot;released&quot; ] &amp;&amp; rfkill_state=1
    ;;
*)
    config_foreach wifi_rfkill_check wifi-device
    ;;
esac
config_foreach wifi_rfkill_set wifi-device
uci commit wireless
wifi up</code></pre></div><p>I get a general idea of what this is doing, but I can&#039;t figure out how to change it to toggle off the client (WAN) interface.&nbsp; Can anybody give me some tips on how to do this?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262369">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">sersh</div>
					<div class="post-datetime">
						22 Jan 2015, 00:43					</div>
				</div>
				<div class="post-content content">
					<p>openwrt_bizmail, have you read the whole thread, in particular my post above yours?</p><p>The tip might be to try to look for &#039;wifi-iface&#039; instead of &#039;wifi-device&#039;.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262373">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">openwrt_bizmail</div>
					<div class="post-datetime">
						22 Jan 2015, 01:07					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>sersh wrote:</cite><blockquote><p>openwrt_bizmail, have you read the whole thread, in particular my post above yours?</p><p>The tip might be to try to look for &#039;wifi-iface&#039; instead of &#039;wifi-device&#039;.</p></blockquote></div><p>I had the idea that your code is designed to toggle a specific pre-configured ssid.&nbsp; I need to be able to toggle off any ssid which happens to be in use as the repeated network.&nbsp; Does that work with your code or am I missing something?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262374">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">sersh</div>
					<div class="post-datetime">
						22 Jan 2015, 01:13					</div>
				</div>
				<div class="post-content content">
					<p>Hmm... My guess, itâ€™s not possible since you need to know interface name to disable, otherwise all of them will be turned off.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262622">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">openwrt_bizmail</div>
					<div class="post-datetime">
						24 Jan 2015, 01:15					</div>
				</div>
				<div class="post-content content">
					<p>I found a good solution for my problem.&nbsp; <strong>Caveat:&nbsp; This solution is specifically for the 1-button GL.iNet router. </strong> You can probably do something similar with a different router, but there might be differences.&nbsp; This is working on OpenWRT Barrier Breaker.</p><p>If you want to use this solution with a different router, you will need to carefully examine the config files in /etc/rc.button to see which one is launched by a particular button, then look downstream to see what file needs to be modified.</p><p>On this router, the button is normally set up to do two different functions: a short press toggles wifi off and on and a long press resets the router back to factory settings.&nbsp; I wanted to change the function for a short press without disabling the ability to reset to factory (in case something goes wrong), so this approach doesn&#039;t change that.</p><p>On this router, a button press calls up this script: &#039;/etc/rc.button/reset&#039;.&nbsp; On a short button press this script launches &#039;/usr/bin/wifionoff&#039;.&nbsp; I modified this file to look like this:</p><div class="codebox"><pre><code>#!/bin/sh
# device=$(uci -q get wireless.@wifi-device[0].disabled)
mode=$(uci -q get wireless.@wifi-iface[1].mode)
if [ &quot;$mode&quot; = &quot;sta&quot; ]; then
        uci delete wireless.@wifi-iface[1]    
        uci commit wireless
        uci set network.wan.ifname=eth0    
        uci commit network
        wifi
fi</code></pre></div><p>This reconfigures two different config files:<br />&#039;/etc/config/wireless&#039; is changed to remove the wan/sta interface<br />&#039;/etc/config/network&#039; is modified to add the wan interface name to the config (this keeps ethernet wan working)</p><p>After making these changes, the &#039;wifi&#039; command puts everything into operation.&nbsp; This approach will remove the connection to any repeated ssid without having to having to specify which one is in use in advance.</p><p>This is a simple solution that should be pretty easy to maintain after firmware updates.&nbsp; Please let me know if you have any questions.</p>											<p class="post-edited">(Last edited by <strong>openwrt_bizmail</strong> on 26 Jan 2015, 14:44)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311295">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">johndoe</div>
					<div class="post-datetime">
						14 Feb 2016, 01:56					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ve had the same issue with the STA network taking down the AP network. Specifically, the Zsun wifi card reader only has a wifi interface, and killing the wifi leaves no option but a reset of the configuration. So I&#039;ve come up with a workaround that I&#039;ve posted to the (closed, wontfix) <a href="https://dev.openwrt.org/ticket/12000#comment:9">bug</a>. Turns out that it is possible to have a working AP network while the defunct STA network is still active. In best &quot;have you tried turning it off and on again&quot; fashion, I run a script that takes down the AP interface and brings it back up whenever it loses its wireless configuration. This causes it to get reconfigured and reappear on the air, without taking down the station interface. I call the script from /etc/rc.local.</p><div class="codebox"><pre><code>/root/wifi-watchdog.sh &amp;</code></pre></div><p>You might want to run it manually and see if it works for you before you make it run automatically. Here&#039;s the /root/wifi-watchdog.sh script. Don&#039;t forget to chmod u+x /root/wifi-watchdog.sh to make it executable. AP_DEV is the interface which is in access point mode.</p><div class="codebox"><pre><code>#!/bin/sh

AP_DEV=wlan0-1

while ( true ) ; do
  if !( iw dev $AP_DEV info | grep -q ssid ) ; then
    logger wifi-watchdog: Wifi in trouble, to the rescue...
    ifconfig $AP_DEV down;
    ifconfig $AP_DEV up;
  fi
  sleep 5
done</code></pre></div><p>It&#039;s a dirty hack, but it works for me. Use at your own risk.</p>											<p class="post-edited">(Last edited by <strong>johndoe</strong> on 14 Feb 2016, 02:13)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311300">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						14 Feb 2016, 03:38					</div>
				</div>
				<div class="post-content content">
					<p>@openwrt_bizmail&nbsp; <br />I believe that the code you have published is that of dwonderful and which I re-posted on the GLI.net forum with reference.&nbsp; Alzhao suggest attaching it to the button.&nbsp; <br /><a href="https://forum.openwrt.org/viewtopic.php?pid=278230#p278230">https://forum.openwrt.org/viewtopic.php â€¦ 30#p278230</a><br /><a href="http://www.gl-inet.com/forums/topic/ar-150-lan-connection-issues/#post-9488">http://www.gl-inet.com/forums/topic/ar- â€¦ #post-9488</a></p><p>In the future please give appropriate credit to the author(s) of the code.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311568">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">openwrt_bizmail</div>
					<div class="post-datetime">
						15 Feb 2016, 21:50					</div>
				</div>
				<div class="post-content content">
					<p>@RangerZ</p><p>Honestly, it&#039;s been a year ago, and I don&#039;t remember where I got the code for that.&nbsp; Looking at your previous post, it looks like I probably did use your code, so I apologize for using it without giving you credit.&nbsp; &nbsp;In any case, having that mod available has been very useful for me.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311639">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">Max Hopper</div>
					<div class="post-datetime">
						16 Feb 2016, 10:18					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>johndoe wrote:</cite><blockquote><p>It&#039;s a dirty hack, but it works for me. Use at your own risk.</p></blockquote></div><p>Indeed, it is just that.</p><p><a href="https://forum.openwrt.org/viewtopic.php?pid=309131#p309131">Elsewhere</a> are <strong>system event-driven</strong> solutions.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311650">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">johndoe</div>
					<div class="post-datetime">
						16 Feb 2016, 12:38					</div>
				</div>
				<div class="post-content content">
					<p>No, Max, it is not <strong>just</strong> a dirty hack. It&#039;s also a very simple script (one script, not a collection of scripts) that doesn&#039;t need a separate &quot;fail safe&quot; configuration. Your workaround requires the user to keep two configurations in sync except for the STA iface. My hack exhibits one other important aspect: It shows that an active but unconnected STA interface and an AP interface can coexist. It is not technically necessary to turn off the STA interface to regain access to the AP interface. The reason why I&#039;m not doing this in a hotplug script and use a watchdog loop instead is that there is no event specific to the AP interface losing its configuration. This &quot;just happens&quot;. It might be possible to tie the test to events on other interfaces, but that&#039;s the &quot;dirty hack&quot; aspect: I stopped when it worked for me. If you want to make it beautiful, be my guest.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311660">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">Max Hopper</div>
					<div class="post-datetime">
						16 Feb 2016, 14:05					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>johndoe wrote:</cite><blockquote><p>It&#039;s also a very simple script (one script, not a collection of scripts) that doesn&#039;t need a separate &quot;fail safe&quot; configuration. Your workaround requires the user to keep two configurations in sync except for the STA iface.</p></blockquote></div><p>The number of scripts is 3 and <strong>the hack</strong> requires 2.&nbsp; All of the scripts are passive meaning as a <strong>system event-driven</strong> solution they consume no resources until such time as recovery is required.&nbsp; As for synchronisation of two configurations, <strong>the script</strong>, as a <strong>blackbox</strong>, <a href="https://www.acronymfinder.com/SMOP.html">SMOP</a> if you will, can be extended to recover wireless connectivity without a pre-existing fail-safe configuration. </p><div class="quotebox"><cite>johndoe wrote:</cite><blockquote><p>My hack exhibits one other important aspect: It shows that an active but unconnected STA interface and an AP interface can coexist. It is not technically necessary to turn off the STA interface to regain access to the AP interface.</p></blockquote></div><p>Really? Here -</p><div class="quotebox"><cite>johndoe wrote:</cite><blockquote><p>So I&#039;ve come up with a workaround that I&#039;ve posted to the (closed, wontfix) <a href="https://dev.openwrt.org/ticket/12000#comment:9">bug</a>.</p></blockquote></div><p>the link indicates knowledge of the interfaces&#039; states. <strong>the hack</strong> in contrast with <strong>the script</strong> makes an assumption as to the name of the physical device, which is a <strong>maintenance</strong> detail, and uses the lower level OpenWrt <em>ifconfig</em> operation.&nbsp; <strong>the script</strong>, on the other hand, employs the system-wide <em>wifi</em> operation, whereby future enhancements in the wireless space by OpenWrt development are not excluded.</p><p>Indeed, you have given fair warning yet no such disclaimer is necessary over <strong>the script</strong>.&nbsp; Not a minor point.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311675">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">johndoe</div>
					<div class="post-datetime">
						16 Feb 2016, 16:05					</div>
				</div>
				<div class="post-content content">
					<p>What is your problem, Max? I&#039;m not trying to steal your show. I&#039;ve posted an alternative way of getting around a problem. I said it&#039;s a hack, but despite its hackishness it shows something interesting, namely that something we were told was impossible is actually possible: A working AP interface with a defunct but enabled STA interface. Now that I know how people around here react when alternatives to their workarounds are posted, I&#039;m kinda glad I didn&#039;t invest the time to flesh out the hack into a clean solution. Have a nice day.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311709">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">Max Hopper</div>
					<div class="post-datetime">
						16 Feb 2016, 19:11					</div>
				</div>
				<div class="post-content content">
					<p>The nub is that trading in innuendo and mistruths is <span style="color: #ff2b0c"><strong>evil</strong></span> with this serving as a prima facie evidence -</p><div class="quotebox"><cite>johndoe wrote:</cite><blockquote><p>...it shows something interesting, namely that something we were told was impossible is actually possible: A working AP interface with a defunct but enabled STA interface.</p></blockquote></div><p>and their purveyors also.&nbsp; Nowhere has it been stated that an <strong>configured</strong> section - wifi-iface of type <strong>ap</strong> <em>cannot</em> accept associations when a section - wifi-iface of type <strong>sta</strong> is present but cannot reach it&#039;s designated remote AP.&nbsp; As for the outrageous claim that the behaviour of <em>netifd</em> is a <a href="https://dev.openwrt.org/ticket/12000#comment:9">bug</a> when it complies with the industry standard, and who knows better here? johndoe or several thousand developers of networking software?, it is rich when delivered by a self-confessed hack.</p><p>As for the adoption of <strong>the script</strong>?&nbsp; No pride of ownership is attached.&nbsp; Test it and attack it.&nbsp; Improve it and <em>giveback</em>.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311724">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">johndoe</div>
					<div class="post-datetime">
						16 Feb 2016, 20:41					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Max Hopper wrote:</cite><blockquote><p>Nowhere has it been stated that an configured section - wifi-iface of type ap cannot accept associations when a section - wifi-iface of type sta is present but cannot reach it&#039;s designated remote AP.</p></blockquote></div><p>The behavior of OpenWRT is to make the AP interface unavailable on the air if for whatever reason the STA interface can&#039;t connect. There are wifi devices with repeater functionality which don&#039;t have this limitation, even on the exact same hardware. Yet, this is the reason given for the &quot;<a href="https://dev.openwrt.org/ticket/12000#comment:4">wontfix</a>&quot; status of the bug:</p><div class="quotebox"><blockquote><p>If wpa_supplicant looses the connection it will go into an active scan cycle which renders the wiphy unusable for ap mode operation, therefore the ap is taken down if the sta looses its association. That is nothing that can be fixed easily and there are no current plans to solve this.</p></blockquote></div><p>But as demonstrated, the wiphy can be used for AP mode operation while wpa_supplicant is scanning.<br />Dial down the attitude, kid.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p313459">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">orbit</div>
					<div class="post-datetime">
						3 Mar 2016, 15:10					</div>
				</div>
				<div class="post-content content">
					<p>I have just applied your workaround to my ZSUN and works perfectly! Thanks<br />I was wondering if you could look at this other issue <a href="http://forum.openwrt.org/viewtopic.php?pid=313458">http://forum.openwrt.org/viewtopic.php?pid=313458</a><br />I think you would have fun as well with hostapd-wpe <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Thanks!</p><div class="quotebox"><cite>johndoe wrote:</cite><blockquote><p>I&#039;ve had the same issue with the STA network taking down the AP network. Specifically, the Zsun wifi card reader only has a wifi interface, and killing the wifi leaves no option but a reset of the configuration. So I&#039;ve come up with a workaround that I&#039;ve posted to the (closed, wontfix) <a href="https://dev.openwrt.org/ticket/12000#comment:9">bug</a>. Turns out that it is possible to have a working AP network while the defunct STA network is still active. In best &quot;have you tried turning it off and on again&quot; fashion, I run a script that takes down the AP interface and brings it back up whenever it loses its wireless configuration. This causes it to get reconfigured and reappear on the air, without taking down the station interface. I call the script from /etc/rc.local.</p><div class="codebox"><pre><code>/root/wifi-watchdog.sh &amp;</code></pre></div><p>You might want to run it manually and see if it works for you before you make it run automatically. Here&#039;s the /root/wifi-watchdog.sh script. Don&#039;t forget to chmod u+x /root/wifi-watchdog.sh to make it executable. AP_DEV is the interface which is in access point mode.</p><div class="codebox"><pre><code>#!/bin/sh

AP_DEV=wlan0-1

while ( true ) ; do
  if !( iw dev $AP_DEV info | grep -q ssid ) ; then
    logger wifi-watchdog: Wifi in trouble, to the rescue...
    ifconfig $AP_DEV down;
    ifconfig $AP_DEV up;
  fi
  sleep 5
done</code></pre></div><p>It&#039;s a dirty hack, but it works for me. Use at your own risk.</p></blockquote></div>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>