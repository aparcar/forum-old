<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> How to connect OpenWRT behind another router</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 30 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p204248">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">eone</div>
					<div class="post-datetime">
						11 Jun 2013, 11:14					</div>
				</div>
				<div class="post-content content">
					<p>Hi</p><p>I am new to OpenWRT. My environment: </p><p>OpenWrt Backfire 10.03.1</p><p>A Dlink DIR 655 Router is connected to the internet.The Dlink router is connected to an internal network: 192.168.0.0/24 with ip address 192.168.0.1</p><p>I connected OpenWRT to Dlink via (OpenWrt&#039;s WAN port to Dlink&#039;s LAN port)</p><p>OpenWRT&#039;s /etc/config/network is as follows:</p><p>#### VLAN configuration<br />config switch eth0<br />&nbsp; &nbsp; &nbsp; &nbsp; option enable&nbsp; &nbsp;1</p><p>config switch_vlan eth0_0<br />&nbsp; &nbsp; &nbsp; &nbsp; option device&nbsp; &nbsp;&quot;eth0&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; option vlan&nbsp; &nbsp; &nbsp;0<br />&nbsp; &nbsp; &nbsp; &nbsp; option ports&nbsp; &nbsp; &quot;1 2 3 4 5&quot;</p><p>config switch_vlan eth0_1<br />&nbsp; &nbsp; &nbsp; &nbsp; option device&nbsp; &nbsp;&quot;eth0&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; option vlan&nbsp; &nbsp; &nbsp;1<br />&nbsp; &nbsp; &nbsp; &nbsp; option ports&nbsp; &nbsp; &quot;0 5&quot;</p><p>#### Loopback configuration<br />config interface loopback<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname&nbsp; &nbsp;&quot;lo&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto&nbsp; &nbsp; static<br />&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr&nbsp; &nbsp;127.0.0.1<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask&nbsp; 255.0.0.0<br />#### LAN configuration&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />config interface lan&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; option type&nbsp; &nbsp; &nbsp;bridge&nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname&nbsp; &nbsp;&quot;eth0.0&quot; <br />&nbsp; &nbsp; &nbsp; &nbsp; option proto&nbsp; &nbsp; static&nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr&nbsp; &nbsp;192.168.1.1<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask&nbsp; 255.255.255.0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />#### WAN configuration&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />config interface&nbsp; &nbsp; &nbsp; &nbsp; wan&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname&nbsp; &nbsp;&quot;eth0.1&quot;&nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto&nbsp; &nbsp; static&nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr&nbsp; &nbsp;192.168.0.54 <br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask&nbsp; 255.255.255.0<br />&nbsp; &nbsp; &nbsp; &nbsp; option gateway&nbsp; 192.168.0.1&nbsp; <br />&nbsp; </p><p>The Dlink router&nbsp; is configured with a static route to 192.168.1.0/24 via 192.168.0.54</p><p>I have a machine (192.168.0.22) connected to Dlink router via LAN port</p><p>I have a second machine (192.168.1.4) connected to OpenWrt router via LAN port.</p><p>The firewall at&nbsp; machine (192.168.1.4) is disabled.</p><p>The firewall at&nbsp; &nbsp;machine (192.168.0.22) is disabled.</p><p>In the /etc/config/firewall, the wan interface&#039;s option masq setting is set to 0 (off)</p><p>Problem:</p><p>1. Machine (192.168.0.22) can ping machine (192.168.1.4) but machine(192.168.1.4) failed to ping Machine (192.168.0.22).</p><p>2. Machine (192.168.0.22) failed to ssh Machine (192.168.1.4).</p><p>Thank you in advance for help extended.</p><p>Regards,</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p204275">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">lizby</div>
					<div class="post-datetime">
						11 Jun 2013, 15:05					</div>
				</div>
				<div class="post-content content">
					<p>Can&#039;t speak to why your existing configuration doesn&#039;t work, but since your connections are wired, is there a reason why you don&#039;t have all the ips on the same subnet, for example 192.168.0.x, with the gateway router plugged into a lan port on the openWrt router?&nbsp; This works for me.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p204284">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">eone</div>
					<div class="post-datetime">
						11 Jun 2013, 17:01					</div>
				</div>
				<div class="post-content content">
					<p>Hi</p><p>The OpenWrt router is a linksys WRT54Gv2.2 hardware. Previously, with the linksys supplied firmware, I could have 2 different network id by configuring the linksys to act as a router and not a gateway(NAT) and it worked. So I am trying to preserve that setup. I am also doing it as an experiment.</p><p>Regards,</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p204293">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						11 Jun 2013, 18:08					</div>
				</div>
				<div class="post-content content">
					<p>Pardon me, I got lost reading your explanation. Perhaps, if you were to use a diagram that shows the connections between the devices, it would probably clear up some confusion.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p204297">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">eone</div>
					<div class="post-datetime">
						11 Jun 2013, 19:38					</div>
				</div>
				<div class="post-content content">
					<p>Hi</p><p>Here is the diagram of my setup</p><p><span class="postimg"><img src="https://docs.google.com/drawings/d/1xZ_r3W_2kfIaQ0xJblfzWK-HXvHBIeEocLmfd4GPubc/pub?w=960&amp;amp;h=720" alt="PunBB bbcode test" /></span></p><p>Regards</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p204302">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">esters</div>
					<div class="post-datetime">
						11 Jun 2013, 20:23					</div>
				</div>
				<div class="post-content content">
					<p>Bumping this thread, because the problem is actual in my case too. I am trying to set up a guest router (WRT54GL with 10.03.1 &quot;Backfire&quot;) with exact same setup as member eone. In my case i am unable to connect to internet via the guest router, BUT, i am able to successfully ping an external address from it e.g google.com. <br />I have tried to disable the firewall on both routers, tried to adjust the route tables but without any success. Much help appreciated.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p204314">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						11 Jun 2013, 22:19					</div>
				</div>
				<div class="post-content content">
					<p>Unless you can access to the DLink DIR-655 router to make the necessary changes, I would recommend that you put the OpenWRT router as your main router. Once you have your OpenWRT as your main router, you can edit the /etc/config/network file (on your OpenWRT router) to furnish it with the additional route as follows:<br /></p><div class="codebox"><pre><code>config route
        option &#039;interface&#039; &#039;lan&#039;
        option &#039;target&#039;    &#039;192.168.0.0&#039;  # your DLink DIR-655 subnet
        option &#039;gateway&#039;   &#039;192.168.1.x&#039;  # your DLink DIR-655 WAN IP 
                                          # Address assigned by your
                                          # main (OpenWRT) router
        option &#039;netmask&#039;   &#039;255.255.255.0&#039;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p204332">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">kirschwasser</div>
					<div class="post-datetime">
						12 Jun 2013, 01:45					</div>
				</div>
				<div class="post-content content">
					<p>You have three choices:<br />you enter some static routers on your&nbsp; D-Link 655, then you can disable the NAT on your OpenWrt-router and everything will work as it should.</p><p>or you keep the NAT but work with portforwards on your OpenWrt-Router.</p><p>or you switch the two routers and enter static routes on your OpenWrt-Router. Mazilo showed you how.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p204347">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">eone</div>
					<div class="post-datetime">
						12 Jun 2013, 06:31					</div>
				</div>
				<div class="post-content content">
					<p>Hi kirschwasser</p><div class="quotebox"><cite>kirschwasser wrote:</cite><blockquote><p>you enter some static routers on your&nbsp; D-Link 655, then you can disable the NAT on your OpenWrt-router and everything will work as it should.</p></blockquote></div><p>I have access to Dlink Router and have configured the static route to network 192.168.1.0/24 in the Dlink router. So that explains how I am able to ping to machine(192.168.1.4) from machine(192.168.0.22).</p><div class="quotebox"><cite>esters wrote:</cite><blockquote><p> In my case i am unable to connect to internet via the guest router, BUT, i am able to successfully ping an external address from it e.g google.com.</p></blockquote></div><p>I experience the same thing as esters.</p><p>When I was using the Linksys supplied firmware, It was just a matter of changing the mode from gateway to router. I do not have to add any static route in Linksys router. The only static route I added was in the Dlink router that was connected to the internet.</p><p>The main question is: How to tell OpenWrt to change from gateway to router mode.</p><p>So far I have done the following:</p><p>1. Disable Masquerading on WAN interface.</p><p>2. Configure the firewall(INPUT,OUTPUT,FORWARD chains) to accept every packets.</p><p>Regards,</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p205022">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">eone</div>
					<div class="post-datetime">
						18 Jun 2013, 16:43					</div>
				</div>
				<div class="post-content content">
					<p>Hi</p><p>Here is an update after 2 days of trouble-shooting and sniffing packets.</p><p>Problem 1:<br />1. Machine (192.168.0.22) can ping machine (192.168.1.4) but machine(192.168.1.4) failed to ping Machine (192.168.0.22).</p><p>Solved</p><p>The static route in the Dlink router&nbsp; clearly did not work. However after I add a static route in Machine (192.168.0.22) itself,&nbsp; machine(192.168.1.4) was able to ping Machine (192.168.0.22).</p><p>Problem 2. Machine (192.168.0.22) failed to ssh Machine (192.168.1.4).</p><p>Solved. Adding the static route in Machine(192.168.0.22) itself also solved this problem.</p><p>Problem 3. Unable to connect to internet via the OpenWRT router, BUT, i am able to successfully ping an external address from it e.g google.com. (Actually, this problem was brought up by member esters)</p><p>Solved. The problem lies in the Dlink DIR-655&#039;s NAT function. DIR-655 Version A1 can NAT any source ip from its subnet or external subnet(192.168.1.0/255). However, last week I RMA the version A1 to exchange for version B1. DIR-655 version B1 will only NAT source IP from its own subnet. It will not NAT ip packets with source address from external subnet(192.168.1.0/255). So to access the internet behind OpenWRT, enable Masquerade from OpenWRT if you have DIR-655 version B1 connected to Internet. This is effectively Double NATing. To mitigate the double NAT, add a rule in OpenWRT to only masquerade packets bound for Internet and not masquerade packed bound for internal LAN.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>