<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> SIP connection tracking</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 16 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p78962">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">exnor</div>
					<div class="post-datetime">
						4 Jan 2009, 20:23					</div>
				</div>
				<div class="post-content content">
					<p>Hello All!</p><p>I`m trying to run my Asterisk server behind NAT. I couldn&#039;t figure out why and when the NAT helper modules went missing from OpenWRT. <br />They are rather crucial if you are trying to have SIP devices/servers behind NAT without STUN.&nbsp; <br />I now, they have been there in the package &quot;kmod-ipt-nathelper-extra&quot;.&nbsp; The both modules are called: ip_conntrack_sip and ip_nat_sip. <br />They are part of any decent distro nowadays, but they just vanished from Kamikaze. <br />Could you please provide some info on this problem, I can&#039;t believe, I&#039;m the only one with this trouble.</p><p>Thank you in advance!</p><p>Exnor</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p78963">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">oxo</div>
					<div class="post-datetime">
						4 Jan 2009, 20:33					</div>
				</div>
				<div class="post-content content">
					<p>Which version of kamikaze?</p><p>(I had been thinking of moving my asterisk off my OpenWrt box at some stage, so it is good for me to know what problems there are)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p78968">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">exnor</div>
					<div class="post-datetime">
						4 Jan 2009, 22:00					</div>
				</div>
				<div class="post-content content">
					<p>Hi Oxo!</p><p>I was trying the latest Kamikaze 7.09. I was using the binaries for Linksys WRT54G. At 1st the one with the 2.6 Kernel then the the one with the 2.4 series kernel. To be absolutely precise:<br /> <a href="http://downloads.openwrt.org/kamikaze/7.09/brcm47xx-2.6/openwrt-wrt54g-2.6-squashfs.bin">http://downloads.openwrt.org/kamikaze/7 … uashfs.bin</a><br /> <a href="http://downloads.openwrt.org/kamikaze/7.09/brcm-2.4/openwrt-wrt54g-2.4-squashfs.bin">http://downloads.openwrt.org/kamikaze/7 … uashfs.bin</a><br />The package &quot;kmod-ipt-nathelper-extra&quot; depends on a 2.4 kernel.</p><p>Looking forward to hear anything else about this issue!</p><p>Thanks!</p><p>exnor</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p78969">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">oxo</div>
					<div class="post-datetime">
						4 Jan 2009, 22:21					</div>
				</div>
				<div class="post-content content">
					<p>I looked in the packages for your release, then @ <a href="http://downloads.openwrt.org/kamikaze/8.09_RC1/brcm-2.4/packages/">http://downloads.openwrt.org/kamikaze/8 … /packages/</a></p><p>- nat helper seems to be in 8.09 ....</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p78981">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">exnor</div>
					<div class="post-datetime">
						5 Jan 2009, 00:02					</div>
				</div>
				<div class="post-content content">
					<p>Hi!</p><p>Thank you for the answer! <br />The NAT helper modules for specific protocols seem to be in :<br /><a href="http://downloads.openwrt.org/kamikaze/8.09_RC1/brcm-2.4/packages/kmod-ipt-nathelper-extra_2.4.35.4-brcm-2.4-1_mipsel.ipk">http://downloads.openwrt.org/kamikaze/8 … mipsel.ipk</a><br />Too bad the modules for SIP are not included: <br /></p><div class="codebox"><pre><code>./
./lib/
./lib/modules/
./lib/modules/2.4.35.4/
./lib/modules/2.4.35.4/ip_conntrack_amanda.o
./lib/modules/2.4.35.4/ip_conntrack_proto_gre.o
./lib/modules/2.4.35.4/ip_nat_proto_gre.o
./lib/modules/2.4.35.4/ip_conntrack_h323.o
./lib/modules/2.4.35.4/ip_nat_h323.o
./lib/modules/2.4.35.4/ip_conntrack_mms.o
./lib/modules/2.4.35.4/ip_nat_mms.o
./lib/modules/2.4.35.4/ip_conntrack_pptp.o
./lib/modules/2.4.35.4/ip_nat_pptp.o
./lib/modules/2.4.35.4/ip_conntrack_rtsp.o
./lib/modules/2.4.35.4/ip_nat_rtsp.o
./lib/modules/2.4.35.4/ip_nat_snmp_basic.o
./etc/
./etc/modules.d/
./etc/modules.d/45-ipt-nathelper-extra</code></pre></div><p>Exnor</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p79092">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">exnor</div>
					<div class="post-datetime">
						6 Jan 2009, 12:53					</div>
				</div>
				<div class="post-content content">
					<p>Hi All!</p><p>No luck yet, so I will need to have siproxd runnig on OpenWRT as a frontend for my Asterisk. <br />Still, please let me know if someone has some Information on the fate of the SIP helper modules! They could be important to anyone running SIP behind a low cost router.&nbsp; &nbsp;</p><p>Yours !</p><p>Exnor</p><p>Ps. is there a painless way to compile a kernel by myself? Some good howtos maybe?<br />(I have done it several times for my PC, but a cross compile for that small box is quite a big obstacle for me, as an ordinary user.)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p79257">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">stunted</div>
					<div class="post-datetime">
						8 Jan 2009, 05:16					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>exnor wrote:</cite><blockquote><p>No luck yet, so I will need to have siproxd runnig on OpenWRT as a frontend for my Asterisk.</p></blockquote></div><p>Siproxd is pretty cool anyway and probably a more elegant solution, use ifconfig to ID interfaces, on my WRT54GL I set up /etc/siproxd.conf with <br />if_inbound&nbsp; = br-lan<br />if_outbound = eth0.1<br />and also <br />registration_file = /tmp/siproxd_registrations<br />pid_file = /tmp/run/siproxd/siproxd.pid <br />the at the bottom of /etc/firewall.user<br /># transparently redirect SIP traffic to siproxd<br />iptables -t nat -A prerouting_rule -p udp -i br-lan --dport 5060 -j REDIRECT</p><p># allow incoming SIP and RTP traffic<br />iptables -A input_wan -p udp --dport 5060&nbsp; &nbsp; &nbsp; -j ACCEPT<br />iptables -A input_wan -p udp --dport 7070:7089 -j ACCEPT</p><p>One issue is that versions of siproxd prior to 0.6.0 don&#039;t proxy RTCP with the result was that data streams that utilise RTCP (usually Video) look awful, Kamikaze 7.09 uses siproxd 0.5.13-1 while 8.09 RC1 currently has 07.1-1 but I can&#039;t get 8.09 with qos stable so there&#039;s a problem somewhere.<br /><a href="http://forum.openwrt.org/viewtopic.php?id=15531">http://forum.openwrt.org/viewtopic.php?id=15531</a></p><p>Good luck</p>											<p class="post-edited">(Last edited by <strong>stunted</strong> on 9 Jan 2009, 03:41)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p79292">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">exnor</div>
					<div class="post-datetime">
						8 Jan 2009, 18:16					</div>
				</div>
				<div class="post-content content">
					<p>Hi Stunted!</p><p>Thanks a lot, any info on this topic is very much appreciated. Your reply doesn&#039;t sound very promising, I&#039;m wondering if I just should take something like a normal PC with a full blown distro as a router. Still I&#039;ll give it a try this weekend, and should I succeed I&#039;ll post my results here.</p><p>I would still like to hear something about those NAT helper modules, VoIP seems to be neglected a bit by the developers. <br />Anyway OpenWRT is a great thing, please keep up the great job, and thanks for the development, but please, please put those NAT helpers back into there! <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Exnor</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p79330">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">stunted</div>
					<div class="post-datetime">
						9 Jan 2009, 04:10					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>exnor wrote:</cite><blockquote><p>Hi Stunted!</p><p>Thanks a lot, any info on this topic is very much appreciated. Your reply doesn&#039;t sound very promising, I&#039;m wondering if I just should take something like a normal PC with a full blown distro as a router. Still I&#039;ll give it a try this weekend, and should I succeed I&#039;ll post my results here</p></blockquote></div><p>I don&#039;t mean to sound down, I&#039;m just doing battle to get 8.09 with siproxd and qos running and stable on my WRT54GL, if you don&#039;t use video then 7.09 and siproxd 0.5 will work *very* nicely for you.</p><p>You run Asterisk in-side the network, I don&#039;t at the moment so I don&#039;t know if that means *all* the SIP traffic comes from / to the Asterisk box or if it just acts as a registrar and the actual traffic is still P2P, in the first case then just forwarding the relevant ports to the Asterisk box would probably work, in the later you still need some assistance with NAT traversal.</p><p>One alternative I&#039;ve used is you run stable software (7.09 or in my previous case Debian etch) on the internet facing firewall without siproxd but with relevant ports forwarded to an internal box that runs more bleeding edge software (8.09 or in my previous case Debian Lenny) and a more up-to-date version of siproxd, that way video works as well and you don&#039;t have to run beta software on your firewall, the disadvantage is you loose the ability to make the proxy transparent and have to set all your SIP clients to use the internal box as their outbound proxy.</p><p>I can&#039;t wait for 8.09 and / or lenny to go stable as then these issues go away.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p93668">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">peng</div>
					<div class="post-datetime">
						3 Sep 2009, 15:44					</div>
				</div>
				<div class="post-content content">
					<p>HI,</p><p>Based on the above post by Stunted, I am running 8.09.1 and I have to install&nbsp; iptables-mod-nat-extra to get ipt_REDIRECT.ko installed so the &quot;REDIRECT&quot; will work. I don&#039;t have to creat /etc/siproxd.conf as existing siproxd.conf under /var/run..... seems working fine.</p><p>(https://dev.openwrt.org/browser/trunk/package/iptables/Makefile?rev=12649 (define Package/iptables-mod-nat-extra/description<br />173&nbsp; &nbsp;&nbsp; iptables extensions for extra NAT targets.<br />174&nbsp; &nbsp;&nbsp; Includes:<br />175&nbsp; &nbsp;&nbsp; - REDIRECT)</p><p>for the firewall config,</p><p>***from /etc/firewall.user<br /># transparently redirect SIP traffic to siproxd<br />iptables -t nat -A prerouting_rule -p udp -i br-lan --dport 5060 -j REDIRECT</p><p>**from /etc/config/firewall<br />config rule&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src&nbsp; &nbsp; &nbsp; wan&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src_dport&nbsp; &nbsp; &nbsp; &nbsp; 5060&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; option target&nbsp; &nbsp;ACCEPT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; option protocol udp&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />config rule&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src&nbsp; &nbsp; &nbsp; wan&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src_dport&nbsp; &nbsp; &nbsp; &nbsp; 7070-7089&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target&nbsp; &nbsp;ACCEPT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; option protocol udp&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p><p>root@WRT_CAN:~# uname -a<br />Linux WRT_CAN 2.6.25.20 #4 Mon Jun 1 23:39:13 UTC 2009 mips unknown.</p><p>BTW,</p><p>I was trying to use new firewall configuration method to achieve &quot;iptables -t nat -A prerouting_rule -p udp -i br-lan --dport 5060 -j REDIRECT&quot; and not do this in /etc/firewall.user, but doesn&#039;t work.</p><p>config in /etc/config/firewall:<br />config redirect<br />&nbsp; &nbsp; &nbsp; option src&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lan<br />&nbsp; &nbsp; &nbsp; option src_dport&nbsp; &nbsp; &nbsp; &nbsp; 5060<br />&nbsp; &nbsp; &nbsp; option target&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;REDIRECT</p><p>Does anyone know whether this is confired wrong or it can&#039;t be accieved in /etc/config/firewall, but only achieved in /etc/firewall.user. ?</p><p>thanks</p><br /><br /><br /><p>thanks<br />Peng</p>											<p class="post-edited">(Last edited by <strong>peng</strong> on 6 Sep 2009, 01:18)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p95330">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">peng</div>
					<div class="post-datetime">
						4 Oct 2009, 12:53					</div>
				</div>
				<div class="post-content content">
					<p>Hi Guys,</p><p>Can some body give shed some light? What can I do to make this work? Is it a bug?</p><p>When my phone is registering to a proxy not using standard 5060 port,say 8060, siproxd sill modifies it to 5060 and send out registration ( i guess it&#039;s true for invite as well). It would be wrong for it does this and it should only modify source ip/port. I did changed listen port in the siproxd.</p><p>Here&#039;s a tcpdump.</p><p>5:38:15.142620 IP 221.209.xx.xx.8060 &gt; xxxx.dsl.xxx.com.5060:</p><p>thanks in advance.<br />peng</p>											<p class="post-edited">(Last edited by <strong>peng</strong> on 4 Oct 2009, 12:54)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>