<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> A qos script that really works! -- now for Backfire</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 2 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p153061">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">rudy</div>
					<div class="post-datetime">
						4 Jan 2012, 17:48					</div>
				</div>
				<div class="post-content content">
					<p>Finally, qos-re (originally for WhiteRussian -- see <a href="https://forum.openwrt.org/viewtopic.php?pid=19063#p19063">A qos script that really works!</a>) is available for Backfire. The version is bumped up to 2.0.</p><p>Install with:<br /></p><div class="codebox"><pre><code>ipkg install http://files.eschauzier.org/qos-re_2.0-1_all.ipk</code></pre></div><p>The changelog:<br />1. First version for Backfire<br />2. Removed ipp2p because implementation broken</p><p>The hfsc version of the v2.0 script is also available, install with:<br /></p><div class="codebox"><pre><code>ipkg install http://files.eschauzier.org/qos-re-hfsc_2.0-1_all.ipk</code></pre></div><p>The changelog is the same as for qos-re.</p><p>To obtain the new /etc/qos.conf file without the ipp2p reference when upgrading, make sure to use the config file that the package manager saves under the name qos.conf-ipkg. Also, you may need to remove existing packages when installing a package with a new name (e.g. qos-re-hfsc over qos-re).</p><p>After modifying /etc/qos.conf, you will need to run <strong>qos-start</strong> to load the new settings. The command <strong>qos-stat</strong> is available to check the current QoS status. Use <strong>qos-stop</strong> to stop QoS shaping.</p><p>The bare scripts and config file can be found here:<br />HTB version of the script: <a href="http://files.eschauzier.org/backfire/20-qos-htb">20-qos-htb</a><br />HFSC version of the script: <a href="http://files.eschauzier.org/backfire/20-qos-hfsc">20-qos-hfsc</a><br />Config file: <a href="http://files.eschauzier.org/backfire/qos.conf">qos.conf</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153063">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						4 Jan 2012, 18:00					</div>
				</div>
				<div class="post-content content">
					<p>Thank you! I will give it a good try.</p><p>I have two remarks:<br />- Could you use a mark mask in the iptable-rules? This make the script more compatible with other apps that use the iptables mark action.<br />- I have three WAN interfaces. Could you make the script more multi-wan friendly?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153070">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">xopal</div>
					<div class="post-datetime">
						4 Jan 2012, 18:36					</div>
				</div>
				<div class="post-content content">
					<p>Fix the link please</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153108">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">rudy</div>
					<div class="post-datetime">
						4 Jan 2012, 22:26					</div>
				</div>
				<div class="post-content content">
					<p>Can you indicate what the problem is? The links seem to be up:</p><div class="codebox"><pre><code>Website test results

URL tested:    http://files.eschauzier.org/qos-re-hfsc_2.0-1_all.ipk
Test performed from:    Seattle, WA
Test performed at:    2012-01-04 15:20:18 (GMT -05:00)
Resolved As:    92.254.60.135
Status:    OK
Response Time:    0.752 sec
DNS:    0.094 sec
Connect:    0.164 sec
Redirect:    0.000 sec
First byte:    0.281 sec
Last byte:    0.213 sec
Size:    7856 bytes</code></pre></div><div class="quotebox"><cite>xopal wrote:</cite><blockquote><p>Fix the link please</p></blockquote></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153213">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">ymhee_bcex</div>
					<div class="post-datetime">
						5 Jan 2012, 19:54					</div>
				</div>
				<div class="post-content content">
					<p>If I remember correctly, Black Russian had two qos implementations. One of them became <a href="http://downloads.openwrt.org/backfire/10.03.1/brcm47xx/packages/qos-scripts_1.2.1-3.2_all.ipk">stock</a> implementation. <em>This</em> is the upgrade of another one, correct?</p><p>So, in order to use this, I need to uninstall qos-scripts, right? Is it compatible with luci UI? In other words, if I install qos-re, will I be able to administer it through web UI?</p><p>I also remember a spirited discussion (to detailed for me to understand <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> ) about the differences between the two. Now my bandwidth got bigger (and my son got older, so he is not saturating network with file sharing as before) - but is there a way to see performance difference differences between two versions?</p><p>Thanks</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p154533">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">TomVH</div>
					<div class="post-datetime">
						17 Jan 2012, 22:26					</div>
				</div>
				<div class="post-content content">
					<p>Rudy,</p><p>Fist: I’m neither a linux guru nor a network guru. And my English is very bad but maybe you and other people could use my experience. </p><p>I’ve written my own QoS script because I have a slow ADSL connection (6144kbit / 640kbit) and I would prioritize HTTP and VoIP. The default OpenWRT script isn’t documented, Service curves are wrong calculated (in my vieuw) and it isn’t possible to configure the leaf Qdisc. Tomato doesn’t use a good download QoS. The leaf Qdisc of DD-wrt also aren’t configurable.</p><p>Instead of writing your own script, it’s maybe possible to change the default OpenWrt script and make some documentation? If there are some good Qos configfiles with a good documentation, it isn’t necessary to write another script. I’m not capable to modify the default QoS script because I’m not a linux programmer. I understand most of the default QoS script but as already told I’m not capable to modify the default QoS script. Maybe you can change the QoS script of nbd? I would like to help make some wiki documentation (i know people who will translate in English)</p><p><strong>Change requests rudy’s and nbd’s QoS script</strong><br />1) Use the TC stab option if you use the thrunk version of OpenWrt. It really works <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> With the stab option, TC calculate the (ATM, PPP,…) overhead. So it’s not necessary to set upload 90% of your linespeed. <br /></p><div class="codebox"><pre><code>tc qdisc add dev $iface stab overhead 44 linklayer atm root handle 1: hfsc default 50</code></pre></div><p>I guess, it&#039;s not difficult to implement the <a href="http://www.linuxhowtos.org/manpages/8/tc-stab.htm">stab</a> option in the default QoS script. Just add 2 configrules and some code.<br />suggestion of the extra configrules:<br />option linklayer_adaptation &quot;ATM&quot; or &quot;ethernet&quot;<br />option overhead &quot;44&quot; (per ethernet packet 44 bytes overhead) <a href="http://ace-host.stuart.id.au/russell/files/tc/tc-atm/">link</a></p><p>2) The default QoS of the thrunk version of OpenWrt use a ack_conntrack patch and the IFB interface. Maybe you could use IFB and act_conntrack?</p><p>3) In your script you say not to use “length of burst buffers lower than 10 ms) =&gt; timer resolution is 100HZ. Is it possible to find out the timer resolution of the kernel? I don’t know which timer resolution openwrt use. A cat of the /proc/timer_list shows me a timer resolution of 1ns (WNDR 3700v2)<br /></p><div class="codebox"><pre><code>/proc$ cat /proc/timer_list
Timer List Version: v0.6
HRTIMER_MAX_CLOCK_BASES: 3
now at 785328994524672 nsecs

cpu: 0
 clock 0:
  .base:       802c7fa0
  .index:      0
  .resolution: 1 nsecs
  .get_time:   &lt;80095004&gt;
  .offset:     1326047247244582392 nsecs
active timers:
 clock 1:
  .base:       802c7fd0
  .index:      1
  .resolution: 1 nsecs
  .get_time:   &lt;800952e0&gt;
  .offset:     0 nsecs
active timers:
 #0: &lt;8399fb98&gt;, &lt;801f20dc&gt;, S:01
 # expires at 785328994924288-785328994924288 nsecs [in 399616 to 399616 nsecs]
 #1: &lt;830ff798&gt;, &lt;801f20dc&gt;, S:01
 # expires at 785328996922816-785328996922816 nsecs [in 2398144 to 2398144 nsecs]
 #2: &lt;8030b6c0&gt;, &lt;800700ec&gt;, S:01
 # expires at 785329000000000-785329000000000 nsecs [in 5475328 to 5475328 nsecs]
 #3: &lt;802c84b0&gt;, &lt;8009ac40&gt;, S:01
 # expires at 785329000000000-785329000000000 nsecs [in 5475328 to 5475328 nsecs]
 #4: &lt;8381deb8&gt;, &lt;80090244&gt;, S:01
 # expires at 785329047731730-785329047781730 nsecs [in 53207058 to 53257058 nsecs]
 #5: &lt;83355a48&gt;, &lt;80090244&gt;, S:01
 # expires at 785329074610491-785329075568298 nsecs [in 80085819 to 81043626 nsecs]
 #6: &lt;8385deb8&gt;, &lt;80090244&gt;, S:01
 # expires at 785330038946170-785330038996170 nsecs [in 1044421498 to 1044471498 nsecs]
 #7: &lt;83203a48&gt;, &lt;80090244&gt;, S:01
 # expires at 785336390075945-785336400075938 nsecs [in 7395551273 to 7405551266 nsecs]
 #8: &lt;82569a48&gt;, &lt;80090244&gt;, S:01
 # expires at 785628990456272-785629090456272 nsecs [in 299995931600 to 300095931600 nsecs]
 #9: &lt;83351ae0&gt;, &lt;80090244&gt;, S:01
 # expires at 786283993381947-786284093381947 nsecs [in 954998857275 to 955098857275 nsecs]
 #10: &lt;83a31e50&gt;, &lt;80079598&gt;, S:01
 # expires at 811277106541532-811277106541532 nsecs [in 25948112016860 to 25948112016860 nsecs]
 clock 2:
  .base:       802c8000
  .index:      7
  .resolution: 1 nsecs
  .get_time:   &lt;80094d08&gt;
  .offset:     0 nsecs
active timers:
  .expires_next   : 785328994924288 nsecs
  .hres_active    : 1
  .nr_events      : 154691328
  .nr_retries     : 486291
  .nr_hangs       : 1
  .max_hang_time  : 17803 nsecs
  .nohz_mode      : 0
  .idle_tick      : 0 nsecs
  .tick_stopped   : 0
  .idle_jiffies   : 0
  .idle_calls     : 0
  .idle_sleeps    : 0
  .idle_entrytime : 0 nsecs
  .idle_waketime  : 0 nsecs
  .idle_exittime  : 0 nsecs
  .idle_sleeptime : 0 nsecs
  .iowait_sleeptime: 0 nsecs
  .last_jiffies   : 0
  .next_jiffies   : 0
  .idle_expires   : 0 nsecs
jiffies: 78502899


Tick Device: mode:     1
Per CPU device: 0
Clock Event Device: MIPS
 max_delta_ns:   6316128371
 min_delta_ns:   2258
 mult:           1460288881
 shift:          32
 mode:           3
 next_event:     785328994924288 nsecs
 set_next_event: &lt;800684f0&gt;
 set_mode:       &lt;80068514&gt;
 event_handler:  &lt;80090e9c&gt;
 retries:        1</code></pre></div><p>4) it should be possible to set each parameter of the HFSC class. Maybe this is possible in the default openwrt QoS script but I have not studied the entire script.</p><p>5) it should be possible to set each parameter of the leaf qdisc. The most home computer do not support ECN by default. I also thing the most webservers don&#039;t support ECN.&nbsp; So it should be possible to disable ECN.<br />It’s possible to limit P2P traffic with a large leaf red qdisc (300 ms). I’ve read that P2P congestion control algorithms take RTT of the packets into account. In my case, it works <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" />. No packets are dropped and the RTT of ICMP packets are very good. So make it possible to the user to change the leaf qdisc parameters.<br />I test this situation by sending ICMP packets to the priority class. the RTT of the ICMP packets are good. RTT of ICMP packets while downloading HTTP content (youtube, vimeo,...) are extremely good.</p><p>My script (based on rudy’s and nbd’s one):<br /></p><div class="codebox"><pre><code>#!/bin/sh -x

#qos script by TomVH

DEBUG=0

# To enable logging (requires iptables-mod-extra package)
[ $DEBUG -eq 1 ] &amp;&amp; insmod ipt_LOG &gt;&amp;- 2&gt;&amp;-

#######################################################
DOWNLOAD=5000 #download speed in kbit. set xx% of real download speed
UPLOAD=600 # set xx% of real upload speed

# multiports = up to 15 ports
# ports to be classified as bulk #set after connection mark save and after connection mark restore
TCP_BULK=&quot;1024:&quot; #S and D ports
UDP_BULK=&quot;1024:&quot; #S and D ports

# Destination ports to be classified as P2P
TCP_P2P=&quot;13769&quot; #D ports
UDP_P2P=&quot;13769&quot; #D ports
IP_P2P=&quot;192.168.0.133&quot;

# Destination ports to be classified as normal
TCP_NORMAL=&quot;80,443,25,20,21,110,993,995&quot; # D ports
UDP_NORMAL=&quot;&quot;

# Destination ports to be classified as Prio (overules bulk ports)
TCP_PRIO=&quot;22,53&quot; #destination ports
UDP_PRIO=&quot;22,53&quot; #destination ports

# Destination ports to be classified as VoIP (overules bulk ports)
TCP_VOIP=&quot;&quot;
UDP_VOIP=&quot;18080&quot;
IP_VOIP=&quot;192.168.0.226&quot; #destination and source IP
IP_VOIP=&quot;192.168.0.226&quot; #destination and source IP

#######################################################
iface=&quot;pppoe-wan&quot;
#####################################################


#!!!!!uplink leaf class parameters!!!!!!!!!

#bulk
UP_LS_BULK_RATE=$(($UPLOAD*5/100))
UP_UL_BULK_RATE=$UPLOAD
#settings leaf qdisc
UP_BULK_RED_PROB=0.05 #red drob probability
UP_BULK_RED_min=6250 #real limit. To limit BULK traffic
UP_BULK_RED_min2=6250 #min for doing the calculations (burst and etc)
UP_BULK_RED_max=$((2 * $UP_BULK_RED_min2 + $UP_BULK_RED_min))
UP_BULK_RED_burst=$(((5 * $UP_BULK_RED_min2) / (3 * 1000)))
UP_BULK_RED_limit=$(($UP_BULK_RED_max * 5))

#P2P
UP_LS_P2P_RATE=$(($UPLOAD * 5 / 100))
UP_UL_P2P_RATE=$UPLOAD
#settings leaf qdisc
UP_P2P_RED_PROB=0.05 #red drob probability
UP_P2P_RED_min=32000 #real limit. To limit P2P traffic
UP_P2P_RED_min2=32000 #min for doing the calculations (burst and etc)
UP_P2P_RED_max=$((5 * $UP_P2P_RED_min2 + $UP_P2P_RED_min))
UP_P2P_RED_burst=$(((5 * $UP_P2P_RED_min2) / (3 * 1000)))
UP_P2P_RED_limit=$(($UP_P2P_RED_max * 5))
#normal class
UP_LS_NORMAL_RATE=$(($UPLOAD * 40 / 100))
UP_UL_NORMAL_RATE=$UPLOAD
#settings leaf qdisc
UP_NORMAL_RED_PROB=0.05 #red drob probability
UP_NORMAL_RED_min=6250 #real limit. To limit NORMAL traffic
UP_NORMAL_RED_min2=6250 #min for doing the calculations (burst and etc)
UP_NORMAL_RED_max=$((2 * $UP_NORMAL_RED_min2 + $UP_NORMAL_RED_min))
UP_NORMAL_RED_burst=$(((5 * $UP_NORMAL_RED_min2) / (3 * 1000)))
UP_NORMAL_RED_limit=$(($UP_NORMAL_RED_max * 5))

#prio
UP_LS_PRIO_RATE=$(($UPLOAD*50/100))
UP_RT_PRIO_RATE=&quot;200&quot; #rate in kbit
UP_RT_PRIO_UMAX=&quot;400&quot; #lengte of the packets [byte]
UP_RT_PRIO_DMAX=&quot;15&quot; #delay in ms
UP_UL_PRIO_RATE=$UPLOAD

#Voip
UP_UL_VOIP_RATE=$UPLOAD
UP_SC_VOIP_RATE=&quot;200&quot;
UP_SC_VOIP_UMAX=&quot;350&quot; #length of the voip packets [byte]
UP_SC_VOIP_DMAX=&quot;10&quot; #delay in ms



#!!!!!DOWNLIK leaf class parameters!!!!!!!!!

#bulk
DOWN_LS_BULK_RATE=$(($DOWNLOAD*5/100))
DOWN_UL_BULK_RATE=$DOWNLOAD
#leaf qdisc parameters
DOWN_BULK_RED_PROB=0.05 #red drob probability
DOWN_BULK_RED_min=62500 #real limit. To limit BULK traffic
DOWN_BULK_RED_min2=62500 #min for doing the calculations (burst and etc)
DOWN_BULK_RED_max=$((2 * $DOWN_BULK_RED_min2 + $DOWN_BULK_RED_min))
DOWN_BULK_RED_burst=$(((5 * $DOWN_BULK_RED_min2) / (3 * 1000)))
DOWN_BULK_RED_limit=$(($DOWN_BULK_RED_max * 5))


#P2P
DOWN_LS_P2P_RATE=$(($DOWNLOAD*5/100))
DOWN_UL_P2P_RATE=4000
#leaf qdisc parameters
DOWN_P2P_RED_PROB=0.05 #red drob probability
DOWN_P2P_RED_min=200000 #real limit. To limit P2P traffic
DOWN_P2P_RED_min2=200000 #min for doing the calculations (burst and etc)
DOWN_P2P_RED_max=$((2 * $DOWN_P2P_RED_min2 + $DOWN_P2P_RED_min))
DOWN_P2P_RED_burst=$(((5 * $DOWN_P2P_RED_min2) / (3 * 1000)))
DOWN_P2P_RED_limit=$(($DOWN_P2P_RED_max * 5))

#normal class
DOWN_LS_NORMAL_RATE=$(($DOWNLOAD*75/100))
DOWN_UL_NORMAL_RATE=$DOWNLOAD

#leaf qdisc parameters
DOWN_NORMAL_RED_PROB=0.05 #red drob probability
DOWN_NORMAL_RED_min=62500 #real limit. To limit NORMAL traffic
DOWN_NORMAL_RED_min2=62500 #min for doing the calculations (burst and etc)
DOWN_NORMAL_RED_max=$((2 * $DOWN_NORMAL_RED_min2 + $DOWN_NORMAL_RED_min))
DOWN_NORMAL_RED_burst=$(((5 * $DOWN_NORMAL_RED_min2) / (3 * 1000)))
DOWN_NORMAL_RED_limit=$(($DOWN_NORMAL_RED_max * 5))


#prio
DOWN_RT_PRIO_RATE=&quot;500&quot; #rate in kbit
DOWN_RT_PRIO_UMAX=&quot;400&quot; #length of the packets [byte]
DOWN_RT_PRIO_DMAX=&quot;1.5&quot; #delay in ms
DOWN_UL_PRIO_RATE=$DOWNLOAD


#Voip
DOWN_UL_VOIP_RATE=$DOWNLOAD
DOWN_SC_VOIP_RATE=&quot;250&quot;
DOWN_SC_VOIP_UMAX=&quot;350&quot; #lengt of voip packets [byte]
DOWN_SC_VOIP_DMAX=&quot;1.2&quot; #delay in ms


# The following packages are required for the modules:
# kmod-sched
# kmod-ipt-conntrack
# iptables-mod-conntrack
# kmod-ipt-ipopt
# iptables-mod-ipopt
# kmod-ipt-extra
# iptables-mod-extra

insmod ifb
insmod sch_hfsc
insmod sch_red
insmod sch_sfq
insmod cls_fw
insmod cls_u32
insmod em_u32
insmod act_connmark
insmod act_mirred
insmod sch_ingress

tc qdisc del dev $iface ingress
tc qdisc add dev $iface ingress
ifconfig ifb0 up txqueuelen 5
tc filter add dev $iface parent ffff: protocol ip prio 1 u32 match u32 0 0 flowid 1:1 action connmark action mirred egress redirect dev ifb0

#ecn isn&#039;t supported by default in win7 winXp,... So do not enable ECN of the uplaod qdiscs!!!
ifconfig $iface up txqueuelen 5
tc qdisc add dev $iface stab overhead 44 linklayer atm root handle 1: hfsc default 50 
tc class add dev $iface parent 1: classid 1:1 hfsc sc rate ${UPLOAD}kbit ul rate ${UPLOAD}kbit
tc class add dev $iface parent 1:1 classid 1:10 hfsc sc umax ${UP_SC_VOIP_UMAX}b dmax ${UP_SC_VOIP_DMAX}ms rate ${UP_SC_VOIP_RATE}kbit ul rate ${UP_UL_VOIP_RATE}kbit
tc class add dev $iface parent 1:1 classid 1:20 hfsc rt umax ${UP_RT_PRIO_UMAX}b dmax ${UP_RT_PRIO_DMAX}ms rate ${UP_RT_PRIO_RATE}kbit ls rate ${UP_LS_PRIO_RATE}kbit  ul rate ${UP_UL_PRIO_RATE}kbit
tc class add dev $iface parent 1:1 classid 1:30 hfsc ls rate ${UP_LS_NORMAL_RATE}kbit  ul rate ${UP_UL_NORMAL_RATE}kbit
tc class add dev $iface parent 1:1 classid 1:40 hfsc ls rate ${UP_LS_P2P_RATE}kbit  ul rate ${UP_UL_P2P_RATE}kbit
tc class add dev $iface parent 1:1 classid 1:50 hfsc ls rate ${UP_LS_BULK_RATE}kbit  ul rate ${UP_UL_BULK_RATE}kbit
tc qdisc add dev $iface parent 1:10 handle 100: sfq perturb 2 #limit xxx =&gt;128 is the default limit
tc qdisc add dev $iface parent 1:20 handle 200: sfq perturb 2 #limit xxx =&gt;128 is the default limit
tc qdisc add dev $iface parent 1:30 handle 300: red limit $UP_NORMAL_RED_limit min $UP_NORMAL_RED_min max $UP_NORMAL_RED_max avpkt 1000 burst $UP_NORMAL_RED_burst probability $UP_NORMAL_RED_PROB 
tc qdisc add dev $iface parent 1:40 handle 400: red limit $UP_P2P_RED_limit min $UP_P2P_RED_min max $UP_P2P_RED_max avpkt 1000 burst $UP_P2P_RED_burst probability $UP_P2P_RED_PROB
tc qdisc add dev $iface parent 1:50 handle 500: red limit $UP_BULK_RED_limit min $UP_BULK_RED_min max $UP_BULK_RED_max avpkt 1000 burst $UP_BULK_RED_burst probability $UP_BULK_RED_PROB 
tc filter add dev $iface parent 1: prio 1 protocol ip handle 1 fw flowid 1:10
tc filter add dev $iface parent 1: prio 2 protocol ip handle 2 fw flowid 1:20
tc filter add dev $iface parent 1: prio 3 protocol ip handle 3 fw flowid 1:30
tc filter add dev $iface parent 1: prio 4 protocol ip handle 4 fw flowid 1:40
tc filter add dev $iface parent 1: prio 5 protocol ip handle 5 fw flowid 1:50

tc qdisc add dev ifb0 stab overhead 44 linklayer atm root handle 1: hfsc default 50
tc class add dev ifb0 parent 1: classid 1:1 hfsc sc rate ${DOWNLOAD}kbit ul rate ${DOWNLOAD}kbit
tc class add dev ifb0 parent 1:1 classid 1:10 hfsc sc umax ${DOWN_SC_VOIP_UMAX}b dmax ${DOWN_SC_VOIP_DMAX}ms rate ${DOWN_SC_VOIP_RATE}kbit ul rate ${DOWN_UL_VOIP_RATE}kbit
tc class add dev ifb0 parent 1:1 classid 1:20 hfsc sc umax ${DOWN_RT_PRIO_UMAX}b dmax ${DOWN_RT_PRIO_DMAX}ms rate ${DOWN_RT_PRIO_RATE}kbit ul rate ${DOWN_UL_PRIO_RATE}kbit
tc class add dev ifb0 parent 1:1 classid 1:30 hfsc ls rate ${DOWN_LS_NORMAL_RATE}kbit  ul rate ${DOWN_UL_NORMAL_RATE}kbit
tc class add dev ifb0 parent 1:1 classid 1:40 hfsc ls rate ${DOWN_LS_P2P_RATE}kbit  ul rate ${DOWN_UL_P2P_RATE}kbit
tc class add dev ifb0 parent 1:1 classid 1:50 hfsc ls rate ${DOWN_LS_BULK_RATE}kbit  ul rate ${DOWN_UL_BULK_RATE}kbit
tc qdisc add dev ifb0 parent 1:10 handle 100: sfq perturb 2 #limit xxx =&gt;128 is the default limit
tc qdisc add dev ifb0 parent 1:20 handle 200: sfq perturb 2 #limit xxx =&gt;128 is the default limit
tc qdisc add dev ifb0 parent 1:30 handle 300: red limit $DOWN_NORMAL_RED_limit min $DOWN_NORMAL_RED_min max $DOWN_NORMAL_RED_max avpkt 1000 burst $DOWN_NORMAL_RED_burst probability $DOWN_NORMAL_RED_PROB
tc qdisc add dev ifb0 parent 1:40 handle 400: red limit $DOWN_P2P_RED_limit min $DOWN_P2P_RED_min max $DOWN_P2P_RED_max avpkt 1000 burst $DOWN_P2P_RED_burst probability $DOWN_P2P_RED_PROB
tc qdisc add dev ifb0 parent 1:50 handle 500: red limit $DOWN_BULK_RED_limit min $DOWN_BULK_RED_min max $DOWN_BULK_RED_max avpkt 1000 burst $DOWN_BULK_RED_burst probability $DOWN_BULK_RED_PROB
tc filter add dev ifb0 parent 1: prio 1 protocol ip handle 1 fw flowid 1:10
tc filter add dev ifb0 parent 1: prio 2 protocol ip handle 2 fw flowid 1:20
tc filter add dev ifb0 parent 1: prio 3 protocol ip handle 3 fw flowid 1:30
tc filter add dev ifb0 parent 1: prio 4 protocol ip handle 4 fw flowid 1:40
tc filter add dev ifb0 parent 1: prio 5 protocol ip handle 5 fw flowid 1:50



##########################
#####    IPTABLES    #####
##########################

iptables -t mangle -F QOS
iptables -t mangle -D FORWARD -o $iface -j QOS
iptables -t mangle -D OUTPUT -o $iface -j QOS
iptables -t mangle -X QOS

insmod ipt_layer7
insmod xt_layer7
insmod ipt_connbytes
insmod ipt_tos
insmod ipt_dscp
insmod ipt_length
insmod ipt_CONNMARK
insmod ipt_multiport

iptables -t mangle -N QOS
iptables -t mangle -A FORWARD -o $iface -j QOS
iptables -t mangle -A OUTPUT -o $iface -j QOS

#restore connection mark
iptables -t mangle -A QOS -j CONNMARK --restore-mark

#mark everything before connection mark store
#ICMP packages must by prio
iptables -t mangle -A QOS -s 192.168.0.145 -p icmp -j MARK --set-mark 2

#VoIP packages must be marked
iptables -t mangle -A QOS -p udp -m multiport --sports ${UDP_VOIP} -j MARK --set-mark 1
iptables -t mangle -A QOS -s ${IP_VOIP} -j MARK --set-mark 1
iptables -t mangle -A QOS -d ${IP_VOIP} -j MARK --set-mark 1
#may marked if not yet marked
iptables -t mangle -A QOS -m mark --mark 0 -p tcp -m multiport --dports ${TCP_PRIO} -j MARK --set-mark 2
iptables -t mangle -A QOS -m mark --mark 0 -p udp -m multiport --dports ${UDP_PRIO} -j MARK --set-mark 2
iptables -t mangle -A QOS -m mark --mark 0 -p tcp -m multiport --dports ${TCP_NORMAL} -j MARK --set-mark 3

#P2P traffic
iptables -t mangle -A QOS -s ${IP_P2P} -m mark --mark 0 -p tcp -m multiport --sports ${TCP_P2P} -j MARK --set-mark 4
iptables -t mangle -A QOS -s ${IP_P2P} -m mark --mark 0 -p udp -m multiport --sports ${UDP_P2P} -j MARK --set-mark 4

#bulk traffiek
iptables -t mangle -A QOS -m mark --mark 0 -p tcp --sport ${TCP_BULK} -j MARK --set-mark 5
iptables -t mangle -A QOS -m mark --mark 0 -p udp --sport ${UDP_BULK} -j MARK --set-mark 5
iptables -t mangle -A QOS -m mark --mark 0 -p tcp --dport ${TCP_BULK} -j MARK --set-mark 5
iptables -t mangle -A QOS -m mark --mark 0 -p udp --dport ${UDP_BULK} -j MARK --set-mark 5

#alles moet een mark 3 &quot;normal&quot; krijgen als ze nog niet gemarked zijn. Dit is de enige manier om utorrent te snoeren. By deafault moeten alle pakketen in de P2P class behalve als ze gemarked zijn.
iptables -t mangle -A QOS -m mark --mark 0 -j MARK --set-mark 3


# Save mark onto connection
iptables -t mangle -A QOS -j CONNMARK --save-mark

#reclasify any packets #zeker nog te bekijken welke flags we moeten zetten!!
#iptables -t mangle -A QOS -p tcp -m length --length :128 -m mark ! --mark 4 -m mark ! --mark 5 -m tcp --tcp-flags SYN,RST,ACK ACK -j MARK --set-mark 2

#debugging

[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A mark_chain -m mark --mark 0 -j LOG --log-prefix mark_0::
[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A mark_chain -m mark --mark 0 -j ACCEPT
[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A mark_chain -m mark --mark 1 -j LOG --log-prefix mark_1::
[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A mark_chain -m mark --mark 1 -j ACCEPT
[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A mark_chain -m mark --mark 2 -j LOG --log-prefix mark_2::
[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A mark_chain -m mark --mark 2 -j ACCEPT
[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A mark_chain -m mark --mark 3 -j LOG --log-prefix mark_3::
[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A mark_chain -m mark --mark 3 -j ACCEPT
[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A mark_chain -j LOG --log-prefix mark_other::

[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A ingress_chain -m mark --mark 0 -j LOG --log-prefix ingress_0::
[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A ingress_chain -m mark --mark 0 -j ACCEPT
[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A ingress_chain -m mark --mark 1 -j LOG --log-prefix ingress_1::
[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A ingress_chain -m mark --mark 1 -j ACCEPT
[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A ingress_chain -m mark --mark 2 -j LOG --log-prefix ingress_2::
[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A ingress_chain -m mark --mark 2 -j ACCEPT
[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A ingress_chain -m mark --mark 3 -j LOG --log-prefix ingress_3::
[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A ingress_chain -m mark --mark 3 -j ACCEPT
[ $DEBUG -eq 1 ] &amp;&amp; iptables -t mangle -A ingress_chain -j LOG --log-prefix ingress_other::</code></pre></div><p>Qdisc hierarchy<br /><span class="postimg"><img src="http://img849.imageshack.us/img849/4417/hfschiarchieopenwrttomv.jpg" alt="http://img849.imageshack.us/img849/4417/hfschiarchieopenwrttomv.jpg" /></span></p>											<p class="post-edited">(Last edited by <strong>TomVH</strong> on 17 Jan 2012, 22:38)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p154537">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">TomVH</div>
					<div class="post-datetime">
						17 Jan 2012, 22:48					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><blockquote><p>If I remember correctly, Black Russian had two qos implementations. One of them became <a href="http://downloads.openwrt.org/backfire/10.03.1/brcm47xx/packages/qos-scripts_1.2.1-3.2_all.ipk">stock</a> implementation. <em>This</em> is the upgrade of another one, correct?</p></blockquote></div><p>yes</p><div class="quotebox"><blockquote><p>So, in order to use this, I need to uninstall qos-scripts, right?</p></blockquote></div><p>yes<br /></p><div class="quotebox"><blockquote><p>Is it compatible with luci UI?</p></blockquote></div><p>I think rudy&#039;s script isn&#039;t compatible with luci UI. I&#039;m quite sure.</p><div class="quotebox"><blockquote><p>but is there a way to see performance difference differences between two versions?</p></blockquote></div><p>check the RTT of ICMP packets in the prio class?<br />I don&#039;t know if this is a good method but in my case it works well. I have 2 PC&#039;s. ICMP packets of 1 PC are prio packets and ICMP packets of the other PC are bulk, normal or P2P packets. The difference is amazing <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" />. (in my script but probably it&#039;s also possible in the other scripts).</p><p>sorry for my bad English.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p154544">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">ymhee_bcex</div>
					<div class="post-datetime">
						17 Jan 2012, 23:38					</div>
				</div>
				<div class="post-content content">
					<p>TomVH, your English is fine... don&#039;t worry!</p><p>When I asked about performance difference, I meant difference between this script and stock script. When you write about checking the RTT of ICMP packets in the prio class - you probably mean the difference between having qos script and <em>not</em> having qos script - right? or the difference between different packets affected by qos script.</p><p>Either way, that doesn&#039;t help me to answer the question &quot;how is this script better than the stock script&quot;.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p154549">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">dir2cas</div>
					<div class="post-datetime">
						18 Jan 2012, 00:55					</div>
				</div>
				<div class="post-content content">
					<p>Hello rudy, thanks for sharing your work - it is realy useful. I initially discovered your thread in the WhiteRussian section before and was really glad to see your backfire port.</p><p>I searched for a QoS solution for my network and started working on my own script that turned into an alternative QoS architecture. It is inspired by your script and shares several common features with it. <br />Right now, I am at the moment of&nbsp; testing it and will share the results soon - hope that all of you may find some useful ideas implemented in it. I strive to do it highly customizable and comprehensive. One of the main ideas is to have a multiple QoS interfaces support with different configurations for each option per interface - separate bandwidth, priority, etc. <br />Hope to finish testing successfully, probably I wiil create a new topic.</p><div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Thank you! I will give it a good try.</p><p>I have two remarks:<br />- Could you use a mark mask in the iptable-rules? This make the script more compatible with other apps that use the iptables mark action.<br />- I have three WAN interfaces. Could you make the script more multi-wan friendly?</p></blockquote></div><p>Hope that my solution will work in your case.</p>											<p class="post-edited">(Last edited by <strong>dir2cas</strong> on 18 Jan 2012, 02:02)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p154740">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">TomVH</div>
					<div class="post-datetime">
						19 Jan 2012, 22:44					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ymhee_bcex wrote:</cite><blockquote><p>Either way, that doesn&#039;t help me to answer the question &quot;how is this script better than the stock script&quot;.</p></blockquote></div><p>You can test both. I explained how you can test both scripts.</p><p>Witch QoS script is the best? That is a difficult question. I think the stock script is really good but the implementation of the overhead calculation and configurable leaf qdiscs are really necessary. </p><p>Does anyone know how to ask change requests to the nbd’s QoS script? The ticket system?</p><p>Write your own script or modify the stock script (nbd&#039;s one). Why:</p><p>1)&nbsp; &nbsp; rudy&#039;s and nbd&#039;s script don&#039;t use PPP and ATM overhead calculation. VoIP AND P2P use small Ethernet packets. The overhead (PPP, ATM headers) are not countered by TC by default. So it’s important to use the stab option because overhead takes a part of your bandwidth. If you use VoIP and P2P the overhead can be 20% (or more) of your total available bandwidth. Use wireshark to determine the packet-length of some applications.</p><p>2)&nbsp; &nbsp; Nbd’s script uses the ECN option of the RED leaf qdiscs but I think most of the internet servers don’t support ECN. Win7, ubuntu, WinXP, Win2k don’t support ECN by default. So don’t use ECN.</p><p>3)&nbsp; &nbsp; Rudy’s script use RED leaf qdiscs. He calculates de “min” value by “5*MTU” and mtu=1600byte. If you have a downloadspeed of 5000kbit then t=5*1600byte*8bit/5000kbit=12 ms. I think A queue length of 12 ms is to low. To many packets are dropped. I use a default queue length of 100 ms and is works great with http (vimeo, youtube) traffic. I use a queue length of 300 ms voor P2P (µtorrent) and RTT of prioritized packets are good. Smaller queues results in larger ICMP RTT (probably because to many packets are dropped and the P2P congestion algorithm reacts wrong). You can use small queues in the UPLOAD part but in the download qdiscs I think it’s better to use a longer queue in leaf qdisc. Especially a large queue for µtorrent seems to work well. <strong>Maybe there are other people who could test the effect of the queue length with P2P applications?</strong> Non of the QoS script use different queue lengths for the different classes. Nbd’s one use a queue length of 50 ms for non prio/express classes. Gargoyle use leaf queues of 200 ms.</p><p>4)&nbsp; &nbsp; Rudy use the term “burst” in HFSC. In my view, the leaf qdisc take care of the burst and not the HFSC algorithm. HFSC is used to reduce delay.</p><p>5)&nbsp; &nbsp; Rudy don’t use the linkshare criterium. He only uses “SC” service curves. (SC combines a linkshare (LS) service cure and a realtime (RT) service curve). If every class starts sending at once, HFSC exceeds the max linespeed!! It’s not necessary to use RT service curves for all classes. Just use RT service curves to the prio classes (VoIP, gaming,…) and use LS service curves for the other classes.</p><p>If you want some good links to study HFSC and iptables in linux, ask me and i will post some good links to start studying QoS, HFSC, RED,...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155178">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">dir2cas</div>
					<div class="post-datetime">
						23 Jan 2012, 21:54					</div>
				</div>
				<div class="post-content content">
					<p>Hello rudy, TomVH and all interested,</p><p>Did you manage to find a solution for your script for <a href="http://www.gargoyle-router.com/phpbb/viewtopic.php?f=7&amp;t=638">this issue</a>? Since I examined your code and found that you are also jumping to IMQ from INPUT and FORWARD, which is causing the traffic destined to the local process (router itself) not to be handled by IMQ and therefore not classified. I notised that while testing my architecture that I am building now (as I mentioned).</p><p>Example - we have a router generated downlink traffic - let&#039;s say a wget downloading a lagre file on the router (or to /dev/null for testing) filling your bandwidth. I noticed that this traffic is passing all marking rules OK and is going (jumping) to the IMQ device as well (I can see counters accumulating in iptables -t mangle -vS) but this is not handled by the imq0 interface itself - its counters remaining unchanged. This causes the traffic not to be passed to the interface qdiscs and therefore it is not classified (tc -s -d class/qdisc show dev imq0&nbsp; also does not detect activity).</p><p>I am working on finding a solution probably using another chain on PREROUTING stage in which will only try to restore the previously set CONNMARK, relaying on the egress marking of a connection(session). This is a similar concept to that suggested in the link above (gargoyle). Even if this fixes the problem we will still be unable to catch non connection-oriented traffic dedicated to the router.</p><p>Did you also notice this issue, if yes, what is your solution. If I succeeded I will update you as well.</p><p>Regards,</p>											<p class="post-edited">(Last edited by <strong>dir2cas</strong> on 23 Jan 2012, 21:59)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155205">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">TomVH</div>
					<div class="post-datetime">
						24 Jan 2012, 09:54					</div>
				</div>
				<div class="post-content content">
					<p>-You have to mark only outgoing packets. <br />-So, use the output (router traffic) and forward (LAN traffic) chain to do this<br />-Use the &quot;save mark&quot; connmark target to save a packet mark tot the connection mark.</p><p>If you only allow established and related traffic (default firewall rule) on your network, than I see no problem. Non established or Related packets are dropped by default!!.</p><p>Read &quot;chapter 7. the state machine&quot; of the IPtables tutorial to understand it.<br /></p><div class="quotebox"><cite>Iptables tutorial chapt. 7. wrote:</cite><blockquote><p>UDP connections are in themselves not statefull connections, but rather stateless. There are several reasons<br />why, mainly because they don&#039;t contain any connection establishment or connection closing; most of all they<br />lack sequencing. Receiving two UDP datagrams in a specific order does not say anything about the order in<br />which they were sent. It is, however, still possible to set states on the connections within the kernel. Let&#039;s have<br />a look at how a connection can be tracked and how it might look in conntrack.</p></blockquote></div><p>Now we don&#039;t now when the connection mark is set but I think it’s before the mangle prerouting chain. Probably you can use the &quot;netfilter hooks&quot; in google to find the answer. </p><p>In my case, ICMP packets from IP 192.168.0.145 are send to class 200: and it works!!. I&#039;m sure.</p><p>I use the trunk version and i think the trunk version of OpenWrt doesn&#039;t support IMQ anymore. ndb has written iptables connmark_act patch to restore the connection marks before the packets enter the IFB device.</p><p>I see only one problem: broadcast traffic (IPTV). Maybe it&#039;s possible to mark incoming iptv packets by the restore-mark connmark action. I don&#039;t know because i have no IPTV applications.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155214">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">Orca</div>
					<div class="post-datetime">
						24 Jan 2012, 11:09					</div>
				</div>
				<div class="post-content content">
					<p>I take the offer!</p><p>Do you want to work on <a href="http://wiki.openwrt.org/packet_scheduler">OpenWrt - QoS (Quality of Service)</a>?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155571">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">dir2cas</div>
					<div class="post-datetime">
						27 Jan 2012, 19:54					</div>
				</div>
				<div class="post-content content">
					<p>In fact I managed to cope with the local processes traffic (destined to the router itself), by using a little different concept, than the strategy I used for traffic flow marking till now.<br />Egress: inspected in:<br /> OUTPUT chain (for local processes traffic)<br /> FORWARD chain (for traffic routed though the device), generated from the LAN</p><p>Ingress : inspected in:<br /> PREROUTING - next the traffic is thrown in the IMQ device (I use it only once here)</p><p>Combined with the proper CONNMARK rules and a optimizing the packet inspection flow through my QoS policy, the desired result was achieved - even with a little less CPU utilization than the default qos-scripts package.<br />Now both forwarded and router&#039;s traffic is properly classified.</p><p>Well, all is right, but while testing my solution today I noticed another interesting issue. All packets get classified correctly&nbsp; - I mean properly matched by in my iptables rules via the Qos Policy and after that properly classified. <br />But, when the bandwidth limit configured by me for the classes (I used bandwidht sharing strategy) is greater than the currently available through my ISP, the traffic is not handled right despite the fact that it is classified correclt. It seems that each class sees it has more bandwith (tokens available) and none of the classes gets a priority over the others correctly - it can be seen as the ping delay remains high despite it is classified with highest priority.</p><p>I can see that 2x Wget processes downloading a large files, together with my IPTV and icmp test are running but none gets a real preference over the others. When I set my BW to be equal or less than the currently available one, all looks rights and goes smoothly. I am sure all traffic get correct marking and priority<br /></p><div class="codebox"><pre><code>[root@Core-Sf:~]# tc -s -d class show dev imq0
class htb 1:1 root rate 26128Kbit ceil 26128Kbit burst 146970b/8 mpu 0b overhead 0b cburst 146970b/8 mpu 0b overhead 0b level 7 
 Sent 132665411 bytes 88786 pkt (dropped 0, overlimits 0 requeues 0) 
 rate 22144Kbit 1853pps backlog 0b 0p requeues 0 
 lended: 51370 borrowed: 0 giants: 0
 tokens: 695669 ctokens: 695669

class htb 1:10 parent 1:1 leaf 10: prio 1 quantum 1522 rate 2048Kbit ceil 26128Kbit burst 48989b/8 mpu 0b overhead 0b cburst 48990b/8 mpu 0b overhead 0b level 0 
 Sent 829463 bytes 885 pkt (dropped 0, overlimits 0 requeues 0) 
 rate 139024bit 19pps backlog 0b 0p requeues 0 
 lended: 885 borrowed: 0 giants: 0
 tokens: 2739399 ctokens: 225678

class htb 1:20 parent 1:1 leaf 20: prio 3 quantum 1522 rate 1024Kbit ceil 26128Kbit burst 48989b/8 mpu 0b overhead 0b cburst 48990b/8 mpu 0b overhead 0b level 0 
 Sent 43276500 bytes 28851 pkt (dropped 0, overlimits 0 requeues 0) 
 rate 8075Kbit 673pps backlog 0b 0p requeues 0 
 lended: 3863 borrowed: 24988 giants: 0
 tokens: -141752 ctokens: 223089

class htb 1:30 parent 1:1 leaf 30: prio 6 quantum 1522 rate 512000bit ceil 23515Kbit burst 48989b/8 mpu 0b overhead 0b cburst 48984b/8 mpu 0b overhead 0b level 0 
 Sent 42405948 bytes 28281 pkt (dropped 0, overlimits 0 requeues 0) 
 rate 6315Kbit 526pps backlog 0b 0p requeues 0 
 lended: 1984 borrowed: 26297 giants: 0
 tokens: -32543 ctokens: 252422

class htb 1:40 parent 1:1 leaf 40: prio 2 quantum 1522 rate 12288Kbit ceil 26128Kbit burst 48987b/8 mpu 0b overhead 0b cburst 48990b/8 mpu 0b overhead 0b level 0 
 Sent 46153500 bytes 30769 pkt (dropped 0, overlimits 0 requeues 0) 
 rate 7616Kbit 635pps backlog 0b 0p requeues 0 
 lended: 30684 borrowed: 85 giants: 0
 tokens: 23583 ctokens: 226616

[root@Core-Sf:~]# tc -s -d filter show dev imq0
filter parent 1: protocol ip pref 1 fw 
filter parent 1: protocol ip pref 1 fw handle 0xa classid 1:10 
filter parent 1: protocol ip pref 2 fw 
filter parent 1: protocol ip pref 2 fw handle 0x28 classid 1:40 
filter parent 1: protocol ip pref 3 fw 
filter parent 1: protocol ip pref 3 fw handle 0x14 classid 1:20 
filter parent 1: protocol ip pref 6 fw 
filter parent 1: protocol ip pref 6 fw handle 0x1e classid 1:30</code></pre></div><p>1:40 is my IPTV that should be around 12Mbps (HD channel) but now shares the BW with the wget running in class 1:20 that as you can see has lower prio. </p><p>Any idea? This is a real proiblem, because the available bandwidth through my and most of the ISPs is not always the same.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155722">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">TomVH</div>
					<div class="post-datetime">
						29 Jan 2012, 15:18					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>OUTPUT chain (for local processes traffic)<br />FORWARD chain (for traffic routed though the device), generated from the LAN</p></blockquote></div><p>Rudy and nbd also use the output en forward chain.</p><div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>even with a little less CPU utilization than the default qos-scripts package.</p></blockquote></div><p>nbd&#039;s scripts uses HFSC and your script is based on HTB. You can’t compare them!</p><div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>But, when the bandwidth limit configured by me for the classes (I used bandwidht sharing strategy) is greater than the currently available through my ISP, the traffic is not handled right despite the fact that it is classified correclt. It seems that each class sees it has more bandwith (tokens available) and none of the classes gets a priority over the others correctly - it can be seen as the ping delay remains high despite it is classified with highest priority.</p></blockquote></div><p>UPLOAD:<br />If you allocate more bandwidth than available through you ISP, you are filling up your modem’s queue. High RTT (ICMP packets) is the result of filling up your modem’s queue.</p><p>DOWNLOAD:<br />You have to allocate a bandwidth of max 90% of your available bandwidth AND use good leaf qdisc (RED, SFQ,...) and don&#039;t allow burst traffic.&nbsp; Your ISP queue handles burst traffic.</p>											<p class="post-edited">(Last edited by <strong>TomVH</strong> on 29 Jan 2012, 15:42)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155748">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">dir2cas</div>
					<div class="post-datetime">
						29 Jan 2012, 17:37					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>TomVH wrote:</cite><blockquote><div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>OUTPUT chain (for local processes traffic)<br />FORWARD chain (for traffic routed though the device), generated from the LAN</p></blockquote></div><p>Rudy and nbd also use the output en forward chain.</p><div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>even with a little less CPU utilization than the default qos-scripts package.</p></blockquote></div><p>nbd&#039;s scripts uses HFSC and your script is based on HTB. You can’t compare them!</p></blockquote></div><p>Indeed the default openwrt qos-scripts package is using hfsc, but since both are intended doing the same thing I do not see an obstacle to compare them, however finding the most effective solution is my goal. If look in the first post there are 2 versions of rudy&#039;s scrpt - one that uses htb and one that uses hfsc.... since I have not used them, my comparrioson was between my script and the qos-scripts package that is much different than these ones.<br /></p><div class="quotebox"><cite>TomVH wrote:</cite><blockquote><div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>But, when the bandwidth limit configured by me for the classes (I used bandwidht sharing strategy) is greater than the currently available through my ISP, the traffic is not handled right despite the fact that it is classified correclt. It seems that each class sees it has more bandwith (tokens available) and none of the classes gets a priority over the others correctly - it can be seen as the ping delay remains high despite it is classified with highest priority.</p></blockquote></div><p>UPLOAD:<br />If you allocate more bandwidth than available through you ISP, you are filling up your modem’s queue. High RTT (ICMP packets) is the result of filling up your modem’s queue.<br />In fact the upload router&#039;s queue is not full because during these tests my upload is not more than 1Mbps, as you can see I have much more.<br />DOWNLOAD:<br />You have to allocate a bandwidth of max 90% of your available bandwidth AND use good leaf qdisc (RED, SFQ,...) and don&#039;t allow burst traffic.&nbsp; Your ISP queue handles burst traffic.</p></blockquote></div><p>I am using sfq for my leaf classes, the problem is that my bandwith is not always constant, anyway I do not want to limit myself to 90% of my Internet speed when 100% of it is available. I suppose you mean to limit the ceil rate for every class to 90% of my Download speed, right?<br />Is there any other solution?</p>											<p class="post-edited">(Last edited by <strong>dir2cas</strong> on 29 Jan 2012, 17:38)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155768">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">TomVH</div>
					<div class="post-datetime">
						29 Jan 2012, 21:40					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>my comparrioson was between my script and the qos-scripts package that is much different than these ones.</p></blockquote></div><p>much different? What&#039;s the difference?</p><div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>Indeed the default openwrt qos-scripts package is using hfsc, but since both are intended doing the same thing I do not see an obstacle to compare them,</p></blockquote></div><p>HTB and HFSC are the same?<br />I’ve never worked with HTB but can you guarantee low delay for VoIP packets? With HFSC it’s possible.</p><div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>I am using sfq for my leaf classes, the problem is that my bandwith is not always constant, anyway I do not want to limit myself to 90% of my Internet speed when 100% of it is available. I suppose you mean to limit the ceil rate for every class to 90% of my Download speed, right?<br />Is there any other solution?</p></blockquote></div><p>right!</p><p><strong>UPLOAD:</strong><br />Set the max root class rate (ceil in htb and ul in HFSC) to the max linespeed minus the overhead.<br />Example:<br />I have a upload line speed of 640 kbps. If I use only applications which send small packets, the overhead can be 50% of your bandwidth. So I have to set the “ceil parameter” to 320 kbit.<br />If I use only applications which send large packets, the overhead is small. <br />If I have applications which send large AND small packets, I can use the TC stab option and set “ceil” parameter (ul in HFSC) to 620 kbit (maybe 640 kbit is also possible).</p><p>It’s IMPOSSIBLE to guarantee low delay and bandwidth allocations if the ceil parameter is not lower than the max linespeed (minus the overhead if you don’t use the tc stab option).</p><p><strong>DOWNLOAD</strong><br />If you will guarantee low delay and bandwidth, you have to set the “ceil”parameter much lower than the max linespeed. <br />At home I have a linespeed of 6140 kbit and I set the ul parameter (ceil in htb) of the root class to 5000kbit. 20 % lower than the max linespeed !!<br /><strong>Why:</strong><br />It’s only possible to slow down TCP and(and some udp) traffic to drop packets AND/OR make large queues at your router. It’s only possible to fill the router’s queue if you set the max speed (much) lower than the max linespeed.</p><p>It’s IMPOSSIBLE to guarantee low delay and bandwidth allocations if the ceil parameter is not lower than the max linespeed (minus the overhead if you don’t use the tc stab option).</p><p>If your ISP delivers you a variable speed: read <a href="http://www.gargoyle-router.com/phpbb/viewtopic.php?f=7&amp;t=754">this</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155790">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">dir2cas</div>
					<div class="post-datetime">
						30 Jan 2012, 01:12					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>TomVH wrote:</cite><blockquote><p>[</p><div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>Indeed the default openwrt qos-scripts package is using hfsc, but since both are intended doing the same thing I do not see an obstacle to compare them,</p></blockquote></div><p>HTB and HFSC are the same?<br />I’ve never worked with HTB but can you guarantee low delay for VoIP packets? With HFSC it’s possible.</p></blockquote></div><p>I think that you did not get it right! I did not say that htb and hfsc are the same, but that the general (not meaning the particular features of both of them) idea behind them is same - QoS. <br /></p><div class="quotebox"><cite>TomVH wrote:</cite><blockquote><div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>I am using sfq for my leaf classes, the problem is that my bandwith is not always constant, anyway I do not want to limit myself to 90% of my Internet speed when 100% of it is available. I suppose you mean to limit the ceil rate for every class to 90% of my Download speed, right?<br />Is there any other solution?</p></blockquote></div><p>right!</p><p><strong>UPLOAD:</strong><br />Set the max root class rate (ceil in htb and ul in HFSC) to the max linespeed minus the overhead.<br />Example:<br />I have a upload line speed of 640 kbps. If I use only applications which send small packets, the overhead can be 50% of your bandwidth. So I have to set the “ceil parameter” to 320 kbit.<br />If I use only applications which send large packets, the overhead is small. <br />If I have applications which send large AND small packets, I can use the TC stab option and set “ceil” parameter (ul in HFSC) to 620 kbit (maybe 640 kbit is also possible).</p><p>It’s IMPOSSIBLE to guarantee low delay and bandwidth allocations if the ceil parameter is not lower than the max linespeed (minus the overhead if you don’t use the tc stab option).</p><p><strong>DOWNLOAD</strong><br />If you will guarantee low delay and bandwidth, you have to set the “ceil”parameter much lower than the max linespeed. <br />At home I have a linespeed of 6140 kbit and I set the ul parameter (ceil in htb) of the root class to 5000kbit. 20 % lower than the max linespeed !!<br /><strong>Why:</strong><br />It’s only possible to slow down TCP and(and some udp) traffic to drop packets AND/OR make large queues at your router. It’s only possible to fill the router’s queue if you set the max speed (much) lower than the max linespeed.</p><p>It’s IMPOSSIBLE to guarantee low delay and bandwidth allocations if the ceil parameter is not lower than the max linespeed (minus the overhead if you don’t use the tc stab option).</p><p>If your ISP delivers you a variable speed: read <a href="http://www.gargoyle-router.com/phpbb/viewtopic.php?f=7&amp;t=754">this</a></p></blockquote></div><p>Thanks for the link, I will read it and try to figure out if I will be able to implement it in my script. I wanted to finish it fully before posting any code here, so excuse me if I do not provide the full details in order to make the troubleshooting easier.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155813">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">TomVH</div>
					<div class="post-datetime">
						30 Jan 2012, 08:51					</div>
				</div>
				<div class="post-content content">
					<p>I don&#039;t understand why you use HTB. A couple of months ago, I read a lot of documentation. After reading this documentation, I was convinced to use HFSC instead of HTB. And you?</p><p><strong><a href="http://linux-ip.net/articles/hfsc.en/">HFSC scheduling with linux</a></strong><br />For complex traffic shaping scenarios, hierarchical algorithms are necessary. Current versions of Linux support the algorithms HTB and HFSC. While <strong>HTB</strong> basically rearranges token bucket filter (TBF) into a hierarchical structure, thereby retaining the principal characteristics of TBF, HFSC allows proportional distribution of bandwidth as well as control and allocation of latencies. This allows for better and more efficient use of a connection for situations in which both bandwidth intensive data services and interactive services share a single network link.</p><p><strong><a href="http://www.linuxhowtos.org/manpages/7/tc-hfsc.htm">HIERARCHICAL FAIR SERVICE CURVE&nbsp; History &amp; Introduction</a></strong><br />In short HFSC aims to:</p><p>1) guarantee precise bandwidth and delay allocation for all leaf classes (realtime criterion) <br />2) allocate excess bandwidth fairly as specified by class hierarchy (linkshare &amp; upperlimit criterion) <br />3) minimize any discrepancy between the service curve and the actual amount of service provided during linksharing </p><p>The main &quot;selling&quot; point of HFSC is feature (1), which is achieved by using nonlinear service curves (more about what it actually is later). This is particularly useful in VoIP or games, where not only guarantee of consistent bandwidth is important, but initial delay of a data stream as well. Note that it matters only for leaf classes (where the actual queues are) - thus class hierarchy is ignored in realtime case.</p><p>Feature (2) is well, obvious - any algorithm featuring class hierarchy (such as <strong>HTB</strong> or CBQ) strives to achieve that. HFSC does that well, although you might end with unusual situations, if you define service curves carelessly - see section CORNER CASES for examples.</p><p>Feature (3) is mentioned due to the nature of the problem. There may be situations where it&#039;s either not possible to guarantee service of all curves at the same time, and/or it&#039;s impossible to do so fairly. Both will be explained later. Note that this is mainly related to interior (aka aggregate) classes, as the leafs are already handled by (1). Still - it&#039;s perfectly possible to create a leaf class w/o realtime service, and in such case - the caveats will naturally extend to leaf classes as well.</p><p><strong>Please tell us in words the difference between your script and nbd&#039;s one / rudy&#039;s one. What are the different goals/objectives?</strong><br />The goals of my script:<br /></p><ul><li><p>use of 2 VoIP applications with a max delay of 10 ms upload and 1 ms download =&gt; HFSC</p></li><li><p>high bandwidth allocation to HTTP and other &quot;important&quot; traffic =&gt; IP tables and HFSC</p></li><li><p>use of P2P applications (µtorrent) if bandwidth is available =&gt; HFSC and RED</p></li><li><p>max throughput =&gt; TC stab</p></li></ul><p>result: see the first picture of my post &quot;Qdisc hierarchy&quot;<br />My linespeeds are stable, so I don&#039;t need the speed correction.</p><p>I think the nbd&#039;s script is good but:<br /></p><ul><li><p>there is a lack of documentation. I will write some documentation if the leaf qdisc are configurable and the TC stab option is implemented.</p></li><li><p>no overhead calculation</p></li><li><p>leaf qdisc are not configurable</p></li><li><p>no speed correction</p></li><li><p>maybe wrong calculation of service curves.</p></li></ul>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155814">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">TomVH</div>
					<div class="post-datetime">
						30 Jan 2012, 09:02					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Orca wrote:</cite><blockquote><p>I take the offer!</p><p>Do you want to work on <a href="http://wiki.openwrt.org/packet_scheduler">OpenWrt - QoS (Quality of Service)</a>?</p></blockquote></div><p>Ok, If I have some time, I will participate but i think it&#039;s much much much more important to write some documentation of the <a href="http://wiki.openwrt.org/doc/uci/qos">nbd&#039;s script</a>, implement the stab option and make it possible to configure the leaf qdiscs.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155856">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">dir2cas</div>
					<div class="post-datetime">
						30 Jan 2012, 18:03					</div>
				</div>
				<div class="post-content content">
					<p>TomVH, thanks for sharing your experince, anyway, I&#039;ve also read about HFSC (not so few as you think) and linux tc and packet scheduler machine. The main reason for using HTB is that its configuration is cleaner and simplier and because of its realtive cpu effectiveness, that is important when dealing with QoS on an embedded device. </p><p>Since I have pretty wide WAN bandwidth (24 Mbps is an average linespeed in my country, but it is enough for me) the main goal was to be able to download files with the maximum possible speed without eating the needed bandwidth for my IPTV (especially while watching HD channels) and of course - wanted to do it on my own, starting from scratch and learn how all this works as well. In fact my script is doing the job pretty good. I included several additional features in my design keeping it as highly customizable as possible. Well, as I wrote the only problem I faced till now is the link saturation varying the linespeed from my provider from time to time. Initially I thought that the prio parameter of tc (and htb in particular) would cope with that, but as you explained without setting the proper bandwidth limit to be under your linespeed provided by your ISP - it will not be possible.</p><p>I am now interested in tc stab option. <br /></p><div class="quotebox"><cite>TomVH wrote:</cite><blockquote><p>My linespeeds are stable, so I don&#039;t need the speed correction.</p></blockquote></div><p>Since it aims to calculate L2 protocol overhead properly, how it aims to outsand variations of the available linespeed? I am ready to alter my architecture using tc stab and hfsc as classful queueing if I can achieve proper qos traffic handling without doing link cotrollers, etc, like suggested in the link to the Gargoyle thread that you gave above.</p>											<p class="post-edited">(Last edited by <strong>dir2cas</strong> on 30 Jan 2012, 18:06)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155870">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">TomVH</div>
					<div class="post-datetime">
						30 Jan 2012, 23:12					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>TomVH, thanks for sharing your experince, anyway, I&#039;ve also read about HFSC (not so few as you think) and linux tc and packet scheduler machine. The main reason for using HTB is that its configuration is cleaner and simplier and because of its realtive cpu effectiveness, that is important when dealing with QoS on an embedded device.</p></blockquote></div><p>Where have you read that HTB is more “CPU effective”</p><div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>Since I have pretty wide WAN bandwidth (24 Mbps is an average linespeed in my country, but it is enough for me) the main goal was to be able to download files with the maximum possible speed without eating the needed bandwidth for my IPTV (especially while watching HD channels) and of course - wanted to do it on my own, starting from scratch and learn how all this works as well.</p></blockquote></div><p><strong>I suppose that you have a xDSL line and not cable (coax)?</strong></p><p>Here (in Belgium) there are different xDSL profiles. Example the 30/6 or the 50/6 “profile”. So the download sync speed of the line is 30000kbit (bit per seconds) and the upload sync speed is 6000kbit. These values shows how many packets could be send on the wire (inclusive PPP,… overhead). <strong>BUT</strong> this does not mean that ISP delivers you 30000kbit. Here the ISP limit the available bandwidth to 25000kbit download / 3000kbit upload. So you can’t use (30000kbit-25000kbit=)5000kbit. <strong>BUT</strong> the 5000kbit can be used by IPTV. I don’t know if I use the correct terms (sync speed,…)</p><p>Suppose a IPTV use a bandwidth of 6000bit.<br />0 IPTV’s active =&gt; 25000kbit available (for browsing, downloading,….)<br />1 IPTV active =&gt; 30000kbit-6000kbit=24000kbit available (for browsing, downloading,….)<br />2 IPTV’s active =&gt; 30000kbit – 12000kbit = 18000kbit available (for browsing, downloading,….)</p><p>Maybe is this causes the variable speed?</p><p>Here the ISP delivers a modem/router and use Vlans to separate IPTV / VOIP and Internet. Below a suggestion to solve this problem:<br /><span class="postimg"><img src="http://img267.imageshack.us/img267/8461/hfschiarchieopenwrtiptv.jpg" alt="http://img267.imageshack.us/img267/8461/hfschiarchieopenwrtiptv.jpg" /></span><br />I don’t have a fast VDSL link and no IPTV because VDSL is not available here. I have only a slow adsl link (6140kbit/640kbit). So I have no experience with IPTV and vlans,.... It&#039;s just a suggestion.</p><div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>I am now interested in tc stab option. <br />Since it aims to calculate L2 protocol overhead properly, how it aims to outsand variations of the available linespeed?</p></blockquote></div><p>TC-stab only modify the packet size calculation to take overhead into account. It do not solve the variable linespeed problem.</p><div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>I am ready to alter my architecture using tc stab and hfsc as classful queueing if I can achieve proper qos traffic handling without doing link cotrollers, etc, like suggested in the link to the Gargoyle thread that you gave above.</p></blockquote></div><p>“speed controlling” like Gargoyle is really necessary if:<br />-your xdsl speed isn’t constant. But I think xdsl (ADSL / VDSL) sync speed are always constant? Maybe you can read something about VDSL to find out the right answer. I only know that VDSL don’t use ATM encapsulation but Ethernet frames.<br />- your ISP limit your speed and this limitations isn’t constant.</p><p>Why I use HFSC? (below the explanations for <strong>upload</strong>)<br />I think with HTB you can’t control the real-time speed. If a class start sending, the first packet(s) (=burst) are sent at maximum speed. So the max available bandwidth is exceeded. If you don’t use burst in HTB, it’s impossible to guarantee low delays:<br />Example: Voip packets are 400byte. Assume I have a upload speed of 1Mbit. =&gt; it takes 400byte/1Mbit=3,2 ms to send a packet. The VoIP app sends packets at 100 kbit = 31 packets per second. In order to meet het guaranteed 100kbit, the qdisc must send a packet every (1s/31packets=)32 ms. The max delay of HTB is 32 ms.<br />In HFSC you can reduce the delay to 3,2 ms.</p><p>Have you already test your script with ICMP packets?.<br />I have a line speed of 640kbit<br />If my line is empty, the RTT of ICMP packets to 8.8.8.8 (google dns) is 22 ms.<br />ICMP packets are 84byte long. The first slope of the prio class is 300kbit. Assume there is a packet overhead of 50 %. So the packet size = 168byte . =&gt; every (168*8/300=)4,48 ms HFSC dequeues a packet of the prio class.<br />If there is already a packet of 1500byte in the modem&#039;s queue, it takes (1500*8+overhead)/640kbit= 20 ms to send a packet.<br />IF HFSC does his job, the total RTT may never exceeds (22ms + 20ms +4,48ms = ) 46,48 ms. <br />If I saturate the uplink, the delay of ICMP packet never exceed 45 ms. So IT WORKS</p>											<p class="post-edited">(Last edited by <strong>TomVH</strong> on 4 Feb 2012, 11:48)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155958">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">adam2104</div>
					<div class="post-datetime">
						1 Feb 2012, 05:04					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m curious, why use the OUTPUT and FORWARD chains in the mangle table? I&#039;ve got my own little QoS script that I use and I hook everything into the POSTROUTING chain. This captures both forwarding traffic and also router sourced traffic. This is the relevant part of my script:</p><div class="codebox"><pre><code>DEV=eth1
iptables -t mangle -N adam_qos_$DEV &amp;&gt; /dev/null
iptables -t mangle -F adam_qos_$DEV &amp;&gt; /dev/null
iptables -t mangle -I POSTROUTING -o $DEV -j adam_qos_$DEV</code></pre></div><p>Is there some reason NOT to do this? Seems to be the next to last step in the iptables order of operation for an outbound packet, right before POSTROUTING of the nat table.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p156063">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">dir2cas</div>
					<div class="post-datetime">
						2 Feb 2012, 16:10					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>adam2104 wrote:</cite><blockquote><p>I&#039;m curious, why use the OUTPUT and FORWARD chains in the mangle table? I&#039;ve got my own little QoS script that I use and I hook everything into the POSTROUTING chain. This captures both forwarding traffic and also router sourced traffic.<br />Is there some reason NOT to do this? Seems to be the next to last step in the iptables order of operation for an outbound packet, right before POSTROUTING of the nat table.</p></blockquote></div><p>RIGHT! <br />In case you have correctly optimized packet matching rules and right placed CONNMARK targets you may achieve smooth traffic classification even based on source IP address (from LAN - matched in egress, and source addresses coming from WAN side - matched in ingress). This all is possible because POSTROUTING chain first passes through the mangle table and after that is parsed by the nat table. This lets us to match packets generated from LAN&#039;s IP addresses (hosts) in the&nbsp; POSTROUTING mangle table and classify them correctly in both directions if using properly set CONNMARK.</p><p>In fact I optimized my script to do exactly that - another 2-3% of CPU gain for other tasks.</p><p>However the problem when your linespeed is less than the defined bandwidth limit is still present. TomVH explained why in the above posts.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p156217">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">TomVH</div>
					<div class="post-datetime">
						4 Feb 2012, 11:54					</div>
				</div>
				<div class="post-content content">
					<p>maybe there is a reason why the OpenWrt QoS developer(s) uses the output and forward chain but in my script I can use the postrouting chain instead of the output and forward chain.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>