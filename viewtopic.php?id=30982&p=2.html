<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> L2TP over IPsec with PSK using racoon/xl2tpd</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 26 Mar 2018 and 19 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 2 of 4</div><nav><ul><li><a href="viewtopic.php%3Fid=30982&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=30982&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=30982&amp;p=4.html">4</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p152279">
				<div class="post-metadata">
					<div class="post-num">Post #26</div>
					<div class="post-author">alfredlim</div>
					<div class="post-datetime">
						28 Dec 2011, 18:33					</div>
				</div>
				<div class="post-content content">
					<p>Sorry to bring up this thread.</p><p>Any idea what does this error means?</p><p>xl2tpd[6049]: control_finish: Peer requested tunnel 15 twice, ignoring second one.<br />xl2tpd[6049]: control_finish: Peer requested tunnel 15 twice, ignoring second one.<br />xl2tpd[6049]: Maximum retries exceeded for tunnel 17563.&nbsp; Closing.<br />xl2tpd[6049]: Connection 15 closed to x.x.x.x, port 61760 (Timeout)<br />xl2tpd[6049]: control_finish: Peer requested tunnel 15 twice, ignoring second one.<br />xl2tpd[6049]: Unable to deliver closing message for tunnel 17563. Destroying anyway.<br />xl2tpd[6049]: control_finish: Peer requested tunnel 15 twice, ignoring second one.<br />xl2tpd[6049]: Maximum retries exceeded for tunnel 14753.&nbsp; Closing.<br />xl2tpd[6049]: Connection 15 closed to x.x.x.x, port 61760 (Timeout)<br />xl2tpd[6049]: Unable to deliver closing message for tunnel 14753. Destroying anyway.</p><p>where x.x.x.x is my public ip address</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153168">
				<div class="post-metadata">
					<div class="post-num">Post #27</div>
					<div class="post-author">alfredlim</div>
					<div class="post-datetime">
						5 Jan 2012, 11:13					</div>
				</div>
				<div class="post-content content">
					<p>Sorry, anyone can help ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153205">
				<div class="post-metadata">
					<div class="post-num">Post #28</div>
					<div class="post-author">arokh</div>
					<div class="post-datetime">
						5 Jan 2012, 17:36					</div>
				</div>
				<div class="post-content content">
					<p>You could insert a rule before the drop in zone_wan to log every package so you can see if the firewall is blocking something.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153275">
				<div class="post-metadata">
					<div class="post-num">Post #29</div>
					<div class="post-author">alfredlim</div>
					<div class="post-datetime">
						6 Jan 2012, 01:29					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>arokh wrote:</cite><blockquote><p>You could insert a rule before the drop in zone_wan to log every package so you can see if the firewall is blocking something.</p></blockquote></div><p>Sorry, how to do that?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153317">
				<div class="post-metadata">
					<div class="post-num">Post #30</div>
					<div class="post-author">avbohemen</div>
					<div class="post-datetime">
						6 Jan 2012, 13:09					</div>
				</div>
				<div class="post-content content">
					<p>Is it possible at al to connect with the default IPSec client from Windows XP SP3? I configured my WNDR3700v1 with Arokhs &quot;alternate&quot; build with racoon/xl2tpd, and tried the default config:</p><p>First, I tried to connect from within my local lan (behind the router), which gave the indication that AES was not supported in XP. This was confirmed here: <a href="http://technet.microsoft.com/en-us/network/cc987611.aspx">http://technet.microsoft.com/en-us/netw â€¦ 87611.aspx</a> so I changed /etc/racoon.conf from:</p><div class="codebox"><pre><code>(...)
sainfo anonymous {
        encryption_algorithm aes;
        authentication_algorithm hmac_sha1;
        compression_algorithm deflate;
}</code></pre></div><p>to<br /></p><div class="codebox"><pre><code>(...)
sainfo anonymous {
        encryption_algorithm 3des;
        authentication_algorithm hmac_sha1;
        compression_algorithm deflate;
}</code></pre></div><p>After that, I could make IPSec connections from my LAN to the router. Not useful, I know, but just to proof my config was correct <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /> After that, I tried to connect from the internet. After some testing and failing, I found that this log was the cause of the problem:<br /></p><div class="codebox"><pre><code>Jan  6 11:03:39 router daemon.info racoon: INFO: respond new phase 1 negotiation: 83.86.x.x[500]&lt;=&gt;217.149.x.x[220]
Jan  6 11:03:39 router daemon.info racoon: INFO: begin Identity Protection mode.
Jan  6 11:03:39 router daemon.info racoon: INFO: received broken Microsoft ID: MS NT5 ISAKMPOAKLEY
Jan  6 11:03:39 router daemon.info racoon: INFO: received Vendor ID: FRAGMENTATION
Jan  6 11:03:39 router daemon.info racoon: INFO: received Vendor ID: draft-ietf-ipsec-nat-t-ike-02
Jan  6 11:03:39 router daemon.info racoon: [217.149.x.x] INFO: Selected NAT-T version: draft-ietf-ipsec-nat-t-ike-02
Jan  6 11:03:39 router daemon.info racoon: [83.86.x.x] INFO: Hashing 83.86.x.x[500] with algo #2
Jan  6 11:03:39 router daemon.info racoon: INFO: NAT-D payload #0 verified
Jan  6 11:03:39 router daemon.info racoon: [217.149.x.x] INFO: Hashing 217.149.x.x[220] with algo #2
Jan  6 11:03:39 router daemon.info racoon: INFO: NAT-D payload #1 doesn&#039;t match
Jan  6 11:03:39 router daemon.info racoon: INFO: NAT detected: PEER
Jan  6 11:03:39 router daemon.info racoon: [217.149.x.x] INFO: Hashing 217.149.x.x[220] with algo #2
Jan  6 11:03:39 router daemon.info racoon: [83.86.x.x] INFO: Hashing 83.86.x.x[500] with algo #2
Jan  6 11:03:39 router daemon.info racoon: INFO: Adding remote and local NAT-D payloads.
Jan  6 11:03:39 router daemon.info racoon: [217.149.x.x] ERROR: couldn&#039;t find the pskey for 217.149.x.x.
Jan  6 11:03:39 router daemon.info racoon: [217.149.x.x] NOTIFY: Using default PSK.
Jan  6 11:03:39 router daemon.info racoon: INFO: NAT-T: ports changed to: 217.149.x.x[11630]&lt;-&gt;83.86.x.x[4500]
Jan  6 11:03:39 router daemon.info racoon: INFO: KA list add: 83.86.x.x[4500]-&gt;217.149.x.x[11630]
Jan  6 11:03:39 router daemon.info racoon: WARNING: Expecting IP address type in main mode (RFC2409) , but FQDN.
Jan  6 11:03:39 router daemon.info racoon: [217.149.x.x] ERROR: invalid ID payload.
Jan  6 11:03:40 router daemon.info racoon: WARNING: Expecting IP address type in main mode (RFC2409) , but FQDN.
Jan  6 11:03:40 router daemon.info racoon: [217.149.x.x] ERROR: invalid ID payload.
Jan  6 11:03:42 router daemon.info racoon: WARNING: Expecting IP address type in main mode (RFC2409) , but FQDN.
Jan  6 11:03:42 router daemon.info racoon: [217.149.x.x] ERROR: invalid ID payload.
Jan  6 11:03:46 router daemon.info racoon: WARNING: Expecting IP address type in main mode (RFC2409) , but FQDN.
Jan  6 11:03:46 router daemon.info racoon: [217.149.x.x] ERROR: invalid ID payload.
Jan  6 11:03:54 router daemon.info racoon: WARNING: Expecting IP address type in main mode (RFC2409) , but FQDN.
Jan  6 11:03:54 router daemon.info racoon: [217.149.x.x] ERROR: invalid ID payload.
Jan  6 11:04:10 router daemon.info racoon: WARNING: Expecting IP address type in main mode (RFC2409) , but FQDN.
Jan  6 11:04:10 router daemon.info racoon: [217.149.x.x] ERROR: invalid ID payload.
Jan  6 11:04:29 router daemon.info racoon: ERROR: phase1 negotiation failed due to time up. ab10c64f0eb7134d:3b9f2c1ae081a89e
Jan  6 11:04:29 router daemon.info racoon: INFO: KA remove: 83.86.x.x[4500]-&gt;217.149.x.x[11630]
Jan  6 11:04:42 router daemon.info racoon: [217.149.x.x] ERROR: unknown Informational exchange received.</code></pre></div><p>I found the following about this error (even though they do not name racoon specifically, it seems the same): <a href="http://forum.mikrotik.com/viewtopic.php?f=2&amp;t=49849">http://forum.mikrotik.com/viewtopic.php?f=2&amp;t=49849</a> From that, I conclude that it is not possible at all to use the XP IPSec client from behind another NAT&#039;ed connection, which is almost everywhere... bummer.</p><p>Maybe there is some configuration option I can use? Has anyone succeeded in establishing an IPSec connection from Windows XP to OpenWRT/racoon? If not, I think there are three options for me...<br />- Upgrade to Windows 7 (not likely since its my company laptop)<br />- Use some other VPN client (any suggestions?)<br />- Ask for a patch for racoon (any chance? or does XP violate some RFCs?)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153464">
				<div class="post-metadata">
					<div class="post-num">Post #31</div>
					<div class="post-author">birnenschnitzel</div>
					<div class="post-datetime">
						7 Jan 2012, 12:34					</div>
				</div>
				<div class="post-content content">
					<p>Maybe you should follow the advise from issue 2 in this document <a href="http://www.juniperforum.com/index.php?topic=5628.0">http://www.juniperforum.com/index.php?topic=5628.0</a></p><p>Markus</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153707">
				<div class="post-metadata">
					<div class="post-num">Post #32</div>
					<div class="post-author">avbohemen</div>
					<div class="post-datetime">
						9 Jan 2012, 11:33					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>birnenschnitzel wrote:</cite><blockquote><p>Maybe you should follow the advise from issue 2 in this document <a href="http://www.juniperforum.com/index.php?topic=5628.0">http://www.juniperforum.com/index.php?topic=5628.0</a></p><p>Markus</p></blockquote></div><p>Interesting solution, but the hack in oakley.dll did not work. Racoon still complained about getting an fqdn instead of an ip-address. I also tried the Shrewsoft VPN client. It did succeed in connecting, but then stopped somewhere before the user authentication process should kick in, so the network connection failed to come up. So, still no luck on the XP front... I&#039;m open for suggestions <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153766">
				<div class="post-metadata">
					<div class="post-num">Post #33</div>
					<div class="post-author">birnenschnitzel</div>
					<div class="post-datetime">
						10 Jan 2012, 21:00					</div>
				</div>
				<div class="post-content content">
					<p>Are you sure that the patch survived the reboot and was not replaced by the dllcache folder backup file?</p><p>Markus</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153816">
				<div class="post-metadata">
					<div class="post-num">Post #34</div>
					<div class="post-author">avbohemen</div>
					<div class="post-datetime">
						11 Jan 2012, 12:15					</div>
				</div>
				<div class="post-content content">
					<p>Yes, I checked with a hex editor that after the reboot the bit was still changed. I changed both c:\windows\system32\oakley.dll and c:\windows\system32\dllcache\oakley.dll. I also got errors from Windows File Protection, and told him to sh#t up and keep the changed file. So yes, the dll is definately changed.</p>											<p class="post-edited">(Last edited by <strong>avbohemen</strong> on 11 Jan 2012, 12:17)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153890">
				<div class="post-metadata">
					<div class="post-num">Post #35</div>
					<div class="post-author">birnenschnitzel</div>
					<div class="post-datetime">
						12 Jan 2012, 08:43					</div>
				</div>
				<div class="post-content content">
					<p>So we have to toggle racoon to accept FQDN.</p><p>Please try to set </p><p>remote anonymous {<br />&nbsp; peers_identifier fqdn;<br />&nbsp; verify_identifier off;<br />&nbsp; ...<br />}</p><p>in your racoon.conf</p><p>Markus</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p154398">
				<div class="post-metadata">
					<div class="post-num">Post #36</div>
					<div class="post-author">avbohemen</div>
					<div class="post-datetime">
						16 Jan 2012, 16:18					</div>
				</div>
				<div class="post-content content">
					<p>peers_identifier needed to have another parameter after &#039;fqdn&#039;, but somehow it was not the fqdn of my client. That just wasn&#039;t accepted and racoon fails to start. Finally I found that simply &quot;peers_identifier fqdn a;&quot; would start the daemon, but the error I get when connecting with my xp client is still the same: &quot;invalid ID payload&quot;. So still no-go <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p154892">
				<div class="post-metadata">
					<div class="post-num">Post #37</div>
					<div class="post-author">aharrison</div>
					<div class="post-datetime">
						21 Jan 2012, 16:07					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>arokh wrote:</cite><blockquote><p>/etc/xl2tpd/xl2tpd.conf:</p><div class="codebox"><pre><code>...
ip range = 192.168.1.81-192.168.1.89
local ip = 192.168.1.80
...</code></pre></div></blockquote></div><p>Could you clarify the ip&#039;s in this portion?</p><p>My br-lan interface is configured with 192.168.1.1 with a /24 mask.&nbsp; I&#039;ve configured it out so that dhcp assigns clients 192.168.1.100-250.&nbsp; </p><p>Does this mean I should change the above config to &#039;local ip = 192.168.1.1&#039; or do I need to plumb 192.168.1.80 as an alias on br-lan?</p><p>-- <br />Andy</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p158227">
				<div class="post-metadata">
					<div class="post-num">Post #38</div>
					<div class="post-author">avbohemen</div>
					<div class="post-datetime">
						21 Feb 2012, 17:40					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>aharrison wrote:</cite><blockquote><div class="quotebox"><cite>arokh wrote:</cite><blockquote><p>/etc/xl2tpd/xl2tpd.conf:</p><div class="codebox"><pre><code>...
ip range = 192.168.1.81-192.168.1.89
local ip = 192.168.1.80
...</code></pre></div></blockquote></div><p>Could you clarify the ip&#039;s in this portion?</p><p>My br-lan interface is configured with 192.168.1.1 with a /24 mask.&nbsp; I&#039;ve configured it out so that dhcp assigns clients 192.168.1.100-250.&nbsp; </p><p>Does this mean I should change the above config to &#039;local ip = 192.168.1.1&#039; or do I need to plumb 192.168.1.80 as an alias on br-lan?</p><p>-- <br />Andy</p></blockquote></div><p>@Andy: set your local ip to your br-lan address. Then set &quot;ip range&quot; to something outside your dhcp range, ie. 192.168.1.50-99. Xl2tpd will assign addresses to vpn clients, not the builtin dhcp server. Also make sure to set &quot;ms-dns&quot; in /etc/ppp/options.xl2tpd to your br-lan address (assuming you are using your router as your dns server/forwarder). That should do the trick.</p><p>@everyone:<br />I get xl2tpd/racoon to work fine if I use arokh&#039;s alternate build. However, I just compiled my own build (which works great btw), and with that one I get the same error as alfredlim:</p><div class="codebox"><pre><code>Feb 21 16:31:23 router daemon.info racoon: INFO: respond new phase 1 negotiation: &lt;router-wan-ip&gt;[500]&lt;=&gt;&lt;vpn-client-ip&gt;[67]
Feb 21 16:31:23 router daemon.info racoon: INFO: begin Identity Protection mode.
Feb 21 16:31:23 router daemon.info racoon: INFO: received broken Microsoft ID: MS NT5 ISAKMPOAKLEY
Feb 21 16:31:23 router daemon.info racoon: INFO: received Vendor ID: RFC 3947
Feb 21 16:31:23 router daemon.info racoon: INFO: received Vendor ID: draft-ietf-ipsec-nat-t-ike-02
Feb 21 16:31:23 router daemon.info racoon: INFO: received Vendor ID: FRAGMENTATION
Feb 21 16:31:23 router daemon.info racoon: [&lt;vpn-client-ip&gt;] INFO: Selected NAT-T version: RFC 3947
Feb 21 16:31:23 router daemon.info racoon: ERROR: invalid DH group 20.
Feb 21 16:31:23 router daemon.info racoon: ERROR: invalid DH group 19.
Feb 21 16:31:23 router daemon.info racoon: [&lt;router-wan-ip&gt;] INFO: Hashing &lt;router-wan-ip&gt;[500] with algo #2
Feb 21 16:31:23 router daemon.info racoon: INFO: NAT-D payload #0 verified
Feb 21 16:31:23 router daemon.info racoon: [&lt;vpn-client-ip&gt;] INFO: Hashing &lt;vpn-client-ip&gt;[67] with algo #2
Feb 21 16:31:23 router daemon.info racoon: INFO: NAT-D payload #1 doesn&#039;t match
Feb 21 16:31:23 router daemon.info racoon: INFO: NAT detected: PEER
Feb 21 16:31:23 router daemon.info racoon: [&lt;vpn-client-ip&gt;] INFO: Hashing &lt;vpn-client-ip&gt;[67] with algo #2
Feb 21 16:31:23 router daemon.info racoon: [&lt;router-wan-ip&gt;] INFO: Hashing &lt;router-wan-ip&gt;[500] with algo #2
Feb 21 16:31:23 router daemon.info racoon: INFO: Adding remote and local NAT-D payloads.
Feb 21 16:31:23 router daemon.info racoon: [&lt;vpn-client-ip&gt;] ERROR: couldn&#039;t find the pskey for &lt;vpn-client-ip&gt;.
Feb 21 16:31:23 router daemon.info racoon: [&lt;vpn-client-ip&gt;] NOTIFY: Using default PSK.
Feb 21 16:31:23 router daemon.info racoon: INFO: NAT-T: ports changed to: &lt;vpn-client-ip&gt;[36992]&lt;-&gt;&lt;router-wan-ip&gt;[4500]
Feb 21 16:31:23 router daemon.info racoon: INFO: KA list add: &lt;router-wan-ip&gt;[4500]-&gt;&lt;vpn-client-ip&gt;[36992]
Feb 21 16:31:23 router daemon.info racoon: INFO: ISAKMP-SA established &lt;router-wan-ip&gt;[4500]-&lt;vpn-client-ip&gt;[36992] spi:fc96f56628fd7041:ac130c26fcef6da8
Feb 21 16:31:23 router daemon.info racoon: INFO: respond new phase 2 negotiation: &lt;router-wan-ip&gt;[4500]&lt;=&gt;&lt;vpn-client-ip&gt;[36992]
Feb 21 16:31:23 router daemon.info racoon: INFO: no policy found, try to generate the policy : 10.15.78.225/32[1701] &lt;router-wan-ip&gt;/32[1701] proto=udp dir=in
Feb 21 16:31:23 router daemon.info racoon: INFO: Adjusting my encmode UDP-Transport-&gt;Transport
Feb 21 16:31:23 router daemon.info racoon: INFO: Adjusting peer&#039;s encmode UDP-Transport(4)-&gt;Transport(2)
Feb 21 16:31:23 router daemon.info racoon: INFO: IPsec-SA established: ESP/Transport &lt;router-wan-ip&gt;[4500]-&gt;&lt;vpn-client-ip&gt;[36992] spi=204024557(0xc292aed)
Feb 21 16:31:23 router daemon.info racoon: INFO: IPsec-SA established: ESP/Transport &lt;router-wan-ip&gt;[4500]-&gt;&lt;vpn-client-ip&gt;[36992] spi=1981853477(0x7620af25)
Feb 21 16:31:25 router daemon.debug xl2tpd[18804]: control_finish: Peer requested tunnel 12 twice, ignoring second one.
Feb 21 16:31:26 router daemon.debug xl2tpd[18804]: control_finish: Peer requested tunnel 12 twice, ignoring second one.
Feb 21 16:31:30 router daemon.notice xl2tpd[18804]: Maximum retries exceeded for tunnel 33378.  Closing.
Feb 21 16:31:30 router daemon.info xl2tpd[18804]: Connection 12 closed to &lt;vpn-client-ip&gt;, port 1701 (Timeout)
Feb 21 16:31:30 router daemon.debug xl2tpd[18804]: control_finish: Peer requested tunnel 12 twice, ignoring second one.
Feb 21 16:31:31 router daemon.info racoon: INFO: deleting a generated policy.
Feb 21 16:31:31 router daemon.info racoon: INFO: purged IPsec-SA proto_id=ESP spi=1981853477.
Feb 21 16:31:31 router daemon.info racoon: INFO: ISAKMP-SA expired &lt;router-wan-ip&gt;[4500]-&lt;vpn-client-ip&gt;[36992] spi:fc96f56628fd7041:ac130c26fcef6da8
Feb 21 16:31:31 router daemon.info racoon: INFO: ISAKMP-SA deleted &lt;router-wan-ip&gt;[4500]-&lt;vpn-client-ip&gt;[36992] spi:fc96f56628fd7041:ac130c26fcef6da8
Feb 21 16:31:31 router daemon.info racoon: INFO: KA remove: &lt;router-wan-ip&gt;[4500]-&gt;&lt;vpn-client-ip&gt;[36992]
Feb 21 16:31:35 router daemon.debug xl2tpd[18804]: Unable to deliver closing message for tunnel 33378. Destroying anyway.</code></pre></div><p>By the way, I believe I got the same error when I used a regular trunk build (not arokh&#039;s) and then install the xl2tpd/racoon packages using this howto. The configuration I applied in both setups is a backup from arokh&#039;s build, and I cannot find any differences from this howto.</p><p>The error I get (&quot;Peer requested tunnel 12 twice, ignoring second one.&quot;) is pretty hard to find in combination with racoon. Most google results are using openswan or something else. I&#039;m wondering whether it is a configuration error on my side or something else. And I am able to connect to the vpn server from the LAN side of my router, no problems there. Any ideas?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p161403">
				<div class="post-metadata">
					<div class="post-num">Post #39</div>
					<div class="post-author">arandomnutter</div>
					<div class="post-datetime">
						19 Mar 2012, 20:06					</div>
				</div>
				<div class="post-content content">
					<p>I am getting this error</p><p> * opkg_install_cmd: Cannot install package kmod-crypto-cbc.<br /> * opkg_install_cmd: Cannot install package kmod-crypto-deflate.<br /> * opkg_install_cmd: Cannot install package kmod-crypto-iv.<br /> * opkg_install_cmd: Cannot install package kmod-crypto-rng.<br /> * opkg_install_cmd: Cannot install package kmod-crypto-wq.<br /> * opkg_install_cmd: Cannot install package kmod-zlib.</p><p>how do i fix the source of them or patch the hole?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p161536">
				<div class="post-metadata">
					<div class="post-num">Post #40</div>
					<div class="post-author">avbohemen</div>
					<div class="post-datetime">
						20 Mar 2012, 17:52					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>arokh wrote:</cite><blockquote><p>Note that I use my own init script that runs setkey.conf. I also include a hotplug script to restart racoon on WAN ifup, this is needed so that setkey.conf runs with the new IP address.</p></blockquote></div><p>Ok, I missed this one. That&#039;s probably why my own compile does not connect my vpn. So the next question is: how do I compile arokh&#039;s version into my own custom firmware? Or should I just replace the init scripts (/etc/init.d/racoon; /etc/setkey.conf; /etc/hotplug.d/iface/93-racoon)? Thanks for any answer.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p161705">
				<div class="post-metadata">
					<div class="post-num">Post #41</div>
					<div class="post-author">netbus</div>
					<div class="post-datetime">
						22 Mar 2012, 09:51					</div>
				</div>
				<div class="post-content content">
					<p>My tunnel is working well with this tutorial but I have a performance problem.<br />when I am connected to my WNDR3700 via L2TP over IPsec with my android smartphone, up and download speed is max. 700kb/sec.<br />any tipps here?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p161708">
				<div class="post-metadata">
					<div class="post-num">Post #42</div>
					<div class="post-author">arokh</div>
					<div class="post-datetime">
						22 Mar 2012, 10:10					</div>
				</div>
				<div class="post-content content">
					<p>Did you check cpu usage with top at the same time? Does sound a little low though... What kind of connection do you have?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p161709">
				<div class="post-metadata">
					<div class="post-num">Post #43</div>
					<div class="post-author">netbus</div>
					<div class="post-datetime">
						22 Mar 2012, 10:12					</div>
				</div>
				<div class="post-content content">
					<p>i checked top, cpu and so on. i have 16Mbit DSL line.<br />this strange thing also happens when I use openvpn.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p161740">
				<div class="post-metadata">
					<div class="post-num">Post #44</div>
					<div class="post-author">arokh</div>
					<div class="post-datetime">
						22 Mar 2012, 14:06					</div>
				</div>
				<div class="post-content content">
					<p>So what was the results when you checked? Any idle usage? There&#039;s surely some limit to how much encrypted throughput this hardware can handle, you can see that by using scp.</p>											<p class="post-edited">(Last edited by <strong>arokh</strong> on 22 Mar 2012, 14:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p161743">
				<div class="post-metadata">
					<div class="post-num">Post #45</div>
					<div class="post-author">netbus</div>
					<div class="post-datetime">
						22 Mar 2012, 14:31					</div>
				</div>
				<div class="post-content content">
					<p>WNDR3700: <br /></p><div class="codebox"><pre><code>Mem: 60124K used, 1720K free, 0K shrd, 30172K buff, 10728K cached
CPU:   0% usr   0% sys   0% nic  99% idle   0% io   0% irq   0% sirq
Load average: 0.00 0.01 0.05 2/60 25753
  PID  PPID USER     STAT   VSZ %VSZ %CPU COMMAND
22518     1 root     S     1604   3%   0% /usr/sbin/pppd plugin rp-pppoe.so mtu
25738 25730 root     R     1496   2%   0% top
31943     1 root     S     5792   9%   0% /usr/sbin/collectd
27957     1 root     S     2952   5%   0% /usr/sbin/racoon
23702     1 root     S     1632   3%   0% {dynamic_dns_upd} /bin/sh /usr/lib/dd
23322     1 root     S     1604   3%   0% hostapd -P /var/run/wifi-phy1.pid -B
23225     1 root     S     1596   3%   0% hostapd -P /var/run/wifi-phy0.pid -B
25735  3138 root     S     1516   2%   0% /usr/sbin/pppd passive nodetach 192.1
 5250     1 root     S     1512   2%   0% /usr/sbin/crond -c /etc/crontabs -l 5
  787     1 root     S     1504   2%   0% /sbin/syslogd -l 8 -C16
25730 25729 root     S     1504   2%   0% -ash
    1     0 root     S     1500   2%   0% init
  525     1 root     S     1500   2%   0% init
 3681     1 root     S     1488   2%   0% syslogd -O /opt/log/messages -s 2000
  789     1 root     S     1488   2%   0% /sbin/klogd
25722 23702 root     S     1484   2%   0% sleep 600
 2559     1 root     S     1240   2%   0% pure-ftpd (SERVER)
25729  2543 root     S     1196   2%   0% /usr/sbin/dropbear -P /var/run/dropbe
 2543     1 root     S     1140   2%   0% /usr/sbin/dropbear -P /var/run/dropbe
23101     1 root     S     1084   2%   0% /usr/sbin/ntpclient -i 600 -s -l -D -</code></pre></div><p>Android Smartphone (SGS2)<br /></p><div class="codebox"><pre><code>CPU: 31.4% usr  9.7% sys  0.2% nic 56.6% idle  1.0% io  0.0% irq  0.7% sirq
Load average: 1.55 1.65 0.91 2/987 5924
?[7m  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND?[0m
 5739  2662 10138    R     242m 30.1   0 28.0 {droid.speedtest} org.zwanoo.andro
 2815  2662 1000     S     374m 46.5   0  8.3 system_server
 2944  2662 1000     S     226m 28.1   1  1.3 {ndroid.systemui} com.android.syst
 2671     1 1021     S    17396  2.1   1  0.7 /system/bin/gpsd -c /system/etc/gp
    9     2 0        SW       0  0.0   0  0.5 [events/0]
 1477     2 0        SW       0  0.0   1  0.4 [mmcqd]
 4144  2662 10010    S     227m 28.2   1  0.3 {.client.samsung} com.vlingo.clien
 1387     2 0        SW       0  0.0   0  0.3 [mali-pmm-wq]
 3910  2662 10072    S     230m 28.6   1  0.2 {LocationService} com.google.andro
 5876  5871 0        R     1064  0.1   1  0.2 /system/xbin/busybox /sbin/top
 2670     1 1000     S    14276  1.7   0  0.1 /system/bin/tvoutserver
  539     2 0        SW       0  0.0   0  0.1 [kondemand/0]
 1273     2 0        SW       0  0.0   1  0.1 [svnet_txq]
 2984  2662 1001     S     234m 29.1   0  0.1 {m.android.phone} com.android.phon
 4759  2662 10178    S     230m 28.6   1  0.1 com.ebay.mobile
 5223  2662 1000     S     211m 26.2   0  0.1 {rver.vpn:remote} com.android.serv
 5918     2 0        SW       0  0.0   1  0.1 [events/1]
 3031  2662 10213    S     455m 56.5   0  0.0 com.spb.shell3d
 3054  2662 10060    S     328m 40.8   1  0.0 {e.process.gapps} com.google.proce
 4380  2662 10014    S     277m 34.5   0  0.0 {android.vending} com.android.vend</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p161744">
				<div class="post-metadata">
					<div class="post-num">Post #46</div>
					<div class="post-author">netbus</div>
					<div class="post-datetime">
						22 Mar 2012, 14:43					</div>
				</div>
				<div class="post-content content">
					<p>i tested scp. <br />2.9MB/s was the maximum</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p161755">
				<div class="post-metadata">
					<div class="post-num">Post #47</div>
					<div class="post-author">arokh</div>
					<div class="post-datetime">
						22 Mar 2012, 15:32					</div>
				</div>
				<div class="post-content content">
					<p>Ok, then I guess it&#039;s reasonable to assume that encryption handled by the kernel should be equally fast so 700kb sounds a little low...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p161756">
				<div class="post-metadata">
					<div class="post-num">Post #48</div>
					<div class="post-author">netbus</div>
					<div class="post-datetime">
						22 Mar 2012, 15:33					</div>
				</div>
				<div class="post-content content">
					<p>i am using your build ;-)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p164504">
				<div class="post-metadata">
					<div class="post-num">Post #49</div>
					<div class="post-author">TheCondor</div>
					<div class="post-datetime">
						14 Apr 2012, 19:36					</div>
				</div>
				<div class="post-content content">
					<p>Hi, someone can help me with strongswan+xl2tp? I can&#039;t use racoon because there aren&#039;t some package (like zlib, kmod-cbc and other) for my openwrt version (10.03.1 final on tplink wr1043nd).</p><p>When i tray to connect from my iphone to my openwrt router (ip 192.168.1.254) popup says that isn&#039;t possible to connect to server.<br />This is my config files:</p><br /><br /><p>&lt;ipsec.conf&gt;<br />config setup<br />&nbsp; &nbsp; # plutodebug=all<br />&nbsp; &nbsp; # crlcheckinterval=600<br />&nbsp; &nbsp; # strictcrlpolicy=yes<br />&nbsp; &nbsp; # cachecrls=yes<br />&nbsp; &nbsp; nat_traversal=yes<br />&nbsp; &nbsp; charonstart=no<br />&nbsp; &nbsp; plutostart=yes<br />&nbsp; &nbsp; virtual_private=%v4:0.0.0.0/0,%v4:!192.168.1.0/24 #192.168.1.0/24 is my lan<br />conn L2TP-PSK<br />&nbsp; &nbsp; authby=secret<br />&nbsp; &nbsp; pfs=no<br />&nbsp; &nbsp; rekey=no<br />&nbsp; &nbsp; keyingtries=3<br />&nbsp; &nbsp; type=transport<br />&nbsp; &nbsp; left=%defaultroute<br />&nbsp; &nbsp; leftnexthop=%defaultroute<br />&nbsp; &nbsp; leftprotoport=17/1701<br />&nbsp; &nbsp; right=%any<br />&nbsp; &nbsp; rightsubnet=vhost:%no,%priv<br />&nbsp; &nbsp; rightprotoport=17/%any<br />&nbsp; &nbsp; auto=add</p><br /><br /><br /><p>&lt;ipsec.secret&gt;<br />%any %any : PSK &quot;superpassword&quot;</p><br /><br /><br /><p>&lt;xl2tpd.conf&gt;<br />[global]<br />port = 1701<br />;auth file = /etc/xl2tpd/xl2tp-secrets<br />access control = no<br />ipsec saref = yes<br />[lns default]<br />exclusive = yes<br />ip range = 192.168.1.202-192.168.1.210&nbsp; (out of the dhcp range, right? )<br />local ip = 192.168.1.254&nbsp; (openwrt himself ip)<br />;lac = 10.0.1.2<br />;hidden bit = no<br />length bit = yes<br />name = some-name<br />;refuse authentication = yes<br />ppp debug = yes<br />require authentication = yes<br />unix authentication = no<br />require chap = yes<br />refuse pap = yes<br />pppoptfile = /etc/ppp/options.xl2tpd</p><br /><br /><p>&lt;options.xl2tp&gt;<br />lock<br />auth<br />debug<br />dump<br />noccp<br />novj<br />novjccomp<br />nopcomp<br />noaccomp<br />require-mschap<br />require-mschap-v2<br />ms-dns 192.168.1.254&nbsp; (my openwrt ip)<br />lcp-echo-interval 120<br />lcp-echo-failure 10<br />idle 1800<br />connect-delay 5000<br />nodefaultroute<br />noipdefault<br />proxyarp<br />mtu 1400<br />mru 1400</p><br /><p>&lt;chap-secrets&gt;<br />#USERNAME&nbsp; &nbsp;PROVIDER&nbsp; &nbsp;PASSWORD&nbsp; &nbsp; IPADDRESS<br />user&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;password&quot;&nbsp; &nbsp;192.168.1.202&nbsp; &nbsp;#ip out the dhcp range<br />*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;password&nbsp; &nbsp; &nbsp;&quot;password&quot;&nbsp; &nbsp;192.168.1.202&nbsp; #ip out the dhcp range</p><br /><br /><p>&lt;firewall.conf&gt;<br />config &#039;rule&#039;<br />&nbsp; &nbsp; option &#039;target&#039; &#039;ACCEPT&#039;<br />&nbsp; &nbsp; option &#039;_name&#039; &#039;IPSec IKE&#039;<br />&nbsp; &nbsp; option &#039;src&#039; &#039;wan&#039;<br />&nbsp; &nbsp; option &#039;proto&#039; &#039;udp&#039;<br />&nbsp; &nbsp; option &#039;dest_port&#039; &#039;500&#039;</p><p>config &#039;rule&#039;<br />&nbsp; &nbsp; option &#039;target&#039; &#039;ACCEPT&#039;<br />&nbsp; &nbsp; option &#039;_name&#039; &#039;IPSec ESP&#039;<br />&nbsp; &nbsp; option &#039;src&#039; &#039;wan&#039;<br />&nbsp; &nbsp; option &#039;proto&#039; &#039;esp&#039;</p><p>config &#039;rule&#039;<br />&nbsp; &nbsp; option &#039;target&#039; &#039;ACCEPT&#039;<br />&nbsp; &nbsp; option &#039;_name&#039; &#039;IPsec NAT-T&#039;<br />&nbsp; &nbsp; option &#039;src&#039; &#039;wan&#039;<br />&nbsp; &nbsp; option &#039;proto&#039; &#039;udp&#039;<br />&nbsp; &nbsp; option &#039;dest_port&#039; &#039;4500&#039;<br />&nbsp; &nbsp; <br />config &#039;rule&#039;<br />&nbsp; &nbsp; option &#039;target&#039; &#039;ACCEPT&#039;<br />&nbsp; &nbsp; option &#039;_name&#039; &#039;L2TP ESP&#039;&nbsp; &nbsp;<br />&nbsp; &nbsp; option &#039;src&#039; &#039;wan&#039;&nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; option &#039;proto&#039; &#039;udp&#039;<br />&nbsp; &nbsp; option &#039;dest_port&#039; &#039;1701&#039;<br />&nbsp; &nbsp; option &#039;extra&#039; &#039;-m policy --strict --dir in --pol ipsec --proto esp&#039;</p><br /><br /><p>&lt;firewall.user&gt;<br />iptables -A forwarding_rule -o ppp0 -j ACCEPT<br />iptables -A forwarding_rule -i ppp0 -j ACCEPT</p><br /><br /><p>what&#039;s wrong? seems that xl2tp doesn&#039;t answer to strongswan call <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170651">
				<div class="post-metadata">
					<div class="post-num">Post #50</div>
					<div class="post-author">languagegame</div>
					<div class="post-datetime">
						22 Jun 2012, 06:58					</div>
				</div>
				<div class="post-content content">
					<p>In the firewall rules in the opening post, does the ESP rule need to reference protocol ESP (vs. UDP)?</p><p>In other words, change:</p><p># IPsec/ESP<br />config &#039;rule&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;target&#039; &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;_name&#039; &#039;IPsec ESP&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;src&#039; &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;proto&#039; &#039;udp&#039;</p><p>to:</p><p># IPsec/ESP<br />config &#039;rule&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;target&#039; &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;_name&#039; &#039;IPsec ESP&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;src&#039; &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;proto&#039; &#039;esp&#039;</p>											<p class="post-edited">(Last edited by <strong>languagegame</strong> on 22 Jun 2012, 06:59)</p>
									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 2 of 4</div><nav><ul><li><a href="viewtopic.php%3Fid=30982&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=30982&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=30982&amp;p=4.html">4</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>