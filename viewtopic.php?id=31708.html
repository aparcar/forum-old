<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Please Need Help : I ran &quot;mtd erase nvram&quot; now router won&#039;t boot!</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 24 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p142853">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">FedUp</div>
					<div class="post-datetime">
						5 Sep 2011, 02:41					</div>
				</div>
				<div class="post-content content">
					<p>Hopefully someone here can help me out.</p><p>I have a Dlink DIR-600-A1 router, and up until an hour ago I was successfully running one of the latest trunk versions of Openwrt Attitude Adjustment. </p><p>I went a bit wild updating packages on my router, and was left with nearly no free space, so i decided that I wanted to &quot;reset to defaults&quot; to gain back the space that was lost.</p><p>After a google search, I foolishly ran &quot;mtd erase nvram&quot; and rebooted the router only to discover that it will not boot anymore.</p><p>I then accessed the Dlink Emergency Room bootloader and flashed OpenWrt back to the router. The firmware flash completed, however the router still refuses to boot. The power light remains orange, and the router power cycles every 30 seconds, non-stop.</p><p>I tried flashing the original stock firmware via the Dlink Emergency Room, and the router behaves in the same way...firmware is flashed, but the router refuses to boot.</p><p>Oddly enough, I was able to flash DD-WRT to the router, and the router boots (works) !?!?</p><p>I&#039;m assuming that the &quot;mtd erase nvram&quot; command removed certain boot variables that are needed for OpenWrt and the stock Dlink fimrware to boot, but not those that affect DD-WRT.</p><p>Do any of the OpenWrt and Dlink router gurus out there know of a way that I can get OpenWrt or the stock firmware working on the router again? </p><p>Flashing the firmware back to the device is not enough to get OpenWrt running on it again, but maybe there&#039;s something I can do/type from DD-WRT that would make it work? I feel like an idiot for running &quot;mtd erase nvram&quot; in OpenWrt <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>Thanks in advance!</p><p>Update:</p><p>I have just noticed that DD-WRT no longer displays the correct MAC addresses:</p><p>LAN MAC&nbsp; &nbsp;00:11:22:33:44:66&nbsp; <br />WAN MAC&nbsp; 00:11:22:33:44:55&nbsp; </p><p>Am I screwed?</p><p><strong><br />EDIT:</strong></p><p><strong>As long as you are running OpenWrt on your DIR-601/600-A1 you can help me resolve this issue all i need is a copy of the NVRAM partition on your router. You can obtain this by running the below command on the router via telnet or SSH:</strong></p><p><strong>dd if=/dev/mtdblock/1 of=/tmp/nvram-dir-601.bin</strong></p><br /><p><strong>Save the image to your PC (if you&#039;re not sure how to do so, let me know), and send it to me via private message. You might have to upload the file to a filesharing site since this forum doesn&#039;t support attachments</strong></p><p><strong>Thanks in advance!...I know that one of you guys/gals will be willing to help me <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br /></strong></p>											<p class="post-edited">(Last edited by <strong>FedUp</strong> on 8 Sep 2011, 20:38)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p142891">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						5 Sep 2011, 17:37					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>FedUp wrote:</cite><blockquote><p>Am I screwed?</p></blockquote></div><p>I wouldn&#039;t think so.</p><p>Your best chance to survive this kind of issue is to get a USB/serial console cable to connect a USB port on your computer to the serial port on your device. This will allow you to access the boot console of your device to see what&#039;s going on and fix the problem. If you already had an old LaFonera <a href="http://wiki.openwrt.org/toh/fon/fonera">FON2100</a> device, you can use its serial-console port to interface with the serial-console port on your DLink DIR-600 device, too. Your LaFonera <a href="http://wiki.openwrt.org/toh/fon/fonera">FON2100</a> device needs be running a COM software, i.e. minicom, picocom, etc. OpenWRT has a support for these two COM software. I have one of my LaFonera <a href="http://wiki.openwrt.org/toh/fon/fonera">FON2100</a> devices flashed with OpenWRT+minicom just to do this purpose.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p142906">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						5 Sep 2011, 21:44					</div>
				</div>
				<div class="post-content content">
					<p>From DD-WRT, run &quot;cat /proc/mtd&quot;. Does wifi works?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p142917">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">FedUp</div>
					<div class="post-datetime">
						6 Sep 2011, 00:16					</div>
				</div>
				<div class="post-content content">
					<p>Thanks guys for your help. </p><p><strong><em>mazilo</em></strong>, I have zero experience soldering connectors/wires to a board, so I don&#039;t think that i&#039;ll be able to create a serial connection to the router.</p><p><strong><em>fyi</em></strong>, although i&#039;m not too adept in memory ranges and partition layouts, it looks like the MTD partition layout of dd-wrt is in no way similar to that of the stock firmware, nor OpenWRT. It makes sense that the &quot;mtd erase nvram&quot; command had no affect on DD-WRT since its nvram location is no where near that of OpenWRT.&nbsp; However OpenWRT (<a href="http://wiki.openwrt.org/toh/d-link/dir-600?s%5B%5D=table&amp;s%5B%5D=hardware#flash.layout">according to the DIR-601 wiki</a>) and the stock firmware store nvram in the identical flash memory range, which is probably why neither can no longer boot if inportant config variables were wiped out. </p><p>Would it be possible for a special OpenWRT firmware to re-create the presumably missing variables during the flashing process, if we happened to discover what they were?</p><p><span class="bbu"><strong>MTD Partition Comparison</strong></span></p><p><strong>DDWRT</strong></p><p>------------------<br />Creating 8 MTD partitions on &quot;ar7240-nor0&quot;:</p><p>0x000000000000-0x000000040000 : &quot;RedBoot&quot;<br />0x000000040000-0x0000003e0000 : &quot;linux&quot;<br />0x00000010d000-0x0000003a0000 : &quot;rootfs&quot;<br />0x0000003a0000-0x0000003e0000 : &quot;ddwrt&quot;<br />0x0000003e0000-0x0000003f0000 : &quot;nvram&quot;<br />0x0000003f0000-0x000000400000 : &quot;board_config&quot;<br />0x000000000000-0x000000400000 : &quot;fullflash&quot;<br />0x000000000000-0x000000040000 : &quot;fullboot&quot;</p><p>------------------</p><p><strong>OpenWRT (taken from the wiki)</strong></p><p>------------------</p><p>0x000000000000-0x000000030000 : u-boot <br />0x000000030000-0x000000040000 : nvram <br />0x000000040000-0x000000120000 : kernel <br />0x000000120000-0x0000003e0000 : rootfs <br />0x00000025a000-0x0000003e0000 : rootfs_data <br />0x0000003e0000-0x0000003f0000 : mac <br />0x0000003f0000-0x000000040000 : art <br />0x000000040000-0x0000003e0000 : firmware </p><p>------------------</p><p><strong>Stock Firmware (taken from dd-wrt forum-I think a few zeros are missing)</strong></p><p>------------------</p><p>Creating 6 MTD partitions on &quot;ar7240-nor0&quot;: </p><p>0x00000000-0x00030000 : &quot;u-boot&quot; <br />0x00030000-0x00040000 : &quot;nvram&quot; <br />0x00040000-0x00130000 : &quot;linux&quot; <br />0x00130000-0x003e0000 : &quot;rootfs&quot; <br />0x003e0000-0x003f0000 : &quot;MAC&quot; <br />0x003f0000-0x00400000 : &quot;ART&quot; </p><p>------------------</p><br /><br /><p>The WiFi works in DD-WRT, however its MAC address is also &quot;random&quot;:</p><p>Wireless MAC&nbsp; 20:0A:10:54:59:98 </p><br /><p>Lastly, I notice that dd-wrt uses RedBoot, while OpenWrt and the stock firmware uses u-boot. When I look at the kernel output from a DIR-601 stock-firmware user who had a serial connection connected to his router last year, I see the below early during the boot process:</p><p>----<br />Net: ag7240_enet_initialize... <br />Fetching MAC Address from 0x81fe6e50 <br />: cfg1 0xf cfg2 0x7014 <br />eth0: 00:03:7f:e0:09:ab <br />eth0 up <br />No valid address in Flash. Using fixed address <br />: cfg1 0xf cfg2 0x7214 <br />eth1: 00:03:7f:09:0b:ad <br />----</p><p>Could the issue here be that u-boot attempts to aquire the device MAC address, but since the MAC addresses appear to have vanished on my unit, the boot process is halted and then reboots roughly 30 seconds later? Yeah i know if i had a serial connection, I&#039;d be able to answer that question <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> </p><p>The main reason why I&#039;m kicking myself is that I finally got around to installing asteriks (to ram) on the DIR-601 and had everything inlcuding an IVR up and running. I was wise enough to backup the changes that I had made, but it really sucks having to go back to the much more limited dd-wrt without asterisks.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p142926">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						6 Sep 2011, 03:09					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>FedUp wrote:</cite><blockquote><p><strong><em>mazilo</em></strong>, I have zero experience soldering connectors/wires to a board, so I don&#039;t think that i&#039;ll be able to create a serial connection to the router.</p></blockquote></div><p>My suggestion doesn&#039;t involve with any hardware soldering unless you wanna build your own USB/Serial console cable.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p142951">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						6 Sep 2011, 11:54					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>FedUp wrote:</cite><blockquote><p><span class="bbu"><strong>MTD Partition Comparison</strong></span></p><p><strong>DDWRT</strong></p><p>------------------<br />Creating 8 MTD partitions on &quot;ar7240-nor0&quot;:</p><p>0x000000000000-0x000000040000 : &quot;RedBoot&quot;<br />--------8&lt;----------</p><p><strong>OpenWRT (taken from the wiki)</strong></p><p>------------------</p><p>0x000000000000-0x000000030000 : u-boot<br />0x000000030000-0x000000040000 : nvram</p></blockquote></div><p>Get a copy mtd &quot;0x30000-0x40000: nvram&quot; (mtd1) and write it back together with &quot;0-0x30000: u-boot&quot; (mtd0) to &quot;0-0x40000: RedBoot&quot; (mtd0) with &quot;mtd write&quot; command. You can ask members of DD-WRT to help you get a copy of mtd0 so that you don&#039;t have to merge nvram with u-boot. . Be extremely careful with mtd write or you might brick it.</p><p><a href="http://wiki.openwrt.org/doc/techref/mtd">MTD - OpenWrt Wiki</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p142990">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">FedUp</div>
					<div class="post-datetime">
						6 Sep 2011, 21:52					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>fyi wrote:</cite><blockquote><div class="quotebox"><cite>FedUp wrote:</cite><blockquote><p><span class="bbu"><strong>MTD Partition Comparison</strong></span></p><p><strong>DDWRT</strong></p><p>------------------<br />Creating 8 MTD partitions on &quot;ar7240-nor0&quot;:</p><p>0x000000000000-0x000000040000 : &quot;RedBoot&quot;<br />--------8&lt;----------</p><p><strong>OpenWRT (taken from the wiki)</strong></p><p>------------------</p><p>0x000000000000-0x000000030000 : u-boot<br />0x000000030000-0x000000040000 : nvram</p></blockquote></div><p>Get a copy mtd &quot;0x30000-0x40000: nvram&quot; (mtd1) and write it back together with &quot;0-0x30000: u-boot&quot; (mtd0) to &quot;0-0x40000: RedBoot&quot; (mtd0) with &quot;mtd write&quot; command. You can ask members of DD-WRT to help you get a copy of mtd0 so that you don&#039;t have to merge nvram with u-boot. . Be extremely careful with mtd write or you might brick it.</p><p><a href="http://wiki.openwrt.org/doc/techref/mtd">MTD - OpenWrt Wiki</a></p></blockquote></div><p>Thanks for the info!</p><p>Could the same be accomplished if a DIR-601 / DIR-600-A1 user with OpenWRT installed, supplied me with copies of the below partitions from their device? </p><p>mtd &quot;0-0x30000: u-boot&quot; (mtd0) <br />mtd &quot;0x30000-0x40000: nvram&quot; (mtd1)</p><p>The reason I ask this is because I gather that if I post such a request at the dd-wrt forum, I&#039;d need to find a really friendly dd-wrt user who was willing to flash OpenWRT on their device for the sole purpose of helping me out.&nbsp; </p><p>However, if an OpenWRT DIR-601 user can supply me with a copy of those two partitions then they wouldn&#039;t have to take that extra step? </p><p> I would be <em><strong>extremely</strong></em> grateful, if a DIR-601 OpenWRT user who is reading this thread could help me out in that area <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> I can&#039;t offer much in return, but I can share the steps involved in order to get Asterisk to work on the DIR-601!</p>											<p class="post-edited">(Last edited by <strong>FedUp</strong> on 6 Sep 2011, 21:58)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p143017">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						7 Sep 2011, 10:32					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>FedUp wrote:</cite><blockquote><p>Could the same be accomplished if a DIR-601 / DIR-600-A1 user with OpenWRT installed, supplied me with copies of the below partitions from their device? </p><p>mtd &quot;0-0x30000: u-boot&quot; (mtd0) <br />mtd &quot;0x30000-0x40000: nvram&quot; (mtd1)</p></blockquote></div><p>Yes.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p151999">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">gogators163</div>
					<div class="post-datetime">
						25 Dec 2011, 06:48					</div>
				</div>
				<div class="post-content content">
					<p>@Fedup</p><p>Did you ever get it?</p><p>I have a DIR-601 and am working on a openvpn project.&nbsp; I have openwrt on it now.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>