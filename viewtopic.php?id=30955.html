<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> tp-link wr1043nd vlan tagging with wifi</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 26 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p139510">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">petra2201</div>
					<div class="post-datetime">
						20 Jul 2011, 21:29					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;v been googling and searching for hours but can&#039;t seem to find an answer. I have a tp-link wr1043nd router and I would like to subdivide the wireless in a vlan so that it has internet access but it can&#039;t see any pc&#039;s connected to the ethernet ports. I&#039;ve seen a lot of configs that allow tagging of different ports but none for the wireless. Any ideas? I had tried dd-wrt but they don&#039;t have vlan support for the wr1043 yet.</p><p>thanks for any help</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p139533">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						21 Jul 2011, 00:56					</div>
				</div>
				<div class="post-content content">
					<p><a href="http://translate.google.com/translate?sl=auto&amp;tl=en&amp;u=http://rpc.one.pl/index.php/lista-artykulow/34-openwrt/81-konfiguracja-switch-vlan-na-podstawie-swconfig-w-routerze-wr1043nd-pod-openwrt">Switch configuration and VLAN based on the router WR1043ND swconfig under OpenWrt</a> - by rpc</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p139598">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">petra2201</div>
					<div class="post-datetime">
						21 Jul 2011, 20:05					</div>
				</div>
				<div class="post-content content">
					<p>My polish is&nbsp; a little rusty but I thought this line from Google translate was really helpful<br />So if br-lan bridge = eth0 + ath0 sneezes, despite setting a vlan on eth0.1 it still will not move</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p139604">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						21 Jul 2011, 21:22					</div>
				</div>
				<div class="post-content content">
					<p><a href="https://forum.openwrt.org/viewtopic.php?id=28926">OpenWrt / How to keep users of guest wlan out of lan ?</a><br /><a href="https://forum.openwrt.org/viewtopic.php?id=28317">OpenWrt / Access Point with a second SSID for Guest Access to Internet only</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p139609">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">petra2201</div>
					<div class="post-datetime">
						21 Jul 2011, 22:35					</div>
				</div>
				<div class="post-content content">
					<p>Nevermind. I went into the interfaces tab of the web ui. I created a new interface. I called it WLan. I made a custom device called ath0.3 and bridged it to the wan&#039;s vlan. After a quick reboot I had wifi access to the internet and no access to the machines physically plugged in. I&#039;m sure there&#039;s a better method but this works and did exactly what I wanted.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p139610">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">petra2201</div>
					<div class="post-datetime">
						21 Jul 2011, 22:36					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for the help fyi. Those links would also have done what I wanted. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p139643">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						22 Jul 2011, 06:04					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>petra2201 wrote:</cite><blockquote><p>Nevermind. I went into the interfaces tab of the web ui. I created a new interface. I called it WLan. I made a custom device called ath0.3 and bridged it to the wan&#039;s vlan. After a quick reboot I had wifi access to the internet and no access to the machines physically plugged in.</p></blockquote></div><p>Without MASQUERADE.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p171051">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">@ll@n416</div>
					<div class="post-datetime">
						27 Jun 2012, 09:58					</div>
				</div>
				<div class="post-content content">
					<p>@fyi,</p><p>Hi. I was trying to setup the switch on WR1043ND as enterprise switch with port 1 in default vlan, port 2 a member of vlan 10, port 3 &amp; 4 a trunk where default vlan, vlan10 and vlan 20 (not mapped on any port) can pass through. Please note that I would have two manageable switches (with vlan1, vlan10 and vlan20 also) connected at 2 trunk port and they are connected to each other providing the network a redundant and fail safe link. </p><p>Trying to understand the configurations at <a href="http://translate.google.com/translate?sl=auto&amp;tl=en&amp;u=http://rpc.one.pl/index.php/lista-artykulow/34-openwrt/81-konfiguracja-switch-vlan-na-podstawie-swconfig-w-routerze-wr1043nd-pod-openwrt">http://translate.google.com/translate?s … od-openwrt</a> and set my own configuration made my unit crashed and bricked. I&#039;ve reference also this website <a href="http://www.hermanvandrie.nl/index.php?option=com_content&amp;view=article&amp;id=12:test&amp;catid=4:kpn-glasvezel&amp;Itemid=15">http://www.hermanvandrie.nl/index.php?o … ;Itemid=15</a> and this <a href="http://blog.philippklaus.de/2011/04/openwrt-on-a-tp-link-tl-wr1043nd-gigabit-router">http://blog.philippklaus.de/2011/04/ope … bit-router</a>.</p><p>I managed to recover the unit by using the serial port and have OpenWrt backfire 10.03.1 working again.</p><p>Now, I don&#039;t want the unit crashed and bricked again the second time for it took me so much time recovering, working on soldering and burned serial port but still am working on the setup I want.</p><p>Could you please help me and verify or confirm if the following configuration will work as I wanted? Do I have missing configuration like setting STP ?</p><p>Thank you in advance.</p><br /><p>/etc/config/network</p><p>config &#039;interface&#039; &#039;loopback&#039; <br />&nbsp; option &#039;ifname&#039; &#039;lo&#039; <br />&nbsp; option &#039;proto&#039; &#039;static&#039; <br />&nbsp; option &#039;ipaddr&#039; &#039;127.0.0.1 &#039; <br />&nbsp; option &#039;netmask&#039; &#039;255 .0.0.0 &#039; </p><p>config &#039;interface&#039; &#039;lan&#039; <br />&nbsp; option &#039;ifname&#039; &#039;eth0.1&#039; <br />&nbsp; option &#039;type&#039; &#039;bridge&#039; <br />&nbsp; option &#039;proto&#039; &#039;static&#039; <br />&nbsp; option &#039;ipaddr&#039; &#039;192.168.1.1 &#039; <br />&nbsp; option &#039;netmask&#039; &#039;255 .255.255.0 &#039; </p><p>config &#039;interface&#039; &#039;wan&#039; <br />&nbsp; option &#039;ifname&#039; &#039;eth0.2&#039; <br />&nbsp; option &#039;proto&#039; &#039;dhcp&#039; </p><p>config &#039;interface&#039; &#039;vlan10&#039;&nbsp; &nbsp; #appended<br />&nbsp; option &#039;ifname&#039; &#039;eth0.10&#039;<br />&nbsp; option &#039;proto&#039; &#039;static&#039;<br />&nbsp; option &#039;ipaddr&#039; &#039;192.168.3.1&#039;<br />&nbsp; option &#039;netmask&#039; &#039;255.255.255.0&#039;</p><p>config &#039;interface&#039; &#039;vlan20&#039;&nbsp; &nbsp; #appended<br />&nbsp; option &#039;ifname&#039; &#039;eth0.20&#039;<br />&nbsp; option &#039;proto&#039; &#039;static&#039;<br />&nbsp; option &#039;ipaddr&#039; &#039;192.168.4.1&#039;<br />&nbsp; option &#039;netmask&#039; &#039;255.255.255.0&#039;</p><p>config &#039;switch&#039; <br />&nbsp; option &#039;name&#039; &#039;rtl8366rb&#039; <br />&nbsp; option &#039;reset&#039; &#039;1&#039; <br />&nbsp; option &#039;enable_vlan&#039; &#039;1&#039; <br />&nbsp; option &#039;enable_vlan4k &#039;1&#039;</p><p>config &#039;switch_port&#039;&nbsp; &nbsp; &nbsp; &nbsp; #appended<br />&nbsp; option &#039;device&#039; &#039;rtl8366rb&#039;<br />&nbsp; option &#039;port&#039; &#039;0&#039;<br />&nbsp; option &#039;pvid&#039; &#039;2&#039;</p><p>config &#039;switch_port&#039;&nbsp; &nbsp; &nbsp; &nbsp; #appended<br />&nbsp; option &#039;device&#039; &#039;rtl8366rb&#039;<br />&nbsp; option &#039;port&#039; &#039;1&#039;<br />&nbsp; option &#039;pvid&#039; &#039;1&#039;</p><p>config &#039;switch_port&#039;<br />option &#039;device&#039; &#039;rtl8366rb&#039;<br />option &#039;port&#039; &#039;2&#039;<br />option &#039;pvid&#039; &#039;10&#039;</p><p>config &#039;switch_vlan&#039; <br />&nbsp; option &#039;device&#039; &#039;rtl8366rb&#039; <br />&nbsp; option &#039;vlan&#039; &#039;1&#039; <br />&nbsp; option &#039;ports&#039; &#039;1 5t&#039; &nbsp; &nbsp; #moved ports 2, 3 and 4</p><p>config &#039;switch_vlan&#039; <br />&nbsp; option &#039;device&#039; &#039;rtl8366rb&#039; <br />&nbsp; option &#039;vlan&#039; &#039;2&#039; <br />&nbsp; option &#039;ports&#039; &#039;0 5t&#039; </p><p>config &#039;switch_vlan&#039; &nbsp; &nbsp; &nbsp; &nbsp; #appended<br />&nbsp; option &#039;device&#039; &#039;rtl8366rb&#039; <br />&nbsp; option &#039;vlan&#039; &#039;10&#039; <br />&nbsp; option &#039;ports&#039; &#039;2 3t 4t 5t&#039; </p><p>config &#039;switch_vlan&#039; &nbsp; &nbsp; &nbsp; &nbsp; #appended<br />&nbsp; option &#039;device&#039; &#039;rtl8366rb&#039; <br />&nbsp; option &#039;vlan&#039; &#039;20&#039; <br />&nbsp; option &#039;ports&#039; &#039;3t 4t 5t&#039; </p><br /><p>/etc/config/dhcp</p><p>config &#039;dhcp&#039; &#039;vlan10&#039; &nbsp; &nbsp; &nbsp; &nbsp; #appended<br />&nbsp; option &#039;interface&#039; &#039;vlan10&#039;<br />&nbsp; option &#039;leasetime&#039; &#039;12h&#039;<br />&nbsp; option &#039;start&#039; &#039;6&#039;<br />&nbsp; option &#039;limit&#039; &#039;254&#039;<br />&nbsp; &nbsp;<br />config &#039;dhcp&#039; &#039;vlan20&#039; &nbsp; &nbsp; &nbsp; &nbsp; #appended<br />&nbsp; option &#039;interface &#039;vlan20&#039; <br />&nbsp; option &#039;leasetime&#039; &#039;12h&#039;<br />&nbsp; option &#039;start&#039; &#039;6&#039; <br />&nbsp; option &#039;limit&#039; &#039;254&#039; <br />&nbsp; &nbsp;</p><p>/etc/config/firewall</p><p>config zone&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # appended<br />&nbsp; option name&nbsp; &nbsp; &nbsp; &nbsp; vlan10<br />&nbsp; option network&nbsp; &nbsp; &#039;vlan10&#039;<br />&nbsp; option input&nbsp; &nbsp; &nbsp; &nbsp; ACCEPT<br />&nbsp; option output&nbsp; &nbsp; &nbsp; &nbsp; ACCEPT<br />&nbsp; option forward&nbsp; &nbsp; REJECT</p><p>config zone&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # appended<br />&nbsp; option name&nbsp; &nbsp; &nbsp; &nbsp; vlan20<br />&nbsp; option network&nbsp; &nbsp; &#039;vlan20&#039;<br />&nbsp; option input&nbsp; &nbsp; &nbsp; &nbsp; ACCEPT<br />&nbsp; option output&nbsp; &nbsp; &nbsp; &nbsp; ACCEPT<br />&nbsp; option forward&nbsp; &nbsp; REJECT</p><p>config forwarding<br />&nbsp; option src&nbsp; &nbsp; &nbsp; &nbsp; lan<br />&nbsp; option src&nbsp; &nbsp; &nbsp; &nbsp; vlan10&nbsp; &nbsp; #appended <br />&nbsp; option src&nbsp; &nbsp; &nbsp; &nbsp; vlan20&nbsp; &nbsp; #appended<br />&nbsp; option src&nbsp; &nbsp; &nbsp; &nbsp; wan</p>											<p class="post-edited">(Last edited by <strong>@ll@n416</strong> on 20 Jan 2013, 19:36)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p171125">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">ninno</div>
					<div class="post-datetime">
						28 Jun 2012, 00:52					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>@ll@n416 wrote:</cite><blockquote><p>...<br />Trying to understand the configurations ... and set my own configuration made my unit crashed and bricked.<br />...<br />I managed to recover the unit by using the serial port and have OpenWrt backfire 10.03.1 working again.<br />...<br />Now, I don&#039;t want the unit crashed and bricked again the second time for it took me so much time recovering, working on soldering and burned serial port but still am working on the setup I want.</p></blockquote></div><p>Hmm, you did not get it back by using failsafe mode? Regularly works well.</p><br /><div class="quotebox"><cite>@ll@n416 wrote:</cite><blockquote><p>Could you please help me and verify or confirm if the following configuration will work as I wanted? Do I have missing configuration like setting STP ?<br />....<br />config forwarding<br />&nbsp; option src&nbsp; &nbsp; &nbsp; &nbsp; lan<br />&nbsp; option src&nbsp; &nbsp; &nbsp; &nbsp; vlan10&nbsp; &nbsp; #appended <br />&nbsp; option src&nbsp; &nbsp; &nbsp; &nbsp; vlan20&nbsp; &nbsp; #appended<br />&nbsp; option src&nbsp; &nbsp; &nbsp; &nbsp; wan</p></blockquote></div><p>Except for the forwarding rule this looks good (can you specify multiple &quot;option src&quot; here, never tried that)?<br />I specified one for each vlan:</p><p>config forwarding<br />&nbsp; &nbsp; option src lan<br />&nbsp; &nbsp; option dest wan</p><p>config forwarding<br />&nbsp; &nbsp; option src guestnet<br />&nbsp; &nbsp; option dest wan</p><p>...</p><br /><p>STP: Stability has been a big problem for me, STP is now disabled on the bridges. A redundant setup is not needed for the wlan, so the wlan part (three 1043nd) is connected by one uplink which holds all vlans. The rtl8366rb switch driver seemed to have some bugs in earlier -rc versions (1,5 years ago), and i was not able to specify the vlan ID correcty, so this did never match our vlan config, and i ended up with one untagged port for each vlan, while the 1043nd were connected by tagged ports among them.<br />That was unstable, networks shortened when a 1043nd was booted ect. Now this is all working great - the 1043nd dont reboot themselves anymore, and when you do it manually, they dont shorten the different vlans, it is now very stable indeed, thank you to the developers who sorted this out...</p>											<p class="post-edited">(Last edited by <strong>ninno</strong> on 28 Jun 2012, 00:53)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p171943">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">@ll@n416</div>
					<div class="post-datetime">
						10 Jul 2012, 00:10					</div>
				</div>
				<div class="post-content content">
					<p>@ ninno, </p><p>Thanks for the reply and sorry that only now I read your comment. Actually, I tried to configure again my WR1043ND using the above setup I was asking for advice. Again, my router hang and looks it was bricked but this time I managed to recover it using failsafe mode. My regret, i burned the serial port before learning this way. Hehe..</p><p>Anyway, were you suggesting me to do the forwarding rule as you have it? My goodness I overlook my wan forwarding, it should be destination. Ok, I will try it and update you with the result.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p171990">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">slippyC</div>
					<div class="post-datetime">
						10 Jul 2012, 16:38					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ninno wrote:</cite><blockquote><div class="quotebox"><cite>@ll@n416 wrote:</cite><blockquote><p>...<br />Trying to understand the configurations ... and set my own configuration made my unit crashed and bricked.<br />...<br />I managed to recover the unit by using the serial port and have OpenWrt backfire 10.03.1 working again.<br />...<br />Now, I don&#039;t want the unit crashed and bricked again the second time for it took me so much time recovering, working on soldering and burned serial port but still am working on the setup I want.</p></blockquote></div><p>Hmm, you did not get it back by using failsafe mode? Regularly works well.</p><br /><div class="quotebox"><cite>@ll@n416 wrote:</cite><blockquote><p>Could you please help me and verify or confirm if the following configuration will work as I wanted? Do I have missing configuration like setting STP ?<br />....<br />config forwarding<br />&nbsp; option src&nbsp; &nbsp; &nbsp; &nbsp; lan<br />&nbsp; option src&nbsp; &nbsp; &nbsp; &nbsp; vlan10&nbsp; &nbsp; #appended <br />&nbsp; option src&nbsp; &nbsp; &nbsp; &nbsp; vlan20&nbsp; &nbsp; #appended<br />&nbsp; option src&nbsp; &nbsp; &nbsp; &nbsp; wan</p></blockquote></div><p>Except for the forwarding rule this looks good (can you specify multiple &quot;option src&quot; here, never tried that)?<br />I specified one for each vlan:</p><p>config forwarding<br />&nbsp; &nbsp; option src lan<br />&nbsp; &nbsp; option dest wan</p><p>config forwarding<br />&nbsp; &nbsp; option src guestnet<br />&nbsp; &nbsp; option dest wan</p><p>...</p><br /><p>STP: Stability has been a big problem for me, STP is now disabled on the bridges. A redundant setup is not needed for the wlan, so the wlan part (three 1043nd) is connected by one uplink which holds all vlans. The rtl8366rb switch driver seemed to have some bugs in earlier -rc versions (1,5 years ago), and i was not able to specify the vlan ID correcty, so this did never match our vlan config, and i ended up with one untagged port for each vlan, while the 1043nd were connected by tagged ports among them.<br />That was unstable, networks shortened when a 1043nd was booted ect. Now this is all working great - the 1043nd dont reboot themselves anymore, and when you do it manually, they dont shorten the different vlans, it is now very stable indeed, thank you to the developers who sorted this out...</p></blockquote></div><p>Actually was gonna say something about having no dest... <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>Undoubtedly you know more than me @ll@n416, so figured it was just a mistake.</p><p>I did want to ask you something though.&nbsp; When you are tagging those ports in your vlans and you have them added to multiple vlans, is that what allows different ports to see your separate subnets?</p><p>There are other ways of going about seeing the separate ones, but is that what this accomplishes?</p><p>Thanks, this is really the only part I&#039;m having trouble understanding about OpenWRT and how vlans work.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p172109">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">ninno</div>
					<div class="post-datetime">
						12 Jul 2012, 08:44					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>slippyC wrote:</cite><blockquote><p>When you are tagging those ports in your vlans and you have them added to multiple vlans, is that what allows different ports to see your separate subnets?</p><p>There are other ways of going about seeing the separate ones, but is that what this accomplishes?</p></blockquote></div><p>are you talking about this?</p><div class="codebox"><pre><code>config &#039;switch_vlan&#039;         #appended
  option &#039;device&#039; &#039;rtl8366rb&#039;
  option &#039;vlan&#039; &#039;10&#039;
  option &#039;ports&#039; &#039;2 3t 4t 5t&#039;

config &#039;switch_vlan&#039;         #appended
  option &#039;device&#039; &#039;rtl8366rb&#039;
  option &#039;vlan&#039; &#039;20&#039;
  option &#039;ports&#039; &#039;3t 4t 5t&#039;</code></pre></div><p>Yes: In this setup packets on switch ports 3 and 4 are 802.1q tagged, and you can un-tag them on a client, resulting in two virtual Network interfaces which are part of vlan 10 or vlan 20 respectively. The internal Port5 does the same to address the seperate vlans.<br />Pport 2 will distribute regular untagged packets, so a client can attach to it and will be part of vlan 10 only.<br /><a href="http://en.wikipedia.org/wiki/802.1q">http://en.wikipedia.org/wiki/802.1q</a></p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>