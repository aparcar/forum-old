<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> i2c help needed for Lafonera</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 3 Apr 2018 and 15 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=32516&amp;p=2.html">2</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p146345">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">jabss</div>
					<div class="post-datetime">
						21 Oct 2011, 19:44					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>I&#039;m trying to get i2c working on a fonera with Backfire (10.03.1-RC5, r27608). Basically I need to drive a PCF8574 (GPIO expander), but I&#039;m having no success at all...</p><p>The instructions around are a bit old and mention packages that don&#039;t exist in the current release. (I&#039;m assuming everything have evolved since then and that the packages available are enough).</p><p>I installed all the packages I could (some were not possible because of dependencies), but even so I&#039;m lacking something. <br />For instance, how can we configure wich GPIOs will be the SDA and SCK pins? <br />Where can I find documentation (readme files or something equivelent) for each of these packages?</p><p>root@OpenWrt:/etc# opkg list-installed | grep i2c<br />i2c-tools - 3.0.3-1<br />kmod-i2c-algo-pcf - 2.6.30.10-1<br />kmod-i2c-core - 2.6.30.10-1</p><p>root@OpenWrt:/etc# lsmod | grep i2c<br />i2c_algo_pcf&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4432&nbsp; 0<br />i2c_dev&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4496&nbsp; 0<br />i2c_core&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;13808&nbsp; 2 i2c_algo_pcf,i2c_dev</p><p>root@OpenWrt:/etc# i2cdetect -l</p><p>Could anyone possible bring some light to the shadow?</p><p>Thanks in advance,<br />Jabss</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p146358">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						21 Oct 2011, 21:57					</div>
				</div>
				<div class="post-content content">
					<p>install kmod-i2c-gpio-custom and follow these instructions (linked on the fonera wiki page): <a href="http://code.google.com/p/fonera-i2c/wiki/FoneraHacks">http://code.google.com/p/fonera-i2c/wiki/FoneraHacks</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p146359">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">jabss</div>
					<div class="post-datetime">
						21 Oct 2011, 22:12					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>MBS wrote:</cite><blockquote><p>install kmod-i2c-gpio-custom and follow these instructions (linked on the fonera wiki page): <a href="http://code.google.com/p/fonera-i2c/wiki/FoneraHacks">http://code.google.com/p/fonera-i2c/wiki/FoneraHacks</a></p></blockquote></div><p>Thank you for your reply.</p><p>I can&#039;t find it in the corresponding repository:&nbsp; <a href="http://downloads.openwrt.org/backfire/10.03.1-rc5/atheros/packages/">http://downloads.openwrt.org/backfire/1 … /packages/</a></p><p>Would it work if I get it from somewhere else? Where? I don&#039;t know how to compile, that&#039;s why I preffer packages.</p><p>Thank you,<br />Jabss</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p146360">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						21 Oct 2011, 22:43					</div>
				</div>
				<div class="post-content content">
					<p>I found it: <a href="http://downloads.openwrt.org/backfire/10.03.1-rc5/atheros/packages/kmod-i2c-gpio-custom_2.6.30.10-2_atheros.ipk">http://downloads.openwrt.org/backfire/1 … theros.ipk</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p146363">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">jabss</div>
					<div class="post-datetime">
						22 Oct 2011, 01:49					</div>
				</div>
				<div class="post-content content">
					<p>Thank you!</p><p>I don&#039;t know how I have missed now. I know I had tried to install it before (the link was with the &quot;re-visited&quot; colour) but I was unsucessfull. Now I understand why: There is a precedence for the packages. I though opkg was like yum or apt-get that also installs dependences but that don&#039;t seems to be the case. My suggestion to whom tries the same in the future is to keep trying all possible combinations of the packages untill you get this:</p><p>root@OpenWrt:/# opkg list-installed | grep i2c<br />i2c-tools - 3.0.3-1<br />kmod-i2c-algo-bit - 2.6.30.10-1<br />kmod-i2c-algo-pcf - 2.6.30.10-1<br />kmod-i2c-core - 2.6.30.10-1<br />kmod-i2c-gpio - 2.6.30.10-1<br />kmod-i2c-gpio-custom - 2.6.30.10-2</p><p>I had seen that page before but it wasn clear what packages would be &quot;Install kernel modules that allow to use GPIO as I2C bus&quot;. With your help, I succeed! Maybe the page could be updated to be a bit more clear? Something like telling which packages to install...</p><p>Anyway, some tips for who may try this in the future: </p><p>In the instrucions page ( <a href="http://code.google.com/p/fonera-i2c/wiki/FoneraHacks">http://code.google.com/p/fonera-i2c/wiki/FoneraHacks</a> ). The mentioned caps to be removed are the tiny smd capacitors that are connected to the GPIO ports - on the upper face of the board, it&#039;s possible to see 4 tracks between the GPIOs 3 and 4 (first and second solder points of sw1), 1 and 7 (fift and seventh solder points of sw1) and a set of 4 small smd&#039;s. Take those out, as suggested. Mine only worked after I took them out.</p><p>Even if my PCF8574 is feed at 5v and fonera works at 3,3v, I&#039;m able to work with PCF and change the port bits - I was using a 7400 as a driver (to boost up 3,3 to 5), but it didn&#039;t worked. Tried direct connection and it works.</p><p>The pullup resistors are really needed and the ones I&#039;m using are around 5,5kohms (actually a 10k + 1k in parallel). It works.</p><p>Well that&#039;s it! It works!</p><p>Thank you! I really apreciate your help!<br />Jabss</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p146390">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						22 Oct 2011, 15:57					</div>
				</div>
				<div class="post-content content">
					<p>echo pcf8574 0x20 &gt; /sys/bus/i2c/devices/i2c-1/new_device</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p146402">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">jabss</div>
					<div class="post-datetime">
						22 Oct 2011, 18:08					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>MBS wrote:</cite><blockquote><p>echo pcf8574 0x20 &gt; /sys/bus/i2c/devices/i2c-1/new_device</p></blockquote></div><p>:-D</p><p>Maybe you just guessed my next obstacle :-)&nbsp; : I&#039;m able to change the ports of the PCF8574 as an entire byte, but I&#039;m still not able to do it bit by bit. I mean, for my specific purpose I need to turn on and off each bit independently. Otherwise, I have to somehow calculate the current status and send the byte that doesn&#039;t interfere with the other bits. I tried to play around with the mask switch but it doesn&#039;t seem to work. (some output below).</p><p>root@OpenWrt:/sys/bus/i2c/devices# i2cdetect -l<br />i2c-0&nbsp; &nbsp;i2c&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;i2c-gpio0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;I2C adapter<br />root@OpenWrt:/sys/bus/i2c/devices# i2cdetect 0<br />WARNING! This program can confuse your I2C bus, cause data loss and worse!<br />I will probe file /dev/i2c-0.<br />I will probe address range 0x03-0x77.<br />Continue? [Y/n] y<br />&nbsp; &nbsp; &nbsp;0&nbsp; 1&nbsp; 2&nbsp; 3&nbsp; 4&nbsp; 5&nbsp; 6&nbsp; 7&nbsp; 8&nbsp; 9&nbsp; a&nbsp; b&nbsp; c&nbsp; d&nbsp; e&nbsp; f<br />00:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -- -- -- -- -- -- -- -- -- -- -- -- --<br />10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --<br />20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --<br />30: -- -- -- -- -- -- -- -- 38 -- -- -- -- -- -- --<br />40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --<br />50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --<br />60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --<br />70: -- -- -- -- -- -- -- --<br />root@OpenWrt:/sys/bus/i2c/devices# i2cset -y 0 0x38 0x01<br />root@OpenWrt:/sys/bus/i2c/devices# (led gets on)<br />root@OpenWrt:/sys/bus/i2c/devices# i2cset -y 0 0x38 0x00<br />root@OpenWrt:/sys/bus/i2c/devices# (led gets off)<br />root@OpenWrt:/sys/bus/i2c/devices# i2cset -y -m 0x01 0 0x38 0x01<br />root@OpenWrt:/sys/bus/i2c/devices# (led gets on - I wanted the mask swith to &quot;mask&quot; it, but it didn&#039;t work)<br />root@OpenWrt:/sys/bus/i2c/devices# i2cset -y -m 0xfe 0 0x38 0x00<br />root@OpenWrt:/sys/bus/i2c/devices# (led gets off - I wanted the mask swith to &quot;mask&quot; it, this time I tried with the mask &quot;inverted&quot;. It didn&#039;t work.)</p><br /><p>Anyway, the command you gave didn&#039;t work. What is supposed to happen with that command?&nbsp; :-)</p><p>root@OpenWrt:/sys/bus/i2c/devices# echo pcf8574 0x20 &gt; /sys/bus/i2c/devices/i2c-1/new_device<br />/bin/ash: can&#039;t create /sys/bus/i2c/devices/i2c-1/new_device: nonexistent directory<br />root@OpenWrt:/sys/bus/i2c/devices#<br />root@OpenWrt:/sys/bus/i2c/devices# mkdir i2c-0<br />mkdir: cannot create directory &#039;i2c-0&#039;: No such file or directory<br />root@OpenWrt:/sys/bus/i2c/devices# touch new_device<br />touch: new_device: No such file or directory</p><br /><p>Thanks!<br />jabss</p>											<p class="post-edited">(Last edited by <strong>jabss</strong> on 22 Oct 2011, 18:24)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p146440">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						23 Oct 2011, 12:09					</div>
				</div>
				<div class="post-content content">
					<p>In your case: echo pcf8574 0x38 &gt; /sys/bus/i2c/devices/i2c-0/new_device<br />Maybe you need a more recent openwrt-image (or compile your own). There is a kernel driver for the pcf857x series, so after issuing the above command, it should create a file called /sys/class/gpio/gpiochipXX (dmesg will show the value of XX). Then issuing echo XX &gt; /sys/class/gpio/export will create a subdir named gpioXX. In there you will find files like value, where you can read/write the value of the gpio-pin, and direction, where you can set in or out.<br />So, no messing with any bits necessary :-)</p>											<p class="post-edited">(Last edited by <strong>MBS</strong> on 23 Oct 2011, 12:11)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p146483">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">jabss</div>
					<div class="post-datetime">
						24 Oct 2011, 00:42					</div>
				</div>
				<div class="post-content content">
					<p>Dear MBS,</p><p>Thanks for replying once again. You have been a tremendous help and I have been very afortunate to have your help...&nbsp; :-)</p><p>I also had tried that command with the parameters I suspected it would be correct for my system (0x38 as the chip address and 0 as i2c driver instance). Unfortunatelly it didn&#039;t work either.</p><p>root@OpenWrt:/# echo pcf8574 0x38 &gt; /sys/bus/i2c/devices/i2c-0/new_device<br />/bin/ash: can&#039;t create /sys/bus/i2c/devices/i2c-0/new_device: nonexistent directory</p><br /><p>Now, in terms of finding a solution for this problem:</p><p> I believe I already have the latest release (10.03.1-RC5). Could it happed it got broken meanwhile? What do you think if I downgrade the router to one release that possibly has that?</p><p>root@OpenWrt:/# cat /etc/banner<br />&nbsp; _______&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;________&nbsp; &nbsp; &nbsp; &nbsp; __<br /> |&nbsp; &nbsp; &nbsp; &nbsp;|.-----.-----.-----.|&nbsp; |&nbsp; |&nbsp; |.----.|&nbsp; |_<br /> |&nbsp; &nbsp;-&nbsp; &nbsp;||&nbsp; _&nbsp; |&nbsp; -__|&nbsp; &nbsp; &nbsp;||&nbsp; |&nbsp; |&nbsp; ||&nbsp; &nbsp;_||&nbsp; &nbsp;_|<br /> |_______||&nbsp; &nbsp;__|_____|__|__||________||__|&nbsp; |____|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |__| W I R E L E S S&nbsp; &nbsp;F R E E D O M<br /> Backfire (10.03.1-RC5, r27608) --------------------------<br />&nbsp; * 1/3 shot Kahlua&nbsp; &nbsp; In a shot glass, layer Kahlua<br />&nbsp; * 1/3 shot Bailey&#039;s&nbsp; on the bottom, then Bailey&#039;s,<br />&nbsp; * 1/3 shot Vodka&nbsp; &nbsp; &nbsp;then Vodka.<br /> ---------------------------------------------------<br />root@OpenWrt:/#</p><br /><p>I don&#039;t know much about development, but could it be that the &quot;kernel driver for the pcf857x series&quot; you mention would be the &quot;i2c_algo_pcf&quot;? I have that one installed and loaded.</p><p>root@OpenWrt:/sys/bus/i2c/devices# lsmod | grep i2c<br />i2c_gpio&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2272&nbsp; 0<br />i2c_gpio_custom&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 896&nbsp; 0<br />i2c_algo_pcf&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4432&nbsp; 0<br />i2c_algo_bit&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4480&nbsp; 1 i2c_gpio<br />i2c_dev&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4496&nbsp; 0<br />i2c_core&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;13808&nbsp; 4 i2c_gpio,i2c_algo_pcf,i2c_algo_bit,i2c_dev</p><p>root@OpenWrt:/sys/bus/i2c/devices# opkg list-installed | grep i2c<br />i2c-tools - 3.0.3-1<br />kmod-i2c-algo-bit - 2.6.30.10-1<br />kmod-i2c-algo-pcf - 2.6.30.10-1<br />kmod-i2c-core - 2.6.30.10-1<br />kmod-i2c-gpio - 2.6.30.10-1<br />kmod-i2c-gpio-custom - 2.6.30.10-2</p><p>root@OpenWrt:/sys/bus/i2c/devices# opkg files kmod-i2c-algo-pcf<br />Package kmod-i2c-algo-pcf (2.6.30.10-1) is installed on root and has the following files:<br />/etc/modules.d/55-i2c-algo-pcf<br />/lib/modules/2.6.30.10/i2c-algo-pcf.ko</p><p>Maybe the way of enabling a PCF chip has changed? Where can we find more information about these packages? A readme would be great....</p><p>Any idea?</p><p>Thanks!<br />Jabss</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p146485">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						24 Oct 2011, 02:04					</div>
				</div>
				<div class="post-content content">
					<p>OK, I finally fired up my test station (TL-WR1043) to get exact syntax:<br /></p><div class="codebox"><pre><code> _______                     ________        __
 |       |.-----.-----.-----.|  |  |  |.----.|  |_
 |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|
 |_______||   __|_____|__|__||________||__|  |____|
          |__| W I R E L E S S   F R E E D O M
 ATTITUDE ADJUSTMENT (bleeding edge, r28352) ----------
  * 1/4 oz Vodka      Pour all ingredients into mixing
  * 1/4 oz Gin        tin with ice, strain into glass.
  * 1/4 oz Amaretto
  * 1/4 oz Triple sec
  * 1/4 oz Peach schnapps
  * 1/4 oz Sour mix
  * 1 splash Cranberry juice
 -----------------------------------------------------
root@OpenWrt:~# i2cdetect -l
i2c-0   i2c             i2c-tiny-usb at bus 001 device 002      I2C adapter
root@OpenWrt:~# i2cdetect -y 0
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- -- 
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
20: 20 -- 22 -- -- -- -- -- -- -- -- -- -- -- -- -- 
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
70: -- -- -- -- -- -- -- --                         
root@OpenWrt:~# echo pcf8575 0x20 &gt; /sys/bus/i2c/
devices/           drivers_autoprobe  uevent
drivers/           drivers_probe
root@OpenWrt:~# echo pcf8575 0x20 &gt; /sys/bus/i2c/devices/i2c-0/new_device 
root@OpenWrt:~# dmesg | tail
br-lan: port 2(wlan0) entering forwarding state
br-lan: port 2(wlan0) entering forwarding state
device wlan0 left promiscuous mode
br-lan: port 2(wlan0) entering forwarding state
device wlan0 entered promiscuous mode
br-lan: port 2(wlan0) entering forwarding state
br-lan: port 2(wlan0) entering forwarding state
ar71xx-wdt: enabling watchdog timer
pcf857x 0-0020: gpios 48..63 on a pcf8575
i2c i2c-0: new_device: Instantiated device pcf8575 at 0x20</code></pre></div><p>The kernel module is called pcf857x (the package should be called kmod-pcf857x) and is included in trunk since this month. Although it was sometimes already selected by default for certain platforms (like mine), where it is built already into the kernel (no module). I don&#039;t know about your platform, I haven&#039;t seen the package there (maybe it is already included in the kernel). Anyways, you probably need to upgrade to trunk (<a href="http://downloads.openwrt.org/snapshots/trunk/atheros/">http://downloads.openwrt.org/snapshots/trunk/atheros/</a>), this way of instanciating was added to the pcf857x driver about one year ago, while your kernel version seems to be much older.<br />i2c-algo-pcf is not needed in your case. This is another i2c-adapter, but you are using i2c-gpio-custom adapter.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p146688">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">jabss</div>
					<div class="post-datetime">
						26 Oct 2011, 02:49					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>I have installed the latest trunk:</p><div class="codebox"><pre><code>root@OpenWrt:/sys/class# cat /etc/banner
  _______                     ________        __
 |       |.-----.-----.-----.|  |  |  |.----.|  |_
 |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|
 |_______||   __|_____|__|__||________||__|  |____|
          |__| W I R E L E S S   F R E E D O M
 ATTITUDE ADJUSTMENT (bleeding edge, r28504) ----------
  * 1/4 oz Vodka      Pour all ingredients into mixing
  * 1/4 oz Gin        tin with ice, strain into glass.
  * 1/4 oz Amaretto
  * 1/4 oz Triple sec
  * 1/4 oz Peach schnapps
  * 1/4 oz Sour mix
  * 1 splash Cranberry juice
 -----------------------------------------------------
root@OpenWrt:/sys/class# uname -a
Linux OpenWrt 2.6.37.6 #1 Sat Oct 22 02:27:11 MST 2011 mips GNU/Linux</code></pre></div><p>and the I2c packages</p><div class="codebox"><pre><code>root@OpenWrt:/sys/class# opkg list-installed | grep i2c
i2c-tools - 3.0.3-1
kmod-i2c-algo-bit - 2.6.37.6-1
kmod-i2c-core - 2.6.37.6-1
kmod-i2c-gpio - 2.6.37.6-1
kmod-i2c-gpio-custom - 2.6.37.6-2</code></pre></div><p>I was now able to issue the desired command and get some propper answer:</p><div class="codebox"><pre><code>root@OpenWrt:~# echo pcf8574 0x38 &gt; /sys/bus/i2c/devices/i2c-0/new_device
i2c i2c-0: new_device: Instantiated device pcf8574 at 0x38</code></pre></div><p>Great! But I&#039;m not able to find any &quot;export&quot; directory within /sys/class to issue the next command (echo 0x38 &gt; /sys/class/gpio/export ):</p><div class="codebox"><pre><code>root@OpenWrt:/sys/class# ls /sys/class/
bdi         gpiodev     leds        misc        pci_bus     tty
block       i2c-dev     mdio_bus    mtd         ppp
firmware    ieee80211   mem         net         spi_master
root@OpenWrt:/sys/class# ls /sys/class/gpiodev/
gpio
root@OpenWrt:/sys/class# ls /sys/class/gpiodev/gpio/
dev        subsystem  uevent
root@OpenWrt:/sys/class# ls /sys/class/gpiodev/gpio/subsystem/
gpio
root@OpenWrt:/sys/class# ls /sys/class/gpiodev/gpio/subsystem/gpio/
dev        subsystem  uevent
root@OpenWrt:/sys/class# cat /sys/class/gpiodev/gpio/subsystem/gpio/dev
254:0
root@OpenWrt:/sys/class# cat /sys/class/gpiodev/gpio/subsystem/gpio/uevent
MAJOR=254
MINOR=0
DEVNAME=gpio
root@OpenWrt:/sys/class#</code></pre></div><p>/sys/class/gpio/export doesn&#039;t exist...&nbsp; Maybe I&#039;m missing some GPIO package?</p><div class="codebox"><pre><code>root@OpenWrt:/sys/class# opkg list-installed | grep -i gpio
gpioctl - 1.0-1
kmod-i2c-gpio - 2.6.37.6-1
kmod-i2c-gpio-custom - 2.6.37.6-2</code></pre></div><p>I also looked into /sys/class/i2c-dev:<br /></p><div class="codebox"><pre><code>root@OpenWrt:/sys/devices/platform/i2c-gpio.0/i2c-0/i2c-dev/i2c-0# ls
dev        device     name       subsystem  uevent
root@OpenWrt:/sys/devices/platform/i2c-gpio.0/i2c-0/i2c-dev/i2c-0# cd device/
root@OpenWrt:/sys/devices/platform/i2c-gpio.0/i2c-0# ls
0-0038         i2c-dev        new_device     uevent
delete_device  name           subsystem
root@OpenWrt:/sys/devices/platform/i2c-gpio.0/i2c-0# cat new_device
cat: can&#039;t open &#039;new_device&#039;: Permission denied
root@OpenWrt:/sys/devices/platform/i2c-gpio.0/i2c-0# cd 0-0038/
root@OpenWrt:/sys/devices/platform/i2c-gpio.0/i2c-0/0-0038# ls
modalias   name       subsystem  uevent
root@OpenWrt:/sys/devices/platform/i2c-gpio.0/i2c-0/0-0038#</code></pre></div><p>I feel I&#039;m close, but I&#039;m missing just a bit...</p><p>Any suggestion?</p><p>Thanks!<br />Jabss</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p146714">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						26 Oct 2011, 11:22					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>jabss wrote:</cite><blockquote><div class="codebox"><pre><code>root@OpenWrt:~# echo pcf8574 0x38 &gt; /sys/bus/i2c/devices/i2c-0/new_device
i2c i2c-0: new_device: Instantiated device pcf8574 at 0x38</code></pre></div></blockquote></div><p>If that&#039;s the whole message you get, it means the gpiodevice has not yet been created. I remeber a posting in the mailing list two days ago, mentioning to get support for gpiolib on atheros platform. I guess that is the reason. From what I understand, pcf857x depends on gpiolib, so it probably has not been compiled for your platform. I only see a chance for the moment, that you build your own image from trunk with the patch from the following posting applied:<br /><a href="http://patchwork.openwrt.org/patch/1452/">http://patchwork.openwrt.org/patch/1452/</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p146949">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">jabss</div>
					<div class="post-datetime">
						29 Oct 2011, 01:45					</div>
				</div>
				<div class="post-content content">
					<p>Hello again,</p><p>Maybe I&#039;m runnig the risk of geeting a little bit out of topic, but I&#039;m afraid I have no idea how to add a patch...<br />Well, to be honest, I neither know how to build my own image. </p><p>I&#039;m good in troubleshooting and configuring within Unix/linux, but I&#039;m null when programing and compiling.... <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>Will I need a VMWare environment?</p><p>By the way, do you use any buffer in your device? Something like 7405? I&#039;ve read somewhere that it&#039;s good to protect the router GPIO&#039;s and to step up the 3.3v to 5v... <br />If that&#039;s the case, where would you place the I2c pull-up resistors? After or before the buffer? Maybe in both?</p><p>Thanks!<br />Joaoabs</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p146963">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						29 Oct 2011, 11:44					</div>
				</div>
				<div class="post-content content">
					<p>Building an image is pretty easy (but can take some hours compiling). You probably need some Unix/Linux environment. Then follow <a href="http://wiki.openwrt.org/doc/howto/buildroot.exigence">http://wiki.openwrt.org/doc/howto/buildroot.exigence</a><br />Enter the top level directory of your build environment (normally called trunk) and issue<br /></p><div class="codebox"><pre><code>patch -p0 &lt; /tmp/patchfile.diff</code></pre></div><p>(change /tmp/patch.diff to the location of your patch file).<br />Then continue building with <a href="http://wiki.openwrt.org/doc/howto/build">http://wiki.openwrt.org/doc/howto/build</a><br />I don&#039;t do levelshifting at the moment, my bus runs at 5V. Although, from what I read, you can easily shift the voltage level using just a regular MOSFET (like 2N7000). Page 10 of <a href="http://ics.nxp.com/support/documents/interface/pdf/an97055.pdf">http://ics.nxp.com/support/documents/in … n97055.pdf</a> shows how to do that.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p147020">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">jabss</div>
					<div class="post-datetime">
						30 Oct 2011, 04:37					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>Still no luck....<br />Created a kind of vm machine based on pendriveinux with portable ubuntu and created the compiling environment.</p><p>What next?<br /></p><div class="quotebox"><blockquote><p>mkdir ~/openwrt<br />cd openwrt<br />svn co svn://svn.openwrt.org/openwrt/trunk/<br />cd trunk<br />./scripts/feeds update -a<br />./scripts/feeds install -a</p><p>(copied and pasted the patch text from the webpage to a file)<br />patch -p0 &lt; /tmp/patchfile.diff</p><p>make defconfig<br />make prereq<br />make menuconfig&nbsp; (changed the arch to ateros 231x)<br />make </p><p>4 hours later:<br />flashed images from trunk/bin/atheros/<br /> openwrt-atheros-vmlinux.lzma<br /> openwrt-atheros-root.squashfs</p></blockquote></div><p>booted system and installed kmod-i2c-gpio-custom. Followed again the instructions from <a href="http://code.google.com/p/fonera-i2c/wiki/FoneraHacks">http://code.google.com/p/fonera-i2c/wiki/FoneraHacks</a></p><p>The new system worked as before. I&#039;m able to detect the i2C bus and the devices. However, there is no path /sys/class/gpio/export.</p><p>Should it be like this or did I probabily do something wrong?</p><p>Thanks,<br />Jabss</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p147038">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						30 Oct 2011, 12:29					</div>
				</div>
				<div class="post-content content">
					<p>So, I assume patching worked without any issues? Then, in menuconfig, submenu Kernel modules, section I2C support: are kmod-i2c-gpio-custom and kmod-pcf857x selected?<br />Are gpiolib.o and pcf857x.o built? Check that in directory build/linux*/linux*/drivers/gpio (* is my placeholder for version or target specific names. when in a good shell, hit Tab-key for auto completion in that case).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p147096">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">jabss</div>
					<div class="post-datetime">
						31 Oct 2011, 02:50					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>No success yet...<br />I have tried everything back again three times and I&#039;m still on the same page.</p><p>Firstly I tried patching with &quot;patch -p0 &lt; patchfile.diff&quot; and didn&#039;t work. (I copied the patch from the site and pasted into a text-file).<br />The patching working OK. The &quot;/openwrt/trunk/build_dir/linux-atheros/linux-2.6.37.6/drivers/gpio&quot; directory had both gpiolib.c and pcf857x.c files (note: .c files, not .o - Does it matter the difference?)</p><p>Anyway, I contacted the patch author who advised me to download the patch as a file, and put it in &quot;/openwrt/trunk/target/linux/atheros/patches-xxxx&quot;. Then it was just to re-build the image and try again.</p><p>Then, I figured out that I had both &quot;openwrt/trunk/target/linux/atheros/patches-2.6.38&quot; and &quot;openwrt/trunk/target/linux/atheros/patches-2.6.37&quot; directories. I had copied to the latest release (*38) and then realised that the level being build was the *37, so I copied the patch to the *37 and tried everyting back again.</p><p>In every time, I flashed the fonera, and add and configure the kmod-i2c-gpio-custom_2.6.37.6-2_atheros.ipk package.<br />I test the i2cbus sucessfully and try the command </p><div class="quotebox"><blockquote><p>echo pcf8574 0x38 &gt; /sys/bus/i2c/devices/i2c-0/new_device<br />i2c i2c-0: new_device: Instantiated device pcf8574 at 0x38</p></blockquote></div><p>I still don&#039;t have the desired directory structure:<br /></p><div class="quotebox"><blockquote><p>root@OpenWrt:/sys/class# ls<br />bdi&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gpiodev&nbsp; &nbsp; &nbsp;leds&nbsp; &nbsp; &nbsp; &nbsp; misc&nbsp; &nbsp; &nbsp; &nbsp; pci_bus&nbsp; &nbsp; &nbsp;tty<br />block&nbsp; &nbsp; &nbsp; &nbsp;i2c-dev&nbsp; &nbsp; &nbsp;mdio_bus&nbsp; &nbsp; mtd&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ppp<br />firmware&nbsp; &nbsp; ieee80211&nbsp; &nbsp;mem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;net&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;spi_master<br />root@OpenWrt:/sys/class# cd gpiodev/<br />root@OpenWrt:/sys/class/gpiodev# ls<br />gpio<br />root@OpenWrt:/sys/class/gpiodev# cd gpio/<br />root@OpenWrt:/sys/devices/virtual/gpiodev/gpio# ls<br />dev&nbsp; &nbsp; &nbsp; &nbsp; subsystem&nbsp; uevent<br />root@OpenWrt:/sys/devices/virtual/gpiodev/gpio#</p></blockquote></div><p>What am I doing wrong???</p><p>Thanks for all of your tremendous help!<br />Jabss</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p147125">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						31 Oct 2011, 12:37					</div>
				</div>
				<div class="post-content content">
					<p>it has to be pcf857x.o and gpiolib.o. Files with extension .c are source code, while files with extension .o are already compiled. So now you should check if the patch got successfully applied.<br />As an example from the patch:<br /></p><div class="codebox"><pre><code>--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
####Means that in your kernel directory the above file gets changed####
@@ -111,7 +111,7 @@ config ATHEROS_AR231X
####somewhere around line 111 in section &quot;config ATHEROS_AR231X####
     select SYS_HAS_CPU_MIPS32_R1
     select SYS_SUPPORTS_BIG_ENDIAN
     select SYS_SUPPORTS_32BIT_KERNEL
-    select GENERIC_GPIO
+    select ARCH_REQUIRE_GPIOLIB
     select SYS_HAS_EARLY_PRINTK
     help
       Support for AR231x and AR531x based boards
####the line starting with - gets deleted and the line starting with + gets added####</code></pre></div><p>So parse through the patch and check that all changes are made in your local trunk copy.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p147186">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">jabss</div>
					<div class="post-datetime">
						1 Nov 2011, 05:33					</div>
				</div>
				<div class="post-content content">
					<p>Yes, definetelly, the patch is not being applied.<br />I&#039;ve tried several times with the patch -p0 &lt; file command but the target files are not being updated.<br />(appliying the patch only creates a directory in trunk named &quot;b&quot;: trunk/b/target/linux/atheros/patches-2.6.37/300-sysfs_for_gpio.patch)</p><p>I&#039;ve also copied the file to the &quot;/openwrt/trunk/target/linux/atheros/patches--2.6.37&quot; without any result.</p><p>Do I have to build differently? I&#039;m just running the &quot;make&quot; command.</p><p>I could always apply the patch manually, but it&#039;s about 500 lines... (and I wouldn&#039;t know what to do with the &quot;+-&quot; lines).</p><p>Thanks,<br />Jabss</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p147196">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						1 Nov 2011, 09:52					</div>
				</div>
				<div class="post-content content">
					<p>ok, seems like this patch has to be applied with -p1 instead of -p0. This is a patchfile within a patchfile. On every pass it is applied, it removes the leading + or - in every line. So +- will become - in the next step. The patchfile inside also needs to be applied with -p1.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p147585">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						4 Nov 2011, 16:32					</div>
				</div>
				<div class="post-content content">
					<p>it might be necessary to issue an make clean (or even make dirclean), so that the build system runs its patches (assuming target/linux/atheros/patches-2.6.37/300-sysfs_for_gpio.patch exists).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p147719">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">jabss</div>
					<div class="post-datetime">
						6 Nov 2011, 03:25					</div>
				</div>
				<div class="post-content content">
					<p>Hello again,</p><p>I don&#039;t know what else to do.... <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>I&#039;ve been strugling with the patch and simply it&#039;s not applied correctly. I don&#039;t know why, but I&#039;m not surprised - I don&#039;t know much about compiling/patching and most likelly I&#039;m doing a dumb mistake.</p><p>I tried &quot;make clean&quot;, &quot;make cleandir&quot;, I even created a new build environment in a different computer (this one is a real PC with ubuntu, not virtual as the previous).&nbsp; Tried &quot;patch -p0 &lt; FILE&quot;, &quot;patch -p1 &lt; FILE&quot;, even &quot;patch -p4 &lt; FILE&quot; with no luck. I also tried running the patch command both in the &quot;trunk&quot; dir as well in the &quot;target&quot; dir, as it seems that when is applied in the &quot;trunk&quot; directroy, a &quot;b&quot; directory is created in &quot;trunk&quot; - I have no idea if it should be like that or not...</p><p>I&#039;m not even trying to flash the fonera anymore - Just checking the &quot;..../trunk/build_dir/linux-atheros/linux-2.6.37.6/drivers/gpio&quot; directory seeking for .o files and nothing...</p><p>I also check the first file refered by the patch (/arch/mips/Kconfig) wich I believe in my build environment should be &quot;.../trunk/build_dir/linux-atheros/linux-2.6.37.6/arch/mips/Kconfig&quot; and the line &quot;+-&nbsp; &nbsp; &nbsp; select GENERIC_GPIO&quot; is always there (it should be deleted, right?).</p><p>I&#039;m not sure I have understand what should I do when a patchfile is whithin a patch file. I think when I run the &quot;patch -p1 &lt; FILE&quot; (under the target directroy), another patch file named &quot;300-add_gpiolib_support.patch&quot; is saved in &quot;.../trunk/target/linux/atheros/patches-2.6.37&quot;.&nbsp; Should I go there and run &quot;patch -p1 &lt; 300-add_gpiolib_support.patch&quot; ? Tried anyway and it seems not to work...</p><p>I&#039;m getting a bit desesperate. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Any suggestion?</p><p>Thanks!<br />Jabss</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p147740">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						6 Nov 2011, 14:17					</div>
				</div>
				<div class="post-content content">
					<p>OK, I tried it.<br />1. Downloaded <a href="http://patchwork.openwrt.org/patch/1452/raw/">http://patchwork.openwrt.org/patch/1452/raw/</a> to parent dir of my trunk<br />2. enter trunk and issue<br /></p><div class="codebox"><pre><code>trunk&gt; patch -p1 &lt; ../OpenWrt-Devel-Move-atheros-platforms-to-sysfs-style-gpio.patch 
patching file target/linux/atheros/patches-2.6.37/300-sysfs_for_gpio.patch</code></pre></div><p>That created the above file.<br />3. run &quot;make menuconfig&quot; to select the atheros target<br />4. run &quot;make kernel_menuconfig&quot;: it downloads and patches a 2.6.37.6 kernel and runs its menuconfig. I checked the first and last two files which get patched - everything looks OK.<br />If that doesn&#039;t work for you, then please start from scratch again and post your console output. In case of any error, either fix it or report it back here - just don&#039;t skip it.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p147777">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">jabss</div>
					<div class="post-datetime">
						6 Nov 2011, 21:59					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>Some improvements, but still with no success... <br />I can now see that with make kernel_menuconfig the patch is correctly applied. I have also checked some files pointed by the patch file and the patched entries are there.</p><p>However, there is still no .o files in the build directory...</p><div class="codebox"><pre><code>jabss@blackpearl:/mnt/storage/trunk$ ls -larth build_dir/linux-atheros/linux-2.6.37.6/drivers/gpio | grep &quot;\.o&quot;
-rw-r--r--  1 jabss jabss    8 2011-11-06 01:11 built-in.o
-rw-r--r--  1 jabss jabss  120 2011-11-06 01:11 .built-in.o.cmd
-rw-r--r--  1 jabss jabss    0 2011-11-06 19:25 modules.order</code></pre></div><p>Is it possible that it was built anyway but iwithout the .o files in this directory?</p><p>I suspect it must be some option I&#039;m not sellecting in make menuconfig. I&#039;ve added all the I2C (with *, not M), and all the GPIO&#039;s I could find in the submenus.</p><p>Besides kmod-i2c-gpio-custom and kmod-pcf857x in the I2C section of kernel modules, what should I choose in order to have GPIOLIB?<br />There is no GPIOLIB item in the libraries section...</p><p>Thanks,<br />Jabss</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p147782">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						6 Nov 2011, 22:51					</div>
				</div>
				<div class="post-content content">
					<p>make kernel_menuconfig does not build the kernel. It is supposed to configure the kernel (with more options than buildroot offers). It is just a side effect, that it has to download, extract and apply patches, which I abused to see if the patches get applied properly (I did not want to build the whole toolchain, which takes hours on my computer).<br />So you have to issue make from trunk dir, to get the modules compiled. The use of GPIOLIB has already been selected by the patch.</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=32516&amp;p=2.html">2</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>