<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> mwan3; multi-wan policy routing (general topic)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 22 May 2013 and 6 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 33 of 65</div><nav><ul><li><a href="viewtopic.php%3Fid=39052&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=31.html">31</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=32.html">32</a></li><li class="pagination-current"><span>33</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=34.html">34</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=35.html">35</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p237493">
				<div class="post-metadata">
					<div class="post-num">Post #801</div>
					<div class="post-author">qasdfdsaq</div>
					<div class="post-datetime">
						20 Jun 2014, 16:54					</div>
				</div>
				<div class="post-content content">
					<div class="codebox"><pre><code>ps -w </code></pre></div><p>To stop it truncating to your terminal width.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p237599">
				<div class="post-metadata">
					<div class="post-num">Post #802</div>
					<div class="post-author">rhunwicks</div>
					<div class="post-datetime">
						21 Jun 2014, 19:17					</div>
				</div>
				<div class="post-content content">
					<p>I can confirm that ps -w solves the problem - the full line in /usr/sbin/mwan3 is now</p><div class="codebox"><pre><code>if [ -n &quot;$(ps -w | grep mwan3track | grep -v grep | sed &#039;/.*\/usr\/sbin\/mwan3track \([^ ]*\) .*$/!d;s//\1/&#039; | awk &#039;$1 == (&quot;&#039;$1&#039;&quot;)&#039;)&quot; ]; then</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p237612">
				<div class="post-metadata">
					<div class="post-num">Post #803</div>
					<div class="post-author">kpv</div>
					<div class="post-datetime">
						21 Jun 2014, 21:43					</div>
				</div>
				<div class="post-content content">
					<p>What would be the recommended way to implement &quot;WAN persistence&quot; when having more than 2 WANs ? (i.e. what is currently achieved with the &quot;sticky_odd&quot; and &quot;sticky_even&quot; rules)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p237764">
				<div class="post-metadata">
					<div class="post-num">Post #804</div>
					<div class="post-author">jigglywiggly</div>
					<div class="post-datetime">
						23 Jun 2014, 01:54					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hi jigglywiggly,</p><br /><p>Thanks for the update. Donwgrading to version 1.3 does not help if you conclude that interface eth1 is still not working after stopping mwan3... Besides, version 1.3 is buggy when it comes to load-balancing (active-failover should work ok).</p><p>I would completly remove mwan3 and see if you can still get eth1 to fail. Good luck</p></blockquote></div><p>I&#039;m on mwan3 1.3 at the moment and I haven&#039;t had the same issue. 1.3 is buggier in terms of when an interface goes offline it might say it is still up/keep switching. That and if I apply new rules I have to reset the interfaces manually(but only then). In 1.4 if I apply new rules all my connections stay up. Even if I don&#039;t change anything eth1 will turn off eventually for v4 traffic in 1.4.</p><p>I&#039;ll stay on 1.3 for a while longer to see if the same problem eventually happens. If it doesn&#039;t, I&#039;ll try 1.4 again and see if it&#039;s 100% consistent.</p>											<p class="post-edited">(Last edited by <strong>jigglywiggly</strong> on 23 Jun 2014, 01:55)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p237789">
				<div class="post-metadata">
					<div class="post-num">Post #805</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						23 Jun 2014, 10:24					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>rhunwicks wrote:</cite><blockquote><p>I can confirm that ps -w solves the problem - the full line in /usr/sbin/mwan3 is now</p><div class="codebox"><pre><code>if [ -n &quot;$(ps -w | grep mwan3track | grep -v grep | sed &#039;/.*\/usr\/sbin\/mwan3track \([^ ]*\) .*$/!d;s//\1/&#039; | awk &#039;$1 == (&quot;&#039;$1&#039;&quot;)&#039;)&quot; ]; then</code></pre></div></blockquote></div><br /><p>I will add it to the new version asap.. Thnx for finding this!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238163">
				<div class="post-metadata">
					<div class="post-num">Post #806</div>
					<div class="post-author">md55</div>
					<div class="post-datetime">
						26 Jun 2014, 23:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>arfett wrote:</cite><blockquote><div class="quotebox"><cite>md55 wrote:</cite><blockquote><p>Hello<br />I&#039;m using mwan3 to make port 80 open on both wans.<br />Also I have openvpn server with cheap traffic, so I use it as default route.<br />While openvpn is connected everything works fine. But when it disconnects, tun0 iface goes down and mwan routes all traffic via wan1. <br />How can I deny this?<br />I need to have only some specific routes via wan1 and wan2: to dns, no-ip and vpn server, but mwan config requires default routes on these ifaces.</p></blockquote></div><p>Could we see your mwan3 config file?</p></blockquote></div><p>Here it is. I just replaced real ips with &lt;wan1subnet&gt; and &lt;wan2subnet&gt;:<br /></p><div class="codebox"><pre><code>config &#039;interface&#039; &#039;wan1&#039;
    option &#039;enabled&#039; &#039;1&#039;
    option &#039;reroute&#039; &#039;1&#039;
config &#039;interface&#039; &#039;wan2&#039;
    option &#039;enabled&#039; &#039;1&#039;
    option &#039;reroute&#039; &#039;1&#039;
config &#039;interface&#039; &#039;wan_openvpn&#039;
    option &#039;enabled&#039; &#039;1&#039;
    option &#039;reroute&#039; &#039;1&#039;

config &#039;member&#039; &#039;wan1_m1&#039;
    option &#039;interface&#039; &#039;wan1&#039;
    option &#039;metric&#039; &#039;1&#039;
    option &#039;weight&#039; &#039;1&#039;
config &#039;member&#039; &#039;wan2_m2&#039;
    option &#039;interface&#039; &#039;wan2&#039;
    option &#039;metric&#039; &#039;2&#039;
    option &#039;weight&#039; &#039;1&#039;
config &#039;member&#039; &#039;openvpn_m5&#039;
    option &#039;interface&#039; &#039;wan_openvpn&#039;
    option &#039;metric&#039; &#039;5&#039;
    option &#039;weight&#039; &#039;1&#039;

config &#039;policy&#039; &#039;wan1_only&#039;
    list &#039;use_member&#039; &#039;wan1_m1&#039;
config &#039;policy&#039; &#039;wan2_only&#039;
    list &#039;use_member&#039; &#039;wan2_m2&#039;
config &#039;policy&#039; &#039;openvpn_only&#039;
    list &#039;use_member&#039; &#039;openvpn_m5&#039;

config &#039;rule&#039; &#039;rule10&#039;
    option &#039;dest_ip&#039; &#039;&lt;wan1subnet&gt;&#039;
    option &#039;use_policy&#039; &#039;wan1_only&#039;
config &#039;rule&#039; &#039;rule20&#039;
    option &#039;dest_ip&#039; &#039;&lt;wan2subnet&gt;&#039;
    option &#039;use_policy&#039; &#039;wan2_only&#039;
config &#039;rule&#039; &#039;rule50&#039;
    option &#039;dest_ip&#039; &#039;0.0.0.0/0&#039;
    option &#039;use_policy&#039; &#039;openvpn_only&#039;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238240">
				<div class="post-metadata">
					<div class="post-num">Post #807</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						27 Jun 2014, 11:57					</div>
				</div>
				<div class="post-content content">
					<p>Hi md55,</p><p>As you dont use the track_ip option, mwan3 assumes that the interface is always UP, even though it isn&#039;t. That is why the router still tries to forward the traffic, even if the tun interface is unaivailable. To fix this add track_ip options to the vpn interface in your mwan3 config.</p><p>On a side note, the reroute option is obsolete since version 1.4 and does not do anything. You can remove it.</p><p>Grtz Adze.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238303">
				<div class="post-metadata">
					<div class="post-num">Post #808</div>
					<div class="post-author">md55</div>
					<div class="post-datetime">
						27 Jun 2014, 22:43					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hi md55,</p><p>As you dont use the track_ip option, mwan3 assumes that the interface is always UP, even though it isn&#039;t. That is why the router still tries to forward the traffic, even if the tun interface is unaivailable. To fix this add track_ip options to the vpn interface in your mwan3 config.</p><p>On a side note, the reroute option is obsolete since version 1.4 and does not do anything. You can remove it.</p><p>Grtz Adze.</p></blockquote></div><p>Hi Adze<br />I need to always forward all traffic to vpn, even when it&#039;s down, but mwan routes traffic via wan1 when vpn is down.<br />It&#039;s a problem for me. I guess when vpn is down mwan uses default routing table for some reason.<br />How can I deny all traffic except to wan1subnet being routed via wan1?<br />Btw I still use mwan3_1.3</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238654">
				<div class="post-metadata">
					<div class="post-num">Post #809</div>
					<div class="post-author">Vahe91</div>
					<div class="post-datetime">
						30 Jun 2014, 23:57					</div>
				</div>
				<div class="post-content content">
					<p>How to make that a specific site was opened only through one interface ?<br />Please help.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238660">
				<div class="post-metadata">
					<div class="post-num">Post #810</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						1 Jul 2014, 00:49					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Vahe91 wrote:</cite><blockquote><p>How to make that a specific site was opened only through one interface ?<br />Please help.</p></blockquote></div><p>You have two options:<br />1. Follow the guide in the wiki - <a href="http://wiki.openwrt.org/doc/howto/mwan3">http://wiki.openwrt.org/doc/howto/mwan3</a><br />Use the IP address(es) of the website as the destination in MWAN3 rules.</p><p>2. Create static routes in OpenWrt directing the IP address(es) of the website out the desired interface.</p>											<p class="post-edited">(Last edited by <strong>arfett</strong> on 1 Jul 2014, 00:51)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238687">
				<div class="post-metadata">
					<div class="post-num">Post #811</div>
					<div class="post-author">gh0st</div>
					<div class="post-datetime">
						1 Jul 2014, 11:54					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adze,</p><p>i have a little problem, might be as well just understanding issue, with the mwan3 package in use with strongswan 5.1.3 net-to-net.<br />mwan is configured with 2 wan interfaces, load balancing is default.<br />After starting strongswan, routes and firewall rules are set up to make the ipsec tunnel accessible.</p><p>strongswan does initialize the ipsec tunnel via wan without problems, it is possible to ping the remote subnet from openwrt but packets from local subnet get lost somewhere...</p><p>It seems, packets are sent out from local subnet to remote subnet correctly (i can see the ping arriving on remote) but the reply is not forwarded. </p><p>After stopping mwan3 everything works as expected, so my suspicion is some rule that can not match the returning packet and dropping it. </p><p>Any ideas are very much appreciated <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>[edit]<br />version is latest from github, 1.4-20<br />[/edit]</p><p>Details on Configuration:<br />/etc/config/mwan3 (pretty much default ...)<br /></p><div class="codebox"><pre><code>config rule &#039;sticky_even&#039;
    option src_ip &#039;0.0.0.0/0.0.0.1&#039;
    option dest_port &#039;443&#039;
    option proto &#039;tcp&#039;
    option use_policy &#039;wan_umts&#039;

config rule &#039;sticky_odd&#039;
    option src_ip &#039;0.0.0.1/0.0.0.1&#039;
    option dest_port &#039;443&#039;
    option proto &#039;tcp&#039;
    option use_policy &#039;umts_wan&#039;

config rule &#039;default_rule&#039;
    option dest_ip &#039;0.0.0.0/0&#039;
    option use_policy &#039;balanced&#039;

config interface &#039;wan&#039;
    option enabled &#039;1&#039;
    option count &#039;1&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;8&#039;
    list track_ip &#039;8.8.8.8&#039;
    option reliability &#039;1&#039;

config interface &#039;umts&#039;
    option enabled &#039;1&#039;
    option count &#039;1&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;8&#039;
    option reliability &#039;1&#039;
    list track_ip &#039;8.8.8.8&#039;
    

config member &#039;wan_m1_w3&#039;
    option interface &#039;wan&#039;
    option metric &#039;1&#039;
    option weight &#039;3&#039;

config member &#039;wan_m2_w3&#039;
    option interface &#039;wan&#039;
    option metric &#039;2&#039;
    option weight &#039;3&#039;

config member &#039;umts_m1_w2&#039;
    option interface &#039;umts&#039;
    option metric &#039;1&#039;
    option weight &#039;2&#039;

config member &#039;umts_m2_w2&#039;
    option interface &#039;umts&#039;
    option metric &#039;2&#039;
    option weight &#039;2&#039;

config policy &#039;wan_only&#039;
    list use_member &#039;wan_m1_w3&#039;

config policy &#039;umts_only&#039;
    list use_member &#039;umts_m1_w2&#039;

config policy &#039;balanced&#039;
    list use_member &#039;wan_m1_w3&#039;
    list use_member &#039;umts_m1_w2&#039;

config policy &#039;wan_umts&#039;
    list use_member &#039;wan_m1_w3&#039;
    list use_member &#039;umts_m2_w2&#039;

config policy &#039;umts_wan&#039;
    list use_member &#039;wan_m2_w3&#039;
    list use_member &#039;umts_m1_w2&#039;</code></pre></div><p>Output of ip rule show (with mwan3 running)<br /></p><div class="codebox"><pre><code>root@box:~# ip rule show
0:    from all lookup local 
220:    from all lookup 220 
1002:    from all iif 3g-umts lookup main 
2002:    from all fwmark 0x200/0xff00 lookup 2 
2254:    from all fwmark 0xfe00/0xff00 unreachable
32766:    from all lookup main 
32767:    from all lookup default </code></pre></div><p>ip route show table&nbsp; 220<br /></p><div class="codebox"><pre><code>root@box:~# ip route show table 220
{remote subnet} dev ipsec0  proto static  src {ip of box}</code></pre></div>											<p class="post-edited">(Last edited by <strong>gh0st</strong> on 1 Jul 2014, 11:57)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238689">
				<div class="post-metadata">
					<div class="post-num">Post #812</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						1 Jul 2014, 12:07					</div>
				</div>
				<div class="post-content content">
					<p>Hi Ghost,</p><br /><p>Please try and add this rule to your mwan3 config. Place it on top of all other rules:</p><div class="codebox"><pre><code>config rule &#039;ipsec&#039;
    option dest_ip &#039;{remote subnet}&#039;
    option use_policy &#039;default&#039;</code></pre></div><p>On a sdie note: I see that you use custom route table 220. This can be a problem as mwan3 might wipe this table when it&#039;s stopped. If you use a number higher then 255 you should be fine...</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 1 Jul 2014, 12:10)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238709">
				<div class="post-metadata">
					<div class="post-num">Post #813</div>
					<div class="post-author">Vahe91</div>
					<div class="post-datetime">
						1 Jul 2014, 14:10					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>arfett wrote:</cite><blockquote><div class="quotebox"><cite>Vahe91 wrote:</cite><blockquote><p>How to make that a specific site was opened only through one interface ?<br />Please help.</p></blockquote></div><p>You have two options:<br />1. Follow the guide in the wiki - <a href="http://wiki.openwrt.org/doc/howto/mwan3">http://wiki.openwrt.org/doc/howto/mwan3</a><br />Use the IP address(es) of the website as the destination in MWAN3 rules.</p><p>2. Create static routes in OpenWrt directing the IP address(es) of the website out the desired interface.</p></blockquote></div><p>does not work, please give an example</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238711">
				<div class="post-metadata">
					<div class="post-num">Post #814</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						1 Jul 2014, 14:12					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Vahe91 wrote:</cite><blockquote><p>does not work, please give an example</p></blockquote></div><p>Let&#039;s turn it around. Please show your config and explain in detail what you want to achieve and what does not work.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238712">
				<div class="post-metadata">
					<div class="post-num">Post #815</div>
					<div class="post-author">Vahe91</div>
					<div class="post-datetime">
						1 Jul 2014, 14:21					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><div class="quotebox"><cite>Vahe91 wrote:</cite><blockquote><p>does not work, please give an example</p></blockquote></div><p>Let&#039;s turn it around. Please show your config and explain in detail what you want to achieve and what does not work.</p></blockquote></div><p>want to make a particular site was opened only via wan2<br />and do so<br /><a href="http://4put.ru/view-max-picture.php?id=2899377"><span class="postimg"><img src="http://4put.ru/pictures/small/943/2899377.jpg" alt="http://4put.ru/pictures/small/943/2899377.jpg" /></span></a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238718">
				<div class="post-metadata">
					<div class="post-num">Post #816</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						1 Jul 2014, 14:49					</div>
				</div>
				<div class="post-content content">
					<p>Hi Vahe91,</p><br /><p>You&#039;re on the right track! That is indeed how you create a rule!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238719">
				<div class="post-metadata">
					<div class="post-num">Post #817</div>
					<div class="post-author">Vahe91</div>
					<div class="post-datetime">
						1 Jul 2014, 14:53					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hi Vahe91,</p><br /><p>You&#039;re on the right track! That is indeed how you create a rule!</p></blockquote></div><p>but this rule not working</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238720">
				<div class="post-metadata">
					<div class="post-num">Post #818</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						1 Jul 2014, 15:05					</div>
				</div>
				<div class="post-content content">
					<p>Is the order of rules right?</p><p>You have to give me more info then &quot;it is not working&quot;, before i can help you. I&#039;m not here to take you by the hand and solve your problems. So please post your complete config or ask questions as detailed as possible.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238723">
				<div class="post-metadata">
					<div class="post-num">Post #819</div>
					<div class="post-author">Vahe91</div>
					<div class="post-datetime">
						1 Jul 2014, 15:22					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Is the order of rules right?</p><p>You have to give me more info then &quot;it is not working&quot;, before i can help you. I&#039;m not here to take you by the hand and solve your problems. So please post your complete config or ask questions as detailed as possible.</p></blockquote></div><p>unfortunately I do not know English so well in order to explain in detail<br />for example, I want to open the site <a href="http://www.2ip.ru">www.2ip.ru</a> only through wan2<br />here is my configuration<br />-------------------<br />config interface &#039;wan&#039;<br />&nbsp; &nbsp; option enabled &#039;1&#039;<br />&nbsp; &nbsp; list track_ip &#039;8.8.4.4&#039;<br />&nbsp; &nbsp; list track_ip &#039;8.8.8.8&#039;<br />&nbsp; &nbsp; list track_ip &#039;208.67.222.222&#039;<br />&nbsp; &nbsp; list track_ip &#039;208.67.220.220&#039;<br />&nbsp; &nbsp; option reliability &#039;2&#039;<br />&nbsp; &nbsp; option count &#039;1&#039;<br />&nbsp; &nbsp; option timeout &#039;2&#039;<br />&nbsp; &nbsp; option interval &#039;5&#039;<br />&nbsp; &nbsp; option down &#039;3&#039;<br />&nbsp; &nbsp; option up &#039;8&#039;</p><p>config interface &#039;wan2&#039;<br />&nbsp; &nbsp; list track_ip &#039;8.8.8.8&#039;<br />&nbsp; &nbsp; list track_ip &#039;208.67.220.220&#039;<br />&nbsp; &nbsp; option reliability &#039;1&#039;<br />&nbsp; &nbsp; option count &#039;1&#039;<br />&nbsp; &nbsp; option timeout &#039;2&#039;<br />&nbsp; &nbsp; option interval &#039;5&#039;<br />&nbsp; &nbsp; option down &#039;3&#039;<br />&nbsp; &nbsp; option up &#039;8&#039;<br />&nbsp; &nbsp; option enabled &#039;1&#039;</p><p>config member &#039;wan_m1_w3&#039;<br />&nbsp; &nbsp; option interface &#039;wan&#039;<br />&nbsp; &nbsp; option metric &#039;1&#039;<br />&nbsp; &nbsp; option weight &#039;3&#039;</p><p>config member &#039;wan_m2_w3&#039;<br />&nbsp; &nbsp; option interface &#039;wan&#039;<br />&nbsp; &nbsp; option metric &#039;2&#039;<br />&nbsp; &nbsp; option weight &#039;3&#039;</p><p>config member &#039;wan2_m1_w2&#039;<br />&nbsp; &nbsp; option interface &#039;wan2&#039;<br />&nbsp; &nbsp; option metric &#039;1&#039;<br />&nbsp; &nbsp; option weight &#039;2&#039;</p><p>config member &#039;wan2_m2_w2&#039;<br />&nbsp; &nbsp; option interface &#039;wan2&#039;<br />&nbsp; &nbsp; option metric &#039;2&#039;<br />&nbsp; &nbsp; option weight &#039;2&#039;</p><p>config policy &#039;wan_only&#039;<br />&nbsp; &nbsp; list use_member &#039;wan_m1_w3&#039;</p><p>config policy &#039;wan2_only&#039;<br />&nbsp; &nbsp; list use_member &#039;wan2_m1_w2&#039;</p><p>config policy &#039;balanced&#039;<br />&nbsp; &nbsp; list use_member &#039;wan_m1_w3&#039;<br />&nbsp; &nbsp; list use_member &#039;wan2_m1_w2&#039;<br />&nbsp; &nbsp; list use_member &#039;wan3_m1_w4&#039;<br />&nbsp; &nbsp; list use_member &#039;wan4_m1_w5&#039;</p><p>config policy &#039;wan_wan2&#039;<br />&nbsp; &nbsp; list use_member &#039;wan_m1_w3&#039;<br />&nbsp; &nbsp; list use_member &#039;wan2_m2_w2&#039;</p><p>config policy &#039;wan2_wan&#039;<br />&nbsp; &nbsp; list use_member &#039;wan_m2_w3&#039;<br />&nbsp; &nbsp; list use_member &#039;wan2_m1_w2&#039;</p><p>config rule &#039;sticky_even&#039;<br />&nbsp; &nbsp; option src_ip &#039;0.0.0.0/0.0.0.1&#039;<br />&nbsp; &nbsp; option dest_port &#039;443&#039;<br />&nbsp; &nbsp; option proto &#039;tcp&#039;<br />&nbsp; &nbsp; option use_policy &#039;wan_wan2&#039;</p><p>config rule &#039;sticky_odd&#039;<br />&nbsp; &nbsp; option src_ip &#039;0.0.0.1/0.0.0.1&#039;<br />&nbsp; &nbsp; option dest_port &#039;443&#039;<br />&nbsp; &nbsp; option proto &#039;tcp&#039;<br />&nbsp; &nbsp; option use_policy &#039;wan2_wan&#039;</p><p>config rule &#039;default_rule&#039;<br />&nbsp; &nbsp; option dest_ip &#039;0.0.0.0/0&#039;<br />&nbsp; &nbsp; option use_policy &#039;balanced&#039;</p><p>config interface &#039;wan3&#039;<br />&nbsp; &nbsp; option enabled &#039;1&#039;<br />&nbsp; &nbsp; list track_ip &#039;8.8.8.8&#039;<br />&nbsp; &nbsp; list track_ip &#039;8.8.4.4&#039;<br />&nbsp; &nbsp; option reliability &#039;1&#039;<br />&nbsp; &nbsp; option count &#039;1&#039;<br />&nbsp; &nbsp; option timeout &#039;2&#039;<br />&nbsp; &nbsp; option interval &#039;5&#039;<br />&nbsp; &nbsp; option down &#039;3&#039;<br />&nbsp; &nbsp; option up &#039;3&#039;</p><p>config interface &#039;wan4&#039;<br />&nbsp; &nbsp; option enabled &#039;1&#039;<br />&nbsp; &nbsp; list track_ip &#039;8.8.8.8&#039;<br />&nbsp; &nbsp; list track_ip &#039;8.8.4.4&#039;<br />&nbsp; &nbsp; option reliability &#039;1&#039;<br />&nbsp; &nbsp; option count &#039;1&#039;<br />&nbsp; &nbsp; option timeout &#039;2&#039;<br />&nbsp; &nbsp; option interval &#039;5&#039;<br />&nbsp; &nbsp; option down &#039;3&#039;<br />&nbsp; &nbsp; option up &#039;3&#039;</p><p>config member &#039;wan3_m1_w4&#039;<br />&nbsp; &nbsp; option interface &#039;wan3&#039;<br />&nbsp; &nbsp; option metric &#039;1&#039;<br />&nbsp; &nbsp; option weight &#039;4&#039;</p><p>config member &#039;wan4_m1_w5&#039;<br />&nbsp; &nbsp; option interface &#039;wan4&#039;<br />&nbsp; &nbsp; option metric &#039;1&#039;<br />&nbsp; &nbsp; option weight &#039;5&#039;</p><p>config policy &#039;wan3_only&#039;<br />&nbsp; &nbsp; list use_member &#039;wan3_m1_w4&#039;</p><p>config policy &#039;wan4_only&#039;<br />&nbsp; &nbsp; list use_member &#039;wan4_m1_w5&#039;</p><p>config rule &#039;rule_1&#039;<br />&nbsp; &nbsp; option dest_ip &#039;188.40.74.0/26&#039;<br />&nbsp; &nbsp; option proto &#039;all&#039;<br />&nbsp; &nbsp; option use_policy &#039;wan2_only&#039;<br />--------------------------</p><p>what else to do, because with such a configuration 2ip.ru opens as always, and not only through wan2 ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238724">
				<div class="post-metadata">
					<div class="post-num">Post #820</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						1 Jul 2014, 15:26					</div>
				</div>
				<div class="post-content content">
					<p>Please add the following rule on top of all other rules:</p><div class="codebox"><pre><code>config rule &#039;www.2lp.ru&#039;
    option dest_ip &#039;62.109.26.77&#039;
    option use_policy &#039;wan2_only&#039;</code></pre></div><p>Remember that order of rules important. In your posted config the last rule will never be hit.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238726">
				<div class="post-metadata">
					<div class="post-num">Post #821</div>
					<div class="post-author">Vahe91</div>
					<div class="post-datetime">
						1 Jul 2014, 15:32					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Please add the following rule on top of all other rules:</p><div class="codebox"><pre><code>config rule &#039;www.2lp.ru&#039;
    option dest_ip &#039;62.109.26.77&#039;
    option use_policy &#039;wan2_only&#039;</code></pre></div><p>Remember that order of rules important. In your posted config the last rule will never be hit.</p></blockquote></div><p>in my example 2ip.ru, not 2lp.ru<br />Thanks, everything turned out just needed to move the rule to the first line</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238730">
				<div class="post-metadata">
					<div class="post-num">Post #822</div>
					<div class="post-author">kpv</div>
					<div class="post-datetime">
						1 Jul 2014, 17:13					</div>
				</div>
				<div class="post-content content">
					<p>Should I be concerned by the following timeout error &quot;Timeout waiting for older hotplug processes to finish. ifup interface wan (eth0.2) aborted&quot; ?</p><p>It occured while stress-testing my xDSL line (link saturation causing ping timeout and mwan3 marking both WANs as being down).</p><div class="codebox"><pre><code>Mon Jun 30 01:03:34 2014 user.info mwan3track: Lost 1 ping(s) on interface wan2 (eth0.3)
Mon Jun 30 01:03:38 2014 user.info mwan3track: Lost 2 ping(s) on interface wan (eth0.2)
Mon Jun 30 01:03:54 2014 user.notice mwan3track: Interface wan2 (eth0.3) is online
Mon Jun 30 01:03:56 2014 user.notice mwan3: ifup interface wan2 (eth0.3)
Mon Jun 30 01:03:57 2014 user.notice mwan3: ifup interface wan2 (eth0.3)
Mon Jun 30 01:04:14 2014 user.notice mwan3track: Interface wan (eth0.2) is online
Mon Jun 30 01:04:15 2014 user.notice mwan3: ifup interface wan (eth0.2)
Mon Jun 30 01:05:17 2014 user.warn mwan3: Timeout waiting for older hotplug processes to finish. ifup interface wan (eth0.2) aborted
Mon Jun 30 01:25:14 2014 user.info mwan3track: Lost 2 ping(s) on interface wan (eth0.2)
root@OpenWrt:~#</code></pre></div><p>PS: OpenWRT could use a &quot;qosmon&quot; util, like the one offered by Gargoyle, that will tune up/down the line bandwidth based on latency, for those of us who don&#039;t enjoy a &quot;guaranteed&quot; line speed of our xDSL line</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238732">
				<div class="post-metadata">
					<div class="post-num">Post #823</div>
					<div class="post-author">kpv</div>
					<div class="post-datetime">
						1 Jul 2014, 17:27					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Vahe91 wrote:</cite><blockquote><p>for example, I want to open the site <a href="http://www.2ip.ru">www.2ip.ru</a> only through wan2</p></blockquote></div><p>I just wanted to add that while in your particular case it was rather easy (since <a href="http://www.2ip.ru">www.2ip.ru</a> resolves to only 2 IPs), there are other cases where policy-routing a Website via a certain WAN might be quite difficult, since some popular Websites can resolve to 10s or 100s of different IPs (or CDNs).</p>											<p class="post-edited">(Last edited by <strong>kpv</strong> on 1 Jul 2014, 17:28)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238751">
				<div class="post-metadata">
					<div class="post-num">Post #824</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						1 Jul 2014, 19:33					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>kpv wrote:</cite><blockquote><p>Should I be concerned by the following timeout error &quot;Timeout waiting for older hotplug processes to finish. ifup interface wan (eth0.2) aborted&quot; ?</p><p>It occured while stress-testing my xDSL line (link saturation causing ping timeout and mwan3 marking both WANs as being down).</p></blockquote></div><p>It&#039;s hard to tell afterwards why this happened. Only thing i can say is that there was another hotplug process running, that started before the aborted one, and took more than the time-out of 1 minute to finish (or did not finish at all). I&#039;m curius to what this might caused it..</p><p>Can you reproduce this on command? If so, could you list the processes running just before it times out. I know this would not be easy, but it could shed some light on the cause...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238760">
				<div class="post-metadata">
					<div class="post-num">Post #825</div>
					<div class="post-author">kpv</div>
					<div class="post-datetime">
						1 Jul 2014, 21:32					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><div class="quotebox"><cite>kpv wrote:</cite><blockquote><p>Should I be concerned by the following timeout error &quot;Timeout waiting for older hotplug processes to finish. ifup interface wan (eth0.2) aborted&quot; ?</p><p>It occured while stress-testing my xDSL line (link saturation causing ping timeout and mwan3 marking both WANs as being down).</p></blockquote></div><p>It&#039;s hard to tell afterwards why this happened. Only thing i can say is that there was another hotplug process running, that started before the aborted one, and took more than the time-out of 1 minute to finish (or did not finish at all). I&#039;m curius to what this might caused it..</p><p>Can you reproduce this on command? If so, could you list the processes running just before it times out. I know this would not be easy, but it could shed some light on the cause...</p></blockquote></div><p>I don&#039;t know if I can reproduce this error, but I&#039;ll be keeping an eye on the logs.</p><p>I assume that the other hotplug event would be related to the up/down of the other WAN link. Note: since both WANs in my test setup go out via the same Internet link, they both go down together and come back up again together.</p><p>PS: As I&#039;ve written you, I&#039;ve added -w to all invocations of iptables by mwan3, I&#039;m not sure if that might be related ...</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 33 of 65</div><nav><ul><li><a href="viewtopic.php%3Fid=39052&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=31.html">31</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=32.html">32</a></li><li class="pagination-current"><span>33</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=34.html">34</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=35.html">35</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>