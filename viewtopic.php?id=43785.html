<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> define the flash size of WR703N for building</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 1 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p199719">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">andreasb</div>
					<div class="post-datetime">
						26 Apr 2013, 13:01					</div>
				</div>
				<div class="post-content content">
					<p>Hi,<br />I did extend the flash of my WR703N from 4M to 16M. This works well and have no problems. But I want to make a new binary for flashing with a bigger size than 4MB. I can create only a binary with a max size of 4M. If I define more modules and SW with make menuconfig then the make will not create a binary.<br />I know that I can first create a smaller binary and install later the additional software. But I want to compile all modules what I want into the kernel.<br />In which file is defined the flash size of this router?</p><p>best regards<br />Andreas</p>											<p class="post-edited">(Last edited by <strong>andreasb</strong> on 5 May 2013, 11:03)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p200754">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">andreasb</div>
					<div class="post-datetime">
						5 May 2013, 08:09					</div>
				</div>
				<div class="post-content content">
					<p>Hi,<br />have nobody any idea how I can remove the flash limitation during the make?</p><p>best regards<br />Andreas</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p200756">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						5 May 2013, 09:04					</div>
				</div>
				<div class="post-content content">
					<p>You should have put a reference to the device in the title... That would help getting answers. Now your title is very generic :-(</p><br /><p>The device is strange to me, but I think that the flash size is set here:<br /><a href="https://dev.openwrt.org/browser/trunk/target/linux/ar71xx/image/Makefile#L933">https://dev.openwrt.org/browser/trunk/t … efile#L933</a></p><p>And based on wiki (<a href="http://wiki.openwrt.org/toh/tp-link/tl-wr703n#hardware.mods">http://wiki.openwrt.org/toh/tp-link/tl- … dware.mods</a>), you might also read <a href="https://forum.openwrt.org/viewtopic.php?id=28343">https://forum.openwrt.org/viewtopic.php?id=28343</a></p>											<p class="post-edited">(Last edited by <strong>hnyman</strong> on 5 May 2013, 09:08)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p200759">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">andreasb</div>
					<div class="post-datetime">
						5 May 2013, 09:49					</div>
				</div>
				<div class="post-content content">
					<p>Thank you very much!<br />In this file I did change the size to 16M already. But it doesn&#039;t work.<br />Now I try to set it to 8MB. This works fine. May be, the make of openwrt didn&#039;t work general with a flash size more than 8MB.<br />(I did not wrote the device in the title to become a general answer. I thought this increase the change of an answer. May be, the false way... :-(&nbsp; )</p><p>best regards<br />Andreas</p>											<p class="post-edited">(Last edited by <strong>andreasb</strong> on 5 May 2013, 09:49)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p200764">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						5 May 2013, 10:26					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>andreasb wrote:</cite><blockquote><p>(I did not wrote the device in the title to become a general answer. I thought this increase the change of an answer. May be, the false way... :-(&nbsp; )</p></blockquote></div><p>That kind of settings like flash size are so device specific that there is no generic answer. Thatswhy I suggested mentioning the device.</p><p>I would guess that those 8M and 4M setttings are defined somewhere in the ar71xx device definitions. Might be that a suitable setting has not yet been defined for 16M in your device type.</p><br /><p>Ps.&nbsp; I have 16 MB WNDR3700 (with the same ar71xx architecture) , so Openwrt itself supports that size quite well. You have just to find, where the definition for your devices gets parsed.</p>											<p class="post-edited">(Last edited by <strong>hnyman</strong> on 5 May 2013, 10:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p200765">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						5 May 2013, 10:41					</div>
				</div>
				<div class="post-content content">
					<p>I spent a few more minutes debugging this...</p><p>The ar71xx image makefile image calls Singleprofile --&gt; Image/Build/Template/TPLINK-LZMA, which then calls external &quot;mktplinkfw&quot; tool to build Tplink image:<br /><a href="https://dev.openwrt.org/browser/trunk/target/linux/ar71xx/image/Makefile#L36">https://dev.openwrt.org/browser/trunk/t … kefile#L36</a><br /><a href="https://dev.openwrt.org/browser/trunk/target/linux/ar71xx/image/Makefile#L586">https://dev.openwrt.org/browser/trunk/t … efile#L586</a></p><p>4Mlzma etc definitions are set here:<br /><a href="https://dev.openwrt.org/browser/trunk/tools/firmware-utils/src/mktplinkfw.c#L160">https://dev.openwrt.org/browser/trunk/t … kfw.c#L160</a></p><p>You need to correctly define there 16Mlzma and then use that both in the image makefile (<a href="https://dev.openwrt.org/browser/trunk/target/linux/ar71xx/image/Makefile#L933">https://dev.openwrt.org/browser/trunk/t … efile#L933</a>) and in the device definition here: <a href="https://dev.openwrt.org/browser/trunk/tools/firmware-utils/src/mktplinkfw.c#L336">https://dev.openwrt.org/browser/trunk/t … kfw.c#L336</a></p><p>EDIT: you might edit the title in the first message to contain TL-WR703N so that other looking for information can find this discussion more easily.</p>											<p class="post-edited">(Last edited by <strong>hnyman</strong> on 5 May 2013, 10:44)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p200772">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">andreasb</div>
					<div class="post-datetime">
						5 May 2013, 12:12					</div>
				</div>
				<div class="post-content content">
					<p>Hi,<br />I did change the line 339 to 16M in mktplink.c now.<br />But if I change the size in the make file again to 16M then make don&#039;t create a binary more.<br />(openwrt-ar71xx-generic-tl-wr703n-v1-squashfs-factory.bin has 8.1M if it created)</p><p>best regards<br />Andreas</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p200773">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						5 May 2013, 12:25					</div>
				</div>
				<div class="post-content content">
					<p>What are all the changes you have done? You could copy the code (svn diff output of those files) here inside [ code ] tags.</p><p>I guess that you need at least to:<br /> - define a new section (in lines 160-190) for 16lzma<br /> - define that as the format for 703 in line 339<br /> - change also the image makefile to use that definition (line 933 of makefile)</p><p>You might also need to &quot;make dirclean&quot; to ensure that the new mktplinkfw gets surely built. I guess it should be built automatically if you change source, but I am not sure. (you might also &quot;make tools/firmware-utils/clean&quot; , as it is part of that tools package.)</p>											<p class="post-edited">(Last edited by <strong>hnyman</strong> on 5 May 2013, 12:30)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p200777">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">andreasb</div>
					<div class="post-datetime">
						5 May 2013, 12:48					</div>
				</div>
				<div class="post-content content">
					<p>Hi,<br />just I saw the same. The flash layout 16Mlzma didn&#039;t exist.<br />I create it now like follow:<br />&nbsp; &nbsp; &nbsp; &nbsp; .id&nbsp; &nbsp; &nbsp; &nbsp; = &quot;16Mlzma&quot;,<br />&nbsp; &nbsp; &nbsp; &nbsp; .fw_max_len = 0xfc0000,<br />&nbsp; &nbsp; &nbsp; &nbsp; .kernel_la&nbsp; &nbsp; = 0x80060000,<br />&nbsp; &nbsp; &nbsp; &nbsp; .kernel_ep&nbsp; &nbsp; = 0x80060000,<br />&nbsp; &nbsp; &nbsp; &nbsp; .rootfs_ofs&nbsp; &nbsp; = 0x100000,<br />Thank you very much! It works well now!</p><p>best regards<br />Andreas</p>											<p class="post-edited">(Last edited by <strong>andreasb</strong> on 5 May 2013, 12:49)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p200780">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						5 May 2013, 12:58					</div>
				</div>
				<div class="post-content content">
					<p>You might add the correct advice to the wiki article for your device:</p><p><a href="http://wiki.openwrt.org/toh/tp-link/tl-wr703n#hardware.mods">http://wiki.openwrt.org/toh/tp-link/tl- … dware.mods</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p200786">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">andreasb</div>
					<div class="post-datetime">
						5 May 2013, 13:34					</div>
				</div>
				<div class="post-content content">
					<p>Hi,<br />ok, but I will describe here exact what I did for a better understanding.</p><p>For comparisation this way you have to mind that this change is valid for the openwrt trunk of this day. May be, for later versions have another line in the file.</p><p>1. Change the make file: <a href="https://dev.openwrt.org/browser/trunk/target/linux/ar71xx/image/Makefile#L933">https://dev.openwrt.org/browser/trunk/t … efile#L933</a><br />- $(eval $(call SingleProfile,TPLINK-LZMA,$(fs_64kraw),TLWR703,tl-wr703n-v1,TL-WR703N,ttyATH0,115200,0x07030101,1,4Mlzma))<br />+ $(eval $(call SingleProfile,TPLINK-LZMA,$(fs_64kraw),TLWR703,tl-wr703n-v1,TL-WR703N,ttyATH0,115200,0x07030101,1,16Mlzma))</p><p>2. Change the file: <a href="https://dev.openwrt.org/browser/trunk/tools/firmware-utils/src/mktplinkfw.c#L158">https://dev.openwrt.org/browser/trunk/t … kfw.c#L158</a><br />add a element in the struct &quot;static struct flash_layout layouts[]&quot; for 16MB like follow:</p><p>&nbsp; &nbsp; &nbsp; &nbsp; .id&nbsp; &nbsp; &nbsp; &nbsp; = &quot;16Mlzma&quot;,<br />&nbsp; &nbsp; &nbsp; &nbsp; .fw_max_len = 0xfc0000,<br />&nbsp; &nbsp; &nbsp; &nbsp; .kernel_la&nbsp; &nbsp; = 0x80060000,<br />&nbsp; &nbsp; &nbsp; &nbsp; .kernel_ep&nbsp; &nbsp; = 0x80060000,<br />&nbsp; &nbsp; &nbsp; &nbsp; .rootfs_ofs&nbsp; &nbsp; = 0x100000,</p><p>Change the entry for the WR703N of the struct &quot;static struct board_info boards[]&quot; in the same file( the entry is now in line line 345)<br />&nbsp; &nbsp; &nbsp; &nbsp; .id&nbsp; &nbsp; &nbsp; &nbsp; = &quot;TL-WR703Nv1&quot;,<br />&nbsp; &nbsp; &nbsp; &nbsp; .hw_id&nbsp; &nbsp; &nbsp; &nbsp; = HWID_TL_WR703N_V1,<br />&nbsp; &nbsp; &nbsp; &nbsp; .hw_rev&nbsp; &nbsp; &nbsp; &nbsp; = 1,<br />&nbsp; &nbsp; &nbsp; &nbsp; .layout_id&nbsp; &nbsp; = &quot;4Mlzma&quot;,<br /> to<br />&nbsp; &nbsp; &nbsp; &nbsp; .id&nbsp; &nbsp; &nbsp; &nbsp; = &quot;TL-WR703Nv1&quot;,<br />&nbsp; &nbsp; &nbsp; &nbsp; .hw_id&nbsp; &nbsp; &nbsp; &nbsp; = HWID_TL_WR703N_V1,<br />&nbsp; &nbsp; &nbsp; &nbsp; .hw_rev&nbsp; &nbsp; &nbsp; &nbsp; = 1,<br />&nbsp; &nbsp; &nbsp; &nbsp; .layout_id&nbsp; &nbsp; = &quot;16Mlzma&quot;,</p><p>that&#039;s all!<br />Andreas</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238165">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">zxdavb</div>
					<div class="post-datetime">
						26 Jun 2014, 23:29					</div>
				</div>
				<div class="post-content content">
					<p>To make these changes via a script (works on BB, b41353):</p><div class="codebox"><pre><code>sed -i &#039;/TLWR703/              s/4Mlzma/16Mlzma/&#039;   target/linux/ar71xx/image/Makefile
sed -i &#039;/TL-WR703Nv1/,/layout/{s/4Mlzma/16Mlzma/;}&#039; tools/firmware-utils/src/mktplinkfw.c</code></pre></div><p>FWIW, I did not change <strong>fw_max_len</strong>, but the thing still built!</p>											<p class="post-edited">(Last edited by <strong>zxdavb</strong> on 26 Jun 2014, 23:30)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p284743">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">zxdavb</div>
					<div class="post-datetime">
						24 Jul 2015, 00:54					</div>
				</div>
				<div class="post-content content">
					<p>In CC b46441, I use: <br /></p><div class="codebox"><pre><code>sed -i &#039;/tl-wr703n-v1/,/endif/{;s/4mlzma/16mlzma/;}&#039; ./target/linux/ar71xx/image/Makefile
sed -i &#039;/TL-WR703Nv1/,/layout/{;s/4Mlzma/16Mlzma/;}&#039; ./tools/firmware-utils/src/mktplinkfw.c</code></pre></div>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>