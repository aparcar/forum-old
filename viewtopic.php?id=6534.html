<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> ez-ipupdate beefup</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 2 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p30715">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">onitake</div>
					<div class="post-datetime">
						18 Jul 2006, 18:44					</div>
				</div>
				<div class="post-content content">
					<p>hi, i prepared two patches for ez-ipupdate.</p><p>the first one adds support for the free japanese dyndns service ieserver.net, the second fixes two null string pointer bugs.<br />i&#039;m not sure if those are intended to be there, but i guess it&#039;s much better to have than not. the problems arose because i didn&#039;t have an &quot;interface&quot; entry in my config file and fixed that by surrounding two locations where that setting is used with &quot;if(interface != NULL)&quot;.</p><p>ieserver.net is a bit special because it doesn&#039;t use login, password and domain, but login (which is the same as the subdomain), password and domain (which is the domain suffix). i decided it would be good to distinguish that and made the new configuration entry &quot;domain&quot;. &quot;user&quot; works the same way as usual.</p><p>here&#039;s a sample ez-ipupdate.conf:<br />service-type=ieserver<br />user=kimi:Naisho<br />domain=moe.hm<br />interface=ppp0<br />cache-file=/tmp/ez-ipupdate.cache<br />pid-file=/var/run/ez-ipupdate.pid</p><p>there&#039;s additional work neccessary, because the two patches don&#039;t fit in completely yet. 200-ieserver.patch is against the raw source and 300-interface.patch against the 100- and 200-patched tree. but they should work nonetheless (i get patch successes with a few lines offset).</p><p>and here are the patches:</p><p>200-ieserver.patch:<br />----------------------------------------------------<br />--- ez-ipupdate-3.0.11b8.orig/ez-ipupdate.c<br />+++ ez-ipupdate-3.0.11b8/ez-ipupdate.c<br />@@ -103,6 +103,10 @@<br /> #define HEIPV6TB_DEFAULT_PORT &quot;80&quot;<br /> #define HEIPV6TB_REQUEST &quot;/index.cgi&quot;</p><p>+#define IESERVER_DEFAULT_SERVER &quot;ieserver.net&quot;<br />+#define IESERVER_DEFAULT_PORT &quot;80&quot;<br />+#define IESERVER_REQUEST &quot;/cgi-bin/dip.cgi&quot;<br />+<br /> #define DEFAULT_TIMEOUT 120<br /> #define DEFAULT_UPDATE_PERIOD 120<br /> #define DEFAULT_RESOLV_PERIOD 30<br />@@ -271,6 +275,7 @@<br /> char *notify_email = NULL;<br /> char *pid_file = NULL;<br /> char *partner = NULL;<br />+char *domain = NULL;</p><p> static volatile int client_sockfd;<br /> static volatile int last_sig = 0;<br />@@ -341,6 +346,10 @@<br /> int HEIPV6TB_check_info(void);<br /> static char *HEIPV6TB_fields_used[] = { &quot;server&quot;, &quot;user&quot;, NULL };</p><p>+int IESERVER_update_entry(void);<br />+int IESERVER_check_info(void);<br />+static char *IESERVER_fields_used[] = { &quot;server&quot;, &quot;user&quot;, &quot;domain&quot;, NULL };<br />+<br /> struct service_t services[] = {<br />&nbsp; &nbsp;{ &quot;NULL&quot;,<br />&nbsp; &nbsp; &nbsp;{ &quot;null&quot;, &quot;NULL&quot;, 0, },<br />@@ -514,6 +523,16 @@<br />&nbsp; &nbsp; &nbsp;HEIPV6TB_DEFAULT_PORT,<br />&nbsp; &nbsp; &nbsp;HEIPV6TB_REQUEST<br />&nbsp; &nbsp;},<br />+&nbsp; { &quot;ieserver&quot;,<br />+&nbsp; &nbsp; { &quot;ieserver&quot;, 0, 0, },<br />+&nbsp; &nbsp; NULL,<br />+&nbsp; &nbsp; IESERVER_update_entry,<br />+&nbsp; &nbsp; IESERVER_check_info,<br />+&nbsp; &nbsp; IESERVER_fields_used,<br />+&nbsp; &nbsp; IESERVER_DEFAULT_SERVER,<br />+&nbsp; &nbsp; IESERVER_DEFAULT_PORT,<br />+&nbsp; &nbsp; IESERVER_REQUEST<br />+&nbsp; },<br /> };</p><p> static struct service_t *service = NULL;<br />@@ -557,6 +576,7 @@<br />&nbsp; &nbsp;CMD_pid_file,<br />&nbsp; &nbsp;CMD_offline,<br />&nbsp; &nbsp;CMD_partner,<br />+&nbsp; CMD_domain,<br />&nbsp; &nbsp;CMD__end<br /> };</p><p>@@ -591,6 +611,7 @@<br />&nbsp; &nbsp;{ CMD_connection_type, &quot;connection-type&quot;, CONF_NEED_ARG, 1, conf_handler, &quot;%s=&lt;connection type&gt;&quot; },<br />&nbsp; &nbsp;{ CMD_request,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&quot;request&quot;,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CONF_NEED_ARG, 1, conf_handler, &quot;%s=&lt;request uri&gt;&quot; },<br />&nbsp; &nbsp;{ CMD_partner,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&quot;partner&quot;,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CONF_NEED_ARG, 1, conf_handler, &quot;%s=&lt;easydns partner&gt;&quot; },<br />+&nbsp; { CMD_domain,&nbsp; &nbsp; &quot;domain&quot;,&nbsp; &nbsp; CONF_NEED_ARG, 1, conf_handler, &quot;%s=&lt;domain&gt;&quot; },<br />&nbsp; &nbsp;{ 0, 0, 0, 0, 0 }<br /> };</p><p>@@ -1142,6 +1163,12 @@<br />&nbsp; &nbsp; &nbsp; &nbsp;dprintf((stderr, &quot;cache_file: %s\n&quot;, cache_file));<br />&nbsp; &nbsp; &nbsp; &nbsp;break;</p><p>+&nbsp; &nbsp; case CMD_domain:<br />+&nbsp; &nbsp; &nbsp; if(domain) { free(domain); }<br />+&nbsp; &nbsp; &nbsp; domain = strdup(optarg);<br />+&nbsp; &nbsp; &nbsp; dprintf((stderr, &quot;domain: %s\n&quot;, domain));<br />+&nbsp; &nbsp; &nbsp; break;<br />+<br />&nbsp; &nbsp; &nbsp;default:<br />&nbsp; &nbsp; &nbsp; &nbsp;dprintf((stderr, &quot;case not handled: %d\n&quot;, id));<br />&nbsp; &nbsp; &nbsp; &nbsp;break;<br />@@ -4246,6 +4273,111 @@<br />&nbsp; &nbsp; return(UPDATERES_OK);<br /> }</p><p>+int IESERVER_check_info(void)<br />+{<br />+&nbsp; if(domain == NULL)<br />+&nbsp; {<br />+&nbsp; &nbsp;fprintf(stderr, &quot;you have to specify the ieserver domain\n&quot;);<br />+&nbsp; &nbsp;return(-1);<br />+&nbsp; }<br />+&nbsp; warn_fields(service-&gt;fields_used);<br />+<br />+&nbsp; return 0;<br />+}<br />+<br />+int IESERVER_update_entry(void)<br />+{<br />+&nbsp; char buf[BUFFER_SIZE+1];<br />+&nbsp; char *bp = buf;<br />+&nbsp; int bytes;<br />+&nbsp; int btot;<br />+&nbsp; int ret;<br />+<br />+&nbsp; buf[BUFFER_SIZE] = &#039;\0&#039;;<br />+<br />+&nbsp; if(do_connect((int*)&amp;client_sockfd, server, port) != 0)<br />+&nbsp; {<br />+&nbsp; &nbsp;if(!(options &amp; OPT_QUIET))<br />+&nbsp; &nbsp;{<br />+&nbsp; &nbsp; show_message(&quot;error connecting to %s:%s\n&quot;, server, port);<br />+&nbsp; &nbsp;}<br />+&nbsp; &nbsp; return(UPDATERES_ERROR);<br />+&nbsp; }<br />+<br />+&nbsp; snprintf(buf, BUFFER_SIZE, &quot;GET %s?updatehost=1&amp;&quot;, request);<br />+&nbsp; output(buf);<br />+&nbsp; snprintf(buf, BUFFER_SIZE, &quot;%s=%s&amp;&quot;, &quot;username&quot;, user_name);<br />+&nbsp; output(buf);<br />+&nbsp; snprintf(buf, BUFFER_SIZE, &quot;%s=%s&amp;&quot;, &quot;password&quot;, password);<br />+&nbsp; output(buf);<br />+&nbsp; snprintf(buf, BUFFER_SIZE, &quot;%s=%s&amp;&quot;, &quot;domain&quot;, domain);<br />+&nbsp; output(buf);<br />+&nbsp; snprintf(buf, BUFFER_SIZE, &quot; HTTP/1.0\015\012&quot;);<br />+&nbsp; output(buf);<br />+&nbsp; snprintf(buf, BUFFER_SIZE, &quot;User-Agent: %s-%s %s [%s] (%s)\015\012&quot;, <br />+&nbsp; &nbsp; &nbsp; &quot;ez-update&quot;, VERSION, OS, (options &amp; OPT_DAEMON) ? &quot;daemon&quot; : &quot;&quot;, &quot;by Angus Mackay&quot;);<br />+&nbsp; output(buf);<br />+&nbsp; snprintf(buf, BUFFER_SIZE, &quot;Host: %s\015\012&quot;, server);<br />+&nbsp; output(buf);<br />+&nbsp; snprintf(buf, BUFFER_SIZE, &quot;\015\012&quot;);<br />+&nbsp; output(buf);<br />+<br />+&nbsp; bp = buf;<br />+&nbsp; bytes = 0;<br />+&nbsp; btot = 0;<br />+&nbsp; while((bytes=read_input(bp, BUFFER_SIZE-btot)) &gt; 0)<br />+&nbsp; {<br />+&nbsp; &nbsp; bp += bytes;<br />+&nbsp; &nbsp; btot += bytes;<br />+&nbsp; &nbsp; dprintf((stderr, &quot;btot: %d\n&quot;, btot));<br />+&nbsp; }<br />+&nbsp; close(client_sockfd);<br />+&nbsp; buf[btot] = &#039;\0&#039;;<br />+<br />+&nbsp; dprintf((stderr, &quot;server output: %s\n&quot;, buf));<br />+<br />+&nbsp; if(sscanf(buf, &quot; HTTP/1.%*c %3d&quot;, &amp;ret) != 1)<br />+&nbsp; {<br />+&nbsp; &nbsp; ret = -1;<br />+&nbsp; }<br />+<br />+&nbsp; switch(ret)<br />+&nbsp; {<br />+&nbsp; &nbsp; case -1:<br />+&nbsp; &nbsp; &nbsp; if(!(options &amp; OPT_QUIET))<br />+&nbsp; &nbsp; &nbsp; {<br />+&nbsp; &nbsp; &nbsp; &nbsp; show_message(&quot;strange server response, are you connecting to the right server?\n&quot;);<br />+&nbsp; &nbsp; &nbsp; }<br />+&nbsp; &nbsp; &nbsp; return(UPDATERES_ERROR);<br />+&nbsp; &nbsp; &nbsp; break;<br />+<br />+&nbsp; &nbsp; case 200:<br />+&nbsp; &nbsp; &nbsp; if(!(options &amp; OPT_QUIET))<br />+&nbsp; &nbsp; &nbsp; {<br />+&nbsp; &nbsp; &nbsp; &nbsp; printf(&quot;request successful\n&quot;);<br />+&nbsp; &nbsp; &nbsp; }<br />+&nbsp; &nbsp; &nbsp; break;<br />+<br />+&nbsp; &nbsp; case 401:<br />+&nbsp; &nbsp; &nbsp; if(!(options &amp; OPT_QUIET))<br />+&nbsp; &nbsp; &nbsp; {<br />+&nbsp; &nbsp; &nbsp; &nbsp; show_message(&quot;authentication failure\n&quot;);<br />+&nbsp; &nbsp; &nbsp; }<br />+&nbsp; &nbsp; &nbsp; return(UPDATERES_SHUTDOWN);<br />+&nbsp; &nbsp; &nbsp; break;<br />+<br />+&nbsp; &nbsp; default:<br />+&nbsp; &nbsp; &nbsp; if(!(options &amp; OPT_QUIET))<br />+&nbsp; &nbsp; &nbsp; {<br />+&nbsp; &nbsp; &nbsp; &nbsp; show_message(&quot;unknown return code: %d\n&quot;, ret);<br />+&nbsp; &nbsp; &nbsp; }<br />+&nbsp; &nbsp; &nbsp; return(UPDATERES_ERROR);<br />+&nbsp; &nbsp; &nbsp; break;<br />+&nbsp; }<br />+<br />+&nbsp; return(UPDATERES_OK);<br />+}<br />+<br /> static int is_in_list(char *needle, char **haystack)<br /> {<br />&nbsp; &nbsp;char **p;</p><br /><p>300-interface.patch:<br />----------------------------------------------------<br />--- ez-ipupdate-3.0.11b8.orig/ez-ipupdate.c<br />+++ ez-ipupdate-3.0.11b8/ez-ipupdate.c<br />@@ -4883,16 +4883,19 @@<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if(address == NULL || *address == &#039;\0&#039;)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br /> #ifdef IF_LOOKUP<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; struct sockaddr_in sin;<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int sock;<br />-<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sock = socket(AF_INET, SOCK_STREAM, 0);<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(get_if_addr(sock, interface, &amp;sin) != 0)<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(interface)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit(1);<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; close(sock);<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(ipbuf, sizeof(ipbuf), &quot;%s&quot;, inet_ntoa(sin.sin_addr));<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; struct sockaddr_in sin;<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int sock;<br />+<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sock = socket(AF_INET, SOCK_STREAM, 0);<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(get_if_addr(sock, interface, &amp;sin) != 0)<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit(1);<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; close(sock);<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(ipbuf, sizeof(ipbuf), &quot;%s&quot;, inet_ntoa(sin.sin_addr));<br />+&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;}<br /> #else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fprintf(stderr, &quot;interface lookup not enabled at compile time\n&quot;);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;exit(1);<br />@@ -4984,16 +4987,19 @@<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if(address == NULL || *address == &#039;\0&#039;)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br /> #ifdef IF_LOOKUP<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; struct sockaddr_in sin;<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int sock;<br />-<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sock = socket(AF_INET, SOCK_STREAM, 0);<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(get_if_addr(sock, interface, &amp;sin) != 0)<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (interface)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit(1);<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; struct sockaddr_in sin;<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int sock;<br />+<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sock = socket(AF_INET, SOCK_STREAM, 0);<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(get_if_addr(sock, interface, &amp;sin) != 0)<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit(1);<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; close(sock);<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(ipbuf, sizeof(ipbuf), &quot;%s&quot;, inet_ntoa(sin.sin_addr));<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; close(sock);<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(ipbuf, sizeof(ipbuf), &quot;%s&quot;, inet_ntoa(sin.sin_addr));<br /> #else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fprintf(stderr, &quot;interface lookup not enabled at compile time\n&quot;);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;exit(1);</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>