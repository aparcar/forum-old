<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Announcing AAP (aka AutoAP) for OpenWrt Kamikaze 8.09+</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 3 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p93671">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">orange</div>
					<div class="post-datetime">
						3 Sep 2009, 16:12					</div>
				</div>
				<div class="post-content content">
					<p><strong>UPDATE 100814 - For most recent Piranha + AAP development, please follow</strong> <a href="https://forum.openwrt.org/viewtopic.php?id=26116">https://forum.openwrt.org/viewtopic.php?id=26116</a></p><p>Community,</p><p>I&#039;m glad to announce the immediate availability of AAP for OpenWrt Kamikaze 8.09+. AAP is ready-to-run on devices with Atheros wireless chipsets (while easily adoptable to other chipsets) and has been written for the Fonera 2100/2200. Instead of explaining AAP in detail again here, I paste the rather comprehensive README that ships with the initial release of AAP. AAP is available as of today at <a href="http://piranha.klashed.net/pub/aap">http://piranha.klashed.net/pub/aap</a></p><div class="codebox"><pre><code>#
# Copyright (C) 2009 orange &lt;or4n9e@gmx.de&gt;
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#

### Definition ###
AAP is a script that enables users of OpenWrt Kamikaze 8.09+ to automatically log into different 
wireless accesspoints that provide internet access. The accesspoints can be automatically
searched and/or set in a whitelist (aap_wlst). Beyond that AAP is capable in defining a blacklist
of undesired accesspoints while connecting (aap_blst). AAP supports the client connection of
your OpenWrt Kamikaze 8.09+ device to open, wep, wpa-psk and wpa2-psk encrypted accesspoints. 
AAP connects to surrounding accesspoints utilizing their MAC addresses. This ensures a high level of
differentiation between accesspoints in contrast to SSID-based connecting.

### Requirements ###
AAP requires an OpenWrt Kamikaze 8.09+ device properly configured in Client Mode (sta). AAP supports
devices with an Atheros wireless chipset (while easily adoptable to other chipsets) and has been written
for the Fonera 2100/2200. It assumes a single madwifi-VAP ath0 in sta mode.

### Whitelist/Blacklist ###
aap_wlst is a newline-separated whitelist of preferred accesspoints:
00:11:22:33:44:55* for accesspoints with no encryption
00:11:22:33:44:55*key for accesspoints with wep, wpa-psk or wpa2-psk encryption

aap_blst is a newline-separated blacklist of undesired accesspoints:
00:11:22:33:44:55 for open, wep, wpa-psk and wpa2-psk encrypted accesspoints

### Configuration Variables ###
aap.sh provides configuration variables (with default values) at the top of the script:
# Internet connection check frequency in seconds
aap_checkfreq=60

# Length of time in seconds to wait for a DHCP request to succeed
aap_dhcptimeout=30

# Internet URL or IP address used to ping to ensure internet access is working
aap_ineturl=www.google.com

# Defines the search mode. Try to find all accesspoints that provide internet access. &quot;0&quot;=NO, &quot;1&quot;=YES
aap_prefonly=0

# Defines the accesspoint refresh scan delay in seconds (divisible by 5)
aap_rescandelay=43200

### Installation ###
1. Log into your device via SSH
2. # mkdir /aap
3. scp aap.sh, aap_blst, aap_wlst and scan.awk to /aap
4. scp aap to /etc/init.d
5. # chmod 755 /aap/aap.sh, /aap/scan.awk and /etc/init.d/aap

### Usage ###
To enable autostart of AAP
# /etc/init.d/aap enable
To disable autostart of AAP
# /etc/init.d/aap disable
To start AAP manually
# /etc/init.d/aap start
To stop AAP manually
# /etc/init.d/aap stop

### Known Issues ###
Both aap_wlst and aap_blst need to be non-empty files due to the behaviour of the busybox builtin grep. 
Thus, please leave aap_wlst and aap_blst as provided and just append your custom newline-separated entries 
if actually in use.

### Warning ###
Both aap.sh and scan.awk make use of &quot;*&quot; as a field separator. Thus, both SSIDs and encryption keys
that includes &quot;*&quot; aren&#039;t supported by AAP. Unfortunately this constraint isn&#039;t solvable currently
as the busybox ash shell doesn&#039;t support arrays and the SSID specification allows the complete ASCII
character set. Be sure to utilize aap_blst to exclude those particular accesspoints. AAP may harm your 
OpenWrt Kamikaze 8.09+ /etc/config/wireless configuration permanently if you neglect this warning. Use
AAP at your own risk!

### Changelog ###
Initial release aap_090903</code></pre></div><p>Testing, reporting bugs, voicing comments/suggestions and asking questions about AAP is certainly much appreciated. I hope you feel this initial release of AAP as a valuable share to the OpenWrt community.</p><p>best,<br />orange</p>											<p class="post-edited">(Last edited by <strong>orange</strong> on 14 Aug 2010, 20:09)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p93907">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">orange</div>
					<div class="post-datetime">
						9 Sep 2009, 01:21					</div>
				</div>
				<div class="post-content content">
					<p>aap_090909 has been released. It fixes a bug with missing variable quoting. With the new release, SSIDs that contain spaces are now properly processed by UCI. I plan to do some more code clean-up in the future, but this is a quick fix for your convenience. aap_090909 is available at <a href="http://piranha.klashed.net/pub/aap">http://piranha.klashed.net/pub/aap</a></p><p>thanks,<br />orange</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p93982">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">cptdondo</div>
					<div class="post-datetime">
						10 Sep 2009, 05:50					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m trying your script.&nbsp; scan.awk fails to parse the channel properly, resulting in:</p><p>(I stuck in a few echo statements)</p><p>uci set wireless.wifi0.channel=0<br />uci: Invalid argument<br />uci set wireless.@wifi-iface[0].ssid=4jwireless<br />uci set wireless.@wifi-iface[0].bssid=00:1A:1E:17:E3:20<br />uci set wireless.@wifi-iface[0].hidden=0</p><p>This is with Broadcom 2.4 kernel; sample iwlist scan output:</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Cell 05 - Address: 00:1A:1E:18:01:A0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESSID:&quot;4jwireless&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mode:Managed<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Channel:3<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Quality:2/5&nbsp; Signal level:-76 dBm&nbsp; Noise level:-87 dBm<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Encryption key:off<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 48 Mb/s; 54 Mb/s</p><p>root@OpenWrt:/usr/sbin# cat /tmp/aap_slst <br />1*4jwireless*00:1A:1E:17:E3:20*0*none<br />1*4jauth*00:1A:1E:17:E3:21*0*psk2<br />3*linksys*00:13:10:0E:E4:ED*0*wep<br />2*SeinerHome*00:90:4B:C9:AC:F6*0*wep<br />1*4jwireless*00:1A:1E:19:DD:A0*0*none<br />2*4jauth*00:1A:1E:19:DD:A1*0*psk2</p><p>All of the channels are &#039;0&#039;.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p93985">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">orange</div>
					<div class="post-datetime">
						10 Sep 2009, 07:38					</div>
				</div>
				<div class="post-content content">
					<p>@cptdondo<br />AAP has been written for Atheros wireless chipsets as mentioned above. Thus, you&#039;d need to port it by yourself to be able to use it on your Broadcom 2.4 platform. That said, AAP is designed to be rather easy portable though. I just had a quick look on the iwlist scan output you provided above and the reason it doesn&#039;t work out-of-the-box is pretty obvious. Just have a look on sample Atheros iwlist scan output and you&#039;ll see:</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Cell 04 - Address: 00:1A:1E:18:01:A0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESSID:&quot;4jwireless&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mode:Master<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Frequency:2.462 GHz (Channel 11)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Quality=54/70&nbsp; Signal level=-41 dBm&nbsp; Noise level=-95 dBm<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Encryption key:on<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s; 6 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 48 Mb/s; 54 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Extra:bcn_int=100<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IE: IEEE 802.11i/WPA2 Version 1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Group Cipher : CCMP<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Pairwise Ciphers (1) : CCMP<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Authentication Suites (1) : PSK</p><p>scan.awk parses field $4 to get the appropriate channel and it&#039;s just not the same output. If you&#039;d decide to port it by yourself, have a precise look at line 9 of aap.sh, its UCI section (function aap_connect() {}) and proper adjusting of scan.awk to your iwlist scan output.</p><p>I may help with the porting if you provide me the following:<br />1. iwlist &lt;interface&gt; scan sample with OPN, WEP, WPA1, WPA1/2 mixed and WPA2 encryptions<br />2. uci show wireless sample<br />3. interface (ath0 equivalent)</p><p>Other than that I&#039;d need appropriate information about possible operating modes of the Broadcom 2.4 platform as I never dealed with it before. I hope it&#039;s able to operate in station mode at least?</p>											<p class="post-edited">(Last edited by <strong>orange</strong> on 10 Sep 2009, 07:43)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94000">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">cptdondo</div>
					<div class="post-datetime">
						10 Sep 2009, 14:39					</div>
				</div>
				<div class="post-content content">
					<p>I had a look through scan.awk, which is where the problem lies.&nbsp; Unfortunately I&#039;ve always found awk scripts very difficult to understand; I&#039;m more of a sed/grep kind of person.</p><p>Here&#039;s a list of APs that I can see from my house - not quite the mix you asked for, but it has all of the common modes:</p><p>wl0&nbsp; &nbsp; &nbsp; &nbsp;Scan completed :<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Cell 01 - Address: 00:1A:1E:17:E3:20<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESSID:&quot;4jwireless&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mode:Managed<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Channel:3<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Quality:2/5&nbsp; Signal level:-77 dBm&nbsp; Noise level:-90 dBm<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Encryption key:off<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 48 Mb/s; 54 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Cell 02 - Address: 00:1A:1E:17:E3:21<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESSID:&quot;4jauth&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mode:Managed<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Channel:3<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Quality:2/5&nbsp; Signal level:-77 dBm&nbsp; Noise level:-90 dBm<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IE: IEEE 802.11i/WPA2 Version 1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Group Cipher : TKIP<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Pairwise Ciphers (1) : CCMP<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Authentication Suites (1) : 802.1x<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IE: WPA Version 1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Group Cipher : TKIP<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Pairwise Ciphers (1) : TKIP<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Authentication Suites (1) : 802.1x<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Encryption key:on<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 48 Mb/s; 54 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Cell 03 - Address: 00:13:10:0E:E4:ED<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESSID:&quot;linksys&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mode:Managed<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Channel:11<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Quality:3/5&nbsp; Signal level:-69 dBm&nbsp; Noise level:-87 dBm<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Encryption key:on<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s; 18 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 24 Mb/s; 36 Mb/s; 54 Mb/s; 6 Mb/s; 9 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 12 Mb/s; 48 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Cell 04 - Address: 00:90:xx:xx:xx:xx<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESSID:&quot;XXXXXX&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mode:Managed<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Channel:13<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Quality:1/5&nbsp; Signal level:-82 dBm&nbsp; Noise level:-90 dBm<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Encryption key:on<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Cell 05 - Address: 00:1A:1E:18:01:A0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESSID:&quot;4jwireless&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mode:Managed<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Channel:3<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Quality:2/5&nbsp; Signal level:-76 dBm&nbsp; Noise level:-87 dBm<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Encryption key:off<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 48 Mb/s; 54 Mb/s</p><p>root@OpenWrt:/usr/sbin# uci show | grep wireless<br />wireless.wl0=wifi-device<br />wireless.wl0.type=broadcom<br />wireless.wl0.channel=5<br />wireless.@wifi-iface[0]=wifi-iface<br />wireless.@wifi-iface[0].device=wl0<br />wireless.@wifi-iface[0].network=lan<br />wireless.@wifi-iface[0].mode=sta<br />wireless.@wifi-iface[0].encryption=none<br />wireless.@wifi-iface[0].ssid=4jwireless<br />wireless.@wifi-iface[0].hidden=0<br />wireless.@wifi-iface[0].bssid=00:1A:1E:19:DD:A0</p><p>As I&#039;m not really sure what scan.awk does (too early, not enough coffee) I can&#039;t quite rewrite in with sed but here&#039;s a line that should reliably parse the channel number:</p><p> iwlist scan | awk /hannel/ | sed &#039;s/^.*hannel[^0-9]*//;s/[^0-9]*$//&#039;</p><p>I&#039;ll see later on if I can get it to mind-meld with the rest of your script.&nbsp; awk doesn&#039;t support backreferences, so I can&#039;t really do this within awk.</p><p>--Yan</p>											<p class="post-edited">(Last edited by <strong>cptdondo</strong> on 10 Sep 2009, 15:30)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94013">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">orange</div>
					<div class="post-datetime">
						10 Sep 2009, 15:20					</div>
				</div>
				<div class="post-content content">
					<p>OK, I did some minor adjustments to both scan.awk and aap.sh and uploaded a tarball available at <a href="http://piranha.klashed.net/pub/testing/aap_090909_brcm-2.4_testing.tar.gz">http://piranha.klashed.net/pub/testing/ … ing.tar.gz</a></p><p>Please let me know if it works. I won&#039;t guarantee for proper functionality though as I have no hardware to actually test it. Thus use it at your own risk!</p><p>best,<br />orange</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94025">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">cptdondo</div>
					<div class="post-datetime">
						10 Sep 2009, 16:51					</div>
				</div>
				<div class="post-content content">
					<p>One observation:</p><p>If I understand this correctly, the script writes to flash every time it tries a new AP.&nbsp; I don&#039;t know how many write cycles the flash is good for, but there really is no real reason to write to flash at all.&nbsp; Everything could be done with iwconfig.</p><p>This particular box will sit in a van and be on all the time, 24/7, for the forseeable future - several years at least.&nbsp; I don&#039;t want it writing to flash every few seconds.</p><p>Am I wrong on this?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94033">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">orange</div>
					<div class="post-datetime">
						10 Sep 2009, 17:50					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>cptdondo wrote:</cite><blockquote><p>One observation:</p><p>If I understand this correctly, the script writes to flash every time it tries a new AP.&nbsp; I don&#039;t know how many write cycles the flash is good for, but there really is no real reason to write to flash at all.&nbsp; Everything could be done with iwconfig.</p><p>This particular box will sit in a van and be on all the time, 24/7, for the forseeable future - several years at least.&nbsp; I don&#039;t want it writing to flash every few seconds.</p><p>Am I wrong on this?</p></blockquote></div><p>Actually you&#039;re right on this. AAP utilizes Kamikaze UCI configuration and thus it writes to flash when attempting to connect to a new AP (i.e. it writes to /etc/config/wireless). All temporary output of AAP ends up in /tmp though. That said, your assumption is a bit too pessimistic from my perspective (every few seconds): I mean, as long as AAP stays connected to a particular AP it won&#039;t access the flash, just upon connecting to a new AP (when aap_check() {} fails OR aap_rescandelay is reached). AutoAP for dd-wrt does, btw, the very same thing with NVRAM configuration. That said, feel free to re-write aap_connect () {} to utilize iwconfig commands if you feel better then - I haven&#039;t looked into that as I try to support the standard Kamikaze-style approach to configure things (=UCI)</p><p>From my very personal experience, I can tell you that neither AutoAP for dd-wrt nor AAP harmed my flash so far although I have my device (Fonera 2100) running 24/7 on the rooftop for almost a year now.</p><p>What you haven&#039;t mentioned and what I&#039;m certainly most interested in: Does the brcm-2.4 port I&#039;ve written for you actually works on your device?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94037">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						10 Sep 2009, 18:11					</div>
				</div>
				<div class="post-content content">
					<p>You can just leave out the &quot;uci commit&quot; iirc. As long as you just do &quot;uci set&quot; the changes are staged in /tmp and only written to flash if you run &quot;uci commit&quot;. However, the &quot;wifi&quot; command will pick up the changed values even if the uci was not committed before. As a bonus you can run &quot;uci revert wireless&quot; to get back to the original state. So there&#039;s no need to actually write anything to flash.</p><p>~ JoW</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94040">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">orange</div>
					<div class="post-datetime">
						10 Sep 2009, 18:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>jow wrote:</cite><blockquote><p>You can just leave out the &quot;uci commit&quot; iirc. As long as you just do &quot;uci set&quot; the changes are staged in /tmp and only written to flash if you run &quot;uci commit&quot;. However, the &quot;wifi&quot; command will pick up the changed values even if the uci was not committed before. As a bonus you can run &quot;uci revert wireless&quot; to get back to the original state. So there&#039;s no need to actually write anything to flash.</p><p>~ JoW</p></blockquote></div><p>That&#039;s indeed pretty interesting! Thanks a lot for that valuable insight into the &quot;inner workings&quot; of UCI. I myself assumed that &quot;wifi&quot; would read /etc/config/wireless instead of the staged UCI values in /tmp so far. Knowing about it, I&#039;ll definitely consider this for the next release of AAP once I&#039;ve done appropriate testing on this.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94042">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">orange</div>
					<div class="post-datetime">
						10 Sep 2009, 18:33					</div>
				</div>
				<div class="post-content content">
					<p>@jow<br />One related question that came to my mind when thinking about your proposed change to aap_connect () {}: What&#039;s the actual difference between &quot;wifi&quot; and &quot;/etc/init.d/network restart&quot;? Would &quot;wifi&quot; be sufficient (or maybe even better) for aap_connect () {} from your perspective and is there any difference in regard of using the staged UCI values in /tmp VS the config information from /etc/config/wireless as the used input?</p>											<p class="post-edited">(Last edited by <strong>orange</strong> on 10 Sep 2009, 19:13)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94047">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">cptdondo</div>
					<div class="post-datetime">
						10 Sep 2009, 19:33					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>orange wrote:</cite><blockquote><p>What you haven&#039;t mentioned and what I&#039;m certainly most interested in: Does the brcm-2.4 port I&#039;ve written for you actually works on your device?</p></blockquote></div><p>Yup it works, but I see maintenance headaches if you need to have a custom version for each driver.</p><p>I think I have some time in the next couple of days; I may take a shot at streamlining your script.&nbsp; At least it will give me an opportunity to overcome my obtuseness when it comes to awk.</p><p>--Yan</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94048">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">orange</div>
					<div class="post-datetime">
						10 Sep 2009, 19:48					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><blockquote><p>Yup it works, but I see maintenance headaches if you need to have a custom version for each driver.</p></blockquote></div><p>Cool! I see where you&#039;re coming from, but the maintenance overhead is worth it from my perspective. I even think about posting another &quot;AAP porting&quot; thread and request the needed input from users for all OpenWrt supported platforms. I mean, I&#039;ve written AAP with portability in mind anyway - I just lack the hardware to test every single supported platform, but the effort for brcm-2.4 was actually changing 4 lines of code and that&#039;s not that much to do, even from a maintenance perspective.</p><p>I&#039;m now on my way to work on jow&#039;s proposed change to completely get rid of the write access to flash and will release the next AAP very soon. The remaining question is the &quot;/sbin/wifi&quot; VS &quot;/etc/init.d/network restart&quot; thing - I&#039;d like to address this as well with the new release.</p><p>Stay tuned and have fun with AAP! I hope you&#039;ll like it!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94061">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">cptdondo</div>
					<div class="post-datetime">
						10 Sep 2009, 22:13					</div>
				</div>
				<div class="post-content content">
					<p>Proof of concept for a more generic script:</p><p>First we split the output of iwlist scan into separate files.&nbsp; This gets rid of the need for arrays.</p><p>iwlist wl0 scan &gt; /tmp/test<br />awk &#039;BEGIN{IGNORECASE=1}/^ *cell [0-9]/{close(&quot;/tmp/cell/0&quot;f);f++}{print $0 &gt; &quot;/tmp/cell/0&quot;f}&#039; /tmp/test</p><p>Now we can loop through each of the files in /tmp/cell/NN at our leisure.&nbsp; Instead of looking for hard position parameters, use pattern matching to find our arguments.&nbsp; I&#039;m not clear on what you&#039;re doing with all of the encryption stuff, so I haven&#039;t taken it further.&nbsp; Maybe later.</p><p>for cell in /tmp/cell/0[0-9]* ; do<br />....</p><p>scan.awk:</p><p>#!/usr/bin/awk -f</p><p>BEGIN{IGNORECASE=1;b=&quot;[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]&quot;}</p><p>/b/ {m=match($0,b);if (RSTART &gt; 0) print substr($0,m,RLENGTH)}<br />/^ *ESSID/ {m=match($0,&quot;\&quot;.*\&quot;&quot;);if (RSTART &gt; 0) print substr($0,m,RLENGTH)}<br />/Channel.+[0-9]/ {m=match($0,&quot;Channel&quot;);if (RSTART &gt; 0) {s=substr($0,m);n=match(s,/[0-9]+/);print substr(s,n,RLENGTH)}}<br />/^ *Encryption Key/ {m=match($0, /on$/); if (RSTART &gt; 0) print substr($0,m,RLENGTH)}</p><p>That&#039;s it for now.&nbsp; It should drop a lot of the complexity from your script.</p><p>If you can comment on what you&#039;re doing in the script, I can do more.</p>											<p class="post-edited">(Last edited by <strong>cptdondo</strong> on 10 Sep 2009, 22:20)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94075">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">cptdondo</div>
					<div class="post-datetime">
						11 Sep 2009, 01:34					</div>
				</div>
				<div class="post-content content">
					<p>OK, here&#039;s a shiny new scan.awk that should work with any reasonable driver.&nbsp; I called it scan2.awk.</p><p>#!/usr/bin/awk -f</p><p>BEGIN{<br />&nbsp; &nbsp; &nbsp; &nbsp; IGNORECASE=1<br />&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>/[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]/ {<br />&nbsp; &nbsp; &nbsp; &nbsp; m=match($0,/[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]/);<br />&nbsp; &nbsp; &nbsp; &nbsp; if (RSTART &gt; 0) {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bssid=substr($0,m,RLENGTH);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>/^ *ESSID/ {<br />&nbsp; &nbsp; &nbsp; &nbsp; m=match($0,&quot;\&quot;.*\&quot;&quot;);<br />&nbsp; &nbsp; &nbsp; &nbsp; if (RSTART &gt; 0) essid=substr($0,m+1,RLENGTH-2);<br />&nbsp; &nbsp; &nbsp; &nbsp; next;<br />&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>/Channel.+[0-9]/ {<br />&nbsp; &nbsp; &nbsp; &nbsp; m=match($0,&quot;Channel&quot;);<br />&nbsp; &nbsp; &nbsp; &nbsp; if (RSTART &gt; 0) {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s=substr($0,m);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n=match(s,/[0-9]+/);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; channel=substr(s,n,RLENGTH)}<br />&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>/^ *Quality/ {<br />&nbsp; &nbsp; &nbsp; &nbsp; m=match($0,/[0-9]+\/[0-9]+/);<br />&nbsp; &nbsp; &nbsp; &nbsp; if (RSTART &gt; 0) {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s=substr($0,m);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; split(s,t,&quot;/&quot;);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (t[2] &gt; 0) {quality=t[1]*100/t[2];}<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else quality = 50;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>/^ *Encryption Key/ {<br />&nbsp; &nbsp; &nbsp; &nbsp; m=match($0, /on$/);<br />&nbsp; &nbsp; &nbsp; &nbsp; if (RSTART &gt; 0) encr=1;<br />&nbsp; &nbsp; &nbsp; &nbsp; next;<br />&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>/^ *IE. *IEEE/ {<br />&nbsp; &nbsp; &nbsp; &nbsp; m=match($0, /wpa/);<br />&nbsp; &nbsp; &nbsp; &nbsp; if (RSTART &gt; 0) psk2=1;<br />&nbsp; &nbsp; &nbsp; &nbsp; next;<br />&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>/^ *IE. *WPA/ {<br />&nbsp; &nbsp; &nbsp; &nbsp; m=match($0, /wpa/);<br />&nbsp; &nbsp; &nbsp; &nbsp; if (RSTART &gt; 0) psk=1;<br />&nbsp; &nbsp; &nbsp; &nbsp; next;<br />&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>END{<br />&nbsp; &nbsp; &nbsp; &nbsp; if(psk2 == 1) crypt = &quot;psk2&quot;;<br />&nbsp; &nbsp; &nbsp; &nbsp; else if (psk == 1) crypt =&quot;psk&quot;;<br />&nbsp; &nbsp; &nbsp; &nbsp; else if (encr == 1) crypt = &quot;wep&quot;;<br />&nbsp; &nbsp; &nbsp; &nbsp; else crypt = &quot;none&quot;;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; print quality&quot;*&quot;bssid&quot;*&quot;essid&quot;*&quot;channel&quot;*&quot;crypt;<br />&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>It needs a minor modification to aap.sh; modify the first few lines of aap_scan to read</p><p>aap_scan() {<br />mkdir -p /tmp/cell<br />rm -f /tmp/aap_rlst2 /tmp/cell/*<br />iwlist wl0 scan &gt; /tmp/scan.out<br />awk &#039;BEGIN{IGNORECASE=1}/^ *cell [0-9]/{close(&quot;/tmp/cell/0&quot;f);f++}{print $0 &gt; &quot;/tmp/cell/0&quot;f}&#039; /tmp/scan.out<br />for f in /tmp/cell/0[0-9]*; do cat $f | /usr/sbin/scan2.awk ; done &gt; /tmp/aap_slst</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94105">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">orange</div>
					<div class="post-datetime">
						11 Sep 2009, 15:50					</div>
				</div>
				<div class="post-content content">
					<p>@all<br />AAP 090911 has been released. Thanks to a suggestion by jow, the write-access of AAP to flash memory got completely eliminated. An “uci commit wireless” upon connection attempt to a new AP is actually not needed as “wifi” reads the staged UCI values in /tmp anyway. Thanks jow, I certainly gave you full credits for this within the README that ships with the tarball. AAP 090911 is available at <a href="http://piranha.klashed.net/pub/aap">http://piranha.klashed.net/pub/aap</a></p><p>@cptdondo<br />Thanks for your efforts. I&#039;ll come back to your suggestions later on as I&#039;m under time pressure currently - I&#039;m sorry!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94129">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						11 Sep 2009, 22:45					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>orange wrote:</cite><blockquote><p>@jow<br />One related question that came to my mind when thinking about your proposed change to aap_connect () {}: What&#039;s the actual difference between &quot;wifi&quot; and &quot;/etc/init.d/network restart&quot;? Would &quot;wifi&quot; be sufficient (or maybe even better) for aap_connect () {} from your perspective and is there any difference in regard of using the staged UCI values in /tmp VS the config information from /etc/config/wireless as the used input?</p></blockquote></div><p>The init script restarts the whole networking, which will bring down every interface and reconfigure it again. This can be &quot;harmfull&quot; for users with ppp(oe), pptp or 3g connections since the reinitializing could take quite some time. Just running &quot;wifi&quot; should be enough in almost every case. It will take care of the required ifdown/ifup stuff and interface reconfiguration, also it&#039;s less intrusive then a full network restart and way faster in most cases.</p><p>Regards,<br />JoW</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94246">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">orange</div>
					<div class="post-datetime">
						14 Sep 2009, 14:44					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><blockquote><p>It will take care of the required ifdown/ifup stuff and interface reconfiguration</p></blockquote></div><p>I tried using a plain &quot;wifi&quot; instead of &quot;/etc/init.d/network restart&quot; but this wouldn&#039;t work out because of the ifdown/ifup stuff. Although you mentioned that &quot;wifi&quot; would take care of this as well I cannot confirm this. If I join a new network (uci set blabla) and run &quot;wifi&quot; afterwards &quot;iwconfig&quot; will reflect the changed wireless configuration but I won&#039;t get an IP via DHCP (and this is to my best knowlegde ifup-related, isn&#039;t it?)</p><p>So, here is my proposal and I&#039;d like to ask you what&#039;s right/wrong from your perspective, what&#039;s redundant and so on and so forth.</p><div class="codebox"><pre><code>ifdown wan (OR redundant?)
uci set blabla
...
/sbin/wifi (OR /sbin/wifi up?)
ifup wan</code></pre></div><p>In the wiki for WhiteRussian I found &quot;ifup wan&quot; and &quot;wifi&quot; switched around but this isn&#039;t understandable to me as &quot;ifup wan&quot;, i.e. the dhcp client would request the IP from the former network prior re-configuration with &quot;wifi&quot;. Also, as a last question... Is it needed to kill the dhcp client prior joining a new network with &quot;/sbin/wifi&quot; followed by &quot;ifup wan&quot;? I.e. would I have a double instance if I miss to kill the client previously or will it just re-request an IP? I&#039;m sorry for the rather long response but the documentation here is really misleading so far and due to your previous explanation I&#039;d really like to get rid of the &quot;/etc/init.d/network restart&quot;. I hope this all is understandable.</p><p>Thanks a lot in advance for your support!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94295">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">cptdondo</div>
					<div class="post-datetime">
						15 Sep 2009, 04:15					</div>
				</div>
				<div class="post-content content">
					<p>Here&#039;s my code which handles the wifi up/down scenario.&nbsp; I bring wifi down and then up.&nbsp; wifi by itself apparently toggles the state of wifi, so the only way to be sure is to force it off before bringing up the new config.</p><p>aap2.sh:</p><div class="codebox"><pre><code>#!/bin/ash

aap_connect () {
        mkdir -p /tmp/cell
        rm -f /tmp/cell/*

        iwlist wl0 scan &gt; /tmp/scan.out

        awk &#039;BEGIN{IGNORECASE=1}/^ *cell[0-9]/{close(&quot;/tmp/cell/0&quot;f);f++}{print $0 &gt; &quot;/tmp/cell/0&quot;f}&#039; /tmp/scan.out

#        ls /tmp/cell/

        for ap in /tmp/cell/0[0-9]* ; do

#                echo $ap

                uci set wireless.wl0.disabled=1
                wifi
                if [ -e /proc/`cat /var/run/wl0.pid` ] ; then kill -9 `cat /var/run/wl0.pid` ; fi
                echo 0 &gt; /proc/diag/led/power
                if [ -f /tmp/ap ] ; then rm /tmp/ap ; fi
                if [ -f /tmp/script ] ; then rm /tmp/script ; fi
                sleep 3

                cat $ap | /usr/sbin/scan2.awk
                if [ -e /tmp/ap ] ; then cat /tmp/ap ; fi

                if [ -f /tmp/script ] ; then
                        sh /tmp/script
                        uci set wireless.wl0.disabled=0
                        wifi
                        sleep 5
##############################
#### change the URL to something that works
##############################
                wget -O /dev/null http://www.known.good.website/real.file
                        ret=$?
                        if [ $ret -eq 0 ] ; then
                                echo 1 &gt; /proc/diag/led/power
                                conn=1
                                return
                        else
                                # try to deliver our payload via ping
                                aap_ping
                        fi
                fi
                done
        conn=0
        }

aap_maintain() {
        ret=0
        while [ $ret -eq 0 ] ; do
                sleep 15
                echo checking connection
##############################
#### change the URL to something that works
##############################
                wget -O /dev/null http://www.known.good.website/real.file
                ret=$?
                done
        }

aap_ping() {
        # placeholder for the ping payload routine
        # eventually craft a ping that can carry a small payload, like GPS coordinates
        # a bit complicated by the fact that busybox ping doesn&#039;t have the -p option
        ping -c 3 -q www.google.com
        }

aap_payload() {
        echo payload goes here
        # placeholder for whatever we want to do on connection
        # like deliver email, send GPS location coordinates, etc
        }

while [ 1 ] ; do
        aap_connect
        if [ $conn -eq 1 ] ; then
                aap_payload
                aap_maintain
                fi
        done</code></pre></div><p>scan2.awk:<br /></p><div class="codebox"><pre><code>#!/usr/bin/awk -f

BEGIN{
        IGNORECASE=1
        }

/[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]/ {
        m=match($0,/[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]:[0-9,a-f][0-9,a-f]/);
        if (RSTART &gt; 0) {
                bssid=substr($0,m,RLENGTH);
                next;
                }
        }

/^ *ESSID/ {
        m=match($0,&quot;\&quot;.*\&quot;&quot;);
        if (RSTART &gt; 0) essid=substr($0,m+1,RLENGTH-2);
        next;
        }

/Channel.+[0-9]/ {
        m=match($0,&quot;Channel&quot;);
        if (RSTART &gt; 0) {
                s=substr($0,m);
                n=match(s,/[0-9]+/);
                channel=substr(s,n,RLENGTH)}
        }

/^ *Quality/ {
        m=match($0,/[0-9]+\/[0-9]+/);
        if (RSTART &gt; 0) {
                s=substr($0,m);
                split(s,t,&quot;/&quot;);
                if (t[2] &gt; 0) {quality=t[1]*100/t[2];}
                else quality = 50;
                next;
                }
        }

/^ *Encryption Key/ {
        m=match($0, /on$/);
        if (RSTART &gt; 0) encr=1;
        next;
        }

/^ *IE. *IEEE/ {
        m=match($0, /wpa/);
        if (RSTART &gt; 0) psk2=1;
        next;
        }

/^ *IE. *WPA/ {
        m=match($0, /wpa/);
        if (RSTART &gt; 0) psk=1;
        next;
        }

END {
        if(psk2 == 1) crypt = &quot;psk2&quot;;
        else if (psk == 1) crypt =&quot;psk&quot;;
        else if (encr == 1) crypt = &quot;wep&quot;;
        else crypt = &quot;none&quot;;

        # first we see if we&#039;re in blacklist
        while ( ( getline &lt; &quot;/etc/aap_blst&quot; ) &gt; 0) {
                if (bssid == $0) exit;
                }

        # now we get key if we&#039;re encrypted
        if ( crypt != &quot;none&quot; ) {
                rkey = &quot;&quot;;
                while ( ( getline &lt; &quot;/etc/aap_wlst&quot; ) &gt; 0 ) {
                        if ($1 == bssid) rkey = $2;
                        }
                if ( rkey == &quot;&quot; ) exit;
                }

        print quality &quot;\n&quot; bssid &quot;\n&quot; essid &quot;\n&quot; channel &quot;\n&quot; crypt &quot;\n&quot; rkey &gt; &quot;/tmp/ap&quot;;

        print &quot;uci set wireless.wl0.channel=&quot; channel &gt; &quot;/tmp/script&quot;;
        print &quot;uci set wireless.@wifi-iface[0].ssid=&quot; essid &gt;&gt; &quot;/tmp/script&quot;;
        print &quot;uci set wireless.@wifi-iface[0].bssid=&quot; bssid &gt;&gt; &quot;/tmp/script&quot;;
        if (crypt == &quot;none&quot;) {
                print &quot;uci set wireless.@wifi-iface[0].encryption=none&quot; &gt;&gt; &quot;/tmp/script&quot;;
                }
        else {
                print &quot;uci set wireless.@wifi-iface[0].key=&quot; rkey &gt;&gt; &quot;/tmp/script&quot;;
                print &quot;uci set wireless.@wifi-iface[0].encryption=&quot; crypt &gt;&gt; &quot;/tmp/script&quot;;
                }
        }</code></pre></div>											<p class="post-edited">(Last edited by <strong>cptdondo</strong> on 15 Sep 2009, 04:19)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94415">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">dbrown</div>
					<div class="post-datetime">
						16 Sep 2009, 09:12					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;d like to use these AAP scripts, but am getting the following error from this line:<br /></p><div class="quotebox"><blockquote><p># iwlist wl0 scan<br />wl0&nbsp; &nbsp; &nbsp; &nbsp;Failed to read scan data : Invalid argument</p></blockquote></div><p>What can I do to fix this?</p><p>If it helps, I&#039;m running on the brcm-2.4 version of openwrt, on an asus 520gu router. Here are some rows from the syslog with more detail:<br /></p><div class="quotebox"><blockquote><p>Dec 31 16:00:23 (none) user.emerg kernel: wl0: wlc_attach: chiprev 3 coreunit 0 corerev 13 cccap 0x104007ea maccap 0x30482205 band 2.4G, phy_type 5 phy_rev 0 ana_rev 6<br />Dec 31 16:00:23 (none) user.warn kernel: wl0: Broadcom BCM4318 802.11 Wireless Controller 4.150.10.5</p></blockquote></div><p>And fwiw, I am able to connect to wireless networks by adjusting the settings in /etc/config/wireless, but would prefer to use the AAP scripts instead.</p><p>thanks<br />Dan</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94417">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">dbrown</div>
					<div class="post-datetime">
						16 Sep 2009, 10:32					</div>
				</div>
				<div class="post-content content">
					<p>Nevermind. I needed to un-disable the wireless in the uci settings and run wifi.</p><p>The scripts work great! thanks!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94468">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">orange</div>
					<div class="post-datetime">
						16 Sep 2009, 19:02					</div>
				</div>
				<div class="post-content content">
					<p>Just a quick note: AAP 090916 is out with some new features/enhancements! Please read <a href="http://piranha.klashed.net/2009/09/16/piranha-30-090916-aap-090916-released/">http://piranha.klashed.net/2009/09/16/p … -released/</a> for further information.</p><p>drbrown, cptdondo:<br />I&#039;ll response as soon as I have enough time to do so. brcm-2.4 will be maintained (WIP)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94846">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">orange</div>
					<div class="post-datetime">
						23 Sep 2009, 14:38					</div>
				</div>
				<div class="post-content content">
					<p>If you&#039;re interested in AAP and/or Piranha 3.0, I&#039;d like to encourage you to follow my blog <a href="http://piranha.klashed.net">http://piranha.klashed.net</a>/ for updates from now on - it&#039;s even possible to subscribe to my <a href="http://piranha.klashed.net/feed/">http://piranha.klashed.net/feed/</a> RSS feed. From my perspective it makes not too much sense to &quot;spam&quot; these forums every time I release something new. New releases of AAP will be (at any time) available at <a href="http://piranha.klashed.net/pub/aap/">http://piranha.klashed.net/pub/aap/</a> and of Piranha 3.0 at <a href="http://piranha.klashed.net/pub/3.0/">http://piranha.klashed.net/pub/3.0/</a></p><p>I hope you feel this as an appropriate decision. I&#039;ll certainly check these forums on a regular basis, so feel free to ask whatever you like about AAP here and I&#039;ll come back to you asap.</p><p>Thanks,<br />orange</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p95027">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">foxtroop11</div>
					<div class="post-datetime">
						28 Sep 2009, 05:14					</div>
				</div>
				<div class="post-content content">
					<p>@Orange</p><p>Found this thread more informative. I have your script running on the WGT634U, just playing around with it now. Still trying to figure out how to kick it in as a backup on my other project. Almost forgot, I can try out your script with the ath9k driver and N if you think it would work. I know ath0 is more like wlan0 or wifi0, can&#039;t remember.</p>											<p class="post-edited">(Last edited by <strong>foxtroop11</strong> on 28 Sep 2009, 05:16)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p95029">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">foxtroop11</div>
					<div class="post-datetime">
						28 Sep 2009, 05:23					</div>
				</div>
				<div class="post-content content">
					<p>One more thing, would it be hard to use this with broadcom wireless devices? I wasn&#039;t sure if that&#039;s what was addressed earlier or if that was just in reference to the 2.4 kernel broadcom itself. Just thinking about all the devices dd-wrt autoap currently run&#039;s on and would like to switch them over to openwrt and your aap, they never did add in wpa encryption and that&#039;s something I need.</p><p>Thanks</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>