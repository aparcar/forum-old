<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Mounting 4GB SD card</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 23 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p32496">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">kingpepsi</div>
					<div class="post-datetime">
						21 Aug 2006, 23:27					</div>
				</div>
				<div class="post-content content">
					<p>Hi, </p><p>i have problems to mount my 4GB SD Card, manufactor &quot;extremememory&quot;. It works perfekt with a 512 MB SD card.</p><p>&quot;insmod mmc&quot; gives debug as follows:</p><p>mmc Hardware init<br />mmc Card init<br />mmc Card init *1*<br />mmc Card init *2*<br />Size = 3912704, hardsectsize = 2048, sectors = 1956352<br /> mmca: p1<br />devfs_mk_dir(mmc/disc0): using old entry in dir: 80d094e0 &quot;mmc&quot;<br />devfs_register(disc): could not append to parent, err: -17<br />FAT: bogus logical sector size 0<br />VFS: Can&#039;t find a valid FAT filesystem on dev 79:01.</p><p>The strange thing is that Windows also cannot access the card, nor to format it. My digicam (Canon Ixus 50) works fine saving picutures and movies on it...</p><p>any idea?<br />thx</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p32522">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">kingpepsi</div>
					<div class="post-datetime">
						22 Aug 2006, 13:31					</div>
				</div>
				<div class="post-content content">
					<p>With another card reader (also on Windows XP) ist works fine too. I formated it using FAT32, but the same problem. ;(</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p32525">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">star882</div>
					<div class="post-datetime">
						22 Aug 2006, 15:14					</div>
				</div>
				<div class="post-content content">
					<p>What happens if you format it as ext2/3 in the router?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p32563">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">kingpepsi</div>
					<div class="post-datetime">
						22 Aug 2006, 20:35					</div>
				</div>
				<div class="post-content content">
					<p>how i schould do that? I tried:&nbsp; mke2fs, mkfs.ext2 and mkfs.ext3.&nbsp; all of them result in segmentation fault or hanging....</p><p>mke2fs /dev/mmc/disc0/part1<br />mke2fs 1.38 (30-Jun-2005)<br />Filesystem label=<br />OS type: Linux<br />Block size=4096 (log=2)<br />Fragment size=4096 (log=2)<br />1958400 inodes, 3912700 blocks<br />195635 blocks (5.00%) reserved for the super user<br />First data block=0<br />120 block groups<br />32768 blocks per group, 32768 fragments per group<br />16320 inodes per group<br />Superblock backups stored on blocks:<br />&nbsp; &nbsp; &nbsp; &nbsp; 32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208</p><p>Writing inode tables: Segmentation fault<br />root@OpenWrt:~# mkf /dev/mmc/disc0/part1<br />mkfifo&nbsp; &nbsp; &nbsp; &nbsp;mkfs.ext2&nbsp; &nbsp; mkfs.ext3&nbsp; &nbsp; mkfs.msdos&nbsp; &nbsp;mkfs.vfat<br />root@OpenWrt:~# mkfs.ext2 /dev/mmc/disc0/part1<br />mke2fs 1.38 (30-Jun-2005)<br />Segmentation fault</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p32574">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">star882</div>
					<div class="post-datetime">
						22 Aug 2006, 23:20					</div>
				</div>
				<div class="post-content content">
					<p>Have you tried making a ext partition on the *entire* card (no partition table)?<br />How much RAM does your router have? Could it be running out of memory?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p32619">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">kingpepsi</div>
					<div class="post-datetime">
						23 Aug 2006, 15:34					</div>
				</div>
				<div class="post-content content">
					<p>I have a WRt54G v. 4&nbsp; Wlan-router. with the whiterussian RC. 5, jffs version.<br />I am not very familar with linux, especailly with this tiny ditriburtion, so can you tell me please exactly what i should try? (commands and required packages)</p><p>maybe i have to mount the card with specal params?</p><p>thx</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p32628">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">kingpepsi</div>
					<div class="post-datetime">
						23 Aug 2006, 20:53					</div>
				</div>
				<div class="post-content content">
					<p>I tried to make a hole ext part using fdisk: The strange thing is that 16GB are found??</p><p>Command (m for help): p</p><p>Disk /dev/mmc/disc0/part1: 16.0 GB, 16026419200 bytes<br />4 heads, 16 sectors/track, 122271 cylinders<br />Units = cylinders of 64 * 2048 = 131072 bytes</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Device Boot&nbsp; &nbsp; &nbsp; Start&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;End&nbsp; &nbsp; &nbsp; Blocks&nbsp; &nbsp;Id&nbsp; System<br />/dev/mmc/disc0/part1p1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1&nbsp; &nbsp; &nbsp; 122271&nbsp; &nbsp; 15650656&nbsp; &nbsp; 5&nbsp; Extended</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p32652">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">star882</div>
					<div class="post-datetime">
						24 Aug 2006, 00:30					</div>
				</div>
				<div class="post-content content">
					<p>Check your wiring. A loose connection or a wire too long will cause signal problems and very strange behavior.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p32655">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">kingpepsi</div>
					<div class="post-datetime">
						24 Aug 2006, 00:46					</div>
				</div>
				<div class="post-content content">
					<p>but the 512MB Card works fine?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p32665">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">star882</div>
					<div class="post-datetime">
						24 Aug 2006, 05:07					</div>
				</div>
				<div class="post-content content">
					<p>Some cards are more sensitive than others. The 4GB card probably has a higher speed interface (high slew rate) that can cause oscillations.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p32767">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">kingpepsi</div>
					<div class="post-datetime">
						25 Aug 2006, 21:48					</div>
				</div>
				<div class="post-content content">
					<p>Hi,<br />now i shortened up the wires as short as possible, but i still get error when mounting the card:</p><p>&quot;insmod mmc&quot; works fine, correct size is shown:</p><p>mmc Hardware init<br />mmc Card init<br />mmc Card init *1*<br />mmc Card init *2*<br />Size = 3912704, hardsectsize = 2048, sectors = 1956352<br />Partition check:<br /> mmca: p1</p><p>mount gives error: &quot; Mounting /dev/mmc/disc0/part1 on /mmc failed: Invalid argument&quot;<br />and the dmesg:</p><p>FAT: bogus logical sector size 0<br />VFS: Can&#039;t find a valid FAT filesystem on dev 79:01.</p><p>so it is the same as before <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>Any ideas?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p32769">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">star882</div>
					<div class="post-datetime">
						25 Aug 2006, 23:15					</div>
				</div>
				<div class="post-content content">
					<p>Now try formatting the card as ext. What happens?<br />Also try adding a capacitor between 3.3v and gnd as close to the card as possible. And make sure the two grounds go to the same point in the router, or there may be a ground loop.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p32773">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">kingpepsi</div>
					<div class="post-datetime">
						26 Aug 2006, 00:54					</div>
				</div>
				<div class="post-content content">
					<p>I tried:</p><p>root@OpenWrt:~# mkfs.ext2 /dev/mmc/disc0/part1<br />mke2fs 1.38 (30-Jun-2005)<br />Filesystem label=<br />OS type: Linux<br />Block size=4096 (log=2)<br />Fragment size=4096 (log=2)<br />1958400 inodes, 3912700 blocks<br />195635 blocks (5.00%) reserved for the super user<br />First data block=0<br />120 block groups<br />32768 blocks per group, 32768 fragments per group<br />16320 inodes per group<br />Superblock backups stored on blocks:<br />&nbsp; &nbsp; &nbsp; &nbsp; 32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208</p><p>Writing inode tables: Segmentation fault</p><br /><p>Groud wires have same lenght and are connected to same ground pin. I have no capacity here but I am afraid its another problem. Have you ever used a 4 GB SD-Card in the WRTG54 v4?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p32781">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">AndiM</div>
					<div class="post-datetime">
						26 Aug 2006, 02:16					</div>
				</div>
				<div class="post-content content">
					<p>I have very similar issues with a pre-formatted 512M card on WRT54GS v1.0 (recognized card only after swapping DO and CLK, as on several<br />other models) here:</p><p>FAT: bogus logical sector size 0<br />VFS: Can&#039;t find a valid FAT filesystem on dev 79:01.</p><p>IIRC I formatted the card using FAT32.</p><p>dd&#039;ing a couple sectors and scp&#039;ing the dump file to my PC and hextype&#039;ing it there shows exactly the same stuff<br />as when hextype&#039;ing the card on my PC (where it mounts fine!!).</p><p>whiterussian RC5 here, too.</p><p>Hopefully further investigation will tell me what&#039;s wrong...</p><p>Now where did I put my 8M garbage SD card, pray tell?</p><p>.<br />.<br />.</p><p>Oops, just realized that I had formatted the card using ext3 (doh!), so this is most likely the problem here.<br />However after installing ext3 modules I get a nice OOPS when mounting the partition...</p><p>Anyway, I&#039;ll probably reformat using JFFS2 (if it makes sense!) or vfat.</p><br /><p>Conclusion of this posting: are you sure the card has the filesystem/data content that you think it has?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p32944">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">kingpepsi</div>
					<div class="post-datetime">
						29 Aug 2006, 21:28					</div>
				</div>
				<div class="post-content content">
					<p>Now i inserted a capacitor for buffering between ground and 3,3V directly next to the card, but the problem is still the same... do you have a 4 GB card running?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p33729">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">robwen</div>
					<div class="post-datetime">
						12 Sep 2006, 19:23					</div>
				</div>
				<div class="post-content content">
					<p><a href="http://forum.openwrt.org/post.php?tid=6998">http://forum.openwrt.org/post.php?tid=6998</a></p><p>The mmc.o driver for OpenWrt only supports 2 GB SD cards because the byte address sent to the mmc/sd card is 32 bits, and the math used to calculate this from the block address uses a SIGNED number. Therefore, mmc.o only supports cards whose size is between -2 GB and +2 GB. I have made extensive changes to MY copy of mmc.c, and I fixed the math to support 4 GB cards. I do not have a 4 GB SD card to test this though.</p><p>My mmc driver has been optimized to leave interrupts ON where appropriate, so other sessions are not bogged down during lengthy SD card IO (such as using dd to copy a partition on the SD card). I also rewrote the SPI bitbang routines to use separate input-only and output-only subroutines, and to use word-based rather than bit-based IO, so I can output the clock and data at the same time (only 2 GPIO outputs per data bit). Input from the SD card requires 2 outputs plus an input, so it is a little slower.</p><p>I also output to both GPIO2 and GPIO5, so my driver works fine with either router wiring version. It does not take any extra time to output a clock bit plus 2 outputs to the sd card, when output an entire word to the GPIO port. My GPIO outputs are 32 bits, because testing showed this to be faster than 8-bit outputs to these ports.</p><p>There seems to be a hardware wait-state generated during GPIO output, because writing to the port is far slower than writing to RAM. Also, timing analysis shows that the SD card itself takes extra time during sequential reads or writes when it crosses an erase-block boundary. Diffierent SD cards have different timing boundaries.</p><p>Although I have not done it yet, I plan to also support using DI and DO sharing a single GPIO bit, as is commonly done using PIC microcontrollers, by tying the SD card output pin to its input pin via a resistor. My code changes will need to change the data direction on the shared GPIO pin between reads and writes to the SD card.</p><p>I turn off the WRT54G front panel amber LED before exiting from the mmc driver, so the LED doubles as a &quot;disk access&quot; light.</p><p>I have made numerous other small corrections to the code as well. </p><p>I am booting (pivotroot) from my SD card ext3 partition, and I also have a second partition formatted as JFFS2. In theory, the effective throughput should be faster sending COMPRESSED data over the slow bit-bang SPI bus. Because JFFS2 always does an integrity check during mount, it takes several minutes to mount, so my /etc/init.d startup script launches the mount in the background so booting can continue. The JFFS2 partition mount point is empty for several minutes after booting, until the background mount completes.</p><p>I have not yet submitted my extensive mmc.c changes, or my updated mmc.o. I plan to make more changes, but I have been using my current MUCH FASTER version since March 2006, with no glitches or other problems, so I should probably submit my current mmc driver as-is.</p><p>Where do I submit an updated mmc driver?</p><p>BTW, I discovered that an SD card plugs nicely into a floppy edge-connector (many of which are unused in most computers). All the MMC pins line up good, but the unused SD-only pins do not align. I use a small piece of plastic inserted into the connector to fill the unused pins and help align the card during insertion. I have a nice set of photos that show assembling and using this connector for mmc.</p><p>SD floppy details here:<br /><a href="http://uanr.com/sdfloppy/">http://uanr.com/sdfloppy/</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p33760">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">star882</div>
					<div class="post-datetime">
						13 Sep 2006, 15:07					</div>
				</div>
				<div class="post-content content">
					<p>Nice to see someone working on it. Can you please figure out how to read the write protect switch and handle hotswapping?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p33771">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">bigdan</div>
					<div class="post-datetime">
						13 Sep 2006, 19:19					</div>
				</div>
				<div class="post-content content">
					<p>That&#039;s awesome. but where can I download the updated mmc driver</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p33874">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">robwen</div>
					<div class="post-datetime">
						15 Sep 2006, 11:44					</div>
				</div>
				<div class="post-content content">
					<p>The write protect switch is a mechanical switch in an SD socket. The easy way to read it is to connect the switch pins across a switch in the router (i.e. reset switch or front panel switch). Then the device driver needs to know that it should use that switch as a write protect...</p><p>Regarding when the driver will be finished, I am reconstructing source code in my &quot;spare&quot; time, from various backup copies (XP ate it and many other files during a bootup scandisk after a system lockup -- thanks Microsoft)...&nbsp; &nbsp;;-(&nbsp; I hope to be finished soon (a matter of days).</p><p>I lost some more code when I did a &quot;tar -zcvf&quot; when I meant to do a &quot;tar -zxvf&quot; -- thanks Linux...&nbsp; ;-(</p><p>I do have an mmc.o that I have been using since February in one of my routers, and it is quite stable. I suppose I could release the binary only for now...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p34003">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">robwen</div>
					<div class="post-datetime">
						17 Sep 2006, 22:30					</div>
				</div>
				<div class="post-content content">
					<p>Instead of needing the mmc.o device driver handling the SD socket write-protect switch, perhaps the script that mounts the mmc device should decide whether to mount it &quot;rw&quot; (read-write) or &quot;ro&quot; (read-only), by checking the switch (with the GPIO utility). This would save needing to have a custom mmc.o driver module that handles the switch and the complexity of handling writes to a &quot;read-only&quot; device that Linux thinks is writable...</p><p>BTW, I added descriptions to the images on my web page, to answer questions I read on various message boards. The text is redundant though -- there are links to my webpage from all over the world, in multiple languages, and I have gotten hits from MANY countries (just since yesterday).</p><p> During my &quot;15 minutes of fame&quot; period, I was getting so much traffic (over 2 GB/hr), that my web host suspended my page. I had to switch providers, leaving my page down for several days.</p><p>&nbsp; &nbsp;<a href="http://uanr.com/sdfloppy/">http://uanr.com/sdfloppy/</a></p><p>I will have the updated MMC driver available (which leaves interrupts ON while waiting for SD card ready, plus much faster port I/O, etc.), &quot;Real Soon Now&quot;... I am doing &quot;source code reconstruction&quot; due to a hard drive crash, with literally MANY hundreds of unindexed DVDs and CDs, containing various backups from my stack of 250 GB drives...&nbsp; ;-) &amp; ;-(</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p39823">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">m4rc0</div>
					<div class="post-datetime">
						29 Dec 2006, 18:12					</div>
				</div>
				<div class="post-content content">
					<p>Robwen: When will you be posting your version of the driver?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p40174">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">dmytro</div>
					<div class="post-datetime">
						4 Jan 2007, 23:54					</div>
				</div>
				<div class="post-content content">
					<p>Are you finished with mmc.c driver yet? can you post it please.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p40211">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">m4rc0</div>
					<div class="post-datetime">
						5 Jan 2007, 11:10					</div>
				</div>
				<div class="post-content content">
					<p>I sent an email to this guy, but he doesn&#039;t seem to respond to it. A dead shame!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p40620">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">dmytro</div>
					<div class="post-datetime">
						11 Jan 2007, 02:26					</div>
				</div>
				<div class="post-content content">
					<p>remmeber the link to speedup the transfare rate to 300Kb/s? the link does not work! can someone repost that mmc.c?</p><p>Thank you</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>