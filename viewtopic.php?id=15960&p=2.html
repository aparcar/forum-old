<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> WRT600NV11 - Serial Port</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 2 Apr 2018 and 29 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 2 of 2</div><nav><ul><li><a href="viewtopic.php%3Fid=15960&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p71703">
				<div class="post-metadata">
					<div class="post-num">Post #26</div>
					<div class="post-author">dch24</div>
					<div class="post-datetime">
						3 Aug 2008, 00:47					</div>
				</div>
				<div class="post-content content">
					<p>So this might be revealing my n00bishness but I can&#039;t load Kamikaze on my wrt600n. I would like to look at how the 2.4 kernel maps flash so I can help you ZeroPain, but what did you do to build a .bin file?</p><p><strong>Edit:</strong> I can build Kamikaze for a Broadcom 4785 with the bcm5397 roboswitch... But when I tried to tftp up openwrt-wrt350n_v1-squashfs.bin the CFE rejected it. I think what I&#039;m missing is the signature... here is the relevant section from kamikaze/target/linux/brcm-2.4/image/Makefile:</p><div class="codebox"><pre><code>define Image/Build/jffs2-64k
        $(call Image/Build/CyberTAN,$(1),wrt54g3g,W54F,2.20.1,$(patsubst jffs2-%,jffs2,$(1)))
        $(call Image/Build/CyberTAN,$(1),wrt54g3g-em,W3GN,2.20.1,$(patsubst jffs2-%,jffs2,$(1)))
        $(call Image/Build/CyberTAN,$(1),wrt54g,W54G,4.71.1,$(patsubst jffs2-%,jffs2,$(1)))
        $(call Image/Build/CyberTAN,$(1),wrt54gs_v4,W54s,1.09.1,$(patsubst jffs2-%,jffs2,$(1)))
        $(call Image/Build/CyberTAN,$(1),wrt150n,N150,1.51.3,$(patsubst jffs2-%,jffs2,$(1)))
        $(call Image/Build/CyberTAN,$(1),wrt300n_v1,EWCB,1.51.2,$(patsubst jffs2-%,jffs2,$(1)))
        $(call Image/Build/CyberTAN,$(1),wrt350n_v1,EWCG,1.04.1,$(patsubst jffs2-%,jffs2,$(1)))
        $(call Image/Build/Motorola,$(1),wa840g,2,$(patsubst jffs2-%,jffs2,$(1)))
        $(call Image/Build/Motorola,$(1),we800g,3,$(patsubst jffs2-%,jffs2,$(1)))
endef</code></pre></div><p>I think if I&#039;m reading your posts correctly, ZeroPain, you have it working. How?</p><p><strong>Edit:</strong> I think the wrt600n uses the bcm5397 switch, supported by the bcm57xx driver</p>											<p class="post-edited">(Last edited by <strong>dch24</strong> on 7 Aug 2008, 00:35)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71708">
				<div class="post-metadata">
					<div class="post-num">Post #27</div>
					<div class="post-author">dch24</div>
					<div class="post-datetime">
						3 Aug 2008, 08:54					</div>
				</div>
				<div class="post-content content">
					<p>OK, I think I identified the wrt600n magic: $(call Image/Build/CyberTAN,$(1),wrt600n_v1,<strong>GMTK</strong>,1.04.1,$(patsubst jffs2-%,jffs2,$(1)))</p><p>But CFE still gives me the same rejection of my TFTP:</p><div class="codebox"><pre><code>CFE version 1.0.37 for BCM947XX (32bit,SP,LE)
Build Date: Fri Jan 18 15:59:34 CST 2008 (joseph@localhost)
Copyright (C) 2000,2001,2002,2003 Broadcom Corporation.

Initializing Arena
Initializing PCI. [normal]
PCI bus 0 slot 0/0: vendor 0x14e4 product 0x0800 (flash memory, rev 0x02)
PCI bus 0 slot 1/0: vendor 0x14e4 product 0x471f (ethernet network, rev 0x02)
PCI bus 0 slot 2/0: vendor 0x14e4 product 0x471a (USB serial bus, interface 0x1)
PCI bus 0 slot 2/1: vendor 0x14e4 product 0x471a (USB serial bus, interface 0x2)
PCI bus 0 slot 3/0: vendor 0x14e4 product 0x471b (USB serial bus, rev 0x02)
PCI bus 0 slot 4/0: vendor 0x14e4 product 0x0804 (PCI bridge, rev 0x02)
PCI bus 0 slot 5/0: vendor 0x14e4 product 0x0816 (MIPS processor, rev 0x02)     
PCI bus 0 slot 6/0: vendor 0x14e4 product 0x471d (IDE mass storage, rev 0x02)   
PCI bus 0 slot 7/0: vendor 0x14e4 product 0x4718 (network/computing crypto, rev)
PCI bus 0 slot 8/0: vendor 0x14e4 product 0x080f (RAM memory, rev 0x02)         
PCI bus 0 slot 9/0: vendor 0x14e4 product 0x471e (class 0xfe, subclass 0x00, re)
Initializing Devices.                                                           
Boot partition size = 262144(0x40000)                                           
PCI bus 0 slot 1/0: pci_map_mem: attempt to map 64-bit region tag=0x800 @ addr=4
PCI bus 0 slot 1/0: pci_map_mem: addr=0x18010004 pa=0x18010000                  
ge0: BCM5750 Ethernet at 0x18010000                                             
CPU type 0x2901A: 300MHz                                                        
Total memory: 32768 KBytes                                                      
                                                                                
Total memory used by CFE:  0x80300000 - 0x804066F0 (1074928)                    
Initialized Data:          0x80337C80 - 0x8033AC10 (12176)                      
BSS Area:                  0x8033AC10 - 0x8033C6F0 (6880)                       
Local Heap:                0x8033C6F0 - 0x804046F0 (819200)                     
Stack Area:                0x804046F0 - 0x804066F0 (8192)                       
Text (code) segment:       0x80300000 - 0x80337C80 (228480)                     
Boot area (physical):      0x00407000 - 0x00447000                              
Relocation Factor:         I:00000000 - D:00000000                              
                                                                                
eth0: Link speed: 1000BaseT FDX                                                 
Device eth0:  hwaddr 00-90-4C-A6-00-01, ipaddr 192.168.1.1, mask 255.255.255.0  
        gateway not set, nameserver not set                                     
Loader:raw Filesys:tftp Dev:eth0 File:: Options:(null)                          
Loading: .... 2363424 bytes read                                                
Entry at 0x804066f0                                                             
Loader:raw Filesys:memory Dev:eth0 File::0x804066f0 Options:(null)              
Loading: . 0 bytes read                                                         
Failed.                                                                         
Could not load :0x804066f0: Error                                               
CFE&gt;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71709">
				<div class="post-metadata">
					<div class="post-num">Post #28</div>
					<div class="post-author">ZeroPain</div>
					<div class="post-datetime">
						3 Aug 2008, 09:50					</div>
				</div>
				<div class="post-content content">
					<p>if you download linksys gpl source code for the wrt600n <br /><a href="ftp://ftp.linksys.com/opensourcecode/wrt600n/1.01.36/wrt600n_v1.01.36.03.tgz">ftp://ftp.linksys.com/opensourcecode/wr â€¦ .36.03.tgz</a></p><p>use this file on the trx you made<br />wrt600n_v1.01.36.03/src/user/tools/trailer-tools/trailer_mkimage/mkimage<br />and just move it to your bin folder</p><p>example:<br /></p><div class="codebox"><pre><code>./mkimage openwrt-brcm-2.4-squashfs.trx
mv Trailed_LINKSYS_WRTB193N_1.01.36\ build\ 3_US.bin openwrt-wrt600n-squashfs.bin</code></pre></div><p>Your router should accept openwrt-wrt600n-squashfs.bin its what i do to load it. <br />the 1st few times i had to load dd-wrt on it then use dd-wrt to flash openwrt.<br />But luckly i found that file in the linksys gpl code.</p>											<p class="post-edited">(Last edited by <strong>ZeroPain</strong> on 3 Aug 2008, 09:50)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71710">
				<div class="post-metadata">
					<div class="post-num">Post #29</div>
					<div class="post-author">dch24</div>
					<div class="post-datetime">
						3 Aug 2008, 09:50					</div>
				</div>
				<div class="post-content content">
					<p>OK, I&#039;m slowly figuring it out.</p><p>This time I loaded the .trx instead of the .bin. Now I just need to figure out how to add the right trailer when generating the .trx:</p><div class="codebox"><pre><code>eth0: Link speed: 1000BaseT FDX                                                 
Device eth0:  hwaddr 00-90-4C-A6-00-01, ipaddr 192.168.1.1, mask 255.255.255.0  
        gateway not set, nameserver not set                                     
Loader:raw Filesys:tftp Dev:eth0 File:: Options:(null)                          
Loading: .... 2363392 bytes read                                                
Entry at 0x804066f0                                                             
Reading from 0x804066f0: front: Total size is 2363392                           
BCM5395                                                                         
No Trailer is not allowed!                                                      
Loader:raw Filesys:raw Dev:flash0.os File: Options:(null)                       
Loading: .. 3732 bytes read                                                     
Entry at 0x80001000                                                             
Closing network.                                                                
Starting program at 0x80001000                                                  
CPU revision is: 0002901a                                                       
Linux version 2.4.36 (eko@dd-wrt) (gcc version 3.4.6 (OpenWrt-2.0)) #674 Fri Ju8
Setting the PFC to its default value</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71711">
				<div class="post-metadata">
					<div class="post-num">Post #30</div>
					<div class="post-author">ZeroPain</div>
					<div class="post-datetime">
						3 Aug 2008, 09:57					</div>
				</div>
				<div class="post-content content">
					<p>Looks like i posted the answer to your question like 15 seconds before you asked it. just in case you don&#039;t see it i know i have a habit of scrolling down to the last thing i posted don&#039;t tend to look at anything before it.</p><p>I see that you do have a serial port connected. This took me awail to figure out i thought the bootloader was locked out.<br />Because most everything i read you just pressed any key during bootup to access it and it didn&#039;t work for this router.</p><p>But if you need to get into the CFE i found the hitting crtl + c during the bootwait time will drop me to CFE <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>basicly once i see<br /></p><div class="codebox"><pre><code>Device eth0:  hwaddr 00-90-4C-A6-00-01, ipaddr 192.168.1.1, mask 255.255.255.0  
        gateway not set, nameserver not set                                     
Loader:raw Filesys:tftp Dev:eth0 File:: Options:(null)                          
Loading:</code></pre></div><p>i start hitting crtl + c and then i&#039;m at the CFE prompt</p>											<p class="post-edited">(Last edited by <strong>ZeroPain</strong> on 3 Aug 2008, 09:58)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71769">
				<div class="post-metadata">
					<div class="post-num">Post #31</div>
					<div class="post-author">dch24</div>
					<div class="post-datetime">
						5 Aug 2008, 01:20					</div>
				</div>
				<div class="post-content content">
					<p>The ctrl-c trick is great! But I crossed a wire while soldering and sent +5V down the router&#039;s RX line... Yeah, I can&#039;t send anything to the router, just listen to it. <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> I even looked at reprogramming it to use the second serial port out of the CPU, but that one isn&#039;t apparently visible anywhere on the PCB.</p><p>Thanks for the tip on mkimage! I reverse engineered it:<br />.text is 0x80485b0 - 0x8048b68<br />main() starts somewhere around 0x8048684<br />Inside main() from 0x80487b1 to 0x804891d fills in the struct<br />0x8048924 call 0x8048a78 - this is the CRC function<br />main() continues from there</p><p>The CRC function is a standard IEEE 802.3 CRC32, so here is an 86-line C program to output the image file. The point is to open-source this function for OpenWrt. The CRC implementation is the most simple way (certainly not the fastest).</p><div class="codebox"><pre><code>#include &lt;stdio.h&gt;
#include &lt;errno.h&gt;
#include &lt;string.h&gt;
#include &lt;stdint.h&gt;

#define IEEE_802_3_CRC 0xEDB88320
struct mkimage_trailer
{
    char magic[4];
    uint32_t version;
    uint32_t PID;
    uint32_t filesize;
    uint32_t crc32;
    char padding[12];
};

void docrc(uint32_t * crc, unsigned char c)
{
    int i;
    *crc ^= c;
    for (i = 0; i &lt; 8; i++)
        if (*crc &amp; 1) *crc = (*crc &gt;&gt; 1) ^ IEEE_802_3_CRC;
            else *crc &gt;&gt;= 1;
}

int do_trailer(FILE * fin, FILE * fout, const char * nin, const char * nout)
{
    int i;
    struct mkimage_trailer t;
    memset(&amp;t, 0, sizeof(t));
    uint32_t crc = (uint32_t) -1;
    while (!feof(fin)) {
        char c;
        if (fread(&amp;c, 1, 1, fin) != 1) {
            if (feof(fin)) break;
            fprintf(stderr, &quot;\&quot;%s\&quot; read err %d\n&quot;, nin, errno);
            return 1;
        }
        docrc(&amp;crc, c);
        t.filesize++;
        if (fwrite(&amp;c, 1, 1, fout) != 1) {
            fprintf(stderr, &quot;\&quot;%s\&quot;: write err %d\n&quot;, nout, errno);
            return 1;
        }
    }
    strncpy(t.magic, &quot;GMTK&quot;, sizeof(t.magic));
    t.version = 1;
    t.filesize += sizeof(t);
    t.PID = 0x1020001lu;
    // note: we compute the CRC of everything, including t.crc32 (= 0 now)
    for (i = 0; i &lt; (int) sizeof(t); i++) docrc(&amp;crc, ((char *) &amp;t)[i]);
    t.crc32 = crc ^ (uint32_t) -1;    // IEEE 802.3 CRC requires a final XOR
    if (fwrite(&amp;t, 1, sizeof(t), fout) != sizeof(t)) {
        fprintf(stderr, &quot;\&quot;%s\&quot; trailer write err: %d\n&quot;, nout, errno);
        return 1;
    }
    return 0;
}

int main(int argc, char ** argv)
{
    if (argc != 2) {
        fprintf(stderr, &quot;Usage: %s filename\n&quot;, argv[0]);
        return 1;
    }
    const char * nout = &quot;Trailed_LINKSYS_WRTB193N_1.01.36 build 3_US.bin&quot;;
    FILE * fin = fopen(argv[1], &quot;rb&quot;), * fout = fopen(nout, &quot;wb&quot;);
    if (!fin) {
        fprintf(stderr, &quot;Failed to open \&quot;%s\&quot; for reading\n&quot;, argv[1]);
        return 1;
    }
    if (!fout) {
        fprintf(stderr, &quot;Failed to open \&quot;%s\&quot; for writing\n&quot;, nout);
        fclose(fin);
        return 1;
    }
    if (do_trailer(fin, fout, argv[1], nout)) {
        fclose(fin);
        fclose(fout);
        return 1;
    }
    fclose(fin);
    fclose(fout);
    return 0;
}</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71771">
				<div class="post-metadata">
					<div class="post-num">Post #32</div>
					<div class="post-author">ZeroPain</div>
					<div class="post-datetime">
						5 Aug 2008, 01:43					</div>
				</div>
				<div class="post-content content">
					<p>if you don&#039;t mind and haven&#039;t done so already I&#039;m going to look into making a patch that will put it in as a option of the make menuconfig so i can chose to have it automatically trail the file for me.</p><p>I would have looked in to doing it sooner i just didn&#039;t want to use Linksys&#039;s binary to do it.</p><p>Yeah i couldn&#039;t find a 2nd port either. There aren&#039;t many empty holes on that board if i remember right the ones i found for the 1st serial port were the only ones and honestly don&#039;t know if its the right way to hook it up or not i just know it works. This is all very new territory for me i haven&#039;t done electronics sense like 6th grade when i was building strobe lights and little audio amps out of kits and such. Then got my computer and all that stuff kinda feel behind but openwrt has sparked a old interest of working with stuff on more of a hardware level <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> So i thank them for that.</p><br /><p>ZeroPain</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71772">
				<div class="post-metadata">
					<div class="post-num">Post #33</div>
					<div class="post-author">dch24</div>
					<div class="post-datetime">
						5 Aug 2008, 01:59					</div>
				</div>
				<div class="post-content content">
					<p>Sure, I haven&#039;t done a patch or anything, so I&#039;ll be able to use one if you do one. Thanks!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71774">
				<div class="post-metadata">
					<div class="post-num">Post #34</div>
					<div class="post-author">dch24</div>
					<div class="post-datetime">
						5 Aug 2008, 02:22					</div>
				</div>
				<div class="post-content content">
					<p>I got openwrt running. <img src="https://forum.openwrt.org/img/smilies/cool.png" width="15" height="15" alt="cool" /> Thanks so much ZeroPain for the hints! Now I&#039;ll see what I can learn about flash mapping in 2.6.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71778">
				<div class="post-metadata">
					<div class="post-num">Post #35</div>
					<div class="post-author">ZeroPain</div>
					<div class="post-datetime">
						5 Aug 2008, 04:46					</div>
				</div>
				<div class="post-content content">
					<p>I had made a patch so you can control the leds but thats the only patch i have made for anything really. Its already been commited to the svn i believe and i think its still in there <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> wasn&#039;t anything major but made me happy.</p><p>In 2.4 i have a problem with it crashing when i try to use both wireless cards the kernel will panic at various points. I dunno whats different between the drivers being used in openwrt and the ones in dd-wrt but under dd-wrt you can get 260mbit connection over the 2.4 ghz anyways the 5.6ghz maxes out at 130 on there. But it doesn&#039;t crash. Just another one of the many things i&#039;m looking into</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71779">
				<div class="post-metadata">
					<div class="post-num">Post #36</div>
					<div class="post-author">ZeroPain</div>
					<div class="post-datetime">
						5 Aug 2008, 05:20					</div>
				</div>
				<div class="post-content content">
					<p>yeah i got no idea how i would go about adding it to openwrt system</p><p>I&#039;m sure it has something to do with the files in /tools/firmware-utils/src<br />and /usr/src/openwrt-brcm-2.4/target/linux/brcm-2.4/image/Makefile</p><p>But pretty sure its above my head for now</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71780">
				<div class="post-metadata">
					<div class="post-num">Post #37</div>
					<div class="post-author">napierzaza</div>
					<div class="post-datetime">
						5 Aug 2008, 06:45					</div>
				</div>
				<div class="post-content content">
					<p>Maybe ask the devs? They&#039;re busy now, but it&#039;s best to ask them, as they are probably specific as to how this stuff is folded in! Not to mention it&#039;d be great if this was included in 808!</p>											<p class="post-edited">(Last edited by <strong>napierzaza</strong> on 5 Aug 2008, 06:45)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71781">
				<div class="post-metadata">
					<div class="post-num">Post #38</div>
					<div class="post-author">dch24</div>
					<div class="post-datetime">
						5 Aug 2008, 09:45					</div>
				</div>
				<div class="post-content content">
					<p>Well, I can reproduce the 2.6 flash error:</p><div class="codebox"><pre><code>Physically mapped flash: Found 1 x16 devices at 0x0 in 16-bit bank              
 Amd/Fujitsu Extended Query Table at 0x0040                                     
  Unknown Amd/Fujitsu Extended Query version 0.0.                               
gen_probe: No supported Vendor Command Set found                                
Failed to do_map_probe</code></pre></div><p>When it is working in 2.4.35.4, it looks like this:</p><div class="codebox"><pre><code> Amd/Fujitsu Extended Query Table v0.0 at 0x0040
Physically mapped flash: JEDEC Device ID is 0xE2. Assuming broken CFI table.
Physically mapped flash: Swapping erase regions for broken CFI table.
number of CFI chips: 1
cfi_cmdset_0002: Disabling fast programming due to code brokenness.
Flash device: 0x800000 at 0x1c000000
bootloader size: 262144
Physically mapped flash: Filesystem type: squashfs, size=0x1a70fa
Updating TRX offsets and length:
old trx = [0x0000001c, 0x00000904, 0x0007f800], len=0x00241000 crc32=0x4ba6048f
new trx = [0x0000001c, 0x00000904, 0x0007f800], len=0x00230000 crc32=0xdc6bf58a
Done
Creating 5 MTD partitions on &quot;Physically mapped flash&quot;:
0x00000000-0x00040000 : &quot;cfe&quot;
0x00040000-0x007f0000 : &quot;linux&quot;
0x000bf800-0x00270000 : &quot;rootfs&quot;
mtd: partition &quot;rootfs&quot; doesn&#039;t start on an erase block boundary -- force read-y
0x007f0000-0x00800000 : &quot;nvram&quot;
0x00270000-0x007f0000 : &quot;rootfs_data&quot;</code></pre></div><p>I can&#039;t decide whether the 2.4 message is what I want 2.6 to do also or not.</p><p>If it were that simple, just get this file to work on the 2.6 kernel:<br />kamikaze/target/linux/generic-2.4/patches/005-mtd_flashtypes.patch</p><p>But obviously, I&#039;m still just a n00b so this might take some time to figure out.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71802">
				<div class="post-metadata">
					<div class="post-num">Post #39</div>
					<div class="post-author">ZeroPain</div>
					<div class="post-datetime">
						5 Aug 2008, 20:07					</div>
				</div>
				<div class="post-content content">
					<p>yeah but i think thats half the fun and why open source works <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> its all the figuring out we get to do and the feeling we get when we finally figure it out. Otherwise i would have just settled on using dd-wrt with optware or something. But i wanted to know and do more so here i am :-P</p><p>I&#039;m about to test out a few things i&#039;ll let you know what i come up with if anything works <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71868">
				<div class="post-metadata">
					<div class="post-num">Post #40</div>
					<div class="post-author">dch24</div>
					<div class="post-datetime">
						7 Aug 2008, 01:42					</div>
				</div>
				<div class="post-content content">
					<p>I did a little research, and the 2.6 kernel has the b43 driver in it (for broadcom wireless devices), but it doesn&#039;t support the bcm4329 or bcm432a. So even a 2.6 kernel would still use the same wl_mimo proprietary driver, and I don&#039;t even know if it works in a 2.6 kernel.</p><p>Here is a summary of the hardware and what works/doesn&#039;t work:</p><p><strong>CPU:</strong> 300 MHz bcm4785 rev 2 - working</p><p><strong>Flash:</strong> Samsung NOR Flash K8D6316ubm (I have the datasheet) - not supported by the 2.6.25 kernel mtd driver, but works fine in 2.4.35.</p><p><strong>CFE:</strong> version 1.0.37. Loads firmware via TFTP fine, but use the reverse-engineered code in this thread to add a trailer to the .trx, then TFTP it.</p><p><strong>package/broadcom-diag:</strong> ZeroPain, your patch is in, but has anyone tested whether it identifies the wrt600n v1 correctly? It identifies my wrt600n v1.1 correctly.</p><p><strong>Switch:</strong> bcm5397 GbE, using the bcm57xx driver. (But since Broadcom is discontinuing the bcm5397, the wrt600n may come with the bcm5395 in the future.) I&#039;ve tested the VLAN support, and it works. Linux 2.4.36.6 adds GemTek support for QoS, although that&#039;s not in the 2.4.35 in OpenWRT svn. robocfg does not have support for bcm539x.</p><p><strong>WiFi:</strong> Two radios, bcm4329 for 802.11bgn and bcm432a for 802.11an - supported in 2.4.35 using Broadcom proprietary wl_mimo driver. ZeroPain, are you still having speed/throughput problems? I&#039;ve verified at least that the bcm4329 for 802.11bgn can scan for APs in STA mode.</p><p><strong>LEDs:</strong> ZeroPain, your patch works great. Power LED can either blink or stay lit. eth port LEDs are green for 100 Mbit and amber for 1000 Mbit. USB LED is controllable (on or off), and the two WiFi encryption indicator LEDs (really four LEDs, a green and amber LED for each) are all independently controllable (on or off).</p><p><strong>USB:</strong> The bcm4785 has two USB device ports and one USB host port, but only a USB device port is connected up. I don&#039;t see how to get the USB modules included in the image (/lib/modules where they should be), but loading them from /tmp works fine.</p><p>Here are the USB modules to get, e.g. USB mass storage support and the vfat filesystem. I think ehci-hcd.o is part of USB 2.0. I&#039;m not sure -- it seems unused here but it might be a good idea anyway.</p><p>vfat.o&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;11340&nbsp; &nbsp;1<br />fat.o&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 34464&nbsp; &nbsp;0 [vfat.o]<br />usb-storage.o&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 69632&nbsp; &nbsp;1<br />sd_mod.o&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;12500&nbsp; &nbsp;2<br />scsi_mod.o&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;66048&nbsp; &nbsp;3 [usb-storage.o sd_mod.o]<br />ehci-hcd.o&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;20568&nbsp; &nbsp;0 (unused)<br />usb-ohci.o&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;19252&nbsp; &nbsp;0 (unused)<br />usbcore.o&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 71296&nbsp; &nbsp;0 [usb-storage.o ehci-hcd.o usb-ohci.o]</p>											<p class="post-edited">(Last edited by <strong>dch24</strong> on 7 Aug 2008, 10:02)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71913">
				<div class="post-metadata">
					<div class="post-num">Post #41</div>
					<div class="post-author">napierzaza</div>
					<div class="post-datetime">
						7 Aug 2008, 17:51					</div>
				</div>
				<div class="post-content content">
					<p>How much circuitry is missing for those two unwired ports? Does anyone have any photos of that area?</p>											<p class="post-edited">(Last edited by <strong>napierzaza</strong> on 7 Aug 2008, 17:52)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71927">
				<div class="post-metadata">
					<div class="post-num">Post #42</div>
					<div class="post-author">dch24</div>
					<div class="post-datetime">
						7 Aug 2008, 21:13					</div>
				</div>
				<div class="post-content content">
					<p>The pins on the processor are probably a BGA - under the processor on the PCB. The processor is covered with an EMI shield and a heatsink.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71936">
				<div class="post-metadata">
					<div class="post-num">Post #43</div>
					<div class="post-author">napierzaza</div>
					<div class="post-datetime">
						7 Aug 2008, 23:47					</div>
				</div>
				<div class="post-content content">
					<p>Yeah, but some times there are traces that go pretty close by the other port. I&#039;ve seen this with other routers.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71942">
				<div class="post-metadata">
					<div class="post-num">Post #44</div>
					<div class="post-author">dch24</div>
					<div class="post-datetime">
						8 Aug 2008, 03:07					</div>
				</div>
				<div class="post-content content">
					<p><strong>napierzaza:</strong> I&#039;ll see if I can find the second USB port. It&#039;s not hard to take the box apart (thanks, ZeroPain!)</p><p><strong>ZeroPain:</strong> Your problems with wireless might not be wireless. I don&#039;t know what causes it, exactly, but the router gets into a state where it drops more and more packets. It may be when the WAN is on a busy network (so lots of broadcasts?), it may be overheating, I don&#039;t know... But I&#039;m not using wireless at all and I&#039;m seeing DNS timing out, long downloads grind to a halt, etc.</p><p>More testing needed...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p71952">
				<div class="post-metadata">
					<div class="post-num">Post #45</div>
					<div class="post-author">ZeroPain</div>
					<div class="post-datetime">
						8 Aug 2008, 09:30					</div>
				</div>
				<div class="post-content content">
					<p>My wireless is the wireless I&#039;m not as&nbsp; worried about the speed as i am when i try to run both wireless cards with WPA2/AES i get a kernel panic. It seems to crash on other random things having to do with running both cards different encryption&#039;s and things but its very random to me. Sometimes it will work for a minute sometimes 30seconds. </p><p>I haven&#039;t been using mine as my main router its more of a access point with a usb port for the most part. I plan to make it my primary router once i a few more things are stabilized. But for just using the wired interface and usb running the 2.4 kernel its been quite stable for me even when i was using it as a router but my laptop does support wide band 2.4ghz and 5.6ghz. And i have moved things around in my house so its not as easy to always have a network jack near by so I&#039;m relying on it more over the wireless. Which was when i started trying to use the wireless more. I know the driver being used or the firmware openwrt is using is different then the one in the linksys firmware. I don&#039;t know what the changes are i just know the version numbers were off. </p><p>Openwrt svn trunk: Broadcom BCM%04x 802.11 Wireless Controller 4.150.10.5<br />its either for the 2.4.35.4 kernel or was compiled on the 2.4.35.4 kernel. i just know when i do a nano wl_mimo.o thats what i see.</p><p>Linksys wrt600n_v1.01.36.03 firmware: <br />Broadcom BCM%04x 802.11 Wireless Controller 4.158.4.0<br />its weird but the kernel version on this one is 2.4.20 which is the kernel running on that firmware.</p><p>That&#039;s why i figured there maybe something wrong on a driver level. Because the driver if i remember correctly in openwrt for the wl_mimo is from the wrt300n or wrt350n can&#039;t remember were i saw it to look it up again.</p><p>I get a decent speed though it its just i know its not registering 260 for me. But the driver should be able to do it for the 2.4ghz card at least because it came from a wrt300N which does 260mb i believe. so its probably just a matter of me figuring out how to tell it to use the wide band. I&#039;m sure its just a option I&#039;m missing.</p><p>From what i have been able to tell the only difference between the v1 and the v1.1 is the switch v1 is bcm5397 but v1.1 is bcm5395.<br />I may have that back words. I&#039;ll have to double check but if i remember right that&#039;s how i made the patch to detect the difference and i remember reading on dd-wrt&#039;s forums they do about the same thing. Has to be detected for settings up vlans according to them. the bcm5397 doesn&#039;t have a vlan0 or something to that effect. So on dd-wrt everything is shifted basically vlan0 is vlan1, vlan1 is vlan2 at least that&#039;s my understanding.</p><p>I don&#039;t really know that&#039;s just what i have been able to piece together and not so not any kind of expert when it comes to anything with hardware programming or the kernel really. Been a network/server admin and web programmer for a while but mostly just a jack of too many trades :-P</p><p>Form what i have read the broadcom driver from 2.4 could never be loaded in 2.6 its why there is a 2.4 still around broadcom is the only one left not supported in 2.6. At least that&#039;s what i gather</p><p>Oh did you notice during the pci init it also shows a IDE mass storage device just found that interesting.</p><p>Well i gotta get back to work and hopefully find some time to play with my wrt600n sometime. It&#039;s fun in some weird way</p><br /><br /><p>ZeroPain<br />-- Disclaimer --<br />It&#039;s not my fault if anything i have said causes your router to explode or anything as stated I&#039;m new to all this and honestly kinda surprised i haven&#039;t blown my up yet :-P</p>											<p class="post-edited">(Last edited by <strong>ZeroPain</strong> on 8 Aug 2008, 09:37)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p72018">
				<div class="post-metadata">
					<div class="post-num">Post #46</div>
					<div class="post-author">ZeroPain</div>
					<div class="post-datetime">
						9 Aug 2008, 11:34					</div>
				</div>
				<div class="post-content content">
					<p>Ok the wireless kernel panic seems to only be happening to me now when i enable the 5.6ghz card. Not sure if its a combination of both cards or just that one going to try to do some tests so i can provide more info.</p><div class="codebox"><pre><code>Data bus error, epc == c0132850, ra == c0132850
Oops in traps.c::do_be, line 385:
$0 : 00000000 1000fc00 c0130550 00000001 81880000 00000000 00002b05 81880c68
$8 : 81881d74 00000001 00000001 00000000 00000000 fffffff9 0000000a 00000000
$16: 81880000 c0218000 81880fa8 81880000 00000024 00000001 81880000 81880fa8
$24: 00000000 c0194718                   81dce000 81dcfa68 00000000 c0132850
Hi : 00000000
Lo : 00000000
epc   : c0132850    Tainted: P 
Status: 1000fc03
Cause : 0000001c
PrId  : 0002901a
Process nas (pid: 447, stackpage=81dce000)
Stack:    c018d580 00000001 81880000 c018d918 81880000 81880000 81880fa8
 81762000 c01a1558 00000004 81880000 81880fa8 81880fa8 81880000 81880fa8
 81880000 00000000 c01948d4 81762000 00000004 0000000a 801519cc 00000085
 81880fb0 00000000 81762000 0000001a 81880fb0 00000002 81762000 c015449c
 c01541cc c0077114 00000007 81dcfc20 c00770c0 81762000 00000004 00000000
 81880fb0 ...
Call Trace:   [&lt;c018d580&gt;] [&lt;c018d918&gt;] [&lt;c01a1558&gt;] [&lt;c01948d4&gt;] [&lt;801519cc&gt;]
 [&lt;c015449c&gt;] [&lt;c01541cc&gt;] [&lt;801421b8&gt;] [&lt;80141a78&gt;] [&lt;801418a8&gt;] [&lt;800023c8&gt;]
 [&lt;800023c8&gt;] [&lt;80021788&gt;] [&lt;801429c8&gt;] [&lt;801429a8&gt;] [&lt;801428bc&gt;] [&lt;c019b8b0&gt;]
 [&lt;80043524&gt;] [&lt;800284a0&gt;] [&lt;800d4204&gt;] [&lt;800d47e8&gt;] [&lt;8004e9c0&gt;] [&lt;800c9e00&gt;]
 [&lt;800c9fcc&gt;] [&lt;80049268&gt;] [&lt;800caaac&gt;] [&lt;80008a60&gt;] [&lt;8005bb0c&gt;]

Code: 24420550  0040f809  00809821 &lt;8e230120&gt; 2404ffff  10640025  00000000  8e220128  10440022 
Kernel panic: Aiee, killing interrupt handler!
In interrupt handler - not syncing
 &lt;0&gt;Rebooting in 3 seconds..Please stand by while rebooting the system...</code></pre></div><p>Looking back at this looks like its something to do with nas maybe if i pull nas out of the latest firmware from linksys it will be updated to handle whatever is causing this i dunno but i&#039;ll try it <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> and keep you posted</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p110191">
				<div class="post-metadata">
					<div class="post-num">Post #47</div>
					<div class="post-author">MaZe</div>
					<div class="post-datetime">
						30 May 2010, 12:17					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m curious to know what the current state of OpenWrt on the Linksys WRT600N V1.1 is?<br />Anyone care to enlighten me?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p134327">
				<div class="post-metadata">
					<div class="post-num">Post #48</div>
					<div class="post-author">ixix</div>
					<div class="post-datetime">
						29 Apr 2011, 23:30					</div>
				</div>
				<div class="post-content content">
					<p>Would someone please share the working image for WRT600N v1.1 (WRT600NV11)? I used mkimage on a few official trx files (e.g. <a href="http://downloads.openwrt.org/backfire/10.03.1-rc4/brcm-2.4/openwrt-brcm-2.4-squashfs.trx)">http://downloads.openwrt.org/backfire/1 â€¦ ashfs.trx)</a>, and tried to flash the generated bin using both tftp and linksys webgui, but it didn&#039;t work, it didn&#039;t respond to ping.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p136971">
				<div class="post-metadata">
					<div class="post-num">Post #49</div>
					<div class="post-author">MaZe</div>
					<div class="post-datetime">
						12 Jun 2011, 17:58					</div>
				</div>
				<div class="post-content content">
					<p>I haven&#039;t been able to get to a fully functioning image... the best I&#039;ve been able to get to is by using the &quot;brcm-2.4&quot; (ie. broadcom 2.4 kernel based) kamikaze 8.09.2 imagebuilder.&nbsp; I unfortunately don&#039;t have serial console on the box (and it&#039;s also currently on the other side of an ocean...).<br />I had no luck whatsoever with backfire.</p><p><a href="http://downloads.openwrt.org/kamikaze/8.09.2/brcm-2.4/OpenWrt-ImageBuilder-brcm-2.4-for-Linux-i686.tar.bz2">http://downloads.openwrt.org/kamikaze/8 â€¦ 86.tar.bz2</a></p><p>You need to convert the trx to broadcom format (if you want to flash via tftp), using:</p><div class="codebox"><pre><code>#include &lt;stdio.h&gt;
#include &lt;errno.h&gt;
#include &lt;string.h&gt;
#include &lt;stdint.h&gt;

#define IEEE_802_3_CRC 0xEDB88320
struct mkimage_trailer {
  char magic[4];
  uint32_t version;
  uint32_t PID;
  uint32_t filesize;
  uint32_t crc32;
  char padding[12];
};

void docrc(uint32_t * crc, unsigned char c)
{
  int i;
  *crc ^= c;
  for (i = 0; i &lt; 8; i++)
    if (*crc &amp; 1) *crc = (*crc &gt;&gt; 1) ^ IEEE_802_3_CRC;
    else *crc &gt;&gt;= 1;
}

int do_trailer(FILE * fin, FILE * fout, const char * nin, const char * nout)
{
  int i;
  struct mkimage_trailer t;
  memset(&amp;t, 0, sizeof(t));
  uint32_t crc = (uint32_t) -1;
  while (!feof(fin)) {
    char c;
    if (fread(&amp;c, 1, 1, fin) != 1) {
      if (feof(fin)) break;
      fprintf(stderr, &quot;\&quot;%s\&quot; read err %d\n&quot;, nin, errno);
      return 1;
    }
    docrc(&amp;crc, c);
    t.filesize++;
    if (fwrite(&amp;c, 1, 1, fout) != 1) {
      fprintf(stderr, &quot;\&quot;%s\&quot;: write err %d\n&quot;, nout, errno);
      return 1;
    }
  }
  strncpy(t.magic, &quot;GMTK&quot;, sizeof(t.magic));
  t.version = 1;
  t.filesize += sizeof(t);
  t.PID = 0x1020001lu;
  // note: we compute the CRC of everything, including t.crc32 (= 0 now)
  for (i = 0; i &lt; (int) sizeof(t); i++) docrc(&amp;crc, ((char *) &amp;t)[i]);
  t.crc32 = crc ^ (uint32_t) -1;    // IEEE 802.3 CRC requires a final XOR
  if (fwrite(&amp;t, 1, sizeof(t), fout) != sizeof(t)) {
    fprintf(stderr, &quot;\&quot;%s\&quot; trailer write err: %d\n&quot;, nout, errno);
    return 1;
  }
  return 0;
}

int main (int argc, char ** argv)
{
  if (argc != 2) {
    fprintf(stderr, &quot;Usage: %s filename\n&quot;, argv[0]);
    return 1;
  }
  const char * nout = &quot;Trailed_LINKSYS_WRTB193N_1.01.36 build 3_US.bin&quot;;
  FILE * fin = fopen(argv[1], &quot;rb&quot;), * fout = fopen(nout, &quot;wb&quot;);
  if (!fin) {
    fprintf(stderr, &quot;Failed to open \&quot;%s\&quot; for reading\n&quot;, argv[1]);
    return 1;
  }
  if (!fout) {
    fprintf(stderr, &quot;Failed to open \&quot;%s\&quot; for writing\n&quot;, nout);
    fclose(fin);
    return 1;
  }
  if (do_trailer(fin, fout, argv[1], nout)) {
    fclose(fin);
    fclose(fout);
    return 1;
  }
  fclose(fin);
  fclose(fout);
  return 0;
}</code></pre></div><p>I can get functioning wired networking + one functioning wifi device (not sure about stability).<br />Getting wired networking up requires overriding the network config file so it has a proper vlan configuration.<br />I believe as soon as you enable the second wifi, you get a kernel crash or something bad happens.</p><p>ie. /etc/config/network in the built image (straight on the root file system) has to contain something along the lines of (single vlan config - no wan port) - I believe the important point is to not use &#039;vlan0&#039; (doesn&#039;t work?) and that the cpu is port 8 (not 5), while the remaining ports are 0-4 (I think wan is 4, but can&#039;t remember).</p><div class="codebox"><pre><code>#### VLAN configuration
config switch eth0
        option vlan1    &quot;0 1 2 3 4 8&quot;
        option vlan2    &quot;8*&quot;


#### Loopback configuration
config interface loopback
        option ifname   &quot;lo&quot;
        option proto    static
        option ipaddr   127.0.0.1
        option netmask  255.0.0.0


#### LAN configuration
config interface lan
        option type     bridge
        option ifname   &quot;eth0.1&quot;
        option proto    static
        option ipaddr   10.0.0.200
        option netmask  255.255.255.0
        option gateway  10.0.0.1
        option dns      &quot;10.0.0.1 8.8.8.8 8.8.4.4&quot;</code></pre></div><p>While /etc/config/wireless in the built image could contain:<br /></p><div class="codebox"><pre><code>config wifi-device  wl0
        option type     broadcom
        option channel  5

config wifi-iface
        option device   wl0
        option network  lan
        option mode     ap
        option ssid     SSID
        option hidden   0
        option isolate  0
        option encryption psk2
        option key      KEY</code></pre></div>											<p class="post-edited">(Last edited by <strong>MaZe</strong> on 12 Jun 2011, 18:00)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p136972">
				<div class="post-metadata">
					<div class="post-num">Post #50</div>
					<div class="post-author">MaZe</div>
					<div class="post-datetime">
						12 Jun 2011, 18:11					</div>
				</div>
				<div class="post-content content">
					<p>Once you extract the image builder, and create a new empty directory ${ROOTFS_OVERRIDE}, and put /etc/config/network in at ${ROOTFS_OVERRIDE}/etc/config/network (etc for wireless) you should be able to build via:</p><p>PACKAGES=&#039;kmod-brcm-wl-mimo wlc nas kmod-wlcompat kmod-brcm-57xx kmod-brcm-57xx ip&#039;</p><p>(adding &#039;kmod-usb-core kmod-usb-ohci kmod-usb2&#039; above might be the beginning of usb support)</p><p>make image PROFILE=None PACKAGES=&quot;${PACKAGES}&quot; FILES=&quot;${ROOTFS_OVERRIDE}&quot;</p><p>which should generate a &quot;bin/openwrt-brcm-2.4-squashfs.trx&quot; file.</p><p>Once you have a bin file (generated from the trx with the above program), you should be able to flash it via:</p><div class="codebox"><pre><code>DEV=eth0
sudo ip addr add 192.168.1.2/16 broadcast + dev &quot;${DEV}&quot;
tftp -4 -v -l -m binary 192.168.1.1 -c put &#039;Trailed_LINKSYS_WRTB193N_1.01.36 build 3_US.bin&#039;
# now you powercycle the WRT600N v1.1
sudo ip addr del 192.168.1.2/16 broadcast + dev &quot;${DEV}&quot;</code></pre></div><p>(and now you cross your fingers and pray...)</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 2 of 2</div><nav><ul><li><a href="viewtopic.php%3Fid=15960&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>