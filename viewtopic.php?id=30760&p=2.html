<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> ALL-U-NEED Ad Blocking by YAQUI - Does it work with OpenWRT</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 22 Apr 2018 and 30 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 2 of 3</div><nav><ul><li><a href="viewtopic.php%3Fid=30760&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=30760&amp;p=3.html">3</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p138677">
				<div class="post-metadata">
					<div class="post-num">Post #26</div>
					<div class="post-author">rgranados80</div>
					<div class="post-datetime">
						8 Jul 2011, 00:34					</div>
				</div>
				<div class="post-content content">
					<p>drwxr-xr-x&nbsp; &nbsp; 2 root&nbsp; &nbsp; &nbsp;root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 Jun 28 21:48 dns</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138682">
				<div class="post-metadata">
					<div class="post-num">Post #27</div>
					<div class="post-author">KingJL</div>
					<div class="post-datetime">
						8 Jul 2011, 01:03					</div>
				</div>
				<div class="post-content content">
					<p>rgranados80:<br />run the set command with no parameters to see the busybox envirionment.&nbsp; Here is what mine looks like:</p><div class="codebox"><pre><code>root@OpenWrt:/etc# set
HOME=&#039;/root&#039;
IFS=&#039;
&#039;
LOGNAME=&#039;root&#039;
OLDPWD=&#039;/sbin&#039;
OPTIND=&#039;1&#039;
PATH=&#039;/bin:/sbin:/usr/bin:/usr/sbin&#039;
PPID=&#039;4301&#039;
PS1=&#039;\u@\h:\w\$ &#039;
PS2=&#039;&gt; &#039;
PS4=&#039;+ &#039;
PWD=&#039;/etc&#039;
SHELL=&#039;/bin/ash&#039;
SSH_CONNECTION=&#039;192.168.68.144 1052 192.168.68.1 22&#039;
SSH_TTY=&#039;/dev/pts/0&#039;
TERM=&#039;xterm&#039;
USER=&#039;root&#039;
_=&#039;-l&#039;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138683">
				<div class="post-metadata">
					<div class="post-num">Post #28</div>
					<div class="post-author">rgranados80</div>
					<div class="post-datetime">
						8 Jul 2011, 01:10					</div>
				</div>
				<div class="post-content content">
					<p>There appears to be only one difference at the very end and it is for a variable I&#039;m not familiar with at all.</p><div class="codebox"><pre><code>root@OpenWrt:/etc# set
HOME=&#039;/root&#039;
IFS=&#039;     
&#039;
LOGNAME=&#039;root&#039;
OLDPWD=&#039;/root&#039;
OPTIND=&#039;1&#039;
PATH=&#039;/bin:/sbin:/usr/bin:/usr/sbin&#039;
PPID=&#039;1988&#039;
PS1=&#039;\u@\h:\w\$ &#039;
PS2=&#039;&gt; &#039;
PS4=&#039;+ &#039;
PWD=&#039;/etc&#039;
SHELL=&#039;/bin/ash&#039;
SSH_CONNECTION=&#039;206.54.145.254 26179 67.190.222.79 443&#039;
SSH_TTY=&#039;/dev/pts/0&#039;
TERM=&#039;xterm&#039;
USER=&#039;root&#039;
_=&#039;clear&#039;
root@OpenWrt:/etc#</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138684">
				<div class="post-metadata">
					<div class="post-num">Post #29</div>
					<div class="post-author">KingJL</div>
					<div class="post-datetime">
						8 Jul 2011, 01:24					</div>
				</div>
				<div class="post-content content">
					<p>The only other thing that I can think of is that there was corruption of the disable_adds.sh file that was put on the router.&nbsp; How did you transfer it to the router?&nbsp; I used winScp.&nbsp; If some how the file gets corrupted so that un-printable characters were inserted, then that could cause all symptoms.&nbsp; If the shell cannot read/interperet (correctly) the &quot;#!/bin/sh&quot; it will not execute the file and issue a &quot;not found&quot; error message.&nbsp; I think we need to verify the state of the script file.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138689">
				<div class="post-metadata">
					<div class="post-num">Post #30</div>
					<div class="post-author">rgranados80</div>
					<div class="post-datetime">
						8 Jul 2011, 03:03					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>The only other thing that I can think of is that there was corruption of the disable_adds.sh file that was put on the router.&nbsp; How did you transfer it to the router?&nbsp; I used winScp.&nbsp; If some how the file gets corrupted so that un-printable characters were inserted, then that could cause all symptoms.&nbsp; If the shell cannot read/interperet (correctly) the &quot;#!/bin/sh&quot; it will not execute the file and issue a &quot;not found&quot; error message.&nbsp; I think we need to verify the state of the script file.</p></blockquote></div><p>Sorry for the delayed response KingJL. The file was transferred using scp command from a terminal. I don&#039;t have the commands but the responses of those commands appeared to indicate a successful transmission of the file. I was doing this remotely though as opposed to locally on the network. (Not sure if that really makes a difference)</p><p>Since the files really don&#039;t change -- I&#039;ll re-upload them now and report back what happens.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138692">
				<div class="post-metadata">
					<div class="post-num">Post #31</div>
					<div class="post-author">rgranados80</div>
					<div class="post-datetime">
						8 Jul 2011, 04:31					</div>
				</div>
				<div class="post-content content">
					<p>So here&#039;s the situation now... <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I took what KingJL said into consideration regarding the file being corrupt and re-uploaded the file. The same result occurred when I tried to run the script so I opted to try and see if I could find anything about the &quot;exact&quot; message it was returning when I did run the script.</p><p>I was led to a &quot;How-To-Geek&quot; post regarding the very same thing I&#039;m trying to execute to now.</p><p>This user had the same error I was experiencing. <a href="http://www.howtogeek.com/51477/how-to-remove-advertisements-with-pixelserv-on-dd-wrt/#comment-122445">Link Here</a></p><p>This user brought up &quot;EXACTLY&quot; how I had transferred the file (scp) and how that will mess with the file. So he indicated it was best to paste the script into the SSH session while working within vi. <a href="http://www.howtogeek.com/51477/how-to-remove-advertisements-with-pixelserv-on-dd-wrt/#comment-122445">Link Here</a></p><p>I managed to get that completed and re-applied the the permissions and attributes the script and pixelserv files.</p><p>Viola! The script ran!</p><p>It came back with errors though. <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> (and some bad consequences)</p><div class="codebox"><pre><code>root@OpenWrt:/etc/dns# ./disable_add.sh 
ad_blocker_script: ###########Ads blocker ed###########
ad_blocker_script: Sleeping for 30 secs to give time for router boot
ad_blocker_script: New IP and ports setup
ad_blocker_script: Adding a refresh cycle by puting the script in cron if it isnt there yet
ad_blocker_script: The script is already in cron
ad_blocker_script: Redirect setup &amp; Appending to the FW script
ad_blocker_script: did NOT find an active redirect rule with the iptable command, injecting it now.
ad_blocker_script: Starting or ReSpawning pixelsrv
ad_blocker_script: it seems that the pixelserv isnt up. starting it now
pixelserv[4430]: /etc/dns/pixelserv V22 compiled: Dec  8 2010 14:58:16 from pixelserv22.c
ad_blocker_script: Get the online lists
date: can&#039;t stat &#039;/etc/dns/dlhosts&#039;: No such file or directory
date: can&#039;t stat &#039;/etc/dns/adblock.conf&#039;: No such file or directory
expr: syntax error
expr: syntax error
sh: -o: bad number
ad_blocker_script: The lists are less then 3 days old, saving on flash erosion and NOT refreshing them
ad_blocker_script: Removing whitelist from the personal file
ad_blocker_script: Refreshing DNS settings

dnsmasq: cannot read /etc/dns/adblock.conf: No such file or directory
ad_blocker_script: ##########The Ads blocker script has finished its run and you should up and running##########
root@OpenWrt:/etc/dns# ls
disable_add.sh          personal-ads-list.conf  pixelserv               whitelist
root@OpenWrt:/etc/dns#</code></pre></div><p>As can be seen from the &quot;ls&quot; command at the end -- some of the files were created as the script indicated it would -- but not all of them.</p><p>I figured &quot;no harm&quot; -- just reboot the router and all will be fine. Well it appears that the script makes some changes to the overall router and some settings stuck and are currently not allowing me access to the internet from my router. <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> (using my Droid X right now as a wireless access point) <img src="https://forum.openwrt.org/img/smilies/tongue.png" width="15" height="15" alt="tongue" /></p><p>From my computer that is wired to the router -- I have no internet but I can ping google.com and other sites.</p><p>From my laptop that is wireless to the router -- I cannot even establish a connection.</p><p>I am maintaining a positive attitude though... because that&#039;s all part of learning right? <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>My theory for my wired connection regarding the script is that it makes some &quot;iptable&quot; changes that effects the firewall, but I am definitely not versed in making those kinds of commands yet since I do almost all of my changes within Luci. I&#039;m assuming there is something that the script didn&#039;t get to complete and packets are just falling off somewhere.</p><p>What I can&#039;t explain is why my laptop cannot get an address wirelessly on the router though?</p><p>Again -- any and all help will be appreciated.</p><p>Thanks in advance. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138693">
				<div class="post-metadata">
					<div class="post-num">Post #32</div>
					<div class="post-author">rgranados80</div>
					<div class="post-datetime">
						8 Jul 2011, 04:52					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>rgranados80 wrote:</cite><blockquote><p>From my computer that is wired to the router -- I have no internet <strong>but I can ping google.com and other sites.</strong></p></blockquote></div><p>That wasn&#039;t entirely true.</p><p>From my PC I am unable to access the internet OR ping any outside DNS.</p><p>From an SSH connection to my router -- I CAN ping any outside DNS.</p><p>Pardon my mistake there.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138695">
				<div class="post-metadata">
					<div class="post-num">Post #33</div>
					<div class="post-author">KingJL</div>
					<div class="post-datetime">
						8 Jul 2011, 05:11					</div>
				</div>
				<div class="post-content content">
					<p>There is always &#039;failsafe&#039; that will let you telnet into the router at the default ip address.&nbsp; Once in in failsafe, you can run &#039;firstboot&#039; to restore all settings to the installed default.&nbsp; After running &#039;firstboot&#039; wait unti the router reboots or 15 minutes to be safe.&nbsp; On reboot telnet in and set passwd (all steps you originally took).&nbsp; </p><p>I have modified the script to take care of the errors that occurred because the files that bdid not exist and gave the &#039;stat&#039; errors that in turn resulted in the &#039;expr&#039; errors (I had original files already in place, just out of date).&nbsp; When these errors occurred, the conditional block was never executed to create the 2 main adblock files.&nbsp; Not sure what happened to cause you not to be able to get in.&nbsp; Did you ensure that the correct interface was br-lan?</p><p>New script:<br /></p><div class="codebox"><pre><code>#!/bin/sh
########Debug commands for terminal############
#echo &quot;alias mem=&#039;cat /proc/meminfo&#039;&quot; &gt;&gt;/tmp/root/.profile
#echo &quot;alias ll=&#039;ls -lash --color=auto&#039;&quot; &gt;&gt;/tmp/root/.profile
#echo &quot;alias ls=&#039;ls --color=auto&#039;&quot; &gt;&gt;/tmp/root/.profile
#echo &quot;alias tlog=&#039;tail -f /var/log/messages&#039;&quot; &gt;&gt;/tmp/root/.profile
#echo &quot;alias clog=&#039;cat /var/log/messages | grep local0.notice&#039;&quot; &gt;&gt;/tmp/root/.profile
########Functions setup#########################
logger_ads()
{
logger -s -p local0.notice -t ad_blocker_script $1
}
 
##################################################

logger_ads &quot;###########Ads blocker ed###########&quot;

if [[ -z &quot;$1&quot; ]]; then
    logger_ads &quot;Sleeping for 30 secs to give time for router boot&quot;
    sleep 30
else
    logger_ads &quot;override switch given&quot;
    [[ $1 = &quot;-h&quot; || $1 = &quot;/?&quot; ]] &amp;&amp; echo &quot;use -m to override the 30 seconds delay and -f to force a list refresh&quot; &amp;&amp; exit 0    
    [ $1 = &quot;-f&quot; ] &amp;&amp; rm /etc/dns/adblock.conf &amp;&amp; rm /etc/dns/dlhosts
fi

# while ! ping www.google.com -c 1 &gt; /dev/null ; do
# use wget for thos instances where the host network prevents pings
while ! wget http://www.google.com -O /dev/null 2&gt;/dev/null ; do
    logger_ads &quot;waiting for the internet connection to come up&quot;
    sleep 5
done
 
logger_ads &quot;New IP and ports setup&quot;
pixel=&quot;`ifconfig br-lan | grep inet | awk &#039;{ print $3 }&#039; | awk -F &quot;:&quot; &#039;{ print $2 }&#039; | cut -d . -f 1,2,3`.254&quot;
/sbin/ifconfig br-lan:1 $pixel
#/sbin/ifconfig br-lan:1 $pixel netmask &quot;`ifconfig br-lan | grep inet | awk &#039;{ print $4 }&#039; | awk -F &quot;:&quot; &#039;{ print $2 }&#039;`&quot; broadcast &quot;`ifconfig br-lan | grep inet | awk &#039;{ print $3 }&#039; | awk -F &quot;:&quot; &#039;{ print $2 }&#039;`&quot; up
 
logger_ads &quot;Adding a refresh cycle by puting the script in cron if it isnt there yet&quot;
if [[ -z &quot;`cat /etc/crontabs/root | grep &quot;/etc/dns/disable_adds.sh&quot;`&quot; ]] ; then
    echo &#039;0 0 * * * \t/etc/dns/disable_adds.sh -m&#039; &gt;&gt; /etc/crontabs/root
    /etc/init.d/cron restart &amp;&amp; logger_ads &quot;restarted the cron service&quot;
else
    logger_ads &quot;The script is already in cron&quot;
fi

logger_ads &quot;Redirect setup &amp; Appending to the FW script&quot;
#[[ -z &quot;`iptables -L -n -t nat | grep ${pixel} | grep 88`&quot; ]] &amp;&amp; logger_ads &quot;did NOT find an active redirect rule with the iptable command, injecting it now.&quot; &amp;&amp; /usr/sbin/iptables -t nat -I PREROUTING -p tcp -d ${pixel} --dport 80 -j REDIRECT --to-ports 88
[[ -z &quot;`iptables -L -n -t nat | grep ${pixel} | grep 88`&quot; ]] &amp;&amp; logger_ads &quot;did NOT find an active redirect rule with the iptable command, injecting it now.&quot; &amp;&amp; /usr/sbin/iptables -t nat -I PREROUTING 1 -d ${pixel} -p tcp --dport 80 -j DNAT --to ${pixel}:88

 
logger_ads &quot;Starting or ReSpawning pixelsrv&quot;
if [[ -n &quot;`ps | grep -v grep | grep /etc/dns/pixelserv`&quot; ]]
then
logger_ads &quot;the pixelserv is already up&quot;
else
logger_ads &quot;it seems that the pixelserv isnt up. starting it now&quot;
/etc/dns/pixelserv $pixel -p 88
fi

logger_ads &quot;Get the online lists&quot;
tdhl=0
tadblk=0
tnow=`date +%s`
[ -e /etc/dns/dlhosts ] &amp;&amp; tdlh=`date +%s -r /etc/dns/dlhosts`
[ -e /etc/dns/adblock.conf ] &amp;&amp; tadblk=`date +%s -r /etc/dns/adblock.conf`
tdlh=`expr $tdlh + 86400`
tadblk=`expr $tadblk + 86400`

[ ! -e /etc/dns/whitelist ] &amp;&amp; echo google-analytics &gt; /etc/dns/whitelist &amp;&amp; echo googleadservices &gt;&gt; /etc/dns/whitelist
if [[ $tnow -ge $tdlh || $tnow -ge $tadblk || ! -e /etc/dns/dlhosts || ! -e /etc/dns/adblock.conf ]]; then
    logger_ads &quot;The lists are NOT setup at all yet, or more then 3 days old. will now retrieve them from the web&quot;
    logger_ads &quot;Retrieving the MVPS hosts list&quot;
    wget -q -O - http://www.mvps.org/winhelp2002/hosts.txt | grep &quot;^127.0.0.1&quot; | grep -v localhost | tr -d &#039;\015&#039; &gt;/tmp/dlhosts.tmp
    logger_ads &quot;adjusting the MVPS hosts list for our use&quot;
    cat /etc/dns/whitelist | while read line; do sed -i /${line}/d /tmp/dlhosts.tmp ; done
    sed -i s/127.0.0.1/$pixel/g /tmp/dlhosts.tmp
    logger_ads &quot;done adjusting the MVPS hosts list use&quot;
    logger_ads &quot;retrieving the Yoyo domain list&quot;
    wget -q &quot;http://pgl.yoyo.org/adservers/serverlist.php?hostformat=dnsmasq&amp;showintro=0&amp;mimetype=plaintext&quot; -O /tmp/adblock.tmp
    logger_ads &quot;adjusting the Yoyo domain list for our use&quot;
    cat /etc/dns/whitelist | while read line; do sed -i /${line}/d /tmp/adblock.tmp ; done
    sed -i s/127.0.0.1/$pixel/g /tmp/adblock.tmp
    logger_ads &quot;Moving the Yoyo list to etc&quot;
    mv /tmp/adblock.tmp /etc/dns/adblock.conf
    logger_ads &quot;Moving the MVPS hosts list to etc&quot;
    mv /tmp/dlhosts.tmp /etc/dns/dlhosts

else
    logger_ads &quot;The lists are less then 3 days old, saving on flash erosion and NOT refreshing them&quot;
fi
 
logger_ads &quot;Removing whitelist from the personal file&quot;
[ ! -e /etc/dns/personal-ads-list.conf ] &amp;&amp; touch /etc/dns/personal-ads-list.conf
cat /etc/dns/whitelist | while read line; do sed -i /${line}/d /etc/dns/personal-ads-list.conf ; done

# Replace the adblock stuff in the &quot;dnsmasq.conf&quot; file.
sed  -i &quot;/^#BEGIN--adblock-custom/,/^#END--adblock-custom/d&quot; /etc/dnsmasq.conf
echo &quot;#BEGIN--adblock-custom&quot; &gt;&gt;/etc/dnsmasq.conf
echo &quot;conf-file=/etc/dns/adblock.conf&quot; &gt;&gt;/etc/dnsmasq.conf
echo &quot;addn-hosts=/etc/dns/dlhosts&quot; &gt;&gt;/etc/dnsmasq.conf
echo &quot;conf-file=/etc/dns/personal-ads-list.conf&quot; &gt;&gt; /etc/dnsmasq.conf
echo &quot;#END--adblock-custom&quot; &gt;&gt;/etc/dnsmasq.conf

logger_ads &quot;Refreshing DNS settings&quot;
/etc/init.d/dnsmasq restart &amp;&amp; logger_ads &quot;restarted the dnsmasq service&quot;

logger_ads &quot;##########The Ads blocker script has finished its run and you should up and running##########&quot;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138697">
				<div class="post-metadata">
					<div class="post-num">Post #34</div>
					<div class="post-author">KingJL</div>
					<div class="post-datetime">
						8 Jul 2011, 05:42					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>rgranados80 wrote:</cite><blockquote><div class="quotebox"><cite>rgranados80 wrote:</cite><blockquote><p>From my computer that is wired to the router -- I have no internet <strong>but I can ping google.com and other sites.</strong></p></blockquote></div><p>That wasn&#039;t entirely true.</p><p>From my PC I am unable to access the internet OR ping any outside DNS.</p><p>From an SSH connection to my router -- I CAN ping any outside DNS.</p><p>Pardon my mistake there.</p></blockquote></div><p>get in with ssh.<br />use vi to edit the dnsmasq.conf<br />delete the lines:</p><div class="codebox"><pre><code>#BEGIN--adblock-custom
conf-file=/etc/dns/adblock.conf
addn-hosts=/etc/dns/dlhosts
conf-file=/etc/dns/personal-ads-list.conf
#END--adblock-custom</code></pre></div><p>save and exit the file<br />use vi to edit the /etc/crontabs/root file<br />delete the line:<br />0 0 * * *&nbsp; &nbsp; &nbsp; &nbsp;/etc/dns/disable_adds.sh -m<br />save and exit the file</p><p>in the /etc/dns directory delete the adblock.conf, dlhosts, personal-ads-list.conf, whitelist</p><p>reboot and see if you can get in... you should be back to pre script configuration.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138698">
				<div class="post-metadata">
					<div class="post-num">Post #35</div>
					<div class="post-author">KingJL</div>
					<div class="post-datetime">
						8 Jul 2011, 05:52					</div>
				</div>
				<div class="post-content content">
					<p>Note: Using WinSCP, I have never had a corrupted file transfer.&nbsp; With the corruption that occurred with the script would make me wonder the condition of the binary.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138700">
				<div class="post-metadata">
					<div class="post-num">Post #36</div>
					<div class="post-author">rgranados80</div>
					<div class="post-datetime">
						8 Jul 2011, 05:57					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>There is always &#039;failsafe&#039; that will let you telnet into the router at the default ip address.&nbsp; Once in in failsafe, you can run &#039;firstboot&#039; to restore all settings to the installed default.&nbsp; After running &#039;firstboot&#039; wait unti the router reboots or 15 minutes to be safe.&nbsp; On reboot telnet in and set passwd (all steps you originally took).</p></blockquote></div><p>I can get into the router still via SSH. I&#039;ve noticed that DHCP wasn&#039;t working correctly but with a static IP address I am able to communicate with the router. If I take the route of initiating the &quot;firstboot&quot; command -- will I lose all of my configurations and installed modules?&nbsp; </p><br /><div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>I have modified the script to take care of the errors that occurred because the files that bdid not exist and gave the &#039;stat&#039; errors that in turn resulted in the &#039;expr&#039; errors (I had original files already in place, just out of date).&nbsp; When these errors occurred, the conditional block was never executed to create the 2 main adblock files.&nbsp; Not sure what happened to cause you not to be able to get in.</p></blockquote></div><p>Does this mean I should make dummy files within the directory so that the script sees something at least? Or has the script changed in a way that it creates dummies in advance and then inserts information into them?</p><p>Also -- I want to confirm before doing anything &quot;firstboot&quot; commands -- that when you say, &quot;cause you not to be able to get in.&quot; -- that you mean not at all? I am still able to SSH into the router and once logged into it, I can ping out to google.com and other websites. Functional... just seems that DNSMASQ has seen better days! <img src="https://forum.openwrt.org/img/smilies/tongue.png" width="15" height="15" alt="tongue" /></p><div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>Did you ensure that the correct interface was br-lan?</p></blockquote></div><p>Yep -- I made sure of that when I first started reading the beginning of the script and the interface is called exactly the same as the script needs.</p><br /><br /><div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>logger_ads &quot;Adding a refresh cycle by puting the script in cron if it isnt there yet&quot;<br />if [[ -z &quot;`cat /etc/crontabs/root | grep &quot;/etc/dns/disable_adds.sh&quot;`&quot; ]] ; then<br /><strong>&nbsp; &nbsp; echo &#039;0 0 * * * \t/etc/dns/disable_adds.sh -m&#039; &gt;&gt; /etc/crontabs/root</strong><br />&nbsp; &nbsp; /etc/init.d/cron restart &amp;&amp; logger_ads &quot;restarted the cron service&quot;<br />else<br />&nbsp; &nbsp; logger_ads &quot;The script is already in cron&quot;<br />fi</p></blockquote></div><p>This information below is what I had in your original e-mail to me and I wanted to make sure that the script above was correct or if there was a typo?</p><p><span style="color: blue">logger_ads &quot;Adding a refresh cycle by puting the script in cron if it isnt there yet&quot;<br />if [[ -z &quot;`cat /etc/crontabs/root | grep &quot;/etc/dns/disable_adds.sh&quot;`&quot; ]] ; then<br /><strong>&nbsp; &nbsp; echo &#039;0 0 * * * root /etc/dns/disable_adds.sh -m&#039; &gt;&gt; /etc/crontabs/root</strong><br />&nbsp; &nbsp; /etc/init.d/cron restart &amp;&amp; logger_ads &quot;restarted the cron service&quot;<br />else<br />&nbsp; &nbsp; logger_ads &quot;The script is already in cron&quot;<br />fi</span></p><br /><br /><div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>logger_ads &quot;Redirect setup &amp; Appending to the FW script&quot;<br />#[[ -z &quot;`iptables -L -n -t nat | grep ${pixel} | grep 88`&quot; ]] &amp;&amp; logger_ads &quot;did NOT find an active redirect rule with the iptable command, injecting it now.&quot; &amp;&amp; /usr/sbin/iptables -t nat -I PREROUTING -p tcp -d ${pixel} --dport 80 -j REDIRECT --to-ports 88<br />[[ -z &quot;`iptables -L -n -t nat | grep ${pixel} | grep 88`&quot; ]] &amp;&amp; logger_ads &quot;did NOT find an active redirect rule with the iptable command, injecting it now.&quot; &amp;&amp; /usr/sbin/iptables -t nat -I PREROUTING 1 -d ${pixel} -p tcp --dport 80 -j DNAT --to ${pixel}:88</p></blockquote></div><p>Was the syntax wrong? Curious because I&#039;m trying to learn all the different parts of the script and what it does.</p><br /><div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>logger_ads &quot;Get the online lists&quot;<br />tdhl=0<br />tadblk=0<br />tnow=`date +%s`<br />[ -e /etc/dns/dlhosts ] &amp;&amp; tdlh=`date +%s -r /etc/dns/dlhosts`<br />[ -e /etc/dns/adblock.conf ] &amp;&amp; tadblk=`date +%s -r /etc/dns/adblock.conf`<br />tdlh=`expr $tdlh + 86400`<br />tadblk=`expr $tadblk + 86400`</p></blockquote></div><p>Curious if this is possibly the dummy file creation if the /etc/dns/ path doesn&#039;t have the dlhost &amp; adblock.conf files. Below is the original.</p><p><span style="color: blue"><br />logger_ads &quot;Get the online lists&quot;<br />tnow=`date +%s`<br />tdlh=`date +%s -r /etc/dns/dlhosts`<br />tadblk=`date +%s -r /etc/dns/adblock.conf`<br />tdlh=`expr $tdlh + 86400`<br />tadblk=`expr $tadblk + 86400`<br /></span></p><br /><br /><p>I&#039;d really hate to lose what I&#039;ve gotten configured -- but I will if I have to. I&#039;m curious if there is any way to recover the DNSMASQ or other daemon service configurations to allow for the router to work again and just rerun the script with your changes?</p><br /><p>I&#039;ll start working on whatever fix once I&#039;ve confirmed I&#039;m not assuming anything. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Thanks again KingJL!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138701">
				<div class="post-metadata">
					<div class="post-num">Post #37</div>
					<div class="post-author">KingJL</div>
					<div class="post-datetime">
						8 Jul 2011, 06:16					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>rgranados80 wrote:</cite><blockquote><div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>There is always &#039;failsafe&#039; that will let you telnet into the router at the default ip address.&nbsp; Once in in failsafe, you can run &#039;firstboot&#039; to restore all settings to the installed default.&nbsp; After running &#039;firstboot&#039; wait unti the router reboots or 15 minutes to be safe.&nbsp; On reboot telnet in and set passwd (all steps you originally took).</p></blockquote></div><p>I can get into the router still via SSH. I&#039;ve noticed that DHCP wasn&#039;t working correctly but with a static IP address I am able to communicate with the router. If I take the route of initiating the &quot;firstboot&quot; command -- will I lose all of my configurations and installed modules?</p></blockquote></div><p>Probably.&nbsp; firstboot restore to the original installed image.</p><div class="quotebox"><blockquote><div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>I have modified the script to take care of the errors that occurred because the files that bdid not exist and gave the &#039;stat&#039; errors that in turn resulted in the &#039;expr&#039; errors (I had original files already in place, just out of date).&nbsp; When these errors occurred, the conditional block was never executed to create the 2 main adblock files.&nbsp; Not sure what happened to cause you not to be able to get in.</p></blockquote></div><p>Does this mean I should make dummy files within the directory so that the script sees something at least? Or has the script changed in a way that it creates dummies in advance and then inserts information into them?</p></blockquote></div><p>No need the modified script now allows for the non-existence of these files</p><div class="quotebox"><blockquote><p>Also -- I want to confirm before doing anything &quot;firstboot&quot; commands -- that when you say, &quot;cause you not to be able to get in.&quot; -- that you mean not at all? I am still able to SSH into the router and once logged into it, I can ping out to google.com and other websites. Functional... just seems that DNSMASQ has seen better days! <img src="https://forum.openwrt.org/img/smilies/tongue.png" width="15" height="15" alt="tongue" /></p><div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>Did you ensure that the correct interface was br-lan?</p></blockquote></div><p>Yep -- I made sure of that when I first started reading the beginning of the script and the interface is called exactly the same as the script needs.</p><br /><br /><div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>logger_ads &quot;Adding a refresh cycle by puting the script in cron if it isnt there yet&quot;<br />if [[ -z &quot;`cat /etc/crontabs/root | grep &quot;/etc/dns/disable_adds.sh&quot;`&quot; ]] ; then<br /><strong>&nbsp; &nbsp; echo &#039;0 0 * * * \t/etc/dns/disable_adds.sh -m&#039; &gt;&gt; /etc/crontabs/root</strong><br />&nbsp; &nbsp; /etc/init.d/cron restart &amp;&amp; logger_ads &quot;restarted the cron service&quot;<br />else<br />&nbsp; &nbsp; logger_ads &quot;The script is already in cron&quot;<br />fi</p></blockquote></div><p>This information below is what I had in your original e-mail to me and I wanted to make sure that the script above was correct or if there was a typo?</p><p><span style="color: blue">logger_ads &quot;Adding a refresh cycle by puting the script in cron if it isnt there yet&quot;<br />if [[ -z &quot;`cat /etc/crontabs/root | grep &quot;/etc/dns/disable_adds.sh&quot;`&quot; ]] ; then<br /><strong>&nbsp; &nbsp; echo &#039;0 0 * * * root /etc/dns/disable_adds.sh -m&#039; &gt;&gt; /etc/crontabs/root</strong><br />&nbsp; &nbsp; /etc/init.d/cron restart &amp;&amp; logger_ads &quot;restarted the cron service&quot;<br />else<br />&nbsp; &nbsp; logger_ads &quot;The script is already in cron&quot;<br />fi</span></p></blockquote></div><p>take the actions in my oteher post concering dnsmasq.conf and crontabs/root</p><div class="quotebox"><blockquote><div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>logger_ads &quot;Redirect setup &amp; Appending to the FW script&quot;<br />#[[ -z &quot;`iptables -L -n -t nat | grep ${pixel} | grep 88`&quot; ]] &amp;&amp; logger_ads &quot;did NOT find an active redirect rule with the iptable command, injecting it now.&quot; &amp;&amp; /usr/sbin/iptables -t nat -I PREROUTING -p tcp -d ${pixel} --dport 80 -j REDIRECT --to-ports 88<br />[[ -z &quot;`iptables -L -n -t nat | grep ${pixel} | grep 88`&quot; ]] &amp;&amp; logger_ads &quot;did NOT find an active redirect rule with the iptable command, injecting it now.&quot; &amp;&amp; /usr/sbin/iptables -t nat -I PREROUTING 1 -d ${pixel} -p tcp --dport 80 -j DNAT --to ${pixel}:88</p></blockquote></div><p>Was the syntax wrong? Curious because I&#039;m trying to learn all the different parts of the script and what it does.</p></blockquote></div><p>Syntax here was correct.&nbsp; On reboot the iptables entry should be gone until the script is run again.&nbsp; The problem now is mainly with the dnsmasq.conf which should be straightened out with the edits I described in the other post.&nbsp; What happened was that the dnsmasq.conf was referencing some non-existant files and was probably erroring thus disableing routing and dhcp.</p><div class="quotebox"><blockquote><div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>logger_ads &quot;Get the online lists&quot;<br />tdhl=0<br />tadblk=0<br />tnow=`date +%s`<br />[ -e /etc/dns/dlhosts ] &amp;&amp; tdlh=`date +%s -r /etc/dns/dlhosts`<br />[ -e /etc/dns/adblock.conf ] &amp;&amp; tadblk=`date +%s -r /etc/dns/adblock.conf`<br />tdlh=`expr $tdlh + 86400`<br />tadblk=`expr $tadblk + 86400`</p></blockquote></div><p>Curious if this is possibly the dummy file creation if the /etc/dns/ path doesn&#039;t have the dlhost &amp; adblock.conf files. Below is the original.</p></blockquote></div><p>No this is now a test for the existence before trying to get the creation date (previous failing code did not check for existence, thus failing when trying to get the creation date of a non-existing file</p><div class="quotebox"><blockquote><p><span style="color: blue"><br />logger_ads &quot;Get the online lists&quot;<br />tnow=`date +%s`<br />tdlh=`date +%s -r /etc/dns/dlhosts`<br />tadblk=`date +%s -r /etc/dns/adblock.conf`<br />tdlh=`expr $tdlh + 86400`<br />tadblk=`expr $tadblk + 86400`<br /></span></p><br /><br /><p>I&#039;d really hate to lose what I&#039;ve gotten configured -- but I will if I have to. I&#039;m curious if there is any way to recover the DNSMASQ or other daemon service configurations to allow for the router to work again and just rerun the script with your changes?</p><br /><p>I&#039;ll start working on whatever fix once I&#039;ve confirmed I&#039;m not assuming anything. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Thanks again KingJL!</p></blockquote></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138702">
				<div class="post-metadata">
					<div class="post-num">Post #38</div>
					<div class="post-author">KingJL</div>
					<div class="post-datetime">
						8 Jul 2011, 06:25					</div>
				</div>
				<div class="post-content content">
					<p>If after taking the steps to edit the dnsmasq .conf file and rebooting, dnsmasq still not working, you can copy /rom/etc/dnsmasq.conf to /etc/dnsmasq.conf for the original file.&nbsp; Then go into LuCi and make sure that dhcp is enabled for the lan.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138706">
				<div class="post-metadata">
					<div class="post-num">Post #39</div>
					<div class="post-author">rgranados80</div>
					<div class="post-datetime">
						8 Jul 2011, 07:24					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>reboot and see if you can get in... you should be back to pre script configuration.</p></blockquote></div><p>You are the man King! I have read your other posts but have been on my slow connection with my laptop using my cell phone. I have tested my wireless and DHCP and DNS are back up and running on both my computer and on my laptop!! <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>With the corruption that occurred with the script would make me wonder the condition of the binary</p></blockquote></div><p>I&#039;m not sure what you mean by binary here? Do you mean the build of my router firmware or something wrong with the script file itself when it transferred? If your concern is over the script -- I&#039;m currently using vi and pasting the script in now and modifying the file to be executable. If you mean something else -- could you explain?</p><p>So I&#039;ve taken the script with the edits you&#039;ve created and attempted to run it again and came up with less errors but the same situation of being unable to surf the web.</p><div class="codebox"><pre><code>root@OpenWrt:/etc/dns# ./disable_add.sh 
./disable_add.sh: line 1: nds: not found
ad_blocker_script: ###########Ads blocker ed###########
ad_blocker_script: Sleeping for 30 secs to give time for router boot
ad_blocker_script: New IP and ports setup
ad_blocker_script: Adding a refresh cycle by puting the script in cron if it isnt there yet
ad_blocker_script: restarted the cron service
ad_blocker_script: Redirect setup &amp; Appending to the FW script
ad_blocker_script: did NOT find an active redirect rule with the iptable command, injecting it now.
ad_blocker_script: Starting or ReSpawning pixelsrv
ad_blocker_script: it seems that the pixelserv isnt up. starting it now
pixelserv[2061]: /etc/dns/pixelserv V22 compiled: Dec  8 2010 14:58:16 from pixelserv22.c
ad_blocker_script: Get the online lists
expr: syntax error
sh: -o: bad number
ad_blocker_script: The lists are less then 3 days old, saving on flash erosion and NOT refreshing them
ad_blocker_script: Removing whitelist from the personal file
ad_blocker_script: Refreshing DNS settings

dnsmasq: cannot read /etc/dns/adblock.conf: No such file or directory
ad_blocker_script: ##########The Ads blocker script has finished its run and you should up and running##########
root@OpenWrt:/etc/dns#</code></pre></div><p>I&#039;m posting immediately to you now because I&#039;m using your fixes to the dnsmasq.conf and cron right after I ran the script. I should be able to make responses quicker now because of that. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138720">
				<div class="post-metadata">
					<div class="post-num">Post #40</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						8 Jul 2011, 13:59					</div>
				</div>
				<div class="post-content content">
					<p>KIngJL, this time I got your update. Thanks.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138724">
				<div class="post-metadata">
					<div class="post-num">Post #41</div>
					<div class="post-author">KingJL</div>
					<div class="post-datetime">
						8 Jul 2011, 15:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>rgranados80 wrote:</cite><blockquote><div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>With the corruption that occurred with the script would make me wonder the condition of the binary</p></blockquote></div><p>I&#039;m not sure what you mean by binary here? Do you mean the build of my router firmware or something wrong with the script file itself when it transferred? If your concern is over the script -- I&#039;m currently using vi and pasting the script in now and modifying the file to be executable. If you mean something else -- could you explain?</p></blockquote></div><p>I was referring to the &#039;pixelserv&#039; binary.</p><div class="quotebox"><blockquote><p>So I&#039;ve taken the script with the edits you&#039;ve created and attempted to run it again and came up with less errors but the same situation of being unable to surf the web.</p><div class="codebox"><pre><code>root@OpenWrt:/etc/dns# ./disable_add.sh 
./disable_add.sh: line 1: nds: not found
ad_blocker_script: ###########Ads blocker ed###########
ad_blocker_script: Sleeping for 30 secs to give time for router boot
ad_blocker_script: New IP and ports setup
ad_blocker_script: Adding a refresh cycle by puting the script in cron if it isnt there yet
ad_blocker_script: restarted the cron service
ad_blocker_script: Redirect setup &amp; Appending to the FW script
ad_blocker_script: did NOT find an active redirect rule with the iptable command, injecting it now.
ad_blocker_script: Starting or ReSpawning pixelsrv
ad_blocker_script: it seems that the pixelserv isnt up. starting it now
pixelserv[2061]: /etc/dns/pixelserv V22 compiled: Dec  8 2010 14:58:16 from pixelserv22.c
ad_blocker_script: Get the online lists
expr: syntax error
sh: -o: bad number
ad_blocker_script: The lists are less then 3 days old, saving on flash erosion and NOT refreshing them
ad_blocker_script: Removing whitelist from the personal file
ad_blocker_script: Refreshing DNS settings

dnsmasq: cannot read /etc/dns/adblock.conf: No such file or directory
ad_blocker_script: ##########The Ads blocker script has finished its run and you should up and running##########
root@OpenWrt:/etc/dns#</code></pre></div><p>I&#039;m posting immediately to you now because I&#039;m using your fixes to the dnsmasq.conf and cron right after I ran the script. I should be able to make responses quicker now because of that. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></blockquote></div><p>There is still something amiss in the script causing the error at line 1, the expr error, and the sh -o bad number error.<br />You need to carefully compare your script (on the router) with the one I corrected in a previous post ( <a href="https://forum.openwrt.org/viewtopic.php?pid=138695#p138695">https://forum.openwrt.org/viewtopic.php … 95#p138695</a> ).</p><p>Line 1: should be only &#039;#!/bin/sh&#039; (there is no &#039;nds&#039; on line 1).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138725">
				<div class="post-metadata">
					<div class="post-num">Post #42</div>
					<div class="post-author">KingJL</div>
					<div class="post-datetime">
						8 Jul 2011, 15:57					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>There is still something amiss in the script causing the error at line 1, the expr error, and the sh -o bad number error.</p></blockquote></div><p>I think I found the cause of the expr error.<br />Change:</p><div class="codebox"><pre><code>tdhl=0</code></pre></div><p>to</p><div class="codebox"><pre><code>tdlh=0</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138736">
				<div class="post-metadata">
					<div class="post-num">Post #43</div>
					<div class="post-author">rgranados80</div>
					<div class="post-datetime">
						8 Jul 2011, 18:44					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ll post results a little later today -- I don&#039;t want to run the script remotely and be unable to get back into the router if something goes awry. Should be 3-5 hours for next post.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138757">
				<div class="post-metadata">
					<div class="post-num">Post #44</div>
					<div class="post-author">KingJL</div>
					<div class="post-datetime">
						9 Jul 2011, 05:48					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>KingJL wrote:</cite><blockquote><p>There is still something amiss in the script causing the error at line 1, the expr error, and the sh -o bad number error.<br />You need to carefully compare your script (on the router) with the one I corrected in a previous post ( <a href="https://forum.openwrt.org/viewtopic.php?pid=138695#p138695">https://forum.openwrt.org/viewtopic.php … 95#p138695</a> ).</p><p>Line 1: should be only &#039;#!/bin/sh&#039; (there is no &#039;nds&#039; on line 1).</p></blockquote></div><p>Okay, I THINK I know what happened to cause the error &quot;nds not found&quot; at line 1.&nbsp; You said that you used copy/paste while you were using vi to create disable_adds.sh.&nbsp; I think that you were not in &quot;INSERT&quot; mode when you did the paste.&nbsp; That would cause all characters of the paste to be ignored as illegal commands until the &#039;a&#039; in &quot;commands&quot; on line 2.&nbsp; At that point vi was put in &quot;APPEND&quot; mode and from that point forward everything pasted sucessfully.&nbsp; Resulting in line 1 becomming:<br /></p><div class="codebox"><pre><code>nds for terminal############</code></pre></div><p>resuting in the &quot;./disable_add.sh: line 1: nds: not found&quot;.&nbsp; I think that if you use vi and restore the first 2 lines and apply the edit of the tdhl to tdlh variable, then everything shoiuld be fine for the disable_adds.sh.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138953">
				<div class="post-metadata">
					<div class="post-num">Post #45</div>
					<div class="post-author">rgranados80</div>
					<div class="post-datetime">
						12 Jul 2011, 02:16					</div>
				</div>
				<div class="post-content content">
					<p>KingJL</p><p><strong>ALL IS WORKING!!!</strong></p><p>After following your last post -- the script is fully functional! <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /> You hit the nail on the head regarding VI and my pasting into the terminal window. I looked at the script file and it started incorrectly because it didn&#039;t go into &quot;insert&quot; mode until it hit an &quot;i&quot; in the script. &lt;dumb mistake&gt; I also made the modification of the script for the one line indicating &quot;tdhl=0&quot; to &quot;tdlh=0&quot; and there were no errors. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>This is by far the best modification I&#039;ve made on a router before as it will benefit everyone on the network. I&#039;ve only ever done port forwarding to get access to things on another computer, so this is the most advanced thing I&#039;ve ever implemented.</p><p>Thank you so much for sticking it out with me on this thread and dealing with my lack of scripting knowledge and basic router troubleshoot. I really appreciate everything I&#039;ve learned and I&#039;m making sure to remember the more common files that were worked with on this to try and help others on the forum.</p><p>Would you be interested at all in doing a how to?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138955">
				<div class="post-metadata">
					<div class="post-num">Post #46</div>
					<div class="post-author">KingJL</div>
					<div class="post-datetime">
						12 Jul 2011, 03:12					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>rgranados80 wrote:</cite><blockquote><p>KingJL</p><p><strong>ALL IS WORKING!!!</strong></p></blockquote></div><p>Great! The only other recommendation I would give would be to add an entry into the /etc/hosts file of &quot;xxx.xxx.xxx.254 local_ad_blocker&quot; (replace the xxx.xxx.xxx with your domain address).&nbsp; That way when someone does a ping -a or a nslookup that resoves to your pixelserv, it shows a name that you will recognize rather than what ever host is the first one listed in the /etc/dns/dlhosts file.</p>											<p class="post-edited">(Last edited by <strong>KingJL</strong> on 12 Jul 2011, 03:15)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p139007">
				<div class="post-metadata">
					<div class="post-num">Post #47</div>
					<div class="post-author">mstombs</div>
					<div class="post-datetime">
						12 Jul 2011, 23:39					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><blockquote><p>pixelserv[2061]: /etc/dns/pixelserv V22 compiled: Dec&nbsp; 8 2010 14:58:16 from pixelserv22.c</p></blockquote></div><p>There was an &#039;enhanced version&#039; of the little c program a few days later, trying to workaround ad hosts that load javascript or other non image requests</p><p><a href="http://www.linksysinfo.org/forums/showpost.php?p=370859&amp;postcount=154">http://www.linksysinfo.org/forums/showp … tcount=154</a></p><p>hasn&#039;t been updated since - I know of one bug - pixelserv should be killed and restarted if the interface (ie lan bridge) is reconfigured - else it can sit forever attached to some no-longer-existent handle.</p><p>Would probably be preferable to re-build using the appropriate toolchains - this version used the tomatousb Broadcom mips toolchain (which is OpenWRT derived) .</p><p>Anyone give advice howto package as the smallest optware contribution?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p139960">
				<div class="post-metadata">
					<div class="post-num">Post #48</div>
					<div class="post-author">languagegame</div>
					<div class="post-datetime">
						26 Jul 2011, 09:28					</div>
				</div>
				<div class="post-content content">
					<p>Great thread and good work.&nbsp; Here&#039;s a lightweight version that doesn&#039;t require a third party program.</p><p>1) Create a document root with a blank gif file<br /></p><div class="codebox"><pre><code>mkdir /www2
wget –O /www2/Blank.gif http://upload.wikimedia.org/wikipedia/commons/c/c0/Blank.gif</code></pre></div><p>2) Append the following to /etc/config/uhttpd to start a new web server on port 88 that returns the blank gif file for any URL<br /></p><div class="codebox"><pre><code>config uhttpd pixelserv
    list listen_http    0.0.0.0:88
    option home    /www2
    option error_page    /Blank.gif
    option index_page    Blank.gif</code></pre></div><p>The rest of a solution could use the prior script mentioned previously (which uses dnsmasq to point ad domains to the pixelserv).&nbsp; Alternatively a lightweight version of the script could be something like:</p><p>3) Create a new executable file /etc/init.d/adblock<br /></p><div class="codebox"><pre><code>#!/bin/sh /etc/rc.common
# Copyright (C) 2006 OpenWrt.org

START=59
start() {
        pixel=&quot;`ifconfig br-lan | grep inet | awk &#039;{ print $3 }&#039; | awk -F &quot;:&quot; &#039;{ print $2 }&#039; | cut -d . -f 1,2,3`.254&quot;
        /sbin/ifconfig br-lan:1 $pixel
        /usr/sbin/iptables -t nat -I PREROUTING 1 -d ${pixel} -p tcp --dport 80 -j DNAT --to ${pixel}:88
        wget -O - &quot;http://pgl.yoyo.org/adservers/serverlist.php?hostformat=hosts&amp;showintro=0&amp;mimetype=plaintext&quot; | sed &quot;s/127\.0\.0\.1/$pixel/&quot; &gt; /var/hosts.yoyo
        wget -O - &quot;http://www.mvps.org/winhelp2002/hosts.txt&quot; | tr -d &#039;\015\032&#039; | sed &quot;s/127\.0\.0\.1/$pixel/&quot; &gt; /var/hosts.mvps
}</code></pre></div><p>4) Enable the adblock script to start on boot (right before dnsmasq)<br /></p><div class="codebox"><pre><code>/etc/init.d/adblock enable</code></pre></div><p>5) Append to /etc/config/dhcp (ignoring the &quot;config &#039;dnsmasq&#039;&quot;)<br /></p><div class="codebox"><pre><code>config &#039;dnsmasq&#039;
        list &#039;addnhosts&#039; &#039;/var/hosts.mvps&#039;
        list &#039;addnhosts&#039; &#039;/var/hosts.yoyo&#039;</code></pre></div><p>6) Reboot</p>											<p class="post-edited">(Last edited by <strong>languagegame</strong> on 26 Jul 2011, 09:42)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p139965">
				<div class="post-metadata">
					<div class="post-num">Post #49</div>
					<div class="post-author">mstombs</div>
					<div class="post-datetime">
						26 Jul 2011, 11:50					</div>
				</div>
				<div class="post-content content">
					<p>You cannot use the built-in web-server in Tomato/dd-wrt etc because they are heavily customized for web gui/control script type functions - so this is a big plus for OpenWRT - but presumably can also do similar with OpenWRT/Tomato when using Optware.&nbsp; Can you also filter the reply based on request?&nbsp; Many links to adhosts are now to javascript snippets, and IE at least tries to execute the null gif string and reports script error. </p><p>I prefer dnsmasq&#039;s domain blocking config should be fewer entries than specific hosts? - the pgl list is downloadable in suitable form for use, others can be transformed - the Tomato based scripts merge, sort and remove duplicates.&nbsp; If the resulting dnsmasq config is invalid it will error and exit - hence there are are also checks and default configs for unattended operation.</p><p>You will also likely need a Whitelist file to over-ride the download, I use this bash snip to do this</p><div class="codebox"><pre><code>CNF=/jffs/adblock.conf
WHL=/jffs/whitelist
ADS=&quot;http://pgl.yoyo.org/adservers/serverlist.php?hostformat=dnsmasq&amp;showintro=0&amp;mimetype=plaintext&quot;
AIP=&quot;192.168.0.1&quot; # changes 127.0.0.1 to this globally
wget -O - &quot;$ADS&quot;|sed &quot;s/127.0.0.1/$AIP/&quot; | grep -Fvf $WHL &gt;$CNF</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p140064">
				<div class="post-metadata">
					<div class="post-num">Post #50</div>
					<div class="post-author">languagegame</div>
					<div class="post-datetime">
						27 Jul 2011, 06:46					</div>
				</div>
				<div class="post-content content">
					<p>Agree the javascript functionality is preferred for the web server.&nbsp; The built-in server on OpenWRT runs relatively fast for sending blank image files, but it does not address the IE script error for javascript snippets.</p><p>I suppose this gets us back to your original request. What&#039;s the best way to get a package for the latest pixelserv executable and related scripts?</p>											<p class="post-edited">(Last edited by <strong>languagegame</strong> on 27 Jul 2011, 06:48)</p>
									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 2 of 3</div><nav><ul><li><a href="viewtopic.php%3Fid=30760&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=30760&amp;p=3.html">3</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>