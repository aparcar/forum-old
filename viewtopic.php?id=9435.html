<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Details of changes in Kamikaze?</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 18 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p42566">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">monnier</div>
					<div class="post-datetime">
						12 Feb 2007, 20:05					</div>
				</div>
				<div class="post-content content">
					<p>I do not have a spare router on which to try Kamikaze, so I&#039;ll just post here some random things I hope are fixed compared to WhiteRussian:<br />1 - the main one: make upgrading safer.&nbsp; Everytime a new WhiteRussian release has come up, I learned about it because some of my router&#039;s functionality got trashed by &quot;ipkg upgrade&quot;.&nbsp; E.g. today when I run &quot;ipkg upgrade&quot; on my RC6 router, it started to install presumably 0.9 packages, overwriting my /etc/passwd and various other files. Ipkg has no business removing my users and passwords.<br />BTW, I see nowhere any info indicating whether &quot;ipkg upgrade&quot; did successfully<br />upgrade my router to 0.9 or if it only did part of it.&nbsp; I&#039;ll probably re-flash 0.9 anyway just to save flash space (by moving the new modules from /jffs to /rom), but I&#039;d be interested to learn whether there&#039;s something more to it.<br />2 - make upgrading easier.&nbsp; Upgrading from one release to the next is painful: after re-flashing I have to figure out all over again all the files I had changed.<br />3 - /tmp and /var are different.&nbsp; dhcp.leases should be in /var, not in /tmp (so that the info is not lost across reboots).&nbsp; BTW, I have split them here and most things work fine after the split.&nbsp; I did notice that webif looks for /tmp/dhcp.leases rather than /var/dhcp.leases.</p><p>For reference here is the output of &quot;ipkg upgrade&quot; when I ran it today.&nbsp; All in all, I don&#039;t think it has erased too much stuff, but throwing away my root password got me seriously scared since I couldn&#039;t log back in via SSH (luckily I still had left the webif reachable indirectly and this worked to reset the password).</p><p>~# ipkg upgrade<br />Upgrading base-files on root from 8 to 9...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/base-files_9_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />ipkg: /rom/note: Read-only file system<br />ipkg: Cannot create symlink from ./var to &#039;/tmp&#039;: File exists<br />Upgrading busybox on root from 1.00-4 to 1.00-5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/busybox_1.00-5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading dnsmasq on root from 2.33-1 to 2.35-1...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/dnsmasq_2.35-1_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />&nbsp; &nbsp; Configuration file &#039;/etc/dnsmasq.conf&#039;<br />&nbsp; &nbsp; ==&gt; File on system created by you or by a script.<br />&nbsp; &nbsp; ==&gt; File also in package provided by package maintainer.<br />&nbsp; &nbsp; &nbsp; &nbsp;What would you like to do about it ?&nbsp; Your options are:<br />&nbsp; &nbsp; &nbsp; &nbsp; Y or I&nbsp; : install the package maintainer&#039;s version<br />&nbsp; &nbsp; &nbsp; &nbsp; N or O&nbsp; : keep your currently-installed version<br />&nbsp; &nbsp; &nbsp;The default action is to keep your current version.<br />&nbsp; &nbsp; *** dnsmasq.conf (Y/I/N/O) [default=N] ?<br />Upgrading kmod-brcm-wl on root from 2.4.30-brcm-4 to 2.4.30-brcm-5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/kmod-brcm-wl_2.4.30-brcm-5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading kmod-crypto on root from 2.4.30-brcm-4 to 2.4.30-brcm-5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/kmod-crypto_2.4.30-brcm-5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading kmod-ext3 on root from 2.4.30-brcm-4 to 2.4.30-brcm-5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/kmod-ext3_2.4.30-brcm-5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading kmod-gre on root from 2.4.30-brcm-4 to 2.4.30-brcm-5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/kmod-gre_2.4.30-brcm-5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading kmod-ipt-conntrack on root from 2.4.30-brcm-4 to 2.4.30-brcm-5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/kmod-ipt-conntrack_2.4.30-brcm-5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading kmod-ipt-nat-extra on root from 2.4.30-brcm-4 to 2.4.30-brcm-5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/kmod-ipt-nat-extra_2.4.30-brcm-5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading kmod-ipt-nat-pptp on root from 2.4.30-brcm-4 to 2.4.30-brcm-5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/kmod-ipt-nat-pptp_2.4.30-brcm-5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading kmod-mppe on root from 2.4.30-brcm-4 to 2.4.30-brcm-5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/kmod-mppe_2.4.30-brcm-5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading kmod-ppp on root from 2.4.30-brcm-4 to 2.4.30-brcm-5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/kmod-ppp_2.4.30-brcm-5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading kmod-pppoe on root from 2.4.30-brcm-4 to 2.4.30-brcm-5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/kmod-pppoe_2.4.30-brcm-5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading kmod-usb-core on root from 2.4.30-brcm-4 to 2.4.30-brcm-5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/kmod-usb-core_2.4.30-brcm-5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading kmod-usb-ohci on root from 2.4.30-brcm-4 to 2.4.30-brcm-5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/kmod-usb-ohci_2.4.30-brcm-5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading kmod-usb-printer on root from 2.4.30-brcm-4 to 2.4.30-brcm-5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/kmod-usb-printer_2.4.30-brcm-5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading kmod-usb-storage on root from 2.4.30-brcm-4 to 2.4.30-brcm-5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/kmod-usb-storage_2.4.30-brcm-5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading kmod-usb-uhci on root from 2.4.30-brcm-4 to 2.4.30-brcm-5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/kmod-usb-uhci_2.4.30-brcm-5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading mtd on root from 4 to 5...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/mtd_5_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Upgrading uclibc on root from 0.9.27-8 to 0.9.27-9...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/uclibc_0.9.27-9_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Installing libgcc (3.4.4-9) to root...<br />Downloading <a href="http://downloads.openwrt.org/whiterussian/packages/libgcc_3.4.4-9_mipsel.ipk">http://downloads.openwrt.org/whiterussi … mipsel.ipk</a><br />Configuring base-files<br />Configuring busybox<br />Configuring dnsmasq<br />Configuring kmod-brcm-wl<br />Configuring kmod-crypto<br />Configuring kmod-ext3<br />Configuring kmod-gre<br />Configuring kmod-ipt-conntrack<br />Configuring kmod-ipt-nat-extra<br />Configuring kmod-ipt-nat-pptp<br />Configuring kmod-mppe<br />Configuring kmod-ppp<br />Configuring kmod-pppoe<br />Configuring kmod-usb-core<br />Configuring kmod-usb-ohci<br />Configuring kmod-usb-printer<br />Configuring kmod-usb-storage<br />Configuring kmod-usb-uhci<br />Configuring libgcc<br />Configuring mtd<br />Configuring uclibc<br />Successfully terminated.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p42572">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">mbm</div>
					<div class="post-datetime">
						12 Feb 2007, 20:37					</div>
				</div>
				<div class="post-content content">
					<p>Sorry - ipkg upgrade will never work.</p><p>The real problem is the design of the system; there&#039;s just not a heck of a lot available in terms of resources so you really have to work hard to cram everything into as little space as possible. For those of you that aren&#039;t familiar with the full technical details of the device let&#039;s start out with the basics. Your typical router:</p><p>* 4M flash<br />* 16M ram</p><p>The first 256k of flash is eatten by the bootloader, this is basically the bios of the device, required to boot into the OS (ie the openwrt firmware). At the end of the flash is nvram, taking the last (64k) block of flash.&nbsp; This leaves you with just over 3.6M to fit your entire OS - kernel and filesystem.</p><div class="codebox"><pre><code>[ Bootloader ] [ Firmware ................... ] [ NVRAM ]</code></pre></div><p>The bootloader really has no concept of a filesystem; it just assumes that the firmware starts with executable code, meaning that our kernel is contained outside the filesystem. Technically we could put some sort of code at the start of the firmware to locate the filesystem and pull the kernel out of it, but that would require space for the bootstrap code and more space used by the kernel due to filesystem overhead. The best thing we&#039;ve come up with so far is to highly compress the kernel using lzma, and boot into an lzma decompressor, making it look something like this:</p><div class="codebox"><pre><code>[ Bootloader ] [ LZMA + Kernel ] [ Rest of firmware .... ] [ NVRAM ]</code></pre></div><p>Now comes the filesystem, we want to make the filesystem as big as possible, that means that we want to start the filesystem immediately after the end of the kernel. Well what happens if the kernel changes? It&#039;s not like we left any extra room for a larger kernel - this means that every time the kernel changes it can potentially wipe out a good chunk of the start of the filesystem. Ouch, obviously we&#039;re going to have to recreate the filesystem every time the kernel changes.</p><p>But let&#039;s talk about the filesystem itself; you want a filesystem that&#039;s readable and writable, but you also want a filesystem that compresses well. Unfortunately the tradeoff with having a writable filesystem is that you can&#039;t compress the files nearly as tightly as you could if the filesystem was readonly. Squashfs gets better compression than JFFS2 but the Squashfs filesystem is readonly. Ouch this is starting to get annoying. Ok let&#039;s set up the flash as follows:</p><div class="codebox"><pre><code>[ Bootloader ] [ LZMA + Kernel ] [ Squashfs ] [ Jffs2 ........ ] [ NVRAM ]</code></pre></div><p>The idea is that we&#039;ll try to cram as much common functionality as possible into Squashfs to get the best compression, but we&#039;ll try to leave out task specific items that not everyone will use -- no point wasting flash space for features the end user isn&#039;t interested in, and if they are interested they can just load the package onto JFFS2.</p><p>We can hide the split between JFFS2 and Squahsfs by using either symlinks or mini_fo. In the past we&#039;ve used symlinks from JFFS2 to files on squashfs, but more recently we&#039;ve switched over to using mini_fo. The mini_fo module provides a copy on write filesystem, meaning that if you try to change anything on the squashfs partition, it will just copy the file over to the jffs2 filesystem and make the changes there.</p><p>So what happens with the ipkg upgrade?</p><p>This is tricky, there&#039;s no way to change the kernel without nuking the filesystem, and if we try to change any of the files that came with the firmware, all we&#039;ll really be doing is downloading packages to the JFFS2 partition - there&#039;s no way to rewrite the squashfs partition without reflashing. So eventually we&#039;ll fill up with JFFS2 partition and our Squashfs partition will go unused because all the applications are now on JFFS2.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p42573">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">mbm</div>
					<div class="post-datetime">
						12 Feb 2007, 20:48					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>monnier wrote:</cite><blockquote><p>/tmp and /var are different.&nbsp; dhcp.leases should be in /var, not in /tmp (so that the info is not lost across reboots).&nbsp; BTW, I have split them here and most things work fine after the split.&nbsp; I did notice that webif looks for /tmp/dhcp.leases rather than /var/dhcp.leases.</p></blockquote></div><p>This was intentional.</p><p>/tmp is a ramdisk</p><p>OpenWrt&#039;s policy is to never write to flash unless explicitly instructed to do so (with the exception of the first bootup). The basic idea is that frequent writes to the flash will eventually wear out the flash; OpenWrt is designed such that it can run forever without risk of crashing due to flash failure.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p42663">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">monnier</div>
					<div class="post-datetime">
						14 Feb 2007, 17:31					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mbm wrote:</cite><blockquote><p>Sorry - ipkg upgrade will never work.</p></blockquote></div><p>I understand that &quot;ipkg upgrade&quot; can&#039;t upgrade the kernel, of course.<br />But there are two issues:<br />1 - make sure that &quot;ipkg upgrade&quot; doesn&#039;t screw up existing files (such as /etc/passwd, /etc/profile, /etc/group, ...).&nbsp; Clearly this can be done (as my sample session showed: it was careful with /etc/dnsmasq.conf).&nbsp; Also maybe it should try to avoid (or at least warn the user when) trying to upgrade a package that is in the squashfs part.<br />2 - make it easier to preserve local changes when upgrading from one version of the firmware to another.&nbsp; One way I can think of would be to write a tool that takes the old firmware and generates a &quot;diff&quot; by comparing it to the current state of the system, and then another tool that can apply this diff to the system after upgrading to the new firmware.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p42664">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">monnier</div>
					<div class="post-datetime">
						14 Feb 2007, 17:35					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mbm wrote:</cite><blockquote><div class="quotebox"><cite>monnier wrote:</cite><blockquote><p>/tmp and /var are different.&nbsp; dhcp.leases should be in /var, not in /tmp (so that the info is not lost across reboots).</p></blockquote></div><p>This was intentional.</p><p>/tmp is a ramdisk</p><p>OpenWrt&#039;s policy is to never write to flash unless explicitly instructed to do so (with the exception of the first bootup). The basic idea is that frequent writes to the flash will eventually wear out the flash; OpenWrt is designed such that it can run forever without risk of crashing due to flash failure.</p></blockquote></div><p>OK, that makes sense.&nbsp; But I believe that OpenWRT should still work correctly if the user chooses to split the two.&nbsp; I.e. all tools should be careful to use /tmp or /var appropriately, in case /var is not a symlink to /tmp.<br />I.e. it&#039;s still a bug for webif to refer to /tmp/dhcp.leases rather than /var/dhcp.leases.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p42686">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						15 Feb 2007, 01:25					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mbm wrote:</cite><blockquote><p>Sorry - ipkg upgrade will never work.<br />...</p></blockquote></div><p>Sorry for hijacking the thread, but anyways, kudos to mbm for a great write-up! I&#039;m not that literate when it comes to linux kernel and OS internals, and it was a great read to help understand insides of OpenWRT a little better.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p42689">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">skorianez</div>
					<div class="post-datetime">
						15 Feb 2007, 02:16					</div>
				</div>
				<div class="post-content content">
					<p>@mbm:&nbsp; Very good review off embendded openwrt system, how about put this on wiki .</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p44077">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">pier11</div>
					<div class="post-datetime">
						10 Mar 2007, 13:06					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>skorianez wrote:</cite><blockquote><p>@mbm:&nbsp; Very good review off embendded openwrt system, how about put this on wiki .</p></blockquote></div><p>Please put it to wiki if not yet. Just incidently found this great inside in forum internals.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p45786">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">kenjiru</div>
					<div class="post-datetime">
						3 Apr 2007, 22:14					</div>
				</div>
				<div class="post-content content">
					<p>Yes, it&#039;s great inside. I couldn&#039;t find this kind of stuff on wiki and it would be nice to have it there.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>