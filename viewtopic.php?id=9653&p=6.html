<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Optimized version of mmc.c</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 5 Jun 2014 and 7 Mar 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 6 of 7</div><nav><ul><li><a href="viewtopic.php%3Fid=9653&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=9653&amp;p=4.html">4</a></li><li><a href="viewtopic.php%3Fid=9653&amp;p=5.html">5</a></li><li class="pagination-current"><span>6</span></li><li><a href="viewtopic.php%3Fid=9653&amp;p=7.html">7</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p61592">
				<div class="post-metadata">
					<div class="post-num">Post #126</div>
					<div class="post-author">ke1g</div>
					<div class="post-datetime">
						11 Jan 2008, 16:22					</div>
				</div>
				<div class="post-content content">
					<p>I believe that there is a timing hazard in cycles_delay(), from spi.c (second function in the file).</p><p>I&#039;m assuming that successive calls to get_cycle() in the loop:<br/>&nbsp; &nbsp;while (get_cycles() &gt; future) ;<br/>can (usually or always do) return values that differ by more than one from call to call.&nbsp; Then, if future turns out to be the maximally small number (0x7FFFFFFF, if, indeed, cycle_t is a 32 bit signed integer, 0 if it is actually unsigned), it is possible, when get_cycle() wraps, that it will skip past the value in future, leading to an additional delay until at least the next time get_cycle() wraps.&nbsp; A very easy fix is to change the loop to:<br/>&nbsp; &nbsp;while (get_cycles() &gt; now) ;</p><p>This is not to say that I&#039;ve experienced this problem, but I currently have too much time on my hands, and was reading the code because I&#039;m curious about the SD interface.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p62409">
				<div class="post-metadata">
					<div class="post-num">Post #127</div>
					<div class="post-author">lsomchai</div>
					<div class="post-datetime">
						28 Jan 2008, 16:12					</div>
				</div>
				<div class="post-content content">
					<p>Hi all,</p><p>I am using Kingston 512MB 50X SD card on WRT54GL@250MHz with mmc driver version 1.3.4.<br/>I got write speed only 170KBps for 150MB testing data.</p><p>Please advise me what should I do for faster speed as Cyril said (850KB/s WRITE, 450KB/s READ).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p62644">
				<div class="post-metadata">
					<div class="post-num">Post #128</div>
					<div class="post-author">lsomchai</div>
					<div class="post-datetime">
						1 Feb 2008, 07:08					</div>
				</div>
				<div class="post-content content">
					<p>Hi all,</p><p>I just want to report my test.<br/>Now, I got 550KB/s WRITE, 400KB/s READ when I format SD card in ext2 format faster than vfat format.<br/>However, I do not reach the max Cyril&#039;s speed.</p><p>Well, now I got 700KB/s WRITE, 445KB/s READ when using 2GB 150X SD. The old on is 512MB 50X SD.</p>											<p class="post-edited">(Last edited by <strong>lsomchai</strong> on 3 Feb 2008, 11:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p63454">
				<div class="post-metadata">
					<div class="post-num">Post #129</div>
					<div class="post-author">collen</div>
					<div class="post-datetime">
						15 Feb 2008, 12:46					</div>
				</div>
				<div class="post-content content">
					<p>Is there also a mmc.o for the wap54g ???</p><p>i tried several mmc.o &#039;s but all gave me an mmc_card_init error.</p><p>i use whiterussian 0.9 ( kamikaze is still not running poroper on my wap54g, and get&#039;s to big)</p><p>used these howto&#039;s: <br/><a href="http://www.linksysinfo.org/forums/showthread.php?t=44464">http://www.linksysinfo.org/forums/showthread.php?t=44464</a><br/><a href="http://panteltje.com/panteltje/wap54g/to-linksys-wap54g-forum-2.txt">http://panteltje.com/panteltje/wap54g/to-linksys-wap54g-forum-2.txt</a></p><p>Cheers, Collen</p>											<p class="post-edited">(Last edited by <strong>collen</strong> on 15 Feb 2008, 12:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p63917">
				<div class="post-metadata">
					<div class="post-num">Post #130</div>
					<div class="post-author">dotb52</div>
					<div class="post-datetime">
						23 Feb 2008, 00:08					</div>
				</div>
				<div class="post-content content">
					<p>Hey,</p><p>im runnin a Buffalo WHR-HP-G54.<br/>kamikaze_0.7<br/>sd: ScanDisk 512mb</p><p>i used the following layout:<br/>SD_CS -&gt; GPIO 1 (Bridge LED)<br/>SD_DO -&gt; GPIO 6 (AOSS LED)<br/>SD_CLK -&gt; GPIO 3 (Uninstalled LED)<br/>SD_DI -&gt; GPIO 5 (Auto/Bridge switch)</p><p>i got the src of 1.3.4 and changed the config.h to:<br/></p><div class="codebox"><pre><code>#define LOG_LEVEL 3
#define USE_CMD18
#define USE_CMD25

/* GPIO pin 2 */
//#define SD_DI 0x04
#define SD_DI 0x20
/* GPIO pin 4 */
//#define SD_DO 0x10
#define SD_DO 0x40
/* GPIO pin 3 */
#define SD_CLK 0x08
/* GPIO pin 7 */
#define SD_CS 0x02

#if SD_DO == 0x10
    #define SHIFT_DO 3
#else
#if SD_DO == 0x40
    #define SHIFT_DO 1
#endif
#endif
#if SD_DI == 0x04
    #define SHIFT_DI 5
#else
#if SD_DI == 0x20
    #define SHIFT_DI 2
#endif
#endif</code></pre></div><p>and i always get this message:<br/></p><div class="codebox"><pre><code>[INFO] mmc_hardware_init: initializing GPIOs
[INFO] mmc_card_init: the period of a 380KHz frequency lasts 524 CPU cycles
[INFO] mmc_card_init: powering card on. sending 80 CLK
[INFO] mmc_card_init: 80 CLK sent in 44136 CPU cycles
[INFO] mmc_card_init: resetting card (CMD0)
[FATAL] mmc_card_init: invalid response from card: ff found, waiting for 01
[INFO] mmc_card_init: the period of a 380KHz frequency lasts 524 CPU cycles
[INFO] mmc_card_init: powering card on. sending 80 CLK
[INFO] mmc_card_init: 80 CLK sent in 43306 CPU cycles
[INFO] mmc_card_init: resetting card (CMD0)
[FATAL] mmc_card_init: invalid response from card: ff found, waiting for 01
[ERROR] mmc_init: got an error calling mmc_card_init: 01
[ERROR] mmc_check_media: change detected but was not able to initialize new card: ffffffff</code></pre></div><p>any ideas?</p><br/><p>Edit:<br/>i tried the mmc.c from <a href="http://wiki.openwrt.org/OpenWrtDocs/Customizing/Hardware/MMC?highlight=%28mmc%29">http://wiki.openwrt.org/OpenWrtDocs/Customizing/Hardware/MMC?highlight=%28mmc%29</a> (1.4)<br/>seems to work, i just mnted the sd card and wrote some stuff<br/>speed suxx like hell ,)</p><p>dmesg:<br/></p><div class="codebox"><pre><code>mmc: Device does not use v1 GPIO layout, trying to use v4 layout
mmc: Device does not use v4 layout, trying to use Buffalo layout
Size = 495488, hardsectsize = 512, sectors = 990976
Partition check:
 mmca: p1</code></pre></div><p>Edit:<br/>i tried dd-wrt with mmc, works fijne with manual gpio layout definition<br/>write: 197 kb/s<br/>read: 256 kb/s</p><p>dmesg:<br/></p><div class="codebox"><pre><code>mmc: starting module with: SD_DI=0x40, SD_DO=0x20, SD_CLK=0x8, SD_CS=0x2
Size = 495488, hardsectsize = 512, sectors = 990976
Partition check:
 mmca: p1
EXT2-fs warning: mounting unchecked fs, running e2fsck is recommended</code></pre></div>											<p class="post-edited">(Last edited by <strong>dotb52</strong> on 23 Feb 2008, 17:38)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p64451">
				<div class="post-metadata">
					<div class="post-num">Post #131</div>
					<div class="post-author">$@m</div>
					<div class="post-datetime">
						3 Mar 2008, 00:54					</div>
				</div>
				<div class="post-content content">
					<p>how do you test read/write ?</p><p>mmc 1.3.4 is ok with SD emet 2Go 60x ~400ko/s read</p>											<p class="post-edited">(Last edited by <strong>$@m</strong> on 3 Mar 2008, 01:24)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p66430">
				<div class="post-metadata">
					<div class="post-num">Post #132</div>
					<div class="post-author">snipers</div>
					<div class="post-datetime">
						7 Apr 2008, 00:24					</div>
				</div>
				<div class="post-content content">
					<p>i have wrt54g v2 </p><p>i connect mmc card to him</p><p>i test all gpio with led albo its blinking when i run <br/></p><div class="codebox"><pre><code>while true; do gpio enable 5; sleep 1; gpio disable 5; sleep 1; done</code></pre></div><p>but its little problem if i run &quot;gpio enable 7&quot; (DMZ LED) its turn OFF and if &quot;gpio disable 7&quot; the its ON </p><p>maybe this is a problem , card not work</p><p>or mmc.o is bad </p><p>help</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p67519">
				<div class="post-metadata">
					<div class="post-num">Post #133</div>
					<div class="post-author">forum2008</div>
					<div class="post-datetime">
						28 Apr 2008, 00:27					</div>
				</div>
				<div class="post-content content">
					<p>Seems dead. But I don&#039;t care for 2.4 kernel any more.</p><p>And for 2.6 kernels their is a new mmc-over-gpio driver in the trunk source which works good <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p67599">
				<div class="post-metadata">
					<div class="post-num">Post #134</div>
					<div class="post-author">dinek889</div>
					<div class="post-datetime">
						29 Apr 2008, 21:01					</div>
				</div>
				<div class="post-content content">
					<p>Hi<br/>I need mmc driver for gpio 0,6,12 and 14 pins for my wap54g...<br/>I use this howto:http://panteltje.com/panteltje/wap54g/to-linksys-wap54g-forum-2.txt and I&#039;m using soft from this site now, but I have:<br/></p><div class="codebox"><pre><code>Jan  1 00:45:46 (none) daemon.warn klogd: mmc Hardware init
Jan  1 00:45:46 (none) daemon.warn klogd: mmc Card init
Jan  1 00:45:46 (none) daemon.warn klogd: mmc Card init
Jan  1 00:45:46 (none) daemon.warn klogd&gt; &gt; error in mmc_card_init (1)
Jan  1 00:45:46 (none) daemon.warn klogd: mmc: error in mmc_init (-1)</code></pre></div><p>What can I do? <br/>I can&#039;t download src for mmc driver.(site is down)<br/>Please help my <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p>											<p class="post-edited">(Last edited by <strong>dinek889</strong> on 29 Apr 2008, 21:02)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p67650">
				<div class="post-metadata">
					<div class="post-num">Post #135</div>
					<div class="post-author">bss</div>
					<div class="post-datetime">
						30 Apr 2008, 23:59					</div>
				</div>
				<div class="post-content content">
					<p>Hey guys!! great work!!</p><p>The links seem to be offline or broken... you might wanna check your hosting....it would be really great if you could fix those download links...<br/>or just send me a compiled version of the newest dirver GPIO2 (used this tutorial to make it: <a href="http://www.hendlsofen.de/WRT54GL/eng/WRT54GL_SDMod.html)">http://www.hendlsofen.de/WRT54GL/eng/WRT54GL_SDMod.html)</a> for WRT54GL 1.1 (i would like to use it with kamikaze) on my mail: kantta@gmail.com</p><p>Right now i have tired many drivers from different pages, but i have no /dev/mmc/ device in dev directory.... so i would like to use THE drivers!</p><p>Cuz that would be just great!!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p74522">
				<div class="post-metadata">
					<div class="post-num">Post #136</div>
					<div class="post-author">dinek889</div>
					<div class="post-datetime">
						10 Oct 2008, 23:04					</div>
				</div>
				<div class="post-content content">
					<p>Hi all,<br/>I&#039;m done this mod on my wap54g:<br/>here is a firmware(with compiled mmc driver - optimized) and howto(gpio: 3,4,6 oraz 7):<br/><a href="http://www.linksys.chyl.org/readarticle.php?article_id=1">http://www.linksys.chyl.org/readarticle.php?article_id=1</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p78649">
				<div class="post-metadata">
					<div class="post-num">Post #137</div>
					<div class="post-author">z0rg</div>
					<div class="post-datetime">
						26 Dec 2008, 13:52					</div>
				</div>
				<div class="post-content content">
					<p>Hi everybody. <br/>Do you can explain me how i can use mmc/sd card under Kamikaze 8.09_RC1 with 2.6 kernel? <br/>Previously i use Witerusssian, and everithing work fine,&nbsp; but now i not have right software ( kernel mod) for use mmc. <br/>I already&nbsp; install kmod-mmc&nbsp; but is not work.<br/>kmod-mmc-over-gpio_2.6.25.17-brcm47xx-2_mipsel<br/>kmod-mmc-spi_2.6.25.17-brcm47xx-1_mipsel<br/>kmod-mmc_2.6.25.17-brcm47xx-1_mipsel</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p79413">
				<div class="post-metadata">
					<div class="post-num">Post #138</div>
					<div class="post-author">kloklosek</div>
					<div class="post-datetime">
						10 Jan 2009, 15:28					</div>
				</div>
				<div class="post-content content">
					<p>Hi</p><p>I had many problems running mmc driver in openwrt (no problem in dd-wrt)&nbsp; on wrt54gl 1.1<br/>now i have kamikaze 8.09 2.4 and latest driver from this topic, everything works but writing is exremely slow<br/>about 30-40 KB/s <br/>i realized that after booting if i unmount mmc partition remove mmc module, load it and mount partition one more time everything is ok, reading and writing times such as others have (32 mb, 1m 18s - write)<br/>so what&#039;s wrong with it? <br/>this is my script loading mmc and mounting partiton:<br/>cat /etc/init.d/mountmmc<br/>#!/bin/sh<br/>echo &quot;0x9c&quot; &gt; /proc/diag/gpiomask<br/>insmod mmc<br/>mount /mmc<br/>sleep 8s<br/>swapon /dev/mmc/disc0/part2 -p 5<br/>and /etc/fstab contains (i have modified /etc/config/fstab)<br/>/dev/mmc/disc0/part1&nbsp; &nbsp; /mmc&nbsp; &nbsp; ext2&nbsp; &nbsp; noauto,rw,sync&nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp;0<br/>it&#039;s strange for me, what i did wrong?</p><p>ps. mounting swap in this script doesn&#039;t work also, why ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p81322">
				<div class="post-metadata">
					<div class="post-num">Post #139</div>
					<div class="post-author">bahko2</div>
					<div class="post-datetime">
						7 Feb 2009, 20:02					</div>
				</div>
				<div class="post-content content">
					<p>Sorry but can someone upload mmc-bufalo.tgz from <a href="http://www.partners.biz/dd-wrt/mmc-buffalo.tar">http://www.partners.biz/dd-wrt/mmc-buffalo.tar</a> because the site is down <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad"/><br/>MY configuration is:<br/>3 CLK<br/>6 DO<br/>7 CS<br/>5 DI</p><p>Thanks in advance</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p81331">
				<div class="post-metadata">
					<div class="post-num">Post #140</div>
					<div class="post-author">Yanira</div>
					<div class="post-datetime">
						7 Feb 2009, 20:38					</div>
				</div>
				<div class="post-content content">
					<p>Compile by yourself.....</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p81504">
				<div class="post-metadata">
					<div class="post-num">Post #141</div>
					<div class="post-author">flamemaniii</div>
					<div class="post-datetime">
						9 Feb 2009, 22:04					</div>
				</div>
				<div class="post-content content">
					<p>hello<br/>i&#039;m integrating the mmc_drv in the 2.6 kernel tree <br/>unfortunately i haven&#039;t understand the problem related to the 512Mb limit</p><p>i&#039;m using the first release of the mmc_drv (for fonera 2100) that has a limit of the first 512Mb of the mmc/sd card.</p><p>What exactly has been modified in that driver to support 1Gb 2Gb ... mmc/sd card ?</p><p>/*<br/> * Fonera MMC Driver<br/> *<br/> * 2003-2005 original idea by K. John Crispin, mail john@phrozen.org<br/>*/</p><p>(this driver has been used in fonera 2100 mcc<br/><a href="http://www.dd-wrt.com/wiki/index.php/Fonera_SD-Card_hack#MMC_BETA_driver_for_the_LaFonera">http://www.dd-wrt.com/wiki/index.php/Fonera_SD-Card_hack#MMC_BETA_driver_for_the_LaFonera</a><br/><a href="http://www.larsen-b.com/Article/262.html)">http://www.larsen-b.com/Article/262.html)</a></p>											<p class="post-edited">(Last edited by <strong>flamemaniii</strong> on 10 Feb 2009, 03:32)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p81505">
				<div class="post-metadata">
					<div class="post-num">Post #142</div>
					<div class="post-author">flamemaniii</div>
					<div class="post-datetime">
						9 Feb 2009, 22:06					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>forum2008 wrote:</cite><blockquote><p>And for 2.6 kernels their is a new mmc-over-gpio driver in the trunk source which works good <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p></blockquote></div><p>where is it ?</p><p>could you post the source ?</p>											<p class="post-edited">(Last edited by <strong>flamemaniii</strong> on 9 Feb 2009, 22:29)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p81507">
				<div class="post-metadata">
					<div class="post-num">Post #143</div>
					<div class="post-author">Yanira</div>
					<div class="post-datetime">
						9 Feb 2009, 22:09					</div>
				</div>
				<div class="post-content content">
					<p>menuconfig / Kernel modules / Other modules / kmod-mmc-over-gpio</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p81511">
				<div class="post-metadata">
					<div class="post-num">Post #144</div>
					<div class="post-author">flamemaniii</div>
					<div class="post-datetime">
						9 Feb 2009, 22:42					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Yanira wrote:</cite><blockquote><p>menuconfig / Kernel modules / Other modules / kmod-mmc-over-gpio</p></blockquote></div><p>i mean where are sources inside the trunk</p><p>ls trunk/package/mmc_over_gpio/files/ </p><p>.svn/&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>mmc_over_gpio.config&nbsp; <br/>mmc_over_gpio.init </p><br/><br/><p>no .c found </p><p>i have to manually include them inside my kernel tree</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p81513">
				<div class="post-metadata">
					<div class="post-num">Post #145</div>
					<div class="post-author">Yanira</div>
					<div class="post-datetime">
						9 Feb 2009, 23:10					</div>
				</div>
				<div class="post-content content">
					<p>It&#039;s the driver from the Linux Kernel...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p81518">
				<div class="post-metadata">
					<div class="post-num">Post #146</div>
					<div class="post-author">flamemaniii</div>
					<div class="post-datetime">
						10 Feb 2009, 01:22					</div>
				</div>
				<div class="post-content content">
					<p>ok if you mean the following</p><p>/*<br/> * Driver for driving an MMC card over a bitbanging GPIO SPI bus.<br/> *<br/> * 2008 Michael Buesch &lt;mb@bu3sch.de&gt;<br/> *<br/> */</p><p>it has documentation&nbsp; uc-gentoo-2.6.26.8-fonera/Documentation/gpiommc.txt</p><div class="quotebox"><blockquote><p>GPIOMMC - Driver for an MMC/SD card on a bitbanging GPIO SPI bus<br/>================================================================</p><p>The gpiommc module hooks up the mmc_spi and spi_gpio modules for running an<br/>MMC or SD card on GPIO pins.</p><p>Two interfaces for registering a new MMC/SD card device are provided:<br/>A static platform-device based mechanism and a dynamic configfs based interface.</p><br/><p>Registering devices via platform-device<br/>=======================================</p><p>The platform-device interface is used for registering MMC/SD devices that are<br/>part of the hardware platform. This is most useful only for embedded machines<br/>with MMC/SD devices statically connected to the platform GPIO bus.</p><p>The data structures are declared in &lt;linux/mmc/gpiommc.h&gt;.</p><p>To register a new device, define an instance of struct gpiommc_platform_data.<br/>This structure holds any information about how the device is hooked up to the<br/>GPIO pins and what hardware modes the device supports. See the docbook-style<br/>documentation in the header file for more information on the struct fields.</p><p>Then allocate a new instance of a platform device by doing:</p><p>&nbsp; &nbsp; &nbsp; &nbsp; pdev = platform_device_alloc(GPIOMMC_PLATDEV_NAME, gpiommc_next_id());</p><p>This will allocate the platform device data structures and hook it up to the<br/>gpiommc driver.<br/>Then add the gpiommc_platform_data to the platform device.</p><p>&nbsp; &nbsp; &nbsp; &nbsp; err = platform_device_add_data(pdev, pdata, sizeof(struct gpiommc_platform_data));</p><p>You may free the local instance of struct gpiommc_platform_data now. (So the<br/>struct may be allocated on the stack, too).<br/>Now simply register the platform device.</p><p>&nbsp; &nbsp; &nbsp; &nbsp; err = platform_device_add(pdev);</p><p>Done. The gpiommc probe routine will be invoked now and you should see a kernel<br/>log message for the added device.</p><br/><p>Registering devices via configfs<br/>================================</p><p>MMC/SD cards connected via GPIO often are a pretty dynamic thing, as for example<br/>selfmade hacks for soldering an MMC/SD card to standard GPIO pins on embedded<br/>hardware are a common situation.<br/>So we provide a dynamic interface to conveniently handle adding and removing<br/>devices from userspace, without the need to recompile the kernel.</p><p>The &quot;gpiommc&quot; subdirectory at the configfs mountpoint is used for handling<br/>the dynamic configuration.</p></blockquote></div><p>i don&#039;t like this part</p><div class="quotebox"><blockquote><p>To create a new device, it must first be allocated with mkdir.<br/>The following command will allocate a device named &quot;my_mmc&quot;:<br/>&nbsp; &nbsp; &nbsp; &nbsp; mkdir /config/gpiommc/my_mmc</p><p>There are several configuration files available in the new<br/>/config/gpiommc/my_mmc/ directory:</p><p>gpio_data_in&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = The SPI data-IN GPIO pin number.<br/>gpio_data_out&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= The SPI data-OUT GPIO pin number.<br/>gpio_clock&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = The SPI Clock GPIO pin number.<br/>gpio_chipselect&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= The SPI Chipselect GPIO pin number.<br/>gpio_chipselect_activelow&nbsp; &nbsp; &nbsp; &nbsp;= Boolean. If 0, Chipselect is active-HIGH.<br/>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; If 1, Chipselect is active-LOW.<br/>spi_mode&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = The SPI data mode. Can be 0-3.<br/>spi_delay&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= Enable all delays in the lowlevel bitbanging.<br/>max_bus_speed&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= The maximum SPI bus speed. In Hertz.</p><p>The device must first get configured and then registered by writing &quot;1&quot; to<br/>the &quot;register&quot; file.<br/>The configuration parameters &quot;gpio_data_in&quot;, &quot;gpio_data_out&quot;, &quot;gpio_clock&quot;<br/>and &quot;gpio_chipselect&quot; are essential and _must_ be configured before writing<br/>&quot;1&quot; to the &quot;register&quot; file. The registration will fail, otherwise.</p><p>The default values for the other parameters are:<br/>gpio_chipselect_activelow&nbsp; &nbsp; &nbsp; &nbsp;= 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(CS active-LOW)<br/>spi_mode&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(SPI_MODE_0)<br/>spi_delay&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(enabled)<br/>max_bus_speed&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 5000000&nbsp; &nbsp; &nbsp; &nbsp;(5 Mhz)</p><p>Configuration values can not be changed after registration. To unregister<br/>the device, write a &quot;0&quot; to the &quot;register&quot; file. The configuration can be<br/>changed again after unregistering.</p><p>To completely remove the device, simply rmdir the directory<br/>(/config/gpiommc/my_mmc in this example).<br/>There&#039;s no need to first unregister the device before removing it. That will<br/>be done automatically.</p></blockquote></div><p>i don&#039;t like that cause i have to bootstrap directly with root=/dev/mmc2, so this dynamic mechanism makes me to do an initram where to boot (root=/dev/ram0) and to root_pivot to /dev/mmc2</p><p>mmm my question is: is it possible to have a static configuration of the GPIO pins hardly compiled in the kernel ?</p>											<p class="post-edited">(Last edited by <strong>flamemaniii</strong> on 10 Feb 2009, 03:20)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p82515">
				<div class="post-metadata">
					<div class="post-num">Post #147</div>
					<div class="post-author">okar</div>
					<div class="post-datetime">
						24 Feb 2009, 00:16					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>z0rg wrote:</cite><blockquote><p>Hi everybody.<br/>Do you can explain me how i can use mmc/sd card under Kamikaze 8.09_RC1 with 2.6 kernel?<br/>Previously i use Witerusssian, and everithing work fine,&nbsp; but now i not have right software ( kernel mod) for use mmc.<br/>I already&nbsp; install kmod-mmc&nbsp; but is not work.<br/>kmod-mmc-over-gpio_2.6.25.17-brcm47xx-2_mipsel<br/>kmod-mmc-spi_2.6.25.17-brcm47xx-1_mipsel<br/>kmod-mmc_2.6.25.17-brcm47xx-1_mipsel</p></blockquote></div><p>has anyone got a sd card running with kmod-mmc-over-gpio<br/>how do you use this module? does it use /proc/diag/gpiomask, too? does it work flawless.<br/>want to be sure I can use my sd-card before switching to 2.6.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p82516">
				<div class="post-metadata">
					<div class="post-num">Post #148</div>
					<div class="post-author">Yanira</div>
					<div class="post-datetime">
						24 Feb 2009, 00:21					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>okar wrote:</cite><blockquote><p>has anyone got a sd card running with kmod-mmc-over-gpio</p></blockquote></div><p>Yes, but not on Broadcom hardware. One on La Fonera (fon2100) and the other one one a D-Link DIR-300. Both working fine.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p82924">
				<div class="post-metadata">
					<div class="post-num">Post #149</div>
					<div class="post-author">flamemaniii</div>
					<div class="post-datetime">
						1 Mar 2009, 00:55					</div>
				</div>
				<div class="post-content content">
					<p>i opened this project -&gt; <a href="http://www.elinux.org/Flameman/fonera">http://www.elinux.org/Flameman/fonera</a><br/>and a full and complete drive rewrite has been started</p>											<p class="post-edited">(Last edited by <strong>flamemaniii</strong> on 1 Mar 2009, 02:25)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85676">
				<div class="post-metadata">
					<div class="post-num">Post #150</div>
					<div class="post-author">opensys</div>
					<div class="post-datetime">
						12 Apr 2009, 15:15					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>I compiled this driver for kamikaze 8.09 kernel 2.4.35.4</p><p>But seams that not working.<br/>I have wrt54gl device working with mmc/sd card in whiterussian and at old past time he works in dd-wrt.</p><p>now in kamikaze 8.09&nbsp; with wrt54gl have:</p><p>[INFO] mmc_hardware_init: initializing GPIOs<br/>[INFO] mmc_card_init: the period of a 380KHz frequency lasts 654 CPU cycles<br/>[INFO] mmc_card_init: powering card on. sending 80 CLK<br/>[INFO] mmc_card_init: 80 CLK sent in 53726 CPU cycles<br/>[INFO] mmc_card_init: resetting card (CMD0)<br/>[FATAL] mmc_card_init: invalid response from card: ff found, waiting for 01<br/>[INFO] mmc_card_init: the period of a 380KHz frequency lasts 654 CPU cycles<br/>[INFO] mmc_card_init: powering card on. sending 80 CLK<br/>[INFO] mmc_card_init: 80 CLK sent in 53327 CPU cycles<br/>[INFO] mmc_card_init: resetting card (CMD0)<br/>[FATAL] mmc_card_init: invalid response from card: ff found, waiting for 01<br/>[ERROR] mmc_init: got an error calling mmc_card_init: 01<br/>[ERROR] mmc_check_media: change detected but was not able to initialize new card: ffffffff</p><p>I tested this driver because the kmod-broadcom-mmc_2.4.35.4+0.1-brcm-2.4-1_mipsel.ipk was not work.</p><p>Please help.</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 6 of 7</div><nav><ul><li><a href="viewtopic.php%3Fid=9653&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=9653&amp;p=4.html">4</a></li><li><a href="viewtopic.php%3Fid=9653&amp;p=5.html">5</a></li><li class="pagination-current"><span>6</span></li><li><a href="viewtopic.php%3Fid=9653&amp;p=7.html">7</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>