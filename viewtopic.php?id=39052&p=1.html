<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> mwan3; multi-wan policy routing (general topic)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 22 May 2013 and 6 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 65</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=3.html">3</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p176616">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						1 Sep 2012, 15:34					</div>
				</div>
				<div class="post-content content">
					<p>Hi guys,</p><p>In succession of mwan2, i have made a new multi-wan script called mwan3. With the lessons i&#039;ve learned making mwan2, i realized that the approach i took was not as efficient and configurable as it should be. Therefor i have created mwan3, which should resolve these issues. The reason i named it mwan3 and not a new version of mwan2 is because the config file changed quite a bit. If you were to upgrade this would break mwan2. I&#039;d really like it if you could give it a go and let me know what you think of it.</p><p><em>edit: mwan svn repository is down. Please use git: <a href="https://github.com/Adze1502/mwan">https://github.com/Adze1502/mwan</a></em><br /><em>edit2: With version 1.1, you can now ping multiple hosts per wan interface to check if it is still up. With the option reliability you set how many hosts should at least reply each round of testing, before triggering the interface as down. See the config example on how to configure it.</em><br /><em>edit3: With the great help from Arfett, mwan3 now has a luci web interface. With this addition it is really easy to configure a multi-wan OpenWrt router. Thanks Arfett !!</em><br /><em>edit4: GitHub repo is up: <a href="https://github.com/Adze1502/mwan">https://github.com/Adze1502/mwan</a> . svn repo is down. Please update your &quot;feeds.conf&quot; file with the line &quot;src-git mwan git://github.com/Adze1502/mwan.git&quot; and remove the old svn repo.</em><br /><em>edit5: New 1.4 version release which which should solve all load-balancing issues in previous release, like problem with wan connections not comming back online correctly.</em></p><p>The mwan3 package and the mwan3 luci app:<br /><a href="http://213.136.13.52/mwan3_latest_all.ipk">http://213.136.13.52/mwan3_latest_all.ipk</a><br /><a href="http://213.136.13.52/luci-app-mwan3_latest_all.ipk">http://213.136.13.52/luci-app-mwan3_latest_all.ipk</a></p><p>And the source:<br />git://github.com/Adze1502/mwan.git</p><p><strong>What is mwan3:</strong><br />Mwan3 is a couple of lines of code that simplifies the usage of more (up to 250) WAN interfaces in OpenWRT. It is hotplug driven and it allows for any combination of primary, secondary or more failover interfaces, load balanced or not, for any combination of traffic. Mwan3 makes policy routing with multiple wan&#039;s easy. Mwan3 can monitor the state of interfaces by sending pings to a configured tracking host and failover if necessary.</p><p><strong>Why should i use mwan3?:</strong><br />- If you have multiple internet connections, you want to control which traffic goes through which wan&#039;s.<br />- Mwan3 can handle multiple levels of primary and backup interfaces, load-balanced or not. Different sources can have different primary or backup wan&#039;s.<br />- Mwan3 uses flowmask to be compatible with other packages (such as OpenVPN, PPTP VPN, QoS-script, Tunnels, etc) as you can configure traffic to use the default routing table.<br />- Mwan3 can also load-balance traffic originating from the router itself.</p><p><strong>Requirements:</strong><br />Mwan3 is successfully tested on OpenWRT trunk r40512. You need the following packages (which should be installed automatically if missing): ip, iptables, iptables-mod-conntrack, iptables-mod-conntrack-extra, iptables-mod-ipopt. Mwan3 is limited to max 250 wan interfaces.</p><p><strong>How does it work:</strong><br />Mwan3 is triggered by hotplug-events. When an interface comes up it creates a new routing table and new iptables rules. A new routing table is created for each interface. It then sets up iptables rules and uses iptables MARK to mark certain traffic. Based on ip rules the kernel determines which routing table to use. When an interface goes down, mwan3 deletes all the rules and routes to that interface in all created routing tables.</p><p>Mwan3 is not a daemon that runs in the background. Ones all the routes and rules are in place, it exits. The kernel takes care of all the routing decisions. If you want to apply a change you have made to mwan3 configuration, you have to trigger a hotplug event (replace eth1 and wan with your values):<br /></p><div class="codebox"><pre><code>ACTION=ifup DEVICE=eth1 INTERFACE=wan /sbin/hotplug-call iface</code></pre></div><p>or you could bring up the interface using a mwan3 command:<br /></p><div class="codebox"><pre><code>mwan3 ifup wan</code></pre></div><p><strong>How to install and configure:</strong><br /><em>Please check the wiki <a href="http://wiki.openwrt.org/doc/howto/mwan3">http://wiki.openwrt.org/doc/howto/mwan3</a> for the more info.</em></p><p>I&#039;ll assume here you have a clean install of OpenWRT. Before installing mwan3, you need to make sure that all of your wan interfaces are correctly configured and work. Place a different metric on each WAN interface! This metric has only effect on the default routing table, not on the mwan3 routing tables. If it is configured correctly you should have a default gateway with a different metric set for each WAN interface. Something will look like this:<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         213.154.232.9   0.0.0.0         UG    10     0        0 eth1
0.0.0.0         192.168.33.1    0.0.0.0         UG    20     0        0 eth0.2
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan
192.168.33.0    0.0.0.0         255.255.255.0   U     20     0        0 eth0.2
213.154.232.8   0.0.0.0         255.255.255.248 U     10     0        0 eth1</code></pre></div><p>Check if above configuration works by trying to ping <a href="http://www.google.com">www.google.com</a> form each interface:<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# ping -c 1 -I eth1 www.google.com
PING www.google.com (74.125.136.106): 56 data bytes
64 bytes from 74.125.136.106: seq=0 ttl=50 time=23.012 ms

--- www.google.com ping statistics ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 23.012/23.012/23.012 ms
root@OpenWrt:~# ping -c 1 -I eth0.2 www.google.com
PING www.google.com (74.125.136.104): 56 data bytes
64 bytes from 74.125.136.104: seq=0 ttl=47 time=17.562 ms

--- www.google.com ping statistics ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 17.562/17.562/17.562 ms</code></pre></div><p>If above ping test are successful, you can then continue installing mwan3. If you cannot ping <a href="http://www.google.com">www.google.com</a> from all your WAN interfaces, there is a problem with your config and installing mwan3 won&#039;t fix that!</p><p>After installing mwan3, configure it by editting /etc/config/mwan3. For each WAN interface create an interface with a name that matches the one used in /etc/config/network. The status of each interface can be monitored with the track_ip option. Create at least two members. A member is a virtual representation of a wan interface. Each member can have different metric and or weight values. Members are used to make up a routing policy. Create a routing policy of at least one member. Members within one policy with a lower metric have precedence over higher metric members. Members with the same metric will load-balance. Load balancing members (with same metric) will distribute load based on those weights values.</p><p>After that, configure the rules. With the rules you can direct types of traffic based on ip, protocol or ports to certain policies, or use the default routing table by choosing &quot;default&quot;. The order of the rules is very important, as they are loaded in that order. If a rule is matched, but all listed WAN interfaces/members are down, traffic is blackholed.</p><br /><p><strong>Example configuration</strong><br /></p><div class="codebox"><pre><code>config interface &#039;wan&#039;
    option enabled &#039;1&#039;
    list track_ip &#039;8.8.4.4&#039;
    list track_ip &#039;8.8.8.8&#039;
    list track_ip &#039;208.67.222.222&#039;
    list track_ip &#039;208.67.220.220&#039;
    option reliability &#039;2&#039;
    option count &#039;1&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;8&#039;

config interface &#039;wan2&#039;
    option enabled &#039;1&#039;
    list track_ip &#039;8.8.8.8&#039;
    list track_ip &#039;208.67.220.220&#039;
    option reliability &#039;1&#039;
    option count &#039;1&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;8&#039;

config member &#039;wan_m1_w3&#039;
    option interface &#039;wan&#039;
    option metric &#039;1&#039;
    option weight &#039;3&#039;

config member &#039;wan_m2_w3&#039;
    option interface &#039;wan&#039;
    option metric &#039;2&#039;
    option weight &#039;3&#039;

config member &#039;wan2_m1_w2&#039;
    option interface &#039;wan2&#039;
    option metric &#039;1&#039;
    option weight &#039;2&#039;

config member &#039;wan2_m2_w2&#039;
    option interface &#039;wan2&#039;
    option metric &#039;2&#039;
    option weight &#039;2&#039;

config policy &#039;wan_only&#039;
    list use_member &#039;wan_m1_w3&#039;

config policy &#039;wan2_only&#039;
    list use_member &#039;wan2_m1_w2&#039;

config policy &#039;balanced&#039;
    list use_member &#039;wan_m1_w3&#039;
    list use_member &#039;wan2_m1_w2&#039;

config policy &#039;wan_wan2&#039;
    list use_member &#039;wan_m1_w3&#039;
    list use_member &#039;wan2_m2_w2&#039;

config policy &#039;wan2_wan&#039;
    list use_member &#039;wan_m2_w3&#039;
    list use_member &#039;wan2_m1_w2&#039;

config rule &#039;example_1&#039;
    option dest_ip &#039;213.136.223.128/25&#039;
    option dest_port &#039;80&#039;
    option proto &#039;tcp&#039;
    option use_policy &#039;wan_wan2&#039;

config rule &#039;example_2&#039;
    option src_ip &#039;1.2.3.4&#039;
    option dest_ip &#039;5.6.7.8&#039;
    option src_port &#039;12345:54321&#039;
    option dest_port &#039;12345:54321&#039;
    option proto &#039;udp&#039;
    option use_policy &#039;wan2_wan&#039;

config rule &#039;default_rule&#039;
    option dest_ip &#039;0.0.0.0/0&#039;
    option use_policy &#039;balanced&#039;</code></pre></div><p><em>The wiki page <a href="http://wiki.openwrt.org/doc/howto/mwan3">http://wiki.openwrt.org/doc/howto/mwan3</a> has more more info on this.</em></p><p>Now you&#039;re almost good to go. Last thing you should do is make sure the your firewall configuration allows traffic from lan to wan&#039;s and make sure the default OUTPUT policy is set to ACCEPT!<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# cat /etc/config/firewall 

config defaults
    option syn_flood &#039;1&#039;
    option input &#039;ACCEPT&#039;
    option output &#039;ACCEPT&#039;
    option forward &#039;REJECT&#039;
    option drop_invalid &#039;1&#039;

config zone
    option name &#039;lan&#039;
    list network &#039;lan&#039;
    option input &#039;ACCEPT&#039;
    option output &#039;ACCEPT&#039;
    option conntrack &#039;1&#039;
    option forward &#039;REJECT&#039;

config zone
    option name &#039;wan&#039;
    list network &#039;wan&#039;
    list network &#039;wan2&#039;
    option input &#039;REJECT&#039;
    option output &#039;ACCEPT&#039;
    option forward &#039;REJECT&#039;
    option masq &#039;1&#039;
    option conntrack &#039;1&#039;

config forwarding
    option src &#039;lan&#039;
    option dest &#039;wan&#039;</code></pre></div><p>Reboot your router and try if everything works. If not please feel free to ask your questions in this thread.</p><p><strong>Status of load-balancing:</strong><br />The command &quot;mwan3 status&quot; shows you the current state. It lists the state of each configured wan and the current output strategy for each policy. It also shows you a list of network which are &quot;local&quot; and not balanced. The last table lists the mwan3 rules currently active and it&#039;s policy. <br /></p><div class="codebox"><pre><code>root@OpenWrt:~# mwan3 status
Interface status:
Interface wan is online (tracking active)
Interface wan2 is online (tracking active)

Policy balanced:
 wan2 (40%)
 wan (60%)

Policy wan1_only:
 wan (100%)

Policy wan2_only:
 wan2 (100%)

Policy wan2_wan:
 wan2 (100%)

Policy wan_wan2:
 wan (100%)

Local connected networks:
destination        policy             hits     
------------------------------------------------
127.0.0.0/8        default            92       
224.0.0.0/3        default            4        
192.168.1.0/24     default            0        
192.168.33.0/24    default            4        
213.154.232.8/29   default            4        

Active rules:
source             destination        proto  src-port      dest-port     policy          hits     
---------------------------------------------------------------------------------------------------
0.0.0.0/0          213.136.223.128/25 tcp    0:65535       80            wan_wan2        0        
1.2.3.4            5.6.7.8            udp    12345:54321   12345:54321   wan2_wan        0        
0.0.0.0/0          0.0.0.0/0          all                                balanced        20533</code></pre></div><p><strong>Troubleshooting (if necessary):</strong><br /></p><div class="codebox"><pre><code>root@OpenWrt:~# logread | grep mwan3
Tue Apr 15 14:47:33 2014 user.notice mwan3: ifup interface wan (eth1)
Tue Apr 15 14:47:47 2014 user.notice mwan3: ifup interface wan2 (eth0.2)

root@OpenWrt:~# iptables -L -t mangle -v -n -w
Chain PREROUTING (policy ACCEPT 84533 packets, 50M bytes)
 pkts bytes target     prot opt in     out     source               destination         
 101K   54M mwan3_hook  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain OUTPUT (policy ACCEPT 21796 packets, 1953K bytes)
 pkts bytes target     prot opt in     out     source               destination         
31676 3119K mwan3_hook  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain mwan3_connected (1 references)
 pkts bytes target     prot opt in     out     source               destination         
  102  7198 MARK       all  --  *      *       0.0.0.0/0            127.0.0.0/8          mark match 0x0/0xff00 MARK or 0xff00
    4   292 MARK       all  --  *      *       0.0.0.0/0            224.0.0.0/3          mark match 0x0/0xff00 MARK or 0xff00
    0     0 MARK       all  --  *      *       0.0.0.0/0            192.168.1.0/24       mark match 0x0/0xff00 MARK or 0xff00
    6   725 MARK       all  --  *      *       0.0.0.0/0            192.168.33.0/24      mark match 0x0/0xff00 MARK or 0xff00
    9   604 MARK       all  --  *      *       0.0.0.0/0            213.154.232.8/29     mark match 0x0/0xff00 MARK or 0xff00

Chain mwan3_hook (2 references)
 pkts bytes target     prot opt in     out     source               destination         
 133K   57M CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0            CONNMARK restore mask 0xff00
31717 2695K mwan3_ifaces  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00
29628 2449K mwan3_connected  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00
28819 2388K mwan3_rules  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00
 133K   57M CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0            CONNMARK save mask 0xff00

Chain mwan3_iface_wan (1 references)
 pkts bytes target     prot opt in     out     source               destination         
  211  7624 MARK       all  --  *      *       213.154.232.8/29     0.0.0.0/0            mark match 0x0/0xff00 /* wan */ MARK or 0xff00
  148  9892 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan */ MARK xset 0x100/0xff00

Chain mwan3_iface_wan2 (1 references)
 pkts bytes target     prot opt in     out     source               destination         
 1066  157K MARK       all  --  *      *       192.168.33.0/24      0.0.0.0/0            mark match 0x0/0xff00 /* wan2 */ MARK or 0xff00
  147  6006 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan2 */ MARK xset 0x200/0xff00

Chain mwan3_ifaces (1 references)
 pkts bytes target     prot opt in     out     source               destination         
  359 17516 mwan3_iface_wan  all  --  eth1   *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00
 1213  163K mwan3_iface_wan2  all  --  eth0.2 *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00

Chain mwan3_policy_balanced (1 references)
 pkts bytes target     prot opt in     out     source               destination         
 8663  719K MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 statistic mode random probability 0.39999999991 /* wan2 2 5 */ MARK xset 0x200/0xff00
12919 1073K MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan 3 3 */ MARK xset 0x100/0xff00

Chain mwan3_policy_wan1_only (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan 3 3 */ MARK xset 0x100/0xff00

Chain mwan3_policy_wan2_only (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan2 2 2 */ MARK xset 0x200/0xff00

Chain mwan3_policy_wan2_wan (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan2 2 2 */ MARK xset 0x200/0xff00

Chain mwan3_policy_wan_wan2 (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan 3 3 */ MARK xset 0x100/0xff00

Chain mwan3_rules (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 mwan3_policy_wan_wan2  tcp  --  *      *       0.0.0.0/0            213.136.223.128/25   multiport sports 0:65535 multiport dports 80 mark match 0x0/0xff00 /* example_1 */
    0     0 mwan3_policy_wan2_wan  udp  --  *      *       1.2.3.4              5.6.7.8              multiport sports 12345:54321 multiport dports 12345:54321 mark match 0x0/0xff00 /* example_2 */
21582 1792K mwan3_policy_balanced  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* default_rule */

root@OpenWrt:~# ip rule
0:    from all lookup local 
1001:    from all iif eth1 lookup main 
1002:    from all iif eth0.2 lookup main 
2001:    from all fwmark 0x100/0xff00 lookup 1 
2002:    from all fwmark 0x200/0xff00 lookup 2 
2254:    from all fwmark 0xfe00/0xff00 unreachable
32766:    from all lookup main 
32767:    from all lookup default 

root@OpenWrt:~# ip route
default via 213.154.232.9 dev eth1  proto static  metric 10 
default via 192.168.33.1 dev eth0.2  proto static  metric 20 
192.168.1.0/24 dev br-lan  proto kernel  scope link  src 192.168.1.1 
192.168.33.0/24 dev eth0.2  proto static  scope link  metric 20 
213.154.232.8/29 dev eth1  proto static  scope link  metric 10 

root@OpenWrt:~# ip route list table 1
default via 213.154.232.9 dev eth1 

root@OpenWrt:~# ip route list table 2
default via 192.168.33.1 dev eth0.2</code></pre></div>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 30 Mar 2015, 22:11)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p177476">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Bluse-Blue</div>
					<div class="post-datetime">
						8 Sep 2012, 19:52					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adze,</p><p>I just tested you multiwan package and it works well in my case with 2x dsl lines.<br />Is there a public repository (github, svn...) where I could access your source code ?</p><p>--&gt; got it <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I would be interested to adapt the luci-multiwan app to your script.</p><p>Bye Bluse</p>											<p class="post-edited">(Last edited by <strong>Bluse-Blue</strong> on 8 Sep 2012, 20:18)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p177477">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						8 Sep 2012, 20:13					</div>
				</div>
				<div class="post-content content">
					<p>The link to the source code is in the start post.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p177604">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						10 Sep 2012, 12:31					</div>
				</div>
				<div class="post-content content">
					<p>mwan svn repository is up: svn://213.136.13.52/var/svn/mwan, it is now much easier to add mwan to the openwrt trunk. Just add the line &quot;src-svn mwan svn://213.136.13.52/var/svn/mwan&quot; to the file &quot;feeds.conf.default&quot;.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178204">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						14 Sep 2012, 21:12					</div>
				</div>
				<div class="post-content content">
					<p>mwan3 works fine in failover or load balancing configurations for me. I have PMed you about your package.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178327">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						16 Sep 2012, 05:28					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m trying to failover between l2tp-&gt;wan-&gt;wan2</p><p>mwan3 never seems to detect the l2tp link as being up</p><p>/etc/config/network:<br /></p><div class="codebox"><pre><code>config interface &#039;l2tp0&#039;
        option _orig_ifname &#039;ppp0&#039;
        option _orig_bridge &#039;false&#039;
        option ifname &#039;ppp0&#039;
        option proto &#039;none&#039;</code></pre></div><p>/etc/config/mwan3<br /></p><div class="codebox"><pre><code>config interface &#039;wan&#039;
    option enabled &#039;1&#039;
    option track_ip &#039;8.8.8.8&#039;
    option count &#039;1&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;5&#039;

config interface &#039;wan2&#039;
    option enabled &#039;1&#039;
    option track_ip &#039;8.8.4.4&#039;
    option count &#039;1&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;5&#039;

config interface &#039;l2tp0&#039;
    option enabled &#039;1&#039;
    option track_ip &#039;8.8.8.8&#039;
    option count &#039;1&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;5&#039;

config interface &#039;l2tp1&#039;
    option enabled &#039;1&#039;
    option track_ip &#039;8.8.8.8&#039;
    option count &#039;1&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;5&#039;

config member &#039;wan_m1_w3&#039;
    option interface &#039;wan&#039;
    option metric &#039;1&#039;
    option weight &#039;3&#039;

config member &#039;wan_m2_w3&#039;
    option interface &#039;wan&#039;
    option metric &#039;2&#039;
    option weight &#039;3&#039;

config member &#039;wan_m3_w3&#039;
    option interface &#039;wan&#039;
    option metric &#039;3&#039;
    option weight &#039;3&#039;

config member &#039;wan_m4_w3&#039;
    option interface &#039;wan&#039;
    option metric &#039;4&#039;
    option weight &#039;3&#039;

config member &#039;wan2_m1_w3&#039;
    option interface &#039;wan2&#039;
    option metric &#039;1&#039;
    option weight &#039;3&#039;

config member &#039;wan2_m2_w3&#039;
    option interface &#039;wan2&#039;
    option metric &#039;2&#039;
    option weight &#039;3&#039;

config member &#039;wan2_m3_w3&#039;
    option interface &#039;wan2&#039;
    option metric &#039;3&#039;
    option weight &#039;3&#039;

config member &#039;wan2_m4_w3&#039;
    option interface &#039;wan2&#039;
    option metric &#039;4&#039;
    option weight &#039;3&#039;

config member &#039;l2tp0_m1_w3&#039;
    option interface &#039;l2tp0&#039;
    option metric &#039;1&#039;
    option weight &#039;3&#039;

config member &#039;l2tp0_m2_w3&#039;
    option interface &#039;l2tp0&#039;
    option metric &#039;2&#039;
    option weight &#039;3&#039;

config member &#039;l2tp1_m1_w3&#039;
    option interface &#039;l2tp1&#039;
    option metric &#039;1&#039;
    option weight &#039;3&#039;

config member &#039;l2tp1_m2_w3&#039;
    option interface &#039;l2tp1&#039;
    option metric &#039;2&#039;
    option weight &#039;3&#039;

config policy &#039;wan_only&#039;
    list use_member &#039;wan_m1_w3&#039;

config policy &#039;wan2_only&#039;
    list use_member &#039;wan2_m1_w3&#039;

config policy &#039;fail_wan_wan2&#039;
    list use_member &#039;wan_m1_w3&#039;
    list use_member &#039;wan2_m2_w3&#039;

config policy &#039;fail_wan2_wan&#039;
    list use_member &#039;wan_m2_w3&#039;
    list use_member &#039;wan2_m1_w3&#039;

config policy &#039;fail_l2tp_wan&#039;
    list use_member &#039;l2tp0_m1_w3&#039;
    list use_member &#039;l2tp1_m2_w3&#039;
    list use_member &#039;wan_m3_w3&#039;

config policy &#039;fail_l2tp_wan2&#039;
    list use_member &#039;l2tp0_m1_w3&#039;
    list use_member &#039;l2tp1_m2_w3&#039;
    list use_member &#039;wan2_m3_w3&#039;

config policy &#039;fail_l2tp_wan_wan2&#039;
    list use_member &#039;l2tp0_m1_w3&#039;
    list use_member &#039;l2tp1_m2_w3&#039;
    list use_member &#039;wan_m3_w3&#039;
    list use_member &#039;wan2_m4_w3&#039;

config policy &#039;fail_l2tp_wan2_wan&#039;
    list use_member &#039;l2tp0_m1_w3&#039;
    list use_member &#039;l2tp1_m2_w3&#039;
    list use_member &#039;wan2_m3_w3&#039;
    list use_member &#039;wan_m4_w3&#039;

config policy &#039;load_equal_wan_wan2&#039;
    list use_member &#039;wan_m1_w3&#039;
    list use_member &#039;wan2_m1_w3&#039;

config rule &#039;router_generated&#039;
    option src_ip &#039;127.0.0.0/8&#039;
    option proto &#039;all&#039;
    option use_policy &#039;fail_wan_wan2&#039;

config rule &#039;lan&#039;
    option src_ip &#039;192.168.1.0/24&#039;
    option proto &#039;all&#039;
    option use_policy &#039;fail_l2tp_wan&#039;

config rule &#039;lan2&#039;
    option src_ip &#039;192.168.2.0/24&#039;
    option proto &#039;all&#039;
    option use_policy &#039;fail_l2tp_wan&#039;

config rule &#039;lan3&#039;
    option src_ip &#039;192.168.3.0/24&#039;
    option proto &#039;all&#039;
    option use_policy &#039;fail_l2tp_wan&#039;

config rule &#039;lan4&#039;
    option src_ip &#039;192.168.4.0/24&#039;
    option proto &#039;all&#039;
    option use_policy &#039;fail_l2tp_wan_wan2&#039;</code></pre></div><p>root@OpenWrt:~# route -n<br /></p><div class="codebox"><pre><code>Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.80.1    0.0.0.0         UG    10     0        0 eth1
0.0.0.0         192.168.1.1     0.0.0.0         UG    20     0        0 eth0.1
0.0.0.0         1.1.1.1         0.0.0.0         UG    100    0        0 ppp0
1.1.1.1         0.0.0.0         255.255.255.255 UH    0      0        0 ppp0
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0.1
192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan2
192.168.3.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan3
192.168.4.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan4
192.168.80.0    0.0.0.0         255.255.255.0   U     0      0        0 eth1</code></pre></div><p>root@OpenWrt:~# ifconfig ppp0<br /></p><div class="codebox"><pre><code>ppp0      Link encap:Point-to-Point Protocol  
          inet addr:1.1.1.11  P-t-P:1.1.1.1  Mask:255.255.255.255
          UP POINTOPOINT RUNNING NOARP MULTICAST  MTU:1460  Metric:1
          RX packets:138 errors:0 dropped:0 overruns:0 frame:0
          TX packets:139 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:3 
          RX bytes:11370 (11.1 KiB)  TX bytes:11454 (11.1 KiB)</code></pre></div><p>root@OpenWrt:/# ip rule<br /></p><div class="codebox"><pre><code>0:      from all lookup local 
200:    from all fwmark 0xc8 lookup TUN 
400:    from 192.168.2.0/24 lookup TUN 
400:    from 192.168.3.0/24 lookup TUN 
400:    from 192.168.4.0/24 lookup TUN 
1001:   from 192.168.80.112 fwmark 0x0/0x8000 lookup 1001 
1002:   from 192.168.1.118 fwmark 0x0/0x8000 lookup 1002 
1003:   from 1.1.1.11 fwmark 0x0/0x8000 lookup 1003 
1008:   from all fwmark 0x100/0xff00 lookup 1001 
1009:   from all fwmark 0x200/0xff00 lookup 1002 
1010:   from all fwmark 0x300/0xff00 lookup 1003 
1017:   from all fwmark 0x1100/0xff00 lookup 1017 
1018:   from all fwmark 0x1200/0xff00 lookup 1018 
1019:   from all fwmark 0x1300/0xff00 lookup 1019 
1021:   from all fwmark 0x1500/0xff00 lookup 1021 
1022:   from all fwmark 0x1600/0xff00 lookup 1022 
1023:   from all fwmark 0x1700/0xff00 lookup 1023 
1024:   from all fwmark 0x1800/0xff00 lookup 1024 
32766:  from all lookup main 
32767:  from all lookup default</code></pre></div><p>root@OpenWrt:~# ping -I ppp0 8.8.8.8<br /></p><div class="codebox"><pre><code>PING 8.8.8.8 (8.8.8.8): 56 data bytes
64 bytes from 8.8.8.8: seq=0 ttl=46 time=91.126 ms</code></pre></div><p>root@OpenWrt:~# tcpdump -i ppp0 icmp<br /></p><div class="codebox"><pre><code>tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on ppp0, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes
18:04:35.235293 IP 1.1.1.11 &gt; google-public-dns-a.google.com: ICMP echo request, id 9877, seq 0, length 64
18:04:35.328886 IP google-public-dns-a.google.com &gt; 1.1.1.11: ICMP echo reply, id 9877, seq 0, length 64</code></pre></div><p>root@OpenWrt:/# logread | grep mwan3<br /></p><div class="codebox"><pre><code>Sep 17 17:54:21 OpenWrt user.notice root: mwan3: Lost 5 ping(s) on interface l2tp0 (ppp0)
Sep 17 17:54:21 OpenWrt user.notice root: mwan3: ifup interface l2tp0 (ppp0)
Sep 17 17:54:56 OpenWrt user.notice root: mwan3: ifdown interface l2tp0 ()
Sep 17 17:54:57 OpenWrt user.notice root: mwan3: Interface l2tp0 (ppp0) is offline
Sep 17 17:54:59 OpenWrt user.notice root: mwan3: ifdown interface l2tp0 (ppp0)
Sep 17 17:55:02 OpenWrt user.notice root: mwan3: ifup interface l2tp0 (ppp0)
Sep 17 17:55:06 OpenWrt user.notice root: mwan3: ifdown interface l2tp0 ()
Sep 17 17:55:11 OpenWrt user.notice root: mwan3: ifup interface l2tp0 (ppp0)
Sep 17 17:55:39 OpenWrt user.notice root: mwan3: Lost 3 ping(s) on interface l2tp0 (ppp0)
Sep 17 17:59:46 OpenWrt user.notice root: mwan3: Lost 66 ping(s) on interface wan2 (eth0.1)
Sep 17 18:00:06 OpenWrt user.notice root: mwan3: Interface wan2 (eth0.1) is online
Sep 17 18:00:07 OpenWrt user.notice root: mwan3: ifup interface wan2 (eth0.1)</code></pre></div><p>root@OpenWrt:~# iptables -L -t mangle -v -n<br /></p><div class="codebox"><pre><code>Chain PREROUTING (policy ACCEPT 1577 packets, 280K bytes)
 pkts bytes target     prot opt in     out     source               destination         
23693 4594K mwan3_pre  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain INPUT (policy ACCEPT 537 packets, 43056 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 1027 packets, 236K bytes)
 pkts bytes target     prot opt in     out     source               destination         
14857 3737K zone_wan2_MSSFIX  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
14857 3737K zone_wan_MSSFIX  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain OUTPUT (policy ACCEPT 557 packets, 216K bytes)
 pkts bytes target     prot opt in     out     source               destination         
10369 2491K mwan3_pre  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain POSTROUTING (policy ACCEPT 1584 packets, 452K bytes)
 pkts bytes target     prot opt in     out     source               destination         
24619 6191K mwan3_post  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain mwan3_default (1 references)
 pkts bytes target     prot opt in     out     source               destination         
   95 25788 MARK       all  --  *      *       0.0.0.0/0            224.0.0.0/3         mark match !0x8000/0x8000 MARK or 0x8000 
    8   672 MARK       all  --  *      *       0.0.0.0/0            1.1.1.1             mark match !0x8000/0x8000 MARK or 0x8000 
 2431  311K MARK       all  --  *      *       0.0.0.0/0            192.168.1.0/24      mark match !0x8000/0x8000 MARK or 0x8000 
    0     0 MARK       all  --  *      *       0.0.0.0/0            192.168.2.0/24      mark match !0x8000/0x8000 MARK or 0x8000 
    0     0 MARK       all  --  *      *       0.0.0.0/0            192.168.3.0/24      mark match !0x8000/0x8000 MARK or 0x8000 
 7406 1520K MARK       all  --  *      *       0.0.0.0/0            192.168.4.0/24      mark match !0x8000/0x8000 MARK or 0x8000 
 1272  195K MARK       all  --  *      *       0.0.0.0/0            192.168.80.0/24     mark match !0x8000/0x8000 MARK or 0x8000 

Chain mwan3_post (1 references)
 pkts bytes target     prot opt in     out     source               destination         
  327 27468 MARK       all  --  *      eth0.1  0.0.0.0/0            0.0.0.0/0           mark match !0x8000/0x8000 MARK xset 0x200/0xff00 
  695  175K MARK       all  --  *      ppp0    0.0.0.0/0            0.0.0.0/0           mark match !0x8000/0x8000 MARK xset 0x300/0xff00 
 6930 1373K MARK       all  --  *      eth1    0.0.0.0/0            0.0.0.0/0           mark match !0x8000/0x8000 MARK xset 0x100/0xff00 
14715 4190K MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x8000/0x8000 MARK and 0xffff7fff 
24619 6191K CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0           CONNMARK save mask 0xff00 

Chain mwan3_pre (2 references)
 pkts bytes target     prot opt in     out     source               destination         
34062 7085K CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0           CONNMARK restore mask 0xff00 
 2953  960K MARK       all  --  eth0.1 *       0.0.0.0/0            0.0.0.0/0           MARK xset 0x8200/0xff00 
  364 30576 MARK       all  --  ppp0   *       0.0.0.0/0            0.0.0.0/0           MARK xset 0x8300/0xff00 
 5898 1484K MARK       all  --  eth1   *       0.0.0.0/0            0.0.0.0/0           MARK xset 0x8100/0xff00 
24841 4610K mwan3_default  all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match !0x8000/0x8000 
 2820  222K mwan3_rules  all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff00 

Chain mwan3_rules (1 references)
 pkts bytes target     prot opt in     out     source               destination         
  352 38316 MARK       all  --  *      *       127.0.0.0/8          0.0.0.0/0           mark match 0x0/0xff00 MARK xset 0x1200/0xff00 
  325 27300 MARK       all  --  *      *       192.168.1.0/24       0.0.0.0/0           mark match 0x0/0xff00 MARK xset 0x1400/0xff00 
    0     0 MARK       all  --  *      *       192.168.2.0/24       0.0.0.0/0           mark match 0x0/0xff00 MARK xset 0x1400/0xff00 
    0     0 MARK       all  --  *      *       192.168.3.0/24       0.0.0.0/0           mark match 0x0/0xff00 MARK xset 0x1400/0xff00 
  968 58192 MARK       all  --  *      *       192.168.4.0/24       0.0.0.0/0           mark match 0x0/0xff00 MARK xset 0x1400/0xff00 

Chain qos_Default (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0           CONNMARK restore mask 0xff 
    0     0 qos_Default_ct  all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff 
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x1/0xff length 400:65535 MARK and 0xffffff00 
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x2/0xff length 800:65535 MARK and 0xffffff00 
    0     0 MARK       udp  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff length 0:500 MARK xset 0x2/0xff 
    0     0 MARK       icmp --  *      *       0.0.0.0/0            0.0.0.0/0           MARK xset 0x1/0xff 
    0     0 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff tcp spts:1024:65535 dpts:1024:65535 MARK xset 0x4/0xff 
    0     0 MARK       udp  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff udp spts:1024:65535 dpts:1024:65535 MARK xset 0x4/0xff 
    0     0 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           length 0:128 mark match !0x4/0xff tcp flags:0x3F/0x02 MARK xset 0x1/0xff 
    0     0 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           length 0:128 mark match !0x4/0xff tcp flags:0x3F/0x10 MARK xset 0x1/0xff 

Chain qos_Default_ct (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff tcp multiport ports 22,53 MARK xset 0x1/0xff 
    0     0 MARK       udp  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff udp multiport ports 22,53 MARK xset 0x1/0xff 
    0     0 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff tcp multiport ports 20,21,25,80,110,443,993,995 MARK xset 0x3/0xff 
    0     0 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff tcp multiport ports 5190 MARK xset 0x2/0xff 
    0     0 MARK       udp  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff udp multiport ports 5190 MARK xset 0x2/0xff 
    0     0 CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0           CONNMARK save mask 0xff 

Chain zone_wan2_MSSFIX (1 references)
 pkts bytes target     prot opt in     out     source               destination         
  207 12420 TCPMSS     tcp  --  *      eth0.1  0.0.0.0/0            0.0.0.0/0           tcp flags:0x06/0x02 TCPMSS clamp to PMTU 

Chain zone_wan_MSSFIX (1 references)
 pkts bytes target     prot opt in     out     source               destination         
   68  4080 TCPMSS     tcp  --  *      eth1    0.0.0.0/0            0.0.0.0/0           tcp flags:0x06/0x02 TCPMSS clamp to PMTU 
    0     0 TCPMSS     tcp  --  *      ppp0    0.0.0.0/0            0.0.0.0/0           tcp flags:0x06/0x02 TCPMSS clamp to PMTU</code></pre></div><p>With my rule for lan4 which should direct traffic over the l2tp tunnel it doesn&#039;t. Clients going to whatismyip.com shows the wan external IP address rather than the external address of our datacenter..</p><p>Any thoughts?</p>											<p class="post-edited">(Last edited by <strong>arfett</strong> on 17 Sep 2012, 21:28)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178431">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						17 Sep 2012, 00:15					</div>
				</div>
				<div class="post-content content">
					<p>Maybe you could try removing these lines? Sounds silly, i know, but have seen some situations where it did matter.<br /></p><div class="codebox"><pre><code>        option _orig_ifname &#039;ppp0&#039;
        option _orig_bridge &#039;false&#039;</code></pre></div><p>Or maybe you could go for the complete openwrt l2tp configuration: <a href="http://wiki.openwrt.org/doc/uci/network#protocol.l2tp.l2tp.pseudowire.tunnel">http://wiki.openwrt.org/doc/uci/network … ire.tunnel</a> . This has worked for me.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 17 Sep 2012, 00:16)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178534">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						17 Sep 2012, 21:21					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Maybe you could try removing these lines? Sounds silly, i know, but have seen some situations where it did matter.<br /></p><div class="codebox"><pre><code>        option _orig_ifname &#039;ppp0&#039;
        option _orig_bridge &#039;false&#039;</code></pre></div><p>Or maybe you could go for the complete openwrt l2tp configuration: <a href="http://wiki.openwrt.org/doc/uci/network#protocol.l2tp.l2tp.pseudowire.tunnel">http://wiki.openwrt.org/doc/uci/network … ire.tunnel</a> . This has worked for me.</p></blockquote></div><p>Those are added automatically after configuring it sometimes and they are not currently in the config.</p><p>Also we are using openl2tp.</p><p>Are there supposed to be routes in these?</p><p>root@OpenWrt:~# ip route show table 1001<br />root@OpenWrt:~# ip route show table 1002<br />default via 192.168.1.1 dev eth0.1 <br />root@OpenWrt:~# ip route show table 1003</p><p>Edit: I updated the original post with the output of &quot;iptables -L -t mangle -v -n&quot;<br />Interestingly enough it doesn&#039;t look like the rule for 127.0.0.0/8 traffic is working either as I can unplug my wan connection and mwan3 sends an ifdown but the router traffic does not failover to wan2. This was working on saturday with the same config file.</p>											<p class="post-edited">(Last edited by <strong>arfett</strong> on 17 Sep 2012, 21:31)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178537">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						17 Sep 2012, 21:48					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>arfett wrote:</cite><blockquote><p>Interestingly enough it doesn&#039;t look like the rule for 127.0.0.0/8 traffic is working either as I can unplug my wan connection and mwan3 sends an ifdown but the router traffic does not failover to wan2. This was working on saturday with the same config file.</p></blockquote></div><p>I think i&#039;ve made a mistake somewhere with the last update... will get back asap.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178780">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">RussellSenior</div>
					<div class="post-datetime">
						19 Sep 2012, 20:42					</div>
				</div>
				<div class="post-content content">
					<p>Adze,&nbsp; I gave your mwan3 a try based on r8 of your svn repo.&nbsp; I observed that my wan2 (dhcp) got virtually all the traffic, over wan (static), despite my attempt to direct all but a specific UDP stream over wan:</p><p>config &#039;rule&#039;<br />&nbsp; &nbsp; option &#039;dest_ip&#039; &#039;hostname.example.com&#039; <br />&nbsp; &nbsp; option &#039;proto&#039; &#039;udp&#039;<br />&nbsp; &nbsp; option &#039;dest_port&#039; &#039;1194&#039;<br />&nbsp; &nbsp; option &#039;use_policy&#039; &#039;wan2_only&#039;&nbsp; &nbsp; </p><p>config &#039;rule&#039;<br />&nbsp; &nbsp; option &#039;dest_ip&#039; &#039;0.0.0.0/0&#039;<br />&nbsp; &nbsp; option &#039;use_policy&#039; &#039;wan_only&#039;</p><p>(full mwan3 config here: <a href="http://www.pastebin.ca/2205638)">http://www.pastebin.ca/2205638)</a></p><p>Also, I had trouble with some previously working (in single-wan) iptables DNAT rules, passing ssh through to internal hosts from static ips on the gateway.&nbsp; The traffic arrived at wan, but then disappeared, never forwarded inside.&nbsp; The DNAT rule was never triggerred (judging by the packet/byte counts).&nbsp; When I turn off mwan3, my DNAT rules start working again.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178787">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						19 Sep 2012, 21:38					</div>
				</div>
				<div class="post-content content">
					<p>Hi RussellSenior,</p><br /><p>Your config looks OK. I&#039;d like to get your setup working. Could you please paste me the outcome of:</p><p>- ip rule<br />- route -n<br />- iptables -L -t mangle -v -n<br />- cat /etc/config/network<br />- ip route list table 1001<br />- ip route list table 1002<br />- cat /etc/config/firewall</p><br /><p>Thanks.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178847">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">RussellSenior</div>
					<div class="post-datetime">
						20 Sep 2012, 13:30					</div>
				</div>
				<div class="post-content content">
					<p>Adze, here is a slightly anonymized version.&nbsp; Note that I am not seeing table 1001, but some others, which I&#039;ve included.&nbsp; Also, I am not using the OpenWrt firewall script, but have substituted my own init script (included):</p><p>&nbsp; <a href="http://www.pastebin.ca/2205823">http://www.pastebin.ca/2205823</a></p><p>It looks like maybe the dhcp is stomping on the static default gateway route I&#039;ve specified for the wan interface.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178853">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">RussellSenior</div>
					<div class="post-datetime">
						20 Sep 2012, 14:16					</div>
				</div>
				<div class="post-content content">
					<p>Oh, actually, I neglected to assign a metric to the wan interfaces, that explains the static iface&#039;s default gateway going away.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178855">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						20 Sep 2012, 14:27					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>RussellSenior wrote:</cite><blockquote><p>Oh, actually, I neglected to assign a metric to the wan interfaces, that explains the static iface&#039;s default gateway going away.</p></blockquote></div><p>And that explains why mwan3 isn&#039;t working... After you have changed this, is it working? If not could you paste the same info again after setting different metric to your wan&#039;s?</p><p>Thnx!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178858">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">RussellSenior</div>
					<div class="post-datetime">
						20 Sep 2012, 14:43					</div>
				</div>
				<div class="post-content content">
					<p>Now, it seems things are mostly working.&nbsp; New wrinkle is olsrd derived routes are not being honored.&nbsp; All the olsrd routes are going into &#039;table main&#039;</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178859">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						20 Sep 2012, 14:49					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>RussellSenior wrote:</cite><blockquote><p>Now, it seems things are mostly working.&nbsp; New wrinkle is olsrd derived routes are not being honored.&nbsp; All the olsrd routes are going into &#039;table main&#039;</p></blockquote></div><p>You can work-around this by adding a rule to tell mwan3 for which destinations to look in the default routing table.</p><div class="codebox"><pre><code>config rule
 option &#039;dest_ip&#039; &#039;10.0.0.0/8&#039;
 option &#039;use_policy&#039; &#039;default&#039;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178860">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">RussellSenior</div>
					<div class="post-datetime">
						20 Sep 2012, 15:07					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><div class="quotebox"><cite>RussellSenior wrote:</cite><blockquote><p>Now, it seems things are mostly working.&nbsp; New wrinkle is olsrd derived routes are not being honored.&nbsp; All the olsrd routes are going into &#039;table main&#039;</p></blockquote></div><p>You can work-around this by adding a rule to tell mwan3 for which destinations to look in the default routing table.</p><div class="codebox"><pre><code>config rule
 option &#039;dest_ip&#039; &#039;10.0.0.0/8&#039;
 option &#039;use_policy&#039; &#039;default&#039;</code></pre></div></blockquote></div><p>That works, cool!</p><p>However, my rule:</p><p>config &#039;rule&#039;<br />&nbsp; &nbsp; option &#039;dest_ip&#039; &#039;donk.personaltelco.net&#039;<br />&nbsp; &nbsp; option &#039;proto&#039; &#039;udp&#039;<br />&nbsp; &nbsp; option &#039;dest_port&#039; &#039;1194&#039;<br />&nbsp; &nbsp; option &#039;use_policy&#039; &#039;wan2_only&#039;&nbsp; &nbsp; </p><p>isn&#039;t working (packets go out eth1.1 (wan) instead of wan2, while this one does work:</p><p>config &#039;rule&#039;<br />&nbsp; &nbsp; option &#039;dest_ip&#039; &#039;4.2.2.2&#039;<br />&nbsp; &nbsp; option &#039;use_policy&#039; &#039;wan2_only&#039;</p>											<p class="post-edited">(Last edited by <strong>RussellSenior</strong> on 20 Sep 2012, 15:08)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178862">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						20 Sep 2012, 15:31					</div>
				</div>
				<div class="post-content content">
					<p>Hostnames in rules work, but are kinda borky... When mwan3 fills the iptables rules, it resolves the hostname. If it has multiple A records, it will only use the first one. It will not change until an interface has changed its status again. My advice would be to use ip addresses only.</p><p>To verify that the rule is actually correct, please use the command &quot;iptables -L mwan3_rules -t mangle -v -n&quot; and see if it&#039;s there.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178900">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">mexia</div>
					<div class="post-datetime">
						20 Sep 2012, 22:30					</div>
				</div>
				<div class="post-content content">
					<p>I wrote a Luci web interface, but I don&#039;t know how to upload</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178903">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						20 Sep 2012, 23:35					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mexia wrote:</cite><blockquote><p>I wrote a Luci web interface, but I don&#039;t know how to upload</p></blockquote></div><p>I have also created one shown here. It just needs the final part which is a status page showing real-time data on whether interfaces are up/down and also a troubleshooting page which spits out iptables information related to mwan3 (this part is done.)</p><p><a href="https://forum.openwrt.org/viewtopic.php?pid=178312">https://forum.openwrt.org/viewtopic.php?pid=178312</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178907">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">RussellSenior</div>
					<div class="post-datetime">
						21 Sep 2012, 01:51					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hostnames in rules work, but are kinda borky... When mwan3 fills the iptables rules, it resolves the hostname. If it has multiple A records, it will only use the first one. It will not change until an interface has changed its status again. My advice would be to use ip addresses only.</p><p>To verify that the rule is actually correct, please use the command &quot;iptables -L mwan3_rules -t mangle -v -n&quot; and see if it&#039;s there.</p></blockquote></div><p>Yeah, it resolves the ipaddr numbers correctly.&nbsp; Looks like it&#039;s an issue of where the data is originating.&nbsp; That is, if I run a traceroute -U -p 1194 donk.personaltelco.net from a host on my LAN, it routes the right way.&nbsp; If I do that from the router running mwan3, it doesn&#039;t route the right way.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p178911">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						21 Sep 2012, 02:35					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>RussellSenior wrote:</cite><blockquote><p>Yeah, it resolves the ipaddr numbers correctly.&nbsp; Looks like it&#039;s an issue of where the data is originating.&nbsp; That is, if I run a traceroute -U -p 1194 donk.personaltelco.net from a host on my LAN, it routes the right way.&nbsp; If I do that from the router running mwan3, it doesn&#039;t route the right way.</p></blockquote></div><p>I wasn&#039;t having much luck getting router generated traffic routing correctly so I made my own hotplug script which runs right after his that adds ip rules for loopback traffic based on ifup/ifdown hotplug events for wan interfaces.</p><p>ip rule add dev lo table 100x</p><p>If I could get it working via rules instead I would be ecstatic.</p>											<p class="post-edited">(Last edited by <strong>arfett</strong> on 21 Sep 2012, 02:36)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p179003">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						21 Sep 2012, 21:19					</div>
				</div>
				<div class="post-content content">
					<p>The way i got my router originated traffic to load-balance is by adding an ip alias on the loopback interface. Then create a default route <strong>with the ip alias as source</strong> in the main routing table with a lower metric than the lowest wan interface. You will have something like this:</p><div class="codebox"><pre><code>root@mercurius:~# ip addr show lo
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
    inet 192.168.1.1/32 brd 255.255.255.255 scope global lo   &lt;-- This is the added ip alias.
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever

root@mercurius:~# ip route
default via 192.168.1.1 dev lo  src 192.168.1.1  metric 5    &lt;-- This is the added loopback route.
default via 95.97.227.169 dev eth0.1  proto static  metric 10 
default via 213.154.232.9 dev eth0.2  proto static  metric 20 
95.97.227.168/29 dev eth0.1  proto static  scope link  metric 10 
192.168.33.0/24 dev br-lan  proto kernel  scope link  src 192.168.33.2 
213.154.232.8/29 dev eth0.2  proto static  scope link  metric 20</code></pre></div><p>And proof that it is load-balancing:<br /></p><div class="codebox"><pre><code>root@mercurius:~# traceroute -4 -l -n -q 1 -w 1 213.136.13.52
traceroute to 213.136.13.52 (213.136.13.52), 30 hops max, 38 byte packets
 1  213.154.232.9  0.722 ms (64)
 2  213.136.1.10  16.243 ms (254)
 3  212.142.61.37  15.958 ms (253)
 4  84.116.244.21  11.587 ms (252)
 5  84.116.135.182  12.166 ms (251)
 6  195.69.144.35  16.226 ms (249)
 7  213.154.229.54  32.742 ms (249)
 8  213.136.13.52  12.850 ms (57)

root@mercurius:~# traceroute -4 -l -n -q 1 -w 1 213.136.13.52
traceroute to 213.136.13.52 (213.136.13.52), 30 hops max, 38 byte packets
 1  95.97.227.169  0.395 ms (64)
 2  213.136.1.10  17.067 ms (254)
 3  213.136.1.233  17.746 ms (252)
 4  84.116.244.21  10.208 ms (252)
 5  84.116.132.218  12.596 ms (251)
 6  213.136.13.52  18.374 ms (60)

root@mercurius:~# traceroute -4 -l -n -q 1 -w 1 213.136.13.52
traceroute to 213.136.13.52 (213.136.13.52), 30 hops max, 38 byte packets
 1  213.154.232.9  0.642 ms (64)
 2  213.136.1.10  16.267 ms (254)
 3  213.136.1.233  17.590 ms (252)
 4  84.116.244.21  11.194 ms (252)
 5  213.136.13.52  17.959 ms (60)

root@mercurius:~# traceroute -4 -l -n -q 1 -w 1 213.136.13.52
traceroute to 213.136.13.52 (213.136.13.52), 30 hops max, 38 byte packets
 1  95.97.227.169  0.431 ms (64)
 2  10.15.180.129  7.107 ms (254)
 3  213.136.1.233  17.650 ms (252)
 4  213.154.229.54  17.460 ms (252)
 5  84.116.135.202  13.082 ms (251)
 6  195.69.144.35  17.767 ms (249)
 7  213.154.229.54  16.024 ms (249)
 8  213.136.13.52  17.117 ms (60)</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p179006">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						21 Sep 2012, 21:45					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>The way i got my router originated traffic to load-balance is by adding an ip alias on the loopback interface. Then create a default route <strong>with the ip alias as source</strong> in the main routing table with a lower metric than the lowest wan interface. You will have something like this:</p></blockquote></div><p>I think where I messed up was not using a lower metric. I will try again and see what happens. And just to clarify again you did not need to create a rule for this traffic?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p179007">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						21 Sep 2012, 21:50					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>arfett wrote:</cite><blockquote><p>And just to clarify again you did not need to create a rule for this traffic?</p></blockquote></div><p>You must create a rule for this traffic. In above example i have only one default load-balancing rule with equalize active. The rules both apply to hosts on the lan and to the router itself.</p><div class="codebox"><pre><code>config &#039;interface&#039; &#039;wan1&#039;
    option &#039;enabled&#039; &#039;1&#039;

config &#039;interface&#039; &#039;wan2&#039;
    option &#039;enabled&#039; &#039;1&#039;

config &#039;member&#039; &#039;wan1_m1_w3&#039;
    option &#039;interface&#039; &#039;wan1&#039;
    option &#039;metric&#039; &#039;1&#039;
    option &#039;weight&#039; &#039;3&#039;

config &#039;member&#039; &#039;wan2_m1_w2&#039;
    option &#039;interface&#039; &#039;wan2&#039;
    option &#039;metric&#039; &#039;1&#039;
    option &#039;weight&#039; &#039;2&#039;

config &#039;policy&#039; &#039;wan1_wan2_loadbalanced&#039;
    list &#039;use_member&#039; &#039;wan1_m1_w3&#039;
    list &#039;use_member&#039; &#039;wan2_m1_w2&#039;

config &#039;rule&#039;
    option &#039;dest_ip&#039; &#039;0.0.0.0/0&#039;
    option &#039;equalize&#039; &#039;1&#039;
    option &#039;use_policy&#039; &#039;wan1_wan2_loadbalanced&#039;</code></pre></div>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 21 Sep 2012, 22:00)</p>
									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 65</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=3.html">3</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>