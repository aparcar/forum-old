<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> U-Boot mod for routers with AR9331/AR9344</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 3 Apr 2015 and 7 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 22 of 25</div><nav><ul><li><a href="viewtopic.php%3Fid=43237&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=43237&amp;p=20.html">20</a></li><li><a href="viewtopic.php%3Fid=43237&amp;p=21.html">21</a></li><li class="pagination-current"><span>22</span></li><li><a href="viewtopic.php%3Fid=43237&amp;p=23.html">23</a></li><li><a href="viewtopic.php%3Fid=43237&amp;p=24.html">24</a></li><li><a href="viewtopic.php%3Fid=43237&amp;p=25.html">25</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p319280">
				<div class="post-metadata">
					<div class="post-num">Post #526</div>
					<div class="post-author">dktn</div>
					<div class="post-datetime">
						12 Apr 2016, 12:40					</div>
				</div>
				<div class="post-content content">
					<p>I have TP-WR940V2 with 4MB flash.<br />I mod flash from 4MB to 8MB with U-boot mod as this topic.<br />Now I installed firmware from TRUNK image(like 941v5) but I run<br />opkg update (OK)<br />opkg install luci-ssl xupnpd....<br />It had some error dont installed package.<br />Please tell me It had error because of 8Mb flash or have some bug in trunk package?<br />I do with 15.05.01 work OK</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p319283">
				<div class="post-metadata">
					<div class="post-num">Post #527</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						12 Apr 2016, 12:46					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dktn wrote:</cite><blockquote><p>I have TP-WR940V2 with 4MB flash.<br />I mod flash from 4MB to 8MB with U-boot mod as this topic.<br />Now I installed firmware from TRUNK image(like 941v5) but I run<br />opkg update (OK)<br />opkg install luci-ssl xupnpd....<br />It had some error dont installed package.<br />Please tell me It had error because of 8Mb flash or have some bug in trunk package?<br />I do with 15.05.01 work OK</p></blockquote></div><p>It&#039;s not related with this project, please don&#039;t spam this topic with that kind of problems.<br />Plus, next time if you want to ask for a help, don&#039;t write &quot;some error&quot;, because we don&#039;t have any wizards on the forum.</p>											<p class="post-edited">(Last edited by <strong>pepe2k</strong> on 12 Apr 2016, 12:47)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p319295">
				<div class="post-metadata">
					<div class="post-num">Post #528</div>
					<div class="post-author">user5077</div>
					<div class="post-datetime">
						12 Apr 2016, 14:08					</div>
				</div>
				<div class="post-content content">
					<p>Something is unclear to me: does the u-boot update page from httpd recovery need the full 128 KB image or just the 123 KB one? If I compile a new u-boot image from a newer commit and want to flash it from web recovery mode(httpd), do I need to use dd to combine it with original image or I can just go flash the 123 KiB image?</p><p>Also, what does AHB clock affect on a device with no USB port at all? Also, can you add more profiles for clocks? I want to try to overclock my tl-wr841n to 700 MHz CPU if possible. I run it at 620 MHz for a while and it seems to work fine.</p>											<p class="post-edited">(Last edited by <strong>user5077</strong> on 12 Apr 2016, 14:09)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p319298">
				<div class="post-metadata">
					<div class="post-num">Post #529</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						12 Apr 2016, 14:27					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>user5077 wrote:</cite><blockquote><p>Something is unclear to me: does the u-boot update page from httpd recovery need the full 128 KB image or just the 123 KB one? If I compile a new u-boot image from a newer commit and want to flash it from web recovery mode(httpd), do I need to use dd to combine it with original image or I can just go flash the 123 KiB image?</p></blockquote></div><p>For TP-Link devices the U-Boot image should be withing 10-123 KB size. For web update it doesn&#039;t make any difference.</p><div class="quotebox"><cite>user5077 wrote:</cite><blockquote><p>Also, what does AHB clock affect on a device with no USB port at all?</p></blockquote></div><p>I don&#039;t know exact internal schematic, but it&#039;s like a system bus with almost everything connected over it, not only the USB subsystem, but also GMACs, PCIE, WMAC etc. For example, on AR933x with AHB clock around 300 MHz Ethernet part is not working at all.</p><div class="quotebox"><cite>user5077 wrote:</cite><blockquote><p>Also, can you add more profiles for clocks? I want to try to overclock my tl-wr841n to 700 MHz CPU if possible. I run it at 620 MHz for a while and it seems to work fine.</p></blockquote></div><p>Yes, I want to include profiles generator, just need to find time and finish it <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p319612">
				<div class="post-metadata">
					<div class="post-num">Post #530</div>
					<div class="post-author">mile18</div>
					<div class="post-datetime">
						14 Apr 2016, 13:38					</div>
				</div>
				<div class="post-content content">
					<p>@pepe2k, why does my firmware update form looks like this? It&#039;s missing ART and Uboot buttons and it&#039;s smaller, on another router is ok, but this is wierd<br /><span class="postimg"><img src="http://i.imgur.com/rP5ftHf.png" alt="http://i.imgur.com/rP5ftHf.png" /></span></p>											<p class="post-edited">(Last edited by <strong>mile18</strong> on 14 Apr 2016, 13:41)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p319618">
				<div class="post-metadata">
					<div class="post-num">Post #531</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						14 Apr 2016, 13:51					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mile18 wrote:</cite><blockquote><p>@pepe2k, why does my firmware update form looks like this? It&#039;s missing ART and Uboot buttons and it&#039;s smaller, on another router is ok, but this is wierd<br /><span class="postimg"><img src="http://i.imgur.com/rP5ftHf.png" alt="http://i.imgur.com/rP5ftHf.png" /></span></p></blockquote></div><p>Links for art and u-boot upgrade pages were removed from index.html long time ago (for safety reasons). You should go there manually (art.html, uboot.html).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p319619">
				<div class="post-metadata">
					<div class="post-num">Post #532</div>
					<div class="post-author">mile18</div>
					<div class="post-datetime">
						14 Apr 2016, 13:54					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>pepe2k wrote:</cite><blockquote><div class="quotebox"><cite>mile18 wrote:</cite><blockquote><p>@pepe2k, why does my firmware update form looks like this? It&#039;s missing ART and Uboot buttons and it&#039;s smaller, on another router is ok, but this is wierd<br /><span class="postimg"><img src="http://i.imgur.com/rP5ftHf.png" alt="http://i.imgur.com/rP5ftHf.png" /></span></p></blockquote></div><p>Links for art and u-boot upgrade pages were removed from index.html long time ago (for safety reasons). You should go there manually (art.html, uboot.html).</p></blockquote></div><p>Oh i didn&#039;t know that, thank you. Btw you can add support for WR-842ND v2 becouse it&#039;s the same as 841ND v8. Tested and working.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p319657">
				<div class="post-metadata">
					<div class="post-num">Post #533</div>
					<div class="post-author">user5077</div>
					<div class="post-datetime">
						14 Apr 2016, 17:13					</div>
				</div>
				<div class="post-content content">
					<p>Sorry, but why leave only 4 KiB space for env variables? I need more space for them, anything I can do?..</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p319659">
				<div class="post-metadata">
					<div class="post-num">Post #534</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						14 Apr 2016, 17:18					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>user5077 wrote:</cite><blockquote><p>Sorry, but why leave only 4 KiB space for env variables? I need more space for them, anything I can do?..</p></blockquote></div><p>Look at the schematic here: <a href="https://github.com/pepe2k/u-boot_mod#using-external-programmer">https://github.com/pepe2k/u-boot_mod#us … programmer</a><br />If you really need more space for env (btw. what for?), you can lower the image size and change env block size and address.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p319671">
				<div class="post-metadata">
					<div class="post-num">Post #535</div>
					<div class="post-author">user5077</div>
					<div class="post-datetime">
						14 Apr 2016, 18:02					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>pepe2k wrote:</cite><blockquote><div class="quotebox"><cite>user5077 wrote:</cite><blockquote><p>Sorry, but why leave only 4 KiB space for env variables? I need more space for them, anything I can do?..</p></blockquote></div><p>Look at the schematic here: <a href="https://github.com/pepe2k/u-boot_mod#using-external-programmer">https://github.com/pepe2k/u-boot_mod#us … programmer</a><br />If you really need more space for env (btw. what for?), you can lower the image size and change env block size and address.</p></blockquote></div><p>OK, tried to set u-boot image to 96 KB, and modified env settings in ap143.h like this(for a 16 KB env space)<br /></p><div class="codebox"><pre><code>#if defined(CONFIG_FOR_TPLINK_WR820N_CN) ||\
    defined(CONFIG_FOR_TPLINK_WR802N)    ||\
    defined(CONFIG_FOR_TPLINK_WR841N_V9)
    #define CFG_ENV_ADDR        0x9F018000
    #define CFG_ENV_SIZE        0x4000
    #define CFG_ENV_SECT_SIZE    0x10000</code></pre></div><p>The image was compiled, hope I modified it correctly.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p319710">
				<div class="post-metadata">
					<div class="post-num">Post #536</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						14 Apr 2016, 22:31					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>user5077 wrote:</cite><blockquote><div class="quotebox"><cite>pepe2k wrote:</cite><blockquote><div class="quotebox"><cite>user5077 wrote:</cite><blockquote><p>Sorry, but why leave only 4 KiB space for env variables? I need more space for them, anything I can do?..</p></blockquote></div><p>Look at the schematic here: <a href="https://github.com/pepe2k/u-boot_mod#using-external-programmer">https://github.com/pepe2k/u-boot_mod#us … programmer</a><br />If you really need more space for env (btw. what for?), you can lower the image size and change env block size and address.</p></blockquote></div><p>OK, tried to set u-boot image to 96 KB, and modified env settings in ap143.h like this(for a 16 KB env space)<br /></p><div class="codebox"><pre><code>#if defined(CONFIG_FOR_TPLINK_WR820N_CN) ||\
    defined(CONFIG_FOR_TPLINK_WR802N)    ||\
    defined(CONFIG_FOR_TPLINK_WR841N_V9)
    #define CFG_ENV_ADDR        0x9F018000
    #define CFG_ENV_SIZE        0x4000
    #define CFG_ENV_SECT_SIZE    0x10000</code></pre></div><p>The image was compiled, hope I modified it correctly.</p></blockquote></div><p>The CFG_ENV_ADDR is wrong here, it should be 0x9F01BC00 (0x9F01BC00 + 0x4000 = 0x9F01FC00, where starts MAC address).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p320078">
				<div class="post-metadata">
					<div class="post-num">Post #537</div>
					<div class="post-author">longjun.tang</div>
					<div class="post-datetime">
						17 Apr 2016, 09:06					</div>
				</div>
				<div class="post-content content">
					<p>I used gcc-4.8-linaro_uClibc-0.9.33.2 from&nbsp; trunk and it fail to work,do you have a try?</p><div class="quotebox"><cite>doiga wrote:</cite><blockquote><p>Since I couldn&#039;t find the version gcc-4.8-linaro_musl-1.1.11, I used gcc-4.8-linaro_uClibc-0.9.33.2 from barrier_breaker and it worked! <br />Thanks.</p><div class="quotebox"><cite>doiga wrote:</cite><blockquote><p>That may be the problem since I&#039;m using gcc 5.3.0 and musl 1.1.14, the one on the u-boot wiki. I will try with the toolchain you said.</p><div class="quotebox"><cite>pepe2k wrote:</cite><blockquote><p>Seems like problem related with new gcc and/or musl.<br />Last version I have build images successfully was: toolchain-mips_34kc_gcc-4.8-linaro_musl-1.1.11</p><p>I will take a look on this problem next week and probably just include working toolchain in repository.<br />For now you can revert to earlier version in trunk and rebuild toolchain or use toolchain from previous OpenWrt release.</p></blockquote></div></blockquote></div></blockquote></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p320103">
				<div class="post-metadata">
					<div class="post-num">Post #538</div>
					<div class="post-author">doiga</div>
					<div class="post-datetime">
						17 Apr 2016, 15:23					</div>
				</div>
				<div class="post-content content">
					<p>That version of gcc worked for me, but since it was updated to work with musl, as you can see here <a href="https://github.com/pepe2k/u-boot_mod/issues/95">https://github.com/pepe2k/u-boot_mod/issues/95</a>. Try with gcc-musl</p><br /><div class="quotebox"><cite>longjun.tang wrote:</cite><blockquote><p>I used gcc-4.8-linaro_uClibc-0.9.33.2 from&nbsp; trunk and it fail to work,do you have a try?</p></blockquote></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p320188">
				<div class="post-metadata">
					<div class="post-num">Post #539</div>
					<div class="post-author">user5077</div>
					<div class="post-datetime">
						18 Apr 2016, 12:10					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>pepe2k wrote:</cite><blockquote><div class="quotebox"><cite>user5077 wrote:</cite><blockquote><div class="quotebox"><cite>pepe2k wrote:</cite><blockquote><p>Look at the schematic here: <a href="https://github.com/pepe2k/u-boot_mod#using-external-programmer">https://github.com/pepe2k/u-boot_mod#us … programmer</a><br />If you really need more space for env (btw. what for?), you can lower the image size and change env block size and address.</p></blockquote></div><p>OK, tried to set u-boot image to 96 KB, and modified env settings in ap143.h like this(for a 16 KB env space)<br /></p><div class="codebox"><pre><code>#if defined(CONFIG_FOR_TPLINK_WR820N_CN) ||\
    defined(CONFIG_FOR_TPLINK_WR802N)    ||\
    defined(CONFIG_FOR_TPLINK_WR841N_V9)
    #define CFG_ENV_ADDR        0x9F018000
    #define CFG_ENV_SIZE        0x4000
    #define CFG_ENV_SECT_SIZE    0x10000</code></pre></div><p>The image was compiled, hope I modified it correctly.</p></blockquote></div><p>The CFG_ENV_ADDR is wrong here, it should be 0x9F01BC00 (0x9F01BC00 + 0x4000 = 0x9F01FC00, where starts MAC address).</p></blockquote></div><p>Did that and my router won&#039;t boot anymore, only the first led is on, no serial output. Anything I did wrong?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p320191">
				<div class="post-metadata">
					<div class="post-num">Post #540</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						18 Apr 2016, 12:30					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>user5077 wrote:</cite><blockquote><div class="quotebox"><cite>pepe2k wrote:</cite><blockquote><div class="quotebox"><cite>user5077 wrote:</cite><blockquote><p>OK, tried to set u-boot image to 96 KB, and modified env settings in ap143.h like this(for a 16 KB env space)<br /></p><div class="codebox"><pre><code>#if defined(CONFIG_FOR_TPLINK_WR820N_CN) ||\
    defined(CONFIG_FOR_TPLINK_WR802N)    ||\
    defined(CONFIG_FOR_TPLINK_WR841N_V9)
    #define CFG_ENV_ADDR        0x9F018000
    #define CFG_ENV_SIZE        0x4000
    #define CFG_ENV_SECT_SIZE    0x10000</code></pre></div><p>The image was compiled, hope I modified it correctly.</p></blockquote></div><p>The CFG_ENV_ADDR is wrong here, it should be 0x9F01BC00 (0x9F01BC00 + 0x4000 = 0x9F01FC00, where starts MAC address).</p></blockquote></div><p>Did that and my router won&#039;t boot anymore, only the first led is on, no serial output. Anything I did wrong?</p></blockquote></div><p>I have no idea and I always say: if you want to play with bootloader, make sure to have reliable and proven method for fix the device in case of total brick/corrupted bootloader (for WR841Nv9 take a look at <a href="https://wiki.openwrt.org/doc/recipes/debrick.ath79.using.jtag">https://wiki.openwrt.org/doc/recipes/de … using.jtag</a>).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p320240">
				<div class="post-metadata">
					<div class="post-num">Post #541</div>
					<div class="post-author">freezer2k</div>
					<div class="post-datetime">
						18 Apr 2016, 18:28					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>pepe2k wrote:</cite><blockquote><p>(for WR841Nv9 take a look at <a href="https://wiki.openwrt.org/doc/recipes/debrick.ath79.using.jtag">https://wiki.openwrt.org/doc/recipes/de … using.jtag</a>).</p></blockquote></div><p>Hi Pepe!</p><p>I bricked my TL-WDR3600 a few days ago by replacing the host_util LZMA 32bit binary with the 64bit one that ships with Ubuntu 15.10; it all compiled and looked fine, but bricked the router in the end. </p><p>After doing a binary diff with xdelta3, it showed almost 50% difference when using the host_util version vs. the Ubuntu one. Any idea if this is to be expected? Maybe there could be some sort of check that the correct LZMA binary is used in the Makefile? The uncompressed RAM version worked great, so I happily went on flashing ... :]</p><p>The debrick guide above allowed me to reflash u-boot successfully! Looks like this is a very good option for many devices now. I was looking for an JTAG option quite a long time before finding this, we should link it to every supported device page imho, at least to give some pointer that this could work. </p><p>With my router, I also had to remove a bootstrap resistor (for EJTAG mode switch) and short Pin 2 (Data Pin) of the SPI Flash to ground during powerup for the router to be recognized by OpenOCD.<br />See here: <a href="https://wikidevi.com/wiki/TP-LINK_TL-WDR4300">https://wikidevi.com/wiki/TP-LINK_TL-WDR4300</a></p><p>Used a Raspberry Pi3 for the JTAG interface (sysgpio), and only had to connect the GND, TDI, TDO, TMS and TCK pins. The WDR3600 is using the reference layout (at least for those pins): <a href="http://www.jtagtest.com/pinouts/ejtag">http://www.jtagtest.com/pinouts/ejtag</a></p><p>I think its a good idea -- or even required? to add the &#039;erase&#039; option to the flash write_image operation. At one point I bricked the router so hard after writing uboot via JTAG, that I had to de-solder the SPI Flash for external re-flashing. Not sure if this happened due to a bad JTAG wiring or leaving out the erase before writing. <br />It seems to be depending on the degree/way the u-boot in Flash is messed up if shorting the SPI Data Pin to ground is enough to enter JTAG mode correctly (or not). At this point, it might be required to de-solder Pin(s) of the Flash, see also at wikidevi. <br />In my case, after the bad OpenOCD reflash, the device still showed up in OpenOCD; but flash probe command would fail, followed by permanent device probing errors. Almost took the Flash chip or connected HW-Parts for damaged, but external re-flashing worked like a charm and everything worked just fine again after soldering it back in. OpenOCD device detection was working again while the SPI Flash was removed, more evidence that it can mess with initialization. </p><p>After another brick...eh, chance to learn stuff, (and about the time it hit me about the LZMA), I flashed via EJTAG with erase option, followed by a dump_image of what was just written. MD5-sums matched and the router booted up just fine <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><br /><p>In any case, <strong>thanks a lot</strong> for all your efforts <strong>Pepe</strong>! This is an awesome Project/u-boot version. Even my serial connection works flawless now in u-boot. Before it had lots of errors and only once the linux kernel driver loaded it was suddenly all fine. </p><p>Added two new OC profiles to push the CPU a bit higher,</p><p>In <em>u-boot/include/cmd_qcaclk.h</em><br /></p><div class="codebox"><pre><code>        }, {
                720, 400, 200, 25,
                _qca95xx_spi_ctrl_addr_reg_val(8, 1, 0, 2),
                {
                        _qca95xx_cpu_pll_cfg_reg_val(28, 1, 0, 0, 0),
                        _qca95xx_ddr_pll_cfg_reg_val(16, 1, 1, 0, 0),
                        _qca95xx_cpu_ddr_clk_ctrl_reg_val(1, 1, 2, 1, 1, 1),
                        _qca95xx_cpu_pll_dither_reg_val(52),
                        _qca95xx_ddr_pll_dither_reg_val(0)
                }, {
                        _qca95xx_cpu_pll_cfg_reg_val(18, 1, 0, 0, 0),
                        _qca95xx_ddr_pll_cfg_reg_val(10, 1, 1, 0, 0),
                        _qca95xx_cpu_ddr_clk_ctrl_reg_val(1, 1, 2, 1, 1, 1),
                        _qca95xx_cpu_pll_dither_reg_val(0),
                        _qca95xx_ddr_pll_dither_reg_val(0)
                },
        }, {
                800, 400, 200, 25,
                _qca95xx_spi_ctrl_addr_reg_val(8, 1, 0, 2),
                {
                        _qca95xx_cpu_pll_cfg_reg_val(30, 1, 0, 0, 0),
                        _qca95xx_ddr_pll_cfg_reg_val(16, 1, 1, 0, 0),
                        _qca95xx_cpu_ddr_clk_ctrl_reg_val(1, 1, 2, 1, 1, 1),
                        _qca95xx_cpu_pll_dither_reg_val(52),
                        _qca95xx_ddr_pll_dither_reg_val(0)
                }, {
                        _qca95xx_cpu_pll_cfg_reg_val(20, 1, 0, 0, 0),
                        _qca95xx_ddr_pll_cfg_reg_val(10, 1, 1, 0, 0),
                        _qca95xx_cpu_ddr_clk_ctrl_reg_val(1, 1, 2, 1, 1, 1),
                        _qca95xx_cpu_pll_dither_reg_val(0),
                        _qca95xx_ddr_pll_dither_reg_val(0)
                },
        }, {</code></pre></div><p>I&#039;m not 100% sure what all those register values mean and took quite some good guesses how this should look like, but so far the router seems to be stable at 800 / 400 / 200 MHz. Performance has definitely increased quite a bit. <br />If you have some time, could you check if this looks correct? Or give some reference how to calculate these?<br />Thanks!</p>											<p class="post-edited">(Last edited by <strong>freezer2k</strong> on 18 Apr 2016, 18:59)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p320252">
				<div class="post-metadata">
					<div class="post-num">Post #542</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						18 Apr 2016, 19:27					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>freezer2k wrote:</cite><blockquote><p>[...]<br />I bricked my TL-WDR3600 a few days ago by replacing the host_util LZMA 32bit binary with the 64bit one that ships with Ubuntu 15.10; it all compiled and looked fine, but bricked the router in the end.</p></blockquote></div><br /><p>Yep, this problem is old: <a href="https://github.com/pepe2k/u-boot_mod/issues/57">https://github.com/pepe2k/u-boot_mod/issues/57</a><br />I should really take care of it...</p><br /><div class="quotebox"><cite>freezer2k wrote:</cite><blockquote><p>After doing a binary diff with xdelta3, it showed almost 50% difference when using the host_util version vs. the Ubuntu one. Any idea if this is to be expected? Maybe there could be some sort of check that the correct LZMA binary is used in the Makefile? The uncompressed RAM version worked great, so I happily went on flashing ... :]</p></blockquote></div><br /><p>RAM image doesn&#039;t include compressed U-Boot image (take a look here: <a href="https://github.com/pepe2k/u-boot_mod/blob/master/Makefile#L112">https://github.com/pepe2k/u-boot_mod/bl … efile#L112</a>) and any low-level code, so it doesn&#039;t make sense to rely on RAM version tests.</p><p>RAM version should be use only for JTAG approach (low-level and RAM initialization is done using JTAG, then RAM version of the U-Boot is loaded to the device and used to transfer &quot;FLASH&quot; U-Boot image over network etc.). I will include support for OpenOCD for all supported SOCs as soon as I find more free time.</p><p>The easiest way to fix this problem would be include correct LZMA library sources with the code and build them on demand, I will think about it.</p><br /><div class="quotebox"><cite>freezer2k wrote:</cite><blockquote><p>The debrick guide above allowed me to reflash u-boot successfully! Looks like this is a very good option for many devices now. I was looking for an JTAG option quite a long time before finding this, we should link it to every supported device page imho, at least to give some pointer that this could work.</p></blockquote></div><br /><p>Fully agree, this guide is really useful.<br />I have plans to include some guides and ready tools in my repository for JTAG debricking.</p><br /><div class="quotebox"><cite>freezer2k wrote:</cite><blockquote><p>With my router, I also had to remove a bootstrap resistor (for EJTAG mode switch) and short Pin 2 (Data Pin) of the SPI Flash to ground during powerup for the router to be recognized by OpenOCD.<br />See here: <a href="https://wikidevi.com/wiki/TP-LINK_TL-WDR4300">https://wikidevi.com/wiki/TP-LINK_TL-WDR4300</a></p></blockquote></div><br /><p>For the FLASH, it should be enough to use HOLD or CS signals instead of DATA, IMHO it&#039;s proper way to &quot;disable&quot; FLASH chip.</p><p>About the EJTAG mode... I have several WDR3600/4300 and some of them have this bootstrap resistor, other don&#039;t.</p><br /><div class="quotebox"><cite>freezer2k wrote:</cite><blockquote><p>[...]<br />I think its a good idea -- or even required? to add the &#039;erase&#039; option to the flash write_image operation. At one point I bricked the router so hard after writing uboot via JTAG, that I had to de-solder the SPI Flash for external re-flashing. Not sure if this happened due to a bad JTAG wiring or leaving out the erase before writing.</p></blockquote></div><br /><p>For NOR FLASH you should always perform erase before write and it&#039;s because of how that memory type works. During write, you can only change individual bits to zero and erasing sets all bits in blocks/sectors to 1.</p><br /><div class="quotebox"><cite>freezer2k wrote:</cite><blockquote><p>In any case, <strong>thanks a lot</strong> for all your efforts <strong>Pepe</strong>! This is an awesome Project/u-boot version. Even my serial connection works flawless now in u-boot. Before it had lots of errors and only once the linux kernel driver loaded it was suddenly all fine.</p></blockquote></div><br /><p>You&#039;re welcome <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><br /><div class="quotebox"><cite>freezer2k wrote:</cite><blockquote><p>Added two new OC profiles to push the CPU a bit higher,<br />[...]<br />I&#039;m not 100% sure what all those register values mean and took quite some good guesses how this should look like, but so far the router seems to be stable at 800 / 400 / 200 MHz. Performance has definitely increased quite a bit. <br />If you have some time, could you check if this looks correct? Or give some reference how to calculate these?<br />Thanks!</p></blockquote></div><br /><p>I will include more PLL/clocks profiles, but I need to test them on scope. All profiles which are already in code were tested and confirmed on scope as it turned out that VCO (voltage controlled oscillator) has limitations and even if you think that the clock is 600 MHz (remember, clock is just calculated from registers values), it could be totally different.</p><p>For PLL/clock calculations you can refer to this file:<br /><a href="https://github.com/pepe2k/u-boot_mod/blob/master/u-boot/cpu/mips/ar7240/qca_clocks.c">https://github.com/pepe2k/u-boot_mod/bl … a_clocks.c</a></p><p>And pages 39~41, 138~145 in datasheet:<br /><a href="https://github.com/Deoptim/atheros/blob/master/AR9344.pdf">https://github.com/Deoptim/atheros/blob … AR9344.pdf</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p321088">
				<div class="post-metadata">
					<div class="post-num">Post #543</div>
					<div class="post-author">Lennong</div>
					<div class="post-datetime">
						24 Apr 2016, 18:01					</div>
				</div>
				<div class="post-content content">
					<p>Hello pepe2k! Is it possible to add support for the Zsun WiFi SD Card Reader? It&#039;s AR9331 based and a really nice candidate for a weather station project I&#039;m pondering. <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /> I would love to see some serious underclocking capabilities if possible. From what I have read you can go so low as 100/100/100 on it. It should give quite some savings I think.</p><p>OpenWRT is already supported and flashing is fairly easy. It got really good specs for both the size and cost:<br /><a href="https://wiki.hackerspace.pl/projects:zsun-wifi-card-reader#hardware">https://wiki.hackerspace.pl/projects:zs … r#hardware</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p321141">
				<div class="post-metadata">
					<div class="post-num">Post #544</div>
					<div class="post-author">Antinomy</div>
					<div class="post-datetime">
						25 Apr 2016, 02:04					</div>
				</div>
				<div class="post-content content">
					<p>Lennong, I&#039;ve asked the same thing several days ago. He has it on the todo list, we just need to wait.<br />Were you able to make HT40 mode working? Mine is stuck at 20MHz making 72Mb/s rate max.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p321162">
				<div class="post-metadata">
					<div class="post-num">Post #545</div>
					<div class="post-author">Lennong</div>
					<div class="post-datetime">
						25 Apr 2016, 07:11					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Antinomy wrote:</cite><blockquote><p>Lennong, I&#039;ve asked the same thing several days ago. He has it on the todo list, we just need to wait.<br />Were you able to make HT40 mode working? Mine is stuck at 20MHz making 72Mb/s rate max.</p></blockquote></div><p>You will never get HT40 mode with that hardware. You need at least two streams (tx-rx/antennas) with a certain distance between them to be able to do HT40.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p325259">
				<div class="post-metadata">
					<div class="post-num">Post #546</div>
					<div class="post-author">nedoskiv</div>
					<div class="post-datetime">
						22 May 2016, 10:50					</div>
				</div>
				<div class="post-content content">
					<p>Hello,<br /> I just want to say thanks to Pepe for making this mod. I was tested it on&nbsp; TL-WR740N v5 and it work fine, tried it on version 6 - router was bricked.<br />Is there any chance TL-WR740N v6 to be supported? (as long as I read it is 841N v10 identical)</p>											<p class="post-edited">(Last edited by <strong>nedoskiv</strong> on 22 May 2016, 13:14)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p327355">
				<div class="post-metadata">
					<div class="post-num">Post #547</div>
					<div class="post-author">hoatienii</div>
					<div class="post-datetime">
						6 Jun 2016, 05:10					</div>
				</div>
				<div class="post-content content">
					<p>Hi pepe2k!<br />I want to disable LED LAN blinking every boot on my tplink 740 V4. Could you help me!<br />Thanks in advance!</p>											<p class="post-edited">(Last edited by <strong>hoatienii</strong> on 6 Jun 2016, 05:12)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p327814">
				<div class="post-metadata">
					<div class="post-num">Post #548</div>
					<div class="post-author">sebr</div>
					<div class="post-datetime">
						9 Jun 2016, 18:26					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>freezer2k wrote:</cite><blockquote><p>The debrick guide above allowed me to reflash u-boot successfully! Looks like this is a very good option for many devices now. I was looking for an JTAG option quite a long time before finding this, we should link it to every supported device page imho, at least to give some pointer that this could work.</p></blockquote></div><p>You mind sharing more details about this?<br />When i apply the patch I get the following errors:<br /></p><div class="codebox"><pre><code>$ git apply -3 &lt; ath79.patcherror: Anwendung des Patches fehlgeschlagen: src/flash/nor/Makefile.am:32
Falling back to three-way merge...
Applied patch to &#039;src/flash/nor/Makefile.am&#039; cleanly.
Falling back to three-way merge...
Applied patch to &#039;src/flash/nor/ath79.c&#039; cleanly.
error: src/flash/nor/drivers.c ist nicht im Index
error: Anwendung des Patches fehlgeschlagen: src/flash/nor/spi.c:61
Falling back to three-way merge...
Applied patch to &#039;src/flash/nor/spi.c&#039; cleanly.</code></pre></div><p>The make also fails and I guess it is related to patching before:<br /></p><div class="codebox"><pre><code>............
mv -f $depbase.Tpo $depbase.Plo
libtool: compile:  gcc -DHAVE_CONFIG_H -I. -I../../.. -I../../../src -I../../../src -I../../../src/helper -DPKGDATADIR=\&quot;/usr/local/share/openocd\&quot; -DBINDIR=\&quot;/usr/local/bin\&quot; -I../../../jimtcl -I../../../jimtcl -g -O2 -Wall -Wstrict-prototypes -Wformat-security -Wshadow -Wextra -Wno-unused-parameter -Wbad-function-cast -Wcast-align -Wredundant-decls -MT drivers.lo -MD -MP -MF .deps/drivers.Tpo -c drivers.c -o drivers.o
drivers.c:23:1: error: expected identifier or ‘(’ before ‘&lt;&lt;’ token
 &lt;&lt;&lt;&lt;&lt;&lt;&lt; ours
 ^
drivers.c:27:1: error: expected identifier or ‘(’ before ‘==’ token
 =======
 ^
drivers.c:34:1: error: expected identifier or ‘(’ before ‘&gt;&gt;’ token
 &gt;&gt;&gt;&gt;&gt;&gt;&gt; theirs
 ^
drivers.c:42:28: warning: redundant redeclaration of ‘cfi_flash’ [-Wredundant-decls]
 extern struct flash_driver cfi_flash;
                            ^
drivers.c:33:28: note: previous declaration of ‘cfi_flash’ was here
 extern struct flash_driver cfi_flash;
                            ^
drivers.c:52:28: warning: redundant redeclaration of ‘lpc2000_flash’ [-Wredundant-decls]
 extern struct flash_driver lpc2000_flash;
                            ^
drivers.c:29:28: note: previous declaration of ‘lpc2000_flash’ was here
 extern struct flash_driver lpc2000_flash;
                            ^
drivers.c:53:28: warning: redundant redeclaration of ‘lpc288x_flash’ [-Wredundant-decls]
 extern struct flash_driver lpc288x_flash;
                            ^
drivers.c:30:28: note: previous declaration of ‘lpc288x_flash’ was here
 extern struct flash_driver lpc288x_flash;
                            ^
drivers.c:54:28: warning: redundant redeclaration of ‘lpc2900_flash’ [-Wredundant-decls]
 extern struct flash_driver lpc2900_flash;
                            ^
drivers.c:31:28: note: previous declaration of ‘lpc2900_flash’ was here
 extern struct flash_driver lpc2900_flash;
                            ^
drivers.c:55:28: warning: redundant redeclaration of ‘lpcspifi_flash’ [-Wredundant-decls]
 extern struct flash_driver lpcspifi_flash;
                            ^
drivers.c:32:28: note: previous declaration of ‘lpcspifi_flash’ was here
 extern struct flash_driver lpcspifi_flash;
                            ^
drivers.c:84:1: error: expected expression before ‘&lt;&lt;’ token
 &lt;&lt;&lt;&lt;&lt;&lt;&lt; ours
 ^
Makefile:521: die Regel für Ziel „drivers.lo“ scheiterte
make[5]: *** [drivers.lo] Fehler 1
make[5]: Verzeichnis „/home/sr/openocd/src/flash/nor“ wird verlassen
Makefile:476: die Regel für Ziel „all-recursive“ scheiterte
make[4]: *** [all-recursive] Fehler 1
make[4]: Verzeichnis „/home/sr/openocd/src/flash“ wird verlassen
Makefile:620: die Regel für Ziel „all-recursive“ scheiterte
make[3]: *** [all-recursive] Fehler 1
make[3]: Verzeichnis „/home/sr/openocd/src“ wird verlassen
Makefile:457: die Regel für Ziel „all“ scheiterte
make[2]: *** [all] Fehler 2
make[2]: Verzeichnis „/home/sr/openocd/src“ wird verlassen
Makefile:514: die Regel für Ziel „all-recursive“ scheiterte
make[1]: *** [all-recursive] Fehler 1
make[1]: Verzeichnis „/home/sr/openocd“ wird verlassen
Makefile:422: die Regel für Ziel „all“ scheiterte
make: *** [all] Fehler 2</code></pre></div><p>The only change I did was to add --enable-buspirate and remove the parport stuff since I use the buspirate as interface.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p327823">
				<div class="post-metadata">
					<div class="post-num">Post #549</div>
					<div class="post-author">freezer2k</div>
					<div class="post-datetime">
						9 Jun 2016, 20:49					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>sebr wrote:</cite><blockquote><div class="quotebox"><cite>freezer2k wrote:</cite><blockquote><p>The debrick guide above allowed me to reflash u-boot successfully! Looks like this is a very good option for many devices now. I was looking for an JTAG option quite a long time before finding this, we should link it to every supported device page imho, at least to give some pointer that this could work.</p></blockquote></div><p>You mind sharing more details about this?</p></blockquote></div><br /><br /><p>I&#039;m not sure about your patching, but it looks like the fallback mode patched correctly?</p><p>Never seen these compilation errors. </p><p>With the latest OpenOCD and for flashing only, I think this patch is not even required. <br />There should be a ath71xx? target that works with the same config. Config might need some adjustment based on which flash type is used.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p327835">
				<div class="post-metadata">
					<div class="post-num">Post #550</div>
					<div class="post-author">sebr</div>
					<div class="post-datetime">
						9 Jun 2016, 22:54					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for your reply. Now I used the patch command and it revelaed that /src/flash/nor/drivers.c was not patched. Since it was only two additional lines I added them manually. Now no errors and I can build OpenOCD without errors.<br />But I cannot communicate with the target or halt it. The bootstrap resistor is not present. Since I have only connected VTref, GND, TDI, TDO, TMS and TCK the reset configuration of my buspirate should not matter. <a href="http://dangerousprototypes.com/docs/Bus_Pirate_JTAG_connections_for_OpenOCD">Here</a> is the interface config.I wonder what I am doing wrong.</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 22 of 25</div><nav><ul><li><a href="viewtopic.php%3Fid=43237&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=43237&amp;p=20.html">20</a></li><li><a href="viewtopic.php%3Fid=43237&amp;p=21.html">21</a></li><li class="pagination-current"><span>22</span></li><li><a href="viewtopic.php%3Fid=43237&amp;p=23.html">23</a></li><li><a href="viewtopic.php%3Fid=43237&amp;p=24.html">24</a></li><li><a href="viewtopic.php%3Fid=43237&amp;p=25.html">25</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0.001 -->

</body>
</html>