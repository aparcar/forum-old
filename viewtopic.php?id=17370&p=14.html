<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> New Broadcom BCM63xx codebase with GPL&#039;d Ethernet and USB support</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 8 Feb 2018 and 7 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 14 of 30</div><nav><ul><li><a href="viewtopic.php%3Fid=17370&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=17370&amp;p=12.html">12</a></li><li><a href="viewtopic.php%3Fid=17370&amp;p=13.html">13</a></li><li class="pagination-current"><span>14</span></li><li><a href="viewtopic.php%3Fid=17370&amp;p=15.html">15</a></li><li><a href="viewtopic.php%3Fid=17370&amp;p=16.html">16</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=17370&amp;p=30.html">30</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p85099">
				<div class="post-metadata">
					<div class="post-num">Post #326</div>
					<div class="post-author">fw_crocodile</div>
					<div class="post-datetime">
						3 Apr 2009, 18:03					</div>
				</div>
				<div class="post-content content">
					<p>(ALICE GATE VOIP 2 PLUS WIFI BUSINESS)</p><p>Hi,</p><p>today we will try the last trunk revision to test the echi module.</p><p>I&#039;ve a question:</p><p>the kernel found two switch, one on eth0 with driver adm6996 which doesn&#039;t seem to be connected on any port, and one roboswitch (driver bcm53xx) on eth1 wich work perfectly. Naturally eth0 and eth1 have two different mac.</p><p>Any idea of what is the eth0 interface? Something related with adsl or voip interfaces?</p><p>In the mean time we have made some test with the ROBOSwitch.</p><p>Internal Port: 5<br />Switch Port: 0 1 2 3 (respectively port labeled 1 2 3 4)<br />The port number 4 appear to be unused.</p><p>So for example (as the dsl modem doesn&#039;t work and you wish to use an external modem):<br /></p><div class="codebox"><pre><code>config switch eth1
    option vlan0 &quot;0 1 2 5*&quot;
    option vlan1 &quot;3 5&quot;</code></pre></div><p>Will let you use the eth1.1 in the ifname option of your wan section.</p><p>Is it possible to have a different /etc/config/network files only on the agpf-s0 image? Or I could just change the included packages with the profiles method.</p>											<p class="post-edited">(Last edited by <strong>fw_crocodile</strong> on 11 Apr 2009, 16:30)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85101">
				<div class="post-metadata">
					<div class="post-num">Post #327</div>
					<div class="post-author">fw_crocodile</div>
					<div class="post-datetime">
						3 Apr 2009, 18:11					</div>
				</div>
				<div class="post-content content">
					<p>May be an error in the board_bcm963xx.c?</p><p>I should delete or disable one &quot;enet&quot; ?</p><p>What are exactly the meaning of has_enet and why enet0 and enet1 have different settings?</p><p>See .has_phy .has_internal_phy .force_speed .force_duplex_full.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85133">
				<div class="post-metadata">
					<div class="post-num">Post #328</div>
					<div class="post-author">florian_</div>
					<div class="post-datetime">
						4 Apr 2009, 18:44					</div>
				</div>
				<div class="post-content content">
					<p>There is nothing wrong with the current configuration. What is happening is that the switch driver probes for two known types of switches : ADM6996 and Broadcom BCM536x. It first probes for the ADM6996 switch and then for the broadcom switch. Eth0 is the &quot;WAN&quot; port of the device and has an internal phy and one dedicated Ethernet MAC. Eth1 is connected to a switch (external) using MII and also has a dedicated ethernet MAC. You should not have to modify anything.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85135">
				<div class="post-metadata">
					<div class="post-num">Post #329</div>
					<div class="post-author">fw_crocodile</div>
					<div class="post-datetime">
						4 Apr 2009, 21:16					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>florian_ wrote:</cite><blockquote><p>There is nothing wrong with the current configuration. What is happening is that the switch driver probes for two known types of switches : ADM6996 and Broadcom BCM536x. It first probes for the ADM6996 switch and then for the broadcom switch. Eth0 is the &quot;WAN&quot; port of the device and has an internal phy and one dedicated Ethernet MAC. Eth1 is connected to a switch (external) using MII and also has a dedicated ethernet MAC. You should not have to modify anything.</p></blockquote></div><p>Perfect, thank&#039;s for the answer.</p><p>So eth0 is related to the adsl part of the SoC? That&#039;s the only wan port available on the alice.</p><p>What surprise me (not the only thing :-)) is that the external (eth1) is recognized by the driver as a bcm53xx, and the internal as an AMD6996. As the SoC is a broadcom device i would have expected to opposite.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85184">
				<div class="post-metadata">
					<div class="post-num">Post #330</div>
					<div class="post-author">florian_</div>
					<div class="post-datetime">
						5 Apr 2009, 21:27					</div>
				</div>
				<div class="post-content content">
					<p>Humm, I badly explained the goal of eth0, eth0 can also be used a the TV decoder port. There is no support for the ADSL interface yet. I do not know how they connected the two Ethernet MACs on the Alice box but I do not think there is an ADM6996 switch at all, rather it&#039;s misdetected.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85193">
				<div class="post-metadata">
					<div class="post-num">Post #331</div>
					<div class="post-author">fw_crocodile</div>
					<div class="post-datetime">
						5 Apr 2009, 23:58					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>florian_ wrote:</cite><blockquote><p>I do not think there is an ADM6996 switch at all, rather it&#039;s misdetected.</p></blockquote></div><p>That was my first tought, but they have two different mac.</p><p>eth1 (bcm53xx) is certainly on the 4 port switch, the vlan capabilities works perfectly.</p><p>There are other two VoIP port but I think they are FXS, so i suppose connected to the DSP, but i can be wrong on that, i will try to see if they are not simple ethernet port on eth0.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85241">
				<div class="post-metadata">
					<div class="post-num">Post #332</div>
					<div class="post-author">ramponis</div>
					<div class="post-datetime">
						6 Apr 2009, 16:03					</div>
				</div>
				<div class="post-content content">
					<p>I have compiled a new image from the last trunk.<br />I have flashed it into my Pirelli gate voip 2+ wi-fi, but after restart, when it try to run the imge it show me this error:</p><div class="codebox"><pre><code>Trying to boot from FIRST image copy (0x80010000) ...
 latest imageSequence found: ... 0
 - Flash Kernel Address: 0xBE020100
 - Tag-&gt;kernelLen: 0x000C4271
 - Flash Kernel Address: 0xBE020100
Linux kernel CRC error.  Corrupted image?
 - Tag Kernel crc : 0x7E784BFE - calculated: 0x7415DA04
web info: Waiting for connection on socket 0.</code></pre></div><p>Is the trunk bugged?</p><p>I have re-tried my previus build and it works, so it&#039;s a problem of the trunk version</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85248">
				<div class="post-metadata">
					<div class="post-num">Post #333</div>
					<div class="post-author">fw_crocodile</div>
					<div class="post-datetime">
						6 Apr 2009, 16:37					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ramponis wrote:</cite><blockquote><p>I have compiled a new image from the last trunk.<br />I have flashed it into my Pirelli gate voip 2+ wi-fi, but after restart, when it try to run the imge it show me this error:</p><div class="codebox"><pre><code>Linux kernel CRC error.  Corrupted image?
 - Tag Kernel crc : 0x7E784BFE - calculated: 0x7415DA04</code></pre></div><p>I have re-tried my previus build and it works, so it&#039;s a problem of the trunk version</p></blockquote></div><p>Yes there is a little problem to resolv with imagetag, because the CFE from various modem keep a different behaviour. I&#039;m waiting to have an alice under my hands to resolv elegantly the problem (i hope before the end of the week) and file the solution to florian.</p><p>For the moment just commenting line 194 in the source of imagetag (tools/firmware-utils/src/imagetag.c) resolv the problem.</p><div class="codebox"><pre><code>/* Write the RootFS */
        fseek(binfile, rootfsoff - fwaddr, SEEK_SET);
        while (rootfsfile &amp;&amp; !feof(rootfsfile) &amp;&amp; !ferror(rootfsfile)) {
                read = fread(readbuf, sizeof(uint8_t), sizeof(readbuf), rootfsfile);
                crc = crc32(crc, readbuf, read);
                fwrite(readbuf, sizeof(uint8_t), read, binfile);
        }</code></pre></div><div class="codebox"><pre><code>/* Write the RootFS */
        fseek(binfile, rootfsoff - fwaddr, SEEK_SET);
        while (rootfsfile &amp;&amp; !feof(rootfsfile) &amp;&amp; !ferror(rootfsfile)) {
                read = fread(readbuf, sizeof(uint8_t), sizeof(readbuf), rootfsfile);
//              crc = crc32(crc, readbuf, read);
                fwrite(readbuf, sizeof(uint8_t), read, binfile);
        }</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85255">
				<div class="post-metadata">
					<div class="post-num">Post #334</div>
					<div class="post-author">ramponis</div>
					<div class="post-datetime">
						6 Apr 2009, 18:26					</div>
				</div>
				<div class="post-content content">
					<p>Thank you fw_crocodile.</p><p>Now it works <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85258">
				<div class="post-metadata">
					<div class="post-num">Post #335</div>
					<div class="post-author">ramponis</div>
					<div class="post-datetime">
						6 Apr 2009, 19:01					</div>
				</div>
				<div class="post-content content">
					<p>if i can... other question</p><p>i have loaded only the usb1 support</p><p>i tried ti plug a little usb pen from the serial i see that the router recognize it</p><div class="codebox"><pre><code>usb 1-1: new full speed USB device using bcm63xx_ohci and addres
s 2
usb 1-1: configuration #1 chosen from 1 choice
scsi0 : SCSI emulation for USB Mass Storage devices
scsi 0:0:0:0: Direct-Access              USB BAR          1.13 PQ: 0 ANSI: 0 CCS
sd 0:0:0:0: [sda] 253952 512-byte hardware sectors (130 MB)
sd 0:0:0:0: [sda] Write Protect is off
sd 0:0:0:0: [sda] Assuming drive cache: write through
sd 0:0:0:0: [sda] 253952 512-byte hardware sectors (130 MB)
sd 0:0:0:0: [sda] Write Protect is off
sd 0:0:0:0: [sda] Assuming drive cache: write through
 sda:
sd 0:0:0:0: [sda] Attached SCSI removable disk</code></pre></div><p>But it do not mount it, why?</p><p>I have tried to install a lot the packages but the problem remain</p><div class="codebox"><pre><code>kmod-fs-ext2 2.6.27.21-brcm63xx-1  
kmod-fs-ext3 2.6.27.21-brcm63xx-1  
kmod-fs-msdos 2.6.27.21-brcm63xx-1  
kmod-fs-ntfs 2.6.27.21-brcm63xx-1  
kmod-fs-udf 2.6.27.21-brcm63xx-1  
kmod-fs-vfat 2.6.27.21-brcm63xx-1  
kmod-nls-base 2.6.27.21-brcm63xx-1  
kmod-nls-cp1250 2.6.27.21-brcm63xx-1  
kmod-nls-cp1251 2.6.27.21-brcm63xx-1  
kmod-nls-cp437 2.6.27.21-brcm63xx-1  
kmod-nls-cp850 2.6.27.21-brcm63xx-1  
kmod-nls-cp852 2.6.27.21-brcm63xx-1  
kmod-nls-iso8859-1 2.6.27.21-brcm63xx-1  
kmod-nls-iso8859-15 2.6.27.21-brcm63xx-1  
kmod-nls-iso8859-2 2.6.27.21-brcm63xx-1  
kmod-nls-koi8r 2.6.27.21-brcm63xx-1  
kmod-nls-utf8 2.6.27.21-brcm63xx-1  
kmod-ppp 2.6.27.21-brcm63xx-1  
kmod-pppoe 2.6.27.21-brcm63xx-1  
kmod-scsi-core 2.6.27.21-brcm63xx-1  
kmod-switch 2.6.27.21-brcm63xx-1  
kmod-usb-core 2.6.27.21-brcm63xx-1  
kmod-usb-ohci 2.6.27.21-brcm63xx-1  
kmod-usb-storage</code></pre></div><p>If i add kmod-usb2_2.6.27.21-brcm63xx-1</p><p>when i plug the usb pen into the port, from the serial i receive continuously...</p><p>hub 2-0:1.0: over-current change on port 2<br />hub 2-0:1.0: over-current change on port 2<br />hub 2-0:1.0: over-current change on port 2<br />hub 2-0:1.0: over-current change on port 2<br />hub 2-0:1.0: over-current change on port 2<br />hub 2-0:1.0: over-current change on port 2<br />hub 2-0:1.0: over-current change on port 2<br />...</p>											<p class="post-edited">(Last edited by <strong>ramponis</strong> on 6 Apr 2009, 19:06)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85392">
				<div class="post-metadata">
					<div class="post-num">Post #336</div>
					<div class="post-author">ramponis</div>
					<div class="post-datetime">
						8 Apr 2009, 19:24					</div>
				</div>
				<div class="post-content content">
					<p>Compiled and flashed r15157<br />Same problem on the usb</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85439">
				<div class="post-metadata">
					<div class="post-num">Post #337</div>
					<div class="post-author">cshore</div>
					<div class="post-datetime">
						9 Apr 2009, 04:35					</div>
				</div>
				<div class="post-content content">
					<p>Okay I&#039;ve been working on the imagetag to try to get the stock firmware to flash via web or tftp.&nbsp; I&#039;ve looked at the source and the rootfs is used to specify the beginning of the area to be flashed. I was able to get the board to boot a kernel by setting both the kernel and rootfs offset to the kernel offset, but the kernel panics when loading the rootfs because the mtdblock2 is pointing to the wrong offset (kernel offset).&nbsp; </p><p>I don&#039;t know how to fix this unless the kernel can be made to use reverse the kernel and rootfs mtd (maybe use a reserved section of the imagetag to specify that that is how the tag is written, so that &#039;normal&#039; tags don&#039;t reverse things?)</p><p>... Oh wait, that won&#039;t work.&nbsp; The kernel offset still needs to be the kernel offset or the router can&#039;t boot (I tried it)</p><p>Any way to have the rootfs then kernel like the stock firmware?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85451">
				<div class="post-metadata">
					<div class="post-num">Post #338</div>
					<div class="post-author">florian_</div>
					<div class="post-datetime">
						9 Apr 2009, 12:52					</div>
				</div>
				<div class="post-content content">
					<p>Provided that you tell imagetag to first insert the rootfs then the kernel and you make the bcm963xx-flash driver aware of that I do not see a reason why this should not work. At least since we are that way consistent with what&#039;s on the flash it should be working, what do you think about this ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85452">
				<div class="post-metadata">
					<div class="post-num">Post #339</div>
					<div class="post-author">florian_</div>
					<div class="post-datetime">
						9 Apr 2009, 12:56					</div>
				</div>
				<div class="post-content content">
					<p>Seems like the offending part of the MTD driver is located between lines 105 and 120. Both the kernellen and rootfslen are non zero, so both will have their MTD parts created, but not in the right order since we are checking first for the kernel lenght and then the rootfs lenght. Inverting both should do the trick.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85453">
				<div class="post-metadata">
					<div class="post-num">Post #340</div>
					<div class="post-author">florian_</div>
					<div class="post-datetime">
						9 Apr 2009, 13:06					</div>
				</div>
				<div class="post-content content">
					<p>cshore, does such a patch work for you ?</p><div class="codebox"><pre><code>Index: tools/firmware-utils/src/imagetag.c
===================================================================
--- tools/firmware-utils/src/imagetag.c (revision 15145)
+++ tools/firmware-utils/src/imagetag.c (working copy)
@@ -155,42 +155,42 @@
                return 1;
        }

-       /* Build the kernel address and length (doesn&#039;t need to be aligned, read only) */
-       kerneloff = fwaddr + sizeof(tag);
-       kernellen = getlen(kernelfile);
+       /* Build the rootfs address and length (doesn&#039;t need to be aligned, read only) */
+       rootfsoff = fwaddr + sizeof(tag);
+       rootfslen = getlen(rootfsfile);

        /* Build the kernel header */
        khdr.loadaddr   = htonl(loadaddr);
        khdr.entry      = htonl(entry);
-       khdr.lzmalen    = htonl(kernellen);
+       khdr.lzmalen    = htonl(getlen(kernelfile));

        /* Increase the kernel size by the header size */
-       kernellen += sizeof(khdr);
+       rootfslen += sizeof(khdr);

        /* Build the rootfs address and length (start and end do need to be aligned on flash erase block boundaries */
-       rootfsoff = kerneloff + kernellen;
-       rootfsoff = (rootfsoff % flash_bs) &gt; 0 ? (((rootfsoff / flash_bs) + 1) * flash_bs) : rootfsoff;
-       rootfslen = getlen(rootfsfile);
-       rootfslen = (rootfslen % flash_bs) &gt; 0 ? (((rootfslen / flash_bs) + 1) * flash_bs) : rootfslen;
+       kerneloff = rootfsoff + rootfslen;
+       kerneloff = (kerneloff % flash_bs) &gt; 0 ? (((kerneloff / flash_bs) + 1) * flash_bs) : kerneloff;
+       kernellen = getlen(kernelfile);
+       kernellen = (kernellen % flash_bs) &gt; 0 ? (((kernellen / flash_bs) + 1) * flash_bs) : kernellen;

-       /* Seek to the start of the kernel */
-       fseek(binfile, kerneloff - fwaddr, SEEK_SET);
+       /* Seek to the start of the rootfs */
+       fseek(binfile, rootfsoff - fwaddr, SEEK_SET);

        /* Write the kernel header */
        crc = crc32(IMAGETAG_CRC_START, (uint8_t*)&amp;khdr, sizeof(khdr));
        fwrite(&amp;khdr, sizeof(khdr), 1, binfile);

-       /* Write the kernel */
-       while (kernelfile &amp;&amp; !feof(kernelfile) &amp;&amp; !ferror(kernelfile)) {
-               read = fread(readbuf, sizeof(uint8_t), sizeof(readbuf), kernelfile);
+       /* Write the rootfs */
+       while (rootfsfile &amp;&amp; !feof(rootfsfile) &amp;&amp; !ferror(rootfsfile)) {
+               read = fread(readbuf, sizeof(uint8_t), sizeof(readbuf), rootfsfile);
                crc = crc32(crc, readbuf, read);
                fwrite(readbuf, sizeof(uint8_t), read, binfile);
        }

-       /* Write the RootFS */
-       fseek(binfile, rootfsoff - fwaddr, SEEK_SET);
-       while (rootfsfile &amp;&amp; !feof(rootfsfile) &amp;&amp; !ferror(rootfsfile)) {
-               read = fread(readbuf, sizeof(uint8_t), sizeof(readbuf), rootfsfile);
+       /* Write the kernel */
+       fseek(binfile, kerneloff - fwaddr, SEEK_SET);
+       while (kernelfile &amp;&amp; !feof(kernelfile) &amp;&amp; !ferror(kernelfile)) {
+               read = fread(readbuf, sizeof(uint8_t), sizeof(readbuf), kernelfile);
                //crc = crc32(crc, readbuf, read);
                fwrite(readbuf, sizeof(uint8_t), read, binfile);
        }
Index: target/linux/brcm63xx/files/drivers/mtd/maps/bcm963xx-flash.c
===================================================================
--- target/linux/brcm63xx/files/drivers/mtd/maps/bcm963xx-flash.c       (revision 15145)
+++ target/linux/brcm63xx/files/drivers/mtd/maps/bcm963xx-flash.c       (working copy)
@@ -103,13 +103,6 @@
        parts[curpart].size = master-&gt;erasesize;
        curpart++;

-       if (kernellen &gt; 0) {
-               parts[curpart].name = &quot;kernel&quot;;
-               parts[curpart].offset = kerneladdr;
-               parts[curpart].size = kernellen;
-               curpart++;
-       };
-
        if (rootfslen &gt; 0) {
                parts[curpart].name = &quot;rootfs&quot;;
                parts[curpart].offset = rootfsaddr;
@@ -118,6 +111,12 @@
                        parts[curpart].size += sparelen;
                curpart++;
        };
+       if (kernellen &gt; 0) {
+               parts[curpart].name = &quot;kernel&quot;;
+               parts[curpart].offset = kerneladdr;
+               parts[curpart].size = kernellen;
+               curpart++;
+       };
        parts[curpart].name = &quot;nvram&quot;;
        parts[curpart].offset = master-&gt;size - master-&gt;erasesize;
        parts[curpart].size = master-&gt;erasesize;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85468">
				<div class="post-metadata">
					<div class="post-num">Post #341</div>
					<div class="post-author">fw_crocodile</div>
					<div class="post-datetime">
						9 Apr 2009, 18:12					</div>
				</div>
				<div class="post-content content">
					<p>IMAGETAG</p><p>I&#039;m working on imagetag to give it more adaptabilty (some more options on how to build the image and compute the CRC32)</p><p>It&#039;s almost done but i have some question as the only device on which i can test it is the Alice Gate VoIP 2 Plus ....</p><p>(I can definitely confirm that the Alice consider to CRC32 of the image as the crc32 of the kernel)</p><p>1 - Imagetag use a wrong image lenght?<br /></p><div class="codebox"><pre><code>sprintf(tag.imagelen, &quot;%lu&quot;, kernellen + rootfslen);</code></pre></div><p>But the real lenght&nbsp; should be<br /></p><div class="codebox"><pre><code>sprintf(tag.imagelen, &quot;%lu&quot;, rootfsoff + rootfslen - kerneloff);</code></pre></div><p>to include the rootfsoff alignement</p><p>2 - At present the crc32 is computed directly from the vmlinux and rootfs files (and tag structure). But this time too the crc32 do not consider the alignement of both rootfsoff and rootfslen in the final image.</p><p>Everything should remain as is, or these are errors that don&#039;t caused problem for the moment but should be corrected?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85495">
				<div class="post-metadata">
					<div class="post-num">Post #342</div>
					<div class="post-author">cshore</div>
					<div class="post-datetime">
						9 Apr 2009, 23:26					</div>
				</div>
				<div class="post-content content">
					<p>@florian: <br />Thanks.&nbsp; I&#039;ll test tonight; I think the flash driver part was what I needed - I need to change imagetag differently because the crc calculation is wrong in the one in svn.&nbsp; I&#039;ve figured out how to get it right, the part I was missing was swapping the rootfs and kernelfs mtd because of the fact the stock firmware is stupid and requires that the rootfs offset be the offset of the start of the image (after tag).</p><p>@fw_crocodile: <br />The crc calculation needs to do any padding needed to start on an erase boundary, rootfs, then any padding to even out erase boundaries, then kernel header, then kernel, then any kernel padding for erase boundaries (that last padding may not be necessary).&nbsp; I should have a patch for that tonight.</p><p>Doing that will allow for loading from the stock firmware web/tftp interface (broadcom supplies that code so most broadcom based boards will work with these changes).</p><p>I should have a patch tonight.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85498">
				<div class="post-metadata">
					<div class="post-num">Post #343</div>
					<div class="post-author">cshore</div>
					<div class="post-datetime">
						10 Apr 2009, 00:04					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>fw_crocodile wrote:</cite><blockquote><p>In the mean time we have made some test with the ROBOSwitch.</p><p>Internal Port: 5<br />Switch Port: 0 1 2 3 (respectively port labeled 1 2 3 4)<br />The port number 4 appear to be unused.</p><p>So for example (as the dsl modem doesn&#039;t work and you wish to use an external modem):<br /></p><div class="codebox"><pre><code>config switch
    vlan0 &quot;0 1 2 5*&quot;
    vlan1 &quot;3 5&quot;</code></pre></div><p>Will let you use the eth1.1 in the ifname option of your wan section.</p></blockquote></div><p>Do you have to run robocfg to setup up the vlans first?&nbsp; I used something like that code but it didn&#039;t do anything to the switch, so I&#039;ve been using the switch setup script called by the network setup init script in order to do some robocfg settings first so that vlan&#039;s are available (otherwise the above, for me, was just calling vconfig, but not configuring the switch, so the vlan&#039;s didn&#039;t actually work).</p>											<p class="post-edited">(Last edited by <strong>cshore</strong> on 10 Apr 2009, 00:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85501">
				<div class="post-metadata">
					<div class="post-num">Post #344</div>
					<div class="post-author">fw_crocodile</div>
					<div class="post-datetime">
						10 Apr 2009, 00:46					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>cshore wrote:</cite><blockquote><p>@fw_crocodile: <br />The crc calculation needs to do any padding needed to start on an erase boundary, rootfs, then any padding to even out erase boundaries, then kernel header, then kernel, then any kernel padding for erase boundaries (that last padding may not be necessary).&nbsp; I should have a patch for that tonight.</p><p>Doing that will allow for loading from the stock firmware web/tftp interface (broadcom supplies that code so most broadcom based boards will work with these changes).</p><p>I should have a patch tonight.</p></blockquote></div><p>I&#039;ve done some work on imagetag in the past day, take a look at ticket 4909. It&#039;s my first try in C so there are probably some possible improvement.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85592">
				<div class="post-metadata">
					<div class="post-num">Post #345</div>
					<div class="post-author">fw_crocodile</div>
					<div class="post-datetime">
						11 Apr 2009, 01:33					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>cshore wrote:</cite><blockquote><p>Do you have to run robocfg to setup up the vlans first?&nbsp; I used something like that code but it didn&#039;t do anything to the switch, so I&#039;ve been using the switch setup script called by the network setup init script in order to do some robocfg settings first so that vlan&#039;s are available (otherwise the above, for me, was just calling vconfig, but not configuring the switch, so the vlan&#039;s didn&#039;t actually work).</p></blockquote></div><p>I made a stupid error in the above post.</p><p>If you use the same syntax as I posted above (i just correct it know to avoid furter problem) it&#039;will certainly not work as I forgot the term &quot;option&quot;.</p><p>So a correct config section for the switch is:</p><div class="codebox"><pre><code>config switch eth1
    option vlan0 &quot;0 1 2 5*&quot;
    option vlan1 &quot;3 5&quot;</code></pre></div><p>without the &quot;option&quot; option_cb () (switch.sh) is never called, and consequentially neither setup_switch_vlan () which does the echo in /proc/switch/ethX/vlan/X/ports.</p><p>You need to specify the ethernet port too.</p><p>So finally robocfg is not needed.</p><p>Sorry for the mistake.</p>											<p class="post-edited">(Last edited by <strong>fw_crocodile</strong> on 11 Apr 2009, 16:31)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85669">
				<div class="post-metadata">
					<div class="post-num">Post #346</div>
					<div class="post-author">vxdxv</div>
					<div class="post-datetime">
						12 Apr 2009, 13:16					</div>
				</div>
				<div class="post-content content">
					<p>After getting kamikaze 8.09 source, configuring it for BCM 6358 and building it i&#039;ve got following in bin folder:<br /></p><div class="codebox"><pre><code>openwrt-96345GW2-jffs2-128k-cfe.bin
openwrt-96345GW2-jffs2-64k-cfe.bin
openwrt-96345GW2-squashfs-cfe.bin
openwrt-96348GW-10-jffs2-128k-cfe.bin
openwrt-96348GW-10-jffs2-64k-cfe.bin
openwrt-96348GW-10-squashfs-cfe.bin
openwrt-96348GW-11-jffs2-128k-cfe.bin
openwrt-96348GW-11-jffs2-64k-cfe.bin
openwrt-96348GW-11-squashfs-cfe.bin
openwrt-96348GW-A-jffs2-128k-cfe.bin
openwrt-96348GW-A-jffs2-64k-cfe.bin
openwrt-96348GW-A-squashfs-cfe.bin
openwrt-96348GW-jffs2-128k-cfe.bin
openwrt-96348GW-jffs2-64k-cfe.bin
openwrt-96348GW-squashfs-cfe.bin
openwrt-96358VW-jffs2-128k-cfe.bin
openwrt-96358VW-jffs2-64k-cfe.bin
openwrt-96358VW-squashfs-cfe.bin
openwrt-AGPF-S0-jffs2-128k-cfe.bin
openwrt-AGPF-S0-jffs2-64k-cfe.bin
openwrt-AGPF-S0-squashfs-cfe.bin
openwrt-brcm63xx-jffs2-128k.trx
openwrt-brcm63xx-jffs2-64k.trx
openwrt-brcm63xx-root.jffs2-128k
openwrt-brcm63xx-root.jffs2-64k
openwrt-brcm63xx-root.squashfs
openwrt-brcm63xx-squashfs.trx
openwrt-DV201AMR-jffs2-128k-cfe.bin
openwrt-DV201AMR-jffs2-64k-cfe.bin
openwrt-DV201AMR-squashfs-cfe.bin
openwrt-F@ST2404-jffs2-128k-cfe.bin
openwrt-F@ST2404-jffs2-64k-cfe.bin
openwrt-F@ST2404-squashfs-cfe.bin
openwrt-livebox-vmlinux.elf
openwrt-livebox-vmlinux.gz
openwrt-livebox-vmlinux.lzma</code></pre></div><p>what of these files i need to flash to my device?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85689">
				<div class="post-metadata">
					<div class="post-num">Post #347</div>
					<div class="post-author">marca56</div>
					<div class="post-datetime">
						12 Apr 2009, 19:45					</div>
				</div>
				<div class="post-content content">
					<p>Hi, V....</p><p>If you have a 6358 on the board, you can narrow it down to the following list:</p><p>openwrt-96358VW-jffs2-128k-cfe.bin<br />openwrt-96358VW-jffs2-64k-cfe.bin<br />openwrt-96358VW-squashfs-cfe.bin</p><p>I would start with the last one because squashfs is the most compact and the one that Broadcom recommends. </p><p>marc.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85734">
				<div class="post-metadata">
					<div class="post-num">Post #348</div>
					<div class="post-author">vxdxv</div>
					<div class="post-datetime">
						13 Apr 2009, 20:01					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>marca56 wrote:</cite><blockquote><p>Hi, V....</p><p>If you have a 6358 on the board, you can narrow it down to the following list:</p><p>openwrt-96358VW-jffs2-128k-cfe.bin<br />openwrt-96358VW-jffs2-64k-cfe.bin<br />openwrt-96358VW-squashfs-cfe.bin</p><p>I would start with the last one because squashfs is the most compact and the one that Broadcom recommends. </p><p>marc.</p></blockquote></div><p>Hi, Marc. I tried to put all of these files, but have no success. For flashing i tried to use tftp but everything i&#039;ve got is &quot;timeout expired&quot;. If i put firmware via ftp i&#039;ve got: </p><div class="codebox"><pre><code>iptables v1.2.11: can&#039;t initialize iptables table `filter&#039;: iptables who? (do yo
u need to insmod?)
Perhaps iptables or your kernel needs to be upgraded.
Image updating failed. The selected file contains an illegal image.  PLEASE TYPE
 &#039;bye&#039; or &#039;quit&#039; NOW to quit ftp</code></pre></div><p>Any ideas about flashing?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85739">
				<div class="post-metadata">
					<div class="post-num">Post #349</div>
					<div class="post-author">marca56</div>
					<div class="post-datetime">
						13 Apr 2009, 21:30					</div>
				</div>
				<div class="post-content content">
					<p>V...</p><p>I&#039;m guessing that you don&#039;t know how to flash using the tftp from the CFE.</p><p>Do you have a serial console to the 6358? You will need that to stop the CFE from booting the installed image. </p><p>When the board starts up, there is a built in delay of between 1 and 3 seconds where you can hit Ctrl + C to get to the CFE prompt. Once you have the CFE prompt, you can enter a command like: flashimage openwrt-96358VW-squashfs-cfe.bin:192.168.1.10. If you setup your laptop with a fixed IP address of 192.168.1.10 and put the openwrt-96358VW-squashfs-cfe.bin in the tftp server root directory, then the flashimage command will suck down the image and you&#039;ll see some information in the telnet console and when done, the board will reboot. </p><p>There are two built in Ethernet ports on the 6358. The phy0 is the one that needs to be connected to the laptop.</p><p>marc.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85821">
				<div class="post-metadata">
					<div class="post-num">Post #350</div>
					<div class="post-author">cshore</div>
					<div class="post-datetime">
						14 Apr 2009, 14:08					</div>
				</div>
				<div class="post-content content">
					<p>imagetag for flashing kamakize from any generic broadcom stock firmware tftp or web interface.&nbsp; (Alice Gate is not generic).</p><p>@florian:</p><p>&nbsp; That patch doesn&#039;t work, but I have (finally) got one that does.&nbsp; I can&#039;t post to Trac right now because it isn&#039;t working (502 Bad Gateway)</p><div class="codebox"><pre><code>diff --git a/target/linux/brcm63xx/files/drivers/mtd/maps/bcm963xx-flash.c b/target/linux/brcm63xx/files/drivers/mtd/maps/bcm963xx-flash.c
index d17baf2..7c82527 100644
--- a/target/linux/brcm63xx/files/drivers/mtd/maps/bcm963xx-flash.c
+++ b/target/linux/brcm63xx/files/drivers/mtd/maps/bcm963xx-flash.c
@@ -114,14 +114,15 @@ static int parse_cfe_partitions( struct mtd_info *master, struct mtd_partition *
         parts[curpart].name = &quot;rootfs&quot;;
         parts[curpart].offset = rootfsaddr;
         parts[curpart].size = rootfslen;
-        if (sparelen &gt; 0)
-            parts[curpart].size += sparelen;
+                   if (sparelen &gt; 0)
+                parts[curpart].size += sparelen;
         curpart++;
     };
+
     parts[curpart].name = &quot;nvram&quot;;
     parts[curpart].offset = master-&gt;size - master-&gt;erasesize;
     parts[curpart].size = master-&gt;erasesize;
-       
+
     for (i = 0; i &lt; nrparts; i++)
         printk(KERN_INFO PFX &quot;Partition %d is %s offset %x and length %x\n&quot;, i, parts[i].name, parts[i].offset, parts[i].size);
 
diff --git a/target/linux/brcm63xx/files/include/asm-mips/mach-bcm63xx/bcm_tag.h b/target/linux/brcm63xx/files/include/asm-mips/mach-bcm63xx/bcm_tag.h
index efc4f02..0de957c 100644
--- a/target/linux/brcm63xx/files/include/asm-mips/mach-bcm63xx/bcm_tag.h
+++ b/target/linux/brcm63xx/files/include/asm-mips/mach-bcm63xx/bcm_tag.h
@@ -14,13 +14,16 @@ struct bcm_tag {
     unsigned char totalLength[IMAGE_LEN];           //Total length of image
     unsigned char cfeAddress[ADDRESS_LEN];  // Address in memory of CFE
     unsigned char cfeLength[IMAGE_LEN];             // Size of CFE
-    unsigned char rootAddress[ADDRESS_LEN];         // Address in memory of rootfs
-    unsigned char rootLength[IMAGE_LEN];            // Size of rootfs
+    unsigned char cfeRootAddress[ADDRESS_LEN];         // Address in memory of rootfs (for broadcom; for wrt this is only used for flashing the image and is offset of the image)
+    unsigned char cfeRootLength[IMAGE_LEN];            // Size of rootfs
     unsigned char kernelAddress[ADDRESS_LEN];       // Address in memory of kernel
     unsigned char kernelLength[IMAGE_LEN];  // Size of kernel
     unsigned char dualImage[2];                             // Unused at present
     unsigned char inactiveFlag[2];                  // Unused at present
-    unsigned char reserved1[74];                            // Reserved area not in use
+    unsigned char reserved1[52];                            // Reserved area not in use
+    unsigned char rootAddress[ADDRESS_LEN];         // Address in memory of rootfs
+    unsigned char rootLength[IMAGE_LEN];            // Size of rootfs
+
     unsigned char imageCRC[4];                              // CRC32 of images
     unsigned char reserved2[16];                            // Unused at present
     unsigned char headerCRC[4];                             // CRC32 of header excluding tagVersion
diff --git a/target/linux/brcm63xx/image/Makefile b/target/linux/brcm63xx/image/Makefile
index b6ef968..9db2363 100644
--- a/target/linux/brcm63xx/image/Makefile
+++ b/target/linux/brcm63xx/image/Makefile
@@ -28,17 +28,16 @@ define trxalign/squashfs
 endef
 
 define Image/Build/CFE
-    # Generate the tagged image
+    # Generate the tagged image (CFE)
     $(STAGING_DIR_HOST)/bin/imagetag -i $(KDIR)/vmlinux.lzma.cfe -f $(KDIR)/root.$(1) \
         -o $(BIN_DIR)/openwrt-$(2)-$(1)-cfe.bin \
         -b $(2) -c $(3) -e $(LOADADDR) -l $(LOADADDR)
 #        -b $(2) -c $(3) -e $(KERNEL_ENTRY) -l $(LOADADDR)
 
-    $(call prepare_generic_squashfs,$(BIN_DIR)/openwrt-$(2)-$(1)-cfe.bin)
 endef
 
 define Image/Build/CFEAGPF
-    # Generate the tagged image
+    # Generate the tagged image (CFEAGPF)
     $(STAGING_DIR_HOST)/bin/imagetag -i $(KDIR)/vmlinux.lzma.cfe -f $(KDIR)/root.$(1) \
         -o $(BIN_DIR)/openwrt-$(2)-$(1)-cfe.bin \
         -b $(2) -c $(3) -e $(LOADADDR) -l $(LOADADDR) \
@@ -55,6 +54,7 @@ define Image/Build/RedBoot
 endef
 
 define Image/Build/CFEOLD
+    # Generate the tagged image (CFEOLD)
     $(TOPDIR)/scripts/brcmImage.pl -t -p    \
         -b $(2) -c $(3)            \
         -k $(KDIR)/vmlinux.lzma.cfe    \
diff --git a/tools/firmware-utils/src/imagetag.c b/tools/firmware-utils/src/imagetag.c
index af37992..3ada4fd 100644
--- a/tools/firmware-utils/src/imagetag.c
+++ b/tools/firmware-utils/src/imagetag.c
@@ -23,6 +23,8 @@
 #define DEFAULT_FW_OFFSET        0x10000
 #define DEFAULT_FLASH_START        0xBFC00000
 #define DEFAULT_FLASH_BS        (64 * 1024)
+#define DEADCODE                        0xDEADC0DE
+#define DEADCODE_LEN                    4
 
 /* Kernel header */
 struct kernelhdr {
@@ -47,11 +49,12 @@ struct imagetag {
     uint8_t            bigendian[2];    /*  60 -  61: &quot;1&quot; for big endian, &quot;0&quot; for little endian */
     uint8_t            imagelen[10];    /*  62 -  71: The length of all data that follows */
     struct imagecomp    cfe;        /*  72 -  93: The offset and length of CFE */
-    struct imagecomp    rootfs;        /*  94 - 115: The offset and length of the root file system */
+    struct imagecomp    rootfs;        /*  94 - 115: The offset of the start of the image and length of the root filesystem; for Broadcom firmware images this is the rootfs but causes flashing problems for WRT hence the addition of wrtrootfs */
     struct imagecomp    kernel;        /* 116 - 137: The offset and length of the kernel */
     uint8_t            dualimage[2];    /* 138 - 139: use &quot;0&quot; here */
     uint8_t            inactive[2];    /* 140 - 141: use &quot;0&quot; here */
-    uint8_t            reserved1[74];    /* 142 - 215: reserved */
+    uint8_t            reserved1[52];    /* 142 - 193: reserved */
+        struct imagecomp        wrtrootfs;      /* 193 - 215: WRT: real offset and length of the root file system */
     uint32_t        imagecrc;    /* 216 - 219: crc of the images (net byte order) */
     uint8_t            reserved2[16];    /* 220 - 235: reserved */
     uint32_t        headercrc;    /* 236 - 239: crc starting from sig1 until headercrc (net byte order) */
@@ -116,6 +119,30 @@ size_t getlen(FILE *fp)
     return retval;
 }
 
+uint32_t writepadding(FILE *padfile, size_t size, uint32_t crc) {
+  size_t paddingsize, padcount;
+  uint8_t padbuf[1024];
+  
+  for (padcount = 0; padcount &lt; 1024; padcount++) {
+    padbuf[padcount] = 0;
+  }    
+
+  paddingsize = 0;
+
+  while (paddingsize &lt; size) {
+    if ((size - paddingsize) &gt; 1024) {
+      padcount = 1024;
+    } else {
+      padcount = size - paddingsize; 
+    }
+    fwrite(padbuf, sizeof(uint8_t), padcount, padfile);
+    
+    paddingsize += padcount;
+    crc = crc32(crc, padbuf, padcount);
+  }
+  return crc;
+}
+
 int tagfile(const char *kernel, const char *rootfs, const char *bin,
         const char *boardid, const char *chipid, const uint32_t fwaddr,
         const uint32_t loadaddr, const uint32_t entry,
@@ -124,9 +151,10 @@ int tagfile(const char *kernel, const char *rootfs, const char *bin,
     struct imagetag tag;
     struct kernelhdr khdr;
     FILE *kernelfile = NULL, *rootfsfile = NULL, *binfile;
-    size_t kerneloff, kernellen, rootfsoff, rootfslen, read;
+    size_t kerneloff, kernellen, rootfsoff, rootfslen, read, cferootfsoff, cferootfslen, imagelen, imageoff, rootfspaddingsize, origrootfslen;
     uint8_t readbuf[1024];
     uint32_t crc;
+    const uint32_t deadcode = htonl(DEADCODE);
 
     memset(&amp;tag, 0, sizeof(struct imagetag));
 
@@ -154,9 +182,17 @@ int tagfile(const char *kernel, const char *rootfs, const char *bin,
         fprintf(stderr, &quot;Unable to open output file \&quot;%s\&quot;\n&quot;, bin);
         return 1;
     }
+    /* Initialize CRC */
+    crc = IMAGETAG_CRC_START;
+
+    /* Initialize image length calculations */
+    imagelen = 0;
+    cferootfslen = 0;
 
     /* Build the kernel address and length (doesn&#039;t need to be aligned, read only) */
     kerneloff = fwaddr + sizeof(tag);
+    imageoff = kerneloff;
+    cferootfsoff = imageoff;
     kernellen = getlen(kernelfile);
 
     /* Build the kernel header */
@@ -167,17 +203,21 @@ int tagfile(const char *kernel, const char *rootfs, const char *bin,
     /* Increase the kernel size by the header size */
     kernellen += sizeof(khdr);
 
+    imagelen += kernellen;
+
     /* Build the rootfs address and length (start and end do need to be aligned on flash erase block boundaries */
     rootfsoff = kerneloff + kernellen;
     rootfsoff = (rootfsoff % flash_bs) &gt; 0 ? (((rootfsoff / flash_bs) + 1) * flash_bs) : rootfsoff;
-    rootfslen = getlen(rootfsfile);
+    origrootfslen = getlen(rootfsfile);
+    rootfslen = origrootfslen;
     rootfslen = (rootfslen % flash_bs) &gt; 0 ? (((rootfslen / flash_bs) + 1) * flash_bs) : rootfslen;
+    cferootfslen = rootfslen;
 
     /* Seek to the start of the kernel */
     fseek(binfile, kerneloff - fwaddr, SEEK_SET);
 
     /* Write the kernel header */
-    crc = crc32(IMAGETAG_CRC_START, (uint8_t*)&amp;khdr, sizeof(khdr));
+    crc = crc32(crc, (uint8_t*)&amp;khdr, sizeof(khdr));
     fwrite(&amp;khdr, sizeof(khdr), 1, binfile);
 
     /* Write the kernel */
@@ -187,16 +227,39 @@ int tagfile(const char *kernel, const char *rootfs, const char *bin,
         fwrite(readbuf, sizeof(uint8_t), read, binfile);
     }
 
+    /* Write padding from end of kernel to start of RootFS needed so that
+     * RootFS starts on and erase boundary, and calculate its CRC 
+     */
+    rootfspaddingsize = rootfsoff - (kerneloff + kernellen );
+    imagelen += rootfspaddingsize;
+    /* FIXME: Don&#039;t use this CRC for Alice Gate */
+    crc = writepadding(binfile, rootfspaddingsize, crc);
+
     /* Write the RootFS */
-    fseek(binfile, rootfsoff - fwaddr, SEEK_SET);
     while (rootfsfile &amp;&amp; !feof(rootfsfile) &amp;&amp; !ferror(rootfsfile)) {
         read = fread(readbuf, sizeof(uint8_t), sizeof(readbuf), rootfsfile);
-        /*
-         * TODO: Is this necessary ?
-         * crc = crc32(crc, readbuf, read);
-         */
+        /* FIXME: Don&#039;t do this for Alice Gate */
+        crc = crc32(crc, readbuf, read);
+        
         fwrite(readbuf, sizeof(uint8_t), read, binfile);
     }
+    imagelen += origrootfslen;
+
+    /* Write the ending padding and end-of-filesystem marker for RootFS so
+     * that RootFS ends on an erase boundary, and calculate its CRC 
+     */
+
+    /* FIXME: Don&#039;t use the CRC for Alice Gate */
+    crc = writepadding(binfile, rootfslen - origrootfslen, crc);
+    imagelen += rootfslen - origrootfslen;
+    cferootfslen += rootfslen - origrootfslen;
+
+    /* Write end-of-filesystem marker */
+    /* FIXME: Don&#039;t use this CRC for Alice Gate */
+    crc = crc32(crc, (uint8_t*)&amp;deadcode, DEADCODE_LEN);
+    fwrite((uint8_t*)&amp;deadcode, sizeof(uint8_t), DEADCODE_LEN, binfile);
+    imagelen += DEADCODE_LEN;
+    cferootfslen += DEADCODE_LEN;
 
     /* Close the files */
     fclose(kernelfile);
@@ -209,7 +272,7 @@ int tagfile(const char *kernel, const char *rootfs, const char *bin,
     strcpy(tag.chipid, chipid);
     strcpy(tag.boardid, boardid);
     strcpy(tag.bigendian, &quot;1&quot;);
-    sprintf(tag.imagelen, &quot;%lu&quot;, kernellen + rootfslen);
+    sprintf(tag.imagelen, &quot;%lu&quot;, imagelen);
 
     /* We don&#039;t include CFE */
     strcpy(tag.cfe.address, &quot;0&quot;);
@@ -221,8 +284,10 @@ int tagfile(const char *kernel, const char *rootfs, const char *bin,
     }
 
     if (rootfsfile) {
-        sprintf(tag.rootfs.address, &quot;%lu&quot;, rootfsoff);
-        sprintf(tag.rootfs.len, &quot;%lu&quot;, rootfslen);
+        sprintf(tag.rootfs.address, &quot;%lu&quot;, cferootfsoff);
+        sprintf(tag.rootfs.len, &quot;%lu&quot;, cferootfslen);
+        sprintf(tag.wrtrootfs.address, &quot;%lu&quot;, rootfsoff);
+        sprintf(tag.wrtrootfs.len, &quot;%lu&quot;, rootfslen);
     }
 
     tag.imagecrc = htonl(crc);</code></pre></div>											<p class="post-edited">(Last edited by <strong>cshore</strong> on 14 Apr 2009, 14:11)</p>
									</div>
			</article>

			
		
						<div class="notice">
				<p>Sorry, posts 351 to 350 are missing from our archive.</p>
			</div>
		
		
	
	<div class="pagination"><div class="pagination-number">Page 14 of 30</div><nav><ul><li><a href="viewtopic.php%3Fid=17370&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=17370&amp;p=12.html">12</a></li><li><a href="viewtopic.php%3Fid=17370&amp;p=13.html">13</a></li><li class="pagination-current"><span>14</span></li><li><a href="viewtopic.php%3Fid=17370&amp;p=15.html">15</a></li><li><a href="viewtopic.php%3Fid=17370&amp;p=16.html">16</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=17370&amp;p=30.html">30</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>