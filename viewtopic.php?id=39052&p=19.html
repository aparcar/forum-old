<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> mwan3; multi-wan policy routing (general topic)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 22 May 2013 and 6 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 19 of 65</div><nav><ul><li><a href="viewtopic.php%3Fid=39052&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=17.html">17</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=18.html">18</a></li><li class="pagination-current"><span>19</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=20.html">20</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=21.html">21</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p210117">
				<div class="post-metadata">
					<div class="post-num">Post #451</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						19 Aug 2013, 02:04					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>thdyck wrote:</cite><blockquote><p>1. Does a load-balanced connection also provide failover automatically to the remaining link if one of the links goes down? The load-balancing metric is ignored if one of the links is down so as to send 100% of traffic through the remaining working link?</p></blockquote></div><p>Yes</p><div class="quotebox"><cite>thdyck wrote:</cite><blockquote><p>2. For load-balancing, the selection of outgoing interface is made by the Linux kernel at the time of the start of the IP connection based on destination IP address? So, all connections to the same specific destination IP address will go through the same WAN interface? How is UDP handled where there is no connection state?</p></blockquote></div><p>The linux kernel uses some kind of fake connection state. When an udp packet leaves the router it&#039;s stored in the session table as NEW. When a returning packet is seen, it&#039;s marked ESTABLISHED. It&#039;s not really a three-way session, but this is how it&#039;s tracked.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p210118">
				<div class="post-metadata">
					<div class="post-num">Post #452</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						19 Aug 2013, 02:07					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>pingo wrote:</cite><blockquote><p>I have one problem though, I cannot get traffic over both wifi interfaces at the same time.</p><p>...</p><p>Can anyone look at my setup and tell me if there is a mistake in it? Otherwise, does anyone have any clue why this would be happening and how I could debug it?</p></blockquote></div><p>Your config looks fine to me. Could you please try it with the option equalize set to &quot;1&quot;.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p210119">
				<div class="post-metadata">
					<div class="post-num">Post #453</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						19 Aug 2013, 02:13					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ranfish wrote:</cite><blockquote><p>1.Lower cpu consumption.One my wdr7500 with two wans (100mbit+24mbit),mwan3 eats a lot cpu.</p></blockquote></div><p>Unless there is some other way of &quot;cheaply&quot; analyzing all the individual packets, i don&#039;t think that will be possible. I myself would also be very interested.</p><p>Just curious: What is the CPU load when mwan3 is not used?</p><div class="quotebox"><cite>ranfish wrote:</cite><blockquote><p>2.Allow custom route table for some specific ip sections</p></blockquote></div><p>I think it&#039;s a great idea to introduce ip ranges. I will see what i can do, allthough the examples you posted are easily aggregatable.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 19 Aug 2013, 02:23)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p210326">
				<div class="post-metadata">
					<div class="post-num">Post #454</div>
					<div class="post-author">pingo</div>
					<div class="post-datetime">
						21 Aug 2013, 16:25					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>headless.cross wrote:</cite><blockquote><p>@pingo:</p><p>How strong is the wifi signal between you and those two APs? I&#039;m asking that because I have similar setup and the wifi signal affects the load-balancing.</p></blockquote></div><br/><div class="quotebox"><cite>Adze wrote:</cite><blockquote><div class="quotebox"><cite>pingo wrote:</cite><blockquote><p>I have one problem though, I cannot get traffic over both wifi interfaces at the same time.</p><p>...</p><p>Can anyone look at my setup and tell me if there is a mistake in it? Otherwise, does anyone have any clue why this would be happening and how I could debug it?</p></blockquote></div><p>Your config looks fine to me. Could you please try it with the option equalize set to &quot;1&quot;.</p></blockquote></div><br/><p>It turned out headless.cross was onto something as I changed one wifi from channel 13 to channel 6 and now both wifis load balance fine. So thanks for the help and sorry since the problem was not mwan3 related. </p><p>I can now report that mwan3 works great load-balancig an ethernet wan and 2 wifi wans <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p210376">
				<div class="post-metadata">
					<div class="post-num">Post #455</div>
					<div class="post-author">n_dandanov</div>
					<div class="post-datetime">
						22 Aug 2013, 01:16					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>Congratulations to All who contributed to this wonderful project!<br/>I installed and configured mwan3 on TP-Link TL-WR740N running OpenWrt Attitude Adjustment 12.09. I configured two WAN interfaces, both using DHCP.<br/>However, when the primary WAN interface (the physical WAN port) goes down, the router won&#039;t resolve hostnames.<br/>I noticed the resolve is done with the loopback IP address (127.0.0.1). I thought this would cause the problem and created manually a new /etc/resolv.conf file containing the four DNS servers&#039; addresses I&#039;m using (two for each ISP). The router now tries to resolve via the first of them, but still unsuccessfully when the primary WAN is down. Resolving with Google&#039;s public DNS (8.8.8.8) also isn&#039;t successful.<br/>If using nslookup on a PC behind the router and specifying which DNS server to look up, the result is correct. I looked at /tmp/resolv.conf.auto while the primary WAN is down and the list is correct, but still includes all 4 DNS servers. <br/>I tried &quot;rerouting&quot; the traffic, originating from the WAN (interface WAN1 config in mwan3), but with no success.<br/>Am I missing something trivial? If not, I&#039;m posting mwan3 and network configurations at the bottom of my post. If there are any additional configs needed, please, inform me. Otherwise, I&#039;d really appreciate it if someone more experienced could look at them.<br/>This problem leads to inability to open any webpage that hasn&#039;t been resolved yet and having its IP address cached. Doing nslookup on a PC and then entering the IP address in a browser launches the page successfully. Otherwise, traffic seems to be failing over and failing-back properly.</p><p>And a final question: there would be no issues, if both interfaces had the same weight set, would be?</p><div class="codebox"><pre><code>root@OpenWrt:~# cat /etc/config/network 


# This is a mwan3 example config. For mwan3 to work you will need at least:
#
# - 2 interfaces
# - 2 members
# - 1 policy
# - 1 rule
#
# First define all your wan interfaces. Interface name must match with the
# name used in your network configuration:

config &#039;interface&#039; &#039;wan&#039;
    option &#039;enabled&#039; &#039;1&#039;
    list &#039;track_ip&#039; &#039;8.8.4.4&#039;
    list &#039;track_ip&#039; &#039;8.8.8.8&#039;
    list &#039;track_ip&#039; &#039;46.40.72.17&#039;
    list &#039;track_ip&#039; &#039;46.40.72.18&#039;
    option &#039;reliability&#039; &#039;2&#039;
    option &#039;count&#039; &#039;1&#039;
    option &#039;timeout&#039; &#039;2&#039;
    option &#039;interval&#039; &#039;5&#039;
    option &#039;down&#039; &#039;3&#039;
    option &#039;up&#039; &#039;8&#039;
    option &#039;reroute&#039; &#039;0&#039;

config &#039;interface&#039; &#039;wan2&#039;
    option &#039;enabled&#039; &#039;1&#039;
    list &#039;track_ip&#039; &#039;8.8.8.8&#039;
    list &#039;track_ip&#039; &#039;217.9.239.90&#039;
    list &#039;track_ip&#039; &#039;217.9.239.94&#039;
    option &#039;reliability&#039; &#039;1&#039;
    option &#039;count&#039; &#039;1&#039;
    option &#039;timeout&#039; &#039;2&#039;
    option &#039;interval&#039; &#039;5&#039;
    option &#039;down&#039; &#039;3&#039;
    option &#039;up&#039; &#039;8&#039;
    option &#039;reroute&#039; &#039;0&#039;

# Next define a member and configure metric and weight values for this member.
# Each interface can have multiple member definitions. Give each member a correct
# name (A-Z, a-z, 0-9, &quot;_&quot; and no spaces).

config &#039;member&#039; &#039;wan1_m1_w3&#039;
    option &#039;interface&#039; &#039;wan&#039;
    option &#039;metric&#039; &#039;1&#039;
    option &#039;weight&#039; &#039;3&#039;

config &#039;member&#039; &#039;wan1_m2_w3&#039;
    option &#039;interface&#039; &#039;wan&#039;
    option &#039;metric&#039; &#039;2&#039;
    option &#039;weight&#039; &#039;3&#039;

config &#039;member&#039; &#039;wan2_m1_w2&#039;
    option &#039;interface&#039; &#039;wan2&#039;
    option &#039;metric&#039; &#039;1&#039;
    option &#039;weight&#039; &#039;2&#039;

config &#039;member&#039; &#039;wan2_m2_w2&#039;
    option &#039;interface&#039; &#039;wan2&#039;
    option &#039;metric&#039; &#039;2&#039;
    option &#039;weight&#039; &#039;2&#039;

# After that create a routing policy. A routing policy consist of one or more
# members. Give each policy a correct name (A-Z, a-z, 0-9, &quot;_&quot; and no spaces). You 
# can create multiple policies, so that it is possible for different traffic to
# have different primary and/or backup interfaces.

config &#039;policy&#039; &#039;wan1_only&#039;
    list &#039;use_member&#039; &#039;wan1_m1_w3&#039;

config &#039;policy&#039; &#039;wan2_only&#039;
    list &#039;use_member&#039; &#039;wan2_m1_w2&#039;

config &#039;policy&#039; &#039;wan1_wan2_loadbalanced&#039;
    list &#039;use_member&#039; &#039;wan1_m1_w3&#039;
    list &#039;use_member&#039; &#039;wan2_m1_w2&#039;

config &#039;policy&#039; &#039;wan1_pri_wan2_sec&#039;
    list &#039;use_member&#039; &#039;wan1_m1_w3&#039;
    list &#039;use_member&#039; &#039;wan2_m2_w2&#039;

config &#039;policy&#039; &#039;wan2_pri_wan1_sec&#039;
    list &#039;use_member&#039; &#039;wan1_m2_w3&#039;
    list &#039;use_member&#039; &#039;wan2_m1_w2&#039;

# And to finish the config define your traffic rules. Rules are matched in top to
# bottom order. If you define a rule and it matches, all following rules are ignored.
#
# If the option equalize is set, mwan3 will load-balance each new session to the same
# host. If not set, it will load-balance based on destination.

#config &#039;rule&#039; &#039;rule1&#039;
#    option &#039;src_ip&#039; &#039;192.168.21.0/24&#039;
#    option &#039;proto&#039; &#039;tcp&#039;
#    option &#039;dest_port&#039; &#039;563&#039;
#    option &#039;use_policy&#039; &#039;wan2_only&#039;

#config &#039;rule&#039; &#039;rule2&#039;
#    option &#039;src_ip&#039; &#039;192.168.21.0/24&#039;
#    option &#039;proto&#039; &#039;tcp&#039;
#    option &#039;dest_port&#039; &#039;995&#039;
#    option &#039;use_policy&#039; &#039;wan1_only&#039;
#
#config &#039;rule&#039; &#039;rule3&#039;
#    option &#039;dest_ip&#039; &#039;88.154.0.0/16&#039;
#    option &#039;proto&#039; &#039;tcp&#039;
#    option &#039;dest_port&#039; &#039;1024:65535&#039;
#    option &#039;equalize&#039; &#039;1&#039;
#    option &#039;use_policy&#039; &#039;wan1_wan2_loadbalanced&#039;
#
#config &#039;rule&#039; &#039;rule4&#039;
#    option &#039;dest_ip&#039; &#039;77.11.41.0/24&#039;
#    option &#039;proto&#039; &#039;tcp&#039;
#    option &#039;dest_port&#039; &#039;1024:65535&#039;
#    option &#039;use_policy&#039; &#039;wan1_pri_wan2_sec&#039;
#
#config &#039;rule&#039; &#039;rule5&#039;
#    option &#039;dest_ip&#039; &#039;112.136.0.0/16&#039;
#    option &#039;proto&#039; &#039;udp&#039;
#    option &#039;dest_port&#039; &#039;5352&#039;
#    option &#039;use_policy&#039; &#039;wan2_pri_wan1_sec&#039;
#
config &#039;rule&#039; &#039;rule6&#039;
    option &#039;dest_ip&#039; &#039;0.0.0.0/0&#039;
    option &#039;use_policy&#039; &#039;wan1_wan2_loadbalanced&#039;</code></pre></div><div class="codebox"><pre><code>config interface &#039;loopback&#039;
    option ifname &#039;lo&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;127.0.0.1&#039;
    option netmask &#039;255.0.0.0&#039;

config interface &#039;lan&#039;
    option ifname &#039;eth0.1&#039;
    option type &#039;bridge&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;192.168.1.1&#039;
    option netmask &#039;255.255.255.0&#039;

config interface &#039;wan&#039;
    option ifname &#039;eth1&#039;
    option proto &#039;dhcp&#039;
    option macaddr &#039;00:21:91:EA:D7:12&#039;
    option metric &#039;10&#039;

config switch
    option name &#039;eth0&#039;
    option reset &#039;1&#039;
    option enable_vlan &#039;1&#039;

config switch_vlan
    option device &#039;eth0&#039;
    option vlan &#039;1&#039;
    option vid &#039;1&#039;
    option ports &#039;0t 1 3 4&#039;

config switch_vlan
    option device &#039;eth0&#039;
    option vlan &#039;2&#039;
    option ports &#039;0t 2&#039;
    option vid &#039;3&#039;

config interface &#039;wan2&#039;
    option proto &#039;dhcp&#039;
    option ifname &#039;eth0.3&#039;
    option metric &#039;20&#039;</code></pre></div><p>Thank You in advance,<br/>Nickolay</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p210380">
				<div class="post-metadata">
					<div class="post-num">Post #456</div>
					<div class="post-author">thdyck</div>
					<div class="post-datetime">
						22 Aug 2013, 03:34					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>n_dandanov wrote:</cite><blockquote><p>If using nslookup on a PC behind the router and specifying which DNS server to look up, the result is correct. <br/>...<br/>And a final question: there would be no issues, if both interfaces had the same weight set, would be?</p></blockquote></div><p>Hi Nickolay,</p><p>It is a big clue that traffic from behind the router is working fine.</p><p>I see you have reroute set to 0 (disabled) on your WAN interfaces. If the &quot;reroute&quot; option is disabled, traffic from the router itself will not follow mwan3 failover rules. This traffic will use the router&#039;s default routing table and so not go out when the wan interface is down.</p><p>Can you set the following option for both your WAN interfaces and try again?</p><p> option &#039;reroute&#039; &#039;1&#039;</p><p>It&#039;s fine to give both WAN interfaces the same weight. If so, traffic will be load-balanced evenly between them.</p><p>Regards,<br/>Tim</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p210425">
				<div class="post-metadata">
					<div class="post-num">Post #457</div>
					<div class="post-author">n_dandanov</div>
					<div class="post-datetime">
						22 Aug 2013, 14:52					</div>
				</div>
				<div class="post-content content">
					<p>Hello, thdyck,</p><p>Thank You a lot for the advice! I had set reroute on WAN 1 only but it didn&#039;t seem to work. Now I set it to both interfaces, and also set equal weights (3) to WAN1 and WAN2. Then rebooted the router and the resolves now seem to be working flawlessly. I get them from the loopback interface on the router without specifying which DNS server to look up in. Resolves are correct also on a PC behind the router so web browsing now seems to be working nicely.</p><p>Thank You a lot for the great software and support! If I can assist You with anything, I&#039;d be glad to.</p><p>Best regards,<br/>Nickolay</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p210655">
				<div class="post-metadata">
					<div class="post-num">Post #458</div>
					<div class="post-author">n_dandanov</div>
					<div class="post-datetime">
						24 Aug 2013, 19:33					</div>
				</div>
				<div class="post-content content">
					<p>Dear All,</p><p>I spotted similar problem to the one I mentioned in my last posts. This time the router wouldn&#039;t resolve hostnames after a fail-back. At the time present I have all four DNS servers set manually in a file and dhcp configuration (dnsmasq) pointed to look in this file.<br/>As some other fellow members, I also thought it would be nice to have a kind of reporting the mwan3 log when there is a new event. I tried doing this using an e-mail client (in my case, msmtp). However this failed, as my router (TP-Link TL-WR740n) doesn&#039;t have enough free flash storage to install libopenssl. This library seems to be used for SSL authentication when sending e-mails and therefore is needed along with msmtp.<br/>I ended up installing msmtp-nossl. The install went trouble-free, but afterwards I failed to find a free no-ssl mail server which would accept the no-ssl e-mails I was sending from the router. I know Google has a way of relaying such messages, but I didn&#039;t delve further and decided the research wasn&#039;t worth it at this time.<br/>I came up with a slightly different concept:</p><p>1. Look in the system log on a defined interval;<br/>2. Check whether there is an update related to mwan3;<br/>3. If yes, copy the log contents which are relevant to mwan3. Then upload this log to a ftp server;<br/>4. If not, do nothing.</p><p>I implemented this using the directory /usr/share/reporter/ (&#039;reporter&#039; here is the name I chose both for the folder and for the short script which would do the steps outlined above). For ftp server I&#039;m currently using the free service from <a href="http://www.drivehq.com/">DriveHQ</a>. For uploading there I chose the package wput, so You&#039;ll need to install it if You&#039;d use the script quoted here.</p><p>Here&#039;s the script itself. It&#039;s name is reporter.sh:<br/>root@OpenWrt:~# cat /usr/share/reporter/reporter.sh</p><div class="codebox"><pre><code>#!/bin/ash

unset news
unset olds

#Checking the logs for new events, related to mwan3:
logread | grep mwan3 &gt; /usr/share/reporter/readlogtmp
news=$(tail -n 1 /usr/share/reporter/readlogtmp)
olds=$(tail -n 1 /usr/share/reporter/readlog)

#If there are new events:
if [ &quot;$olds&quot; != &quot;$news&quot; ]
then

#Constructing the log file:
date &gt; /usr/share/reporter/readlog
uptime &gt;&gt; /usr/share/reporter/readlog
echo -e  &quot;\n\nLog below:\n\n&quot; &gt;&gt; /usr/share/reporter/readlog
logread | grep mwan3 &gt;&gt; /usr/share/reporter/readlog

#Uploading the file with current timestamp:
unset filename
unset now
now=$(date +&quot;%Y-%m-%d-%H-%M&quot; )
filename=&quot;readlog_$now.txt&quot;
wput /usr/share/reporter/readlog ftp://XXXXX:YYYYY@ftp.drivehq.com/Router_logs/mwan3/&quot;$filename&quot;
unset filename
unset nowYYYYY
fi

#Removing the temporary file and variables:
rm -f /usr/share/reporter/readlogtmp
unset news
unset olds</code></pre></div><p>Replace XXXXX with Your username and YYYYY with Your password for the ftp server.</p><p>As You can see, it&#039;s basically storing the mwan3 log in a file called readlog.<br/>In order to accomplish this, the script is making a new temporary file named readlogtmp in which it copies the current system log related to mwan3. This is done using &quot;logread | grep mwan3&quot;.<br/>Then in two string variables - news and olds, it&#039;s copying the last lines of the logs stored in readlog and readlogtmp. If there&#039;s no readlog file, the tail command gives an error, but the script goes on and creates such file with the current mwan3 log contents.<br/>Afterwards we&#039;re comparing news and olds. If they match, we do nothing but release the used variables and remove the temporary file.<br/>If they don&#039;t, we create the readlog file with the actual timestamp, uptime and mwan3 logs. The file has a similar construction:<br/></p><div class="quotebox"><blockquote><p>Sat Aug 24 17:40:01 EEST 2013<br/> 17:40:01 up 14 min,&nbsp; load average: 0.02, 0.06, 0.06</p><br/><p>Log below:</p><br/><p>Aug 24 17:25:13 OpenWrt user.info mwan3: ifup interface wan2 (eth0.3)<br/>Aug 24 17:25:19 OpenWrt user.info mwan3: ifup interface wan (eth1)<br/>Aug 24 17:25:31 OpenWrt user.info mwan3track: Lost 4 ping(s) on interface wan (eth1)<br/>Aug 24 17:25:40 OpenWrt user.info mwan3: ifup interface wan (eth1)<br/>Aug 24 17:26:37 OpenWrt user.info mwan3: ifup interface wan2 (eth0.3)<br/>Aug 24 17:33:45 OpenWrt user.info mwan3track: Interface wan (eth1) is offline<br/>Aug 24 17:33:46 OpenWrt user.info mwan3: ifdown interface wan (eth1)<br/>Aug 24 17:35:38 OpenWrt user.info mwan3track: Lost 44 ping(s) on interface wan (eth1)<br/>Aug 24 17:36:14 OpenWrt user.info mwan3track: Interface wan (eth1) is online<br/>Aug 24 17:36:16 OpenWrt user.info mwan3: ifup interface wan (eth1)</p></blockquote></div><p>(This one contains the information recorded after a router reboot and wan interface going down, then up).<br/>The file uploaded to the ftp server has a similar name:<br/></p><div class="quotebox"><blockquote><p>readlog_2013-08-24-17-40.txt</p></blockquote></div><p>This way its contents can be viewed directly in DriveHQ&#039;s website. These files are uploaded to a folder /Router_logs/mwan3/ on the server.<br/>At the end of the script we are removing the temporary file and the used variables.</p><p>After the script is in place, we need to schedule it&#039;s execution at a give interval of time. I chose 5 minutes, as this seems reasonable to me. Feel free to correct me if I&#039;m wrong.<br/>For the purpose I entered a crontab entry. Here&#039;s how it looks currently:<br/></p><div class="codebox"><pre><code>root@OpenWrt:~# crontab -l
*/5 * * * * /usr/share/reporter/reporter.sh</code></pre></div><p>The */5 indicates the desired interval. (You might want to check <a href="http://wiki.openwrt.org/doc/howto/notuci.config">wiki</a>). After I made sure the script was being executed properly and working good, I edited the cron file in /etc/init.d so that crontab wouldn&#039;t log in the system log. Here&#039;s how it looks now:</p><p>root@OpenWrt:~# cat /etc/init.d/cron<br/></p><div class="codebox"><pre><code>#!/bin/sh /etc/rc.common
# Copyright (C) 2006-2011 OpenWrt.org

START=50

SERVICE_USE_PID=1

start () {
    loglevel=$(uci_get &quot;system.@system[0].cronloglevel&quot;)
    [ -z &quot;$(ls /etc/crontabs/)&quot; ] &amp;&amp; exit 1
    mkdir -p /var/spool/cron
    ln -s /etc/crontabs /var/spool/cron/ 2&gt;/dev/null
#    Some changes in order NOT to log to syslog. Below is the original line:
#    service_start /usr/sbin/crond -c /etc/crontabs -l ${loglevel:-5}
#    And here is the new line:
    service_start /usr/sbin/crond -c /etc/crontabs -L /dev/null
}

stop() {
    service_stop /usr/sbin/crond
}</code></pre></div><p>(Here very helpful was <a href="http://www.martybugs.net/wireless/openwrt/cron.cgi">this</a>).</p><p>That&#039;s the setup I have at the moment and it seems to be working as expected. I&#039;d be very grateful to hear Your comments and advices. Please, note that I don&#039;t have much experience with Linux and OpenWrt so there may be wrongly used manners in the script I posted.</p><p>Best regards,<br/>Nickolay</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p210868">
				<div class="post-metadata">
					<div class="post-num">Post #459</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						26 Aug 2013, 15:45					</div>
				</div>
				<div class="post-content content">
					<p>Just a small note on dns and mwan3. If you use the dns servers from your isp, it is very common that resolving fails if you try it with a wan interface (source ip address) that is not from that specific provider. I recommend to use opendns or google&#039;s dns service as they work from any ip address. It is not an mwan3 issue.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211760">
				<div class="post-metadata">
					<div class="post-num">Post #460</div>
					<div class="post-author">Ramesh_P</div>
					<div class="post-datetime">
						6 Sep 2013, 17:09					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adze,</p><p>My questions might look very silly to you but please very badly m looking for the answer.</p><p>I&#039;m not clear with mutiwan concept and testcase, can you please provide me any document related to this.</p><p>what is the diffrence between mwan3 and luci-mutilwan ?</p><br/><p>And also i have taken mwan3 package compiled with latest openwrt trunk and booted the image.now i will tell you what all steps i have followed :</p><p>1. created two wan connection nas0,nas1 in dhcp mode with successfull configuration.i.e i conformed by executing below command.</p><p>ping -c 1 -I nas0 <a href="http://www.google.com/">www.google.com</a><br/>ping -c 1 -I nas0 <a href="http://www.google.com/">www.google.com</a></p><p>both case ping was successful.</p><p>root@OpenWrt:/# route -n<br/>Kernel IP routing table<br/>Destination&nbsp; &nbsp; &nbsp;Gateway&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Genmask&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Flags Metric Ref&nbsp; &nbsp; Use Iface<br/>0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;200.200.59.1&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 10&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; 0 nas0<br/>0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;200.200.60.1&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 20&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; 0 nas1<br/>192.168.1.0&nbsp; &nbsp; &nbsp;0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 br-lan<br/>200.200.59.0&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 nas0<br/>200.200.60.0&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 nas1</p><p>2.then configured mwan3 config file </p><p>config &#039;interface&#039; &#039;wan1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;enabled&#039; &#039;1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; list &#039;track_ip&#039; &#039;8.8.4.4&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; list &#039;track_ip&#039; &#039;8.8.8.8&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; list &#039;track_ip&#039; &#039;200.200.59.1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; list &#039;track_ip&#039; &#039;208.67.220.100&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;reliability&#039; &#039;2&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;count&#039; &#039;1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;timeout&#039; &#039;2&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;interval&#039; &#039;5&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;down&#039; &#039;3&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;up&#039; &#039;8&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;reroute&#039; &#039;0&#039;</p><p>config &#039;interface&#039; &#039;wan2&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;enabled&#039; &#039;1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; list &#039;track_ip&#039; &#039;8.8.8.8&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; list &#039;track_ip&#039; &#039;200.200.60.1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; list &#039;track_ip&#039; &#039;200.200.60.100&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;reliability&#039; &#039;1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;count&#039; &#039;1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;timeout&#039; &#039;2&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;interval&#039; &#039;5&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;down&#039; &#039;3&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;up&#039; &#039;8&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;reroute&#039; &#039;0&#039;</p><p># Next define a member and configure metric and weight values for this member.<br/># Each interface can have multiple member definitions. Give each member a correct<br/># name (A-Z, a-z, 0-9, &quot;_&quot; and no spaces).</p><p>config &#039;member&#039; &#039;wan1_m1_w3&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;interface&#039; &#039;wan1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;metric&#039; &#039;1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;weight&#039; &#039;3&#039;</p><p>config &#039;member&#039; &#039;wan1_m2_w3&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;interface&#039; &#039;wan1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;metric&#039; &#039;2&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;weight&#039; &#039;3&#039;</p><p>config &#039;member&#039; &#039;wan2_m1_w2&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;interface&#039; &#039;wan2&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;metric&#039; &#039;1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;weight&#039; &#039;2&#039;</p><p>config &#039;member&#039; &#039;wan2_m2_w2&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;interface&#039; &#039;wan2&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;metric&#039; &#039;2&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;weight&#039; &#039;2&#039;</p><p># After that create a routing policy. A routing policy consist of one or more<br/># members. Give each policy a correct name (A-Z, a-z, 0-9, &quot;_&quot; and no spaces). You<br/># can create multiple policies, so that it is possible for different traffic to<br/># have different primary and/or backup interfaces.</p><p>config &#039;policy&#039; &#039;wan1_only&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; list &#039;use_member&#039; &#039;wan1_m1_w3&#039;</p><p>config &#039;policy&#039; &#039;wan2_only&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; list &#039;use_member&#039; &#039;wan2_m1_w2&#039;</p><p>config &#039;policy&#039; &#039;wan1_wan2_loadbalanced&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; list &#039;use_member&#039; &#039;wan1_m1_w3&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; list &#039;use_member&#039; &#039;wan2_m1_w2&#039;</p><p>config &#039;policy&#039; &#039;wan1_pri_wan2_sec&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; list &#039;use_member&#039; &#039;wan1_m1_w3&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; list &#039;use_member&#039; &#039;wan2_m2_w2&#039;</p><p>config &#039;policy&#039; &#039;wan2_pri_wan1_sec&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; list &#039;use_member&#039; &#039;wan1_m2_w3&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; list &#039;use_member&#039; &#039;wan2_m1_w2&#039;</p><p># And to finish the config define your traffic rules. Rules are matched in top to<br/># bottom order. If you define a rule and it matches, all following rules are ignored.<br/>#<br/># If the option equalize is set, mwan3 will load-balance each new session to the same<br/># host. If not set, it will load-balance based on destination.</p><p>config &#039;rule&#039; &#039;rule1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;src_ip&#039; &#039;192.168.1.0/24&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;proto&#039; &#039;tcp&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;dest_port&#039; &#039;563&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;use_policy&#039; &#039;wan2_only&#039;</p><p>config &#039;rule&#039; &#039;rule2&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;src_ip&#039; &#039;192.168.1.0/24&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;proto&#039; &#039;tcp&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;dest_port&#039; &#039;995&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;use_policy&#039; &#039;wan1_only&#039;</p><p>config &#039;rule&#039; &#039;rule3&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;dest_ip&#039; &#039;200.200.0.0/16&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;proto&#039; &#039;tcp&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;dest_port&#039; &#039;1024:65535&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;equalize&#039; &#039;1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;use_policy&#039; &#039;wan1_wan2_loadbalanced&#039;</p><p>config &#039;rule&#039; &#039;rule4&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;dest_ip&#039; &#039;200.200.59.0/24&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;proto&#039; &#039;tcp&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;dest_port&#039; &#039;1024:65535&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;use_policy&#039; &#039;wan1_pri_wan2_sec&#039;</p><p>config &#039;rule&#039; &#039;rule5&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;dest_ip&#039; &#039;200.200.60.0/16&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;proto&#039; &#039;udp&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;dest_port&#039; &#039;5352&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;use_policy&#039; &#039;wan2_pri_wan1_sec&#039;</p><p>config &#039;rule&#039; &#039;rule6&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;dest_ip&#039; &#039;0.0.0.0/0&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option &#039;use_policy&#039; &#039;wan1_wan2_loadbalanced&#039;</p><p>3. my network config files as below:</p><p>root@OpenWrt:/# cat /etc/config/network</p><p>config interface &#039;loopback&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;lo&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;static&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr &#039;127.0.0.1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;255.0.0.0&#039;</p><p>config globals &#039;globals&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option ula_prefix &#039;fd9e:8265:7b25::/48&#039;</p><p>config interface &#039;lan&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;eth0&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option type &#039;bridge&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;static&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr &#039;192.168.1.1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;255.255.255.0&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option ip6assign &#039;60&#039;</p><p>config atm-bridge &#039;atm&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option vci &#039;32&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option encaps &#039;llc&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option payload &#039;bridged&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option vpi &#039;0&#039;</p><p>config interface &#039;wan6&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;@wan&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;dhcpv6&#039;</p><p>config interface &#039;wan1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;nas0&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option _orig_ifname &#039;nas0&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option _orig_bridge &#039;false&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;dhcp&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option metric &#039;10&#039;</p><p>config atm-bridge<br/>&nbsp; &nbsp; &nbsp; &nbsp; option unit &#039;0&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option atmdev &#039;0&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option encaps &#039;llc&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option payload &#039;bridged&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option vci &#039;35&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option vpi &#039;0&#039;</p><p>config interface &#039;wan2&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;dhcp&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;nas1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option metric &#039;20&#039;</p><p>4. firewall config </p><p>config defaults<br/>&nbsp; &nbsp; &nbsp; &nbsp; option syn_flood &#039;1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option input &#039;ACCEPT&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option output &#039;ACCEPT&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option forward &#039;REJECT&#039;</p><p>config zone<br/>&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;lan&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option input &#039;ACCEPT&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option output &#039;ACCEPT&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option forward &#039;ACCEPT&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option network &#039;lan&#039;</p><p>config zone<br/>&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;wan&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option network &#039;wan1 wan2&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option input &#039;REJECT&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option output &#039;ACCEPT&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option forward &#039;REJECT&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option masq &#039;1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option mtu_fix &#039;1&#039;<br/>&nbsp; &nbsp; &nbsp; &nbsp; option network &#039;wan wan6</p><br/><p>5. now rebooted the board and it comes up without any issue. nas0, nas1 got ip and i can see some TX,RX pkts in both the interfaces.</p><p>6. now what should be the test case to conform that mwan3 working or not working.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211769">
				<div class="post-metadata">
					<div class="post-num">Post #461</div>
					<div class="post-author">pingo</div>
					<div class="post-datetime">
						6 Sep 2013, 18:00					</div>
				</div>
				<div class="post-content content">
					<p>I didn&#039;t look at your config much so perhaps some of these tests don&#039;t apply to your configuration but here are a few lame suggestions on what you can test:<br/>- Start a high speet torrent download and then use </p><div class="codebox"><pre><code>bmon -p &#039;nas*&#039;</code></pre></div><p> to monitor bandwidth on both interfaces<br/>- Go to a website that reports your ip address (google &quot;whatismyipaddress&quot;) and keep refreshing to see if the ip is changing<br/>- Try unplugging/disabling one of the two interfaces and see what happens</p><div class="quotebox"><cite>Ramesh_P wrote:</cite><blockquote><p>what is the diffrence between mwan3 and luci-mutilwan ?</p></blockquote></div><p>From my understanding you have 2 solutions that try to serve a similar purpose:<br/>There is multiwan + luci-app-multiwan<br/>and mwan3 + luci-app-mwan3</p><p>The luci packages just add a web interface so that you can configure everything through it instead editing config files.</p><p>One difference I&#039;ve noticed between multiwan and mwan3 is that mwan3 appears to work fine with overlapping subnets on wan interfaces while multiwan does not.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211770">
				<div class="post-metadata">
					<div class="post-num">Post #462</div>
					<div class="post-author">Ramesh_P</div>
					<div class="post-datetime">
						6 Sep 2013, 18:06					</div>
				</div>
				<div class="post-content content">
					<p>Hi pingo,</p><p>thanks for your quick reply.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211901">
				<div class="post-metadata">
					<div class="post-num">Post #463</div>
					<div class="post-author">rickyc</div>
					<div class="post-datetime">
						8 Sep 2013, 20:46					</div>
				</div>
				<div class="post-content content">
					<p>Hi all<br/>I&#039;m trying to use mwan3 to failover from ADSL to 3G/UMTS connectivity but I would like to have 3G/UMTS connectivity interface up only when ADSL connection is down. I tried to change the /etc/hotplug.d/iface/16-mwan3custom script like this</p><p>case &quot;$ACTION&quot; in<br/>&nbsp; &nbsp; &nbsp; &nbsp; ifup)<br/>if [&quot;$INTERFACE&quot; = &quot;WAN&quot;]<br/>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report_event<br/>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ifdown WAN3G<br/>fi<br/>&nbsp; &nbsp; &nbsp; &nbsp; ;;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ifdown)<br/>if [&quot;$INTERFACE&quot; = &quot;WAN&quot;]<br/>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report_event<br/>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ifup WAN3G<br/>fi<br/>&nbsp; &nbsp; &nbsp; &nbsp; ;;<br/>esac</p><p>but it doesn&#039;t work. Plus, I&#039;m not convinced that this would run also in case ADSL provider has problems but physically interface WAN is still up.</p><p>Any hint?</p><p>Thanks a lot<br/>Riccardo</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211908">
				<div class="post-metadata">
					<div class="post-num">Post #464</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						8 Sep 2013, 23:00					</div>
				</div>
				<div class="post-content content">
					<p>Hi rickyc,</p><br/><p>Maybe you could try the following code.</p><div class="codebox"><pre><code>case &quot;$ACTION&quot; in
   ifup)
      if [&quot;$INTERFACE&quot; == &quot;WAN&quot;]
         report_event
         ifdown WAN3G &amp;
      fi
   ;;
   ifdown)
      if [&quot;$INTERFACE&quot; == &quot;WAN&quot;]
         report_event
         ifup WAN3G &amp;
      fi
   ;;
esac</code></pre></div><p>I think the problem is the following. Your code spawns another hotplug event. The new process will wait until the current has ended, but it will never end because the current is still waiting for the new one to finish...</p><p>And this will also work if your isp has troubles, but the wan link remains up. Use some track_ip host in your mwan3 config for your main wan connection.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 8 Sep 2013, 23:02)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211959">
				<div class="post-metadata">
					<div class="post-num">Post #465</div>
					<div class="post-author">fharmusial</div>
					<div class="post-datetime">
						9 Sep 2013, 19:05					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>First of all .. thanks for this nice funcionality.</p><p>I have mwan3 set up with adsl and 3g/umts for a failover scenario*),<br/>but am a little bit puzzled with test results.</p><p>Could someone verify outcome of tests/mwan3 behaviour please ...</p><p>I used two tests issued from another computer:<br/>1) traceroute -m 3 8.8.8.8<br/>2) ping 8.8.8.8</p><p>I ran test 1) with adsl/3g functioning and indeed it took route via adsl. <br/>Next I unplugged the wan/adsl cable from router and yes it went via 3g<br/>I plugged in the wan/adsl cable again and -huray!- adsl route again.<br/>So far so good ....</p><p>Now I do test 2) with adsl/3g functioning and ideed it took route via adsl<br/>Next I unplugged the wan/adsl cable from router and yes it went via 3g<br/>I plugged in the wan/adsl cable again and to my surprise traffic still went via 3g</p><p>Is this normal when testing with ping, ie should I not use this test? </p><p>Regards,<br/>Ferry</p><p>*) </p><p>config rule &#039;rule6&#039;<br/>&nbsp; &nbsp; option dest_ip &#039;0.0.0.0/0&#039;<br/>&nbsp; &nbsp; option use_policy &#039;wan1_pri_wan2_sec&#039;</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211961">
				<div class="post-metadata">
					<div class="post-num">Post #466</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						9 Sep 2013, 19:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>fharmusial wrote:</cite><blockquote><p>Is this normal when testing with ping, ie should I not use this test?</p></blockquote></div><p>Ping is suitable for testing. As long as it is matched in the rules.</p><p>I cant tell you why test2 failed. I dont have enough info to determine what went wrong or what you did or how long you waited. You haven&#039;t posted your config. With al these uncertainties it is impossible to answer your question.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211964">
				<div class="post-metadata">
					<div class="post-num">Post #467</div>
					<div class="post-author">fharmusial</div>
					<div class="post-datetime">
						9 Sep 2013, 20:04					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>I dont have enough info to determine what went wrong or what you did or how long you waited.</p></blockquote></div><p>Hi Adze,</p><p>Thank you for your swift reply.<br/>I will first do my homework (ie Ialready spotted incosistency in my config)<br/>and if needed I just might try again on this thread.</p><p>Regards,<br/>Ferry</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211969">
				<div class="post-metadata">
					<div class="post-num">Post #468</div>
					<div class="post-author">rickyc</div>
					<div class="post-datetime">
						9 Sep 2013, 21:21					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hi rickyc,</p><br/><p>Maybe you could try the following code.</p><div class="codebox"><pre><code>case &quot;$ACTION&quot; in
   ifup)
      if [&quot;$INTERFACE&quot; == &quot;WAN&quot;]
         report_event
         ifdown WAN3G &amp;
      fi
   ;;
   ifdown)
      if [&quot;$INTERFACE&quot; == &quot;WAN&quot;]
         report_event
         ifup WAN3G &amp;
      fi
   ;;
esac</code></pre></div><p>I think the problem is the following. Your code spawns another hotplug event. The new process will wait until the current has ended, but it will never end because the current is still waiting for the new one to finish...</p><p>And this will also work if your isp has troubles, but the wan link remains up. Use some track_ip host in your mwan3 config for your main wan connection.</p></blockquote></div><p>Hi,<br/>thanks a lot for your help. I tried but I get this error </p><div class="codebox"><pre><code>Sep  9 20:13:22 OpenWrt user.info sysinit: /sbin/hotplug-call: /etc/hotplug.d/iface/16-mwan3custom: line 123: [wan: not found</code></pre></div><p>and strange enough line 123 is the line with &quot;esac&quot;, as below</p><div class="codebox"><pre><code>case &quot;$ACTION&quot; in
        ifup)
                if [&quot;$INTERFACE&quot; == &quot;wan&quot;];
                then
                report_event
                ifdown WAN3G &amp;
fi
        ;;

        ifdown)
if [&quot;$INTERFACE&quot; == &quot;wan&quot;];
then
                report_event
                ifup WAN3G &amp;
fi
        ;;
esac

exit 0</code></pre></div><p>where I also tried adding &quot;;&quot; at the end of the &quot;if&quot; lines..</p><p>Any idea of what I am still doing wrong?</p><p>Thanks!<br/>Riccardo</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211974">
				<div class="post-metadata">
					<div class="post-num">Post #469</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						9 Sep 2013, 22:28					</div>
				</div>
				<div class="post-content content">
					<p>Hi rickyc,</p><br/><p>The following code works for me:</p><div class="codebox"><pre><code>#!/bin/sh

case &quot;$ACTION&quot; in
   ifup)
      if [ &quot;$INTERFACE&quot; == &quot;wan1&quot; ]; then
         logger -t mwan3 &quot;Interface wan1 came up, tearing down interface wan2&quot;
         ifdown wan2 &amp;
      fi
   ;;
   ifdown)
      if [ &quot;$INTERFACE&quot; == &quot;wan1&quot; ]; then
         logger -t mwan3 &quot;Interface wan1 went down, bringing up interface wan2&quot;
         ifup wan2 &amp;
      fi
   ;;
esac

exit 0</code></pre></div><p>I forgot to mind the space between &quot;[&quot; and &quot;$INTERFACE&quot;.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 9 Sep 2013, 22:29)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211977">
				<div class="post-metadata">
					<div class="post-num">Post #470</div>
					<div class="post-author">rickyc</div>
					<div class="post-datetime">
						9 Sep 2013, 23:16					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>I forgot to mind the space between &quot;[&quot; and &quot;$INTERFACE&quot;.</p></blockquote></div><p>Hi Adze,<br/>this was the problem! :-) Thanks!</p><p>Now, I don&#039;t get any error but it seems that the IF is not triggered. I tried </p><div class="codebox"><pre><code>if [ &quot;$INTERFACE&quot; == &quot;WAN&quot;];</code></pre></div><p>both with &quot;WAN&quot; (name in Network-&gt;Interfaces), with &quot;wan&quot; (name in MWAN3-&gt;Interfaces) and also with eth0.2 (physical name). Which name should I use?</p><p>Since we are at it, is there a command to introduce a pause in the script for a few seconds? I need to wait until 3G interface is down before sending an SMS with gnokii...</p><p>Thanks again!!<br/>Riccardo</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211978">
				<div class="post-metadata">
					<div class="post-num">Post #471</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						9 Sep 2013, 23:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>rickyc wrote:</cite><blockquote><p>Now, I don&#039;t get any error but it seems that the IF is not triggered. I tried</p><div class="codebox"><pre><code>if [ &quot;$INTERFACE&quot; == &quot;WAN&quot;];</code></pre></div></blockquote></div><p>You also need a space between &quot;WAN&quot; and &quot;]&quot;.</p><div class="quotebox"><cite>rickyc wrote:</cite><blockquote><p>both with &quot;WAN&quot; (name in Network-&gt;Interfaces), with &quot;wan&quot; (name in MWAN3-&gt;Interfaces) and also with eth0.2 (physical name). Which name should I use?</p></blockquote></div><p>The name of the interface should be the same in /etc/config/network and /etc/config/mwan3. Else it won&#039;t work!. You need that name.</p><div class="quotebox"><cite>rickyc wrote:</cite><blockquote><p>Since we are at it, is there a command to introduce a pause in the script for a few seconds? I need to wait until 3G interface is down before sending an SMS with gnokii...</p></blockquote></div><div class="codebox"><pre><code>sleep 10 #to wait ten seconds</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211981">
				<div class="post-metadata">
					<div class="post-num">Post #472</div>
					<div class="post-author">rickyc</div>
					<div class="post-datetime">
						9 Sep 2013, 23:47					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>You also need a space between &quot;WAN&quot; and &quot;]&quot;.</p></blockquote></div><p>Thanks a lot, it works!!!! :-)</p><p>Best regards<br/>Riccardo</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212016">
				<div class="post-metadata">
					<div class="post-num">Post #473</div>
					<div class="post-author">Ramesh_P</div>
					<div class="post-datetime">
						10 Sep 2013, 16:14					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adze,</p><p>please help me to understand, for me mwan3 is not working.</p><p>i have created two wan connection nas1 and nas3 on dhcp mode , got the ip and tried to ping google.</p><p>root@openwrt:~# ping -c 1 -I nas1 <a href="http://www.google.com/">www.google.com</a><br/>root@openwrt:~# ping -c 1 -I nas3 <a href="http://www.google.com/">www.google.com</a></p><p>ping successful.</p><p>now i did mwan3 config changes and firewall&nbsp; config changes as mentioned by you. then rebooted the board, after reboot m not able to ping to google with same command as above.</p><p>root@OpenWrt:/# route -n<br/>Kernel IP routing table<br/>Destination&nbsp; &nbsp; &nbsp;Gateway&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Genmask&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Flags Metric Ref&nbsp; &nbsp; Use Iface<br/>0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;200.209.62.1&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 10&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; 0 nas1<br/>0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;200.209.64.1&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 20&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; 0 nas3<br/>192.168.1.0&nbsp; &nbsp; &nbsp;0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 br-lan<br/>200.209.62.0&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;10&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; 0 nas1<br/>200.209.64.0&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;20&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; 0 nas3</p><p>root@OpenWrt:/# ping -c 1 -I nas1 <a href="http://www.google.com/">www.google.com</a><br/>ping: bad address &#039;<a href="http://www.google.com/">www.google.com</a>&#039;&nbsp; &nbsp; &nbsp; &nbsp;--&gt; dns resolution is not happing </p><p>and i dont find any files uner /tmp directory related dns resolve.</p><br/><p>ip rule show command also shows very diffrent result from what you have mentioned.</p><p>root@OpenWrt:/# ip rule show<br/>0:&nbsp; &nbsp; &nbsp; from all lookup local<br/>9:&nbsp; &nbsp; &nbsp; from all fwmark 0x1 lookup LoadBalancer<br/>32766:&nbsp; from all lookup main<br/>32767:&nbsp; from all lookup default</p><br/><p>root@OpenWrt:/# iptables -L mwan3_pre -t mangle -v -n<br/>iptables: No chain/target/match by that name.</p><p>root@OpenWrt:/# iptables -L mwan3_post -t mangle -v -n<br/>iptables: No chain/target/match by that name.</p><p>root@CDR6-U11-10:~#&nbsp; iptables -L mwan3_default -t mangle -v -n<br/>iptables: No chain/target/match by that name</p><p>root@OpenWrt:/# iptables -L mwan3_rules -t mangle -v -n<br/>iptables: No chain/target/match by that name.</p><p>Looks like mwan3 not configured during bootup and tried start manually after reboot but i got following error.</p><p>root@OpenWrt:/# ACTION=ifup DEVICE=nas1 INTERFACE=wan1 /sbin/hotplug-call iface<br/>uci: Parse error (unterminated &#039;) at line 15, byte 32<br/>sh: 1: unknown operand</p><p>root@OpenWrt:/# /etc/init.d/mwan3 start<br/>uci: Parse error (unterminated &#039;) at line 15, byte 32<br/>sh: 1: unknown operand<br/>uci: Parse error (unterminated &#039;) at line 15, byte 32<br/>sh: 1: unknown operand</p><p>can you please tell me what colud be the issue here to fail to start mwan3.</p><p>Is wan connection needs to be created under eth0.x interface ? <br/>Is there problem with nas interface ?</p><p>thanks in advance .</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212018">
				<div class="post-metadata">
					<div class="post-num">Post #474</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						10 Sep 2013, 16:22					</div>
				</div>
				<div class="post-content content">
					<p>Hi Ramesh_P,</p><br/><p>I have never seen that error (uci: Parse error (unterminated &#039;) at line 15, byte 32) before. Don&#039;t know what is causing this.</p><p>What strikes me is when you issue the command &quot;ip rule show&quot;, that there is a line &quot;9 from all fwmark 0x1 lookup LoadBalancer&quot;. Mwan3 does not add this rule. Have you installed some other load-balancing software, like multiwan? What version of mwan3 are you running? How did you install it? Looks like a corrupt version of some kind...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212025">
				<div class="post-metadata">
					<div class="post-num">Post #475</div>
					<div class="post-author">Ramesh_P</div>
					<div class="post-datetime">
						10 Sep 2013, 16:41					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adze,</p><p>thanks for quick reply, </p><p>cloned source from : git clone <a href="https://github.com/Adze1502/mwan">https://github.com/Adze1502/mwan</a> .<br/>version : this is wat makefile shows.<br/>PKG_NAME:=mwan3<br/>PKG_VERSION:=1.2<br/>PKG_RELEASE:=18</p><p>And your correct openWRT multwan also enabled, let me try by disabling multwan.</p><br/><p>Second part of the question wasnt answerd. is there any restriction to create type wan connection? <br/>&nbsp; &nbsp; - like it should be eth0.x not nas or pppoe interfaces.</p>											<p class="post-edited">(Last edited by <strong>Ramesh_P</strong> on 10 Sep 2013, 17:22)</p>
									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 19 of 65</div><nav><ul><li><a href="viewtopic.php%3Fid=39052&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=17.html">17</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=18.html">18</a></li><li class="pagination-current"><span>19</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=20.html">20</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=21.html">21</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0.001 -->

</body>
</html>