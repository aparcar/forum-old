<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> BlueZ ver 5.28 BLE Pairing Crashes Kernel</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 5 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p269412">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">wtucker</div>
					<div class="post-datetime">
						20 Mar 2015, 22:32					</div>
				</div>
				<div class="post-content content">
					<p>BlueZ ver 5.28 BLE Pairing Crashes Kernel.</p><p>I was looking for a way to perform pairing of a BLE device to&nbsp; the D-Link DIR-505A1 / BLE dongle. I have most of it working discovery, connections, gatt commands, but pairing causes the kernel to crash.&nbsp; I&#039;m currently using dbus and bluetoothctl since I couldn&#039;t find another way to perform pairing in C yet. My Linux PC with Kernel 3.16.6 and bluetooth core 2.19 using the same bluetoothctl works fine. </p><p>Any Ideas how to fix this or where to look for more clues or something easier to try/use? </p><p>Using:</p><p>using latest trunk on 3/20/2015</p><p>============================================<br />Date:Feb&nbsp; 9 2012&nbsp; Time:20:12:45<br />Cameo Version: v1.00 Build:03<br />Module Name: D-Link DIR-505A1<br />============================================<br />Starting kernel ...</p><p>[&nbsp; &nbsp; 0.000000] Linux version 3.18.9 (guest@W) (gcc version 4.8.3 (<br />OpenWrt/Linaro GCC 4.8-2014.04 r44873) ) #1 Fri Mar 20 10:42:02 MDT 2015<br />[&nbsp; &nbsp; 0.000000] bootconsole [early0] enabled<br />[&nbsp; &nbsp; 0.000000] CPU0 revision is: 00019374 (MIPS 24Kc)<br />...<br />[&nbsp; &nbsp;15.230000] Bluetooth: Core ver 2.19<br />[&nbsp; &nbsp;15.230000] NET: Registered protocol family 31<br />[&nbsp; &nbsp;15.230000] Bluetooth: HCI device and connection manager initialized<br />[&nbsp; &nbsp;15.240000] Bluetooth: HCI socket layer initialized<br />[&nbsp; &nbsp;15.250000] Bluetooth: L2CAP socket layer initialized<br />[&nbsp; &nbsp;15.250000] Bluetooth: SCO socket layer initialized<br />[&nbsp; &nbsp;15.270000] Bluetooth: BNEP (Ethernet Emulation) ver 1.3<br />[&nbsp; &nbsp;15.270000] Bluetooth: BNEP filters: protocol multicast<br />[&nbsp; &nbsp;15.280000] Bluetooth: BNEP socket layer initialized<br />[&nbsp; &nbsp;15.300000] usbcore: registered new interface driver btusb<br />[&nbsp; &nbsp;15.300000] Loading modules backported from Linux version master-2015-03-09-0-g141f155<br />[&nbsp; &nbsp;15.310000] Backport generated by backports.git backports-20150129-0-gdd4a670<br />[&nbsp; &nbsp;15.320000] Bluetooth: HCI UART driver ver 2.2<br />[&nbsp; &nbsp;15.320000] Bluetooth: HCI H4 protocol initialized<br />[&nbsp; &nbsp;15.330000] Bluetooth: HCI BCSP protocol initialized<br />[&nbsp; &nbsp;15.330000] Bluetooth: HIDP (Human Interface Emulation) ver 1.2<br />[&nbsp; &nbsp;15.340000] Bluetooth: HIDP socket layer initialized<br />[&nbsp; &nbsp;15.340000] bluetooth hci0: Direct firmware load for brcm/BCM20702A0-0a5c-21e8.hcd failed with error -2<br />[&nbsp; &nbsp;15.350000] bluetooth hci0: Falling back to user helper<br />[&nbsp; &nbsp;15.370000] ip_tables: (C) 2000-2006 Netfilter Core Team<br />[&nbsp; &nbsp;15.430000] Bluetooth: RFCOMM TTY layer initialized<br />[&nbsp; &nbsp;15.430000] Bluetooth: RFCOMM socket layer initialized<br />[&nbsp; &nbsp;15.430000] Bluetooth: RFCOMM ver 1.11<br />[&nbsp; &nbsp;16.060000] Bluetooth: Unable to create crypto context</p><p>Also tried to add patch for this and it didn&#039;t make any difference.<br />[&nbsp; &nbsp;16.060000] Bluetooth: Unable to create crypto context</p><p>Trying to Pair:</p><p>root@OpenWrt:/# bluetoothectl</p><p>Did:<br /> power on<br /> scan on<br /> scan off</p><p>[bluetooth]# show<br />Controller 00:19:0E:12:46:8A<br />&nbsp; &nbsp; &nbsp; &nbsp; Name: BlueZ 5.28<br />&nbsp; &nbsp; &nbsp; &nbsp; Alias: BlueZ 5.28<br />&nbsp; &nbsp; &nbsp; &nbsp; Class: 0x000000<br />&nbsp; &nbsp; &nbsp; &nbsp; Powered: yes<br />&nbsp; &nbsp; &nbsp; &nbsp; Discoverable: no<br />&nbsp; &nbsp; &nbsp; &nbsp; Pairable: yes<br />&nbsp; &nbsp; &nbsp; &nbsp; UUID: PnP Information&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(00001200-0000-1000-8000-00805f9b34fb)<br />&nbsp; &nbsp; &nbsp; &nbsp; UUID: Generic Access Profile&nbsp; &nbsp; (00001800-0000-1000-8000-00805f9b34fb)<br />&nbsp; &nbsp; &nbsp; &nbsp; UUID: Generic Attribute Profile (00001801-0000-1000-8000-00805f9b34fb)<br />&nbsp; &nbsp; &nbsp; &nbsp; UUID: A/V Remote Control&nbsp; &nbsp; &nbsp; &nbsp; (0000110e-0000-1000-8000-00805f9b34fb)<br />&nbsp; &nbsp; &nbsp; &nbsp; UUID: A/V Remote Control Target (0000110c-0000-1000-8000-00805f9b34fb)<br />&nbsp; &nbsp; &nbsp; &nbsp; Modalias: usb:v1D6Bp0246d051C<br />&nbsp; &nbsp; &nbsp; &nbsp; Discovering: no<br />[bluetooth]#</p><p>[bluetooth]# pair EC:FE:7E:10:95:1F<br />method call sender=:1.2 -&gt; dest=org.bluez serial=49 path=/org/bluez/hci0/dev_EC_<br />FE_7E_10_95_1F; interface=org.bluez.Device1; member=Pair<br />method call sender=:1.0 -&gt; dest=org.freedesktop.DBus serial=129 path=/org/freede<br />skt[&nbsp; 757.590000] CPU 0 Unable to handle kernel paging request at virtual addres<br />s 00000200, epc == 80067e20, ra == 83231668<br />[&nbsp; 757.600000] Oops[#1]:<br />[&nbsp; 757.600000] CPU: 0 PID: 778 Comm: kworker/u3:2 Not tainted 3.18.9 #1<br />[&nbsp; 757.600000] Workqueue: hci0 hci_alloc_dev [bluetooth]<br />[&nbsp; 757.600000] task: 83bff548 ti: 83336000 task.ti: 83336000<br />[&nbsp; 757.600000] $ 0&nbsp; &nbsp;: 00000000 00000000 00000000 00000000<br />[&nbsp; 757.600000] $ 4&nbsp; &nbsp;: 00000200 829f440c 00000000 00000000<br />[&nbsp; 757.600000] $ 8&nbsp; &nbsp;: ffffffec 00000001 00000003 1f95107e<br />[&nbsp; 757.600000] $12&nbsp; &nbsp;: 00000000 771f23a0 00000000 00000000<br />[&nbsp; 757.600000] $16&nbsp; &nbsp;: 829f4400 82a0e500 00000000 00000002<br />[&nbsp; 757.600000] $20&nbsp; &nbsp;: 00000200 00000003 82a0e594 00000080<br />[&nbsp; 757.600000] $24&nbsp; &nbsp;: 00000003 8322cf20<br />[&nbsp; 757.600000] $28&nbsp; &nbsp;: 83336000 83337c90 00000005 83231668<br />[&nbsp; 757.600000] Hi&nbsp; &nbsp; : 00000009<br />[&nbsp; 757.600000] Lo&nbsp; &nbsp; : 00000fa0<br />[&nbsp; 757.600000] epc&nbsp; &nbsp;: 80067e20 mutex_lock+0x0/0x30<br />[&nbsp; 757.600000]&nbsp; &nbsp; &nbsp;Not tainted<br />[&nbsp; 757.600000] ra&nbsp; &nbsp; : 83231668 smp_conn_security+0x88/0x200 [bluetooth]<br />[&nbsp; 757.600000] Status: 1000fc03 KERNEL EXL IE<br />[&nbsp; 757.600000] Cause : 00800008<br />[&nbsp; 757.600000] BadVA : 00000200<br />[&nbsp; 757.600000] PrId&nbsp; : 00019374 (MIPS 24Kc)<br />[&nbsp; 757.600000] Modules linked in: ath9k ath9k_common pppoe ppp_async iptable_nat<br /> ath9k_hw ath pppox ppp_generic nf_nat_ipv4 nf_conntrack_ipv6 nf_conntrack_ipv4<br />mac80211 ipt_REJECT ipt_MASQUERADE cfg80211 xt_time xt_tcpudp xt_tcpmss xt_strin<br />g xt_statistic xt_state xt_recent xt_nat xt_multiport xt_mark xt_mac xt_limit xt<br />_length xt_id xt_hl xt_helper xt_ecn xt_dscp xt_conntrack xt_connmark xt_connlim<br />it xt_connbytes xt_comment xt_TCPMSS xt_REDIRECT xt_LOG xt_HL xt_DSCP xt_CT xt_C<br />LASSIFY ts_kmp ts_fsm ts_bm slhc rfcomm nf_reject_ipv4 nf_nat_masquerade_ipv4 nf<br />_nat_irc nf_nat_ftp nf_nat nf_log_ipv4 nf_defrag_ipv6 nf_defrag_ipv4 nf_conntrac<br />k_rtcache nf_conntrack_irc nf_conntrack_ftp iptable_raw iptable_mangle iptable_f<br />ilter ipt_ECN ip_tables hidp hci_uart crc_ccitt compat btusb bnep bluetooth act_<br />connmark nf_conntrack act_skbedit act_mirred em_u32 cls_u32 cls_tcindex cls_flow<br /> cls_route cls_fw sch_hfsc sch_ingress hid evdev input_core ledtrig_usbdev ip6t_<br />REJECT nf_reject_ipv6 nf_log_ipv6 nf_log_common ip6table_raw ip6table_mangle ip6<br />table_filter ip6_tables x_tables ifb ipv6 arc4 crypto_blkcipher usb_storage ehci<br />_platform ehci_hcd sd_mod scsi_mod gpio_button_hotplug ext4 crc16 jbd2 mbcache u<br />sbcore nls_base usb_common crypto_hash<br />[&nbsp; 757.600000] Process kworker/u3:2 (pid: 778, threadinfo=83336000, task=83bff54<br />8, tls=00000000)<br />[&nbsp; 757.600000] Stack : 830f5400 832283f0 829f6e00 82a0e500 829f4400 830f5400 82a<br />0e500 829f4400<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 829f4400 82a0e5ac 82a0e59c 8322c69c 83bb4000 829f4570 829f6c0b 8011ccf<br />0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 83bb4000 829f4570 829f6c0b 829f440c 829f4413 00000000 83bb4000 829f440<br />0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 00000000 829f440c 83bb4008 00000000 832381e8 832381b8 00000088 83211f5<br />8<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fffffff5 800f964c 83bb4000 83bb46bc 00000000 00000000 00000000 0000000<br />0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...<br />[&nbsp; 757.600000] Call Trace:<br />[&nbsp; 757.600000] [&lt;80067e20&gt;] mutex_lock+0x0/0x30<br />[&nbsp; 757.600000] [&lt;83231668&gt;] smp_conn_security+0x88/0x200 [bluetooth]<br />[&nbsp; 757.600000] [&lt;8322c69c&gt;] l2cap_connect_cfm+0x290/0x354 [bluetooth]<br />[&nbsp; 757.600000] [&lt;83211f58&gt;] hci_chan_lookup_handle+0x4fec/0x5968 [bluetooth]<br />[&nbsp; 757.600000]<br />[&nbsp; 757.600000]<br />Code: 8fb00024&nbsp; 03e00008&nbsp; 27bd0040 &lt;c0820000&gt; 2443ffff&nbsp; e0830000&nbsp; 1060fffc&nbsp; 0000<br />0000&nbsp; 2442ffff<br />[&nbsp; 757.880000] ---[ end trace 9237985c83908c91 ]---<br />op/DBus; interface=org.freedesktop.DBus; member=AddMatch<br />&nbsp; &nbsp;string &quot;type=&#039;sig[&nbsp; 757.890000] CPU 0 Unable to handle kernel paging request<br />at virtual address fffffff0, epc == 801b5158, ra == 802c8c68<br />[&nbsp; 757.890000] Oops[#2]:<br />[&nbsp; 757.890000] CPU: 0 PID: 778 Comm: kworker/u3:2 Tainted: G&nbsp; &nbsp; &nbsp; D&nbsp; &nbsp; &nbsp; &nbsp; 3.18.<br />9 #1<br />[&nbsp; 757.890000] task: 83bff548 ti: 83336000 task.ti: 83336000<br />[&nbsp; 757.890000] $ 0&nbsp; &nbsp;: 00000000 803d0000 00000000 c9d6a9c5<br />[&nbsp; 757.890000] $ 4&nbsp; &nbsp;: 83bff548 00000000 80359590 c9d6a9c5<br />[&nbsp; 757.890000] $ 8&nbsp; &nbsp;: 00000003 00000000 00000000 000a0014<br />[&nbsp; 757.890000] $12&nbsp; &nbsp;: 0000000e 00000007 00000001 80337d74<br />[&nbsp; 757.890000] $16&nbsp; &nbsp;: 00000000 00000001 80359590 83828000<br />[&nbsp; 757.890000] $20&nbsp; &nbsp;: 83bff744 80360000 80359590 00000000<br />[&nbsp; 757.890000] $24&nbsp; &nbsp;: 0000000e 80117168<br />[&nbsp; 757.890000] $28&nbsp; &nbsp;: 83336000 83337a48 00000010 802c8c68<br />[&nbsp; 757.890000] Hi&nbsp; &nbsp; : 000000b0<br />[&nbsp; 757.890000] Lo&nbsp; &nbsp; : 75c3a480<br />[&nbsp; 757.890000] epc&nbsp; &nbsp;: 801b5158 kthread_data+0x4/0xc<br />[&nbsp; 757.890000]&nbsp; &nbsp; &nbsp;Tainted: G&nbsp; &nbsp; &nbsp; D<br />[&nbsp; 757.890000] ra&nbsp; &nbsp; : 802c8c68 wq_worker_sleeping+0x14/0xc0<br />[&nbsp; 757.890000] Status: 1000fc02 KERNEL EXL<br />[&nbsp; 757.890000] Cause : 80800008<br />[&nbsp; 757.890000] BadVA : fffffff0<br />[&nbsp; 757.890000] PrId&nbsp; : 00019374 (MIPS 24Kc)<br />[&nbsp; 757.890000] Modules linked in: ath9k ath9k_common pppoe ppp_async iptable_nat<br /> ath9k_hw ath pppox ppp_generic nf_nat_ipv4 nf_conntrack_ipv6 nf_conntrack_ipv4<br />mac80211 ipt_REJECT ipt_MASQUERADE cfg80211 xt_time xt_tcpudp xt_tcpmss xt_strin<br />g xt_statistic xt_state xt_recent xt_nat xt_multiport xt_mark xt_mac xt_limit xt<br />_length xt_id xt_hl xt_helper xt_ecn xt_dscp xt_conntrack xt_connmark xt_connlim<br />it xt_connbytes xt_comment xt_TCPMSS xt_REDIRECT xt_LOG xt_HL xt_DSCP xt_CT xt_C<br />LASSIFY ts_kmp ts_fsm ts_bm slhc rfcomm nf_reject_ipv4 nf_nat_masquerade_ipv4 nf<br />_nat_irc nf_nat_ftp nf_nat nf_log_ipv4 nf_defrag_ipv6 nf_defrag_ipv4 nf_conntrac<br />k_rtcache nf_conntrack_irc nf_conntrack_ftp iptable_raw iptable_mangle iptable_f<br />ilter ipt_ECN ip_tables hidp hci_uart crc_ccitt compat btusb bnep bluetooth act_<br />connmark nf_conntrack act_skbedit act_mirred em_u32 cls_u32 cls_tcindex cls_flow<br /> cls_route cls_fw sch_hfsc sch_ingress hid evdev input_core ledtrig_usbdev ip6t_<br />REJECT nf_reject_ipv6 nf_log_ipv6 nf_log_common ip6table_raw ip6table_mangle ip6<br />table_filter ip6_tables x_tables ifb ipv6 arc4 crypto_blkcipher usb_storage ehci<br />_platform ehci_hcd sd_mod scsi_mod gpio_button_hotplug ext4 crc16 jbd2 mbcache u<br />sbcore nls_base usb_common crypto_hash<br />[&nbsp; 757.890000] Process kworker/u3:2 (pid: 778, threadinfo=83336000, task=83bff54<br />8, tls=00000000)<br />[&nbsp; 757.890000] Stack : 00000001 80359590 83828000 83bff744 83bff548 80066278 803<br />d0000 00000000<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 83337a68 83337a68 83bff548 00000001 83bff540 83828000 83bff6c0 0000000<br />1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 83bff540 00000000 00000010 80129220 803d4880 00000002 80362a6c 803d000<br />0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 83337aa8 83337aa8 83bff708 08000000 83337aa8 83337ad4 83337bd8 8031881<br />8<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0000000b 00000028 00000200 00000003 00000000 00000000 00030000 801228b<br />8<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...</p>											<p class="post-edited">(Last edited by <strong>wtucker</strong> on 20 Mar 2015, 22:35)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p269561">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">zloop</div>
					<div class="post-datetime">
						22 Mar 2015, 11:23					</div>
				</div>
				<div class="post-content content">
					<p>Not knowing the bluetooth subsystem but:</p><p>- test BlueZ 5.29 it might have some fixes<br />- check if you are using the correct commands - there might be bugs in the bluez tools with new &quot;LE&quot; devices or some things that are &quot;not supposed to work that way&quot;<br />- Kernel 3.16 and 3.18 might differ: Bluetooth LE is &quot;new&quot; and needs testings - looking at the release news of bluez for 5.22 and other versions (many of them have LE improvements)</p><div class="quotebox"><blockquote><p>Unable to create crypto context</p></blockquote></div><p>-&gt; Low Energy Secure Connections which will require a 3.19 or newer kernel.<br />from bluez 5.26 release note</p><p>You could report this to linux-bluetooth or bluez - maybe its something &quot;obvious&quot; that can be identified by <br />your crash (it looks like it is security and mutex related)</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>