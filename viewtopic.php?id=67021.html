<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Chaos Calmer with multi-SSID-WAN-pairs/routing tables (WZR-HP-G450H)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 29 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p335170">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">projectfd</div>
					<div class="post-datetime">
						20 Aug 2016, 14:48					</div>
				</div>
				<div class="post-content content">
					<p>Greetings,</p><p>having some trouble with configuring OpenWRT (aren&#039;t we all :D with multiple routing tables... Namely, I can&#039;t get the routing to work properly for the guest WiFi.</p><p>In short, I have two wan uplinks (cable and DSL). I want to use the cable as an uplink for my &#039;home LAN&#039; with its own SSID, and the DSL as an uplink for a &#039;guest WLAN&#039;, without the pairs being able to interact.</p><p>I&#039;ve configured VLANs so that each WAN uplink modem is in its own port/VLAN and each LAN is in its own VLAN (VLAN 1: home LAN, VLAN 2: cable modem, VLAN 3: guest WLAN, VLAN 4: DSL) . This part, I believe, works. Here&#039;s the config for reference, however.</p><p>--snip (/etc/config/network)</p><p>config interface &#039;loopback&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;lo&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr &#039;127.0.0.1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;255.0.0.0&#039;</p><p>config interface &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;eth0.1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option force_link &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option type &#039;bridge&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr &#039;192.168.11.1&#039;</p><p>config interface &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;eth0.2&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;dhcp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option macaddr &#039;10:6F:3F:0F:C0:96&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option broadcast &#039;1&#039;</p><p>config interface &#039;guestwan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp;option ifname &#039;eth0.4&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp;option ip4table &#039;guest&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp;option proto &#039;dhcp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp;option macaddr &#039;10:6F:3F:0F:C0:98&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp;option broadcast &#039;1&#039;</p><p>config interface &#039;guestlan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;eth0.3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ip4table &#039;guest&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option force_link &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option type &#039;bridge&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr &#039;192.168.12.1&#039;</p><p>config switch<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;switch0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option reset &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option enable_vlan &#039;1&#039;</p><p>config switch_vlan # Wired home LAN<br />&nbsp; &nbsp; &nbsp; &nbsp; option device &#039;switch0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option vlan &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ports &#039;0t 3 4 5&#039;</p><p>config switch_vlan # Uplink #1<br />&nbsp; &nbsp; &nbsp; &nbsp; option device &#039;switch0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option vlan &#039;2&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ports &#039;0t 1&#039;</p><p>config switch_vlan # Wireless guest LAN<br />&nbsp; &nbsp; &nbsp; &nbsp; option device &#039;switch0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option vlan &#039;3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ports &#039;0t&#039;</p><p>config switch_vlan # Uplink #2<br />&nbsp; &nbsp; &nbsp; &nbsp;option device &#039;switch0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp;option vlan &#039;4&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp;option ports &#039;0t 2&#039;</p><p>--snip</p><p>By installing the &#039;ip&#039; package, I can get to creating multiple routing tables, but then I run into trouble. Simply replicating my network and firewall configuration for both pairs doesn&#039;t seem to work as it should. Here, I believe, I start running into trouble:</p><p>--snip (ip route/ip route show table guest)</p><p>root@OpenWrt:/etc/rc.d# ip route<br />default via 80.220.158.1 dev eth0.2&nbsp; proto static&nbsp; src 80.220.158.213<br />80.220.158.0/23 dev eth0.2&nbsp; proto kernel&nbsp; scope link&nbsp; src 80.220.158.213<br />80.220.158.1 dev eth0.2&nbsp; proto static&nbsp; scope link&nbsp; src 80.220.158.213<br />192.168.11.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.11.1</p><p>root@OpenWrt:/etc/rc.d# ip route show table guest<br />default via 88.112.242.1 dev eth0.4&nbsp; proto static&nbsp; src 88.112.242.179<br />88.112.242.0/23 dev eth0.4&nbsp; proto static&nbsp; scope link<br />88.112.242.1 dev eth0.4&nbsp; proto static&nbsp; scope link&nbsp; src 88.112.242.179<br />192.168.12.0/24 dev br-guestlan&nbsp; proto static&nbsp; scope link</p><p>--snip</p><p>Does anyone know whether the OpenWRT default NAT can handle multiple pairs properly? The output of the secondary table &#039;guest&#039; (yes, it&#039;s added with higher priority than default) seems.. off.</p><p>Unto to the breach! Here&#039;s the wireless config, handily obfuscated.</p><p>--snip (/etc/config/wireless)</p><p>config wifi-device &#039;radio0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option type &#039;mac80211&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option hwmode &#039;11g&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option path &#039;pci0000:00/0000:00:00.0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option htmode &#039;HT40&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option txpower &#039;20&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option country &#039;FI&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option channel &#039;11&#039;</p><p>config wifi-iface<br />&nbsp; &nbsp; &nbsp; &nbsp; option device &#039;radio0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option network &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option mode &#039;ap&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ssid &#039;XXXXXXX&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option encryption &#039;psk-mixed&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option key &#039;XXXXXXXX&#039;</p><p>config wifi-iface<br />&nbsp; &nbsp; &nbsp; &nbsp; option device &#039;radio0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option network &#039;guestlan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option mode &#039;ap&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ssid &#039;XXXXXXX&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option encryption &#039;psk-mixed&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option key &#039;XXXXXXX&#039;</p><p>--snip</p><p>The result: I can associate with the guest WLAN; I get an IP address from the right DHCP pool, and even my DNS-queries resolve (so I can reach the GW a.k.a DNSmasq address, I can ping 192.168.12.1), but no traffic is forwarded outside the guest LAN.</p><p>Home LAN works just fine; both wired and wireless go out the cable modelm VLAN properly NATd as they should.</p><p>Any ideas?</p><p>Oh, yeah, here&#039;s the firewall config, too.</p><p>--snip (/etc/config/firewall)</p><p>config defaults<br />&nbsp; &nbsp; &nbsp; &nbsp; option syn_flood &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option input &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option output &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option forward &#039;REJECT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option drop_invalid &#039;1&#039;</p><p>config zone<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list network &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option input &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option output &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option forward &#039;REJECT&#039;</p><p>config zone<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;guestlan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list network &#039;guestlan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option input &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option output &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option forward &#039;REJECT&#039;</p><p>config zone<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list network &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option input &#039;REJECT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option output &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option forward &#039;REJECT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option masq &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option mtu_fix &#039;1&#039;</p><p>config forwarding<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest &#039;wan&#039;</p><p>config zone<br />&nbsp; &nbsp; &nbsp; &nbsp;option name &#039;guestwan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp;list network &#039;guestwan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp;option input &#039;REJECT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp;option output &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp;option forward &#039;REJECT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp;option masq &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp;option mtu_fix &#039;1&#039;</p><p>config forwarding<br />&nbsp; &nbsp; &nbsp; &nbsp;option src &#039;guestlan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp;option dest &#039;guestwan&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;Allow-DHCP-Discovery&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src_ip &#039;0.0.0.0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;Allow-DHCP-Discovery-for-Guests&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;guestlan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src_ip &#039;0.0.0.0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;Allow-DHCP-Renew&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;udp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest_port &#039;68&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option family &#039;ipv4&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;Allow-DHCP-Renew-GuestWAN&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;guestwan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;udp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest_port &#039;68&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option family &#039;ipv4&#039;</p><p>config include<br />&nbsp; &nbsp; &nbsp; &nbsp; option path &#039;/etc/firewall.user&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;LAN ESP&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;esp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;LAN udp-500&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest_port &#039;500&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;udp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;GUESTLAN ESP&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;guestwan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest &#039;guestlan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;esp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;GUESTLAN udp-500&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;guestwan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest &#039;guestlan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest_port &#039;500&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;udp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;</p><p># Paranoid much?</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;NAS out&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src_ip &#039;XXXXXXX&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;DROP&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;NAS in&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest_ip &#039;XXXXXXX&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;DROP&#039;</p><p>--snip</p><p>Rgds, Riku</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>