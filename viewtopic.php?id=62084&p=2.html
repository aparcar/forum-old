<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Fail2ban replacement and RBL firewall sync&#039;ing - in lightweight ash</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 5 Apr 2018 and 29 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 2 of 3</div><nav><ul><li><a href="viewtopic.php%3Fid=62084&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=62084&amp;p=3.html">3</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p308547">
				<div class="post-metadata">
					<div class="post-num">Post #26</div>
					<div class="post-author">anomeome</div>
					<div class="post-datetime">
						22 Jan 2016, 00:57					</div>
				</div>
				<div class="post-content content">
					<p>I noticed that my mbedTLS is version 1.3.16, so that may be it. I was looking back through the patches for something but nothing jumped out. My build is at r48443 if that matters.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p308550">
				<div class="post-metadata">
					<div class="post-num">Post #27</div>
					<div class="post-author">mmcneil</div>
					<div class="post-datetime">
						22 Jan 2016, 01:13					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>robzr wrote:</cite><blockquote><p>I haven&#039;t experienced this, but it may be a known issue with newer curl builds on OpenWRT: <a href="https://dev.openwrt.org/ticket/19621">https://dev.openwrt.org/ticket/19621</a></p><p>From what it looks like to me, curl (or rather the mbedTLS library, formerly known as PolarSSL) is not recognizing the root cert bundle and/or directory.&nbsp; The ca-certificates package loads a directory with root certs and then generates hash links to the cert files.&nbsp; The other method that people seem to use is to install a single cert bundle (one file with all the certs concatenated), which is what the <a href="http://curl.haxx.se/ca/cacert.pem">http://curl.haxx.se/ca/cacert.pem</a> file is.&nbsp; The compiled in options in curl/mbedTLS should read at least the directory (maybe the file too).&nbsp; Try this: &quot;curl --cafile /etc/ssl/certs/ca-certificates.crt <a href="https://lists.blocklist.de/lists/ssh.txt\">https://lists.blocklist.de/lists/ssh.txt&quot;</a></p><p>If that still fails, try uninstalling the ca-certificates bundle; make sure that the only file in /etc/ssl/certs is ca-certificates.crt (the bundle), and then try it again.&nbsp; Depending on the precedence that mbedTLS loads the cert files/bundles with, you might have a conflict there.</p><p>As a final band-aid you can also try &quot;curl --insecure <a href="https://lists.blocklist.de/lists/ssh.txt\">https://lists.blocklist.de/lists/ssh.txt&quot;</a> and see if that lets you sidestep the cert issue until this gets fixed.</p><p>Rob</p></blockquote></div><p>Thanks Rob.&nbsp; Unfortunately &#039;--cafile&#039; is not an available option for the version of curl that I have running on openwrt.&nbsp; I&#039;ll rebuild without ca-certificates, then I&#039;ll try installing them separately.&nbsp; I&#039;ll report back.&nbsp; Thanks for all of your help and sorry to be such a pain.</p><p>Mike</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p308553">
				<div class="post-metadata">
					<div class="post-num">Post #28</div>
					<div class="post-author">robzr</div>
					<div class="post-datetime">
						22 Jan 2016, 01:28					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mmcneil wrote:</cite><blockquote><p>Thanks Rob.&nbsp; Unfortunately &#039;--cafile&#039; is not an available option for the version of curl that I have running on openwrt.&nbsp; I&#039;ll rebuild without ca-certificates, then I&#039;ll try installing them separately.&nbsp; I&#039;ll report back.&nbsp; Thanks for all of your help and sorry to be such a pain.</p><p>Mike</p></blockquote></div><p>Sounds like you&#039;re not the only one having trouble with curl.&nbsp; Here&#039;s a workaround - grab the newest version of sub2rbl, and install the wget and openssl-util packages.&nbsp; sub2rbl will use that first if it&#039;s available (then curl, then busybox/wget).&nbsp; It takes up more space than curl, but it&#039;s an easy fix.&nbsp; If you want to force a particular command or adjust the options, use the uci config option &quot;webGetCmd&quot;.&nbsp; You can see the default arguments for each version around line 30 in sub2rbl.</p><p>Rob</p>											<p class="post-edited">(Last edited by <strong>robzr</strong> on 22 Jan 2016, 01:34)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p308786">
				<div class="post-metadata">
					<div class="post-num">Post #29</div>
					<div class="post-author">robzr</div>
					<div class="post-datetime">
						24 Jan 2016, 00:40					</div>
				</div>
				<div class="post-content content">
					<p>Because some people are using bearDropper to monitor more than just dropbear, I changed the regex filtering logic that determines which log lines are examined.&nbsp; It is now done in a uci config list, which is then assembled at runtime into a sed script file.&nbsp; This should make it a lot easier and more readable while adding additional filtering rules.&nbsp; Anyone who is upgrading to this newer version should make sure to grab the new config file in github, or add the following:</p><div class="codebox"><pre><code>  # Log scanning regexs for those who want to extend the pattern matching. These are run in order
  # by &quot;sed -nE&quot;. The IP blocked by bearDropper is the first one encountered in the log line, so
  # if the log line you are scanning for has multiple IPs.  Put /d (delete) entries before /p (print) entries.
        list    logRegex &#039;s/[`$&quot;&#039;\\\&#039;&#039;]//g&#039;            # strip escape chars
        list    logRegex &#039;/has invalid shell, rejected$/d&#039;    # delete (/d) - use to filter out
        list    logRegex &#039;/ authpriv.warn dropbear\[/p&#039;        # print (/p) - use to filter in </code></pre></div><p>The comments should be self-explanatory.&nbsp; The default behavior has not changed.&nbsp; The old &quot;regexLogString&quot; is no longer used, so anyone who was using a modified version will need to convert it to another list element.&nbsp; </p><p>wyf88 - add this to the end of the list to retain your ss-server filtering:<br /></p><div class="codebox"><pre><code>        list    logRegex &#039;\# kern.err /usr/bin/ss-server\[#p&#039;</code></pre></div><p>bouwew - add this to the end of your list:<br /></p><div class="codebox"><pre><code>        list    logRegex &#039;/ daemon.info .*invalid IKE header/p&#039;</code></pre></div><p>Rob</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p308842">
				<div class="post-metadata">
					<div class="post-num">Post #30</div>
					<div class="post-author">bouwew</div>
					<div class="post-datetime">
						24 Jan 2016, 16:49					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>robzr wrote:</cite><blockquote><p>bouwew - add this to the end of your list:<br /></p><div class="codebox"><pre><code>        list    logRegex &#039;/ daemon.info .*invalid IKE header/p&#039;</code></pre></div><p>Rob</p></blockquote></div><p>Got it, thanks!!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p310223">
				<div class="post-metadata">
					<div class="post-num">Post #31</div>
					<div class="post-author">robzr</div>
					<div class="post-datetime">
						4 Feb 2016, 04:52					</div>
				</div>
				<div class="post-content content">
					<p>I just fixed a bug in bearDropper&#039;s expiration logic; expired entries were not purging from the state database (they were purging from the firewall though).&nbsp; I&#039;d recommend anyone using bearDropper download the newest version.</p><p>Rob</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311207">
				<div class="post-metadata">
					<div class="post-num">Post #32</div>
					<div class="post-author">mmcneil</div>
					<div class="post-datetime">
						13 Feb 2016, 01:44					</div>
				</div>
				<div class="post-content content">
					<p>Hi robzr.&nbsp; I had a quick question regarding bearDropper.&nbsp; I installed it on my openwrt routers as per your instructions and a &#039;ps | grep bearDropper shows that it&#039;s running, however, when I check my logs I see the following message every 30 minutes:</p><p> bearDropper[7247]: loadState() loaded 0 entries</p><p>Does this indicate a configuration problem of some sort?</p><p>Thanks,</p><p>Mike</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311589">
				<div class="post-metadata">
					<div class="post-num">Post #33</div>
					<div class="post-author">robzr</div>
					<div class="post-datetime">
						16 Feb 2016, 00:33					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mmcneil wrote:</cite><blockquote><p>Hi robzr.&nbsp; I had a quick question regarding bearDropper.&nbsp; I installed it on my openwrt routers as per your instructions and a &#039;ps | grep bearDropper shows that it&#039;s running, however, when I check my logs I see the following message every 30 minutes:</p><p> bearDropper[7247]: loadState() loaded 0 entries</p><p>Does this indicate a configuration problem of some sort?</p><p>Thanks,</p><p>Mike</p></blockquote></div><p>Hi Mike - that line should only be output if you have logging set to verbose or debug (see the &quot;option logLevel&quot; line in /etc/config/bearDropper).&nbsp; But it sounds like it&#039;s not finding any bad login attempts in your syslog which would be pretty unusual if your wan interface is on the internet and aren&#039;t doing any other firewalling on 22/tcp.&nbsp; Out of curiosity, what do you get when you run:<br /></p><div class="codebox"><pre><code>logread | grep authpriv.warn\ dropbear | wc -l</code></pre></div><p>Rob</p>											<p class="post-edited">(Last edited by <strong>robzr</strong> on 16 Feb 2016, 00:34)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311768">
				<div class="post-metadata">
					<div class="post-num">Post #34</div>
					<div class="post-author">mmcneil</div>
					<div class="post-datetime">
						17 Feb 2016, 01:40					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>robzr wrote:</cite><blockquote><div class="quotebox"><cite>mmcneil wrote:</cite><blockquote><p>Hi robzr.&nbsp; I had a quick question regarding bearDropper.&nbsp; I installed it on my openwrt routers as per your instructions and a &#039;ps | grep bearDropper shows that it&#039;s running, however, when I check my logs I see the following message every 30 minutes:</p><p> bearDropper[7247]: loadState() loaded 0 entries</p><p>Does this indicate a configuration problem of some sort?</p><p>Thanks,</p><p>Mike</p></blockquote></div><p>Hi Mike - that line should only be output if you have logging set to verbose or debug (see the &quot;option logLevel&quot; line in /etc/config/bearDropper).&nbsp; But it sounds like it&#039;s not finding any bad login attempts in your syslog which would be pretty unusual if your wan interface is on the internet and aren&#039;t doing any other firewalling on 22/tcp.&nbsp; Out of curiosity, what do you get when you run:<br /></p><div class="codebox"><pre><code>logread | grep authpriv.warn\ dropbear | wc -l</code></pre></div><p>Rob</p></blockquote></div><p>Hi Rob.&nbsp; Thanks for getting back.&nbsp; Here&#039;s the output:</p><p>root@lnxs-rtr:~# logread | grep authpriv.warn\ dropbear | wc -l<br />0</p><p>So, nothing in the logs.. Let me check my firewall ruleset</p><p>Thanks,</p><p>EDIT:</p><p>Here&#039;s what I see in my logs ( my firewall zones log to my syslog server )</p><p>2016-02-16T08:10:16-08:00 lnxs-rtr.mac6.net kernel: [202695.870717] REJECT(src wan)IN=eth0 OUT= MAC=c0:56:27:77:60:ab:94:62:69:75:16:50:08:00 SRC=31.44.188.50 DST=104.49.221.253 LEN=48 TOS=0x00 PREC=0x00 TTL=106 ID=3816 DF PROTO=TCP SPT=62118 DPT=22 WINDOW=65535 RES=0x00 SYN URGP=0 </p><p>2016-02-16T08:54:49-08:00 lnxs-rtr.mac6.net kernel: [205368.715740] REJECT(src wan)IN=eth0 OUT= MAC=c0:56:27:77:60:ab:94:62:69:75:16:50:08:00 SRC=40.121.92.29 DST=104.49.221.253 LEN=48 TOS=0x00 PREC=0x00 TTL=109 ID=59374 PROTO=TCP SPT=49496 DPT=22 WINDOW=65535 RES=0x00 SYN URGP=0 </p><p>2016-02-16T09:31:39-08:00 lnxs-rtr.mac6.net kernel: [207578.240481] REJECT(src wan)IN=eth0 OUT= MAC=c0:56:27:77:60:ab:94:62:69:75:16:50:08:00 SRC=94.113.252.51 DST=104.49.221.253 LEN=48 TOS=0x00 PREC=0x00 TTL=102 ID=13461 PROTO=TCP SPT=7836 DPT=22 WINDOW=65535 RES=0x00 SYN URGP=0 </p><p>2016-02-16T12:28:16-08:00 lnxs-rtr.mac6.net kernel: [218175.644907] REJECT(src wan)IN=eth0 OUT= MAC=c0:56:27:77:60:ab:94:62:69:75:16:50:08:00 SRC=106.185.29.176 DST=104.49.221.253 LEN=40 TOS=0x00 PREC=0x00 TTL=239 ID=54321 PROTO=TCP SPT=50540 DPT=22 WINDOW=65535 RES=0x00 SYN URGP=0 </p><p>2016-02-16T12:38:38-08:00 lnxs-rtr.mac6.net kernel: [218797.591323] REJECT(src wan)IN=eth0 OUT= MAC=c0:56:27:77:60:ab:94:62:69:75:16:50:08:00 SRC=179.107.99.58 DST=104.49.221.253 LEN=48 TOS=0x00 PREC=0x00 TTL=110 ID=31115 PROTO=TCP SPT=2112 DPT=22 WINDOW=65535 RES=0x00 SYN URGP=0 </p><p>2016-02-16T12:46:11-08:00 lnxs-rtr.mac6.net kernel: [219250.606639] REJECT(src wan)IN=eth0 OUT= MAC=c0:56:27:77:60:ab:94:62:69:75:16:50:08:00 SRC=42.113.159.113 DST=104.49.221.253 LEN=52 TOS=0x00 PREC=0x00 TTL=113 ID=22601 DF PROTO=TCP SPT=17243 DPT=22 WINDOW=8192 RES=0x00 SYN URGP=0 </p><p>2016-02-16T12:46:12-08:00 lnxs-rtr.mac6.net kernel: [219251.323902] REJECT(src wan)IN=eth0 OUT= MAC=c0:56:27:77:60:ab:94:62:69:75:16:50:08:00 SRC=42.113.159.113 DST=104.49.221.253 LEN=52 TOS=0x00 PREC=0x00 TTL=113 ID=22650 DF PROTO=TCP SPT=17243 DPT=22 WINDOW=8192 RES=0x00 SYN URGP=0 </p><p>So the firewall is clearly rejecting inbound traffic destined for port 22, however, I don&#039;t understand why bearDropper isn&#039;t picking it up.</p><br /><p>Mike</p>											<p class="post-edited">(Last edited by <strong>mmcneil</strong> on 17 Feb 2016, 04:24)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311778">
				<div class="post-metadata">
					<div class="post-num">Post #35</div>
					<div class="post-author">robzr</div>
					<div class="post-datetime">
						17 Feb 2016, 06:16					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mmcneil wrote:</cite><blockquote><p>2016-02-16T08:10:16-08:00 lnxs-rtr.mac6.net kernel: [202695.870717] REJECT(src wan)IN=eth0 OUT= MAC=c0:56:27:77:60:ab:94:62:69:75:16:50:08:00 SRC=31.44.188.50 DST=104.49.221.253 LEN=48 TOS=0x00 PREC=0x00 TTL=106 ID=3816 DF PROTO=TCP SPT=62118 DPT=22 WINDOW=65535 RES=0x00 SYN URGP=0 </p><p>Mike</p></blockquote></div><p>Hey Mike - so I think there&#039;s a couple things going on here:</p><p>- bearDropper works by examining the dropbear syslog messages that are logged when there are failed authentication attempts; in your case at least some of the traffic is being blocked by iptables before it even makes it to dropbear (the ssh server), so there is no authentication attempt at all.&nbsp; Do you know what criteria you are using for blocking ssh in the firewall?</p><p>- if you&#039;re logging to a remote syslog server, then I don&#039;t think the log entries would make it into the local syslog ring buffer (but I could be wrong about this).&nbsp; bearDropper runs locally on the OpenWRT box and examines the local syslog ring buffer.&nbsp; We can verify if any logging at all makes it into the local ring buffer if you do a &quot;logread | wc -l&quot;</p><p>Rob</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311869">
				<div class="post-metadata">
					<div class="post-num">Post #36</div>
					<div class="post-author">mmcneil</div>
					<div class="post-datetime">
						17 Feb 2016, 20:31					</div>
				</div>
				<div class="post-content content">
					<p>Rob,</p><p>I&#039;ve verified that the logging is indeed making it to the ring buffer.&nbsp; You&#039;re correct in that the firewall is blocking ALL SSH traffic coming in from the WAN interface and therefore preventing anything from showing up in the logs. As for the criteria for blocking ssh, I&#039;m simply using the default iptables ruleset.&nbsp; I&#039;m a complete noob to iptables, so forgive me.&nbsp; How would I go about creating/modifying a rule for ssh?</p><p>Thanks,</p><p>Mike</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p311938">
				<div class="post-metadata">
					<div class="post-num">Post #37</div>
					<div class="post-author">robzr</div>
					<div class="post-datetime">
						18 Feb 2016, 06:47					</div>
				</div>
				<div class="post-content content">
					<p>They easiest way is to edit /etc/config/firewall - the documentation is <a href="https://wiki.openwrt.org/doc/uci/firewall">https://wiki.openwrt.org/doc/uci/firewall</a>&nbsp; The first example under &quot;Opening ports&quot; is exactly what you&#039;re looking for <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>Rob</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p313578">
				<div class="post-metadata">
					<div class="post-num">Post #38</div>
					<div class="post-author">bouwew</div>
					<div class="post-datetime">
						4 Mar 2016, 13:05					</div>
				</div>
				<div class="post-content content">
					<p><strong>Never mind</strong>, the issue is gone in build r48933.</p><p>Hi Rob,</p><p>Just updated my router (to Arokh&#039;s WDR4900-build r48874) and installed bearDropper again.<br />Logs show something strange:<br /></p><div class="codebox"><pre><code>root@router ~# wget -qO- http://rawgit.com/robzr/bearDropper/master/install.sh | sh
Detected previous version of bearDropper - stopping
Stopping bearDropper 7258
Retrieving and installing latest version...
Processing historical log data
Running in entire mode
processLogLine(,1457088093) malformed line (Fri Mar  4 11:41:33 2016 authpriv.warn dropbear[4847]: wtmp_write: problem writing /dev/null/wtmp: Not a directory)
processLogLine(,1457088367) malformed line (Fri Mar  4 11:46:07 2016 authpriv.warn dropbear[4846]: wtmp_write: problem writing /dev/null/wtmp: Not a directory)
processLogLine(,1457088367) malformed line (Fri Mar  4 11:46:07 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457088367) malformed line (Fri Mar  4 11:46:07 2016 authpriv.warn dropbear[4846]: wtmp_write: problem writing /dev/null/wtmp: Not a directory))
processLogLine(,1457088367) malformed line (Fri Mar  4 11:46:07 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457088367) malformed line (Fri Mar  4 11:46:07 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457088367) malformed line (Fri Mar  4 11:46:07 2016 authpriv.warn dropbear[4846]: wtmp_write: problem writing /dev/null/wtmp: Not a directory)))
processLogLine(,1457088367) malformed line (Fri Mar  4 11:46:07 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457088367) malformed line (Fri Mar  4 11:46:07 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457088367) malformed line (Fri Mar  4 11:46:07 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457088367) malformed line (Fri Mar  4 11:46:07 2016 authpriv.warn dropbear[4846]: wtmp_write: problem writing /dev/null/wtmp: Not a directory))))
processLogLine(,1457088885) malformed line (Fri Mar  4 11:54:45 2016 authpriv.warn dropbear[5906]: wtmp_write: problem writing /dev/null/wtmp: Not a directory)
processLogLine(,1457088885) malformed line (Fri Mar  4 11:54:45 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457088885) malformed line (Fri Mar  4 11:54:45 2016 authpriv.warn dropbear[5906]: wtmp_write: problem writing /dev/null/wtmp: Not a directory))
processLogLine(,1457088885) malformed line (Fri Mar  4 11:54:45 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457088885) malformed line (Fri Mar  4 11:54:45 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457088885) malformed line (Fri Mar  4 11:54:45 2016 authpriv.warn dropbear[5906]: wtmp_write: problem writing /dev/null/wtmp: Not a directory)))
processLogLine(,1457088885) malformed line (Fri Mar  4 11:54:45 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457088885) malformed line (Fri Mar  4 11:54:45 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457088885) malformed line (Fri Mar  4 11:54:45 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457088885) malformed line (Fri Mar  4 11:54:45 2016 authpriv.warn dropbear[5906]: wtmp_write: problem writing /dev/null/wtmp: Not a directory))))
processLogLine(,1457088885) malformed line (Fri Mar  4 11:54:45 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457088885) malformed line (Fri Mar  4 11:54:45 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457088885) malformed line (Fri Mar  4 11:54:45 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457088885) malformed line (Fri Mar  4 11:54:45 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457088885) malformed line (Fri Mar  4 11:54:45 2016 authpriv.warn dropbear[5906]: wtmp_write: problem writing /dev/null/wtFri Mar  4 11:57:33 2016 authpriv.notice sub2rbl[6092]: RBL (https://www.openbl.org/lists/base_30days.txt) added 2049 entries)
processLogLine(,1457089059) malformed line (Fri Mar  4 11:57:39 2016 authpriv.warn dropbear[5899]: wtmp_write: problem writing /dev/null/wtmp: Not a directory)
processLogLine(,1457089059) malformed line (Fri Mar  4 11:57:39 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457089059) malformed line (Fri Mar  4 11:57:39 2016 authpriv.warn dropbear[5899]: wtmp_write: problem writing /dev/null/wtmp: Not a directory))
processLogLine(,1457089059) malformed line (Fri Mar  4 11:57:39 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457089059) malformed line (Fri Mar  4 11:57:39 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457089059) malformed line (Fri Mar  4 11:57:39 2016 authpriv.warn dropbear[5899]: wtmp_write: problem writing /dev/null/wtmp: Not a directory)))
processLogLine(,1457089059) malformed line (Fri Mar  4 11:57:39 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457089059) malformed line (Fri Mar  4 11:57:39 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457089059) malformed line (Fri Mar  4 11:57:39 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457089059) malformed line (Fri Mar  4 11:57:39 2016 authpriv.warn dropbear[5899]: wtmp_write: problem writing /dev/null/wtmp: Not a directory))))
processLogLine(,1457089121) malformed line (Fri Mar  4 11:58:41 2016 authpriv.warn dropbear[6519]: wtmp_write: problem writing /dev/null/wtmp: Not a directory)
processLogLine(,1457089121) malformed line (Fri Mar  4 11:58:41 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457089121) malformed line (Fri Mar  4 11:58:41 2016 authpriv.warn dropbear[6519]: wtmp_write: problem writing /dev/null/wtmp: Not a directory))
processLogLine(,1457089121) malformed line (Fri Mar  4 11:58:41 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457089121) malformed line (Fri Mar  4 11:58:41 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457089121) malformed line (Fri Mar  4 11:58:41 2016 authpriv.warn dropbear[6519]: wtmp_write: problem writing /dev/null/wtmp: Not a directory)))
processLogLine(,1457089121) malformed line (Fri Mar  4 11:58:41 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457089121) malformed line (Fri Mar  4 11:58:41 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457089121) malformed line (Fri Mar  4 11:58:41 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457089121) malformed line (Fri Mar  4 11:58:41 2016 authpriv.warn dropbear[6519]: wtmp_write: problem writing /dev/null/wtmp: Not a directory))))
processLogLine(,1457089121) malformed line (Fri Mar  4 11:58:41 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457089121) malformed line (Fri Mar  4 11:58:41 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457089121) malformed line (Fri Mar  4 11:58:41 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457089121) malformed line (Fri Mar  4 11:58:41 2016 authpriv.notice bearDropper[5341]: processLogLine(,1457089121) malformed line (Fri Mar  4 11:58:41 2016 authpriv.warn dropbear[6519]: wtmp_write: problem writing /dev/null/wtFri Mar  4 11:59:22 2016 authpriv.notice bearDropper[7258]: Running in follow mode)
Starting background process
Starting bearDropper</code></pre></div><p>Any idea what&#039;s wrong?</p>											<p class="post-edited">(Last edited by <strong>bouwew</strong> on 7 Mar 2016, 11:37)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p314701">
				<div class="post-metadata">
					<div class="post-num">Post #39</div>
					<div class="post-author">robzr</div>
					<div class="post-datetime">
						14 Mar 2016, 04:25					</div>
				</div>
				<div class="post-content content">
					<p>Hi bouwew - sorry about the delay - so it looks like dropbear was using authpriv.warn facility to report the wtmp issue, and the bearDropper regex&#039;s were a little too dumb, so they picked up on that, and then they picked up on bearDropper itself reporting the bad log line.&nbsp; I hadn&#039;t seen that before, but it makes perfect sense.</p><p>I fixed the regex&#039;s, it&#039;s one line in bearDropper and one line in the config file - check github for the updates.&nbsp; Thanks for bringing this to my attention.</p><p>Rob</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p321323">
				<div class="post-metadata">
					<div class="post-num">Post #40</div>
					<div class="post-author">FreeByrdE</div>
					<div class="post-datetime">
						26 Apr 2016, 12:09					</div>
				</div>
				<div class="post-content content">
					<p>Forgive my ignorance, i&#039;m fairly new to Openwrt, but are BearDropper and Sub2rbl complimentary to each other and meant to be installed together or are they two scripts that do similar things only differently?<br />Also, I am running Arokh&#039;s build on my Wrt1900AC v2 and it already has dropbrute, how do I disable and get rid of dropbrute and replace it with BearDropper and/or Sub2rbl. Thanks in advance</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p321366">
				<div class="post-metadata">
					<div class="post-num">Post #41</div>
					<div class="post-author">robzr</div>
					<div class="post-datetime">
						26 Apr 2016, 20:46					</div>
				</div>
				<div class="post-content content">
					<p>They are complementary.&nbsp; Sub2RBL downloads existing lists of IPs known to be sources of bad scanning activity and blocks them.&nbsp; bearDropper will monitor your system logs to find IPs who are actively scanning you, and then block those.</p><p>If you run Sub2RBL, then bearDropper in theory won&#039;t have to do as much work.&nbsp; I&#039;d recommend you run them both <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Rob</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p321389">
				<div class="post-metadata">
					<div class="post-num">Post #42</div>
					<div class="post-author">FreeByrdE</div>
					<div class="post-datetime">
						27 Apr 2016, 00:31					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>robzr wrote:</cite><blockquote><p>They are complementary.&nbsp; Sub2RBL downloads existing lists of IPs known to be sources of bad scanning activity and blocks them.&nbsp; bearDropper will monitor your system logs to find IPs who are actively scanning you, and then block those.</p><p>If you run Sub2RBL, then bearDropper in theory won&#039;t have to do as much work.&nbsp; I&#039;d recommend you run them both <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Rob</p></blockquote></div><p>Thanks for the&nbsp; quick answer. How about the removing of dropbrute, how do I go about that? I don&#039;t see it in the system &gt; software tab so I&#039;m guessing I need to remove it manually somehow. Isn&#039;t it just an older less capable&nbsp; version of beardropper?</p><p>Would I just delete dropbrute.sh from /usr/sbin and delete dropbrute.leases &amp; dropbrute.log from /tmp. Then via web interface remove this line, (*/10 * * * * /usr/sbin/dropBrute.sh 2&gt;&amp;1 &gt;&gt; /tmp/dropBrute.log), from System &gt; Scheduled Tasks. And remove theses lines,</p><p>(<em># SSH brute force protection<br />WAN=`uci get network.wan.ifname`<br />iptables -w -N logndrop<br />iptables -w -N dropBrute<br />iptables -w -A logndrop -j LOG<br />iptables -w -A logndrop -j DROP<br /># Allow max 4 new SSH connections pr minute<br />iptables -w -A input_rule -p tcp --dport 22 -i $WAN -m state --state NEW -m recent --set<br />iptables -w -A input_rule -p tcp --dport 22 -i $WAN -m state --state NEW -m recent --update --seconds 60 --hitcount 4 -j logndrop<br /># Check for bans in the dropBrute chain<br />iptables -w -A input_rule -p tcp --dport 22 -j dropBrute<br /></em>),</p><p>from Network &gt; Firewall &gt; Custom Rules, or is there more to it than that?</p><p>Thanks again for any help you may provide.</p>											<p class="post-edited">(Last edited by <strong>FreeByrdE</strong> on 27 Apr 2016, 05:56)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p321758">
				<div class="post-metadata">
					<div class="post-num">Post #43</div>
					<div class="post-author">robzr</div>
					<div class="post-datetime">
						29 Apr 2016, 07:09					</div>
				</div>
				<div class="post-content content">
					<p>Hi, you are right, it is an older and simpler version, bearDropper is improved pretty much across the board.</p><p>I would remove everything you cited, including the rate limiting of ssh connections.&nbsp; The bearDropper installation is pretty simple in comparison.</p><p>Rob</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p321910">
				<div class="post-metadata">
					<div class="post-num">Post #44</div>
					<div class="post-author">FreeByrdE</div>
					<div class="post-datetime">
						30 Apr 2016, 07:50					</div>
				</div>
				<div class="post-content content">
					<p>so after I remove all those iptable entries do I need to create any new ones in their place manually or does the Beardropper and Sub2Rbl install scripts take care of all that is needed in that regard. Sorry for being a pest, I&#039;m just new to Openwrt. Been using DD-Wrt for years and tried Tomato but OpenWrt is a whole other beast, it&#039;s so flexible and configurable it&#039;s a bit overwhelming.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p321986">
				<div class="post-metadata">
					<div class="post-num">Post #45</div>
					<div class="post-author">robzr</div>
					<div class="post-datetime">
						30 Apr 2016, 21:29					</div>
				</div>
				<div class="post-content content">
					<p>Yah, just follow the instructions for installing on the github pages, it&#039;s pretty short &amp; sweet and that&#039;s all you need to do <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Good luck with OpenWRT, it&#039;s a great little OS.</p><p>Rob</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p322504">
				<div class="post-metadata">
					<div class="post-num">Post #46</div>
					<div class="post-author">kevindb</div>
					<div class="post-datetime">
						4 May 2016, 13:18					</div>
				</div>
				<div class="post-content content">
					<p>Hi Rob,</p><p>Think bearDropper is really very good.&nbsp; An anomaly/enhancement request.... Last night I had a persistent person connecting in &#039;batches&#039; to dropbear, not authenticating and then disconnecting; eg.</p><p>Tue May&nbsp; 3 23:01:19 2016 authpriv.info dropbear[6571]: Child connection from 121.42.203.212:50425<br />Tue May&nbsp; 3 23:01:19 2016 authpriv.info dropbear[6576]: Child connection from 121.42.203.212:50565<br />Tue May&nbsp; 3 23:01:19 2016 authpriv.info dropbear[6581]: Child connection from 121.42.203.212:50700<br />Tue May&nbsp; 3 23:01:19 2016 authpriv.info dropbear[6586]: Child connection from 121.42.203.212:50840<br />Tue May&nbsp; 3 23:01:19 2016 authpriv.info dropbear[6591]: Child connection from 121.42.203.212:50981<br />Tue May&nbsp; 3 23:01:19 2016 authpriv.info dropbear[6571]: Exit before auth: Exited normally<br />Tue May&nbsp; 3 23:01:19 2016 authpriv.info dropbear[6576]: Exit before auth: Exited normally<br />Tue May&nbsp; 3 23:01:19 2016 authpriv.info dropbear[6604]: Child connection from 121.42.203.212:51161<br />Tue May&nbsp; 3 23:01:20 2016 authpriv.info dropbear[6586]: Exit before auth: Exited normally<br />Tue May&nbsp; 3 23:01:20 2016 authpriv.info dropbear[6591]: Exit before auth: Exited normally<br />Tue May&nbsp; 3 23:01:20 2016 authpriv.info dropbear[6604]: Exit before auth: Exited normally<br />Tue May&nbsp; 3 23:01:21 2016 authpriv.info dropbear[6581]: Exit before auth: Exited normally</p><p>The normal exits are ignored by bearDropper and there&#039;s no harm done as such...but I do think persistent &#039;do nothing&#039; connections like this should be banned.&nbsp; Is that possible with a tweak of the sed strings (I hate regexp :-) or does it need a tweak to dropbear to report IP addresses in the &#039;exit before auth&#039; report?</p><p>thanks for your time,</p><p>Kevin</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p322918">
				<div class="post-metadata">
					<div class="post-num">Post #47</div>
					<div class="post-author">robzr</div>
					<div class="post-datetime">
						7 May 2016, 23:13					</div>
				</div>
				<div class="post-content content">
					<p>Hi Kevin - so this one is not a simple regex tweak, because unlike the authpriv.warn errors, the error message and the IP address are not on the same line.</p><p>This could be added but it would require tracking the &quot;Child connection from 121.42.203.212&quot; lines in order to correlate the PID of the child process with the IP address; then the main tracking logic would have to make a special case out of the &quot;Exit before auth&quot; errors, to go back and correlate the PID with the IP from the previous statement in order to know what IP to add to the ban list.</p><p>It&#039;d be a (moderate, not huge) amount of work to add this to bearDropper in an intelligent and efficient way.</p><p>As an interim step, it would be pretty trivial to make a second script which could monitor exactly for this situation, and then inject a new single log entry into the log buffer that bearDropper would parse.&nbsp; That would also make testing easier so I could eventually integrate that logic back in bearDropper.&nbsp; Hrmmm...</p><p>Last comment - if this were in bash it would be much easier, unfortunately ash does not support arrays (amongst other limitations).&nbsp; For bddb tracking I had to essentially write hash-like data structure handling from scratch (including expiration and purging so memory use does not run away), and it&#039;s tedious and relatively inefficient.&nbsp; A couple ideas are coming to mind, like a quasi-array with a fixed number of elements that would be pretty simple to implement, or possibly extending bddb....</p><p>Rob</p>											<p class="post-edited">(Last edited by <strong>robzr</strong> on 7 May 2016, 23:32)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323094">
				<div class="post-metadata">
					<div class="post-num">Post #48</div>
					<div class="post-author">kevindb</div>
					<div class="post-datetime">
						9 May 2016, 13:04					</div>
				</div>
				<div class="post-content content">
					<p>Thanks Rob,</p><p>Did you also see the issue I raised on github?</p><p>Cheers,</p><p>Kevin</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323163">
				<div class="post-metadata">
					<div class="post-num">Post #49</div>
					<div class="post-author">robzr</div>
					<div class="post-datetime">
						10 May 2016, 01:03					</div>
				</div>
				<div class="post-content content">
					<p>Hey Kevin - I didn&#039;t see that, thanks for the heads up, as well as troubleshooting it - that makes it a lot easier!&nbsp; I&#039;ll check it out and respond on GitHub.</p><p>Rob</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323630">
				<div class="post-metadata">
					<div class="post-num">Post #50</div>
					<div class="post-author">robzr</div>
					<div class="post-datetime">
						13 May 2016, 03:53					</div>
				</div>
				<div class="post-content content">
					<p>Kevin - I added in support for banning &quot;Exit before auth:&quot; entries by just hooking into getLogIP, it took just 6 extra lines.&nbsp; Instead of maintaining another db in memory, it does one extra sed statement to determine if it is an &quot;Exit before auth:&quot;, and if so it scans the log buffer to get the corresponding connection log entry, and parses the IP from that.</p><p>So it does add a little extra overhead, but it is (somewhat) tuneable via cmdLogreadEba (if using a very long ring buffer, it may be advisable to add a &quot;-l 1000&quot; or something here; but it would come at the expense of the ability to run an entire scan and get entries older than the last 1000 lines...)</p><p>Anyways, it&#039;s up on GitHub, the config file needed a slight change so if you&#039;re using a custom config you&#039;ll have to manually add another logRegex.&nbsp; If using the stock config, the one on GitHub is correct.</p><p>I had wanted to add this in a while back, because if you turn off password auth (using key based only), a lot more is logged like this, so now it works with password-less configs... </p><p>Rob</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 2 of 3</div><nav><ul><li><a href="viewtopic.php%3Fid=62084&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=62084&amp;p=3.html">3</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>