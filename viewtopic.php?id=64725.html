<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> OpenVPN and DHCP</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 24 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p323159">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">keizo</div>
					<div class="post-datetime">
						10 May 2016, 00:36					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>I&#039;m trying to run OpenVPN server on my WDR3700 using the ethernet bridge recipe located here: <a href="https://wiki.openwrt.org/doc/howto/vpn.server.openvpn.tap">https://wiki.openwrt.org/doc/howto/vpn. â€¦ penvpn.tap</a>. Everything works fine but i can&#039;t see if i use openvpn built in dhcp but i would like to use the router dhcp server so i can see the lease of the client.</p><p>I&#039;ve tried to setup another tap interface with a different dhcp address but the client doesn&#039;t get an ip address. </p><p>Also i&#039;ve setup dnsmasq as refered here: <a href="https://wiki.openwrt.org/oldwiki/openvpn.and.dns">https://wiki.openwrt.org/oldwiki/openvpn.and.dns</a> but i also cannot ping via name.</p><p>Here&#039;s my conf:</p><p>Server</p><div class="codebox"><pre><code>config openvpn &#039;ovpn&#039;
        option enabled &#039;1&#039;
        option mode &#039;server&#039;
        option dev &#039;tap1&#039;
        option port &#039;1194&#039;
        option comp_lzo &#039;yes&#039;
        option status &#039;/tmp/openvpn-status.log&#039;
        option log &#039;/tmp/openvpn.log&#039;
        option verb &#039;3&#039;
        option mute &#039;5&#039;
        option keepalive &#039;10 120&#039;
        option persist_key &#039;1&#039;
        option persist_tun &#039;1&#039;
        option ca &#039;/etc/openvpn/ca.crt&#039;
        option cert &#039;/etc/openvpn/server.crt&#039;
        option key &#039;/etc/openvpn/server.key&#039;
        option dh &#039;/etc/openvpn/dh2048.pem&#039;
        option cipher &#039;AES-256-CBC&#039;
        option tls_server &#039;1&#039;
        option sndbuf &#039;393216&#039;
        option rcvbuf &#039;393216&#039;
        option client_to_client &#039;1&#039;
        option learn_address /etc/openvpn/learn-address.sh
        option script_security &#039;2&#039;</code></pre></div><p>Firewall</p><div class="codebox"><pre><code>config defaults
        option syn_flood &#039;1&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;

config zone
        option name &#039;lan&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;ACCEPT&#039;
        option network &#039;lan VPN&#039;

config zone
        option name &#039;wan&#039;
        option input &#039;REJECT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;
        option masq &#039;1&#039;
        option mtu_fix &#039;1&#039;
        option network &#039;wan wan6&#039;

config rule
        option name &#039;Allow-DHCP-Renew&#039;
        option src &#039;wan&#039;
        option proto &#039;udp&#039;
        option dest_port &#039;68&#039;
        option target &#039;ACCEPT&#039;
        option family &#039;ipv4&#039;

config rule
        option name &#039;Allow-Ping&#039;
        option src &#039;wan&#039;
        option proto &#039;icmp&#039;
        option icmp_type &#039;echo-request&#039;
        option family &#039;ipv4&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-IGMP&#039;
        option src &#039;wan&#039;
        option proto &#039;igmp&#039;
        option family &#039;ipv4&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-DHCPv6&#039;
        option src &#039;wan&#039;
        option proto &#039;udp&#039;
        option src_ip &#039;fe80::/10&#039;
        option src_port &#039;547&#039;
        option dest_ip &#039;fe80::/10&#039;
        option dest_port &#039;546&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-MLD&#039;
        option src &#039;wan&#039;
        option proto &#039;icmp&#039;
        option src_ip &#039;fe80::/10&#039;
        list icmp_type &#039;130/0&#039;
        list icmp_type &#039;131/0&#039;
        list icmp_type &#039;132/0&#039;
        list icmp_type &#039;143/0&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-ICMPv6-Input&#039;
        option src &#039;wan&#039;
        option proto &#039;icmp&#039;
        list icmp_type &#039;echo-request&#039;
        list icmp_type &#039;echo-reply&#039;
        list icmp_type &#039;destination-unreachable&#039;
        list icmp_type &#039;packet-too-big&#039;
        list icmp_type &#039;time-exceeded&#039;
        list icmp_type &#039;bad-header&#039;
        list icmp_type &#039;unknown-header-type&#039;
        list icmp_type &#039;router-solicitation&#039;
        list icmp_type &#039;neighbour-solicitation&#039;
        list icmp_type &#039;router-advertisement&#039;
        list icmp_type &#039;neighbour-advertisement&#039;
        option limit &#039;1000/sec&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-ICMPv6-Forward&#039;
        option src &#039;wan&#039;
        option dest &#039;*&#039;
        option proto &#039;icmp&#039;
        list icmp_type &#039;echo-request&#039;
        list icmp_type &#039;echo-reply&#039;
        list icmp_type &#039;destination-unreachable&#039;
        list icmp_type &#039;packet-too-big&#039;
        list icmp_type &#039;time-exceeded&#039;
        list icmp_type &#039;bad-header&#039;
        list icmp_type &#039;unknown-header-type&#039;
        option limit &#039;1000/sec&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config include
        option path &#039;/etc/firewall.user&#039;

config rule
        option src &#039;wan&#039;
        option dest &#039;lan&#039;
        option proto &#039;esp&#039;
        option target &#039;ACCEPT&#039;
        option name &#039;IPSEC-ESP&#039;
        option enabled &#039;0&#039;

config rule
        option src &#039;wan&#039;
        option dest &#039;lan&#039;
        option dest_port &#039;500&#039;
        option proto &#039;udp&#039;
        option target &#039;ACCEPT&#039;
        option name &#039;IPSEC&#039;
        option enabled &#039;0&#039;

config rule
        option name &#039;Don&#039;\&#039;&#039;t track NETBIOS Service&#039;
        option src &#039;lan&#039;
        option src_port &#039;137-139&#039;
        option dest &#039;lan&#039;
        option target &#039;NOTRACK&#039;

config rule
        option name &#039;Don&#039;\&#039;&#039;t track NETBIOS Service&#039;
        option src &#039;lan&#039;
        option dest &#039;lan&#039;
        option dest_port &#039;137-139&#039;
        option target &#039;NOTRACK&#039;

config rule
        option name &#039;Don&#039;\&#039;&#039;t track Windows Filesharing&#039;
        option src &#039;lan&#039;
        option src_port &#039;445&#039;
        option dest &#039;lan&#039;
        option target &#039;NOTRACK&#039;

config rule
        option name &#039;Don&#039;\&#039;&#039;t track Windows Filesharing&#039;
        option src &#039;lan&#039;
        option dest &#039;lan&#039;
        option dest_port &#039;445&#039;
        option target &#039;NOTRACK&#039;

config rule
        option name &#039;Allow-OpenVPN-Inbound&#039;
        option target &#039;ACCEPT&#039;
        option src &#039;wan&#039;
        option proto &#039;udp&#039;
        option dest_port &#039;1194&#039;

config zone
        option network &#039;guest&#039;
        option input &#039;REJECT&#039;
        option forward &#039;REJECT&#039;
        option output &#039;ACCEPT&#039;
        option name &#039;guest&#039;

config rule
        option name &#039;Allow DNS Queries&#039;
        option src &#039;guest&#039;
        option dest_port &#039;53&#039;
        option proto &#039;tcpudp&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow DHCP request&#039;
        option src &#039;guest&#039;
        option src_port &#039;67-68&#039;
        option dest_port &#039;67-68&#039;
        option proto &#039;udp&#039;
        option target &#039;ACCEPT&#039;

config include &#039;miniupnpd&#039;
        option type &#039;script&#039;
        option path &#039;/usr/share/miniupnpd/firewall.include&#039;
        option family &#039;any&#039;
        option reload &#039;1&#039;

config forwarding
        option dest &#039;wan&#039;
        option src &#039;guest&#039;

config forwarding
        option dest &#039;wan&#039;
        option src &#039;lan&#039;</code></pre></div><p>DHCP</p><div class="codebox"><pre><code>config dnsmasq
        option domainneeded &#039;1&#039;
        option boguspriv &#039;1&#039;
        option localise_queries &#039;1&#039;
        option rebind_protection &#039;1&#039;
        option rebind_localhost &#039;1&#039;
        option local &#039;/lan/&#039;
        option domain &#039;lan&#039;
        option expandhosts &#039;1&#039;
        option authoritative &#039;1&#039;
        option readethers &#039;1&#039;
        option leasefile &#039;/tmp/dhcp.leases&#039;
        option noresolv &#039;1&#039;
        option localservice &#039;1&#039;
        option dhcp_boot &#039;bootx64.efi&#039;
        option enable_tftp &#039;1&#039;
        option tftp_root &#039;/mnt/sda1/.netboot/tftp&#039;
        list server &#039;10.0.0.1#10053&#039;

config dhcp &#039;lan&#039;
        option interface &#039;lan&#039;
        option start &#039;100&#039;
        option leasetime &#039;12h&#039;
        option limit &#039;50&#039;

config dhcp &#039;wan&#039;
        option interface &#039;wan&#039;
        option ignore &#039;1&#039;

config odhcpd &#039;odhcpd&#039;
        option maindhcp &#039;0&#039;
        option leasefile &#039;/tmp/hosts/odhcpd&#039;
        option leasetrigger &#039;/usr/sbin/odhcpd-update&#039;

config dhcp &#039;guest&#039;
        option interface &#039;guest&#039;
        option limit &#039;10&#039;
        option leasetime &#039;1h&#039;
        option start &#039;10&#039;

config dhcp &#039;vpn&#039;
        option leasetime &#039;12h&#039;
        option interface &#039;vpn&#039;
        option start &#039;100&#039;
        option limit &#039;150&#039;</code></pre></div><p>and network</p><div class="codebox"><pre><code>config interface &#039;loopback&#039;
        option ifname &#039;lo&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;127.0.0.1&#039;
        option netmask &#039;255.0.0.0&#039;

config globals &#039;globals&#039;
        option ula_prefix &#039;fdbf:ca66:54fc::/48&#039;

config interface &#039;lan&#039;
        option type &#039;bridge&#039;
        option proto &#039;static&#039;
        option netmask &#039;255.255.255.0&#039;
        option ip6assign &#039;60&#039;
        option ipaddr &#039;10.0.0.1&#039;
        option _orig_ifname &#039;eth0.1 tap0 wlan0 wlan1&#039;
        option _orig_bridge &#039;true&#039;
        option ifname &#039;eth0.1 tap0&#039;

config interface &#039;wan&#039;
        option proto &#039;dhcp&#039;
        option _orig_ifname &#039;eth0.2&#039;
        option _orig_bridge &#039;false&#039;
        option ifname &#039;eth0.12&#039;
        option peerdns &#039;0&#039;
        option dns &#039;208.67.222.222 208.67.220.220&#039;

config interface &#039;wan6&#039;
        option ifname &#039;@wan&#039;
        option _orig_ifname &#039;@wan&#039;
        option _orig_bridge &#039;false&#039;
        option proto &#039;dhcpv6&#039;
        option reqaddress &#039;try&#039;
        option reqprefix &#039;auto&#039;
        option peerdns &#039;0&#039;
        option dns &#039;2620:0:ccc::2 2620:0:ccd::2&#039;

config switch
        option name &#039;switch0&#039;
        option reset &#039;1&#039;
        option enable_vlan &#039;1&#039;
        option mirror_source_port &#039;0&#039;
        option mirror_monitor_port &#039;0&#039;

config switch_vlan
        option device &#039;switch0&#039;
        option vlan &#039;1&#039;
        option ports &#039;0t 2 3 4 5&#039;
        option vid &#039;1&#039;

config switch_vlan
        option device &#039;switch0&#039;
        option vlan &#039;2&#039;
        option ports &#039;0t 1t&#039;
        option vid &#039;12&#039;

config interface &#039;guest&#039;
        option _orig_ifname &#039;wlan0-1&#039;
        option _orig_bridge &#039;false&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;172.16.0.1&#039;
        option netmask &#039;255.255.255.0&#039;

config interface &#039;vpn&#039;
        option proto &#039;static&#039;
        option ifname &#039;tap1&#039;
        option netmask &#039;255.255.255.0&#039;
        option ipaddr &#039;192.168.1.1&#039;</code></pre></div><p>If anyone could help me solve this i would appreciate.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323161">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						10 May 2016, 00:42					</div>
				</div>
				<div class="post-content content">
					<p>That wiki does not include the required forwarding rules for the VPN zone.&nbsp; Try this one:<br /><a href="https://wiki.openwrt.org/doc/howto/openvpn-streamlined-server-setup">https://wiki.openwrt.org/doc/howto/open â€¦ rver-setup</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323177">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">keizo</div>
					<div class="post-datetime">
						10 May 2016, 03:02					</div>
				</div>
				<div class="post-content content">
					<p>Thank you.</p><p>I&#039;ve created the all rules from the wiki but i stiil can&#039;t get the client to get the ip address from the lan dhcp server and i cannot see the lease on the LuCi overview webpage.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323188">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						10 May 2016, 07:36					</div>
				</div>
				<div class="post-content content">
					<p>Unclear what you are trying to say here.&nbsp; Does the server indicate that it is up and listening?</p><p>Post your openvpn, firewall, openvpn-status.log, openvpn.log and network files.&nbsp; </p><p>What is your client?&nbsp; Post openvpn.config file and logs.</p><p>You do not have a option server_bridge line.&nbsp; Your client should get their IP form this pool, not the router DHCP.&nbsp; They should not overlap.&nbsp; I realize this is not what you want to do (above), but get it working first.&nbsp; Also you may (probably) need to remove the dns masque code you added.</p><p>Walk before you run.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323238">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">keizo</div>
					<div class="post-datetime">
						10 May 2016, 18:07					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ve got it working with the server_bridge using this config:</p><p>Openvpn</p><div class="codebox"><pre><code>config openvpn &#039;VPNserver&#039;

        option enabled  &#039;1&#039;
        option dev      &#039;tap1&#039;
        option proto    &#039;udp&#039;
        option port     &#039;1194&#039;
        option mode     &#039;server&#039;

        option server_bridge &#039;10.0.0.1 255.255.255.0 10.0.0.200 10.0.0.220&#039;

#       option ifconfig_pool_persist   &#039;/etc/openvpn/clients/ipp.txt&#039;

#        list push &#039;route 10.0.0.0 255.255.255.0&#039;
#        list push &#039;dhcp-option DNS 10.0.0.1&#039;

        option tls_server &#039;1&#039;
        option cipher     &#039;AES-256-CBC&#039;
        option ca &#039;/etc/openvpn/ca.crt&#039;
        option cert &#039;/etc/openvpn/server.crt&#039;
        option key &#039;/etc/openvpn/server.key&#039;
        option dh &#039;/etc/openvpn/dh2048.pem&#039;


        option log &#039;/tmp/openvpn.log&#039;
        option status &#039;/tmp/openvpn-status.log&#039;
        option verb &#039;7&#039;

        option keepalive &#039;10 120&#039;
        option comp_lzo &#039;yes&#039;

        option client_to_client &#039;1&#039;
        option persist_key &#039;1&#039;
        option persist_tun &#039;1&#039;

        option sndbuf &#039;393216&#039;
        option rcvbuf &#039;393216&#039;
        option fragment &#039;0&#039;
        option mssfix &#039;0&#039;
        option tun_mtu &#039;24000&#039;

        list push &#039;sndbuf 393216&#039;
        list push &#039;rcvbuf 393216&#039;</code></pre></div><p>Firewall</p><div class="codebox"><pre><code>config rule
        option target &#039;ACCEPT&#039;
        option proto &#039;tcp udp&#039;
        option family &#039;ipv4&#039;
        option src &#039;*&#039;
        option dest_port &#039;1194&#039;
        option name &#039;Allow Inbound VPN&#039;

config rule
        option target &#039;ACCEPT&#039;
        option proto &#039;tcp udp&#039;
        option family &#039;ipv4&#039;
        option src &#039;*&#039;
        option src_ip &#039;10.8.0.0/24&#039;
        option dest_ip &#039;10.0.0.0/24&#039;
        option name &#039;Allow Inbound VPN Traffic to LAN&#039;

config rule
        option target &#039;ACCEPT&#039;
        option proto &#039;tcp udp&#039;
        option family &#039;ipv4&#039;
        option src &#039;*&#039;
        option src_ip &#039;10.8.0.0/24&#039;
        option dest &#039;*&#039;
        option dest_ip &#039;10.0.0.0/24&#039;
        option name &#039;Allow Forwarded VPN Traffic to LAN&#039;

config rule
        option target &#039;ACCEPT&#039;
        option proto &#039;icmp&#039;
        option src_ip &#039;10.8.0.0/24&#039;
        option src &#039;*&#039;
        option dest &#039;lan&#039;
        option name &#039;Allow Inbound ICMP Traffic from VPN to LAN&#039;

config rule
        option target &#039;ACCEPT&#039;
        option proto &#039;icmp&#039;
        option src &#039;*&#039;
        option src_ip &#039;10.8.0.0/24&#039;
        option dest &#039;wan&#039;
        option name &#039;Allow Outbound ICMP Echo Request (8) from VPN&#039;
        list icmp_type &#039;echo-request&#039;

config defaults
        option syn_flood &#039;1&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;DROP&#039;
        option drop_invalid &#039;1&#039;

config zone
        option name &#039;lan&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;DROP&#039;
        option network &#039;lan&#039;

config zone
        option name &#039;wan&#039;
        option output &#039;ACCEPT&#039;
        option input &#039;DROP&#039;
        option forward &#039;DROP&#039;
        option masq &#039;1&#039;
        option mtu_fix &#039;1&#039;
        option network &#039;wan wan6&#039;

config zone
        option name &#039;vpn&#039;
        option input &#039;ACCEPT&#039;
        option forward &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option family &#039;ipv4&#039;
        option network &#039;vpn0 vpn&#039;

config rule
        option name &#039;Allow-DHCP-Renew&#039;
        option src &#039;wan&#039;
        option proto &#039;udp&#039;
        option dest_port &#039;68&#039;
        option target &#039;ACCEPT&#039;
        option family &#039;ipv4&#039;

config rule
        option name &#039;Allow-Ping&#039;
        option src &#039;wan&#039;
        option proto &#039;icmp&#039;
        option icmp_type &#039;echo-request&#039;
        option family &#039;ipv4&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-IGMP&#039;
        option src &#039;wan&#039;
        option proto &#039;igmp&#039;
        option family &#039;ipv4&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-DHCPv6&#039;
        option src &#039;wan&#039;
        option proto &#039;udp&#039;
        option src_ip &#039;fe80::/10&#039;
        option src_port &#039;547&#039;
        option dest_ip &#039;fe80::/10&#039;
        option dest_port &#039;546&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-MLD&#039;
        option src &#039;wan&#039;
        option proto &#039;icmp&#039;
        option src_ip &#039;fe80::/10&#039;
        list icmp_type &#039;130/0&#039;
        list icmp_type &#039;131/0&#039;
        list icmp_type &#039;132/0&#039;
        list icmp_type &#039;143/0&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-ICMPv6-Input&#039;
        option src &#039;wan&#039;
        option proto &#039;icmp&#039;
        list icmp_type &#039;echo-request&#039;
        list icmp_type &#039;echo-reply&#039;
        list icmp_type &#039;destination-unreachable&#039;
        list icmp_type &#039;packet-too-big&#039;
        list icmp_type &#039;time-exceeded&#039;
        list icmp_type &#039;bad-header&#039;
        list icmp_type &#039;unknown-header-type&#039;
        list icmp_type &#039;router-solicitation&#039;
        list icmp_type &#039;neighbour-solicitation&#039;
        list icmp_type &#039;router-advertisement&#039;
        list icmp_type &#039;neighbour-advertisement&#039;
        option limit &#039;1000/sec&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-ICMPv6-Forward&#039;
        option src &#039;wan&#039;
        option dest &#039;*&#039;
        option proto &#039;icmp&#039;
        list icmp_type &#039;echo-request&#039;
        list icmp_type &#039;echo-reply&#039;
        list icmp_type &#039;destination-unreachable&#039;
        list icmp_type &#039;packet-too-big&#039;
        list icmp_type &#039;time-exceeded&#039;
        list icmp_type &#039;bad-header&#039;
        list icmp_type &#039;unknown-header-type&#039;
        option limit &#039;1000/sec&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config include
        option path &#039;/etc/firewall.user&#039;

config rule
        option src &#039;wan&#039;
        option dest &#039;lan&#039;
        option proto &#039;esp&#039;
        option target &#039;ACCEPT&#039;
        option name &#039;IPSEC-ESP&#039;
        option enabled &#039;0&#039;

config rule
        option src &#039;wan&#039;
        option dest &#039;lan&#039;
        option dest_port &#039;500&#039;
        option proto &#039;udp&#039;
        option target &#039;ACCEPT&#039;
        option name &#039;IPSEC&#039;
        option enabled &#039;0&#039;

config rule
        option name &#039;Don&#039;\&#039;&#039;t track NETBIOS Service&#039;
        option src &#039;lan&#039;
        option src_port &#039;137-139&#039;
        option dest &#039;lan&#039;
        option target &#039;NOTRACK&#039;

config rule
        option name &#039;Don&#039;\&#039;&#039;t track NETBIOS Service&#039;
        option src &#039;lan&#039;
        option dest &#039;lan&#039;
        option dest_port &#039;137-139&#039;
        option target &#039;NOTRACK&#039;

config rule
        option name &#039;Don&#039;\&#039;&#039;t track Windows Filesharing&#039;
        option src &#039;lan&#039;
        option src_port &#039;445&#039;
        option dest &#039;lan&#039;
        option target &#039;NOTRACK&#039;

config rule
        option name &#039;Don&#039;\&#039;&#039;t track Windows Filesharing&#039;
        option src &#039;lan&#039;
        option dest &#039;lan&#039;
        option dest_port &#039;445&#039;
        option target &#039;NOTRACK&#039;

config rule
        option name &#039;Allow-OpenVPN-Inbound&#039;
        option target &#039;ACCEPT&#039;
        option src &#039;wan&#039;
        option proto &#039;udp&#039;
        option dest_port &#039;1194&#039;

config zone
        option network &#039;guest&#039;
        option input &#039;REJECT&#039;
        option forward &#039;REJECT&#039;
        option output &#039;ACCEPT&#039;
        option name &#039;guest&#039;

config rule
        option name &#039;Allow DNS Queries&#039;
        option src &#039;guest&#039;
        option dest_port &#039;53&#039;
        option proto &#039;tcpudp&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow DHCP request&#039;
        option src &#039;guest&#039;
        option src_port &#039;67-68&#039;
        option dest_port &#039;67-68&#039;
        option proto &#039;udp&#039;
        option target &#039;ACCEPT&#039;

config include &#039;miniupnpd&#039;
        option type &#039;script&#039;
        option path &#039;/usr/share/miniupnpd/firewall.include&#039;
        option family &#039;any&#039;
        option reload &#039;1&#039;

config forwarding
        option dest &#039;wan&#039;
        option src &#039;guest&#039;

config forwarding
        option dest &#039;wan&#039;
        option src &#039;lan&#039;

config forwarding
        option dest &#039;lan&#039;
        option src &#039;vpn&#039;

config forwarding
        option dest &#039;vpn&#039;
        option src &#039;lan&#039;</code></pre></div><p>Openvpn log</p><div class="codebox"><pre><code>Tue May 10 15:22:48 2016 us=158126 OpenVPN 2.3.6 mips-openwrt-linux-gnu [SSL (OpenSSL)] [LZO] [EPOLL] [MH] [IPv6] built on Dec 31 2015
Tue May 10 15:22:48 2016 us=158373 library versions: OpenSSL 1.0.2e 3 Dec 2015, LZO 2.08
Tue May 10 15:22:48 2016 us=158794 NOTE: when bridging your LAN adapter with the TAP adapter, note that the new bridge adapter will often take on its own IP address that is different from what the LAN adapter was previously set to
Tue May 10 15:22:49 2016 us=253789 Diffie-Hellman initialized with 2048 bit key
Tue May 10 15:22:49 2016 us=270324 TLS-Auth MTU parms [ L:24090 D:138 EF:38 EB:0 ET:0 EL:0 ]
Tue May 10 15:22:49 2016 us=270574 Socket Buffers: R=[163840-&gt;786432] S=[163840-&gt;786432]
Tue May 10 15:22:49 2016 us=296118 TUN/TAP device tap1 opened
Tue May 10 15:22:49 2016 us=296320 TUN/TAP TX queue length set to 100
Tue May 10 15:22:49 2016 us=296659 Data Channel MTU parms [ L:24090 D:24090 EF:58 EB:135 ET:32 EL:0 AF:3/1 ]
Tue May 10 15:22:49 2016 us=296798 UDPv4 link local (bound): [undef]
Tue May 10 15:22:49 2016 us=296911 UDPv4 link remote: [undef]
Tue May 10 15:22:49 2016 us=297080 MULTI: multi_init called, r=256 v=256
Tue May 10 15:22:49 2016 us=328042 IFCONFIG POOL: base=10.0.0.200 size=21, ipv6=0
Tue May 10 15:22:49 2016 us=328983 Initialization Sequence Completed
Tue May 10 15:24:48 2016 us=925521 MULTI: multi_create_instance called
Tue May 10 15:24:48 2016 us=925861 *.*.*.*:53414 Re-using SSL/TLS context
Tue May 10 15:24:48 2016 us=926076 *.*.*.*:53414 LZO compression initialized
Tue May 10 15:24:48 2016 us=929919 *.*.*.*:53414 Control Channel MTU parms [ L:24090 D:138 EF:38 EB:0 ET:0 EL:0 ]
Tue May 10 15:24:48 2016 us=930130 *.*.*.*:53414 Data Channel MTU parms [ L:24090 D:24090 EF:58 EB:135 ET:32 EL:0 AF:3/1 ]
Tue May 10 15:24:48 2016 us=930438 *.*.*.*:53414 UDPv4 READ [14] from [AF_INET]*.*.*.*:53414: P_CONTROL_HARD_RESET_CLIENT_V2 kid=0 [ ] pid=0 DATA len=0
Tue May 10 15:24:48 2016 us=930645 *.*.*.*:53414 TLS: Initial packet from [AF_INET]*.*.*.*:53414, sid=f9d0d768 6d1fe70b
Tue May 10 15:24:48 2016 us=930922 *.*.*.*:53414 UDPv4 WRITE [26] to [AF_INET]*.*.*.*:53414: P_CONTROL_HARD_RESET_SERVER_V2 kid=0 [ 0 ] pid=0 DATA len=0
Tue May 10 15:24:48 2016 us=933018 *.*.*.*:53414 UDPv4 READ [22] from [AF_INET]*.*.*.*:53414: P_ACK_V1 kid=0 [ 0 ]
Tue May 10 15:24:48 2016 us=933584 *.*.*.*:53414 UDPv4 READ [330] from [AF_INET]*.*.*.*:53414: P_CONTROL_V1 kid=0 [ ] pid=1 DATA len=316
Tue May 10 15:24:49 2016 us=361363 *.*.*.*:53414 UDPv4 WRITE [126] to [AF_INET]*.*.*.*:53414: P_CONTROL_V1 kid=0 [ 1 ] pid=1 DATA len=100
Tue May 10 15:24:49 2016 us=361940 *.*.*.*:53414 UDPv4 WRITE [114] to [AF_INET]*.*.*.*:53414: P_CONTROL_V1 kid=0 [ ] pid=2 DATA len=100
Tue May 10 15:24:49 2016 us=362392 *.*.*.*:53414 NOTE: --mute triggered...
Tue May 10 15:24:49 2016 us=734584 *.*.*.*:53414 74 variation(s) on previous 5 message(s) suppressed by --mute
Tue May 10 15:24:49 2016 us=734755 *.*.*.*:53414 VERIFY OK: depth=1, C=PT, ST=PRT, L=Porto, O=Cupcakes, OU=OpenVPN, CN=WDR3600, name=OpenVPN, emailAddress=me@cupcakes.tld
Tue May 10 15:24:49 2016 us=749462 *.*.*.*:53414 VERIFY OK: depth=0, C=PT, ST=PRT, L=Porto, O=Cupcakes, OU=OpenVPN, CN=client, name=OpenVPN, emailAddress=me@cupcakes.tld
Tue May 10 15:24:50 2016 us=806746 *.*.*.*:53414 UDPv4 WRITE [85] to [AF_INET]*.*.*.*:53414: P_CONTROL_V1 kid=0 [ 4 ] pid=37 DATA len=59
Tue May 10 15:24:50 2016 us=827740 *.*.*.*:53414 UDPv4 READ [388] from [AF_INET]*.*.*.*:53414: P_CONTROL_V1 kid=0 [ 37 ] pid=5 DATA len=362
Tue May 10 15:24:50 2016 us=829411 *.*.*.*:53414 Data Channel Encrypt: Cipher &#039;AES-256-CBC&#039; initialized with 256 bit key
Tue May 10 15:24:50 2016 us=829610 *.*.*.*:53414 Data Channel Encrypt: Using 160 bit message hash &#039;SHA1&#039; for HMAC authentication
Tue May 10 15:24:50 2016 us=829748 *.*.*.*:53414 Data Channel Decrypt: Cipher &#039;AES-256-CBC&#039; initialized with 256 bit key
Tue May 10 15:24:50 2016 us=829920 *.*.*.*:53414 Data Channel Decrypt: Using 160 bit message hash &#039;SHA1&#039; for HMAC authentication
Tue May 10 15:24:50 2016 us=830365 *.*.*.*:53414 UDPv4 WRITE [126] to [AF_INET]*.*.*.*:53414: P_CONTROL_V1 kid=0 [ 5 ] pid=38 DATA len=100
Tue May 10 15:24:50 2016 us=830842 *.*.*.*:53414 UDPv4 WRITE [68] to [AF_INET]*.*.*.*:53414: P_CONTROL_V1 kid=0 [ ] pid=39 DATA len=54
Tue May 10 15:24:50 2016 us=831887 *.*.*.*:53414 UDPv4 READ [22] from [AF_INET]*.*.*.*:53414: P_ACK_V1 kid=0 [ 38 ]
Tue May 10 15:24:50 2016 us=835317 *.*.*.*:53414 UDPv4 READ [22] from [AF_INET]*.*.*.*:53414: P_ACK_V1 kid=0 [ 39 ]
Tue May 10 15:24:50 2016 us=835614 *.*.*.*:53414 Control Channel: TLSv1, cipher TLSv1/SSLv3 DHE-RSA-AES256-SHA, 2048 bit RSA
Tue May 10 15:24:50 2016 us=835859 *.*.*.*:53414 [client] Peer Connection Initiated with [AF_INET]*.*.*.*:53414
Tue May 10 15:24:50 2016 us=836134 client/*.*.*.*:53414 MULTI_sva: pool returned IPv4=10.0.0.200, IPv6=(Not enabled)
Tue May 10 15:24:53 2016 us=204562 client/*.*.*.*:53414 UDPv4 READ [104] from [AF_INET]*.*.*.*:53414: P_CONTROL_V1 kid=0 [ ] pid=6 DATA len=90
Tue May 10 15:24:53 2016 us=205411 client/*.*.*.*:53414 PUSH: Received control message: &#039;PUSH_REQUEST&#039;
Tue May 10 15:24:53 2016 us=205578 client/*.*.*.*:53414 send_push_reply(): safe_cap=940
Tue May 10 15:24:53 2016 us=205949 client/*.*.*.*:53414 SENT CONTROL [client]: &#039;PUSH_REPLY,sndbuf 393216,rcvbuf 393216,route-gateway 10.0.0.1,ping 10,ping-restart 120,ifconfig 10.0.0.200 255.255.255.0&#039; (status=1)
Tue May 10 15:24:53 2016 us=206193 client/*.*.*.*:53414 UDPv4 WRITE [22] to [AF_INET]*.*.*.*:53414: P_ACK_V1 kid=0 [ 6 ]
Tue May 10 15:24:53 2016 us=206647 client/*.*.*.*:53414 UDPv4 WRITE [114] to [AF_INET]*.*.*.*:53414: P_CONTROL_V1 kid=0 [ ] pid=40 DATA len=100
Tue May 10 15:24:53 2016 us=217214 client/*.*.*.*:53414 UDPv4 WRITE [100] to [AF_INET]*.*.*.*:53414: P_CONTROL_V1 kid=0 [ ] pid=41 DATA len=86
Tue May 10 15:24:53 2016 us=217733 client/*.*.*.*:53414 UDPv4 READ [22] from [AF_INET]*.*.*.*:53414: P_ACK_V1 kid=0 [ 40 ]
Tue May 10 15:24:53 2016 us=221282 client/*.*.*.*:53414 UDPv4 READ [22] from [AF_INET]*.*.*.*:53414: P_ACK_V1 kid=0 [ 41 ]
Tue May 10 15:24:53 2016 us=621467 client/*.*.*.*:53414 NOTE: --mute triggered...
Tue May 10 15:24:53 2016 us=621809 client/*.*.*.*:53414 1 variation(s) on previous 5 message(s) suppressed by --mute
Tue May 10 15:24:53 2016 us=622033 client/*.*.*.*:53414 MULTI: Learn: fa:49:08:eb:7a:6a -&gt; client/*.*.*.*:53414
Tue May 10 15:24:53 2016 us=622940 client/*.*.*.*:53414 UDPv4 READ [229] from [AF_INET]*.*.*.*:53414: P_DATA_V1 kid=0 DATA len=228
Tue May 10 15:24:54 2016 us=644859 client/*.*.*.*:53414 UDPv4 READ [229] from [AF_INET]*.*.*.*:53414: P_DATA_V1 kid=0 DATA len=228
Tue May 10 15:24:54 2016 us=645886 client/*.*.*.*:53414 UDPv4 READ [229] from [AF_INET]*.*.*.*:53414: P_DATA_V1 kid=0 DATA len=228
Tue May 10 15:24:56 2016 us=669770 client/*.*.*.*:53414 UDPv4 READ [229] from [AF_INET]*.*.*.*:53414: P_DATA_V1 kid=0 DATA len=228
Tue May 10 15:24:56 2016 us=670603 client/*.*.*.*:53414 UDPv4 READ [229] from [AF_INET]*.*.*.*:53414: P_DATA_V1 kid=0 DATA len=228
Tue May 10 15:25:03 2016 us=693024 client/*.*.*.*:53414 NOTE: --mute triggered...</code></pre></div><p>Openvpn status</p><div class="codebox"><pre><code>OpenVPN CLIENT LIST
Updated,Tue May 10 15:25:53 2016
Common Name,Real Address,Bytes Received,Bytes Sent,Connected Since
client,*.*.*.*:53414,13478,5507,Tue May 10 15:24:48 2016
ROUTING TABLE
Virtual Address,Common Name,Real Address,Last Ref
fa:49:08:eb:7a:6a,client,*.*.*.*:53414,Tue May 10 15:24:53 2016
GLOBAL STATS
Max bcast/mcast queue length,1
END</code></pre></div><p>Network</p><div class="codebox"><pre><code>config interface &#039;loopback&#039;
        option ifname &#039;lo&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;127.0.0.1&#039;
        option netmask &#039;255.0.0.0&#039;

config globals &#039;globals&#039;
        option ula_prefix &#039;fd00:db80::/48&#039;

config interface &#039;lan&#039;
        option type &#039;bridge&#039;
        option proto &#039;static&#039;
        option netmask &#039;255.255.255.0&#039;
        option ip6assign &#039;60&#039;
        option ipaddr &#039;10.0.0.1&#039;
        option _orig_ifname &#039;eth0.1 wlan0 wlan1&#039;
        option _orig_bridge &#039;true&#039;
        option ifname &#039;eth0.1 tap1&#039;

config interface &#039;wan&#039;
        option proto &#039;dhcp&#039;
        option _orig_ifname &#039;eth0.2&#039;
        option _orig_bridge &#039;false&#039;
        option ifname &#039;eth0.12&#039;
        option peerdns &#039;0&#039;
        option dns &#039;208.67.222.222 208.67.220.220&#039;

config interface &#039;wan6&#039;
        option ifname &#039;@wan&#039;
        option _orig_ifname &#039;@wan&#039;
        option _orig_bridge &#039;false&#039;
        option proto &#039;dhcpv6&#039;
        option reqaddress &#039;try&#039;
        option reqprefix &#039;auto&#039;
        option peerdns &#039;0&#039;
        option dns &#039;2620:0:ccc::2 2620:0:ccd::2&#039;

config switch
        option name &#039;switch0&#039;
        option reset &#039;1&#039;
        option enable_vlan &#039;1&#039;
        option mirror_source_port &#039;0&#039;
        option mirror_monitor_port &#039;0&#039;

config switch_vlan
        option device &#039;switch0&#039;
        option vlan &#039;1&#039;
        option ports &#039;0t 2 3 4 5&#039;
        option vid &#039;1&#039;

config switch_vlan
        option device &#039;switch0&#039;
        option vlan &#039;2&#039;
        option ports &#039;0t 1t&#039;
        option vid &#039;12&#039;

config interface &#039;guest&#039;
        option _orig_ifname &#039;wlan0-1&#039;
        option _orig_bridge &#039;false&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;172.16.0.1&#039;
        option netmask &#039;255.255.255.0&#039;

config interface &#039;vpn&#039;
        option ifname &#039;tap1&#039;
        option _orig_ifname &#039;tap1&#039;
        option _orig_bridge &#039;false&#039;
        option proto &#039;none&#039;</code></pre></div><p>Openvpn client config</p><div class="codebox"><pre><code>client
dev tap
proto udp

remote server.us.to 1194
remote server2.us.to 1194
remote-random

resolv-retry infinite
nobind

persist-key
persist-tun

ca /storage/.config/vpn-config/ca.crt
cert /storage/.config/vpn-config/client.crt
key /storage/.config/vpn-config/client.key
cipher AES-256-CBC
comp-lzo

verb 3</code></pre></div><p>Openvpn client log</p><div class="codebox"><pre><code>Tue May 10 15:51:58 2016 OpenVPN 2.3.9 armv7a-openelec-linux-gnueabi [SSL (OpenSSL)] [LZO] [EPOLL] [IPv6] built on Jan  6 2016
Tue May 10 15:51:58 2016 library versions: LibreSSL 2.1.8, LZO 2.09
Tue May 10 15:51:58 2016 WARNING: No server certificate verification method has been enabled.  See http://openvpn.net/howto.html#mitm for more info.
Tue May 10 15:51:58 2016 WARNING: file &#039;/storage/.config/vpn-config/client.key&#039; is group or others accessible
Tue May 10 15:51:58 2016 Socket Buffers: R=[163840-&gt;163840] S=[163840-&gt;163840]
Tue May 10 15:51:58 2016 UDPv4 link local: [undef]
Tue May 10 15:51:58 2016 UDPv4 link remote: [AF_INET]*.*.*.*:1194
Tue May 10 15:51:59 2016 TLS: Initial packet from [AF_INET]*.*.*.*:1194, sid=b625484e d1c55082
Tue May 10 15:51:59 2016 VERIFY OK: depth=1, C=PT, ST=PRT, L=Porto, O=Cupcakes, OU=OpenVPN, CN=WDR3600, name=OpenVPN, emailAddress=me@cupcakes.tld
Tue May 10 15:51:59 2016 VERIFY OK: depth=0, C=PT, ST=PRT, L=Porto, O=Cupcakes, OU=OpenVPN, CN=WDR3600, name=OpenVPN, emailAddress=me@cupcakes.tld
Tue May 10 15:52:00 2016 Data Channel Encrypt: Cipher &#039;AES-256-CBC&#039; initialized with 256 bit key
Tue May 10 15:52:00 2016 Data Channel Encrypt: Using 160 bit message hash &#039;SHA1&#039; for HMAC authentication
Tue May 10 15:52:00 2016 Data Channel Decrypt: Cipher &#039;AES-256-CBC&#039; initialized with 256 bit key
Tue May 10 15:52:00 2016 Data Channel Decrypt: Using 160 bit message hash &#039;SHA1&#039; for HMAC authentication
Tue May 10 15:52:00 2016 Control Channel: TLSv1, cipher TLSv1/SSLv3 DHE-RSA-AES256-SHA, 2048 bit RSA
Tue May 10 15:52:00 2016 [WDR3600] Peer Connection Initiated with [AF_INET]*.*.*.*:1194
Tue May 10 15:52:03 2016 SENT CONTROL [WDR3600]: &#039;PUSH_REQUEST&#039; (status=1)
Tue May 10 15:52:03 2016 PUSH: Received control message: &#039;PUSH_REPLY,sndbuf 393216,rcvbuf 393216,route-gateway 10.0.0.1,ping 10,ping-restart 120,ifconfig 10.0.0.200 255.255.255.0&#039;
Tue May 10 15:52:03 2016 OPTIONS IMPORT: timers and/or timeouts modified
Tue May 10 15:52:03 2016 OPTIONS IMPORT: --sndbuf/--rcvbuf options modified
Tue May 10 15:52:03 2016 Socket Buffers: R=[163840-&gt;327680] S=[163840-&gt;327680]
Tue May 10 15:52:03 2016 OPTIONS IMPORT: --ifconfig/up options modified
Tue May 10 15:52:03 2016 OPTIONS IMPORT: route-related options modified
Tue May 10 15:52:03 2016 TUN/TAP device tap0 opened
Tue May 10 15:52:03 2016 TUN/TAP TX queue length set to 100
Tue May 10 15:52:03 2016 do_ifconfig, tt-&gt;ipv6=0, tt-&gt;did_ifconfig_ipv6_setup=0
Tue May 10 15:52:03 2016 /sbin/ip link set dev tap0 up mtu 1500
Tue May 10 15:52:03 2016 /sbin/ip addr add dev tap0 10.0.0.200/24 broadcast 10.0.0.255
Tue May 10 15:52:03 2016 Initialization Sequence Completed</code></pre></div><p>nslookup on remote machine to local machine</p><div class="codebox"><pre><code>OpenELEC:~ # nslookup openwrt.lan
Server:    208.67.222.222
Address 1: 208.67.222.222 resolver1.opendns.com

Name:      openwrt.lan
Address 1: 10.0.0.1 openwrt</code></pre></div><p>The tap1 is bridge to the local network, cannot ping remote machine if the tap1 adapter isn&#039;t bridged.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p323441">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						12 May 2016, 00:06					</div>
				</div>
				<div class="post-content content">
					<p>Is there a question here or is this resolved?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p332221">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">MrBW</div>
					<div class="post-datetime">
						20 Jul 2016, 00:53					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>keizo wrote:</cite><blockquote><p>I&#039;ve got it working with the server_bridge using this config:......</p></blockquote></div><p>Why do you put &quot;10.8.0.0&quot; in your VPN firewall rules?<br />I thought both the server VPN interface and the VPN clients would get and IP in the scope <strong>10.0.0.200-10.0.0.220</strong>, as specified by the <strong>option server_bridge &#039;10.0.0.1 255.255.255.0 10.0.0.200 10.0.0.220&#039;</strong></p><p>Or do you have some settings in your DHCP which give this 10.8.0.0. scope?</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>