<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> mmc-over-gpio not working on wrt54gl brcm-47xx</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 30 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p91199">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">bud</div>
					<div class="post-datetime">
						11 Jul 2009, 12:38					</div>
				</div>
				<div class="post-content content">
					<p>card works nicely with recent dd-wrt v24, openwrt 8.09.1 + mmc 1.3.4 but on brcm-47xx I get (debugging enabled in kernel_menuconfig) </p><p>Is mmc over gpio officially broken on broadcom 2.6 ? Did it ever work?&nbsp; ..bud</p><div class="codebox"><pre><code>mmc_spi spi32765.0: ASSUMING 3.2-3.4 V slot power
mmc0: clock 0Hz busmode 0 powermode 0 cs 0 Vdd 0 width 0 timing 0
mmc_spi spi32765.0: SD/MMC host mmc0, no DMA, no WP, no poweroff
gpio-mmc: MMC-Card &quot;default&quot; attached to GPIO pins di=2, do=4, clk=3, cs=7
mmc0: clock 0Hz busmode 2 powermode 1 cs 1 Vdd 21 width 0 timing 0
mmc0: clock 400000Hz busmode 2 powermode 2 cs 1 Vdd 21 width 0 timing 0
mmc_spi spi32765.0: can&#039;t change chip-select polarity
mmc0: starting CMD0 arg 00000000 flags 000000c0
mmc0: req done (CMD0): -51: 00000000 00000000 00000000 00000000
mmc0: starting CMD8 arg 000001aa flags 000002f5
mmc0: req done (CMD8): -51: 00000000 00000000 00000000 00000000
mmc0: starting CMD5 arg 00000000 flags 000002e1
mmc0: req failed (CMD5): -51, retrying...
mmc0: req failed (CMD5): -51, retrying...
mmc0: req failed (CMD5): -51, retrying...
mmc0: req done (CMD5): -51: 00000000 00000000 00000000 00000000
mmc0: starting CMD55 arg 00000000 flags 000000f5
mmc0: req done (CMD55): -51: 00000000 00000000 00000000 00000000
mmc0: starting CMD55 arg 00000000 flags 000000f5
mmc0: req done (CMD55): -51: 00000000 00000000 00000000 00000000
mmc0: starting CMD55 arg 00000000 flags 000000f5
mmc0: req done (CMD55): -51: 00000000 00000000 00000000 00000000
mmc0: starting CMD55 arg 00000000 flags 000000f5
mmc0: req done (CMD55): -51: 00000000 00000000 00000000 00000000
mmc0: starting CMD1 arg 00000000 flags 000000e1
mmc0: req done (CMD1): -51: 00000000 00000000 00000000 00000000
mmc0: clock 0Hz busmode 2 powermode 0 cs 1 Vdd 0 width 0 timing 0</code></pre></div><p>the trac ticket is here<br /><a href="https://dev.openwrt.org/ticket/5489">https://dev.openwrt.org/ticket/5489</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p91200">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Dogge</div>
					<div class="post-datetime">
						11 Jul 2009, 12:47					</div>
				</div>
				<div class="post-content content">
					<p>Read the other threads. It&#039;s broken and noone is interested in fixing it....</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p91212">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">bud</div>
					<div class="post-datetime">
						11 Jul 2009, 14:28					</div>
				</div>
				<div class="post-content content">
					<p>Well I am interested to have it fixed... but you are right I missed some posts, to make it easier I summarize and post link in the mentioned threads to this discussion. the status seems to be:</p><p>mb is still maintaing the driver and it shouldn&#039;t be broken<br /><a href="http://forum.openwrt.org/viewtopic.php?pid=90207#p90207">http://forum.openwrt.org/viewtopic.php?pid=90207#p90207</a></p><p>the b43 driver blocked mmc gpios (supposedly fixed by 06/2009, see ticket)<br /><a href="http://forum.openwrt.org/viewtopic.php?id=19346">http://forum.openwrt.org/viewtopic.php?id=19346</a><br /><a href="http://forum.openwrt.org/viewtopic.php?id=19127">http://forum.openwrt.org/viewtopic.php?id=19127</a><br /><a href="http://forum.openwrt.org/viewtopic.php?id=18203">http://forum.openwrt.org/viewtopic.php?id=18203</a><br /><a href="https://dev.openwrt.org/ticket/4274">https://dev.openwrt.org/ticket/4274</a></p><p>it is working on Buffalo WHR-G54S if kmod-diag is disabled, same problem as above with b43<br /><a href="http://forum.openwrt.org/viewtopic.php?pid=86596#p86596">http://forum.openwrt.org/viewtopic.php?pid=86596#p86596</a></p><p>thread describing problems with mmc over gpio on kernel 2.6<br /><a href="http://forum.openwrt.org/viewtopic.php?id=19084">http://forum.openwrt.org/viewtopic.php?id=19084</a></p><p>I&#039;ll pm mbuesch about this thread.&nbsp; ... bud</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p91214">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">bud</div>
					<div class="post-datetime">
						11 Jul 2009, 14:47					</div>
				</div>
				<div class="post-content content">
					<p>just tried rev16746 without wireless drivers .. the white led stays now off and the dmesg output additionally states a spi poweroff in the end ... bud</p><div class="codebox"><pre><code>gpio-mmc: Failed to request mmc_spi module.
mmc_spi spi32765.0: ASSUMING 3.2-3.4 V slot power
mmc0: clock 0Hz busmode 0 powermode 0 cs 0 Vdd 0 width 0 timing 0
mmc_spi spi32765.0: SD/MMC host mmc0, no DMA, no WP, no poweroff
gpio-mmc: MMC-Card &quot;default&quot; attached to GPIO pins di=2, do=4, clk=3, cs=7
mmc0: clock 0Hz busmode 2 powermode 1 cs 1 Vdd 21 width 0 timing 0
mmc_spi spi32765.0: mmc_spi: power up (21)
mmc0: clock 400000Hz busmode 2 powermode 2 cs 1 Vdd 21 width 0 timing 0
mmc_spi spi32765.0: mmc_spi: power on (21)
mmc_spi spi32765.0: can&#039;t change chip-select polarity
mmc_spi spi32765.0: mmc_spi:  clock to 400000 Hz, 0
mmc0: starting CMD0 arg 00000000 flags 000000c0
mmc_spi spi32765.0:   mmc_spi: CMD0, resp R1
mmc_spi spi32765.0:   ... CMD0 response SPI_R1: INVALID RESPONSE, e0
mmc0: req done (CMD0): -51: 00000000 00000000 00000000 00000000
mmc0: starting CMD8 arg 000001aa flags 000002f5
mmc_spi spi32765.0:   mmc_spi: CMD8, resp R3/R4/R7
mmc_spi spi32765.0:   ... CMD8 response SPI_R3/R4/R: INVALID RESPONSE, e0
mmc0: req done (CMD8): -51: 00000000 00000000 00000000 00000000
mmc0: starting CMD5 arg 00000000 flags 000002e1
mmc_spi spi32765.0:   mmc_spi: CMD5, resp R3/R4/R7
mmc_spi spi32765.0:   ... CMD5 response SPI_R3/R4/R: INVALID RESPONSE, e0
mmc0: req failed (CMD5): -51, retrying...
mmc_spi spi32765.0:   mmc_spi: CMD5, resp R3/R4/R7
mmc_spi spi32765.0:   ... CMD5 response SPI_R3/R4/R: INVALID RESPONSE, e0
mmc0: req failed (CMD5): -51, retrying...
mmc_spi spi32765.0:   mmc_spi: CMD5, resp R3/R4/R7
mmc_spi spi32765.0:   ... CMD5 response SPI_R3/R4/R: INVALID RESPONSE, e0
mmc0: req failed (CMD5): -51, retrying...
mmc_spi spi32765.0:   mmc_spi: CMD5, resp R3/R4/R7
mmc_spi spi32765.0:   ... CMD5 response SPI_R3/R4/R: INVALID RESPONSE, e0
mmc0: req done (CMD5): -51: 00000000 00000000 00000000 00000000
mmc0: starting CMD55 arg 00000000 flags 000000f5
mmc_spi spi32765.0:   mmc_spi: CMD55, resp R1
mmc_spi spi32765.0:   ... CMD55 response SPI_R1: INVALID RESPONSE, e0
mmc0: req done (CMD55): -51: 00000000 00000000 00000000 00000000
mmc0: starting CMD55 arg 00000000 flags 000000f5
mmc_spi spi32765.0:   mmc_spi: CMD55, resp R1
mmc_spi spi32765.0:   ... CMD55 response SPI_R1: INVALID RESPONSE, e0
mmc0: req done (CMD55): -51: 00000000 00000000 00000000 00000000
mmc0: starting CMD55 arg 00000000 flags 000000f5
mmc_spi spi32765.0:   mmc_spi: CMD55, resp R1
mmc_spi spi32765.0:   ... CMD55 response SPI_R1: INVALID RESPONSE, e0
mmc0: req done (CMD55): -51: 00000000 00000000 00000000 00000000
mmc0: starting CMD55 arg 00000000 flags 000000f5
mmc_spi spi32765.0:   mmc_spi: CMD55, resp R1
mmc_spi spi32765.0:   ... CMD55 response SPI_R1: INVALID RESPONSE, e0
mmc0: req done (CMD55): -51: 00000000 00000000 00000000 00000000
mmc0: starting CMD1 arg 00000000 flags 000000e1
mmc_spi spi32765.0:   mmc_spi: CMD1, resp R1
mmc_spi spi32765.0:   ... CMD1 response SPI_R1: INVALID RESPONSE, e0
mmc0: req done (CMD1): -51: 00000000 00000000 00000000 00000000
mmc0: clock 0Hz busmode 2 powermode 0 cs 1 Vdd 0 width 0 timing 0
mmc_spi spi32765.0: mmc_spi: power off (0)</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p91462">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">mbuesch</div>
					<div class="post-datetime">
						16 Jul 2009, 14:35					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Dogge wrote:</cite><blockquote><p>Read the other threads. It&#039;s broken and noone is interested in fixing it....</p></blockquote></div><p>It is NOT broken.<br />Please stop spreading that FUD, people.</p><p>I did test it recently (two or three weeks ago) and it does work PROPERLY, if you correctly set up your configuration.</p><p>Make sure that the GPIO config is correct.<br />Make sure that a GPIO is only used ONCE. (Make sure that other apps/modules do not use the GPIO)</p><p>To say it again. It does work. There&#039;s nothing to fix. Saying that &quot;noone is interested in fixing it&quot; is plain _wrong_ because it does work.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p91463">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">bud</div>
					<div class="post-datetime">
						16 Jul 2009, 15:22					</div>
				</div>
				<div class="post-content content">
					<p>thx michael for answering. Still the gpio&#039;s are fine, it works with kernel 2.4 ...</p><p>I also disabled kmod-diag and disabled wireless modules just for the sake of testing... see 2 posts above .. <br />Does the &#039;mmc_spi spi32765.0:&nbsp; &nbsp;... CMD55 response SPI_R1: INVALID RESPONSE, e0&#039;&nbsp; mean anything to you?</p><p>... bud<br />&#039;</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p91476">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">mbuesch</div>
					<div class="post-datetime">
						16 Jul 2009, 21:34					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bud wrote:</cite><blockquote><p>thx michael for answering. Still the gpio&#039;s are fine, it works with kernel 2.4 ...</p><p>I also disabled kmod-diag and disabled wireless modules just for the sake of testing... see 2 posts above .. <br />Does the &#039;mmc_spi spi32765.0:&nbsp; &nbsp;... CMD55 response SPI_R1: INVALID RESPONSE, e0&#039;&nbsp; mean anything to you?</p><p>... bud<br />&#039;</p></blockquote></div><p>This is not an error from any subsystem that I maintain. It&#039;s an error from the generic mmc-spi subsystem. If you think it&#039;s a bug in that subsystem, please contact its maintainer.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p93708">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">pisorce</div>
					<div class="post-datetime">
						4 Sep 2009, 10:34					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>I confirm also that gpiommc module can&#039;t work correctly if wireless is enabled.<br />If I disabled wireless, and reboot my WRT54GL router, SD Card reader worked fine.</p><p>I had the same problem if diag module installed.<br />I am using kernel 2.6.28</p><p>Here is the following partitions on my SD Card 2Go.<br /> cat /proc/partitions<br />major minor&nbsp; #blocks&nbsp; name</p><p>&nbsp; 31&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 256 mtdblock0<br />&nbsp; 31&nbsp; &nbsp; &nbsp; &nbsp; 1&nbsp; &nbsp; &nbsp; &nbsp;3776 mtdblock1<br />&nbsp; 31&nbsp; &nbsp; &nbsp; &nbsp; 2&nbsp; &nbsp; &nbsp; &nbsp;3009 mtdblock2<br />&nbsp; 31&nbsp; &nbsp; &nbsp; &nbsp; 3&nbsp; &nbsp; &nbsp; &nbsp;1600 mtdblock3<br />&nbsp; 31&nbsp; &nbsp; &nbsp; &nbsp; 4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;64 mtdblock4<br /> 179&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; 1921024 mmcblk0<br /> 179&nbsp; &nbsp; &nbsp; &nbsp; 1&nbsp; &nbsp; &nbsp;501084 mmcblk0p1<br /> 179&nbsp; &nbsp; &nbsp; &nbsp; 2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 mmcblk0p2<br /> 179&nbsp; &nbsp; &nbsp; &nbsp; 5&nbsp; &nbsp; &nbsp;501084 mmcblk0p5<br /> 179&nbsp; &nbsp; &nbsp; &nbsp; 6&nbsp; &nbsp; &nbsp;917104 mmcblk0p6</p><br /><p>Phil</p>											<p class="post-edited">(Last edited by <strong>pisorce</strong> on 4 Sep 2009, 10:37)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p93710">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">pisorce</div>
					<div class="post-datetime">
						4 Sep 2009, 11:12					</div>
				</div>
				<div class="post-content content">
					<p>Phil writes :<br />In the following system log you can see SD Card 2GB is enabled.<br />But When I enable wireless AP, mounted partitions are disabled.</p><p>-------------------------------------------------------------<br />mmc_spi spi32766.0: can&#039;t change chip-select polarity<br />mmc0: host does not support reading read-only switch. assuming write-enable.<br />mmc0: new SD card on SPI<br />mmcblk0: mmc0:0000 SD02G 1.83 GiB<br /> mmcblk0: p1 p2 &lt; p5 p6 &gt;<br />EXT2-fs warning: mounting unchecked fs, running e2fsck is recommended<br />attempt to access beyond end of device<br />mmcblk0p2: rw=0, want=4, limit=2<br />EXT2-fs: unable to read superblock<br />attempt to access beyond end of device<br />mmcblk0p2: rw=0, want=4, limit=2<br />EXT3-fs: unable to read superblock<br />EXT2-fs warning: mounting unchecked fs, running e2fsck is recommended<br />EXT2-fs warning: mounting unchecked fs, running e2fsck is recommended<br />br-lan: port 1(eth0.0) entering disabled state<br />device eth0 left promiscuous mode<br />device eth0.0 left promiscuous mode<br />br-lan: port 1(eth0.0) entering disabled state<br />device eth0.0 entered promiscuous mode<br />device eth0 entered promiscuous mode<br />br-lan: topology change detected, propagating<br />br-lan: port 1(eth0.0) entering forwarding state<br />br-lan: port 1(eth0.0) entering disabled state<br />br-lan: topology change detected, propagating<br />br-lan: port 1(eth0.0) entering forwarding state<br />input: b43-phy0 as /devices/virtual/input/input0<br />b43 ssb0:3: firmware: requesting b43/ucode5.fw<br />b43 ssb0:3: firmware: requesting b43/pcm5.fw<br />b43 ssb0:3: firmware: requesting b43/b0g0initvals5.fw<br />b43 ssb0:3: firmware: requesting b43/b0g0bsinitvals5.fw<br />b43-phy0: Loading firmware version 410.2160 (2007-05-26 15:32:10)<br />Registered led device: b43-phy0::tx<br />Registered led device: b43-phy0::rx<br />Registered led device: b43-phy0::radio<br />b43-phy0: Radio turned on by software<br />device wlan0 entered promiscuous mode<br />wlan0: deauthenticating by local choice (reason=3)<br />br-lan: port 2(wlan0) entering disabled state<br />input: b43-phy0 as /devices/virtual/input/input1<br />b43-phy0: Loading firmware version 410.2160 (2007-05-26 15:32:10)<br />Registered led device: b43-phy0::tx<br />Registered led device: b43-phy0::rx<br />Registered led device: b43-phy0::radio<br />br-lan: topology change detected, propagating<br />br-lan: port 2(wlan0) entering forwarding state<br />mmcblk0: error -145 sending read/write command<br />end_request: I/O error, dev mmcblk0, sector 1092<br />mmcblk0: error -145 sending read/write command<br />end_request: I/O error, dev mmcblk0, sector 1092<br />mmcblk0: error -145 sending read/write command<br />end_request: I/O error, dev mmcblk0, sector 64<br />Buffer I/O error on device mmcblk0p1, logical block 1<br />lost page write due to I/O error on mmcblk0p1<br />EXT2-fs error (device mmcblk0p1): ext2_readdir: bad page in #2<br />root@OpenWrt:~#</p><p>If I disable wireless AP SD Card becomes enabled.<br />See system log </p><p>br-lan: port 2(wlan0) entering disabled state<br />br-lan: port 1(eth0.0) entering disabled state<br />device eth0 left promiscuous mode<br />device wlan0 left promiscuous mode<br />br-lan: port 2(wlan0) entering disabled state<br />device eth0.0 left promiscuous mode<br />br-lan: port 1(eth0.0) entering disabled state<br />device eth0.0 entered promiscuous mode<br />device eth0 entered promiscuous mode<br />br-lan: topology change detected, propagating<br />br-lan: port 1(eth0.0) entering forwarding state<br />device wlan0 entered promiscuous mode<br />br-lan: topology change detected, propagating<br />br-lan: port 2(wlan0) entering forwarding state<br />br-lan: port 2(wlan0) entering disabled state<br />br-lan: port 1(eth0.0) entering disabled state<br />br-lan: topology change detected, propagating<br />br-lan: port 2(wlan0) entering forwarding state<br />br-lan: topology change detected, propagating<br />br-lan: port 1(eth0.0) entering forwarding state<br />br-lan: port 2(wlan0) entering disabled state<br />root@OpenWrt:~# df -k<br />Filesystem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1k-blocks&nbsp; &nbsp; &nbsp; Used Available Use% Mounted on<br />rootfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1408&nbsp; &nbsp; &nbsp; 1408&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 100% /<br />/dev/root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1408&nbsp; &nbsp; &nbsp; 1408&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 100% /rom<br />tmpfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6860&nbsp; &nbsp; &nbsp; 1128&nbsp; &nbsp; &nbsp; 5732&nbsp; 16% /tmp<br />tmpfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 512&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp;512&nbsp; &nbsp;0% /dev<br />/dev/mtdblock3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1600&nbsp; &nbsp; &nbsp; 1328&nbsp; &nbsp; &nbsp; &nbsp;272&nbsp; 83% /jffs<br />mini_fo:/jffs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1408&nbsp; &nbsp; &nbsp; 1408&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 100% /<br />/dev/mmcblk0p1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 485246&nbsp; &nbsp; &nbsp;45246&nbsp; &nbsp; 414946&nbsp; 10% /mnt/mmcblk0p1<br />/dev/mmcblk0p5&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 485246&nbsp; &nbsp; &nbsp; 2318&nbsp; &nbsp; 457874&nbsp; &nbsp;1% /mnt/mmcblk0p5<br />/dev/mmcblk0p6&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 902680&nbsp; &nbsp; &nbsp; &nbsp;904&nbsp; &nbsp; 855924&nbsp; &nbsp;0% /mnt/mmcblk0p6<br />root@OpenWrt:~#</p><p>I didn&#039;t need to reboot my router. SD Card and all partions became available.</p><p>Phil</p>											<p class="post-edited">(Last edited by <strong>pisorce</strong> on 4 Sep 2009, 11:16)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p93724">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">bud</div>
					<div class="post-datetime">
						4 Sep 2009, 17:23					</div>
				</div>
				<div class="post-content content">
					<p>interesting .. never switched on wireless during testing I&#039;ve done</p><p>.. eventually it seemed to be an incompatibility of a no name card (which runs under kernel 2.4 flawlessly) with the mmc driver for kernel 2.6 </p><p>2 newly purchased sandisk cards are working, slowly but at least .. working at all</p><p>I will doublecheck your findings with wlan on my sdmodded wrt54gl </p><p>which gpio&#039;s do you use?</p><p>... bud</p>											<p class="post-edited">(Last edited by <strong>bud</strong> on 7 Sep 2009, 11:30)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94671">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">blubberdiblub</div>
					<div class="post-datetime">
						20 Sep 2009, 08:30					</div>
				</div>
				<div class="post-content content">
					<p>Yes, it&#039;s true, as soon the b43 wireless driver is upped it fiddles with the LEDs/GPIO and effectively inhibits kmod-mmc-over-gpio.</p><p>The kmod-b43 driver puts quite a bunch of GPIO lines under its control in its init, so it&#039;s quite unlikely that you&#039;ll find sufficient GPIO pins unaffected by it to get it to successfully drive your SD/MMC. I&#039;m using pins 2, 3, 4 and 7 here on my WRT54GL.</p><p>So what I am doing is taking the current trunk and patching the b43 to stop controlling any GPIO pins except #0 and #1 (Power and WLAN LEDs), which don&#039;t affect my card. This works fine and I can use wireless and my card simultaneously.</p><p>But there are still other minor and major issues.</p><p>One of them is being unable to access the last 8 * 512byte blocks (the last 4k page) of my card. Trying to do so (reading or writing) renders the card unusable for all following accesses until I disable/reenable the card (or reboot).</p><p>The other one is being unable to reliably execute programs directly from the card. It&#039;s not about data integrity, which is fine and easily verified by diffing (with a diff executable not located on the card *g*). Since i&#039;m not really into how things work in the linux kernel, let alone executing stuff, I can only guess. Maybe it&#039;s got something to do with mmaps not working properly? Since I get all kind of strange errors from bus errors to segfaults and which usually go away when trying to execute the program a second time or so (maybe due to the text being served from the buffer cache).</p><p>Unfortunately I don&#039;t understand this whole mmc infrastructure and neither do I understand what causes the problems in connection with program execution, so I was unable to hunt down the problems any further.</p><br /><p>Regards,<br />Niels Böhm</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p111038">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">naplam</div>
					<div class="post-datetime">
						11 Jun 2010, 21:30					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>blubberdiblub wrote:</cite><blockquote><p>Yes, it&#039;s true, as soon the b43 wireless driver is upped it fiddles with the LEDs/GPIO and effectively inhibits kmod-mmc-over-gpio.</p><p>The kmod-b43 driver puts quite a bunch of GPIO lines under its control in its init, so it&#039;s quite unlikely that you&#039;ll find sufficient GPIO pins unaffected by it to get it to successfully drive your SD/MMC. I&#039;m using pins 2, 3, 4 and 7 here on my WRT54GL.</p><p>So what I am doing is taking the current trunk and patching the b43 to stop controlling any GPIO pins except #0 and #1 (Power and WLAN LEDs), which don&#039;t affect my card. This works fine and I can use wireless and my card simultaneously.</p></blockquote></div><p>Nice, could you post the patch? maybe they could make a patched b43 package to download from the openwrt repository too.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p111391">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">naplam</div>
					<div class="post-datetime">
						17 Jun 2010, 18:23					</div>
				</div>
				<div class="post-content content">
					<p>ok i did it, we just need to apply this diff reversed: <a href="https://dev.openwrt.org/attachment/ticket/4274/main.c.diff">https://dev.openwrt.org/attachment/tick … ain.c.diff</a><br />so, we need 0x1 instead of 0xF in these 2 places changed</p><p>I had trouble with the compiled module b43, i tried pretty much every combination except trunk (backfire tag, backfire branch, just b43, all of mac80211 recompiled, backfire tag hostapd, branch hostapd), and they always crashed b43 or hostapd. Go figure... SO, what i did was patch the binary module (i disassembled it and patched the two 0F-&gt;01). If you want to do it yourselves on backfire 10.03 b43.ko, offset 5150: 0F-&gt;01 and offet 5A6C: 0F-&gt;01. Just these 2 bytes and i finally could use mmc and b43 at the same time without any problem whatsoever.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p111781">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">elvisrv</div>
					<div class="post-datetime">
						23 Jun 2010, 11:11					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>naplam wrote:</cite><blockquote><p>ok i did it, we just need to apply this diff reversed: <a href="https://dev.openwrt.org/attachment/ticket/4274/main.c.diff">https://dev.openwrt.org/attachment/tick … ain.c.diff</a><br />so, we need 0x1 instead of 0xF in these 2 places changed</p><p>I had trouble with the compiled module b43, i tried pretty much every combination except trunk (backfire tag, backfire branch, just b43, all of mac80211 recompiled, backfire tag hostapd, branch hostapd), and they always crashed b43 or hostapd. Go figure... SO, what i did was patch the binary module (i disassembled it and patched the two 0F-&gt;01). If you want to do it yourselves on backfire 10.03 b43.ko, offset 5150: 0F-&gt;01 and offet 5A6C: 0F-&gt;01. Just these 2 bytes and i finally could use mmc and b43 at the same time without any problem whatsoever.</p></blockquote></div><p>Hi naplam,<br />Can you explain how you do this? Thanks in advice. I</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p111783">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">naplam</div>
					<div class="post-datetime">
						23 Jun 2010, 12:52					</div>
				</div>
				<div class="post-content content">
					<p>hmm.. what exactly? edit a file with a hex editor?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p111801">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">elvisrv</div>
					<div class="post-datetime">
						23 Jun 2010, 18:01					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>naplam wrote:</cite><blockquote><p>hmm.. what exactly? edit a file with a hex editor?</p></blockquote></div><p>The problem is i can&#039;t find the file. Do i have to build it and then compile it? please tell me where to find it. Im using backfire kernel 2.6.32.10 #20</p><p>gpio-mmc: Failed to request mmc_spi module.<br />mmc_spi spi32766.0: ASSUMING 3.2-3.4 V slot power<br />mmc_spi spi32766.0: SD/MMC host mmc0, no DMA, no WP, no poweroff<br />gpio-mmc: MMC-Card &quot;mmc&quot; attached to GPIO pins di=2, do=4, clk=3, cs=7<br />mmc_spi spi32766.0: can&#039;t change chip-select polarity</p><p>I get this when wifi activated as discussed before</p>											<p class="post-edited">(Last edited by <strong>elvisrv</strong> on 23 Jun 2010, 18:02)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p111805">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">naplam</div>
					<div class="post-datetime">
						23 Jun 2010, 18:55					</div>
				</div>
				<div class="post-content content">
					<p>make sure it works with wifi down.<br /> b43.ko is in the directory where all kernel modules are: /lib/modules/[kernel version]</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p111811">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">elvisrv</div>
					<div class="post-datetime">
						23 Jun 2010, 20:46					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>naplam wrote:</cite><blockquote><p>make sure it works with wifi down.<br /> b43.ko is in the directory where all kernel modules are: /lib/modules/[kernel version]</p></blockquote></div><p>Yes, If i disable wifi it works perfect. No luck when i activated so far. I already found the b43.ko So i opened b43.ko in ghex2 but, i still dont get it. where am i supposed to change the bites? Sorry to ask alot? i&#039;m new to openwrt.</p><p>Thanks in advice</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p111816">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">elvisrv</div>
					<div class="post-datetime">
						23 Jun 2010, 22:33					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>elvisrv wrote:</cite><blockquote><div class="quotebox"><cite>naplam wrote:</cite><blockquote><p>make sure it works with wifi down.<br /> b43.ko is in the directory where all kernel modules are: /lib/modules/[kernel version]</p></blockquote></div><p>Yes, If i disable wifi it works perfect. No luck when i activated so far. I already found the b43.ko So i opened b43.ko in ghex2 but, i still dont get it. where am i supposed to change the bites? Sorry to ask alot? i&#039;m new to openwrt.</p><p>Thanks in advice</p></blockquote></div><p>Hi,<br />My offset 5150 was: 21 and 5A6C: 0F, although I changed them. Now i have offset 5150: 01 and offset 5A6C: 01<br />I get these errors</p><p>gpio-mmc: GPIO based MMC-Card &quot;mmc&quot; removed<br />gpio-mmc: Failed to request mmc_spi module.<br />mmc_spi spi32765.0: ASSUMING 3.2-3.4 V slot power<br />mmc_spi spi32765.0: SD/MMC host mmc0, no DMA, no WP, no poweroff<br />gpio-mmc: MMC-Card &quot;mmc&quot; attached to GPIO pins di=2, do=4, clk=3, cs=7<br />mmc_spi spi32765.0: can&#039;t change chip-select polarity<br />mmc0: card claims to support voltages below the defined range. These will be ignored.<br />mmc0: unrecognised CSD structure version 0<br />mmc0: error -22 whilst initialising MMC card</p><p>Can you send me your b43.ko to simplify things? elvisrv@gmail.com<br />Thanks in advice</p>											<p class="post-edited">(Last edited by <strong>elvisrv</strong> on 24 Jun 2010, 19:21)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123728">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">efanatic</div>
					<div class="post-datetime">
						22 Dec 2010, 19:19					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>naplam wrote:</cite><blockquote><p>ok i did it, we just need to apply this diff reversed: <a href="https://dev.openwrt.org/attachment/ticket/4274/main.c.diff">https://dev.openwrt.org/attachment/tick … ain.c.diff</a><br />so, we need 0x1 instead of 0xF in these 2 places changed</p><p>I had trouble with the compiled module b43, i tried pretty much every combination except trunk (backfire tag, backfire branch, just b43, all of mac80211 recompiled, backfire tag hostapd, branch hostapd), and they always crashed b43 or hostapd. Go figure... SO, what i did was patch the binary module (i disassembled it and patched the two 0F-&gt;01). If you want to do it yourselves on backfire 10.03 b43.ko, offset 5150: 0F-&gt;01 and offet 5A6C: 0F-&gt;01. Just these 2 bytes and i finally could use mmc and b43 at the same time without any problem whatsoever.</p></blockquote></div><p>Naplam,<br />I am using backfire-10.03.1-rc4 on a WRT54G (v3.1). The offsets 5150 &amp; 5A6C did not have the values you mentioned, I still went ahead and changed them to 01 but the router crashed on bootup. It was quite obvious since the source file might have changed from the version you used and the one I am using. Anyway, I could not find the actual b43 source file. It would be a great help if you pointed out the location of the b43 source file (in backfire) and explain in brief as to how I can compile this file alone to get the b43.ko file.</p><p>I have a doubt, how is b43.ko different from b43legacy.ko?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123778">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">nancy3412</div>
					<div class="post-datetime">
						23 Dec 2010, 09:46					</div>
				</div>
				<div class="post-content content">
					<p>good</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p123833">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">tsod</div>
					<div class="post-datetime">
						24 Dec 2010, 01:20					</div>
				</div>
				<div class="post-content content">
					<p>in 10.03.1-rc4 edit /etc/modules.d/30-b43 and replace &#039;b43&#039; with &#039;b43 gpiomask=0x1&#039; to disable the usage of gpios by b43</p><p>i still get the gpio-mmc warnings.. but at least i am able to mount the sd-card this way with wireless active</p>											<p class="post-edited">(Last edited by <strong>tsod</strong> on 24 Dec 2010, 01:28)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p125775">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">SlashV</div>
					<div class="post-datetime">
						18 Jan 2011, 03:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>blubberdiblub wrote:</cite><blockquote><p>...<br />The other one is being unable to reliably execute programs directly from the card. It&#039;s not about data integrity, which is fine and easily verified by diffing (with a diff executable not located on the card *g*). Since i&#039;m not really into how things work in the linux kernel, let alone executing stuff, I can only guess. Maybe it&#039;s got something to do with mmaps not working properly? Since I get all kind of strange errors from bus errors to segfaults and which usually go away when trying to execute the program a second time or so (maybe due to the text being served from the buffer cache).<br />...</p></blockquote></div><p>Looks like this is still in issue (backfire 24999 built from source)</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>