<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Replacement firewall scripts to use for tinc VPN &amp; OSPF routing</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 30 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p78615">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">mpadams</div>
					<div class="post-datetime">
						25 Dec 2008, 01:43					</div>
				</div>
				<div class="post-content content">
					<p>The newer UCI firewall doesn&#039;t seem to support protocols, and the original firewall scripts have an apparent bug wherein they flush the rules in firewall.user after running rules from the init script. Here are corrected scripts based on what I&#039;m using with my work routers.</p><p>----- WHITE RUSSIAN /etc/init.d/S35firewall -----<br />#!/bin/sh</p><p>## Please make changes in /etc/firewall.user<br />## Modified 12-24-2008 by madams@ezrac.com w/new flush rules</p><p>. /etc/functions.sh<br />WAN=&quot;$(nvram get wan_ifname)&quot;<br />WANDEV=&quot;$(nvram get wan_device)&quot;<br />LAN=&quot;$(nvram get lan_ifname)&quot;</p><p>## CLEAR TABLES<br />iptables -F input_rule<br />iptables -F output_rule<br />iptables -F forwarding_rule<br />iptables -F input_wan<br />iptables -F forwarding_wan<br />for T in filter nat; do<br />&nbsp; iptables -t $T -F<br />&nbsp; iptables -t $T -X<br />done</p><p>## NEW RULES<br />iptables -N input_rule<br />iptables -N input_wan<br />iptables -N output_rule<br />iptables -N forwarding_rule<br />iptables -N forwarding_wan</p><p>## NEW NAT RULES<br />iptables -t nat -N NEW<br />iptables -t nat -N prerouting_wan<br />iptables -t nat -N prerouting_rule<br />iptables -t nat -N postrouting_rule</p><p>## Promiscious LAN access<br />iptables -N LAN_ACCEPT<br />[ -z &quot;$WAN&quot; ] || iptables -A LAN_ACCEPT -i &quot;$WAN&quot; -j RETURN<br />[ -z &quot;$WANDEV&quot; -o &quot;$WANDEV&quot; = &quot;$WAN&quot; ] || iptables -A LAN_ACCEPT -i &quot;$WANDEV&quot; -j RETURN<br />iptables -A LAN_ACCEPT -j ACCEPT</p><p>### INPUT<br />###&nbsp; (connections with the router as destination)</p><p>&nbsp; # base case<br />&nbsp; iptables -P INPUT DROP<br />&nbsp; iptables -A INPUT -m state --state INVALID -j DROP<br />&nbsp; iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT<br />&nbsp; iptables -A INPUT -p tcp --tcp-flags SYN SYN --tcp-option \! 2 -j&nbsp; DROP</p><p>&nbsp; #<br />&nbsp; # insert accept rule or to jump to new accept-check table here<br />&nbsp; #<br />&nbsp; iptables -A INPUT -j input_rule<br />&nbsp; iptables -A INPUT -i $WAN -j input_wan</p><p>&nbsp; # allow<br />&nbsp; iptables -A INPUT -j LAN_ACCEPT&nbsp; &nbsp; &nbsp; &nbsp;# allow from lan/wifi interfaces<br />&nbsp; iptables -A INPUT -p icmp&nbsp; &nbsp; &nbsp;-j ACCEPT&nbsp; &nbsp; &nbsp; &nbsp;# allow ICMP<br />&nbsp; iptables -A INPUT -p gre&nbsp; &nbsp; &nbsp; -j ACCEPT&nbsp; &nbsp; &nbsp; &nbsp;# allow GRE</p><p>&nbsp; # reject (what to do with anything not allowed earlier)<br />&nbsp; iptables -A INPUT -p tcp -j REJECT --reject-with tcp-reset<br />&nbsp; iptables -A INPUT -j REJECT --reject-with icmp-port-unreachable</p><p>### OUTPUT<br />### (connections with the router as source)</p><p>&nbsp; # base case<br />&nbsp; iptables -P OUTPUT DROP<br />&nbsp; iptables -A OUTPUT -m state --state INVALID -j DROP<br />&nbsp; iptables -A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</p><p>&nbsp; #<br />&nbsp; # insert accept rule or to jump to new accept-check table here<br />&nbsp; #<br />&nbsp; iptables -A OUTPUT -j output_rule</p><p>&nbsp; # allow<br />&nbsp; iptables -A OUTPUT -j ACCEPT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #allow everything out</p><p>&nbsp; # reject (what to do with anything not allowed earlier)<br />&nbsp; iptables -A OUTPUT -p tcp -j REJECT --reject-with tcp-reset<br />&nbsp; iptables -A OUTPUT -j REJECT --reject-with icmp-port-unreachable</p><p>### FORWARDING<br />### (connections routed through the router)</p><p>&nbsp; # base case<br />&nbsp; iptables -P FORWARD DROP<br />&nbsp; iptables -A FORWARD -m state --state INVALID -j DROP<br />&nbsp; iptables -A FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu<br />&nbsp; iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT</p><p>&nbsp; #<br />&nbsp; # insert accept rule or to jump to new accept-check table here<br />&nbsp; #<br />&nbsp; iptables -A FORWARD -j forwarding_rule<br />&nbsp; iptables -A FORWARD -i $WAN -j forwarding_wan</p><p>&nbsp; # allow<br />&nbsp; iptables -A FORWARD -i $LAN -o $LAN -j ACCEPT<br />&nbsp; iptables -A FORWARD -i $LAN -o $WAN -j ACCEPT</p><p>&nbsp; # reject (what to do with anything not allowed earlier)<br />&nbsp; # uses the default -P DROP</p><p>### MASQ<br />&nbsp; iptables -t nat -A PREROUTING -m state --state NEW -j NEW<br />&nbsp; iptables -t nat -A PREROUTING -j prerouting_rule<br />&nbsp; iptables -t nat -A PREROUTING -i $WAN -j prerouting_wan</p><p>&nbsp; iptables -t nat -A POSTROUTING -j postrouting_rule<br />&nbsp; iptables -t nat -A POSTROUTING -o $WAN -j MASQUERADE</p><p>&nbsp; iptables -t nat -A NEW -m limit --limit 50 --limit-burst 100 -j RETURN &amp;&amp; \<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -t nat -A NEW -j DROP</p><p>## USER RULES<br />[ -f /etc/firewall.user ] &amp;&amp; . /etc/firewall.user<br />[ -e /etc/config/firewall ] &amp;&amp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; awk -f /usr/lib/common.awk -f /usr/lib/firewall.awk /etc/config/firewall | ash<br />}</p><p>----- KAMIKAZE /etc/init.d/firewall -----<br />#!/bin/sh /etc/rc.common<br /># Copyright (C) 2006 OpenWrt.org<br /># Modified 12-24-2008 by madams@ezrac.com</p><p>## Please make changes in /etc/firewall.user<br />START=45<br />start() {<br />&nbsp; &nbsp; &nbsp; &nbsp; include /lib/network<br />&nbsp; &nbsp; &nbsp; &nbsp; scan_interfaces<br />&nbsp; &nbsp; &nbsp; &nbsp; config_load /var/state/network</p><p>&nbsp; &nbsp; &nbsp; &nbsp; config_get WAN wan ifname<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get WANDEV wan device<br />&nbsp; &nbsp; &nbsp; &nbsp; config_get LAN lan ifname</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ## CLEAR TABLES<br />&nbsp; &nbsp; iptables -F input_rule<br />&nbsp; &nbsp; iptables -F output_rule<br />&nbsp; &nbsp; iptables -F forwarding_rule<br />&nbsp; &nbsp; iptables -F input_wan<br />&nbsp; &nbsp; iptables -F forwarding_wan<br />&nbsp; &nbsp; &nbsp; &nbsp; for T in filter nat; do<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; iptables -t $T -F<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; iptables -t $T -X<br />&nbsp; &nbsp; &nbsp; &nbsp; done</p><p>&nbsp; &nbsp; &nbsp; &nbsp; iptables -N input_rule<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -N input_wan<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -N output_rule<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -N forwarding_rule<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -N forwarding_wan</p><p>&nbsp; &nbsp; &nbsp; &nbsp; iptables -t nat -N NEW<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -t nat -N prerouting_rule<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -t nat -N prerouting_wan<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -t nat -N postrouting_rule</p><p>&nbsp; &nbsp; &nbsp; &nbsp; iptables -N LAN_ACCEPT<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -z &quot;$WAN&quot; ] || iptables -A LAN_ACCEPT -i &quot;$WAN&quot; -j RETURN<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -z &quot;$WANDEV&quot; -o &quot;$WANDEV&quot; = &quot;$WAN&quot; ] || iptables -A LAN_ACCEPT -i &quot;$WANDEV&quot; -j RETURN<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A LAN_ACCEPT -j ACCEPT</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ### INPUT<br />&nbsp; &nbsp; &nbsp; &nbsp; ###&nbsp; (connections with the router as destination)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; # base case<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -P INPUT DROP<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A INPUT -m state --state INVALID -j DROP<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A INPUT -p tcp --tcp-flags SYN SYN --tcp-option \! 2 -j&nbsp; DROP</p><p>&nbsp; &nbsp; &nbsp; &nbsp; #<br />&nbsp; &nbsp; &nbsp; &nbsp; # insert accept rule or to jump to new accept-check table here<br />&nbsp; &nbsp; &nbsp; &nbsp; #<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A INPUT -j input_rule<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -z &quot;$WAN&quot; ] || iptables -A INPUT -i $WAN -j input_wan</p><p>&nbsp; &nbsp; &nbsp; &nbsp; # allow<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A INPUT -j LAN_ACCEPT # allow from lan/wifi interfaces<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A INPUT -p icmp&nbsp; &nbsp; &nbsp; &nbsp;-j ACCEPT&nbsp; &nbsp; &nbsp; &nbsp;# allow ICMP<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A INPUT -p gre&nbsp; &nbsp; &nbsp; &nbsp; -j ACCEPT&nbsp; &nbsp; &nbsp; &nbsp;# allow GRE</p><p>&nbsp; &nbsp; &nbsp; &nbsp; # reject (what to do with anything not allowed earlier)<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A INPUT -p tcp -j REJECT --reject-with tcp-reset<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A INPUT -j REJECT --reject-with icmp-port-unreachable</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ### OUTPUT<br />&nbsp; &nbsp; &nbsp; &nbsp; ### (connections with the router as source)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; # base case<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -P OUTPUT DROP<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A OUTPUT -m state --state INVALID -j DROP<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</p><p>&nbsp; &nbsp; &nbsp; &nbsp; #<br />&nbsp; &nbsp; &nbsp; &nbsp; # insert accept rule or to jump to new accept-check table here<br />&nbsp; &nbsp; &nbsp; &nbsp; #<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A OUTPUT -j output_rule</p><p>&nbsp; &nbsp; &nbsp; &nbsp; # allow<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A OUTPUT -j ACCEPT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #allow everything out</p><p>&nbsp; &nbsp; &nbsp; &nbsp; # reject (what to do with anything not allowed earlier)<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A OUTPUT -p tcp -j REJECT --reject-with tcp-reset<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A OUTPUT -j REJECT --reject-with icmp-port-unreachable</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ### FORWARDING<br />&nbsp; &nbsp; &nbsp; &nbsp; ### (connections routed through the router)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; # base case<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -P FORWARD DROP<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A FORWARD -m state --state INVALID -j DROP<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT</p><p>&nbsp; &nbsp; &nbsp; &nbsp; #<br />&nbsp; &nbsp; &nbsp; &nbsp; # insert accept rule or to jump to new accept-check table here<br />&nbsp; &nbsp; &nbsp; &nbsp; #<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A FORWARD -j forwarding_rule<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -z &quot;$WAN&quot; ] || iptables -A FORWARD -i $WAN -j forwarding_wan</p><p>&nbsp; &nbsp; &nbsp; &nbsp; # allow<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -A FORWARD -i $LAN -o $LAN -j ACCEPT<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -z &quot;$WAN&quot; ] || iptables -A FORWARD -i $LAN -o $WAN -j ACCEPT</p><p>&nbsp; &nbsp; &nbsp; &nbsp; # reject (what to do with anything not allowed earlier)<br />&nbsp; &nbsp; &nbsp; &nbsp; # uses the default -P DROP</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ### MASQ<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -t nat -A PREROUTING -m state --state NEW -p tcp -j NEW<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -t nat -A PREROUTING -j prerouting_rule<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -z &quot;$WAN&quot; ] || iptables -t nat -A PREROUTING -i &quot;$WAN&quot; -j prerouting_wan<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -t nat -A POSTROUTING -j postrouting_rule<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -z &quot;$WAN&quot; ] || iptables -t nat -A POSTROUTING -o $WAN -j MASQUERADE</p><p>&nbsp; &nbsp; &nbsp; &nbsp; iptables -t nat -A NEW -m limit --limit 50 --limit-burst 100 -j RETURN &amp;&amp; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; iptables -t nat -A NEW -j DROP</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ## USER RULES<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -f /etc/firewall.user ] &amp;&amp; . /etc/firewall.user<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -n &quot;$WAN&quot; -a -e /etc/config/firewall ] &amp;&amp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; export WAN<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; awk -f /usr/lib/common.awk -f /usr/lib/firewall.awk /etc/config/firewall | ash<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />}</p><p>stop() {<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -P INPUT ACCEPT<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -P OUTPUT ACCEPT<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -P FORWARD ACCEPT<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -F<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -X<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -t nat -P PREROUTING ACCEPT<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -t nat -P POSTROUTING ACCEPT<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -t nat -P OUTPUT ACCEPT<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -t nat -F<br />&nbsp; &nbsp; &nbsp; &nbsp; iptables -t nat -X<br />}</p><p>----- /etc/firewall.user -----<br />#!/bin/sh<br /># Copyright (C) 2006 OpenWrt.org<br /># Modified 12-24-2008 by madams@ezrac.com</p><p>#Open web and SSH ports<br />iptables -t nat -A prerouting_wan -p tcp --dport 22 -j ACCEPT<br />iptables&nbsp; &nbsp; &nbsp; &nbsp; -A input_wan&nbsp; &nbsp; &nbsp; -p tcp --dport 22 -j ACCEPT<br />iptables -t nat -A prerouting_wan -p tcp --dport 80 -j ACCEPT<br />iptables&nbsp; &nbsp; &nbsp; &nbsp; -A input_wan&nbsp; &nbsp; &nbsp; -p tcp --dport 80 -j ACCEPT</p><p>#Allow OSPF<br />iptables -A input_rule --protocol 89 -j ACCEPT<br />iptables -A OUTPUT --protocol 89 -j ACCEPT<br />iptables -A FORWARD --protocol 89 -j ACCEPT</p><p>#Access to tinc on router<br />iptables -A input_rule -p tcp --dport 655 -j ACCEPT<br />iptables -A OUTPUT -p tcp --dport 655 -j ACCEPT<br />iptables -A input_rule -p udp --dport 655 -j ACCEPT<br />iptables -A OUTPUT -p udp --dport 655 -j ACCEPT</p><p>-----</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>