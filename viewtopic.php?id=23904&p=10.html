<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Multi-WAN Load Balancing</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 29 Mar 2018 and 3 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 10 of 14</div><nav><ul><li><a href="viewtopic.php%3Fid=23904&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=8.html">8</a></li><li><a href="viewtopic.php%3Fid=23904&amp;p=9.html">9</a></li><li class="pagination-current"><span>10</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=11.html">11</a></li><li><a href="viewtopic.php%3Fid=23904&amp;p=12.html">12</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=14.html">14</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p117800">
				<div class="post-metadata">
					<div class="post-num">Post #226</div>
					<div class="post-author">renoir</div>
					<div class="post-datetime">
						24 Sep 2010, 19:42					</div>
				</div>
				<div class="post-content content">
					<p>Health pings remain at 1 Hz...</p><p>However, I stumbled over a serious issue. As mentioned before, I run an asterisk server on the same device as the multiwan script. From time to time, asterisk forwards the public IP address of the failover link to the sip providers while registering, when the main link is still up... Some time later, it reverts back to the main link&#039;s IP address. Obviously, asterisk shouldn&#039;t know anything about the failover link when the main link is still up, as load balancing is not activated in my conf. If this happens during an active call, the call isn&#039;t dropped, but the callee can no longer hear me while I still hear him. I should point out that this only happens while registering at the sip provider.</p><p>This behavior is completely random, it happens quite frequently but I have not been able to find what triggers this behavior. However, disabling the multiwan script resolves the issue.</p><p>Greetings.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p117842">
				<div class="post-metadata">
					<div class="post-num">Post #227</div>
					<div class="post-author">mynetmemo</div>
					<div class="post-datetime">
						25 Sep 2010, 12:45					</div>
				</div>
				<div class="post-content content">
					<p>Hi friends,</p><p>Yesterday I purchased a Dlink dir-825 rev B1 router that I immediatly flashed with openwrt Backfire (10.03.1-rc3, r22796).<br />Each internet connector is connected to the ISP router statically.</p><p>That took me some hour to configure the switch (/etc/config/network) and so I share my little work ;-)</p><p>1 Wan is connected to Internet connector (free.fr)<br />1 Wan is connected to switch connector 4 (orange.fr)<br />1 Lan is connected to switch connector 1</p><p>/etc/config/network</p><p>config &#039;interface&#039; &#039;loopback&#039;<br />&nbsp; &nbsp; option &#039;ifname&#039; &#039;lo&#039;<br />&nbsp; &nbsp; option &#039;proto&#039; &#039;static&#039;<br />&nbsp; &nbsp; option &#039;ipaddr&#039; &#039;127.0.0.1&#039;<br />&nbsp; &nbsp; option &#039;netmask&#039; &#039;255.0.0.0&#039;</p><p>config &#039;interface&#039; &#039;lan1&#039;<br />&nbsp; &nbsp; option &#039;ifname&#039; &#039;eth0.1&#039;<br />&nbsp; &nbsp; option &#039;type&#039; &#039;bridge&#039;<br />&nbsp; &nbsp; option &#039;proto&#039; &#039;static&#039;<br />&nbsp; &nbsp; option &#039;ipaddr&#039; &#039;192.168.181.10&#039;<br />&nbsp; &nbsp; option &#039;netmask&#039; &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; option &#039;defaultroute&#039; &#039;0&#039;<br />&nbsp; &nbsp; option &#039;peerdns&#039; &#039;0&#039;</p><p>config &#039;interface&#039; &#039;lan2&#039;<br />&nbsp; &nbsp; option &#039;ifname&#039; &#039;eth0.2&#039;<br />&nbsp; &nbsp; option &#039;type&#039; &#039;bridge&#039;<br />&nbsp; &nbsp; option &#039;proto&#039; &#039;static&#039;<br />&nbsp; &nbsp; option &#039;ipaddr&#039; &#039;192.168.2.1&#039;<br />&nbsp; &nbsp; option &#039;netmask&#039; &#039;255.255.255.0&#039;</p><p>config &#039;interface&#039; &#039;lan3&#039;<br />&nbsp; &nbsp; option &#039;ifname&#039; &#039;eth0.3&#039;<br />&nbsp; &nbsp; option &#039;type&#039; &#039;bridge&#039;<br />&nbsp; &nbsp; option &#039;proto&#039; &#039;static&#039;<br />&nbsp; &nbsp; option &#039;ipaddr&#039; &#039;192.168.3.1&#039;<br />&nbsp; &nbsp; option &#039;netmask&#039; &#039;255.255.255.0&#039;</p><p>config &#039;interface&#039; &#039;lan4&#039;<br />&nbsp; &nbsp; option &#039;ifname&#039; &#039;eth0.4&#039;<br />&nbsp; &nbsp; option &#039;type&#039; &#039;bridge&#039;<br />&nbsp; &nbsp; option &#039;proto&#039; &#039;static&#039;<br />&nbsp; &nbsp; option &#039;ipaddr&#039; &#039;192.168.120.10&#039;<br />&nbsp; &nbsp; option &#039;netmask&#039; &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; option &#039;gateway&#039; &#039;192.168.120.254&#039;<br />&nbsp; &nbsp; option &#039;defaultroute&#039; &#039;0&#039;<br />&nbsp; &nbsp; option &#039;peerdns&#039; &#039;0&#039;<br />&nbsp; &nbsp; option &#039;dns&#039; &#039;208.67.222.222 208.67.220.220&#039;<br />&nbsp; &nbsp; option &#039;macaddr&#039; &#039;00:24:01:E7:7F:F9&#039;</p><p>config &#039;interface&#039; &#039;wan&#039;<br />&nbsp; &nbsp; option &#039;ifname&#039; &#039;eth1&#039;<br />&nbsp; &nbsp; option &#039;proto&#039; &#039;static&#039;<br />&nbsp; &nbsp; option &#039;ipaddr&#039; &#039;192.168.100.10&#039;<br />&nbsp; &nbsp; option &#039;netmask&#039; &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; option &#039;gateway&#039; &#039;192.168.100.254&#039;<br />&nbsp; &nbsp; option &#039;defaultroute&#039; &#039;0&#039;<br />&nbsp; &nbsp; option &#039;peerdns&#039; &#039;0&#039;<br />&nbsp; &nbsp; option &#039;dns&#039; &#039;208.67.222.222 208.67.220.220&#039;<br />&nbsp; &nbsp; option &#039;mtu&#039; &#039;1492&#039;</p><p>config &#039;switch&#039;<br />&nbsp; &nbsp; option &#039;name&#039; &#039;rtl8366s&#039;<br />&nbsp; &nbsp; option &#039;reset&#039; &#039;1&#039;<br />&nbsp; &nbsp; option &#039;enable_vlan&#039; &#039;1&#039;</p><p>config &#039;switch_vlan&#039;<br />&nbsp; &nbsp; option &#039;device&#039; &#039;rtl8366s&#039;<br />&nbsp; &nbsp; option &#039;vlan&#039; &#039;5&#039;<br />&nbsp; &nbsp; option &#039;pvid&#039; &#039;5&#039;<br />&nbsp; &nbsp; option &#039;ports&#039; &#039;5t&#039;</p><p>config &#039;switch_vlan&#039;<br />&nbsp; &nbsp; option &#039;device&#039; &#039;rtl8366s&#039;<br />&nbsp; &nbsp; option &#039;vlan&#039; &#039;1&#039;<br />&nbsp; &nbsp; option &#039;pvid&#039; &#039;1&#039;<br />&nbsp; &nbsp; option &#039;ports&#039; &#039;3 5t&#039;</p><p>config &#039;switch_vlan&#039;<br />&nbsp; &nbsp; option &#039;device&#039; &#039;rtl8366s&#039;<br />&nbsp; &nbsp; option &#039;vlan&#039; &#039;2&#039;<br />&nbsp; &nbsp; option &#039;pvid&#039; &#039;2&#039;<br />&nbsp; &nbsp; option &#039;ports&#039; &#039;2 5t&#039;</p><p>config &#039;switch_vlan&#039;<br />&nbsp; &nbsp; option &#039;device&#039; &#039;rtl8366s&#039;<br />&nbsp; &nbsp; option &#039;vlan&#039; &#039;3&#039;<br />&nbsp; &nbsp; option &#039;pvid&#039; &#039;3&#039;<br />&nbsp; &nbsp; option &#039;ports&#039; &#039;1 5t&#039;</p><p>config &#039;switch_vlan&#039;<br />&nbsp; &nbsp; option &#039;device&#039; &#039;rtl8366s&#039;<br />&nbsp; &nbsp; option &#039;vlan&#039; &#039;4&#039;<br />&nbsp; &nbsp; option &#039;pvid&#039; &#039;4&#039;<br />&nbsp; &nbsp; option &#039;ports&#039; &#039;0 5t&#039;</p><br /><p>/etc/config/multiwan</p><p>config &#039;multiwan&#039; &#039;config&#039;<br />&nbsp; &nbsp; option &#039;resolv_conf&#039; &#039;/tmp/resolv.conf.auto&#039;<br />&nbsp; &nbsp; option &#039;lan_if&#039; &#039;lan&#039;<br />&nbsp; &nbsp; option &#039;default_route&#039; &#039;fastbalancer&#039;</p><p>config &#039;interface&#039; &#039;wan&#039;<br />&nbsp; &nbsp; option &#039;icmp_hosts&#039; &#039;dns&#039;<br />&nbsp; &nbsp; option &#039;timeout&#039; &#039;3&#039;<br />&nbsp; &nbsp; option &#039;health_fail_retries&#039; &#039;3&#039;<br />&nbsp; &nbsp; option &#039;health_recovery_retries&#039; &#039;5&#039;<br />&nbsp; &nbsp; option &#039;weight&#039; &#039;1&#039;<br />&nbsp; &nbsp; option &#039;health_interval&#039; &#039;5&#039;<br />&nbsp; &nbsp; option &#039;failover_to&#039; &#039;fastbalancer&#039;<br />&nbsp; &nbsp; option &#039;dns&#039; &#039;208.67.222.222&#039;</p><p>config &#039;interface&#039; &#039;lan4&#039;<br />&nbsp; &nbsp; option &#039;icmp_hosts&#039; &#039;dns&#039;<br />&nbsp; &nbsp; option &#039;timeout&#039; &#039;3&#039;<br />&nbsp; &nbsp; option &#039;health_fail_retries&#039; &#039;3&#039;<br />&nbsp; &nbsp; option &#039;health_recovery_retries&#039; &#039;5&#039;<br />&nbsp; &nbsp; option &#039;weight&#039; &#039;1&#039;<br />&nbsp; &nbsp; option &#039;health_interval&#039; &#039;5&#039;<br />&nbsp; &nbsp; option &#039;failover_to&#039; &#039;fastbalancer&#039;<br />&nbsp; &nbsp; option &#039;dns&#039; &#039;208.67.222.222&#039;</p><br /><p>config &#039;mwanfw&#039;<br />&nbsp; &nbsp; option &#039;dst&#039; &#039;smtp.free.fr&#039;<br />&nbsp; &nbsp; option &#039;wanrule&#039; &#039;wan&#039;</p><p>config &#039;mwanfw&#039;<br />&nbsp; &nbsp; option &#039;dst&#039; &#039;smtp.orange.fr&#039;<br />&nbsp; &nbsp; option &#039;wanrule&#039; &#039;lan4&#039;</p>											<p class="post-edited">(Last edited by <strong>mynetmemo</strong> on 25 Sep 2010, 12:56)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p117843">
				<div class="post-metadata">
					<div class="post-num">Post #228</div>
					<div class="post-author">huglester</div>
					<div class="post-datetime">
						25 Sep 2010, 13:02					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mynetmemo wrote:</cite><blockquote><p>Hi friends,</p><p>Yesterday I purchased a Dlink dir-825 rev B1 router that I immediatly flashed with openwrt Backfire (10.03.1-rc3, r22796).<br />Each internet connector is connected to the ISP router statically.</p><p>That took me some hour to configure the switch (/etc/config/network) and so I share my little work ;-)</p><p>1 Wan is connected to Internet connector (free.fr)<br />1 Wan is connected to switch connector 4 (orange.fr)<br />1 Lan is connected to switch connector 1<br />...</p></blockquote></div><p>Hello</p><p>Wanted to let you know:<br />1) don&#039;t forget to make FIREWALL rules same for WAN2 as there are configured in WAN1<br />2) in dnsmasq.conf I was adding this lines too, not sure if those are needed:<br /></p><div class="codebox"><pre><code>config dhcp wan2
        option interface        wan
        option ignore   1</code></pre></div><p>3) can&#039;t remember... if I remember, I came here and edit this post:)</p><p>Good luck</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p117845">
				<div class="post-metadata">
					<div class="post-num">Post #229</div>
					<div class="post-author">mynetmemo</div>
					<div class="post-datetime">
						25 Sep 2010, 13:27					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>huglester wrote:</cite><blockquote><div class="quotebox"><cite>mynetmemo wrote:</cite><blockquote><p>Hi friends,</p><p>Yesterday I purchased a Dlink dir-825 rev B1 router that I immediatly flashed with openwrt Backfire (10.03.1-rc3, r22796).<br />Each internet connector is connected to the ISP router statically.</p><p>That took me some hour to configure the switch (/etc/config/network) and so I share my little work ;-)</p><p>1 Wan is connected to Internet connector (free.fr)<br />1 Wan is connected to switch connector 4 (orange.fr)<br />1 Lan is connected to switch connector 1<br />...</p></blockquote></div><p>Hello</p><p>Wanted to let you know:<br />1) don&#039;t forget to make FIREWALL rules same for WAN2 as there are configured in WAN1</p></blockquote></div><p>That&#039;s what I did ;-)</p><div class="quotebox"><cite>huglester wrote:</cite><blockquote><p>2) in dnsmasq.conf I was adding this lines too, not sure if those are needed:<br /></p><div class="codebox"><pre><code>config dhcp wan2
        option interface        wan
        option ignore   1</code></pre></div></blockquote></div><p>I don&#039;t think so because it&#039;s working like a charm...</p><div class="quotebox"><cite>huglester wrote:</cite><blockquote><p>3) can&#039;t remember... if I remember, I came here and edit this post:)</p><p>Good luck</p></blockquote></div><p>Anyway, thanx for your comments ;-)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p117877">
				<div class="post-metadata">
					<div class="post-num">Post #230</div>
					<div class="post-author">buildster</div>
					<div class="post-datetime">
						25 Sep 2010, 23:51					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>renoir wrote:</cite><blockquote><p>Health pings remain at 1 Hz...</p><p>However, I stumbled over a serious issue. As mentioned before, I run an asterisk server on the same device as the multiwan script. From time to time, asterisk forwards the public IP address of the failover link to the sip providers while registering, when the main link is still up... Some time later, it reverts back to the main link&#039;s IP address. Obviously, asterisk shouldn&#039;t know anything about the failover link when the main link is still up, as load balancing is not activated in my conf. If this happens during an active call, the call isn&#039;t dropped, but the callee can no longer hear me while I still hear him. I should point out that this only happens while registering at the sip provider.</p><p>This behavior is completely random, it happens quite frequently but I have not been able to find what triggers this behavior. However, disabling the multiwan script resolves the issue.</p><p>Greetings.</p></blockquote></div><p>Hey renoir,</p><p><a href="https://dev.openwrt.org/ticket/7996">Another improved version of multiwan</a> may solve your issues reported here:<br />1. performance on a WRT54GS v1.1: try set health_monitor to serial<br />2. ping every second: if this version still does it, post your etc/config/multiwan<br />3. asterisk wan switching: if it listens on a src port, use source-ports accordingly, see the sample VoIP mwanfw (works for my ATA)</p><p>I was asking Craig to review it before submitting a patch, but you&#039;re the perfect person to provide feedback and report all the bugs I introduce, right? <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p117887">
				<div class="post-metadata">
					<div class="post-num">Post #231</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						26 Sep 2010, 01:36					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>buildster wrote:</cite><blockquote><div class="quotebox"><cite>renoir wrote:</cite><blockquote><p>Health pings remain at 1 Hz...</p><p>However, I stumbled over a serious issue. As mentioned before, I run an asterisk server on the same device as the multiwan script. From time to time, asterisk forwards the public IP address of the failover link to the sip providers while registering, when the main link is still up... Some time later, it reverts back to the main link&#039;s IP address. Obviously, asterisk shouldn&#039;t know anything about the failover link when the main link is still up, as load balancing is not activated in my conf. If this happens during an active call, the call isn&#039;t dropped, but the callee can no longer hear me while I still hear him. I should point out that this only happens while registering at the sip provider.</p><p>This behavior is completely random, it happens quite frequently but I have not been able to find what triggers this behavior. However, disabling the multiwan script resolves the issue.</p><p>Greetings.</p></blockquote></div><p>Hey renoir,</p><p><a href="https://dev.openwrt.org/ticket/7996">Another improved version of multiwan</a> may solve your issues reported here:<br />1. performance on a WRT54GS v1.1: try set health_monitor to serial<br />2. ping every second: if this version still does it, post your etc/config/multiwan<br />3. asterisk wan switching: if it listens on a src port, use source-ports accordingly, see the sample VoIP mwanfw (works for my ATA)</p><p>I was asking Craig to review it before submitting a patch, but you&#039;re the perfect person to provide feedback and report all the bugs I introduce, right? <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></blockquote></div><p>Taking a look a it right now, I still have yet to update the luci menus for the last change, sorry, been very busy and detached as of late. </p><p>Thanks Buildster, I&#039;ll keep ya posted. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p117909">
				<div class="post-metadata">
					<div class="post-num">Post #232</div>
					<div class="post-author">renoir</div>
					<div class="post-datetime">
						26 Sep 2010, 14:26					</div>
				</div>
				<div class="post-content content">
					<p>Thanks buildster,</p><p>I will have a look at it asap! Seems odd though if one would have to specify src-ports for asterisk to go through the main link, as there is already a default rule that sends all traffic through the main link. But of course I will try what you suggested <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Greetings,<br />renoir.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p117947">
				<div class="post-metadata">
					<div class="post-num">Post #233</div>
					<div class="post-author">buildster</div>
					<div class="post-datetime">
						27 Sep 2010, 08:53					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>SouthPawn wrote:</cite><blockquote><p>Taking a look a it right now, I still have yet to update the luci menus for the last change, sorry, been very busy and detached as of late. </p><p>Thanks Buildster, I&#039;ll keep ya posted. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></blockquote></div><p>Hey Craig,</p><p>Thank you for looking at corresponding changes in the luci menus! I&#039;ve worked with uci only, as I don&#039;t have a testing unit for a http server and luci files. My WHR-HP-G54 has 56 KB left on its 4 MB flash. I really envy those with a monster router or two. <img src="https://forum.openwrt.org/img/smilies/tongue.png" width="15" height="15" alt="tongue" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p117948">
				<div class="post-metadata">
					<div class="post-num">Post #234</div>
					<div class="post-author">buildster</div>
					<div class="post-datetime">
						27 Sep 2010, 09:06					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>renoir wrote:</cite><blockquote><p>Thanks buildster,</p><p>I will have a look at it asap! Seems odd though if one would have to specify src-ports for asterisk to go through the main link, as there is already a default rule that sends all traffic through the main link. But of course I will try what you suggested <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Greetings,<br />renoir.</p></blockquote></div><p>I learned it the hard way in case of Skype and sip-based ATA in my triple-wan setup. Multi-wan load balancing loves to spread network connections of a voice session and break it in some way. For my ATA, I have to ensure both SIP and RTP ports go thru the same wan. Look forward to your feedback...</p><p>Good luck.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p118128">
				<div class="post-metadata">
					<div class="post-num">Post #235</div>
					<div class="post-author">eversteegt</div>
					<div class="post-datetime">
						30 Sep 2010, 00:06					</div>
				</div>
				<div class="post-content content">
					<p>Wow, this MULTIWAN script might just be what I am looking for!!!</p><p>Only I don&#039;t want to use it for any load balancing or failover at all. I want to use it for the following scenario:</p><p>I have a tripple-play subscription over FttH! It supports 2 WAN connections:</p><p>* 1 PPPoE connection via q-tagged ethernet (VLAN 6), for the main internet connection (this is already running perfectly)<br />* 1 PPPoE connection via VLAN 7. Essentially, this one also has full internet connectivity, but heavily QOS&#039;ed. It only supports 512 kbit down adn 512 kbit up, but with absolutely highest priority on the ISP&#039;s network layer (and probably also the fiber&#039;s). </p><p>The second WAN connection is meant to use for VOIP. At my VOIP client (a Fritz!box FON WLAN 7270 with integrated DECT base), I can set what &quot;ToS&quot; to give all SIP- and RTP related packets. </p><p>Is it possible to add a functionality (or is it already configurable when doing it manually at the terminal) to just use the second WAN connection for packets with a specific ToS ? <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p118530">
				<div class="post-metadata">
					<div class="post-num">Post #236</div>
					<div class="post-author">renoir</div>
					<div class="post-datetime">
						5 Oct 2010, 19:03					</div>
				</div>
				<div class="post-content content">
					<p>Yesterday I compiled a new image with multiwan 1.0.18 included. However, running asterisk on the same device is still a little troublesome. The way multiwan announces dns must have changed (given the problem doesn&#039;t show with multiwan disabled). Let me explain: asterisk is one of the services running on the router and is started via init.d-script (start=90). Before 1.0.18, asterisk manages to resolve the sip providers&#039; host addresses without any problems. With 1.0.18, it doesn&#039;t resolve the addresses anymore at startup. When I do a manual sip reload right after the router is up, it does resolve the addresses properly. There is a workaround for this (setting dnsmgr.conf to do periodic resolves), but since this problem didn&#039;t exist before 1.0.18, it might be worth to take a look at. To my knowledge, no other services are affected. I tried to give multiwan some room to load properly before asterisk kicks in (sleep 30), but no luck.</p><p>buildster, I still have to try your proposed improvements, I&#039;ve been quite busy lately. I&#039;ll keep you posted <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Greetings.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p118605">
				<div class="post-metadata">
					<div class="post-num">Post #237</div>
					<div class="post-author">buildster</div>
					<div class="post-datetime">
						6 Oct 2010, 18:22					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>renoir wrote:</cite><blockquote><p>Yesterday I compiled a new image with multiwan 1.0.18 included. However, running asterisk on the same device is still a little troublesome. The way multiwan announces dns must have changed (given the problem doesn&#039;t show with multiwan disabled). Let me explain: asterisk is one of the services running on the router and is started via init.d-script (start=90). Before 1.0.18, asterisk manages to resolve the sip providers&#039; host addresses without any problems. With 1.0.18, it doesn&#039;t resolve the addresses anymore at startup. When I do a manual sip reload right after the router is up, it does resolve the addresses properly. There is a workaround for this (setting dnsmgr.conf to do periodic resolves), but since this problem didn&#039;t exist before 1.0.18, it might be worth to take a look at. To my knowledge, no other services are affected. I tried to give multiwan some room to load properly before asterisk kicks in (sleep 30), but no luck.</p><p>buildster, I still have to try your proposed improvements, I&#039;ve been quite busy lately. I&#039;ll keep you posted <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Greetings.</p></blockquote></div><p>hey renoir, which revision of the trunk did you compile?<br />When you have time, can you try <strong>each</strong> of the followings, to isolate the cause of your ip resolution problem?</p><p>1. disable multiwan: /etc/init.d/disable multiwan; reboot<br />2. downgrade to multiwan 1.0.17 (if there is space left, no re-flash of image is needed. just opkg install...)<br />3. if the issue persists, flash back to your previous image, upgrade to multiwan 1.0.18, and then patch it to the new version in ticket 7996</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p118636">
				<div class="post-metadata">
					<div class="post-num">Post #238</div>
					<div class="post-author">Black6spdZ</div>
					<div class="post-datetime">
						7 Oct 2010, 01:47					</div>
				</div>
				<div class="post-content content">
					<p>Recently installed Backfire 10.03.1 r22752 onto a WRT54GS 32M/8M and then MultiWAN_1.0.18 with Luci app 1.0.16. It took a little while to get the three WAN links configured for my three 6M dsl lines but I got it. P2P apps get the full bandwidth &quot;measured up to 2080KB/s with a torrent&quot; which is what I expected from reading load-balancing multiple connections &quot;not bonding&quot;. What I didn&#039;t expect and cannot explain is why my speedtests on speedtest.net and others report ~11-12MB d/l and 800K u/l. As far as I know these tests use a single transfer during tests.. how do I get the combined BW from two of my connections? Why not all three? Does the multiwan script do some transfer magic? I&#039;d like to get to the bottom of this if nothing more than to learn why. One last Q, when setting up the link weights, I saw it defaults to 10.. if all connections are 10 as in 10:10:10 would that be the same as 1:1:1 or does the script round-robin 10 connections per link before moving to the next WAN link? Thanks</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p118755">
				<div class="post-metadata">
					<div class="post-num">Post #239</div>
					<div class="post-author">tribhuvanji</div>
					<div class="post-datetime">
						9 Oct 2010, 18:34					</div>
				</div>
				<div class="post-content content">
					<p>Hi Blak6spdZ,<br />Regarding the first question, there is no practical way to bond disparate network connections to form a single, aggregated interface. If you had full control of the other end of each ISP line, you may have a chance... The best you can do is what you are doing now, spreading your multiple IP connections across the three lines (as with BT). To bandwidth-test each line, you could run iptraf on the router console and soak all three lines with heavy downloads, or test them one at a time by adding a temporary route for the test-box under&nbsp; &quot;Multi-WAN Traffic Rules&quot;. That would force the test-pc to use one specific wan for each test.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p118788">
				<div class="post-metadata">
					<div class="post-num">Post #240</div>
					<div class="post-author">Black6spdZ</div>
					<div class="post-datetime">
						10 Oct 2010, 10:11					</div>
				</div>
				<div class="post-content content">
					<p>tribhuvanji, I understand the way load-balancing works.. I stated earlier that I could get an aggregate throughput of all three of my lines when D/L a torrent file.. what I cannot explain is why speedtest.net throughput tests always give me the speed as if two of my lines are bonded &quot;roughly 11-12Mb&quot; download even though these are seperate DSL circuits with three different WAN gateways, so are in no way ISP bonded.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p118844">
				<div class="post-metadata">
					<div class="post-num">Post #241</div>
					<div class="post-author">Anders B</div>
					<div class="post-datetime">
						11 Oct 2010, 09:46					</div>
				</div>
				<div class="post-content content">
					<p>Finally I got MultiWAN to work as I expected. Maybe this is obvious to others, or maybe I have misunderstood something, but when I was trying this is my lab I could never get a ping session to fail over while it was running. New sessions went fine, but not the existing ones that were already in the connection track table.</p><p>I modified MultiWAN to clear the conntrack table upon startup, and to remove all connections on a failed interface during the fail process. </p><p>I am running version 1.0.18 on Backfire 10.03. Hardware is a WRT54GL v1.1. I am not using the load balancing function, just one WAN connection at a time.</p><p>Maybe there is a reason why MultiWAN does not do this by default. Any thoughts?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p118911">
				<div class="post-metadata">
					<div class="post-num">Post #242</div>
					<div class="post-author">buildster</div>
					<div class="post-datetime">
						12 Oct 2010, 08:20					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Anders B wrote:</cite><blockquote><p>Finally I got MultiWAN to work as I expected. Maybe this is obvious to others, or maybe I have misunderstood something, but when I was trying this is my lab I could never get a ping session to fail over while it was running. New sessions went fine, but not the existing ones that were already in the connection track table.</p><p>I modified MultiWAN to clear the conntrack table upon startup, and to remove all connections on a failed interface during the fail process. </p><p>I am running version 1.0.18 on Backfire 10.03. Hardware is a WRT54GL v1.1. I am not using the load balancing function, just one WAN connection at a time.</p><p>Maybe there is a reason why MultiWAN does not do this by default. Any thoughts?</p></blockquote></div><p>Hey Anders,</p><p>I see the multiwan script does &quot;ip route flush cache&quot; when failing over. Apparently, it&#039;s not enough. Can you post your changes to clear conntrack table and&nbsp; to remove all connections on a failed interface?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119307">
				<div class="post-metadata">
					<div class="post-num">Post #243</div>
					<div class="post-author">Bagpuss</div>
					<div class="post-datetime">
						19 Oct 2010, 15:00					</div>
				</div>
				<div class="post-content content">
					<p>Firstly, a big thanks for the MultiWAN script. It&#039;s exactly what I was looking for.</p><p>I&#039;m running it on OpenWRT Backfire 10.03 on a WGT634U. The WGT is connected to two TG585v7&#039;s, which are both in bridge mode.<br />My first ISP is PlusNet, and the second is TalkTalk. Both ISPs give me approx 6MBit/s downstream and 512kbps upstream. <br />I&#039;m using MultiWAN 1.0.18 and the Luci stuff is 1.0.16.</p><p>I&#039;ve been able to get the MultiWAN configuration to work pretty well, but have come up against a couple of issues:</p><p>1) My main goal with load balancing was to improve my NNTP download throughput. To this end, I&#039;ve setup my mwanfw entries as follows:</p><div class="codebox"><pre><code>config &#039;mwanfw&#039;
        option &#039;dst&#039; &#039;secure.news.eu.easynews.com&#039;
        option &#039;wanrule&#039; &#039;fastbalancer&#039;

config &#039;mwanfw&#039;
        option &#039;dst&#039; &#039;secure.news.us.easynews.com&#039;
        option &#039;wanrule&#039; &#039;fastbalancer&#039;</code></pre></div><p>I then use SABnzbd to download from primarily secure.news.eu.easynews.com. Sometimes, I am clearly getting the combined throughput, as my download rate reaches about 1.4MB/sec. However, most of the time, I can see that only one link is being used (checked with ifstat). </p><p>I have also been messing about with the standard QoS stuff, and have found that installing, and then removing this seems to have changed the MultiWAN behaviour.</p><p>For example, on first boot of the router, I see the following:</p><div class="codebox"><pre><code>root@OpenWrt:/etc/config# iptables -L MultiWanRules -t mangle -v
Chain MultiWanRules (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 FW1MARK    icmp --  any    any     192.168.0.3          anywhere            mark match 0x0 
  643 45246 LoadBalancer  all  --  any    any     anywhere             anywhere            mark match 0x0</code></pre></div><p>No matter what traffic passes through the router, this table doesn&#039;t change.</p><p>However, if I run /etc/init.d/multiwan restart, then the table becomes:</p><div class="codebox"><pre><code>root@OpenWrt:/etc/config# iptables -L MultiWanRules -t mangle -v
Chain MultiWanRules (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 FW2MARK    tcp  --  any    any     192.168.1.0/24       173-13-171-209-sfba.hfc.comcastbusiness.net mark match 0x0 multiport dports 21 
    0     0 FW1MARK    icmp --  any    any     192.168.0.3          anywhere            mark match 0x0 
    0     0 FastBalancer  all  --  any    any     anywhere             199.89.233.72.static.reverse.ltdomains.com mark match 0x0 
    0     0 FastBalancer  all  --  any    any     anywhere             198.89.233.72.static.reverse.ltdomains.com mark match 0x0 
    0     0 FastBalancer  all  --  any    any     anywhere             197.89.233.72.static.reverse.ltdomains.com mark match 0x0 
    0     0 FastBalancer  all  --  any    any     anywhere             200.89.233.72.static.reverse.ltdomains.com mark match 0x0 
    0     0 FastBalancer  all  --  any    any     anywhere             secure.news.eu.easynews.com mark match 0x0 
    0     0 FastBalancer  all  --  any    any     anywhere             secure.news.dc1.easynews.com mark match 0x0 
   38  1889 LoadBalancer  all  --  any    any     anywhere             anywhere            mark match 0x0</code></pre></div><p>which seems more in line with what is in my /etc/config/multiwan file:</p><div class="codebox"><pre><code>config &#039;multiwan&#039; &#039;config&#039;
    option &#039;default_route&#039; &#039;balancer&#039;

config &#039;interface&#039; &#039;wan&#039;
    option &#039;weight&#039; &#039;10&#039;
    option &#039;health_interval&#039; &#039;10&#039;
    option &#039;icmp_hosts&#039; &#039;dns&#039;
    option &#039;timeout&#039; &#039;3&#039;
    option &#039;health_fail_retries&#039; &#039;3&#039;
    option &#039;health_recovery_retries&#039; &#039;5&#039;
    option &#039;failover_to&#039; &#039;wan1&#039;
    option &#039;dns&#039; &#039;auto&#039;

config &#039;interface&#039; &#039;wan1&#039;
    option &#039;weight&#039; &#039;10&#039;
    option &#039;health_interval&#039; &#039;10&#039;
    option &#039;icmp_hosts&#039; &#039;dns&#039;
    option &#039;timeout&#039; &#039;3&#039;
    option &#039;health_fail_retries&#039; &#039;3&#039;
    option &#039;health_recovery_retries&#039; &#039;5&#039;
    option &#039;failover_to&#039; &#039;balancer&#039;
    option &#039;dns&#039; &#039;auto&#039;

config &#039;mwanfw&#039;
        option &#039;src&#039; &#039;192.168.1.0/24&#039;
        option &#039;dst&#039; &#039;ftp.netlab7.com&#039;
        option &#039;proto&#039; &#039;tcp&#039;
        option &#039;ports&#039; &#039;21&#039;
        option &#039;wanrule&#039; &#039;wan1&#039;

config &#039;mwanfw&#039;
    option &#039;src&#039; &#039;192.168.0.3&#039;
        option &#039;proto&#039; &#039;icmp&#039;
        option &#039;wanrule&#039; &#039;wan&#039;

config &#039;mwanfw&#039;
        option &#039;dst&#039; &#039;www.whatismyip.com&#039;
        option &#039;wanrule&#039; &#039;fastbalancer&#039;
        
config &#039;mwanfw&#039;
        option &#039;dst&#039; &#039;secure.news.eu.easynews.com&#039;
        option &#039;wanrule&#039; &#039;fastbalancer&#039;

config &#039;mwanfw&#039;
        option &#039;dst&#039; &#039;secure.news.us.easynews.com&#039;
        option &#039;wanrule&#039; &#039;fastbalancer&#039;</code></pre></div><p>Has the QoS stuff messed up my configuration, or is there another explanation for the difference in mangle tables from bootup, and after a multiwan restart?</p><p>All I really want to achieve is load balanced throughput for my NNTP and HTTP downloads, combined with some QoS to prioritise my Cisco VPN traffic and other web browsing activities.</p><p>If anyone can give me some pointers to where I&#039;m going wrong, then I&#039;d much appreciate it.</p><p>Thanks,</p><p>Andy.</p><br /><p>For reference, here are my /etc/config/network and /etc/config/firewall files:</p><div class="codebox"><pre><code>#### VLAN configuration 
config switch eth0
    option enable   1

config switch_vlan eth0_0
    option device   &quot;eth0&quot;
    option vlan     0
    option ports    &quot;1 2 3 5&quot;

config switch_vlan eth0_1
    option device   &quot;eth0&quot;
    option vlan     1
    option ports    &quot;4 5&quot;

config switch_vlan eth0_2
    option device   &quot;eth0&quot;
    option vlan     2
    option ports    &quot;0 5&quot;
    
#### Loopback configuration
config interface loopback
    option ifname    &quot;lo&quot;
    option proto    static
    option ipaddr    127.0.0.1
    option netmask    255.0.0.0


#### LAN configuration
config interface lan
    option type     bridge
    option ifname    &quot;eth0.0&quot;
    option proto    static
    option ipaddr    192.168.0.1
    option netmask    255.255.255.0


#### WAN configuration
config &#039;interface&#039; &#039;wan&#039;
    option &#039;ifname&#039; &#039;eth0.1&#039;
    option &#039;username&#039; &#039;bagpuss&#039;
    option &#039;password&#039; &#039;letmein&#039;
    option &#039;vpi&#039; &#039;38&#039;
    option &#039;vci&#039; &#039;0&#039;
    option &#039;mtu&#039; &#039;1500&#039;
    option &#039;defaultroute&#039; &#039;0&#039;
    option &#039;ppp_redial&#039; &#039;demand&#039;
    option &#039;proto&#039; &#039;pppoe&#039;
    
config &#039;interface&#039; &#039;wan1&#039;
        option &#039;ifname&#039; &#039;eth0.2&#039;
        option &#039;username&#039; &#039;user@talktalk.net&#039;
        option &#039;password&#039; &#039;password&#039;
        option &#039;vpi&#039; &#039;38&#039;
        option &#039;vci&#039; &#039;0&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;ppp_redial&#039; &#039;demand&#039;
        option &#039;proto&#039; &#039;pppoe&#039;
        option &#039;mtu&#039; &#039;1432&#039;</code></pre></div><div class="codebox"><pre><code>config &#039;defaults&#039;
    option &#039;syn_flood&#039; &#039;1&#039;
    option &#039;input&#039; &#039;ACCEPT&#039;
    option &#039;output&#039; &#039;ACCEPT&#039;
    option &#039;forward&#039; &#039;REJECT&#039;

config &#039;zone&#039;
    option &#039;name&#039; &#039;lan&#039;
    option &#039;input&#039; &#039;ACCEPT&#039;
    option &#039;output&#039; &#039;ACCEPT&#039;
    option &#039;forward&#039; &#039;REJECT&#039;

config &#039;zone&#039;
    option &#039;name&#039; &#039;wan&#039;
    option &#039;input&#039; &#039;DROP&#039;
    option &#039;output&#039; &#039;ACCEPT&#039;
    option &#039;forward&#039; &#039;REJECT&#039;
    option &#039;masq&#039; &#039;1&#039;
    option &#039;mtu_fix&#039; &#039;1&#039;
    option &#039;network&#039; &#039;wan wan1&#039;

config &#039;forwarding&#039;
    option &#039;src&#039; &#039;lan&#039;
    option &#039;dest&#039; &#039;wan&#039;

config &#039;rule&#039;
    option &#039;src&#039; &#039;wan&#039;
    option &#039;proto&#039; &#039;udp&#039;
    option &#039;dest_port&#039; &#039;68&#039;
    option &#039;target&#039; &#039;ACCEPT&#039;

config &#039;rule&#039;
    option &#039;src&#039; &#039;wan&#039;
    option &#039;proto&#039; &#039;icmp&#039;
    option &#039;icmp_type&#039; &#039;echo-request&#039;
    option &#039;target&#039; &#039;DROP&#039;

config &#039;include&#039;
    option &#039;path&#039; &#039;/etc/firewall.user&#039;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119324">
				<div class="post-metadata">
					<div class="post-num">Post #244</div>
					<div class="post-author">Bagpuss</div>
					<div class="post-datetime">
						19 Oct 2010, 17:42					</div>
				</div>
				<div class="post-content content">
					<p>Just a quick follow up to my previous post. I&#039;ve now found some additional differences between the MultiWAN configuration following a reboot versus running /etc/init.d/multiwan restart.</p><p>From a fresh boot, I see the following:</p><div class="codebox"><pre><code>root@OpenWrt:~# ip rule show
0:    from all lookup local 
9:    from all fwmark 0x1 lookup LoadBalancer 
10:    from 84.93.23.101 lookup MWAN1 
11:    from all fwmark 0x10 lookup MWAN1 
20:    from 84.13.252.100 lookup MWAN2 
21:    from all fwmark 0x20 lookup MWAN2 
32766:    from all lookup main 
32767:    from all lookup default 
root@OpenWrt:~# ip route show table 10
root@OpenWrt:~# ip route show table 11
root@OpenWrt:~# ip route show table 20
root@OpenWrt:~# ip route show table 21

root@OpenWrt:~# cat /etc/iproute2/rt_tables 
#
# reserved values
#
255    local
254    main
253    default
0    unspec
#
# local
#
#1    inr.ruhep
#
170 LoadBalancer
171 MWAN1
172 MWAN2

root@OpenWrt:~# ip route show table 170
195.166.130.7 dev ppp0  proto kernel  scope link  src 84.93.23.101 
84.13.240.1 dev ppp1  proto kernel  scope link  src 84.13.252.100 
192.168.0.0/24 dev br-lan  proto kernel  scope link  src 192.168.0.1 
default via 195.166.130.7 dev ppp0  proto static 

root@OpenWrt:~# ip route show table 171
195.166.130.7 dev ppp0  proto kernel  scope link  src 84.93.23.101 
84.13.240.1 dev ppp1  proto kernel  scope link  src 84.13.252.100 
192.168.0.0/24 dev br-lan  proto kernel  scope link  src 192.168.0.1 
default via 195.166.130.7 dev ppp0  proto static  src 84.93.23.101 

root@OpenWrt:~# ip route show table 172
195.166.130.7 dev ppp0  proto kernel  scope link  src 84.93.23.101 
84.13.240.1 dev ppp1  proto kernel  scope link  src 84.13.252.100 
192.168.0.0/24 dev br-lan  proto kernel  scope link  src 192.168.0.1 
default via 84.13.240.1 dev ppp1  proto static  src 84.13.252.100</code></pre></div><p>At this point, no load balancing appears to be happening. The traffic always appears to go out of the second WAN interface (wan1), as shown by ifstat.</p><p>However, if I run /etc/init.d/restart I see the following difference:</p><div class="codebox"><pre><code>root@OpenWrt:~# ip route show table 170
195.166.130.7 dev ppp0  proto kernel  scope link  src 84.93.23.101 
84.13.240.1 dev ppp1  proto kernel  scope link  src 84.13.252.100 
192.168.0.0/24 dev br-lan  proto kernel  scope link  src 192.168.0.1 
default  proto static 
    nexthop via 195.166.130.7  dev ppp0 weight 10
    nexthop via 84.13.240.1  dev ppp1 weight 10</code></pre></div><p>Now when I&#039;m surfing/download, the traffic appears to be round robin balanced between the WAN connections.</p><p>Is there something I&#039;m doing wrong? Does my config look correct?</p><p>Any help would be much appreciated.</p><p>Thanks,</p><p>Andy.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119347">
				<div class="post-metadata">
					<div class="post-num">Post #245</div>
					<div class="post-author">Bagpuss</div>
					<div class="post-datetime">
						20 Oct 2010, 00:20					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ve now upgraded to 10.03.1-RC3 with MultiWAN 1.0.18 plus ticket 7996 diffs.</p><p>This seems to have resolved the weirdness I was seeing with the nexthop stuff being missing from the ip route table, but I&#039;m now faced with the following error:</p><p>Oct 19 20:44:44 OpenWrt user.notice multiwan: Performance load balancer(fastbalanacer) is unavailable due to current kernel limitations.</p><p>This seems to be because of a lack of iptable statistics, but I&#039;m not sure how to fix this. Presumably, I&#039;d need to build a new kernel, but I&#039;ve not got the facilities to do this currently. Is there any other way of resolving this, other than downgrading to 10.03?</p><p>This is all kind of frustrating, really, as I&#039;ve noticed that using fastbalancer seemed to work better for spreading the traffic to Easynews.</p><p>Andy.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119486">
				<div class="post-metadata">
					<div class="post-num">Post #246</div>
					<div class="post-author">buildster</div>
					<div class="post-datetime">
						21 Oct 2010, 21:59					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Bagpuss wrote:</cite><blockquote><p>I&#039;ve now upgraded to 10.03.1-RC3 with MultiWAN 1.0.18 plus ticket 7996 diffs.</p><p>This seems to have resolved the weirdness I was seeing with the nexthop stuff being missing from the ip route table, but I&#039;m now faced with the following error:</p><p>Oct 19 20:44:44 OpenWrt user.notice multiwan: Performance load balancer(fastbalanacer) is unavailable due to current kernel limitations.</p><p>This seems to be because of a lack of iptable statistics, but I&#039;m not sure how to fix this. Presumably, I&#039;d need to build a new kernel, but I&#039;ve not got the facilities to do this currently. Is there any other way of resolving this, other than downgrading to 10.03?</p><p>This is all kind of frustrating, really, as I&#039;ve noticed that using fastbalancer seemed to work better for spreading the traffic to Easynews.</p><p>Andy.</p></blockquote></div><p>Hey Andy, do you have package iptables-mod-ipopt installed? The statistic mod should be in it. See <a href="https://dev.openwrt.org/browser/branches/backfire/package/iptables/Makefile">https://dev.openwrt.org/browser/branche … s/Makefile</a>. If yes, can you post the output of lsmod?</p><p>By the way, Craig has committed ticket 7996 diffs. For your next upgrade, it may be easier to just install multiwan 1.0.1<strong>9</strong> from the trunk/its snapshot.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119511">
				<div class="post-metadata">
					<div class="post-num">Post #247</div>
					<div class="post-author">Bagpuss</div>
					<div class="post-datetime">
						22 Oct 2010, 12:14					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>buildster wrote:</cite><blockquote><p>Hey Andy, do you have package iptables-mod-ipopt installed? The statistic mod should be in it. See <a href="https://dev.openwrt.org/browser/branches/backfire/package/iptables/Makefile">https://dev.openwrt.org/browser/branche … s/Makefile</a>. If yes, can you post the output of lsmod?</p><p>By the way, Craig has committed ticket 7996 diffs. For your next upgrade, it may be easier to just install multiwan 1.0.1<strong>9</strong> from the trunk/its snapshot.</p></blockquote></div><p>Hi buildster,</p><p>I&#039;ve downgraded to 10.03 for now, as I wanted to get the system back up and running. There is obviously load balancing taking place with this configuration (using 1.0.18) but it doesn&#039;t seem to be consistent. </p><p>My default configuration is to simply have fastbalancer as the default route. When I do this, sometimes my connections to Easynews are balancing, and I see the combined throughput of both links. At other times, only one link is used. I&#039;m keeping an eye on the links using ifstat -i ppp0,ppp1.</p><p>I&#039;m making 10 simultaneous connections to Easynews, all going to secure.news.eu.easynews.com. My expectation is that multiwan would round robin balance these connections, so that 5 go through ppp0 and 5 through ppp1. I&#039;m thinking that the challenge is for multiwan to decide if it&#039;s okay to split the traffic in this way. I&#039;m guessing that for things like ssh, you&#039;d want to bind to one particular interface, and then keep it that way. The same, I guess, for VPN.</p><p>I&#039;d be quite happy to try and install stuff from the trunk or snapshots. Can I simply go to: <a href="http://downloads.openwrt.org/snapshots/trunk/">http://downloads.openwrt.org/snapshots/trunk/</a><br />and download the latest nightly build for my platform, or would it be better to run 10.03.1-rc3, and point the firmware at the packages from the latest snapshot?</p><p>If I install the latest snapshot firmware, will there be any issues with dependencies etc. in the packages when the next snapshot is built?</p><p>Sorry for so many questions, but I want to make sure I get this correct.</p><p>Thanks,</p><p>Andy.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119597">
				<div class="post-metadata">
					<div class="post-num">Post #248</div>
					<div class="post-author">buildster</div>
					<div class="post-datetime">
						23 Oct 2010, 22:06					</div>
				</div>
				<div class="post-content content">
					<p>Andy,</p><p>To get your system up and running, multiwan 1.0.18 should do the job... unless the changes in 1.0.19 accidentally made it better. I normally don&#039;t do that, but do the opposite <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" />.</p><p>I haven&#039;t tested it myself, but multiwan 1.0.19 should run in place of 1.0.18 on openwrt 10.03 because it didn&#039;t introduce any new/hard dependency. If you like to test it, wget the 1.0.19 package to /tmp and okpg install it. opkg remove it (easily) if it doesn&#039;t work out.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119759">
				<div class="post-metadata">
					<div class="post-num">Post #249</div>
					<div class="post-author">Anders B</div>
					<div class="post-datetime">
						26 Oct 2010, 11:45					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>buildster wrote:</cite><blockquote><p>Hey Anders,</p><p>I see the multiwan script does &quot;ip route flush cache&quot; when failing over. Apparently, it&#039;s not enough. Can you post your changes to clear conntrack table and&nbsp; to remove all connections on a failed interface?</p></blockquote></div><p>Hey,</p><p>Sorry for the delay. Here are my two changes, both in /usr/bin/multiwan</p><p>1. In the function iptables_init():</p><p>Last line in the function i added &quot;conntrack -F&quot; to clear any pre-multiwan sessions going thru the wrong internet connection. Maybe this is not needed.</p><p>2. The function add() in the function failover():</p><p>&nbsp; &nbsp; add() {</p><p># &gt;&gt; Anders: Define variable for failed interface ip. Maybe this is already available in some global variable?<br />&nbsp; &nbsp; &nbsp; &nbsp; local clearip<br /># &lt;&lt; Anders</p><p>&nbsp; &nbsp; &nbsp; &nbsp; wan_fail_map=$(echo $wan_fail_map | sed -e &quot;s/${1}\[${failchk}\]//g&quot;)<br />&nbsp; &nbsp; &nbsp; &nbsp; wan_fail_map=$(echo $wan_fail_map${1}[x])<br />&nbsp; &nbsp; &nbsp; &nbsp; wan_recovery_map=$(echo $wan_recovery_map | sed -e &quot;s/${1}\[${recvrychk}\]//g&quot;)<br />&nbsp; &nbsp; &nbsp; &nbsp; update_cache</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if [ &quot;$existing_failover&quot; == &quot;2&quot; ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if [ &quot;$failover_to&quot; != &quot;balancer&quot; -a &quot;$failover_to&quot; != &quot;fastbalancer&quot; -a &quot;$failover_to&quot; != &quot;disable&quot; -a &quot;$failover_to_wanid&quot; != &quot;$wanid&quot; ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; iptables -I FW${wanid}MARK 2 -t mangle -j FW${failover_to_wanid}MARK<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elif [ &quot;$failover_to&quot; == &quot;balancer&quot; ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; iptables -I FW${wanid}MARK 2 -t mangle -j LoadBalancer<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elif [ &quot;$failover_to&quot; == &quot;fastbalancer&quot; ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; iptables -I FW${wanid}MARK 2 -t mangle -j FastBalancer<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fi<br />&nbsp; &nbsp; &nbsp; &nbsp; fi<br />&nbsp; &nbsp; &nbsp; &nbsp; mwnote &quot;$1 has failed and is currently offline.&quot;</p><p># &gt;&gt; Anders: Figure out the ip of the failed interface, then clear associated entries.<br />&nbsp; &nbsp; &nbsp; &nbsp; clearip=$(query_config ipaddr $1)<br />&nbsp; &nbsp; &nbsp; &nbsp; mwnote &quot;Deleting conntrack entries for $clearip&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; conntrack -D -n $clearip<br /># &lt;&lt; Anders</p><p>&nbsp; &nbsp; }</p><br /><p>Yeah, and also the package conntrack-tools needs to be installed.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119787">
				<div class="post-metadata">
					<div class="post-num">Post #250</div>
					<div class="post-author">buildster</div>
					<div class="post-datetime">
						27 Oct 2010, 00:16					</div>
				</div>
				<div class="post-content content">
					<p>Hey Anders,</p><p>Thanks for posting your changes! I&#039;ll apply them to my setup.</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 10 of 14</div><nav><ul><li><a href="viewtopic.php%3Fid=23904&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=8.html">8</a></li><li><a href="viewtopic.php%3Fid=23904&amp;p=9.html">9</a></li><li class="pagination-current"><span>10</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=11.html">11</a></li><li><a href="viewtopic.php%3Fid=23904&amp;p=12.html">12</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=14.html">14</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>