<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> FailSafe - Can&#039;t do Overlay Remove</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 13 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p160779">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">katlivacib</div>
					<div class="post-datetime">
						14 Mar 2012, 03:24					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>Recently installed openwrt to my AP -not modem- and while tinkering with it -to get it connected internet via my PC, I started doing some experiments on etc/config/network.</p><p>Used WinSCP and backed up original config file as a tar file. Then rebooted and unfortunately I can&#039;t connect afterwards.</p><p>So I followed failsafe instructions and -I guess- I succeeded in that for some bits, but then I realized that I can&#039;t restore my config sets to back to open wrt originals.</p><p>Can you help me with this?<br />--</p><br /><br /><p>This dump below should give a better explanation of my attempts: (this is copied from telnet after FailSafe boot)</p><br /><p> === IMPORTANT ============================<br />&nbsp; Use &#039;passwd&#039; to set your login password<br />&nbsp; this will disable telnet and enable SSH<br /> ------------------------------------------</p><br /><p>BusyBox v1.19.3 (2012-03-09 18:37:39 MST) built-in shell (ash)<br />Enter &#039;help&#039; for a list of built-in commands.</p><p>&nbsp; _______&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;________&nbsp; &nbsp; &nbsp; &nbsp; __<br /> |&nbsp; &nbsp; &nbsp; &nbsp;|.-----.-----.-----.|&nbsp; |&nbsp; |&nbsp; |.----.|&nbsp; |_<br /> |&nbsp; &nbsp;-&nbsp; &nbsp;||&nbsp; _&nbsp; |&nbsp; -__|&nbsp; &nbsp; &nbsp;||&nbsp; |&nbsp; |&nbsp; ||&nbsp; &nbsp;_||&nbsp; &nbsp;_|<br /> |_______||&nbsp; &nbsp;__|_____|__|__||________||__|&nbsp; |____|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |__| W I R E L E S S&nbsp; &nbsp;F R E E D O M<br /> ATTITUDE ADJUSTMENT (bleeding edge, r30857) ----------<br />&nbsp; * 1/4 oz Vodka&nbsp; &nbsp; &nbsp; Pour all ingredients into mixing<br />&nbsp; * 1/4 oz Gin&nbsp; &nbsp; &nbsp; &nbsp; tin with ice, strain into glass.<br />&nbsp; * 1/4 oz Amaretto<br />&nbsp; * 1/4 oz Triple sec<br />&nbsp; * 1/4 oz Peach schnapps<br />&nbsp; * 1/4 oz Sour mix<br />&nbsp; * 1 splash Cranberry juice<br /> -----------------------------------------------------<br />root@(none): /# mount_root<br />Unlocking rootfs ...</p><p>root@(none): /# rm -r /overlay/*<br />rm: can&#039;t remove &#039;/overlay/*&#039;: No such file or directory<br />root@(none): /# rm -r /overlay/<br /><strong>root@(none): /# rm -r /overlay</strong><br />rm: can&#039;t remove &#039;/overlay&#039;: No such file or directory<br />root@(none): /# rm -r /overlay/<br />rm: can&#039;t remove &#039;/overlay&#039;: No such file or directory<br />root@(none): /# rm -r /overlay/<br />rm: can&#039;t remove &#039;/overlay&#039;: No such file or directory</p><p>root@(none): /# passwd<br />Changing password for root<br />New password:<br />Retype password:<br />Password for root changed by root</p><p>root@(none): /# rm -r /overlay<br />rm: can&#039;t remove &#039;/overlay&#039;: No such file or directory<br />root@(none): /# rm -r /overlay/<br />rm: can&#039;t remove &#039;/overlay&#039;: No such file or directory</p><p>root@(none): /# dir<br />/bin/ash: dir: not found</p><p>root@(none): /# echo *<br />bin dev etc lib mnt proc rom root sbin sys tmp usr var www</p><p>root@(none): /# cd etc<br />root@(none): /etc# cd config<br />root@(none): /etc/config# echo *<br /><strong>archive.tgz</strong> dhcp dropbear firewall network system ubootenv wireless</p><p>root@(none): /etc/config# reboot -f</p><br /><p>Connection to host lost.</p>											<p class="post-edited">(Last edited by <strong>katlivacib</strong> on 14 Mar 2012, 10:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p160785">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">johan666</div>
					<div class="post-datetime">
						14 Mar 2012, 06:42					</div>
				</div>
				<div class="post-content content">
					<p>Are you using SquashFS ?</p><p>To list files and directories (folders), use &quot;ls&quot;</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p160807">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">katlivacib</div>
					<div class="post-datetime">
						14 Mar 2012, 09:42					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>using the other one - JFss or sth.</p><p>Btw thx for advice on echo and ls. But does it have something to do with my prob?</p>											<p class="post-edited">(Last edited by <strong>katlivacib</strong> on 14 Mar 2012, 09:43)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p160812">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">eleon216</div>
					<div class="post-datetime">
						14 Mar 2012, 10:08					</div>
				</div>
				<div class="post-content content">
					<p>if you use a jffs2-image, than you don&#039;t have an overlay partition, you have just one rootfs and the only way to get back to the initial-state of the routers config is to reflash the router. Using jffs2-rootfs also means no failsafe, so I&#039;m curious how you managed to get into failsafe-mode. </p><p>btw. normally it&#039;s always better to use squashfs as rootfs, you get a better compression-rate on the fs, failsafe-mode, and the fs-overlay is fully transparent so no problems with this either.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p160817">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">katlivacib</div>
					<div class="post-datetime">
						14 Mar 2012, 11:09					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>eleon216 wrote:</cite><blockquote><p>if you use a jffs2-image, than you don&#039;t have an overlay partition, you have just one rootfs and the only way to get back to the initial-state of the routers config is to reflash the router. Using jffs2-rootfs also means no failsafe, so I&#039;m curious how you managed to get into failsafe-mode. </p><p>btw. normally it&#039;s always better to use squashfs as rootfs, you get a better compression-rate on the fs, failsafe-mode, and the fs-overlay is fully transparent so no problems with this either.</p></blockquote></div><p>So I guess I need to reflash using squashfs via FailSafe mode. Unfortunately, I don&#039;t know how.</p><p>Because after failsafe mode,&nbsp; I can only telnet. After setting passwd, I need to reboot to open SSH &amp; SCP connection. Which is my problem, can&#039;t remove old config.</p><p>But I&#039;m thinking of extracting that tgz file (See my first post, bold text) via backup archive.tgz I made, IF I CAN DO THIS via TELNET?</p>											<p class="post-edited">(Last edited by <strong>katlivacib</strong> on 14 Mar 2012, 11:29)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p160822">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						14 Mar 2012, 12:08					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>katlivacib wrote:</cite><blockquote><p>But I&#039;m thinking of extracting that tgz file (See my first post, bold text) via backup archive.tgz I made, IF I CAN DO THIS via TELNET?</p></blockquote></div><p>Telnet and SSH connections should have no difference regarding write rights etc.<br />If you have telnet access, either extract those old settings from that tgz file or alternatively use an editor (nano, vi, whatever you have installed) to edit the main network config files like /etc/config/network. You should be able to check the default contents from Openwrt source code and then edit the file manually to be identical with that.</p><p>Ps. Setting the password is not mandatory. It you have telnet access, do not set password, but use telnet to modify the settings.</p><p>Pps. I think you have not mentioned your device, so far. Knowing which device you have might enable others to give to device-specific advice.</p>											<p class="post-edited">(Last edited by <strong>hnyman</strong> on 14 Mar 2012, 12:11)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p160823">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">eleon216</div>
					<div class="post-datetime">
						14 Mar 2012, 12:08					</div>
				</div>
				<div class="post-content content">
					<p>depends on your hardware, but maybe you can flash a new image mit tftp from the bootloader (without dealing with the serial).<br />if you can telnet to the router you can use wget on the router to download a firmware-image over http or ftp to /tmp/, and than flash with &quot;sysupgrade -n &lt;firmwarefile&gt;&quot;<br />Check <a href="http://wiki.openwrt.org/toh/start">TOH</a> to find the possible options for your device.</p>											<p class="post-edited">(Last edited by <strong>eleon216</strong> on 14 Mar 2012, 12:08)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p160833">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">katlivacib</div>
					<div class="post-datetime">
						14 Mar 2012, 13:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>hnyman wrote:</cite><blockquote><div class="quotebox"><cite>katlivacib wrote:</cite><blockquote><p>But I&#039;m thinking of extracting that tgz file (See my first post, bold text) via backup archive.tgz I made, IF I CAN DO THIS via TELNET?</p></blockquote></div><p>Telnet and SSH connections should have no difference regarding write rights etc.<br />If you have telnet access, either extract those old settings from that tgz file or alternatively use an editor (nano, vi, whatever you have installed) to edit the main network config files like /etc/config/network. You should be able to check the default contents from Openwrt source code and then edit the file manually to be identical with that.</p><p>Ps. Setting the password<br /> is not mandatory. It you have telnet access, do not set password, but use telnet to modify the settings.</p><p>Pps. I think you have not mentioned your device, so far. Knowing which device you have might enable others to give to device-specific advice.</p></blockquote></div><p>This is a real encouraging reply. Thank you for that.</p><p>Yeah, I ignored to mention my HW inorder to avoid potential &quot;can&#039;t do that&quot; &quot;won&#039;t do that&quot; &quot;not possible&quot; replies. But from this point I see no conflicts or blocking thoughts about getting help.</p><p>My device is, <a href="http://wiki.openwrt.org/toh/tp-link/tl-wa701nd">http://wiki.openwrt.org/toh/tp-link/tl-wa701nd</a> (but 1.1 hw revision)</p><p>I&#039;m at work now,&nbsp; so I can&#039;t access device for at least 5 hours from now on.</p><p>I&#039;m gonna try doing &quot;tar -xf archive.tgz&quot; on etc/network/config. </p><p><span class="bbu"><strong>If that fails, can you tell me a way to pull both these files via telnet? I&#039;m a better android user than a pc-Linux one. So I guess someway of pulling is possible but I don&#039;t know if telnet supports file transfers or not.</strong></span></p><p>And I have another request,<br />Let me remind you with highlights of the file structure I&#039;m dealing with:</p><p><strong>archive.tgz</strong> dhcp dropbear firewall <strong>network</strong> system ubootenv wireless</p><p>This folder has two files worth mentioning to aid my explanation:<br />1st file: <strong>archive.tgz</strong> contains <strong>network</strong> config-file revision <span class="bbu">before</span> my last &amp; almost brutal commit.<br />2nd file: <strong>network</strong> is the corrupt-ish active config-file.</p><p>I think I may also need pure openwrt network config beforehand. Which I don&#039;t have. My archive.tgz is only the latest save (It should be a working one). </p><p><span class="bbu"><strong>Any one or any way I can get only this file in its pure form?</strong></span></p><p>Here below is the full story of the reason I started this thread <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Installed latest JFSS2 image from trunk via Web interface of TP-Link.<br />Then I wanted Luci to setup repeater-mode more easily via web interface.</p><p>To install Luci on my router, the router must be connected to internet. </p><p>Therefore, I was experimenting on this file to accept internet of my Windows-running PC (connects internet via WiFi). I adjusted it to use dhcp, deleted IP row from it. Then I enabled Internet Connection Sharing on windows machine to provide necessary settings to router.</p><p>And you can see that these attempts doesn&#039;t work out.</p>											<p class="post-edited">(Last edited by <strong>katlivacib</strong> on 14 Mar 2012, 13:26)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p160834">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">katlivacib</div>
					<div class="post-datetime">
						14 Mar 2012, 13:28					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>eleon216 wrote:</cite><blockquote><p>depends on your hardware, but maybe you can flash a new image mit tftp from the bootloader (without dealing with the serial).<br />if you can telnet to the router you can use wget on the router to download a firmware-image over http or ftp to /tmp/, and than flash with &quot;sysupgrade -n &lt;firmwarefile&gt;&quot;<br />Check <a href="http://wiki.openwrt.org/toh/start">TOH</a> to find the possible options for your device.</p></blockquote></div><p>FTP enabled on failsafe mode? In this mode, device is only telnet-able afaik. Please correct me if I&#039;m wrong.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p160838">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						14 Mar 2012, 14:16					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>katlivacib wrote:</cite><blockquote><p>My device is, <a href="http://wiki.openwrt.org/toh/tp-link/tl-wa701nd">http://wiki.openwrt.org/toh/tp-link/tl-wa701nd</a> (but 1.1 hw revision)</p></blockquote></div><p>Ok. It is an ar71xx based device, so that is the correct source branch to look for solutions:<br /><a href="https://dev.openwrt.org/browser/trunk/target/linux/ar71xx">https://dev.openwrt.org/browser/trunk/t … nux/ar71xx</a></p><p>Based on default config generation, you might try to generate new default /etc/config/network with this:<br />1) login with telnet<br />2) cd /etc/config<br />3) mv network network.faulty<br />4) /etc/uci-defaults/network</p><p>That should generate a new default /etc/config/network for you<br /><a href="https://dev.openwrt.org/browser/trunk/target/linux/ar71xx/base-files/etc/uci-defaults/network">https://dev.openwrt.org/browser/trunk/t … ts/network</a></p><p>If that works, you can then probably continue fixing other settings &amp; flashing the new version.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p160839">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">almursi</div>
					<div class="post-datetime">
						14 Mar 2012, 14:44					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>hnyman wrote:</cite><blockquote><p>4) /etc/uci-defaults/network</p></blockquote></div><p>Hi, maybe it need be (in my case I have a jffs overlay working): <br />&nbsp; </p><div class="codebox"><pre><code>/rom/etc/uci-defaults/network</code></pre></div><p>At least, over a nomal SSH console that I test it <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> (and it only work after 3, it no network file present).<br />However, the best is type &quot;df&quot; before and see all mounted file systems. Regards.</p>											<p class="post-edited">(Last edited by <strong>almursi</strong> on 14 Mar 2012, 15:00)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p160999">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">katlivacib</div>
					<div class="post-datetime">
						15 Mar 2012, 22:27					</div>
				</div>
				<div class="post-content content">
					<p>Update: None of the above worked except for using vi <img src="https://forum.openwrt.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /></p><p>Here is the log,</p><br /><p>root@(none):/# cd /etc/uci-defaults<br />root@(none):/etc/uci-defaults# ls<br />root@(none):/etc/uci-defaults#<br />root@(none):/etc/uci-defaults# cd /rom/etc/<br />/bin/ash: cd: can&#039;t cd to /rom/etc/<br />root@(none):/etc/uci-defaults# cd /rom<br />root@(none):/rom# ls<br />note<br />root@(none):/rom# etc/uci-defaults/network<br />/bin/ash: etc/uci-defaults/network: not found<br />root@(none):/rom# /rom/etc/uci-defaults/network<br />/bin/ash: /rom/etc/uci-defaults/network: not found<br />root@(none):/rom# cd /etc/config<br />root@(none):/etc/config# ls<br />archive.tgz&nbsp; dropbear&nbsp; &nbsp; &nbsp;network.modif&nbsp; &nbsp; &nbsp; ubootenv&nbsp; &nbsp; &nbsp;yetwork<br />dhcp&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;firewall&nbsp; &nbsp; &nbsp;system&nbsp; &nbsp; &nbsp; &nbsp;wireless<br />root@(none):/etc/config# vi yetwork</p><p>config interface &#039;loopback&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;lo&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr &#039;127.0.0.1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;255.0.0.0&#039;</p><p>config interface &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;eth0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option type &#039;bridge&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;dhcp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dns &#039;8.8.8.8&#039;</p><br /><p>config &#039;interface&#039; &#039;example&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;proto&#039;&nbsp; &nbsp;&#039;dhcp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;ifname&#039;&nbsp; &#039;eth0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;gateway&#039; &#039;0.0.0.0&#039;<br />~<br />~<br />~<br />~<br />root@(none):/etc/config# vi network.modif</p><br /><br /><br /><br /><br /><p>config interface &#039;loopback&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;lo&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr &#039;127.0.0.1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;255.0.0.0&#039;</p><p>config interface &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;eth0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option type &#039;bridge&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dns &#039;8.8.8.8&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr &#039;192.168.1.250&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option gateway &#039;192.168.1.1&#039;</p><br /><br /><br /><p>root@(none):/etc/config# cd /etc/config<br />root@(none):/etc/config# tar -xf archive.tgz<br />tar: short read<br />root@(none):/etc/config# mv network.modif network<br />root@(none):reboot -f<br />--</p><p>network.modif is modified network file I happen to make the device work.</p><p>Now the device is working.&nbsp; But I still can&#039;t make it access internet via my pc.</p>											<p class="post-edited">(Last edited by <strong>katlivacib</strong> on 15 Mar 2012, 22:28)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>