<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Problems with setting up guest wlan</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 22 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p346454">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">Rensch</div>
					<div class="post-datetime">
						12 Dec 2016, 14:04					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>i am trying to Setup a guest wlan, following several Howtos and Tutorials.<br />But it won´t work.<br />Ich have an TP-LINK TL-WR841N updatet with the last OPENWRT Image.</p><p>I activated WLAN and Setup an guest Net with several Firewall Rules.<br />When i connect to the &quot;normal&quot; WLAN, my Device is getting an IP and is able to visit WWW ( IP Range 192.168.2.xxx )<br />But when i connect to my guest WLAN, i will get an IP out of the Range i defined ( 192.168.66.xxx ), but it is not able to Access the Internet.</p><p>My Setup differs from all howtos, because the TP-LINK isn´t connected via the WAN Port to the WWW. It is connected via LAN1 to my LAN. It offers no DHCP Function, because this is handled by my Mainrouter. The TP-LInk is Setup as &quot;DUMB-AP&quot; as showed in the&nbsp; DUMB AP HOWTO</p><p>An Idea why my Connect to my Guest WLAN won´t me let to Access Internet ??</p><p>Actual i am at work so i can´t provide any Settings</p><p>So Long<br />Rensch</p>											<p class="post-edited">(Last edited by <strong>Rensch</strong> on 12 Dec 2016, 14:35)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346458">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">eduperez</div>
					<div class="post-datetime">
						12 Dec 2016, 14:51					</div>
				</div>
				<div class="post-content content">
					<p>I think we all can wait until you get home back and can post your config files here...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346496">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">Rensch</div>
					<div class="post-datetime">
						12 Dec 2016, 21:19					</div>
				</div>
				<div class="post-content content">
					<p>well.<br />as i am not allowed to post Links ....<br />I will post the link to the pictures.<br />xttp://up.picr.de/27701114vm.jpg<br />xttp://up.picr.de/27701115yg.jpg<br />xttp://up.picr.de/27701116uu.jpg<br />xttp://up.picr.de/27701117iy.jpg<br />xttp://up.picr.de/27701118bq.jpg</p><p>Sorry About this, but everytime i want to add the links, an error occured saying<br /></p><div class="quotebox"><blockquote><p>Too more links in message. Allowed 0 links. Reduce number of links and post it again.</p></blockquote></div><p>I hope somebody is able to help me.</p><p>Ok. Here some files</p><p>/etc/wireless<br /></p><div class="quotebox"><blockquote><p>config wifi-device &#039;radio0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option type &#039;mac80211&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option hwmode &#039;11g&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option path &#039;platform/qca953x_wmac&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option htmode &#039;HT20&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option txpower &#039;19&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option country &#039;US&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option channel &#039;1&#039;</p><p>config wifi-iface<br />&nbsp; &nbsp; &nbsp; &nbsp; option device &#039;radio0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option network &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option mode &#039;ap&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ssid &#039;PR&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option encryption &#039;psk&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option key &#039;mysecretword&#039;</p><p>config wifi-iface<br />&nbsp; &nbsp; &nbsp; &nbsp; option device &#039;radio0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option mode &#039;ap&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ssid &#039;PR_Gast&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option network &#039;guest&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option encryption &#039;psk2&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option key &#039;guestsecredword&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option isolate &#039;1&#039;</p></blockquote></div><p>/etc/firewall</p><div class="quotebox"><blockquote><p>config defaults<br />&nbsp; &nbsp; &nbsp; &nbsp; option syn_flood &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option input &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option output &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option forward &#039;REJECT&#039;</p><p>config zone<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option input &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option output &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option forward &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option network &#039;lan&#039;</p><p>config zone<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option input &#039;REJECT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option output &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option forward &#039;REJECT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option masq &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option mtu_fix &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option network &#039;wan wan6&#039;</p><p>config forwarding<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest &#039;wan&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;Allow-DHCP-Renew&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;udp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest_port &#039;68&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option family &#039;ipv4&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;Allow-Ping&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;icmp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option icmp_type &#039;echo-request&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option family &#039;ipv4&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;Allow-IGMP&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;igmp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option family &#039;ipv4&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;Allow-DHCPv6&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;udp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src_ip &#039;fe80::/10&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src_port &#039;547&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest_ip &#039;fe80::/10&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest_port &#039;546&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option family &#039;ipv6&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;</p></blockquote></div><p>/etc/network</p><div class="quotebox"><blockquote><p>config interface &#039;loopback&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;lo&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr &#039;127.0.0.1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;255.0.0.0&#039;</p><p>config globals &#039;globals&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ula_prefix &#039;fdb5:f188:26de::/48&#039;</p><p>config interface &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;eth0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option type &#039;bridge&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option _orig_ifname &#039;eth0 wlan0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option _orig_bridge &#039;true&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr &#039;192.168.2.44&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option gateway &#039;192.168.2.1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dns &#039;8.8.8.8 8.8.4.4&#039;</p><p>#config interface &#039;wan&#039;</p><p>#&nbsp; &nbsp; &nbsp; &nbsp;option ifname &#039;eth1&#039;<br />#&nbsp; &nbsp; &nbsp; &nbsp;option proto &#039;dhcp&#039;</p><p>config interface &#039;wan6&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;eth1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;dhcpv6&#039;</p><p>config switch<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;switch0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option reset &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option enable_vlan &#039;1&#039;</p><p>config switch_vlan<br />&nbsp; &nbsp; &nbsp; &nbsp; option device &#039;switch0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option vlan &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option vid &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ports &#039;0 1 2 3 4&#039;</p><p>config interface &#039;guest&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option _orig_ifname &#039;radio0.network2&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option _orig_bridge &#039;false&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr &#039;192.168.66.1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option delegate &#039;0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option gateway &#039;192.168.66.1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dns &#039;192.168.2.1 8.8.4.4&#039;</p></blockquote></div>											<p class="post-edited">(Last edited by <strong>Rensch</strong> on 12 Dec 2016, 21:28)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346501">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">ulmwind</div>
					<div class="post-datetime">
						12 Dec 2016, 22:06					</div>
				</div>
				<div class="post-content content">
					<p><strong>Rensch</strong>, I can&#039;t understand, how dumb access point could manage more than one network. How do you represent it?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346502">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">Rensch</div>
					<div class="post-datetime">
						12 Dec 2016, 22:12					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>i tried blog.doenselmann.com/gaeste-wlan-auf-openwrt-access-point/ Where KLICK is written, thats the way to dump AP<br />and there is a link to the dump AP howto. So i thought it woould be ok.</p><p>Is the DUMP AP the wrong way to setup guest wlan ??</p>											<p class="post-edited">(Last edited by <strong>Rensch</strong> on 12 Dec 2016, 22:13)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346503">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">ulmwind</div>
					<div class="post-datetime">
						12 Dec 2016, 22:17					</div>
				</div>
				<div class="post-content content">
					<p>Sorry, I didn&#039;t know Deutsch.</p><p>To my mind yes, let&#039;s wait somebody to approve or disprove it.</p><p>Understand, that dumb access point operates as bridge, it can&#039;t route traffic. So for two networks it should be &quot;double&quot; AP, but which device will route both networks?</p>											<p class="post-edited">(Last edited by <strong>ulmwind</strong> on 12 Dec 2016, 22:19)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346504">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">Rensch</div>
					<div class="post-datetime">
						12 Dec 2016, 22:21					</div>
				</div>
				<div class="post-content content">
					<p>well.... it is brigding thats right.<br />will it be possible when i create a VLAN ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346505">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">ulmwind</div>
					<div class="post-datetime">
						12 Dec 2016, 22:23					</div>
				</div>
				<div class="post-content content">
					<p>I think yes, if your AP will serve two networks. Which device will route two networks, you haven&#039;t answered?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346507">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">Rensch</div>
					<div class="post-datetime">
						12 Dec 2016, 22:27					</div>
				</div>
				<div class="post-content content">
					<p>well.<br />The TP-Link should provide the two networks.<br />my home WLAN which ist 192.168.2.0/24 and the guest wlan in 192.168.3.0/24.<br />But the guests are only allowed to surf in the internet.<br />The Main Router is a Speedport Hybrid from German Telekom providing DHCP for 192.168.2.xxx</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346509">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">ulmwind</div>
					<div class="post-datetime">
						12 Dec 2016, 22:27					</div>
				</div>
				<div class="post-content content">
					<p>In your configuration there is no router for 192.168.3.X network, as you see.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346511">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">Rensch</div>
					<div class="post-datetime">
						12 Dec 2016, 22:30					</div>
				</div>
				<div class="post-content content">
					<p>the openwrt router should provide the 192.168.3.xxx. At the moment he is providing DHCP via Guest WLAN in 192.168.3.xxx. But nobody out of this IP Pool is able to access to internet</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346512">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">ulmwind</div>
					<div class="post-datetime">
						12 Dec 2016, 22:31					</div>
				</div>
				<div class="post-content content">
					<p>It is already case of <strong>ROUTER</strong>, not <strong>DUMB ACCESS POINT</strong>.</p>											<p class="post-edited">(Last edited by <strong>ulmwind</strong> on 12 Dec 2016, 22:31)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346513">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">Rensch</div>
					<div class="post-datetime">
						12 Dec 2016, 22:33					</div>
				</div>
				<div class="post-content content">
					<p>mh...<br />think i tried the wrong setup haven´t i ??<br />Which configuration would be the right one ??<br />i am a little bit confused <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346514">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">ulmwind</div>
					<div class="post-datetime">
						12 Dec 2016, 22:45					</div>
				</div>
				<div class="post-content content">
					<p>As far as I&#039;ve understood, you need following configuration of OpenWRT router:<br /></p><ol class="decimal"><li><p>Guest WLAN 192.168.3.X, <strong>router</strong> to WAN=192.168.2.2, e.g.</p></li><li><p>Normal WLAN as <strong>dumb AP</strong> to bridge to the same WAN=192.168.2.2</p></li></ol>											<p class="post-edited">(Last edited by <strong>ulmwind</strong> on 12 Dec 2016, 22:45)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346519">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						12 Dec 2016, 23:33					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m not really trying to sort out what has been done, but trying to make sure you are on the right road.<br />There is a wiki for a dumb AP here:&nbsp; <a href="https://wiki.openwrt.org/doc/recipes/dumbap">https://wiki.openwrt.org/doc/recipes/dumbap</a><br />Strongly suggest you set a static IP on the AP device in the subnet of your main router or you may not be able to access it if the main router is unavailable.&nbsp; This can be done in Luci.</p><p>The Guest LAN is NOT just a second SSID on the dumb AP.&nbsp; There are 2 Wikis (CLI and Luci)<br /><a href="https://wiki.openwrt.org/doc/recipes/guest-wlan">https://wiki.openwrt.org/doc/recipes/guest-wlan</a><br /><a href="https://wiki.openwrt.org/doc/recipes/guest-wlan-webinterface">https://wiki.openwrt.org/doc/recipes/gu … binterface</a> </p><p>Configuring the Guest on an AP, as opposed to the router, is more complex and uses VLANs.&nbsp; See about half way down on the first link: Multiple network devices.&nbsp; I have not done this config.</p>											<p class="post-edited">(Last edited by <strong>RangerZ</strong> on 12 Dec 2016, 23:50)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346521">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						12 Dec 2016, 23:56					</div>
				</div>
				<div class="post-content content">
					<p>OK, I just translated <a href="https://blog.doenselmann.com/gaeste-wlan-auf-openwrt-access-point/">https://blog.doenselmann.com/gaeste-wla … ess-point/</a></p><p>This approach is different than the OpenWrt Wiki, and is actually more like the DD-Wrt approach which sets up a new DHCP server on the AP just for the guest LAN.&nbsp; This is probably a better approach for many users as the main router may not be an OpenWrt device and managing the VLAN may not be feasible.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346559">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">Rensch</div>
					<div class="post-datetime">
						13 Dec 2016, 09:34					</div>
				</div>
				<div class="post-content content">
					<p>RangerZ : why are you allowed to post links <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> ?<br />Well as i understand your post ( #15 ), i will have to Setup first the guest wlan via LUCI and then i have to edit the config files via Shell ?<br />Some years ago i installed an raspberry Pi working as an AP with bridged LAN. But this is using a Shell Script.</p><div class="codebox"><pre><code>#!/bin/bash
## Instant WLAN Access-Point an Ethernet Router with transparent bridged interfaces and VLAN
## (WLAN-Guest Accesspoint)
## for Raspberry Pi™ with Raspian and other Linux based Systems
##
## elektronenblitz63 ubuntuusers.de 2013
## published under GPL v3
##
## Version 1.7.1.5bvw / 17. Oktober 2013
##
## have fun :-)

## freie Variablen

## Source-Interface / WAN-Schnittstelle
## durch die interfaces gesteuerte Schnittstelle für die Internetverbindung
## Bezeichnung ggf. anpassen
## Standard eth0 / Ethernet
sourceiface=eth0

## Bridge-Konfiguration
bridgeiface=br0
forward_delay=2
stp=1
brageing=10000
brage=40

braddress=192.168.178.6
brbroadcast=192.168.178.255
brnetmask=255.255.255.0
briptablemasq=192.168.178.0/24

## IP-Adresse des Routers/Gateway
wangateway=192.168.178.1

## manuelle DNS-Konfiguration aktiviert (1) oder deaktiviert (0) (Standard)
manDNS=0

# manuelle DNS-Konfiguration
sys_domain=&quot;domain fritz.box&quot;
sys_search=&quot;search fritz.box&quot;
sys_dns0=&quot;nameserver 192.168.178.1&quot;

## optional DNS 2 &amp; 3 aktivieren
## Beispiel
# sys_dns1=&quot;nameserver 8.8.4.4&quot;
# sys_dns2=&quot;nameserver 8.8.8.8&quot;
sys_dns1=&quot;&quot;
sys_dns2=&quot;&quot;

## Konfiguration der WLAN-Schnittstelle, die den Accesspoint erzeugt
## Bezeichnung ggf. anpassen
wlaniface=wlan0

## Konfiguration der virtuellen WLAN-Schnittstelle 
## Bezeichnung ggf. anpassen
vlaniface=wlan1
vaddress=192.168.3.1
vbroadcast=192.168.3.255
vnetmask=255.255.255.0
viptablemask=192.168.3.0/24

## dnsmasq-base Konfiguration
## Start- Endadresse / lease
vlan_startaddress=192.168.3.10
vlan_endaddress=192.168.3.15
vlan_leasetime=infinite

## Konfiguration der zweiten lokalen LAN-Schnittstelle
## Bezeichnung ggf. anpassen
locallan=eth1

## lokales LAN aktivieren (1), oder nicht (0)
## abschalten, sollte keine zweite Ethernetschnittstelle vorhanden sein
locallan_on=0

## erste WLAN-Schnittstelle wlan0
wlan_modul=&quot;carl9170&quot;

# WLAN tx power in dBm wlan0
txpower=15

## WLAN-Interface 2 virtuell (0) oder physikalisch (zweiter WLAN-Adapter) (1)
second_phy=0

## zweite  WLAN-Schnittstelle wlan1 (0ptional)
## nur wirksam bei second_phy=1
wlan_modul2=&quot;rt2800usb&quot;

# Sendeleistung für WLAN-Adapter 2 (wlan1) einstellen 
# nur bei zweitem WLAN-Adapter wirksam
# tx power in dBm
txpower2=15

## Regionseinstellung
regcode=&quot;DE&quot;
regdelay=3

# Lease-Time DHCP-Server dnsmasq_base für das Gastnetzwerk (wlan1)
leasetime=infinite

## Steuerung hostapd Schnittstelle wlan0
hostapdservice=&quot;hostapd -B&quot;
hostapdconf=&quot;/etc/hostapd_vlan.conf&quot;

## Konfigurationsdatei hostapd Schnittstelle wlan1 (optional)
## nur wirksam bei second_phy=1
hostapdconf1=&quot;/etc/hostapd_vlan1.conf&quot;

## Iptables-Filter bei Programmende löschen
# Standard=1
# bei pppoe-Verbindungen oder Bridge-Konfiguration auf 0 setzen
delfilter=1

## zeige Konfiguration nach Ablauf des Skripts (1/0)
showconfig=1

## Ende freie Variablen

# Skript

if [ &quot;$1&quot; = &quot;-h&quot; ]; then
echo Verwendung: instant_AP-bridge.sh [-start] [-stop] [-h]
echo Syntax:
echo &quot;sudo ./instant_AP-bridge_vWLAN.sh -start startet den AP&quot;
echo &quot;sudo ./instant_AP-bridge_vWLAN.sh -stop beendet die Konfiguration und schließt den AP&quot;
echo &quot;sudo ./instant_AP-bridge_vWLAN.sh beendet die Konfiguration und schließt den AP&quot;
echo &quot;Ende&quot;
 exit
fi

echo -e &quot;Konfiguration ausführen ...\n&quot;

# Konfiguration löschen, Dienste stoppen
sleep 1
 service hostapd stop
  /usr/bin/killall hostapd
   /usr/bin/killall dnsmasq squid
    /bin/rm -f /var/run/hostapd/$wlaniface
     /bin/rm -f /var/run/hostapd/$wlaniface1
      /usr/bin/killall dnsmasq wpa_supplicant wpa_cli wpa_action
       /sbin/sysctl -w net.ipv4.ip_forward=0
      
## Bridge löschen
echo &quot;lösche Bridge und Konfiguration ...&quot;
/sbin/ifconfig br0 down
 /sbin/brctl delif $bridgeiface $sourceiface
  /sbin/brctl delif $bridgeiface $locallan
   /sbin/ifconfig $bridgeiface down
    /sbin/brctl delbr $bridgeiface
   
echo &quot;entferne WAN-Konfiguration ...&quot; 
 /sbin/ifconfig $sourceiface 0.0.0.0   
  sleep 1
   /sbin/ifconfig $sourceiface down  
   
echo &quot;entferne WLAN-Konfiguration ...&quot;
  /sbin/iwconfig $wlaniface mode managed
   sleep 1
    /sbin/ifconfig $wlaniface 0.0.0.0
     sleep 1
      /sbin/ifconfig $wlaniface down
       sleep 1

if [ &quot;$delfilter&quot; = &quot;1&quot; ]; then
 echo &quot;lösche iptables-Filter ...&quot;
 /sbin/iptables -F
  /sbin/iptables -X
   /sbin/iptables -t nat -F
    /sbin/modprobe -rfv iptable_nat ipt_MASQUERADE xt_conntrack iptable_filter   
fi

echo &quot;Router &amp; WLAN Access-Point Konfiguration beendet.&quot;

if [ &quot;$1&quot; != &quot;-start&quot; ]; then
 echo &quot;stoppe alle Dienste, und Verbindungen ...&quot;
  exit
 fi

## start Konfiguration
echo -e &quot;Starte alle Dienste, und Verbindungen ...\n&quot;


## reintialisiere WLAN-Adapter
 echo &quot;WLAN-Treibermodul Adapter 1: $wlan_modul&quot;
   /sbin/modprobe -rf $wlan_modul $wlan_modul2
 sleep 1
 
echo -e &quot;WLAN-Adapter 1  reinitialisieren ...\n&quot;
  /sbin/modprobe -rf $wlan_modul  
   sleep 1
    /sbin/modprobe $wlan_modul 
   sleep 1
    
## reintialisiere WLAN-Adapter 2 (optional) 
if [ &quot;$second_phy&quot; = &quot;1&quot; ]; then
 echo &quot;WLAN-Treibermodul Adapter 2: $wlan_modul2&quot;
  echo -e &quot;WLAN-Adapter 2 reinitialisieren ...\n&quot;
   /sbin/modprobe $wlan_modul2
  sleep 1
fi
    
## MAC-Adress Konfiguration wlan-Adapter 1  für hostapd
currentmacset=$(cat $hostapdconf | grep bssid) 
 currentmac=$(ifconfig $wlaniface | grep -i link | awk {&#039;print $6&#039;})
  echo &quot;erkannte MAC-Adresse des WLAN-Adapters 1:&quot; $currentmac
   sleep 1
   
echo -e &quot;ändere hostapd-Konfiguration für WLAN-Adapter 1 ($wlaniface)\n&quot;
   /bin/sed -i &quot;s/$currentmacset/bssid=$currentmac/g&quot; $hostapdconf
  
## initialize WAN-Port
 /sbin/ifconfig $sourceiface up
    sleep 1

if [ &quot;$second_phy&quot; = &quot;1&quot; ]; then    
## MAC-Adress Konfiguration wlan-Adapter 2 für hostapd
currentmacset2=$(cat $hostapdconf1 | grep bssid) 
 currentmac2=$(ifconfig $vlaniface | grep -i link | awk {&#039;print $6&#039;})
  echo &quot;erkannte MAC-Adresse des WLAN-Adapters 1:&quot; $currentmac2
   sleep 1
   
echo -e &quot;ändere hostapd-Konfiguration für WLAN-Adapter 2 ($vlaniface)\n&quot;
   /bin/sed -i &quot;s/$currentmacset2/bssid=$currentmac2/g&quot; $hostapdconf1
fi
  
## initialize WAN-Port
 /sbin/ifconfig $sourceiface up
    sleep 1

## Sendeleistung / deaktivate WLAN-Powermanagement / set Tx-Power    
echo &quot;deaktiviere Stromsparmechanismen für $wlaniface&quot;
 /sbin/iw dev $wlaniface set power_save off
  sleep 1 

echo -e &quot;setze Sendeleistung des WLAN-Adapters $wlaniface ($txpower&quot;dBm&quot;)\n&quot;
 /sbin/iwconfig $wlaniface txpower $txpower
  sleep 1

if [ &quot;$second_phy&quot; = &quot;1&quot; ]; then
echo &quot;deaktiviere Stromsparmechanismen für $vlaniface&quot;
 /sbin/iw dev $vlaniface set power_save off
  sleep 2 
  
echo -e &quot;setze Sendeleistung des WLAN-Adapters $vlaniface ($txpower2&quot;dBm&quot;)\n&quot;
 /sbin/iwconfig $vlaniface txpower $txpower2
  sleep 1
fi
  
## Regionseinstellung
echo -e &quot;setze Regionseinstellung des Systems: $regcode\n&quot;
/sbin/iw reg set $regcode
 sleep $regdelay

# aut. Dienste nach Reinitialisierung des WLAN-Adapters beenden 
/usr/bin/killall wpa_supplicant wpa_cli wpa_action ifplugd
  
## start hostapd
echo -e &quot;Starte hostapd-Service\n&quot;
 $hostapdservice $hostapdconf
  sleep 1
   echo
   
## start hostapd für WLAN-Adapter 2 (optional) 
if [ &quot;$second_phy&quot; = &quot;1&quot; ]; then
echo -e &quot;Starte hostapd-Service\n&quot;
 $hostapdservice $hostapdconf1
  sleep 1
   echo
fi
  
## Bridge konfigurieren
/sbin/brctl addif $bridgeiface $sourceiface

if [ &quot;$locallan_on&quot; = &quot;1&quot; ]; then
 /sbin/brctl addif $bridgeiface $locallan
  echo -e &quot;Ethernerschnittstelle 2 aktiviert.\n&quot;
 fi
  /sbin/brctl setfd $bridgeiface $forward_delay
   /sbin/brctl stp $bridgeiface $stp
   
## Optional aktivieren   
#    /sbin/brctl setageing $bridgeiface $brageing
#     /sbin/brctl setmaxage $bridgeiface $brage
   
## initialize Bridge-Port
echo &quot;Bridge-Schnittstelle initialisieren (statisch)&quot;
 echo -e &quot;Interface: $bridgeiface IP-Adresse: $braddress Broadcast: $brbroadcast Netzmaske: $brnetmask\n&quot;
  /sbin/ifconfig $bridgeiface $braddress broadcast $brbroadcast netmask $brnetmask
   /sbin/route add default gw $wangateway metric 0 dev $bridgeiface
    sleep 1
     /sbin/ifconfig $sourceiface up
    
## vLAN-Schnittstelle statisch konfigurieren
echo &quot;VLAN-Schnittstelle initialisieren (statisch)&quot;
 echo -e &quot;Interface: $vlaniface IP-Adresse: $vaddress Broadcast: $vbroadcast Netzmaske: $vnetmask\n&quot;
  /sbin/ifconfig $vlaniface $vaddress broadcast $vbroadcast netmask $vnetmask
   sleep 1

## Netze trennen / NAT / Ping unterbinden
/sbin/iptables -A INPUT -p icmp --icmp-type 8 -i $vlaniface -j DROP
 /sbin/iptables -t nat -A POSTROUTING -o $bridgeiface -j MASQUERADE
  /sbin/iptables -A FORWARD -i $vlaniface --dst $briptablemasq -j DROP

## Port forwarding
/sbin/sysctl -w net.ipv4.ip_forward=1    
    
## starting DHCP-Service VLAN
echo -e &quot;starte dnsmasq-base\n&quot;
 echo &quot;DHCP-Range dnsmasq-base ...&quot;
  echo -e &quot;$vlaniface Startadresse: $vlan_startaddress Endadresse: $vlan_endaddress Lease: $vlan_leasetime\n&quot;
  
/usr/sbin/dnsmasq -h -I $bridgeiface -i $vlaniface -F $vlan_startaddress,$vlan_endaddress,$vlan_leasetime 
 sleep 1  
 
echo &quot;dnsmasq - Dienstekonfiguration:&quot;
 ps aux | grep [d]ns
  echo

## DNS setzen
## verwende erkanntes Gateway
echo &quot;DNS-Konfiguration ...&quot;

if [ &quot;$manDNS&quot; = &quot;0&quot; ]; then
 echo -e &quot;nameserver&quot; $(route -n | grep UG | awk {&#039;print $2&#039;}) | tee /etc/resolv.conf
  echo
else
  echo -e &quot;$sys_domain\n$sys_search\n$sys_dns0\n$sys_dns1\n$sys_dns2&quot; | tee /etc/resolv.conf
 sleep 1
   echo
fi

## Ausgabe der aktuellen Konfiguration
if [ &quot;$showconfig&quot; = &quot;1&quot; ]; then   
 echo -e &quot;System DNS-Check und Routing:&quot;
  cat /etc/resolv.conf
   echo
    /sbin/route -n
     echo
    
echo -e &quot;Konfiguration Bridge:\n&quot;
  /sbin/ifconfig $bridgeiface | egrep &#039;Link|inet Adresse&#039;
   echo
    /sbin/brctl show
     echo
      /sbin/brctl showmacs $bridgeiface
       echo
      /sbin/brctl showstp $bridgeiface
    echo
    
echo -e &quot;Konfiguration lokales WAN:\n&quot;
  /sbin/ifconfig $sourceiface | egrep &#039;Link|inet Adresse&#039;
   echo
  
echo -e &quot;Konfiguration lokales LAN:\n&quot;
  /sbin/ifconfig $locallan | egrep &#039;Link|inet Adresse&#039;
   echo

 echo &quot;Konfiguration WLAN:&quot;
  /sbin/ifconfig $wlaniface | egrep &#039;Link|inet Adresse&#039;
   echo
    /sbin/iwconfig $wlaniface | egrep &#039;IEEE|Power|Mode&#039;
     echo      
      /sbin/iwconfig mon.$wlaniface
     
  /sbin/ifconfig $vlaniface | egrep &#039;Link|inet Adresse&#039;
   echo
    /sbin/iwconfig $vlaniface | egrep &#039;IEEE|Power|Mode&#039;
     echo      

## Ausgabe der aktuellen Konfiguration
echo -e &quot;Regionseinstellung des/der WLAN-Adapters:\n&quot;
 /sbin/iw reg get
  echo
     
echo &quot;Dienstestatus:&quot;
service hostapd status

if [ &quot;$second_phy&quot; = &quot;1&quot; ]; then
 ps aux | grep [h]ostapd
fi

else
 exit 0
fi</code></pre></div><p>Is it possible to translate this ubuntu script to openwrt ?</p><p>i think i will try the way via LUCI and Shell this evening.</p><p>How can i reset an openwrt device to factory Defaults ? Is there an reset Switch build in ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346563">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">ulmwind</div>
					<div class="post-datetime">
						13 Dec 2016, 11:39					</div>
				</div>
				<div class="post-content content">
					<p><strong>Rensch</strong>, ability to post links is granted when you have certain amount of posts.<br />There is button in LuCI to reset config to defaults, see something like &quot;System&quot;, &quot;Backup/Flash firmware&quot;.<br />It is much easier to set from &quot;blank page&quot;, than adapt Ubuntu script.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346567">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">Rensch</div>
					<div class="post-datetime">
						13 Dec 2016, 12:12					</div>
				</div>
				<div class="post-content content">
					<p>Thank you <strong>ulmwind</strong>. <br />I should have looked here before i started my Setups....</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p346805">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">Rensch</div>
					<div class="post-datetime">
						15 Dec 2016, 22:28					</div>
				</div>
				<div class="post-content content">
					<p>Its done.<br />Finally my setup works as i wanted it to work.<br />What did i do ?<br />I deleted the WAN Interface and started the setup as mentioned in the wiki &quot;setup guest wlan via luci&quot;.<br />And now it is working.:)</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>