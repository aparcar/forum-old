<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> U-Boot mod for routers with AR9331/AR9344</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 3 Apr 2015 and 7 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 25</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=43237&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=43237&amp;p=3.html">3</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=43237&amp;p=25.html">25</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p196766">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						31 Mar 2013, 15:28					</div>
				</div>
				<div class="post-content content">
					<h5>This project was moved to GitHub: <a href="https://github.com/pepe2k/u-boot_mod">github.com/pepe2k/u-boot_mod</a></h5><p><strong>Hello!</strong></p><p>I made a modification of <strong>U-Boot</strong> for <strong>TP-Link</strong> with <strong>AR9331</strong> SoC routers.</p><p>My modification is based on <a href="http://code.google.com/p/wr703n-uboot-with-web-failsafe/"><strong>wr703n-uboot-with-web-failsafe</strong></a> project (big thanks for the author for this code!) but has some improvements and other modifications.</p><p>After I found wr703n-uboot-with-web-failsafe project, I decided to start from it and make it better. Most of my work was focused on web failsafe mode - I rebuild it and now it works with all browsers and allow to upload not only firmware but also the U-Boot and ART data.</p><p><strong>Changelog:</strong></p><p><strong>Jun 19 2013</strong>:<br /></p><ul><li><p>fixed problem with booting in some cases on all supported models</p></li><li><p>support for TL-MR10U ver. 1.x (tested on ver. 1.0)</p></li><li><p>support fot TL-MR3220 ver. 2.x (tested on ver. 2.1)</p></li><li><p>support for TL-WR720N ver. 3 (only for Chinese version!)</p></li><li><p>support for new flash types/series: Macronix MX25L128 and SST 25VF064C</p></li><li><p>version for TL-WR740N v4 was tested also on TL-WR741ND ver. 4.2 (it&#039;s almost the same hardware)</p></li></ul><p><strong>Apr 22 2013</strong><br /></p><ul><li><p>support for TL-WR740N ver. 4 (tested on ver. 4.23)</p></li><li><p>NetConsole</p></li><li><p>flash recognize by JEDEC ID (please, see README for full list)</p></li><li><p>returned to instruction 0xD8 for flash erasing (64 KiB block erase)</p></li><li><p>setmac command</p></li><li><p>web pages lifting</p></li><li><p>some bugs fixed</p></li><li><p>predefined overclocking profiles in code (please, see ap121.h)</p></li></ul><p><strong>Mar 29 2013</strong><br /></p><ul><li><p>initial release</p></li></ul><br /><p><strong>Modifications/changes:</strong><br /></p><ul><li><p>faster boot up</p></li><li><p>removed unnecessary information from boot up sequence</p></li><li><p>flash chip is automatically recognized</p></li><li><p>eth interfaces MAC is now set from flash (no more &quot;No valid address in Flash. Using fixed address&quot;)</p></li><li><p>setmac option - you can change MAC address stored in flash</p></li><li><p>automatic system boot can be now interrupted by any key (no more need to type &quot;tpl&quot;)</p></li><li><p>you can run web server, U-Boot console or NetConsole by pressing the reset button (for ~3 sec. to run web mode, for ~5 sec. to get in U-Boot console or for ~7 sec. to start U-Boot NetConsole)</p></li><li><p>index.html (fw upgrade), art.html (ART upgrade), uboot.html (U-Boot upgrade)</p></li><li><p>overclocking possibilities</p></li><li><p>and other...</p></li></ul><p><strong>Supported flash chips (recognized automaticly by JEDEC ID):</strong></p><p><strong>4 MiB:</strong><br /></p><ul><li><p>Spansion S25FL032P (4 MiB, JEDEC ID: 01 0215)*</p></li><li><p>Atmel AT25DF321 (4 MB, JEDEC ID: 1F 4700)</p></li><li><p>EON EN25Q32 (4 MB, JEDEC ID: 1C 3016)*</p></li><li><p>Micron M25P32 (4 MB, JEDEC ID: 20 2016)</p></li><li><p>Windbond W25Q32 (4 MB, JEDEC ID: EF 4016)</p></li><li><p>Macronix MX25L320 (4 MB, JEDEC ID: C2 2016)</p></li></ul><p><strong>8 MiB:</strong><br /></p><ul><li><p>Spansion S25FL064P (8 MB, JEDEC ID: 01 0216)</p></li><li><p>Atmel AT25DF641 (8 MB, JEDEC ID: 1F 4800)</p></li><li><p>EON EN25Q64 (8 MB, JEDEC ID: 1C 3017)*</p></li><li><p>Micron M25P64 (8 MB, JEDEC ID: 20 2017)</p></li><li><p>Windbond W25Q64 (8 MB, JEDEC ID: EF 4017)*</p></li><li><p>Macronix MX25L640 (8 MB, JEDEC ID: C2 2017, C2 2617)</p></li><li><p>SST 25VF064C (8 MB, JEDEC ID: BF 254B)</p></li></ul><p><strong>16 MiB:</strong><br /></p><ul><li><p>Winbond W25Q128 (16 MB, JEDEC ID: EF 4018)*</p></li><li><p>Macronix MX25L128 (16 MB, JEDEC ID: C2 2018, C2 2618)</p></li></ul><p>* - tested</p><p>If you want to use other type, please contact with me or add your flash chip into ar7240_flash.c file and compile the code.</p><p><strong>U-Boot NetConsole</strong></p><p>You can use it instead of serial console. All communication is made over UDP protocol (port 6666). Example:<br /><span class="postimg"><img src="http://www.tech-blog.pl/wordpress/wp-content/uploads/2013/04/u-boot_mod_for_tp-link_with_ar9331_netconsole.jpg" alt="http://www.tech-blog.pl/wordpress/wp-content/uploads/2013/04/u-boot_mod_for_tp-link_with_ar9331_netconsole.jpg" /></span></p><p><strong>Web server</strong></p><p>Example page (index.html for firmware upload):</p><p><span class="postimg"><img src="http://www.tech-blog.pl/wordpress/wp-content/uploads/2013/04/u-boot_mod_for_tp-link_with_ar9331_indexb.jpg" alt="http://www.tech-blog.pl/wordpress/wp-content/uploads/2013/04/u-boot_mod_for_tp-link_with_ar9331_indexb.jpg" /></span></p><p>I need to warn you - for now, in web upgrade mode, there isn&#039;t any data validation!<br />So, please be very careful with U-Boot upgrade, if you choose wrong image, your router won&#039;t boot again...</p><p><strong>Bootlogs</strong></p><p>Here is an example boot log from this U-Boot version:</p><div class="codebox"><pre><code>*****************************************
*      U-Boot 1.1.4  (Apr 22 2013)      *
*****************************************
 
AP121 (AR9331) U-Boot for TL-WR740N(D)v4
 
DRAM:  32 MB
FLASH: EON EN25Q64 (8 MB)
 
LED on during eth initialization...
 
Press reset button for at least:
- 3 sec. to run web failsafe mode
- 5 sec. to run U-Boot console
- 7 sec. to run U-Boot netconsole
 
Reset button is pressed for:  6 
 
Button was pressed for 6 sec...
Starting U-Boot console...
 
uboot&gt; ?
 
?           - alias for &#039;help&#039;
boot        - boot default - run command &#039;bootcmd&#039;
bootd       - boot default, i.e., run &#039;bootcmd&#039;
bootm       - boot application image from memory
cp          - memory copy
erase       - erase FLASH memory
help        - print embedded help
httpd       - start www server for firmware recovery
md          - memory display
mm          - memory modify (auto-incrementing)
mtest       - simple RAM test
mw          - memory write (fill)
nm          - memory modify (constant address)
printenv    - print environment variables
printmac    - print MAC address stored in flash
printmodel  - print router model stored in flash
reset       - perform RESET of the CPU
run         - run commands in an environment variable
setenv      - set environment variables
setmac      - save new MAC address in flash
tftpboot    - boot image via network using TFTP protocol
version     - print U-Boot version
 
uboot&gt;</code></pre></div><p>And long version (manually web server start, request for index.html and upload OpenWrt firmware):</p><div class="codebox"><pre><code>*****************************************
*      U-Boot 1.1.4  (Apr 22 2013)      *
*****************************************
 
AP121 (AR9331) U-Boot for TL-WR740N(D)v4
 
DRAM:  32 MB
FLASH: EON EN25Q64 (8 MB)
 
LED on during eth initialization...
 
Hit any key to stop autobooting:  0 
 
uboot&gt; httpd
 
Ethernet mode (duplex/speed): 1/100 Mbps
HTTP server is starting at IP: 192.168.1.1
HTTP server is ready!
 
Request for: /
Request for: /style.css
Data will be downloaded at 0x80080000 in RAM
Upgrade type: firmware
Upload file size: 3932160 bytes
Loading: #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #######################################
         #
 
HTTP upload is done! Upgrading...
 
****************************
*    FIRMWARE UPGRADING    *
* DO NOT POWER OFF DEVICE! *
****************************
 
Executing: erase 0x9F020000 +0x3C0000; cp.b 0x80080000 0x9F020000 0x3C0000
 
Erase flash from 0x9F020000 to 0x9F3DFFFF in bank #1
Erasing: #######################################
         #####################
 
Erased sectors: 60
 
Copying to flash...
Writting at address: 0x9F020000
 
Done!
 
HTTP ugrade is done! Rebooting...</code></pre></div><p>I wrote an article about my project, but for now it is only in Polish (you can try to use Google Translator), you can find it here: <a href="http://www.tech-blog.pl/2013/03/29/zmodyfikowany-u-boot-dla-routerow-tp-link-z-atheros-ar9331-z-trybem-aktualizacji-oprogramowania-przez-www-i-konsola-sieciowa-netconsole/"><strong>Modified U-Boot for the TP-Link WR703N/MR3020/MR3040 (Atheros AR9331) with web upgrade mode</strong></a></p><p>You can download ready U-Boot images (64 KiB, for different models) from here: <a href="http://www.tech-blog.pl/pliki/u-boot_for_tp-link_AR9331_by_pepe2k.tar.gz">http://www.tech-blog.pl/pliki/u-boot_fo … e2k.tar.gz</a></p><p>If you need other version, you should compile the code (please, see Makefile in top dir and make customization which you need) or send me a pm, I will do it for you.</p><p>You can download sources code here: <a href="http://www.tech-blog.pl/pliki/u-boot_sources_for_tp-link_AR9331_by_pepe2k.tar.gz">http://www.tech-blog.pl/pliki/u-boot_so … e2k.tar.gz</a></p><p><strong>Thanks for any feedback!</strong></p>											<p class="post-edited">(Last edited by <strong>pepe2k</strong> on 24 Aug 2013, 23:20)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p196768">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">xopal</div>
					<div class="post-datetime">
						31 Mar 2013, 15:44					</div>
				</div>
				<div class="post-content content">
					<p>pepe2k thanks for your good works, I&#039;ll test it out on my router.</p>											<p class="post-edited">(Last edited by <strong>xopal</strong> on 31 Mar 2013, 15:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p197293">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">mips</div>
					<div class="post-datetime">
						5 Apr 2013, 07:26					</div>
				</div>
				<div class="post-content content">
					<p>@pepe2k:<br />Thanks you do it,that&#039;s many guys need the project that you do.<br />I will add a recommend link in the <a href="http://code.google.com/p/wr703n-uboot-with-web-failsafe/">wr703n-uboot-with-web-failsafe </a> home page.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p197331">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						5 Apr 2013, 12:19					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mips wrote:</cite><blockquote><p>@pepe2k:<br />Thanks you do it,that&#039;s many guys need the project that you do.<br />I will add a recommend link in the <a href="http://code.google.com/p/wr703n-uboot-with-web-failsafe/">wr703n-uboot-with-web-failsafe </a> home page.</p></blockquote></div><p>Thank you <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />Without your work I wouldn&#039;t even start this project!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p197617">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">pupie</div>
					<div class="post-datetime">
						8 Apr 2013, 05:48					</div>
				</div>
				<div class="post-content content">
					<p>well done! nice job! is there any chance to port this mod to support AR9344 CPU (TP-LINK 4300)?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p197634">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						8 Apr 2013, 11:02					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>pupie wrote:</cite><blockquote><p>well done! nice job! is there any chance to port this mod to support AR9344 CPU (TP-LINK 4300)?</p></blockquote></div><p>I don&#039;t have WDR4300, but I&#039;m thinking about buying WDR3600, so... maybe I will make version also for these models.</p><p>I&#039;m going to upload new version with command to change MAC under U-Boot console and with some bugs fixed (most important - erase instruction in SPI flash operation is wrong - now it uses instruction to erase 64 KiB block but the range for erase area is calculated with sector size).</p><p>I&#039;m trying also to remove version for different flash chips and make automatic flash recognition (based on JEDEC ID).</p>											<p class="post-edited">(Last edited by <strong>pepe2k</strong> on 8 Apr 2013, 11:02)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p198208">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">dabyd64</div>
					<div class="post-datetime">
						13 Apr 2013, 03:06					</div>
				</div>
				<div class="post-content content">
					<p>Any&nbsp; posibility for overclocking? Im sure those Ar9331 can run pretty faster than 400mhz <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />Very nice job pepe2k!</p>											<p class="post-edited">(Last edited by <strong>dabyd64</strong> on 13 Apr 2013, 03:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p198532">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">doiga</div>
					<div class="post-datetime">
						16 Apr 2013, 14:21					</div>
				</div>
				<div class="post-content content">
					<p>Nice!!! Great job!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p198534">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						16 Apr 2013, 14:36					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dabyd64 wrote:</cite><blockquote><p>Any&nbsp; posibility for overclocking? Im sure those Ar9331 can run pretty faster than 400mhz <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></blockquote></div><p>Yes, but... on this platform the CPU and RAM frequencies are connected together and can&#039;t be set independently. So, if you set CPU to run at 420 MHz, the RAM chip should be able to run at 210 MHz (420 MHz in DDR mode).</p><p><strong>mips</strong> in his project wr703n-uboot-with-web-failsafe was playing with different frequency settings, but only smaller than stock 400 MHz and the results weren&#039;t good if I remember. I also want to test some of the settings on MR3040 to check if underclocking can noticeably increase battery life. Maybe I will also try with overclocking <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><div class="quotebox"><cite>dabyd64 wrote:</cite><blockquote><p>Very nice job pepe2k!</p></blockquote></div><div class="quotebox"><cite>doiga wrote:</cite><blockquote><p>Nice!!! Great job!</p></blockquote></div><p>Thank you.</p><p>I&#039;m going to post new version in next 2-3 days with WR740N support, flash chip recognition and some bugs removed.<br />I&#039;m working also on version for WR1043ND and WDR3600.</p><p>This is how I tested version dedicated for WR740N <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p><span class="postimg"><img src="http://www.tech-blog.pl/wordpress/wp-content/uploads/2013/04/tp_link_tl_wr740n_flash_swapb.jpg" alt="http://www.tech-blog.pl/wordpress/wp-content/uploads/2013/04/tp_link_tl_wr740n_flash_swapb.jpg" /></span></p>											<p class="post-edited">(Last edited by <strong>pepe2k</strong> on 16 Apr 2013, 14:37)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p198539">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						16 Apr 2013, 17:08					</div>
				</div>
				<div class="post-content content">
					<p>I will be looking forward to your mod on WDR3600/WDR4300, the SoC is clocked at 560MHZ but it is clearly capable of higher performance.<br />The chip is slightly warm and not hot at all.<br />On Mikrotik Router it was default clocked at 600MHZ.<br />I tried to use TP-Link SDK to mod the uboot but it doesn&#039;t work...</p>											<p class="post-edited">(Last edited by <strong>alphasparc</strong> on 16 Apr 2013, 17:08)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p198588">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">ivanm</div>
					<div class="post-datetime">
						17 Apr 2013, 00:18					</div>
				</div>
				<div class="post-content content">
					<p>Nice work pepe2k.<br />I have two question.</p><p>Original bootloader on WR703n (TL-MR3020 ...) tests some GPIO pins levels during boot time to determine configuration. This prevents user from&nbsp; free usage of GPIOs (it has to have expected level at boot time) . Does your version of bootloader still use these GPIO values or does it ignore it?</p><p>The new 1.7 version on WR703n has different bootloader that does not initialize LAN interface properly so it needs patched firmware to deal with that. Is it safe to assume that yours bootloader performs the LAN initialization in the same way as 1.6 or lower version of wr703n?&nbsp; &nbsp;(so any firmware can be installed)</p>											<p class="post-edited">(Last edited by <strong>ivanm</strong> on 17 Apr 2013, 00:19)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p198594">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						17 Apr 2013, 01:32					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ivanm wrote:</cite><blockquote><p>Nice work pepe2k.<br />I have two question.</p><p>Original bootloader on WR703n (TL-MR3020 ...) tests some GPIO pins levels during boot time to determine configuration. This prevents user from&nbsp; free usage of GPIOs (it has to have expected level at boot time) . Does your version of bootloader still use these GPIO values or does it ignore it?</p></blockquote></div><p>No... I didn&#039;t even try to change this. I didn&#039;t know about that!<br />Do you you know which GPIOs are affected by this issue? I can try to find code responsible for this and maybe remove it.</p><p>But I&#039;m not certain if it would be possible. Maybe some of this GPIOs are used to configure RAM and aren&#039;t checked by U-Boot but are need for AR9331 hardware initialization?</p><div class="quotebox"><cite>ivanm wrote:</cite><blockquote><p>The new 1.7 version on WR703n has different bootloader that does not initialize LAN interface properly so it needs patched firmware to deal with that. Is it safe to assume that yours bootloader performs the LAN initialization in the same way as 1.6 or lower version of wr703n?&nbsp; &nbsp;(so any firmware can be installed)</p></blockquote></div><p>My version is based on <strong>mips</strong> project (<a href="http://code.google.com/p/wr703n-uboot-with-web-failsafe/">wr703n-uboot-with-web-failsafe</a>) and his version comes from original TP-Link sources... so, I think that this code is probably old (it was published on TP-Link GPL website before 1.7 version appeared on the market, I think) and not affected by this issue.</p><p>I have tested my U-Boot on WR703N 1.5 and 1.6 version (Rev 1.1 on PCB) - both are working OK and the LAN interface is initialized in U-Boot - I can make an upgrade with TFTP or using my web interface. Moreover, after upload OpenWrt AA 12.09-rc2 I can login using telnet/ssh and ping the router. So, I think that this issue isn&#039;t exist on my U-Boot version.</p><p>Please, wait for the new version of my mod if you want to use it. I&#039;m almost done with it <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Could you tell me what kind of flash does your 703N v1.7 have?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p198599">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">ivanm</div>
					<div class="post-datetime">
						17 Apr 2013, 02:16					</div>
				</div>
				<div class="post-content content">
					<p>pepe2k,&nbsp; here are my answers:</p><p>@ GPIO usage by the bootloader<br />the GPIO are discussed here: <br /> <a href="https://forum.openwrt.org/viewtopic.php?id=36471">https://forum.openwrt.org/viewtopic.php?id=36471</a><br />I&#039;ve just checked the the AR9331 datasheet, it mentiones these GPIOs used by hw initialization:<br />GPIO0 : crystal frequency 25 /40 MHz<br />GPIO1 : booting from internal ROM / Flash <br />GPIO 12/28 : external memory type (SDR, DDR, DDR2)<br />GPIO16: download firmware from USB/MDIO<br />GPIO13: USB mode device /host<br />GPIO 11: JTAG / CPU ICE<br />So it looks like it bootloader has nothing to do with at least with these GPIOs.</p><p>@ Compatibility of new bootlader with &lt;1.6 firmware<br />- it is good that yours new bootloader works with every firmware version. Once the original bootloader is replaced, people do not have to worry about original firmware version (1.7 firmware vs older).</p><p>@Could you tell me what kind of flash does your 703N v1.7 have?<br />- I still have original 4 MB. I&#039;ve ordered 16 Mbyte winbond W25Q128 as this is the only 16 MB flash in SOIC8 package that I&#039;ve found. I&#039;m planing to burn your new bootloader + MAC section (first 128 kB) and then replace original 4 MB flash with this. Remaining parts (ART, firmware can be written from bootloader).<br />For burning new 16MB flash I&#039;m planing to use Attiny microcontroller - 2 pins for uart to PC, 3 pins for SPI to serial Flash. I&#039;ve use serial flash in my previous Attiny project, so I have all the libraries (SPI flash read, erase, write). Just need to finish PC part reading or writing binary file. I&#039;ll post it when its done.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p198655">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">dimonix</div>
					<div class="post-datetime">
						17 Apr 2013, 15:32					</div>
				</div>
				<div class="post-content content">
					<p>pepe2k, <br />especially look at <a href="https://forum.openwrt.org/viewtopic.php?pid=192866#p192866">this</a> post from Dioptimizer.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p198660">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						17 Apr 2013, 16:05					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ivanm wrote:</cite><blockquote><p>pepe2k,&nbsp; here are my answers:</p><p>@ GPIO usage by the bootloader<br />the GPIO are discussed here: <br /> <a href="https://forum.openwrt.org/viewtopic.php?id=36471">https://forum.openwrt.org/viewtopic.php?id=36471</a><br />I&#039;ve just checked the the AR9331 datasheet, it mentiones these GPIOs used by hw initialization:<br />GPIO0 : crystal frequency 25 /40 MHz<br />GPIO1 : booting from internal ROM / Flash <br />GPIO 12/28 : external memory type (SDR, DDR, DDR2)<br />GPIO16: download firmware from USB/MDIO<br />GPIO13: USB mode device /host<br />GPIO 11: JTAG / CPU ICE<br />So it looks like it bootloader has nothing to do with at least with these GPIOs.</p></blockquote></div><p>Yes, on page 81 in datasheet there is a BOOT_STRAP register description. This register is set mostly by the status on those GPIOs, as I can see. I&#039;m not familiar with this platform, so most informations are my speculations from code and datasheet, like everyone here <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>But, the GPIOs which aren&#039;t used to initialize the hardware can be use as an input or output, I think.<br />In U-Boot code there is a function which initialize GPIOs - it operates on GPIO_OE register (page 65 in datasheet).</p><p><a href="http://imageshack.us/photo/my-images/339/20130417144515.jpg/"><span class="postimg"><img src="http://img339.imageshack.us/img339/7206/20130417144515.jpg" alt="http://img339.imageshack.us/img339/7206/20130417144515.jpg" /></span></a>&nbsp; Uploaded with <a href="http://imageshack.us">ImageShack.us</a></p><p>As you can see, bits 0...29 can be set as 1 (related GPIO will work as an output) or 0 (input functionality).<br />I use this register to enable GPIOs for LED functioning in U-Boot, like in this fragment (initialize output for LEDs in MR3020):</p><div class="codebox"><pre><code>#ifdef CONFIG_PID_MR302001

    /* LED&#039;s GPIOs on MR3020:
     *
     * 0    =&gt; WLAN
     * 17    =&gt; ETH
     * 26    =&gt; WPS
     * 27    =&gt; INTERNET
     *
     */

    /* set OE, added by zcf, 20110509 */
    ar7240_reg_wr(AR7240_GPIO_OE, (ar7240_reg_rd(AR7240_GPIO_OE) | 0xC020001));

    /* Disable clock obs, added by zcf, 20110509 */
    // TODO: ????
    //ar7240_reg_wr (AR7240_GPIO_FUNC, (ar7240_reg_rd(AR7240_GPIO_FUNC) &amp; 0xffe7e07f));
#endif</code></pre></div><p>0xC020001 =&gt; 1 set on bits 0, 17, 26, 27.</p><div class="quotebox"><cite>dimonix wrote:</cite><blockquote><p>pepe2k, <br />especially look at <a href="https://forum.openwrt.org/viewtopic.php?pid=192866#p192866">this</a> post from Dioptimizer.</p></blockquote></div><p>Yes, I found it in the code, but in my opinion there was a mistake or missing code, I couldn&#039;t understand some instructions... I change some of the code which operates on those registers (GPIO_FUNCTION1, BOOT_STRAP, GPIO_OE) based on information from datasheet. Please, refer to ap121.c file in my U-Boot mod sources.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p198938">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">dimonix</div>
					<div class="post-datetime">
						19 Apr 2013, 17:55					</div>
				</div>
				<div class="post-content content">
					<p>@pepe2k<br />from <a href="https://forum.openwrt.org/viewtopic.php?id=38777">this</a> thread I understand, that overclocking ar71xx platform is possible, and 800/400/200 even runs stable ... It would be good to have this as a build option for your u-boot.</p>											<p class="post-edited">(Last edited by <strong>dimonix</strong> on 20 Apr 2013, 10:02)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p198943">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						19 Apr 2013, 18:15					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dimonix wrote:</cite><blockquote><p>@pepe2k<br />from <a href="https://forum.openwrt.org/viewtopic.php?id=38777">this</a> thread I understand, that overclocking ar71xx platform is possible, and 800/400/200 even runs stable ... It would be good to have this as a build option for you u-boot.</p></blockquote></div><p>Yes, I didn&#039;t say that it isn&#039;t possible. But... AR9331 is different from AR7161 (mentioned in topic which you pointed).<br />I found some information about PLL configuration in AR9331 datasheet. Maybe I will try to play with them.</p><p>Small sneak peak from new version:</p><p>Netconsole (U-Boot console over UDP datagrams):<br /><span class="postimg"><img src="http://www.tech-blog.pl/wordpress/wp-content/uploads/2013/04/uboot_netconsole_prev.jpg" alt="http://www.tech-blog.pl/wordpress/wp-content/uploads/2013/04/uboot_netconsole_prev.jpg" /></span></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p198969">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						19 Apr 2013, 23:00					</div>
				</div>
				<div class="post-content content">
					<p>OK, I think I know how to overclock this platform... I need to make more test but for now I know how to change (and which ones) registers to manipulate with clocks up and down.</p><p>412,5 MHz:</p><div class="codebox"><pre><code>[    0.000000] Linux version 3.3.8 (blogic@Debian-60-squeeze-64-minimal) (gcc version 4.6.3 20120201 (prerelease) (Linaro GCC 4.6-2012.02) ) #1 Sat Mar 23 16:49:30 UTC 2013
[    0.000000] bootconsole [early0] enabled
[    0.000000] CPU revision is: 00019374 (MIPS 24Kc)
[    0.000000] SoC: Atheros AR9330 rev 1
[    0.000000] Clocks: CPU:412.500MHz, DDR:412.500MHz, AHB:206.250MHz, Ref:25.000MHz</code></pre></div><p>425 MHz:</p><div class="codebox"><pre><code>[    0.000000] Linux version 3.3.8 (blogic@Debian-60-squeeze-64-minimal) (gcc version 4.6.3 20120201 (prerelease) (Linaro GCC 4.6-2012.02) ) #1 Sat Mar 23 16:49:30 UTC 2013
[    0.000000] bootconsole [early0] enabled
[    0.000000] CPU revision is: 00019374 (MIPS 24Kc)
[    0.000000] SoC: Atheros AR9330 rev 1
[    0.000000] Clocks: CPU:425.000MHz, DDR:425.000MHz, AHB:212.500MHz, Ref:25.000MHz</code></pre></div><p>LAN, WiFi, UART... everything seems to work OK. But I need to make some stability tests <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>437,5 MHz is the limit... for now <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />I don&#039;t know weather it is a CPU or a RAM problem.</p><div class="codebox"><pre><code>[    0.000000] Linux version 3.3.8 (blogic@Debian-60-squeeze-64-minimal) (gcc version 4.6.3 20120201 (prerelease) (Linaro GCC 4.6-2012.02) ) #1 Sat Mar 23 16:49:30 UTC 2013
[    0.000000] bootconsole [early0] enabled
[    0.000000] CPU revision is: 00019374 (MIPS 24Kc)
[    0.000000] SoC: Atheros AR9330 rev 1
[    0.000000] Clocks: CPU:437.500MHz, DDR:437.500MHz, AHB:218.750MHz, Ref:25.000MHz
...
[    1.430000] Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0)</code></pre></div><p>OK, it was a RAM problem <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />Testing next CPU frequencies...</p><div class="codebox"><pre><code>[    0.000000] Linux version 3.3.8 (blogic@Debian-60-squeeze-64-minimal) (gcc version 4.6.3 20120201 (prerelease) (Linaro GCC 4.6-2012.02) ) #1 Sat Mar 23 16:49:30 UTC 2013
[    0.000000] bootconsole [early0] enabled
[    0.000000] CPU revision is: 00019374 (MIPS 24Kc)
[    0.000000] SoC: Atheros AR9330 rev 1
[    0.000000] Clocks: CPU:437.500MHz, DDR:218.750MHz, AHB:218.750MHz, Ref:25.000MHz</code></pre></div><p>450 MHz (seems to be stable with RAM at 225 MHz DDR):</p><div class="codebox"><pre><code>[    0.000000] Linux version 3.3.8 (blogic@Debian-60-squeeze-64-minimal) (gcc version 4.6.3 20120201 (prerelease) (Linaro GCC 4.6-2012.02) ) #1 Sat Mar 23 16:49:30 UTC 2013
[    0.000000] bootconsole [early0] enabled
[    0.000000] CPU revision is: 00019374 (MIPS 24Kc)
[    0.000000] SoC: Atheros AR9330 rev 1
[    0.000000] Clocks: CPU:450.000MHz, DDR:225.000MHz, AHB:225.000MHz, Ref:25.000MHz</code></pre></div><p>562,5 MHz (USB stopped working... AHB with divider = 4, RAM with divider = 2):<br /></p><div class="codebox"><pre><code>[    0.000000] Linux version 3.3.8 (blogic@Debian-60-squeeze-64-minimal) (gcc version 4.6.3 20120201 (prerelease) (Linaro GCC 4.6-2012.02) ) #1 Sat Mar 23 16:49:30 UTC 2013
[    0.000000] bootconsole [early0] enabled
[    0.000000] CPU revision is: 00019374 (MIPS 24Kc)
[    0.000000] SoC: Atheros AR9330 rev 1
[    0.000000] Clocks: CPU:562.500MHz, DDR:281.250MHz, AHB:140.625MHz, Ref:25.000MHz
...
[  104.780000] usb 1-1: new high-speed USB device number 2 using ehci-platform
[  106.040000] CPU 0 Unable to handle kernel paging request at virtual address 00100104, epc == 832035b4, ra == 83204a0c
[  106.040000] Oops[#1]:
...
[  106.300000] Kernel panic - not syncing: Fatal exception in interrupt</code></pre></div><p>OK, <strong>562,5 MHz</strong> is the maximum CPU frequency which the device boots on (U-Boot and OpenWrt AA with Luci).</p><p>The LAN, WLAN and UART on this frequency works but not the USB (don&#039;t know why and how to change it).<br />I didn&#039;t make any stress tests to check stability, I think that at 450~500 MHz could be stable but RAM and AHB clocks need to be lowered.</p><p>Time to sleep <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>											<p class="post-edited">(Last edited by <strong>pepe2k</strong> on 21 Apr 2013, 00:34)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p199196">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">xopal</div>
					<div class="post-datetime">
						22 Apr 2013, 10:05					</div>
				</div>
				<div class="post-content content">
					<p>@pepe2k</p><p>How did you do for OC the cpu , from openwrt kernel or u-boot ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p199197">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						22 Apr 2013, 10:20					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>xopal wrote:</cite><blockquote><p>@pepe2k</p><p>How did you do for OC the cpu , from openwrt kernel or u-boot ?</p></blockquote></div><p>In U-Boot. I posted my results and how-to on our polish forum: <a href="http://openrouter.info/forum/viewtopic.php?f=18&amp;t=2490">http://openrouter.info/forum/viewtopic. … amp;t=2490</a> (you can use translator: <a href="http://translate.google.com/translate?hl=pl&amp;sl=auto&amp;tl=en&amp;u=http%3A%2F%2Fopenrouter.info%2Fforum%2Fviewtopic.php%3Ff%3D18%26t%3D2490">http://translate.google.com/translate?h … 26t%3D2490</a>).</p><p>I&#039;m very busy now, so I will make translation later.</p><p>I don&#039;t know if there is a possibility to simply change CPU/RAM/AHB frequency values in kernel, during runtime. In U-Boot code there is a PLL initialization section (hornet_pll_init.S) written in assembler which is responsible for setting these values (it&#039;s a part of bootstrap code, executed before the U-Boot reallocates to RAM, I think).</p><p>I&#039;m going to publish my modified U-Boot sources with options to compile using different CPU/RAM/AHB frequency settings:<br />CFG_PLL_400_400_200<br />CFG_PLL_412_412_206<br />CFG_PLL_425_425_212<br />CFG_PLL_500_250_250<br />CFG_PLL_562_281_140<br />CFG_PLL_525_262_131</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p199218">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">dimonix</div>
					<div class="post-datetime">
						22 Apr 2013, 16:18					</div>
				</div>
				<div class="post-content content">
					<p><strong>@pepe2k</strong>,<br />do you think if it&#039;s possible to increase CPU clock without touching RAM/AHB?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p199219">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						22 Apr 2013, 16:30					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dimonix wrote:</cite><blockquote><p><strong>@pepe2k</strong>,<br />do you think if it&#039;s possible to increase CPU clock without touching RAM/AHB?</p></blockquote></div><p>I don&#039;t think so... maybe if you change oscillator from 25 MHz to 40 MHz?</p><p>The problem is in the available PLL dividers for CPU, RAM and AHB frequencies: only 1, 2, 3 and 4. All three clocks are generated from one base frequency (PLL) so the available options are very limited. I couldn&#039;t boot the device with PLL higher than 1125/2 MHz and with some other frequency sets like: CPU/RAM/AHB 550/275/275.</p><p>BTW. I don&#039;t know if I correctly understood PLL/CLOCK registers so maybe someone should also check and test my info.</p>											<p class="post-edited">(Last edited by <strong>pepe2k</strong> on 23 Apr 2013, 12:29)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p199242">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">dimonix</div>
					<div class="post-datetime">
						22 Apr 2013, 19:33					</div>
				</div>
				<div class="post-content content">
					<p>PLL clock - 800 MHz (multiplier 32)<br />CPU divider - 1 (800MHz)<br />RAM divider - 2 (400MHz)<br />AHB divider - 4 (200MHz)<br />Does it look reasonable?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p199306">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						23 Apr 2013, 11:21					</div>
				</div>
				<div class="post-content content">
					<p>Could you document how to modify the assembly for overclocking? Can&#039;t understand mips assembly.<br />Thanks.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p199317">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">pepe2k</div>
					<div class="post-datetime">
						23 Apr 2013, 12:24					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dimonix wrote:</cite><blockquote><p>PLL clock - 800 MHz (multiplier 32)<br />CPU divider - 1 (800MHz)<br />RAM divider - 2 (400MHz)<br />AHB divider - 4 (200MHz)<br />Does it look reasonable?</p></blockquote></div><p>I don&#039;t think that this CPU will work with 2x higher clock... <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>PLL = (25 MHz * DIV_INT) / 2^OUTDIV</p><p>So, with OUTDIV = 1 (default value) we have:</p><p>PLL = (25 MHz * DIV_INT) / 2</p><p>To achieve PLL = 800 MHz, you will need to have DIV_INT = 64. I couldn&#039;t increase it higher than 45...<br />I tried also to change the OUTDIV from 1 to 0 but it didn&#039;t work. Also, with CPU &gt; 525 MHz, the USB stopped working.</p><p>CPU = PLL / CPU_POST_DIV<br />DDR = PLL / DDR_POST_DIV<br />AHB = PLL / AHB_POST_DIV</p><p>For now, in my opinion overclocking this platform doesn&#039;t make any sense until someone find out how to increase CPU clock without touching RAM and AHB clocks which I think... isn&#039;t possible. I&#039;m thinking rather about underclocking and decreasing power consumption.</p><p>BTW. As I said, these are just my guesses and the equations may be wrong.</p><div class="quotebox"><cite>alphasparc wrote:</cite><blockquote><p>Could you document how to modify the assembly for overclocking? Can&#039;t understand mips assembly.<br />Thanks.</p></blockquote></div><p>I don&#039;t understand it too! <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>I have just uploaded new version of my U-Boot modification (first post is up to date). Just download sources and look into &quot;u-boot/include/configs/ap121.h&quot; file. I made there a lot of comments about PLL/CLOCK registers and their values.</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 25</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=43237&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=43237&amp;p=3.html">3</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=43237&amp;p=25.html">25</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>