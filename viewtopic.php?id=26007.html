<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> extract vmlinux from an lzma-compressed MIPS kernel image</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 12 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p114603">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">Xander</div>
					<div class="post-datetime">
						6 Aug 2010, 17:11					</div>
				</div>
				<div class="post-content content">
					<p>Hi All!</p><p>subj. Please tell me how would one uncompress an lzma-compressed MIPS kernel image?<br />I have a firmware image for Draytek VigorFly 200 and it&#039;s actually an uboot image with a Linux kernel image inside. I want to uncompress it to have a sure proof of a GPL violation.<br />This is not directly related to OpenWrt (at the moment at least). But still maybe someone can help me? Is there any easy way without disassembling?</p><p>FW image is here: <a href="http://news.atg.ru/content/vigorfly200_r836_103YotaRC2.7z">http://news.atg.ru/content/vigorfly200_ … YotaRC2.7z</a></p><p>uboot header states that it contains a Linux kernel image for MIPS with compression method 3 (which I believe to be lzma).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p114736">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">lly</div>
					<div class="post-datetime">
						8 Aug 2010, 15:50					</div>
				</div>
				<div class="post-content content">
					<p>Simple dumb extraction method:</p><p>1) find &amp; remember offset of &quot;shsq&quot; magic from vigorfly200_r836_103YotaRC2.all (for me it is 780107)<br />2) dd if=vigorfly200_r836_103YotaRC2.all of=rootfs.img skip=780107 bs=1<br />3) compile squashfs-3.2-r2-lzma (you can take it from firmware-mod-kit for example)<br />4) unsquashfs rootfs.img</p><p>Yes, it is GPL violated at most - kernel, busybox, dnsmasq, madwimax, etc. <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>If you know how to write effective complain, please do it.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p114783">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">Xander</div>
					<div class="post-datetime">
						9 Aug 2010, 09:17					</div>
				</div>
				<div class="post-content content">
					<p>Thanks, lly, I unpacked it!<br />Will try to talk to the guys first...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p131645">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">sousuke30</div>
					<div class="post-datetime">
						26 Mar 2011, 17:30					</div>
				</div>
				<div class="post-content content">
					<p>Hi.<br />how compile firmware </p><p><a href="ftp://ftp.draytek.com/VigorFly%20200/Support/Linux-based%20Source%20Code/vigorfly200_yota_104_gpl.tar.bz2">ftp://ftp.draytek.com/VigorFly%20200/Su … pl.tar.bz2</a></p><p>thanks</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p131872">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">Xander</div>
					<div class="post-datetime">
						29 Mar 2011, 17:27					</div>
				</div>
				<div class="post-content content">
					<p>Very interesting, thanks!<br />Seems, that they splited their own code from madwimax so now GPL is not violated. Good!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p131977">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">PopOpen</div>
					<div class="post-datetime">
						30 Mar 2011, 20:16					</div>
				</div>
				<div class="post-content content">
					<p>@ lly: Can you further explain point (1) please?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p131980">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">lly</div>
					<div class="post-datetime">
						30 Mar 2011, 21:20					</div>
				</div>
				<div class="post-content content">
					<p>PopOpen: In case of you are not familiar with any hex-editor, and even don&#039;t know what is &quot;offset&quot; in a file, I can&#039;t imagine how to help you. Try to find articles on Internet, read appropriate books, etc.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p132008">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">PopOpen</div>
					<div class="post-datetime">
						31 Mar 2011, 11:26					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>lly wrote:</cite><blockquote><p>PopOpen: In case of you are not familiar with any hex-editor, and even don&#039;t know what is &quot;offset&quot; in a file, I can&#039;t imagine how to help you. Try to find articles on Internet, read appropriate books, etc.</p></blockquote></div><p>Hi. I&#039;m very well familiar with both hexeditors and offsets but your line:</p><p>&quot;find &amp; remember offset of &quot;shsq&quot; magic from&quot; is not clear.</p><p>This is because you don&#039;t tell us what is &quot;shsq&quot; and you are not saying anything how to find the offset. BUT I do suspect that what you wanted to say is, that the ASCII equivalent value for the magic number is &quot;shsq&quot; and the Decimal (?) offset from the first byte of the file to the first character of that string is: 780107. ??? </p><p>So instead of suggesting to people who&#039;d like to help you, to read &quot;appropriate books&quot;, you might perhaps read a book yourself on how to write technical English in a more clear manner.</p><p>I&#039;m working on a similar problem with the OpenRG based Pirelli firmware here: &quot;<a href="https://forum.openwrt.org/viewtopic.php?id=29344">Help! To understand, extract and create Pirelli firmware images</a>&quot;...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p132243">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">whbjr</div>
					<div class="post-datetime">
						3 Apr 2011, 22:20					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>PopOpen wrote:</cite><blockquote><p>This is because you don&#039;t tell us what is &quot;shsq&quot; and you are not saying anything how to find the offset. BUT I do suspect that what you wanted to say is, that the ASCII equivalent value for the magic number is &quot;shsq&quot; and the Decimal (?) offset from the first byte of the file to the first character of that string is: 780107. ???</p></blockquote></div><p>Very good point - I, too, dislike incomplete instructions. Here&#039;s my re-write, and my results:</p><p>1a) Unpack the vigorfly200_r836_103YotaRC2.7z file<br /></p><div class="codebox"><pre><code>$ 7za x vigorfly200_r836_103YotaRC2.7z</code></pre></div><p>This produces the file &quot;vigorfly200_r836_103YotaRC2.all&quot;<br />On Linux, the &quot;7za&quot; command is in the &quot;p7zip&quot; package.</p><p>1b) Find the decimal value of the location of the string &quot;shsq&quot; in the vigorfly200_r836_103YotaRC2.all file<br /></p><div class="codebox"><pre><code>$ hexdump -C vigorfly200_r836_103YotaRC2.all | grep -m 1 shsq
000be740  ce 3d c5 32 12 7a b3 b7  31 85 7a 73 68 73 71 b8  |Î=Å2.z³·1.zshsq¸|</code></pre></div><p>Thus, the string starts on 0xbe74b</p><p>1c) Turn that hex number into a decimal number<br /></p><div class="codebox"><pre><code>$ printf &#039;%d\n&#039; 0xbe74b
780107</code></pre></div><p>Sadly, for me it was Step 4 where I ran into trouble:<br /></p><div class="codebox"><pre><code>$ unsquashfs rootfs.img
Can&#039;t find a SQUASHFS superblock on rootfs.img
$ unsquashfs -v
unsquashfs version 4.1 (2010/09/19)
copyright (C) 2010 Phillip Lougher &lt;phillip@lougher.demon.co.uk&gt;
...</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p132347">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">PopOpen</div>
					<div class="post-datetime">
						6 Apr 2011, 00:28					</div>
				</div>
				<div class="post-content content">
					<p>Are you using the same <em>dd</em> as above?<br />What system are you using (ie. Ubuntu, Cygwin etc etc)?<br />Is &quot;lzma&quot; package included in you system...I think perhaps squashfs need it...</p><p>@Xander: Are these the steps you used successfully as well?</p><p><strong>UPDATE</strong>: I just had success with Pirelli, so have a look here: <a href="https://forum.openwrt.org/viewtopic.php?pid=132491#p132491">https://forum.openwrt.org/viewtopic.php … 91#p132491</a></p>											<p class="post-edited">(Last edited by <strong>PopOpen</strong> on 8 Apr 2011, 03:42)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p132739">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">whbjr</div>
					<div class="post-datetime">
						11 Apr 2011, 22:34					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>PopOpen wrote:</cite><blockquote><p>Are you using the same <em>dd</em> as above?<br />What system are you using (ie. Ubuntu, Cygwin etc etc)?<br />Is &quot;lzma&quot; package included in you system...I think perhaps squashfs need it...</p></blockquote></div><p>1. Same &quot;dd&quot;<br />2. CentOS Linux<br />3. Yes, unsquashfs has lzma.</p><p>However, I&#039;ve found the problem... it&#039;s due to byte-order differences.&nbsp; I made a sample squashfs file on my Linux host:<br /></p><div class="codebox"><pre><code>$ mksquashfs /tmp ./tmp.sqsh
[i]... much output ...[/]
$ hexdump -C tmp.sqsh | head -1
00000000  68 73 71 73 03 00 00 00  17 56 a3 4d 00 00 02 00  |hsqs.....V£M....|</code></pre></div><p>The Magic Number is reversed! I thought that programs such as unsquashfs could handle that (see <a href="http://disktype.sourceforge.net/doc/ch03s05.html">Linux File Systems docs</a>), but I guess not.&nbsp; Anyway, this means that I probably won&#039;t have more to add to this discussion. Sorry!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p132858">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">PopOpen</div>
					<div class="post-datetime">
						13 Apr 2011, 03:13					</div>
				</div>
				<div class="post-content content">
					<p>I don&#039;t know anything about CentOS, apart being not very common for developers. However, it could be it is a &quot;little endian&quot; based system which may explain the byte reversal...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p139014">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">asbokid</div>
					<div class="post-datetime">
						13 Jul 2011, 01:07					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>whbjr wrote:</cite><blockquote><p>However, I&#039;ve found the problem... it&#039;s due to byte-order differences.&nbsp; I made a sample squashfs file on my Linux host:<br /></p><div class="codebox"><pre><code>$ mksquashfs /tmp ./tmp.sqsh
[i]... much output ...[/]
$ hexdump -C tmp.sqsh | head -1
00000000  68 73 71 73 03 00 00 00  17 56 a3 4d 00 00 02 00  |hsqs.....V£M....|</code></pre></div><p>The Magic Number is reversed! I thought that programs such as unsquashfs could handle that (see <a href="http://disktype.sourceforge.net/doc/ch03s05.html">Linux File Systems docs</a>), but I guess not.&nbsp; Anyway, this means that I probably won&#039;t have more to add to this discussion. Sorry!</p></blockquote></div><p>Many if not most of the embedded systems that use squashfs are big endian (MSB first).</p><p>Also, the unsquashfs tool for x86 is not always backwardly compatible with squash file systems created with earlier versions of mksquashfs.&nbsp; The incompatibilities are aggravated where the host system is little endian and the file system is big endian.</p><p>The version of mksquashfs used to create squashfs for embedded systems is typically version 3.2r-2. In that version, the patch by jro for lzma compression hadn&#039;t officially been incorporated into the squashfs codebase.</p><p>The answer is to compile the source code for a compatible version of unsquashfs..</p><p>This version of unsquashfs from the neufbox 4 project was good for me..</p><p><a href="http://svn.gna.org/svn/openbox4/trunk/firmware_2.x/tools/nb4-squashfs/">http://svn.gna.org/svn/openbox4/trunk/f … -squashfs/</a></p>											<p class="post-edited">(Last edited by <strong>asbokid</strong> on 13 Jul 2011, 01:42)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>