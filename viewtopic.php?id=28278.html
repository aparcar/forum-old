<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> WNDR3700 + Backfire 10.03.1-rc4 + ip camera + encryption = fail</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 12 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p126319">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">Thermopyle</div>
					<div class="post-datetime">
						23 Jan 2011, 23:30					</div>
				</div>
				<div class="post-content content">
					<p>Router: WNDR3700<br />OpenWrt: Backfire 10.03.1-rc4<br />Client with problems:&nbsp; <a href="http://www.ltsecurityinc.com/385">Wireless B/G IP camera</a></p><p>Problem description:<br />If I set OpenWRT to use WPA2-PSK encryption, the camera doesn&#039;t stay connected and the system log fills with lines like these:</p><div class="codebox"><pre><code>Jan 23 15:27:10 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 IEEE 802.11: authenticated
Jan 23 15:27:10 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 IEEE 802.11: associated (aid 2)
Jan 23 15:27:10 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 IEEE 802.11: associated (aid 2)
Jan 23 15:27:10 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 WPA: received EAPOL-Key 2/4 Pairwise with unexpected replay counter
Jan 23 15:27:13 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 IEEE 802.11: deauthenticated due to local deauth request
Jan 23 15:27:18 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 IEEE 802.11: authenticated
Jan 23 15:27:18 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 IEEE 802.11: associated (aid 2)
Jan 23 15:27:21 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 IEEE 802.11: deauthenticated due to local deauth request
Jan 23 15:27:26 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 IEEE 802.11: authenticated
Jan 23 15:27:26 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 IEEE 802.11: associated (aid 2)
Jan 23 15:27:29 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 IEEE 802.11: deauthenticated due to local deauth request
Jan 23 15:27:34 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 IEEE 802.11: authenticated
Jan 23 15:27:34 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 IEEE 802.11: associated (aid 2)
Jan 23 15:27:34 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 IEEE 802.11: associated (aid 2)
Jan 23 15:27:34 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 WPA: received EAPOL-Key 2/4 Pairwise with unexpected replay counter
Jan 23 15:27:34 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 WPA: received EAPOL-Key 2/4 Pairwise with unexpected replay counter
Jan 23 15:27:37 OpenWrt daemon.info hostapd: wlan0: STA 00:0d:f0:5b:81:52 IEEE 802.11: deauthenticated due to local deauth request</code></pre></div><p>WPA-PSK, WEP, and no encryption all work correctly.&nbsp; The WNDR3700 stock firmware works with this camera and WPA2-PSK.</p><p>Let me know if more information is required.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p131197">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">dromero</div>
					<div class="post-datetime">
						20 Mar 2011, 23:27					</div>
				</div>
				<div class="post-content content">
					<p>Same problem here, D-LINK DSC-2120<br />using WPA-PSK on a Linksys WRT160NL<br />Linksys WRT54GL with same OpenWRT version works OK.</p><p>Mar 20 18:24:20 OpenWrt daemon.info hostapd: wlan0: STA 00:1c:f0:79:08:e6 IEEE 802.11: associated (aid 1)<br />Mar 20 18:24:23 OpenWrt daemon.info hostapd: wlan0: STA 00:1c:f0:79:08:e6 IEEE 802.11: deauthenticated due to local deauth request<br />Mar 20 18:24:24 OpenWrt daemon.info hostapd: wlan0: STA 00:1c:f0:79:08:e6 IEEE 802.11: authenticated<br />Mar 20 18:24:24 OpenWrt daemon.info hostapd: wlan0: STA 00:1c:f0:79:08:e6 IEEE 802.11: associated (aid 1)<br />Mar 20 18:24:27 OpenWrt daemon.info hostapd: wlan0: STA 00:1c:f0:79:08:e6 IEEE 802.11: deauthenticated due to local deauth request<br />Mar 20 18:24:28 OpenWrt daemon.info hostapd: wlan0: STA 00:1c:f0:79:08:e6 IEEE 802.11: authenticated<br />Mar 20 18:24:28 OpenWrt daemon.info hostapd: wlan0: STA 00:1c:f0:79:08:e6 IEEE 802.11: associated (aid 1)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p135113">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">sophana</div>
					<div class="post-datetime">
						12 May 2011, 00:30					</div>
				</div>
				<div class="post-content content">
					<p>Same with wgt634u (madwifi) psk2<br />openwrt svn backfire branch r26800<br /></p><div class="codebox"><pre><code>May 11 20:44:11 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be IEEE 802.11: associated
May 11 20:44:12 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be WPA: received EAPOL-Key 2/4 Pairwise with unexpected replay counter
May 11 20:44:15 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be IEEE 802.11: deauthenticated due to local deauth request
May 11 20:44:15 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be IEEE 802.11: disassociated
May 11 20:44:16 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be IEEE 802.11: associated
May 11 20:44:17 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be WPA: received EAPOL-Key 2/4 Pairwise with unexpected replay counter
May 11 20:44:20 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be IEEE 802.11: deauthenticated due to local deauth request
May 11 20:44:20 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be IEEE 802.11: disassociated
May 11 20:44:21 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be IEEE 802.11: associated
May 11 20:44:21 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be WPA: received EAPOL-Key 2/4 Pairwise with unexpected replay counter
May 11 20:44:24 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be IEEE 802.11: deauthenticated due to local deauth request
May 11 20:44:24 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be IEEE 802.11: disassociated
May 11 20:44:25 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be IEEE 802.11: associated
May 11 20:44:26 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be WPA: received EAPOL-Key 2/4 Pairwise with unexpected replay counter
May 11 20:44:29 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be IEEE 802.11: deauthenticated due to local deauth request
May 11 20:44:29 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be IEEE 802.11: disassociated
May 11 20:44:30 OpenWrt daemon.info hostapd: ath1: STA 94:0c:6d:be:ee:be IEEE 802.11: associated</code></pre></div><p>After 1 or 2 days, no wifi client can connect (htc desire + a tp-link wifi N laptop).<br />After a reboot, there are still this messages, but after several tries, clients connect.</p><p>Google show that this bug does not seem to be related to openwrt. The problem is seen with net-bsd, pfsense, ubiquiti.<br />They all have atheros wifi (and hostapd)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p136175">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">Stolz</div>
					<div class="post-datetime">
						29 May 2011, 22:59					</div>
				</div>
				<div class="post-content content">
					<p>Same problem here with a fonera.</p><p>I can connect form Windows or Android, but not from Linux.</p><p>My laptio log<br />wlan0: authenticate with MAC_ADDRESS (try 1)<br />wlan0: authenticated<br />wlan0: associate with MAC_ADDRESS (try 1)<br />wlan0: RX AssocResp from MAC_ADDRESS (capab=0x431 status=0 aid=2)<br />wlan0: associated<br />wlan0: deauthenticated from MAC_ADDRESS (Reason: 2)<br />(repeated forever)</p><p>Tha AP log<br />ath0: STA AP_MAC_ADDRESS:0d IEEE 802.11: associated<br />ath0: STA AP_MAC_ADDRESS:0d IEEE 802.11: deauthenticated due to local deauth request<br />ath0: STA AP_MAC_ADDRESS:0d IEEE 802.11: disassociated<br />(repeated forever)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138652">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">gkloepfer</div>
					<div class="post-datetime">
						7 Jul 2011, 20:40					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ve been dealing with an issue with an old IP video camera that apparently has a &quot;slow&quot; WPA2 response time to some of the key negotiation packets from hostapd (linked to wpad on OpenWrt).&nbsp; I get &quot;WPA: received EAPOL-Key 4/4 Pairwise with unexpected replay counter&quot; messages, and this is apparently happening to several people on the &#039;net.</p><p>The problem is that, for some reason, the slow response by the device (the camera in my case too) seems to cause the key negotiation packets to get resent by hostapd, which confuses the camera and the WPA2 association never completes successfully.&nbsp; There was a post on the hostapd forums and an associated fix that was supposed to increase the timeout from 100ms to 1000ms in this case, but the code doesn&#039;t appear to work (I need to contact upstream yet, and since I am new, I need to figure out how).</p><p>I was able to fix my problem by recompiling hostapd with the following mod:&nbsp; in file src/ap/wpa_auth.c, I changed eapol_key_timeout_first from 100 to 300 (making the initial timeout 300ms instead of 100ms).</p><p>The reason I don&#039;t think this fix is entirely correct is because I don&#039;t know how the initial 100ms timeout was derived (from the WPA2 spec, or just experience), and why there isn&#039;t a way for the timeout to be more gracefully renegotiated.&nbsp; I don&#039;t want to step on anyone&#039;s toes or waste developer time when I don&#039;t have a better understanding of the code.</p><p>Anyway, this may work for you...</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>