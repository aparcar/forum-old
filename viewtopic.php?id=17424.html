<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> ntfs-3g is working on Wl-500g Premium kernel 2.4</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 27 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p75156">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">MoD</div>
					<div class="post-datetime">
						22 Oct 2008, 11:42					</div>
				</div>
				<div class="post-content content">
					<p><span style="color: #FF0000">Item contains outdated info. Solution is found!!! Please read thread responses below!</span> </p><p>I have compiled ntfs-3g for wl-500 Premium running kernel 2.4. It works with my 130 MB USB flash quite stable.<br /></p><div class="quotebox"><blockquote><p>BusyBox v1.11.2 (2008-10-21 21:06:27 EEST) built-in shell (ash)<br />Enter &#039;help&#039; for a list of built-in commands.</p><p>&nbsp; _______&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;________&nbsp; &nbsp; &nbsp; &nbsp; __<br /> |&nbsp; &nbsp; &nbsp; &nbsp;|.-----.-----.-----.|&nbsp; |&nbsp; |&nbsp; |.----.|&nbsp; |_<br /> |&nbsp; &nbsp;-&nbsp; &nbsp;||&nbsp; _&nbsp; |&nbsp; -__|&nbsp; &nbsp; &nbsp;||&nbsp; |&nbsp; |&nbsp; ||&nbsp; &nbsp;_||&nbsp; &nbsp;_|<br /> |_______||&nbsp; &nbsp;__|_____|__|__||________||__|&nbsp; |____|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |__| W I R E L E S S&nbsp; &nbsp;F R E E D O M<br /> KAMIKAZE (bleeding edge, r12957) -------------------<br />&nbsp; * 10 oz Vodka&nbsp; &nbsp; &nbsp; &nbsp;Shake well with ice and strain<br />&nbsp; * 10 oz Triple sec&nbsp; mixture into 10 shot glasses.<br />&nbsp; * 10 oz lime juice&nbsp; Salute!<br /> ---------------------------------------------------<br />root@OpenWrt:~# mount<br />rootfs on / type rootfs (rw)<br />/dev/root on /rom type squashfs (ro)<br />none on /dev type devfs (rw)<br />proc on /proc type proc (rw)<br />tmpfs on /tmp type tmpfs (rw,nosuid,nodev)<br />devpts on /dev/pts type devpts (rw)<br />/dev/mtdblock/4 on /jffs type jffs2 (rw)<br />mini_fo:/jffs on / type mini_fo (rw)<br />none on /proc/bus/usb type usbfs (rw)<br />/dev/scsi/host0/bus0/target0/lun0/part1 on /mnt type fuse (rw,user_id=0,group_id=0,allow_other)</p></blockquote></div><div class="quotebox"><blockquote><p>root@OpenWrt:~# ps<br />&nbsp; PID USER&nbsp; &nbsp; &nbsp; &nbsp;VSZ STAT COMMAND<br />&nbsp; &nbsp; 1 root&nbsp; &nbsp; &nbsp; 1912 S&nbsp; &nbsp; init<br />&nbsp; &nbsp; 2 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[keventd]<br />&nbsp; &nbsp; 3 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SWN&nbsp; [ksoftirqd_CPU0]<br />&nbsp; &nbsp; 4 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[kswapd]<br />&nbsp; &nbsp; 5 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[bdflush]<br />&nbsp; &nbsp; 6 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[kupdated]<br />&nbsp; &nbsp; 9 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[mtdblockd]<br />&nbsp; &nbsp;56 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SWN&nbsp; [jffs2_gcd_mtd4]<br />&nbsp; &nbsp;68 root&nbsp; &nbsp; &nbsp; 1912 S&nbsp; &nbsp; init<br />&nbsp; &nbsp;89 root&nbsp; &nbsp; &nbsp; 1928 S&nbsp; &nbsp; syslogd -C16<br />&nbsp; &nbsp;91 root&nbsp; &nbsp; &nbsp; 1908 S&nbsp; &nbsp; klogd<br />&nbsp; 242 root&nbsp; &nbsp; &nbsp; 1924 S&nbsp; &nbsp; udhcpc -t 0 -i eth0.1 -b -p /var/run/eth0.1.pid -R<br />&nbsp; 258 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[khubd]<br />&nbsp; 401 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[usb-storage-0]<br />&nbsp; 403 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[scsi_eh_0]<br />&nbsp; 562 root&nbsp; &nbsp; &nbsp; 1868 S&nbsp; &nbsp; /usr/sbin/dropbear -p 22<br />&nbsp; 565 root&nbsp; &nbsp; &nbsp; 1912 S&nbsp; &nbsp; /usr/sbin/httpd -p 80 -h /www -r OpenWrt<br />&nbsp; 614 root&nbsp; &nbsp; &nbsp; 2388 S&nbsp; &nbsp; ntfs-3g /dev/discs/disc0/part1 /mnt/<br />&nbsp; 698 root&nbsp; &nbsp; &nbsp; 1928 S&nbsp; &nbsp; /usr/sbin/dropbear -p 22<br />&nbsp; 699 root&nbsp; &nbsp; &nbsp; 1916 S&nbsp; &nbsp; -ash<br />&nbsp; 702 root&nbsp; &nbsp; &nbsp; 1928 S&nbsp; &nbsp; /usr/sbin/dropbear -p 22<br />&nbsp; 703 root&nbsp; &nbsp; &nbsp; 1920 S&nbsp; &nbsp; -ash<br />&nbsp; 706 root&nbsp; &nbsp; &nbsp; 1912 R&nbsp; &nbsp; ps</p></blockquote></div><p>However when I try to mount my 160 GB external USB hard drive, happens pretty much the same as described here: <a href="http://www.nslu2-linux.org/wiki/HowTo/BuildNTFS3G">http://www.nslu2-linux.org/wiki/HowTo/BuildNTFS3G</a><br /></p><div class="quotebox"><blockquote><p>The ntfs-3g user-space executable&nbsp; locks up (or locks any process that attempts to access it) until reboot.</p></blockquote></div><p>At first that happened also with my USB flash. Then I noticed that I have to wait some seconds before start to do something with mounted partition. I do not know how much time I should wait for USB HDD to work:)</p><p>It seems that mips or arm platforms even with kernel 2.6 doesnâ€™t support ntfs-3g without patching the kernel: <a href="http://forum.ntfs-3g.org/viewtopic.php?t=115">http://forum.ntfs-3g.org/viewtopic.php?t=115</a> <strong>Could anyone confirm that? Is there anyone who is using ntfs-3g with kernel 2.6 on mips or arm platform?</strong></p><p>How did I compile my ntfs-3g package? First, I patched the kernel. Patch is here: <a href="http://www.abcsolutions.lv/openwrt/016-fuse-ntfs-3g-mips.patch">http://www.abcsolutions.lv/openwrt/016- … mips.patch</a> Put it in &quot;trunk/target/linux/brcm-2.4/patches&quot; </p><p>Second. ntfs-3g doesn&#039;t require the FUSE user space package anymore, but still needs FUSE kenel module. I added a new patch to FUSE package (<a href="http://www.abcsolutions.lv/openwrt/fuse-2.5.3/patches/113-DCACHE_BUG.patch">http://www.abcsolutions.lv/openwrt/fuse … _BUG.patch</a>). At <a href="http://www.abcsolutions.lv/openwrt/">http://www.abcsolutions.lv/openwrt/</a> you will find my FUSE kernel 2.4 package and ntfs-3g package. My FUSE package might conflict&nbsp; with the original fuse package for kernel 2.6. Remove the original one.</p><p>Copy my packages in &quot;trunk/packages&quot; , type </p><div class="quotebox"><blockquote><p>make menuconfig</p></blockquote></div><p>and select <strong>FUSE kernel module</strong> and <strong>ntfs-3g</strong> packages. Then build the image.</p><p><strong>After mounting NTFS partition, wait some seconds before start to do something with mounted partition.</strong> Notice that you wont see filenames with non-Ascii characters. For solution, please please look at <a href="http://ntfs-3g.org/support.html#locale">http://ntfs-3g.org/support.html#locale</a> .</p><p>I&#039;m posting this info to rise discussion how to solve issue with large disks. Could it be FUSE or ntfs-3g issue? ntfs-3g page has info that: </p><div class="quotebox"><blockquote><p>FUSE kernel driver included in Linux kernels before version 2.6.9 are unsafe and prone to data loss.</p></blockquote></div>											<p class="post-edited">(Last edited by <strong>MoD</strong> on 23 Oct 2008, 14:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75209">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">MoD</div>
					<div class="post-datetime">
						23 Oct 2008, 00:20					</div>
				</div>
				<div class="post-content content">
					<p>My 160 GB HDD is working too.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75214">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">misha680</div>
					<div class="post-datetime">
						23 Oct 2008, 08:23					</div>
				</div>
				<div class="post-content content">
					<p>I am glad to hear it worked. I am trying this again (I had my own patches which were basically same thing except I defined EXPORT_SYMTAB in c-r4k.c, your way probably more proper) but it didn&#039;t seem to do the trick (I&#039;m using with owfs &amp; hello sample program). Will try again.</p><p>Misha</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75219">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">MoD</div>
					<div class="post-datetime">
						23 Oct 2008, 09:44					</div>
				</div>
				<div class="post-content content">
					<p>I still do not understand why it sometimes locks up. I&#039;m mounting in directory /mnt </p><p>If I create subdirectory (for example /mnt/usb ) and mount there, then ntfs-3g user-space executable locks up always.</p>											<p class="post-edited">(Last edited by <strong>MoD</strong> on 23 Oct 2008, 09:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75221">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">MoD</div>
					<div class="post-datetime">
						23 Oct 2008, 10:17					</div>
				</div>
				<div class="post-content content">
					<p>It looks like I have found a solution! I can mount ntfs in subdirectories. Now I have running samba server with RW shared 160 GB HDD ntfs partition.</p><p>fuse&#039;s dev.c must be patched more (look at <a href="http://forum.openwrt.org/viewtopic.php?id=8874)">http://forum.openwrt.org/viewtopic.php?id=8874)</a>. function <strong>static inline int fuse_copy_do</strong> must look like:<br /></p><div class="quotebox"><blockquote><p>static inline int fuse_copy_do(struct fuse_copy_state *cs, void **val,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; unsigned *size)<br />{<br />&nbsp; &nbsp; unsigned ncpy = min(*size, cs-&gt;len);<br />&nbsp; &nbsp; if (val) {<strong><br />&nbsp; &nbsp; &nbsp; &nbsp; //patch from mailing list ,it is very important ,otherwise,can&#039; mount , or ls mount point will hang<br />&nbsp; &nbsp; &nbsp; &nbsp; flush_cache_all();</strong><br />&nbsp; &nbsp; &nbsp; &nbsp; if (cs-&gt;write)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memcpy(cs-&gt;buf, *val, ncpy);<br />&nbsp; &nbsp; &nbsp; &nbsp; else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memcpy(*val, cs-&gt;buf, ncpy);<br />&nbsp; &nbsp; &nbsp; &nbsp; *val += ncpy;<br />&nbsp; &nbsp; }<br />&nbsp; &nbsp; *size -= ncpy;<br />&nbsp; &nbsp; cs-&gt;len -= ncpy;<br />&nbsp; &nbsp; cs-&gt;buf += ncpy;<br />&nbsp; &nbsp; return ncpy;<br />}</p></blockquote></div><p>The FUSE package patch file <a href="http://www.abcsolutions.lv/openwrt/fuse-2.5.3/patches/113-DCACHE_BUG.patch">http://www.abcsolutions.lv/openwrt/fuse … _BUG.patch</a> is updated.</p><p>Actually I should test if it is needed to patch the kernel at all.</p>											<p class="post-edited">(Last edited by <strong>MoD</strong> on 23 Oct 2008, 14:43)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75241">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">misha680</div>
					<div class="post-datetime">
						23 Oct 2008, 15:49					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>MoD wrote:</cite><blockquote><p>It looks like I have found a solution! I can mount ntfs in subdirectories. Now I have running samba server with RW shared 160 GB HDD ntfs partition.</p><p>fuse&#039;s dev.c must be patched more (look at <a href="http://forum.openwrt.org/viewtopic.php?id=8874)">http://forum.openwrt.org/viewtopic.php?id=8874)</a>. function <strong>static inline int fuse_copy_do</strong> must look like:<br /></p><div class="quotebox"><blockquote><p>static inline int fuse_copy_do(struct fuse_copy_state *cs, void **val,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; unsigned *size)<br />{<br />&nbsp; &nbsp; unsigned ncpy = min(*size, cs-&gt;len);<br />&nbsp; &nbsp; if (val) {<strong><br />&nbsp; &nbsp; &nbsp; &nbsp; //patch from mailing list ,it is very important ,otherwise,can&#039; mount , or ls mount point will hang<br />&nbsp; &nbsp; &nbsp; &nbsp; flush_cache_all();</strong><br />&nbsp; &nbsp; &nbsp; &nbsp; if (cs-&gt;write)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memcpy(cs-&gt;buf, *val, ncpy);<br />&nbsp; &nbsp; &nbsp; &nbsp; else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memcpy(*val, cs-&gt;buf, ncpy);<br />&nbsp; &nbsp; &nbsp; &nbsp; *val += ncpy;<br />&nbsp; &nbsp; }<br />&nbsp; &nbsp; *size -= ncpy;<br />&nbsp; &nbsp; cs-&gt;len -= ncpy;<br />&nbsp; &nbsp; cs-&gt;buf += ncpy;<br />&nbsp; &nbsp; return ncpy;<br />}</p></blockquote></div><p>The FUSE package patch file <a href="http://www.abcsolutions.lv/openwrt/fuse-2.5.3/patches/113-DCACHE_BUG.patch">http://www.abcsolutions.lv/openwrt/fuse … _BUG.patch</a> is updated.</p><p>Actually I should test if it is needed to patch the kernel at all.</p></blockquote></div><p>For me, on trunk, this patch isn&#039;t enough on trunk, only on 7.09. If you look here these are the fuse packages they work absolutely fine on 7.09 (fuse 2.4.2), but not on trunk still hang. They already had this patch.</p><p><a href="http://home.mag.cx/openwrt/source/mk/kamikaze/">http://home.mag.cx/openwrt/source/mk/kamikaze/</a></p><p>Then again last time I tried with both patches still had problems</p><p>Misha</p><p>Misha</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75242">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">misha680</div>
					<div class="post-datetime">
						23 Oct 2008, 16:03					</div>
				</div>
				<div class="post-content content">
					<p>You know hold it test the kernel anyway. I just got at least the hello example to work with these packages:<br />src owfs <a href="http://home.mag.cx/openwrt/kamikaze-svn-asus/packages/">http://home.mag.cx/openwrt/kamikaze-svn-asus/packages/</a></p><p>No kernel patch. Will have to see...</p><p>Misha</p><p>EDIT: works ok in debug mode, hangs otherwise...</p>											<p class="post-edited">(Last edited by <strong>misha680</strong> on 23 Oct 2008, 16:17)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75247">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">MoD</div>
					<div class="post-datetime">
						23 Oct 2008, 17:15					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>misha680 wrote:</cite><blockquote><p>For me, on trunk, this patch isn&#039;t enough on trunk, only on 7.09. If you look here these are the fuse packages they work absolutely fine on 7.09 (fuse 2.4.2), but not on trunk still hang. They already had this patch.</p><p><a href="http://home.mag.cx/openwrt/source/mk/kamikaze/">http://home.mag.cx/openwrt/source/mk/kamikaze/</a></p><p>Then again last time I tried with both patches still had problems</p><p>Misha</p></blockquote></div><p>The patch <a href="http://www.abcsolutions.lv/openwrt/fuse-2.5.3/patches/113-DCACHE_BUG.patch">http://www.abcsolutions.lv/openwrt/fuse … _BUG.patch</a> is against my fuse package version 2.5.3, see <a href="http://www.abcsolutions.lv/openwrt/fuse-2.5.3/">http://www.abcsolutions.lv/openwrt/fuse-2.5.3/</a> and it depends from <a href="http://www.abcsolutions.lv/openwrt/016-fuse-ntfs-3g-mips.patch">http://www.abcsolutions.lv/openwrt/016- … mips.patch</a></p>											<p class="post-edited">(Last edited by <strong>MoD</strong> on 23 Oct 2008, 17:18)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75250">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">misha680</div>
					<div class="post-datetime">
						23 Oct 2008, 17:55					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>MoD wrote:</cite><blockquote><div class="quotebox"><cite>misha680 wrote:</cite><blockquote><p>For me, on trunk, this patch isn&#039;t enough on trunk, only on 7.09. If you look here these are the fuse packages they work absolutely fine on 7.09 (fuse 2.4.2), but not on trunk still hang. They already had this patch.</p><p><a href="http://home.mag.cx/openwrt/source/mk/kamikaze/">http://home.mag.cx/openwrt/source/mk/kamikaze/</a></p><p>Then again last time I tried with both patches still had problems</p><p>Misha</p></blockquote></div><p>The patch <a href="http://www.abcsolutions.lv/openwrt/fuse-2.5.3/patches/113-DCACHE_BUG.patch">http://www.abcsolutions.lv/openwrt/fuse … _BUG.patch</a> is against my fuse package version 2.5.3, see <a href="http://www.abcsolutions.lv/openwrt/fuse-2.5.3/">http://www.abcsolutions.lv/openwrt/fuse-2.5.3/</a> and it depends from <a href="http://www.abcsolutions.lv/openwrt/016-fuse-ntfs-3g-mips.patch">http://www.abcsolutions.lv/openwrt/016- … mips.patch</a></p></blockquote></div><p>Thanks saw them yesterday. They are basically same as mine with minor differences (you have more #defines in FUSE patch and your kernel patch with Makefile mods looks more proper than my define). I will try again with new kernel later.</p><p>Misha</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75254">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">MoD</div>
					<div class="post-datetime">
						23 Oct 2008, 19:33					</div>
				</div>
				<div class="post-content content">
					<p>I must say that my ntfs-3 is very stable. Even more - I changed <strong>locale</strong> with <strong>iconv</strong> (see this <a href="http://blog.chinaunix.net/u/22617/showart_297332.html)">http://blog.chinaunix.net/u/22617/showart_297332.html)</a> and now I have national characters support on my router.</p><p>And it, again, works with SAMBA.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75284">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">misha680</div>
					<div class="post-datetime">
						24 Oct 2008, 05:29					</div>
				</div>
				<div class="post-content content">
					<p>Still having some problems. Seems to work in debug mode, but not otherwise (e.g. hello -d a).</p><p>Ok, here is my kernel patch that I am using:</p><div class="codebox"><pre><code>--- linux-2.4.35.4.orig/arch/mips/mm/c-r4k.c    2008-10-16 07:57:25.000000000 -0500
+++ linux-2.4.35.4/arch/mips/mm/c-r4k.c    2008-10-16 07:59:00.000000000 -0500
@@ -13,6 +13,7 @@
 #include &lt;linux/sched.h&gt;
 #include &lt;linux/mm.h&gt;
 #include &lt;linux/bitops.h&gt;
+#define EXPORT_SYMTAB
 
 #ifdef CONFIG_BCM4710
 #include &quot;../bcm947xx/include/typedefs.h&quot;
@@ -325,8 +326,8 @@
         r4k_blast_scache();
 }
 
-static void r4k_flush_cache_page(struct vm_area_struct *vma,
-                    unsigned long page)
+void r4k_flush_cache_page(struct vm_area_struct *vma,
+                unsigned long page)
 {
     int exec = vma-&gt;vm_flags &amp; VM_EXEC;
     struct mm_struct *mm = vma-&gt;vm_mm;
@@ -385,6 +386,7 @@
             r4k_blast_icache_page_indexed(page);
     }
 }
+EXPORT_SYMBOL(r4k_flush_cache_page);
 
 static void r4k_flush_data_cache_page(unsigned long addr)
 {</code></pre></div><p>My two fuse patches (to 2.5.3):<br /></p><div class="codebox"><pre><code>--- fuse-2.4.2/kernel/dev.c.org    2005-11-22 22:30:59.000000000 +0100
+++ fuse-2.4.2/kernel/dev.c    2007-01-09 16:32:20.000000000 +0100
@@ -517,6 +517,7 @@
 {
     unsigned ncpy = min(*size, cs-&gt;len);
     if (val) {
+        flush_cache_all();
         if (cs-&gt;write)
             memcpy(cs-&gt;buf, *val, ncpy);
         else</code></pre></div><div class="codebox"><pre><code>--- fuse-2.5.3.orig/kernel/dev.c    2006-02-02 11:04:52.000000000 -0600
+++ fuse-2.5.3/kernel/dev.c    2008-10-16 00:13:35.000000000 -0500
@@ -511,6 +511,7 @@
 static int fuse_copy_fill(struct fuse_copy_state *cs)
 {
     unsigned long offset;
+    struct vm_area_struct *vma;
     int err;
 
     unlock_request(cs-&gt;req);
@@ -524,13 +525,14 @@
     }
     down_read(&amp;current-&gt;mm-&gt;mmap_sem);
     err = get_user_pages(current, current-&gt;mm, cs-&gt;addr, 1, cs-&gt;write, 0,
-                 &amp;cs-&gt;pg, NULL);
+                 &amp;cs-&gt;pg, &amp;vma);
     up_read(&amp;current-&gt;mm-&gt;mmap_sem);
     if (err &lt; 0)
         return err;
     BUG_ON(err != 1);
     offset = cs-&gt;addr % PAGE_SIZE;
     cs-&gt;mapaddr = kmap_atomic(cs-&gt;pg, KM_USER0);
+    r4k_flush_cache_page(vma, cs-&gt;addr);
     cs-&gt;buf = cs-&gt;mapaddr + offset;
     cs-&gt;len = min(PAGE_SIZE - offset, cs-&gt;seglen);
     cs-&gt;seglen -= cs-&gt;len;</code></pre></div><p>and fuse Makefile:</p><div class="codebox"><pre><code># 
# Copyright (C) 2006 OpenWrt.org
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#
# $Id: Makefile 6807 2007-04-01 19:07:59Z nbd $

include $(TOPDIR)/rules.mk
include $(INCLUDE_DIR)/kernel.mk

PKG_NAME:=fuse-2-4
PKG_VERSION:=2.5.3
PKG_RELEASE:=3

PKG_SOURCE:=fuse-$(PKG_VERSION).tar.gz
PKG_SOURCE_URL:=@SF/fuse
PKG_MD5SUM:=6e3d9a580c45ddf4a06558c135c158c2
PKG_BUILD_DIR:=$(BUILD_DIR)/fuse-$(PKG_VERSION)

include $(INCLUDE_DIR)/package.mk

define Package/fuse-2-4/Default
  TITLE:=FUSE
  DEPENDS:=
  URL:=http://fuse.sourceforge.net/
endef

define Package/fuse-2-4/Description
    FUSE (Filesystem in UserSpacE)
endef

define Package/fuse-utils-2-4
  $(call Package/fuse-2-4/Default)
  SECTION:=utils
  CATEGORY:=Utilities
  DEPENDS:=+libfuse-2-4 +kmod-fuse-2-4
  TITLE+= (utilities)
endef

define Package/fuse-utils-2-4/description
    This package contains the FUSE utilities.
endef

define KernelPackage/fuse-2-4
  SUBMENU:=Filesystems
  $(call Package/fuse-2-4/Default)
  DEPENDS:=
  TITLE+= (kernel module)
  FILES:=$(PKG_INSTALL_DIR)/lib/modules/$(LINUX_VERSION)/kernel/fs/fuse/fuse.$(LINUX_KMOD_SUFFIX)
  VERSION:=$(LINUX_VERSION)+$(PKG_VERSION)-$(BOARD)-$(PKG_RELEASE)
#  AUTOLOAD:=$(call AutoLoad,80,fuse)
endef

define KernelPackage/fuse-2-4/descriptione
    This package contains the FUSE kernel module.
endef

define Package/libfuse-2-4
  $(call Package/fuse-2-4/Default)
  SECTION:=libs
  CATEGORY:=Libraries
  DEPENDS:=
  TITLE+= (library)
endef

define Package/libfuse-2-4/description
    This package contains the FUSE shared library, needed by other programs.
endef

CONFIGURE_VARS += \
     kernsrcver=&quot;$(LINUX_VERSION)&quot;

CONFIGURE_ARGS += \
    --enable-shared \
    --enable-static \
    --disable-rpath \
    --enable-kernel-module \
    --enable-lib \
    --enable-util \
    --disable-auto-modprobe \
    --with-kernel=&quot;$(LINUX_DIR)&quot; \
    --disable-mtab

#    --disable-example \

define Build/Configure
    (cd $(PKG_BUILD_DIR); rm -f config.cache; \
        touch configure.in ; \
        touch aclocal.m4 ; \
        touch Makefile.in ; \
        touch include/config.h.in ; \
        touch configure ; \
    )
    $(call Build/Configure/Default)
endef

define Build/Compile
    $(MAKE) -C $(PKG_BUILD_DIR) \
        ARCH=&quot;$(LINUX_KARCH)&quot; \
        CROSS_COMPILE=&quot;$(TARGET_CROSS)&quot; \
        DESTDIR=&quot;$(PKG_INSTALL_DIR)&quot; \
        AM_CFLAGS=&quot;$(TARGET_CFLAGS) -DDISABLE_COMPAT=1&quot; \
        EXTRA_DIST=&quot;&quot; \
        all install
endef

define Build/InstallDev
    mkdir -p $(STAGING_DIR)/usr/include
    $(CP)    $(PKG_INSTALL_DIR)/usr/include/fuse{,.h} $(STAGING_DIR)/usr/include/
    mkdir -p $(STAGING_DIR)/usr/lib
    $(CP)    $(PKG_INSTALL_DIR)/usr/lib/libfuse.{a,so*} $(STAGING_DIR)/usr/lib/
    mkdir -p $(STAGING_DIR)/usr/lib/pkgconfig
    $(CP) $(PKG_INSTALL_DIR)/usr/lib/pkgconfig/fuse.pc $(STAGING_DIR)/usr/lib/pkgconfig/
    $(SED) &#039;s,-I$$$${includedir}/fuse,,g&#039; $(STAGING_DIR)/usr/lib/pkgconfig/fuse.pc
    $(SED) &#039;s,-L$$$${libdir},,g&#039; $(STAGING_DIR)/usr/lib/pkgconfig/fuse.pc
endef

define Build/UninstallDev
    rm -rf    $(STAGING_DIR)/usr/include/fuse{,.h} \
        $(STAGING_DIR)/usr/lib/libfuse.{a,so*} \
        $(STAGING_DIR)/usr/lib/pkgconfig/fuse.pc
endef

define Package/fuse-utils-2-4/install
    $(INSTALL_DIR) $(1)/usr/bin
    $(CP) $(PKG_INSTALL_DIR)/usr/bin/fusermount $(1)/usr/bin/
endef

define Package/libfuse-2-4/install
    $(INSTALL_DIR) $(1)/usr/lib
    $(CP) $(PKG_INSTALL_DIR)/usr/lib/libfuse.so.* $(1)/usr/lib/
endef

$(eval $(call BuildPackage,fuse-utils-2-4))
$(eval $(call BuildPackage,libfuse-2-4))
$(eval $(call KernelPackage,fuse-2-4))</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75286">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">misha680</div>
					<div class="post-datetime">
						24 Oct 2008, 05:30					</div>
				</div>
				<div class="post-content content">
					<p>Oh yeah I&#039;m on r13018.</p><p>Misha</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75287">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">Weedy</div>
					<div class="post-datetime">
						24 Oct 2008, 05:41					</div>
				</div>
				<div class="post-content content">
					<p>uhhh hate to rain of you parade. but 2.6 works on the 500gp with wifi. so all this is kinda moot</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75293">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">misha680</div>
					<div class="post-datetime">
						24 Oct 2008, 08:07					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Weedy wrote:</cite><blockquote><p>uhhh hate to rain of you parade. but 2.6 works on the 500gp with wifi. so all this is kinda moot</p></blockquote></div><p>My understanding last time I checked was this was not exactly true... there are still kinks when transferring with a lot of bandwith no? Has this been fixed recently?</p><p>Thank you<br />Misha</p><p>p.s. also my understanding this is why 2.4 is staying in 8.08.</p>											<p class="post-edited">(Last edited by <strong>misha680</strong> on 24 Oct 2008, 16:15)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75297">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">MoD</div>
					<div class="post-datetime">
						24 Oct 2008, 09:46					</div>
				</div>
				<div class="post-content content">
					<p>I see that my kernel patch does not have #define EXPORT_SYMTAB but has also:<br /></p><div class="quotebox"><blockquote><p>--- linux-2.4.35.4.orig/arch/mips/mm/Makefile&nbsp; &nbsp; 2007-11-17 19:23:15.000000000 +0200<br />+++ linux-2.4.35.4/arch/mips/mm/Makefile&nbsp; &nbsp; 2008-10-21 13:02:00.000000000 +0300<br />@@ -11,7 +11,7 @@<br /> O_TARGET := mm.o</p><p> export-objs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; := cache.o ioremap.o loadmmu.o remap.o \<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; tlb-r4k.o tlb-sb1.o<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; tlb-r4k.o tlb-sb1.o c-r4k.o<br /> obj-y&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; += cache.o extable.o init.o ioremap.o fault.o \<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; loadmmu.o</p></blockquote></div>											<p class="post-edited">(Last edited by <strong>MoD</strong> on 24 Oct 2008, 09:49)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75309">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">misha680</div>
					<div class="post-datetime">
						24 Oct 2008, 15:44					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>MoD wrote:</cite><blockquote><p>I see that my kernel patch does not have #define EXPORT_SYMTAB but has also:<br /></p><div class="quotebox"><blockquote><p>--- linux-2.4.35.4.orig/arch/mips/mm/Makefile&nbsp; &nbsp; 2007-11-17 19:23:15.000000000 +0200<br />+++ linux-2.4.35.4/arch/mips/mm/Makefile&nbsp; &nbsp; 2008-10-21 13:02:00.000000000 +0300<br />@@ -11,7 +11,7 @@<br /> O_TARGET := mm.o</p><p> export-objs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; := cache.o ioremap.o loadmmu.o remap.o \<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; tlb-r4k.o tlb-sb1.o<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; tlb-r4k.o tlb-sb1.o c-r4k.o<br /> obj-y&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; += cache.o extable.o init.o ioremap.o fault.o \<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; loadmmu.o</p></blockquote></div></blockquote></div><p>Thanks. I saw that. I think mine is just a hack for yours the &quot;proper&quot; way. If I check /proc/ksyms r4k_flush_cache_page is there and if I don&#039;t have it in my kernel fuse complains and won&#039;t insmod whereas with it there it loads fine. Know any other difference between the two?</p><p>Thanks<br />Misha</p><p>EDIT: Will try just in case but I&#039;m pretty much stumped here. I think itm ight be my newer trunk release. I&#039;m on ASUS wl-500g Premium v1. I have to admit I have not tried ntfs-3g just the included hello program and ntfs-3g. I compile hello with this script:</p><div class="codebox"><pre><code>#!/bin/bash
VERSION=2.5.3
#FUSE_DIR=linux-brcm-2.4/fuse-${VERSION}
FUSE_DIR=mipsel/fuse-${VERSION}
EXTRA_FLAGS=-DFUSE_USE_VERSION=25
#EXTRA_FLAGS=
PATH=/home/misha/src/openwrt/trunk/staging_dir/host/bin:/home/misha/src/openwrt/trunk/staging_dir/toolchain-mipsel_gcc4.1.2/bin:${PATH}
export PKG_CONFIG_PATH=/home/misha/src/openwrt/trunk/staging_dir/mipsel/usr/lib/pkgconfig:${PKG_CONFIG_PATH}
cd ~/src/openwrt/trunk/build_dir/${FUSE_DIR}/example
mipsel-linux-gcc -Wall `/home/misha/src/openwrt/trunk/staging_dir/host/bin/pkg-config fuse --cflags --libs` -I/home/misha/src/openwrt/trunk/staging_dir/mipsel/usr/include -L/home/misha/src/openwrt/trunk/staging_dir/mipsel/usr/lib ${EXTRA_FLAGS} $1.c -o $1 
scp $1 root@192.168.1.1:</code></pre></div><p>and to run</p><div class="codebox"><pre><code>./script hello</code></pre></div><p>My openwrt is at /home/misha/src/openwrt/trunk so you would have to change (search -&gt; replace) in script. Would you mind trying it out and letting me know if it works? Try both:</p><div class="codebox"><pre><code>mkdir /tmp/a
./hello /tmp/a
ls /tmp/a</code></pre></div><p>(hangs for me on ls)</p><p>and</p><div class="codebox"><pre><code>./hello -d /tmp/a</code></pre></div><p>(works for me)</p><p>if that doesn&#039;t work well.</p><p>Thanks<br />Misha</p>											<p class="post-edited">(Last edited by <strong>misha680</strong> on 24 Oct 2008, 15:59)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75312">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">MoD</div>
					<div class="post-datetime">
						24 Oct 2008, 17:20					</div>
				</div>
				<div class="post-content content">
					<p>does the hello uses libfuse or fuse-utils? Probably there is a problem with hello itself or libfuse or fuse-utils. ntfs-3g uses only fuse kernel module. my understandig is that for kernel 2.4 the fuse.o latest release is 2.5.3 (http://fuse.sourceforge.net/wiki/index.php/FAQ#What_version_of_FUSE_do_I_need_to_use_FUSE_with_Linux_2x2e.4x3f.). </p><p>libfuse and fuse-utils you can use from latest kernel 2.6 releases.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75320">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">misha680</div>
					<div class="post-datetime">
						24 Oct 2008, 20:15					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>MoD wrote:</cite><blockquote><p>does the hello uses libfuse or fuse-utils? Probably there is a problem with hello itself or libfuse or fuse-utils. ntfs-3g uses only fuse kernel module. my understandig is that for kernel 2.4 the fuse.o latest release is 2.5.3 (http://fuse.sourceforge.net/wiki/index.php/FAQ#What_version_of_FUSE_do_I_need_to_use_FUSE_with_Linux_2x2e.4x3f.). </p><p>libfuse and fuse-utils you can use from latest kernel 2.6 releases.</p></blockquote></div><p>Yes, neither works I&#039;ve tried both (only in debug mode). hello uses libfuse which uses the fuse module I believe.</p><p>Worst case I can just run owfs with -o debug for fuse too. Not sure what the downside is. I have too much on that owfs (ac/heat control, temp sensors, etc)</p><p>Misha</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75323">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">MoD</div>
					<div class="post-datetime">
						24 Oct 2008, 21:08					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>misha680 wrote:</cite><blockquote><p>Yes, neither works I&#039;ve tried both (only in debug mode). hello uses libfuse which uses the fuse module I believe.</p><p>Worst case I can just run owfs with -o debug for fuse too. Not sure what the downside is. I have too much on that owfs (ac/heat control, temp sensors, etc)</p><p>Misha</p></blockquote></div><p>I think you should test if ntfs-3g works. If it does, then we can start a new thread to discuss fuse problems?! If you confirm that ntfs-3g works for you, I could release a patch that enables ntfs-3g with iconv support.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75326">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">misha680</div>
					<div class="post-datetime">
						24 Oct 2008, 21:25					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>MoD wrote:</cite><blockquote><div class="quotebox"><cite>misha680 wrote:</cite><blockquote><p>Yes, neither works I&#039;ve tried both (only in debug mode). hello uses libfuse which uses the fuse module I believe.</p><p>Worst case I can just run owfs with -o debug for fuse too. Not sure what the downside is. I have too much on that owfs (ac/heat control, temp sensors, etc)</p><p>Misha</p></blockquote></div><p>I think you should test if ntfs-3g works. If it does, then we can start a new thread to discuss fuse problems?! If you confirm that ntfs-3g works for you, I could release a patch that enables ntfs-3g with iconv support.</p></blockquote></div><p>Ok. Know a quick way to make a ntfs partition on a flash drive using preferrably OpenWRT? Thanks Misha</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p75327">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">MoD</div>
					<div class="post-datetime">
						24 Oct 2008, 21:31					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>misha680 wrote:</cite><blockquote><p>Ok. Know a quick way to make a ntfs partition on a flash drive using preferrably OpenWRT? Thanks Misha</p></blockquote></div><p>it is not a bad idea to try porting <a href="http://www.linux-ntfs.org/doku.php?id=mkntfs">http://www.linux-ntfs.org/doku.php?id=mkntfs</a> there is a makefile <a href="http://trac.nslu2-linux.org/optware/browser/trunk/make/ntfsprogs.mk">http://trac.nslu2-linux.org/optware/bro … fsprogs.mk</a></p>											<p class="post-edited">(Last edited by <strong>MoD</strong> on 24 Oct 2008, 21:49)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p89072">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">bud</div>
					<div class="post-datetime">
						1 Jun 2009, 16:56					</div>
				</div>
				<div class="post-content content">
					<p>Got it working see ... <a href="http://forum.openwrt.org/viewtopic.php?id=20529">http://forum.openwrt.org/viewtopic.php?id=20529</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p89158">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">MoD</div>
					<div class="post-datetime">
						2 Jun 2009, 21:36					</div>
				</div>
				<div class="post-content content">
					<p>my congratulations:)! I have switched to Freecom Datatank 2. Now my wl-700ge is for testing only.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>