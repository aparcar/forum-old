<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> OpenVPN connected but traffic not routable</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 19 Apr 2018 and 30 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=72091&amp;p=2.html">2</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p365506">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">goldy</div>
					<div class="post-datetime">
						17 Sep 2017, 19:20					</div>
				</div>
				<div class="post-content content">
					<p>Internet -&gt; Main Router (192.168.1.1) &lt;- Ethernet -&gt; Open WRT (Dlink DSL 2750U) 192.168.1.98</p><p>New to the world of OpenWrt. Using Dlink DSL 2750U, got it flashed with latest 15.05.1 chaos calmer. Able to setup successfully OpenVPN as per the steps at openwrt tutorials at nordvpn site.</p><p>I can see vpn tunnel to be running, but when I connect my wireless devices with dlink router, traffic is not routable from vpn tunnel. It is going normally to the internet. Following are the configs. Where I could be wrong?</p><div class="codebox"><pre><code>root@OpenWrt:/etc/config# cat network

config interface &#039;loopback&#039;
        option ifname &#039;lo&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;127.0.0.1&#039;
        option netmask &#039;255.0.0.0&#039;

config globals &#039;globals&#039;
        option ula_prefix &#039;fd9b:a069:030c::/48&#039;

config interface &#039;lan&#039;
        option ifname &#039;eth0.1&#039;
        option force_link &#039;1&#039;
        option proto &#039;static&#039;
        option netmask &#039;255.255.255.0&#039;
        option ip6assign &#039;60&#039;
        option ipaddr &#039;192.168.1.98&#039;
        option gateway &#039;192.168.1.1&#039;
        option dns &#039;192.168.1.1&#039;
        option type &#039;bridge&#039;

config switch
        option name &#039;eth0&#039;
        option reset &#039;1&#039;
        option enable_vlan &#039;1&#039;

config switch_vlan
        option device &#039;eth0&#039;
        option vlan &#039;1&#039;
        option ports &#039;0 1 2 3 8t&#039;

config interface &#039;nordvpntun&#039;
        option ifname &#039;tun0&#039;
        option _orig_ifname &#039;tun0 wlan0&#039;
        option _orig_bridge &#039;true&#039;
        option proto &#039;none&#039;</code></pre></div><p>Routes</p><div class="codebox"><pre><code>root@OpenWrt:/etc/config# route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         192.168.1.1     0.0.0.0         UG    0      0        0 br-lan
10.7.7.0        *               255.255.255.0   U     0      0        0 tun0
1xx.5x.5x.9x    192.168.1.1     255.255.255.255 UGH   0      0        0 br-lan
192.168.1.0     *               255.255.255.0   U     0      0        0 br-lan</code></pre></div><p>Firewall</p><div class="codebox"><pre><code>root@OpenWrt:/etc/config# cat firewall

config defaults
        option syn_flood &#039;1&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;

config zone
        option name &#039;lan&#039;
        list network &#039;lan&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;ACCEPT&#039;

config zone
        option name &#039;wan&#039;
        list network &#039;wan&#039;
        list network &#039;wan6&#039;
        option input &#039;REJECT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;
        option masq &#039;1&#039;
        option mtu_fix &#039;1&#039;

config forwarding
        option src &#039;lan&#039;
        option dest &#039;wan&#039;

config rule
        option name &#039;Allow-DHCP-Renew&#039;
        option src &#039;wan&#039;
        option proto &#039;udp&#039;
        option dest_port &#039;68&#039;
        option target &#039;ACCEPT&#039;
        option family &#039;ipv4&#039;

config rule
        option name &#039;Allow-Ping&#039;
        option src &#039;wan&#039;
        option proto &#039;icmp&#039;
        option icmp_type &#039;echo-request&#039;
        option family &#039;ipv4&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-IGMP&#039;
        option src &#039;wan&#039;
        option proto &#039;igmp&#039;
        option family &#039;ipv4&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-DHCPv6&#039;
        option src &#039;wan&#039;
        option proto &#039;udp&#039;
        option src_ip &#039;fe80::/10&#039;
        option src_port &#039;547&#039;
        option dest_ip &#039;fe80::/10&#039;
        option dest_port &#039;546&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-MLD&#039;
        option src &#039;wan&#039;
        option proto &#039;icmp&#039;
        option src_ip &#039;fe80::/10&#039;
        list icmp_type &#039;130/0&#039;
        list icmp_type &#039;131/0&#039;
        list icmp_type &#039;132/0&#039;
        list icmp_type &#039;143/0&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-ICMPv6-Input&#039;
        option src &#039;wan&#039;
        option proto &#039;icmp&#039;
        list icmp_type &#039;echo-request&#039;
        list icmp_type &#039;echo-reply&#039;
        list icmp_type &#039;destination-unreachable&#039;
        list icmp_type &#039;packet-too-big&#039;
        list icmp_type &#039;time-exceeded&#039;
        list icmp_type &#039;bad-header&#039;
        list icmp_type &#039;unknown-header-type&#039;
        list icmp_type &#039;router-solicitation&#039;
        list icmp_type &#039;neighbour-solicitation&#039;
        list icmp_type &#039;router-advertisement&#039;
        list icmp_type &#039;neighbour-advertisement&#039;
        option limit &#039;1000/sec&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-ICMPv6-Forward&#039;
        option src &#039;wan&#039;
        option dest &#039;*&#039;
        option proto &#039;icmp&#039;
        list icmp_type &#039;echo-request&#039;
        list icmp_type &#039;echo-reply&#039;
        list icmp_type &#039;destination-unreachable&#039;
        list icmp_type &#039;packet-too-big&#039;
        list icmp_type &#039;time-exceeded&#039;
        list icmp_type &#039;bad-header&#039;
        list icmp_type &#039;unknown-header-type&#039;
        option limit &#039;1000/sec&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config include
        option path &#039;/etc/firewall.user&#039;

config rule
        option src &#039;wan&#039;
        option dest &#039;lan&#039;
        option proto &#039;esp&#039;
        option target &#039;ACCEPT&#039;

config rule
        option src &#039;wan&#039;
        option dest &#039;lan&#039;
        option dest_port &#039;500&#039;
        option proto &#039;udp&#039;
        option target &#039;ACCEPT&#039;

config zone
        option name &#039;vpnfirewall&#039;
        option input &#039;REJECT&#039;
        option output &#039;ACCEPT&#039;
        option masq &#039;1&#039;
        option mtu_fix &#039;1&#039;
        list network &#039;nordvpntun&#039;
        option forward &#039;REJECT&#039;

config forwarding
        option src &#039;lan&#039;
        option dest &#039;vpnfirewall&#039;</code></pre></div><p>There is no wan interface.</p><div class="codebox"><pre><code>root@OpenWrt:/etc# ifconfig
br-lan    Link encap:Ethernet  HWaddr
          inet addr:192.168.1.98  Bcast:192.168.1.255  Mask:255.255.255.0
          inet6 addr: fd9b:a069:30c::1/60 Scope:Global
          inet6 addr: fe80::aef1:dfff:fee7:f930/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:49604 errors:0 dropped:0 overruns:0 frame:0
          TX packets:39928 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:5990081 (5.7 MiB)  TX bytes:8667271 (8.2 MiB)

eth0      Link encap:Ethernet  HWaddr
          inet6 addr: fe80::aef1:dfff:fee7:f930/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:119864 errors:0 dropped:19 overruns:0 frame:0
          TX packets:97347 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:25868113 (24.6 MiB)  TX bytes:22216057 (21.1 MiB)

eth0.1    Link encap:Ethernet  HWaddr
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:62430 errors:0 dropped:0 overruns:0 frame:0
          TX packets:50035 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:14046107 (13.3 MiB)  TX bytes:10168170 (9.6 MiB)

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:3923 errors:0 dropped:0 overruns:0 frame:0
          TX packets:3923 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:270342 (264.0 KiB)  TX bytes:270342 (264.0 KiB)

tun0      Link encap:UNSPEC  HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00
          inet addr:10.7.7.83  P-t-P:10.7.7.83  Mask:255.255.255.0
          UP POINTOPOINT RUNNING NOARP MULTICAST  MTU:1500  Metric:1
          RX packets:11 errors:0 dropped:0 overruns:0 frame:0
          TX packets:12 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:100
          RX bytes:836 (836.0 B)  TX bytes:912 (912.0 B)

wlan0     Link encap:Ethernet  HWaddr
          inet6 addr: fe80::aef1:dfff:fee7:f931/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:7217 errors:0 dropped:0 overruns:0 frame:0
          TX packets:21026 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:1059594 (1.0 MiB)  TX bytes:8387712 (7.9 MiB)</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365512">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						17 Sep 2017, 22:30					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>goldy wrote:</cite><blockquote><p>I can see vpn tunnel to be running, but when I connect my wireless devices with dlink router, traffic is not routable from vpn tunnel. It is going normally to the internet. Following are the configs. Where I could be wrong?</p></blockquote></div><p>What exactly do you mean by &quot;not routable from vpn tunnel&quot;? Do you mean that if a host on the other end of the VPN tunnel tries to initiate a connection to a host that is found from your LAN network, then that attempt does not succeed? Or do you mean something else?</p><p>I see two potential problems in your configuration. The first is that you do not have a logical network called &#039;wan&#039; defined in your network configuration file. Despite this, you do have a firewall zone called &#039;wan&#039; defined in the firewall configuration file, and this zone is associated with the logical networks &#039;wan&#039; and &#039;wan6&#039;. Your firewall configuration file also has several inbound rules associated with the &#039;wan&#039; firewall zone. Since the logical networks associated with the zone do not exist, your firewall configuration file is invalid, in a sense. Perhaps the firewall configuration is not being applied correctly because of this? Maybe try commenting out the offending configuration snippets?</p><p>The second potential problem is that you have a one-way forwarding rule from &#039;lan&#039; to &#039;vpntunnel&#039;, but you do not have the corresponding reverse rule i.e. from &#039;vpntunnel&#039; to &#039;lan&#039;. Perhaps you should try adding such a rule, and see if that solves your problem?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365536">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">goldy</div>
					<div class="post-datetime">
						18 Sep 2017, 21:30					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Antek wrote:</cite><blockquote><p>What exactly do you mean by &quot;not routable from vpn tunnel&quot;? Do you mean that if a host on the other end of the VPN tunnel tries to initiate a connection to a host that is found from your LAN network, then that attempt does not succeed? Or do you mean something else?</p></blockquote></div><p>I meant, from &quot;not routable from vpntunnel&quot; is that, when I connect my laptop with wifi with the Dlink router (openwrt one), the traffic does not go through tun0. It goes through main router and then normally to the internet as any other packet, as if, no vpn is connected. This defeats my purpose, of making all wifi devices to go through vpn tunnel</p><div class="quotebox"><cite>Antek wrote:</cite><blockquote><p>I see two potential problems in your configuration. The first is that you do not have a logical network called &#039;wan&#039; defined in your network configuration file. Despite this, you do have a firewall zone called &#039;wan&#039; defined in the firewall configuration file, and this zone is associated with the logical networks &#039;wan&#039; and &#039;wan6&#039;. Your firewall configuration file also has several inbound rules associated with the &#039;wan&#039; firewall zone. Since the logical networks associated with the zone do not exist, your firewall configuration file is invalid, in a sense. Perhaps the firewall configuration is not being applied correctly because of this? Maybe try commenting out the offending configuration snippets?</p><p>The second potential problem is that you have a one-way forwarding rule from &#039;lan&#039; to &#039;vpntunnel&#039;, but you do not have the corresponding reverse rule i.e. from &#039;vpntunnel&#039; to &#039;lan&#039;. Perhaps you should try adding such a rule, and see if that solves your problem?</p></blockquote></div><p>From the user interface deleted the wan firewall zone, so all rules in the firewall got deleted. This DLink DSL2750U does not have any physical wan interface. It has ADSL port (not supported by openwrt) and 4 lan ports. One of the port is being used to connect to main router.</p><p>Also added the reverse rule as suggested. But I do not see any change in the behaviour of the network. Still, all data from wifi devices is not going through the tunnel.</p><p>New firewall rules :-<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# cat /etc/config/firewall

config defaults
        option syn_flood &#039;1&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;

config zone
        option name &#039;lan&#039;
        list network &#039;lan&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;ACCEPT&#039;

config include
        option path &#039;/etc/firewall.user&#039;

config zone
        option name &#039;vpnfirewall&#039;
        option output &#039;ACCEPT&#039;
        list network &#039;nordvpntun&#039;
        option input &#039;ACCEPT&#039;
        option forward &#039;ACCEPT&#039;

config forwarding
        option dest &#039;lan&#039;
        option src &#039;vpnfirewall&#039;

config forwarding
        option dest &#039;vpnfirewall&#039;
        option src &#039;lan&#039;</code></pre></div>											<p class="post-edited">(Last edited by <strong>goldy</strong> on 18 Sep 2017, 21:44)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365539">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						18 Sep 2017, 22:37					</div>
				</div>
				<div class="post-content content">
					<p>Ok, now I understand your problem. </p><p>Usually in an OpenVPN setup, the server end uses the &quot;push route&quot; command, which causes the client to create one or more routing table entries for subnets that are found from beyond the tunnel.</p><p>The server can also use the &#039;redirect-gateway def1&#039; command in order to instruct the client to update its default route in the routing table so it points through the VPN tunnel.</p><p>To ensure that your client is respecting these routes (and the potential &#039;redirect-gateway def1&#039; instruction), check that your OpenVPN client configuration file (/etc/config/openvpn) does not have &#039;route_nopull&#039; option. If set, this option causes the client to ignore the potential routes pushed by the server.</p><p>Most OpenVPN servers use these commands, so you might want to check with your VPN service provider to ensure that these commands are sent in the first place. If the commands are sent, then you might need to increase the metric value of the gateway that is configured to the &#039;lan&#039; logical network. To do so, adjust your network configuration file as follows:<br /></p><div class="codebox"><pre><code>config interface &#039;lan&#039;
        option ifname &#039;eth0.1&#039;
        option force_link &#039;1&#039;
        option proto &#039;static&#039;
        option netmask &#039;255.255.255.0&#039;
        option ip6assign &#039;60&#039;
        option ipaddr &#039;192.168.1.98&#039;
        option gateway &#039;192.168.1.1&#039;
        option metric &#039;10&#039;                # Set the metric value of this gateway to 10
        option dns &#039;192.168.1.1&#039;
        option type &#039;bridge&#039;</code></pre></div><p>Try with these changes first, and see if the default route gets set correctly when the VPN tunnel is established. Also, make sure that the default route gets changed back when you drop the VPN tunnel.</p><p>If, for some reason, the server does not send the &#039;redirect-gateway def1&#039; instruction, or does not push the route entries, then you can manually add them by using the &#039;option route&#039; in your OpenVPN configuration file.</p><p>For example, in order to create a default route entry that points through the tunnel, an option such as the following needs to be added:<br /></p><div class="codebox"><pre><code>    ... other config ...
    option route &#039;0.0.0.0 0.0.0.0&#039;</code></pre></div><p>The option value consists of an IP address and a netmask.</p><p>Adding this option also requires that you adjust the metric value of the other gateway in your network configuration file. I do not know if it is possible to configure gateway address or its metric value into this option.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365595">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">goldy</div>
					<div class="post-datetime">
						20 Sep 2017, 17:42					</div>
				</div>
				<div class="post-content content">
					<p>/etc/config/openvpn is a default configuration file. I have not touched it, instead following file was created which openvpn picks it by itself</p><div class="codebox"><pre><code>root@OpenWrt:~# cat /etc/openvpn/in3.nordvpn.com.tcp443.conf


#           _   _               ___     ______  _   _
#          | \ | | ___  _ __ __| \ \   / /  _ \| \ | |
#          |  \| |/ _ \| &#039;__/ _` |\ \ / /| |_) |  \| |
#          | |\  | (_) | | | (_| | \ V / |  __/| |\  |
#          |_| \_|\___/|_|  \__,_|  \_/  |_|   |_| \_|
#


client
dev tun
proto tcp
remote 137.59.52.98 443
resolv-retry infinite
remote-random
nobind
tun-mtu 1500
tun-mtu-extra 32
mssfix 1450
persist-key
persist-tun
ping 15
ping-restart 0
ping-timer-rem
reneg-sec 0

remote-cert-tls server

#mute 10000
auth-user-pass secret

comp-lzo
verb 3
pull
fast-io
cipher AES-256-CBC

key-direction 1
ca ca.crt
tls-auth ta.key 1</code></pre></div><p>Asking from the VPN provider didn&#039;t help much, didn&#039;t get the reply. So if I am assume, they must be sending &#039;redirect-gateway def1&#039; instruction, then following are the routes before and after tunnel initiation, independent of metric &#039;10&#039; value. Whether I set metric value or not, routes before and after tunnel initiation remains same as below.</p><p>Before starting the tunnel.<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         192.168.1.1     0.0.0.0         UG    10     0        0 br-lan
192.168.1.0     *               255.255.255.0   U     10     0        0 br-lan</code></pre></div><p>After starting the tunnel<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         10.7.7.1        128.0.0.0       UG    0      0        0 tun0
default         192.168.1.1     0.0.0.0         UG    10     0        0 br-lan
10.7.7.0        *               255.255.255.0   U     0      0        0 tun0
128.0.0.0       10.7.7.1        128.0.0.0       UG    0      0        0 tun0
137.59.52.98    192.168.1.1     255.255.255.255 UGH   0      0        0 br-lan
192.168.1.0     *               255.255.255.0   U     10     0        0 br-lan</code></pre></div><p>Since I am not using openvpn configuration file, then how to set the &#039;option route&#039; settings ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365602">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						20 Sep 2017, 19:51					</div>
				</div>
				<div class="post-content content">
					<p>The &#039;pull&#039; option is present in your OpenVPN configuration file, hence potential routes sent by the server are respected. </p><p>In order to add routes directly to the OpenVPN configuration file, use an entry such as &#039;route &lt;ip addr&gt; &lt;netmask&gt;&#039;. For reference, you can use the OpenVPN man-pages: <a href="https://openvpn.net/index.php/open-source/documentation/manuals/openvpn-20x-manpage.html">https://openvpn.net/index.php/open-sour … npage.html</a>. All options added to the configuration file are similar to their command-line variants, only with the leading double-dashes omitted.</p><p>The routing table output shows that a new default route was added when the tunnel is up, and that it&#039;s metric value is now lower than that of the default route through &#039;br-lan&#039;. The server is using &#039;redirect-gateway def1&#039; command. This is apparent from the genmask value, and the fact that the previous default route doesn&#039;t get removed.</p><p>However, even with these changes, the packets are not routed correctly through the tunnel? What means do you use to verify the behavior?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365603">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">goldy</div>
					<div class="post-datetime">
						20 Sep 2017, 20:16					</div>
				</div>
				<div class="post-content content">
					<p>I connect a device via WiFi to the Dlink router running openwrt and open in the browser, either whatismyip.com or ipleak.net</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365609">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						20 Sep 2017, 22:20					</div>
				</div>
				<div class="post-content content">
					<p>The following option, when placed to your OpenVPN config file, should create a default route through the VPN remote endpoint with a metric value of 0.</p><div class="codebox"><pre><code>route 0.0.0.0 0.0.0.0 vpn_gateway 0</code></pre></div><p>It is a bit uncertain whether the &#039;vpn_gateway&#039; will be resolved correctly. But give it a spin, and see what the routing table looks like with this change. </p><p>Note that this option most likely wipes the previous default route through &#039;br-lan&#039;, so setting up, and then tearing down the VPN tunnel might leave your router without a default routing table entry. Proceed with care.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365655">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">goldy</div>
					<div class="post-datetime">
						21 Sep 2017, 22:29					</div>
				</div>
				<div class="post-content content">
					<p>Added this option in OpenVPN config file, and the route changed as follows :</p><div class="codebox"><pre><code>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         10.7.7.1        128.0.0.0       UG    0      0        0 tun0
default         10.7.7.1        0.0.0.0         UG    0      0        0 tun0
default         192.168.1.1     0.0.0.0         UG    0      0        0 br-lan
10.7.7.0        *               255.255.255.0   U     0      0        0 tun0
128.0.0.0       10.7.7.1        128.0.0.0       UG    0      0        0 tun0
137.59.52.98    192.168.1.1     255.255.255.255 UGH   0      0        0 br-lan
192.168.1.0     *               255.255.255.0   U     0      0        0 br-lan</code></pre></div><p>But still it would not help. </p><p>By the way, made a discovery, when I try to access internet from the OpenWRT command line, traffic goes via tunnel. Verified this by calling HTTPbin.org/ip website via wget, received VPN IP in response when connected to tunnel and received my original IP when tunnel was disconnected. So basically, LAN ports and WLAN doesn&#039;t respect the routing table of openwrt.</p><p>Could it be due to the fact, that the main router provides DHCP services and WLAN of openwrt router is bridged to LAN, so routing table of main router is being followed? Or if not, what else could be the mystery?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365663">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						22 Sep 2017, 00:25					</div>
				</div>
				<div class="post-content content">
					<p>Looks like adding the &#039;route&#039; option doesn&#039;t solve it, so you can take it out of the configuration file.</p><p>You are correct about the bridging scenario. When the main router provides a DHCP service then you cannot route all traffic through the VPN tunnel: the DHCP renew messages would get lost, and your wireless clients would likely lose network connectivity altogether when the tunnel is up.</p><p>You might achieve a transparent wireless bridge/VPN -setup by using a TAP interface, but I doubt the NordVPN service provider allows this.</p><p>To achieve your primary goal, I suggest you change your network layout a little bit: choose one of the LAN ports on the OpenWRT router, and create a new VLAN on this port. Create a new logical network on this virtual adapter, name it &quot;WAN&quot; and have it use a DHCP client. The main router will provide this address. Add a new firewall zone for this logical network, and allow all traffic.</p><p>Now, re-enable DHCP service on the &quot;LAN&quot; logical network of the OpenWRT router, and change the statically assigned address to something else than what the primary router is using.</p><p>Here are a few configuration files to give you the general idea. They are based on your current configuration, but with the above adjustments:<br /></p><div class="codebox"><pre><code>root@OpenWrt:/etc/config# cat network

config interface &#039;loopback&#039;
        option ifname &#039;lo&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;127.0.0.1&#039;
        option netmask &#039;255.0.0.0&#039;

config globals &#039;globals&#039;
        option ula_prefix &#039;fd9b:a069:030c::/48&#039;

config switch
        option name &#039;eth0&#039;
        option reset &#039;1&#039;
        option enable_vlan &#039;1&#039;

# Added a new VLAN on port 0
config switch_vlan
        option device &#039;eth0&#039;
        option vlan &#039;1&#039;
        option ports &#039;0 8t&#039;

config switch_vlan
        option device &#039;eth0&#039;
        option vlan &#039;2&#039;              # Adjusted the second VLAN&#039;s ordinal number
        option ports &#039;1 2 3 8t&#039;      # Remove port 0 from here

# Added a new interface
config interface &#039;wan&#039;
        option ifname &#039;eth0.1&#039;
        option proto &#039;dhcp&#039;

config interface &#039;lan&#039;
        option ifname &#039;eth0.2&#039;    # Adjusted the VLAN number to match
        option proto &#039;static&#039;
        option netmask &#039;255.255.255.0&#039;
        option ip6assign &#039;60&#039;
        option ipaddr &#039;192.168.2.1&#039;  # Altered the network address so it differs from primary router&#039;s
        option type &#039;bridge&#039;

config interface &#039;nordvpntun&#039;
        option ifname &#039;tun0&#039;
        option proto &#039;none&#039;</code></pre></div><p>----<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# cat /etc/config/firewall

config defaults
        option syn_flood &#039;1&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;

# Added a new zone, with masquerading
config zone
        option name &#039;wan&#039;
        list network &#039;wan&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;ACCEPT&#039;
        option masq &#039;1&#039;
        option mtu_fix &#039;1&#039;

config zone
        option name &#039;lan&#039;
        list network &#039;lan&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;ACCEPT&#039;

config include
        option path &#039;/etc/firewall.user&#039;

config zone
        option name &#039;vpnfirewall&#039;
        list network &#039;nordvpntun&#039;
        option output &#039;ACCEPT&#039;
        option input &#039;ACCEPT&#039;
        option forward &#039;ACCEPT&#039;
        option masq &#039;1&#039;        # Remove if remote network hosts do not need to communicate with hosts in &#039;lan&#039;

# Remove this rule if remote network hosts do not need to communicate with hosts in &#039;lan&#039;
config forwarding
        option dest &#039;lan&#039;
        option src &#039;vpnfirewall&#039;

config forwarding
        option dest &#039;vpnfirewall&#039;
        option src &#039;lan&#039;

# Added a new forwarding rule; allows Internet access when the tunnel is down
config forwarding
        option src &#039;lan&#039;
        option dest &#039;wan&#039;</code></pre></div><p>You did not post your DHCP configuration file, so I cannot write an example for it. But if you look at the OpenWRT DHCP Wiki page, you should figure out how to configure the DHCP pools accordingly. Ignore the pool on &#039;wan&#039; logical network, and enable it on &#039;lan&#039;, using suitable values. Remember to ensure that &#039;dnsmasq&#039; daemon is enabled and running; it provides the DHCP service on the OpenWRT router</p><p>I wrote these two examples at the dead of night, so remember to check for typos and other subtleties if you intend to use them <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365716">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">goldy</div>
					<div class="post-datetime">
						22 Sep 2017, 20:39					</div>
				</div>
				<div class="post-content content">
					<p>Thanks a lot, at last it worked with exact these configs provided by you. After so many days of troubleshooting and struggling with openwrt, learned hell lot of things about routing and openwrt. I really appreciate your help.</p><p>For others, to view in future, following DHCP config I applied at OpenWRT router :-</p><div class="codebox"><pre><code>root@OpenWrt:~# cat /etc/config/dhcp

config dnsmasq
        option domainneeded &#039;1&#039;
        option boguspriv &#039;1&#039;
        option filterwin2k &#039;0&#039;
        option localise_queries &#039;1&#039;
        option rebind_protection &#039;1&#039;
        option rebind_localhost &#039;1&#039;
        option local &#039;/lan/&#039;
        option domain &#039;lan&#039;
        option expandhosts &#039;1&#039;
        option nonegcache &#039;0&#039;
        option authoritative &#039;1&#039;
        option readethers &#039;1&#039;
        option leasefile &#039;/tmp/dhcp.leases&#039;
        option resolvfile &#039;/tmp/resolv.conf.auto&#039;
        option localservice &#039;1&#039;

config dhcp &#039;lan&#039;
        option interface &#039;lan&#039;
        option start &#039;100&#039;
        option limit &#039;150&#039;
        option leasetime &#039;12h&#039;
        option ra server
        option dhcpv6 server

config dhcp &#039;wan&#039;
        option interface &#039;wan&#039;
        option ignore &#039;1&#039;

config odhcpd &#039;odhcpd&#039;
        option maindhcp &#039;0&#039;
        option leasefile &#039;/tmp/hosts/odhcpd&#039;
        option leasetrigger &#039;/usr/sbin/odhcpd-update&#039;

config dhcp &#039;nordvpntun&#039;
        option interface &#039;nordvpntun&#039;
        option ignore &#039;1&#039;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365753">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						23 Sep 2017, 09:57					</div>
				</div>
				<div class="post-content content">
					<p>You&#039;re welcome. Glad I was able to help <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p372843">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">goldy</div>
					<div class="post-datetime">
						26 Feb 2018, 20:39					</div>
				</div>
				<div class="post-content content">
					<p>An extended query to above. This Dlink router hardware is not good enough and VPN traffic is not fast enough due to high computational requirements of encryption involved. So is it possible to offload this VPN heavy workload to a machine connected to this router via ethernet? How shall the network be tweaked on openwrt and the machine?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p373157">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">ulmwind</div>
					<div class="post-datetime">
						3 Mar 2018, 15:14					</div>
				</div>
				<div class="post-content content">
					<p><strong>goldy</strong>, sorry, don&#039;t understand your question clearly. Do you want to run client or server instance of OpenVPN?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p373448">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">goldy</div>
					<div class="post-datetime">
						8 Mar 2018, 17:29					</div>
				</div>
				<div class="post-content content">
					<p>Client instance. I was running it on the dlink but now want to offload it to a machine connected to the same dlink router. So just want to figure out, how network configurations should be in place, so that all traffic of dlink router goes through the machine, where vpn client is running.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p373536">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">600cc</div>
					<div class="post-datetime">
						10 Mar 2018, 15:44					</div>
				</div>
				<div class="post-content content">
					<p>Yes, you can set up a separate computer to be the VPN endpoint, and send your LAN traffic through it so that it goes out of tun0. Your computer can have a single NIC, or it can have multiple NICs. A single-NIC instance is known as a &quot;hairpin&quot;, or &quot;router on a stick&quot;. Those terms might help you in your searches.</p><p>Here&#039;s how to get it to work:<br /></p><ul><li><p>Decide which devices must use the VPN</p></li><li><p>Configure your network so that those devices use the VPN computer as their default gateway.</p></li><li><p>Configure the VPN computer to forward traffic from those devices through tun0.</p></li><li><p>Configure the VPN computer&#039;s default gateway to be the D-Link router.</p></li><li><p>If the VPN computer is running a filter/firewall (e.g. iptables) then configure it to allow traffic forwarding. Remember that the LAN and WAN zones will be different, even with a single NIC. You must create two logical interfaces, one for each zone.</p></li></ul>											<p class="post-edited">(Last edited by <strong>600cc</strong> on 10 Mar 2018, 19:37)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p374269">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">goldy</div>
					<div class="post-datetime">
						22 Mar 2018, 21:03					</div>
				</div>
				<div class="post-content content">
					<p>Thanks, router-on-a-stick term did help. But before that I had to learn a lot on VLAN stuff. </p><p>Now somehow I have been able to setup the network as you suggested, by creating a new vlan3 for traffic from VPN computer&#039;s 2nd interface back to D-link router(as gateway=192.168.3.1). Devices connected to vlan 2 use VPN computer as gateway but can&#039;t connect to internet or VPN. Internet and 192.168.1.0/24 are reachable from VPN computer.</p><p>On VPN computer, net.ipv4.ip_forward=1 and iptables is blank with no rules and default policy to accept on input, output and forward in filter table.</p><p>1. What is missing here? Devices on 192.168.2.0/24 are able to reach 192.168.3.x (VPN computer 2nd interface) but not 192.168.3.0/24 or internet.<br />2. Do I really require 3 VLANs? Is there any scope of optimization without creating complexity?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p374274">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">600cc</div>
					<div class="post-datetime">
						22 Mar 2018, 23:27					</div>
				</div>
				<div class="post-content content">
					<p>If you&#039;re looking to force the network path used by other people&#039;s computers, then you will need multiple VLANs, otherwise what&#039;s to stop the other users from getting wise and switching gateways?</p><p>If you&#039;re the only user, you can get away with two VLANs, but you might find it&#039;s a bit more complex than you were expecting. You can have both of the VPN computer&#039;s NICs in the same VLAN/subnet. It requires paying some attention to routing tables and iptables, but it&#039;s possible. Frankly, I&#039;d go for a serial approach, with three VLANs (the WAN interface of one device connects to the LAN interface of the next device, and so on), instead of trying to be clever with same-subnet routing. It&#039;s easier.</p><p>I recently wanted to know about using specific interfaces for specific traffic, and this post - <a href="https://forum.openwrt.org/viewtopic.php?pid=373938#p373938">https://forum.openwrt.org/viewtopic.php … 38#p373938</a> - contains a link to a StackExchange page which helped me. It might help you, too, if you do decide to play with same-subnet routing.</p><p>For example, Internet router (D-Link) IP address: 192.168.2.1<br />VPN computer &quot;output&quot; IP address: 192.168.2.2<br />VPN computer &quot;input&quot; IP address: 192.168.2.3</p><p>Tell your computers to use 192.168.2.3 as their default gateway, and they&#039;ll shunt all their traffic at the VPN computer. Then the VPN computer can handle the VPN tunnel and routing needed.</p><p>What are the outputs from the following commands, run on the VPN computer?<br />* ifconfig -a<br />* route -n<br />* ps -ef | grep openvpn</p>											<p class="post-edited">(Last edited by <strong>600cc</strong> on 22 Mar 2018, 23:30)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p374299">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">goldy</div>
					<div class="post-datetime">
						23 Mar 2018, 17:01					</div>
				</div>
				<div class="post-content content">
					<p>Openvpn process is running and tunnel is running fine. Browsing on VPN computer goes through the VPN tunnel. ens160 is lan side and ens224 is wan side of VPN computer.</p><div class="codebox"><pre><code>ifconfig -a
ens160    Link encap:Ethernet  HWaddr 00:0c:29:15:a3:a6  
          inet addr:192.168.2.212  Bcast:192.168.2.255  Mask:255.255.255.0
          inet6 addr: fe80::3d15:3d3:a47b:bad8/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:4606 errors:0 dropped:0 overruns:0 frame:0
          TX packets:764 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:356606 (356.6 KB)  TX bytes:76827 (76.8 KB)

ens224    Link encap:Ethernet  HWaddr 00:0c:29:15:a3:b0  
          inet addr:192.168.3.222  Bcast:192.168.3.255  Mask:255.255.255.0
          inet6 addr: fe80::e3bd:3ac0:69:c6c5/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:7446 errors:0 dropped:0 overruns:0 frame:0
          TX packets:8185 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:5451814 (5.4 MB)  TX bytes:1404920 (1.4 MB)

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:2549 errors:0 dropped:0 overruns:0 frame:0
          TX packets:2549 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1 
          RX bytes:786534 (786.5 KB)  TX bytes:786534 (786.5 KB)

tun0      Link encap:UNSPEC  HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  
          inet addr:10.15.0.4  P-t-P:10.15.0.4  Mask:255.255.0.0
          inet6 addr: fdda:d0d0:cafe:1301::1002/64 Scope:Global
          UP POINTOPOINT RUNNING NOARP MULTICAST  MTU:1500  Metric:1
          RX packets:6474 errors:0 dropped:0 overruns:0 frame:0
          TX packets:7091 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:100 
          RX bytes:4076423 (4.0 MB)  TX bytes:695784 (695.7 KB)</code></pre></div><p>xx.xx.xx.xx is the VPN provider&#039;s address hard coded in the openvpn config file<br />192.168.2.212 is provided by DHCP server running at 192.168.2.1 (DLink Router) as gateway to all devices including VPN computer.</p><div class="codebox"><pre><code>route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.15.0.1       128.0.0.0       UG    0      0        0 tun0
0.0.0.0         192.168.3.1     0.0.0.0         UG    100    0        0 ens224
0.0.0.0         192.168.2.212   0.0.0.0         UG    101    0        0 ens160
10.15.0.0       0.0.0.0         255.255.0.0     U     0      0        0 tun0
xx.xx.xx.xx    192.168.3.1     255.255.255.255 UGH   0      0        0 ens224
128.0.0.0       10.15.0.1       128.0.0.0       UG    0      0        0 tun0
169.254.0.0     0.0.0.0         255.255.0.0     U     1000   0        0 ens160
192.168.2.0     0.0.0.0         255.255.255.0   U     100    0        0 ens160
192.168.3.0     0.0.0.0         255.255.255.0   U     100    0        0 ens224</code></pre></div><p>And god knows what 169.254.0.0 entry is ? :-)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p374324">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">600cc</div>
					<div class="post-datetime">
						24 Mar 2018, 03:17					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>goldy wrote:</cite><blockquote><p>ens160 is lan side and ens224 is wan side of VPN computer.</p></blockquote></div><p>That might be part of the problem, judging by the config you posted.</p><p>If your VPN computer can reach the D-Link router (and the other end of the VPN tunnel), it should be doing so from its own WAN interface, not its LAN interface. That&#039;s not a technical limitation, but a conceptual one; it can help to distinguish between LAN and WAN when trying to work out device behaviour.</p><p>It makes connections from its WAN; it accepts connections into its LAN.</p><p>The other thing which is curious, is the gateway shown by your VPN computer&#039;s routing table. Your VPN computer appears to be connecting through a gateway at 192.168.3.1, but it&#039;s not immediately obvious which device has that IP address. Is that a secondary address on your D-Link router?</p><br /><div class="quotebox"><cite>goldy wrote:</cite><blockquote><p>And god knows what 169.254.0.0 entry is ? :-)</p></blockquote></div><p><a href="https://en.wikipedia.org/wiki/Link-local_address#IPv4">https://en.wikipedia.org/wiki/Link-local_address#IPv4</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p374342">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">goldy</div>
					<div class="post-datetime">
						24 Mar 2018, 11:20					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>600cc wrote:</cite><blockquote><p>If your VPN computer can reach the D-Link router (and the other end of the VPN tunnel), it should be doing so from its own WAN interface, not its LAN interface. That&#039;s not a technical limitation, but a conceptual one; it can help to distinguish between LAN and WAN when trying to work out device behaviour.</p></blockquote></div><p>Isn&#039;t it already doing? That&#039;s why tunnel was able to run. VPN computer is able to reach DLink at 192.168.3.1 and further to 192.168.1.1(internet main router)</p><div class="quotebox"><cite>600cc wrote:</cite><blockquote><p>It makes connections from its WAN; it accepts connections into its LAN.</p></blockquote></div><p>From WAN, connections seems to work fine. I doubt from the LAN side, if it is able to accept that. Do you think routing is fine? And shouldn&#039;t blank iptables allow everything or should I explicitly add some rule in Forward chain?</p><div class="quotebox"><cite>600cc wrote:</cite><blockquote><p>The other thing which is curious, is the gateway shown by your VPN computer&#039;s routing table. Your VPN computer appears to be connecting through a gateway at 192.168.3.1, but it&#039;s not immediately obvious which device has that IP address. Is that a secondary address on your D-Link router?</p></blockquote></div><p>Yes.<br />Following is the Dlink ifconfig<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# ifconfig
br-lan    Link encap:Ethernet  HWaddr AC:F1:DF:E7:F9:30
          inet addr:192.168.2.1  Bcast:192.168.2.255  Mask:255.255.255.0
          inet6 addr: fd9b:a069:30c:10::1/60 Scope:Global
          inet6 addr: fe80::aef1:dfff:fee7:f930/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:476730 errors:0 dropped:168 overruns:0 frame:0
          TX packets:600672 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:44361336 (42.3 MiB)  TX bytes:540052981 (515.0 MiB)

eth0      Link encap:Ethernet  HWaddr AC:F1:DF:E7:F9:30
          inet6 addr: fe80::aef1:dfff:fee7:f930/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:3872819 errors:0 dropped:0 overruns:0 frame:0
          TX packets:3182721 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:3058062997 (2.8 GiB)  TX bytes:1557080793 (1.4 GiB)

eth0.1    Link encap:Ethernet  HWaddr AC:F1:DF:E7:F9:30
          inet addr:192.168.1.98  Bcast:192.168.1.255  Mask:255.255.255.0
          inet6 addr: fe80::aef1:dfff:fee7:f930/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1107290 errors:0 dropped:0 overruns:0 frame:0
          TX packets:555352 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:816216668 (778.4 MiB)  TX bytes:80253943 (76.5 MiB)

eth0.2    Link encap:Ethernet  HWaddr AC:F1:DF:E7:F9:30
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1586832 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1359298 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:1545826744 (1.4 GiB)  TX bytes:152414758 (145.3 MiB)

eth0.3    Link encap:Ethernet  HWaddr AC:F1:DF:E7:F9:30
          inet addr:192.168.3.1  Bcast:192.168.3.255  Mask:255.255.255.0
          inet6 addr: fd9b:a069:30c::1/64 Scope:Global
          inet6 addr: fe80::aef1:dfff:fee7:f930/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:256788 errors:0 dropped:130 overruns:0 frame:0
          TX packets:254804 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:44014322 (41.9 MiB)  TX bytes:289030038 (275.6 MiB)

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:29619 errors:0 dropped:0 overruns:0 frame:0
          TX packets:29619 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:2273241 (2.1 MiB)  TX bytes:2273241 (2.1 MiB)

wlan0     Link encap:Ethernet  HWaddr AC:F1:DF:E7:F9:31
          inet6 addr: fe80::aef1:dfff:fee7:f931/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1719353 errors:0 dropped:0 overruns:0 frame:0
          TX packets:2172530 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:167322740 (159.5 MiB)  TX bytes:2121445733 (1.9 GiB)</code></pre></div><p>Router with 192.168.1.1 is the main internet router. Vlan1 (192.168.1.0/24) connects Dlink to main internet router, Vlan2 (192.168.2.0/24) connects all wlan devices and DLink to VPN computer Lan Interface (ens160), Vlan3 (192.168.3.0/24) connects VPN computer Wan interface (ens224) back to Dlink at 192.168.3.1(eth0.3)</p><p>I hope you now have enough clarity on the whole network design.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p374349">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">600cc</div>
					<div class="post-datetime">
						24 Mar 2018, 13:42					</div>
				</div>
				<div class="post-content content">
					<p>Give me a bit. I&#039;ll fish out Visio and knock up a diagram, which might better help to illustrate. When I wrote my post last night, it made perfect sense... to me. Now, after some sleep, I&#039;m struggling to make sense of my words. I know what I want to illustrate, so I&#039;ll do just that: illustrate.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p374351">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">600cc</div>
					<div class="post-datetime">
						24 Mar 2018, 14:24					</div>
				</div>
				<div class="post-content content">
					<p>As promised, here is a diagram which might better help to illustrate. The IP addresses are illustrative only; feel free to change them to suit your needs. But I hope the concept of two subnets (broadcast domains) sharing the same VLAN (collision domain) is clear.</p><p><span class="postimg"><img src="https://i.imgur.com/LBVYNpa.png" alt="https://i.imgur.com/LBVYNpa.png" /></span></p><p>(I&#039;m aware it&#039;s not a pretty diagram; I&#039;m a complete novice when it comes to Visio.)</p>											<p class="post-edited">(Last edited by <strong>600cc</strong> on 24 Mar 2018, 14:27)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p374367">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">goldy</div>
					<div class="post-datetime">
						24 Mar 2018, 19:34					</div>
				</div>
				<div class="post-content content">
					<p>Your diagram is pretty clear and understandable. And here is what I have laid out in past few weeks :-</p><p><span class="postimg"><img src="https://i.imgur.com/YMCydd5.jpg" alt="https://i.imgur.com/YMCydd5.jpg" /></span></p><p>If I compare, the only difference is use of one extra vlan. In the end, both intend to do the same thing. But why things don&#039;t work in mine, that&#039;s the quest? What is missing in the puzzle?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p374412">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">600cc</div>
					<div class="post-datetime">
						25 Mar 2018, 13:43					</div>
				</div>
				<div class="post-content content">
					<p>Good question. I&#039;ve only just had some coffee a few minutes ago, so my brain isn&#039;t yet in gear.</p><p>To recap, in case I&#039;ve missed something:<br />* Your VPN computer can open a VPN connection over its WAN interface (192.168.3.222) to a remote endpoint and can send its own traffic down the tunnel.<br />* Other devices are configured to use the VPN computer&#039;s LAN interface (192.168.2.212) as their default gateway, but are unable to send traffic further.</p><p>This might be a really dumb question (and apologies if it is), but are you positive that IPv4 forwarding is enabled in sysctl.conf on the VPN computer?</p><p>Also, on the VPN computer, is your iptables filter table completely empty, or does it have rules to permit established/related traffic (in other words, the return traffic triggered by the outbound traffic)?</p>											<p class="post-edited">(Last edited by <strong>600cc</strong> on 25 Mar 2018, 13:45)</p>
									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=72091&amp;p=2.html">2</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>