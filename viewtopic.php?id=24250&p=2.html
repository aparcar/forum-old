<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Howto move root fs to sdcard on WRT54GL v1.1 (10.3)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 8 Feb 2018 and 4 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 2 of 3</div><nav><ul><li><a href="viewtopic.php%3Fid=24250&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=24250&amp;p=3.html">3</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p107265">
				<div class="post-metadata">
					<div class="post-num">Post #26</div>
					<div class="post-author">Dogge</div>
					<div class="post-datetime">
						18 Apr 2010, 20:37					</div>
				</div>
				<div class="post-content content">
					<p>VecH, join #openwrt @ freenode on IRC.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107266">
				<div class="post-metadata">
					<div class="post-num">Post #27</div>
					<div class="post-author">VecH</div>
					<div class="post-datetime">
						18 Apr 2010, 20:52					</div>
				</div>
				<div class="post-content content">
					<p>I from russia, cannot that or there understand<br />IRC the client is not established</p><p>p.s. After successful performance of a task in view: flash card installation as root system<br />I will write article for all users with WRT54GL v1.1</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107267">
				<div class="post-metadata">
					<div class="post-num">Post #28</div>
					<div class="post-author">VecH</div>
					<div class="post-datetime">
						18 Apr 2010, 21:12					</div>
				</div>
				<div class="post-content content">
					<p>I am recompiled image and upgrade firmware<br />all soft and modules installed</p><p>After:</p><div class="codebox"><pre><code>echo &quot;0x009c&quot; &gt; /proc/diag/gpiomask
insmod sdhc clk=3 din=2 dout=4 cs=7 major=0 maxsec=32 rahead=2</code></pre></div><p>card detected<br /></p><div class="codebox"><pre><code>root@OpenWrt:/mnt# dmesg
...
[INF] sdhc: Version: 2.0.2  Parms: major=0 din=2 dout=4 clk=3 cs=7 maxsec=32 rahead=2
[INF] sdhc: MM card detected &amp; initialized
[INF] sdhc: Assigned dynamic major number 254
Partition check:
 /dev/sdcard: p1 p2
[INF] sdhc: Module loaded</code></pre></div><div class="codebox"><pre><code>root@OpenWrt:/mnt# df -h
Filesystem                Size      Used Available Use% Mounted on
/dev/root                 2.3M      2.3M         0 100% /rom
tmpfs                     7.0M     44.0K      7.0M   1% /tmp
root                      2.3M      2.3M         0 100% /tmp/root
mini_fo:/tmp/root         2.3M      2.3M         0 100% /tmp/root
/dev/mtdblock/4         896.0K    328.0K    568.0K  37% /overlay
mini_fo:/overlay          2.3M      2.3M         0 100% /
root@OpenWrt:/mnt#</code></pre></div><div class="codebox"><pre><code>root@OpenWrt:/mnt# ls -al /dev/sdcard/
drwxr-xr-x    1 root     root            0 Jan  1  1970 .
drwxr-xr-x    1 root     root            0 Jan  1  1970 ..
brw-------    1 root     root     254,   0 Jan  1  1970 disc
brw-------    1 root     root     254,   1 Jan  1  1970 part1
brw-------    1 root     root     254,   2 Jan  1  1970 part2</code></pre></div><div class="codebox"><pre><code>root@OpenWrt:/mnt# blkid
/dev/sdcard/part1: UUID=&quot;1096dc93-24d8-4374-9554-e153e54fa9d6&quot;
root@OpenWrt:/mnt#</code></pre></div><p><strong>How preliminary to load the module with parametres and to mount a flash card as a root folder ?</strong></p>											<p class="post-edited">(Last edited by <strong>VecH</strong> on 18 Apr 2010, 21:21)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107496">
				<div class="post-metadata">
					<div class="post-num">Post #29</div>
					<div class="post-author">Mr_Smoke</div>
					<div class="post-datetime">
						21 Apr 2010, 16:33					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>I&#039;m also very interested in getting this to work on Backfire.</p><p>So far, I&#039;ve built a custom image containing all the necessary packages. All that&#039;s left is how to trick OpenWRT into making the SD card available so that extroot will actually mount it in the right place.</p><p>My first thought was to create a config file for the sdhc module. Example for /etc/modules.d/33-sdhc:<br /></p><div class="codebox"><pre><code># May be required for rootfs
sdhc major=0 din=2 dout=4 clk=3 cs=7 maxsec=32 rahead=2</code></pre></div><p>/etc/config/fstab:<br /></p><div class="codebox"><pre><code>config global automount
    option from_fstab 1
    option anon_mount 1
    
config global autoswap
    option from_fstab 1
    option anon_swap 0
    
config mount
    option target    /mnt
    option device    /dev/sdcard/part1
    option fstype    ext2
    option options    rw,sync
    option enabled    1
    option enabled_fsck 0
    option is_rootfs 1
    
config swap
    option device    /dev/sda2
    option enabled    0</code></pre></div><p>(I have chosen ext2 and build the image with kmod-fs-ext2 obviously).</p><p>So far this has achieved nothing apart from the fact that the SD card is available after boot under /dev/sdcard ... but extroot is not kicking in.</p><p>Any thoughts ?</p><p>Cheers,</p><p>Romain</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107502">
				<div class="post-metadata">
					<div class="post-num">Post #30</div>
					<div class="post-author">VecH</div>
					<div class="post-datetime">
						21 Apr 2010, 17:11					</div>
				</div>
				<div class="post-content content">
					<p>Your device WRT54GL v1.1 ?<br />attach please you config for build image/firmware</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107518">
				<div class="post-metadata">
					<div class="post-num">Post #31</div>
					<div class="post-author">Mr_Smoke</div>
					<div class="post-datetime">
						21 Apr 2010, 18:57					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>I just built OpenWRT with the necessary packages (kmod-fs-ext2, kmod-broadcom-sdhc etc.) and created the files quoted above.<br />But clearly that&#039;s not enough.</p><p>What happens right now is that the device boots, the DMZ LED stays up, and the sms_orange LED flashes like there was crazy I/O going on (ie. irregular and fast blinking), but the device remains in that state for ages. In other words, it doesn&#039;t boot properly.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107520">
				<div class="post-metadata">
					<div class="post-num">Post #32</div>
					<div class="post-author">VecH</div>
					<div class="post-datetime">
						21 Apr 2010, 19:37					</div>
				</div>
				<div class="post-content content">
					<p>I too have stopped on this problem<br />I can not mount SD a card in any way as root file system</p><p>Hardly above me have sent on IRC the channel, there too have not helped here again have ceased to answer</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107522">
				<div class="post-metadata">
					<div class="post-num">Post #33</div>
					<div class="post-author">Mr_Smoke</div>
					<div class="post-datetime">
						21 Apr 2010, 20:05					</div>
				</div>
				<div class="post-content content">
					<p>I can&#039;t agree with you.</p><p>I have had plenty of help from IRC folks. For instance, I was able to ask about how USB extroot worked, and that&#039;s why I created my /etc/modules.d/33-sdhc: preinit is looking for that magic &quot;# May be required for rootfs&quot; before trying to mount stuff from /etc/config/fstab. Except that it&#039;s apparently missing something else, and I&#039;m trying hard to find what it is. Maybe tomorrow I&#039;ll get a USB/Serial converter and debug this further. I&#039;ll let you know.</p><p>Cheers,</p><p>Romain</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107523">
				<div class="post-metadata">
					<div class="post-num">Post #34</div>
					<div class="post-author">VecH</div>
					<div class="post-datetime">
						21 Apr 2010, 20:23					</div>
				</div>
				<div class="post-content content">
					<p>I will be very grateful in the decision of this problem<br />Unfortunately with USB, Serial no affairs had and I can not help</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107532">
				<div class="post-metadata">
					<div class="post-num">Post #35</div>
					<div class="post-author">Dogge</div>
					<div class="post-datetime">
						21 Apr 2010, 22:13					</div>
				</div>
				<div class="post-content content">
					<p>Building brcm-2.4 now for my WRT54GL v1.1 for testing this tomorrow...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107546">
				<div class="post-metadata">
					<div class="post-num">Post #36</div>
					<div class="post-author">hculver</div>
					<div class="post-datetime">
						22 Apr 2010, 02:19					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ve configured 2 routers with a gpio based sdcard and used extroot.&nbsp; One is an wrt54gsv4 and the other a Buffalo WBR-G54.&nbsp; Both are running 10.3(backfire). Both involved creating an /etc/modules.d/31-sdhc and editing /etc/config/fstab.&nbsp; I included Utilities-&gt;disc-&gt;{fdisk,block-extroot}, Utilities-&gt;filesystem-&gt;e2fsprogs, Kernel-modules-&gt;Other-Modules-&gt;{kmod-broadcom-sdhc, kmod-diag}, Kernel-modules-&gt;Filesystems-&gt;kmod-fs-ext2.&nbsp; I also added a custom mask to /lib/preinit/50_determine_usb_root.&nbsp; Just before the er_load_modules I echo &quot;0x009c&quot; &gt; /proc/diag/gpiomask which happens to correspond to the gpio signals I am using (7,4,3,2 == 10011100).&nbsp; On my linksys my 31-sdhc looks like:<br />&nbsp; # May be required for rootfs<br />&nbsp; sdhc din=2 dout=4 clk=3 cs=7</p><p>My Buffalo required additional args to the kernel module:<br />&nbsp; # May be required for rootfs<br />&nbsp; sdhc din=6 dout=5 clk=3 cs=1 gpio_input=0xb8007060 gpio_output=0xb8007064 \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gpio_enable=0xb8007068 gpio_control=0xb800706c<br />&nbsp; <br />&nbsp; The arguments you pass during the loading of the module should be whatever worked in /etc/sdcard.conf without block-extroot.&nbsp; In my case on the WBR-G54 I needed the gpio_* arguments.&nbsp; </p><p>Interestingly, I noticed my gpiomask on the Buffalo unit is wrong.&nbsp; It should be 01101010 == 0x6a.<br />Still seems to work ok.&nbsp; I only found 2 gpio&#039;s actually used on the Buffalo and avoided them so it<br />shouldn&#039;t matter.</p><p>I had&nbsp; a 256M lexar that doesn&#039;t work in my wbr-g54 but does in the wrt54gs.&nbsp; My 1G sandisk works in both.</p><p>I had trouble making the mmc-gpio driver work reliably under 2.6 and my throughput was terrible. I could fdisk and mke2fs the partition and usually copy files to it, but eventually I would get io errors and would have to power cycle the unit to get the sdcard back (pulling the card probably would have worked, but power cycling the unit was easier).&nbsp; I removed the b43 driver, so I know it wasn&#039;t that.&nbsp; running the &quot;dd if=/dev/zero of=32M bs=4k count=8192&quot; test from the sdcard init script would always cause io errors under 2.6.</p><p>As I recall, to debug I had to figure out preinit.&nbsp; Basically most of the scripts in /lib/preinit define functions and append functions to just 3 variables, preinit_essential, preinit_main and preinit_mount_root (this happens when they are sourced by /etc/preinit).&nbsp; /etc/preinit then executes preinit_essential and preinit_main via boot_run_hook.&nbsp; /lib/preinit/80_mount_root executes the functions in preinit_mount_root similarly when it is executed as part of preinit_main.&nbsp; I found that&nbsp; via a serial console I could enter failsafe and walk thru the preinit manually to see what was going on. </p><p>I hope this helps.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107580">
				<div class="post-metadata">
					<div class="post-num">Post #37</div>
					<div class="post-author">youngjd</div>
					<div class="post-datetime">
						22 Apr 2010, 15:25					</div>
				</div>
				<div class="post-content content">
					<p>how about the read and write speed of the sdhc card, who knows?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107592">
				<div class="post-metadata">
					<div class="post-num">Post #38</div>
					<div class="post-author">Mr_Smoke</div>
					<div class="post-datetime">
						22 Apr 2010, 16:56					</div>
				</div>
				<div class="post-content content">
					<p>Hello there,</p><p>Thank you hculver! Apparently the /proc/diag/gpiomask trick did it. There is one catch though; booting without the card causes the device to hang.</p><p>I&#039;m thinking of creating a dedicated /lib/preinint script based on the sdcard init script, that would take care of the led state and the gpio mask. I&#039;ll test this and let you know. Also, I hope that this will avoid the problem where the unit hangs if no card is present.</p><p>I&#039;ll let you know.</p><p>Cheers,</p><p>Romain</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107682">
				<div class="post-metadata">
					<div class="post-num">Post #39</div>
					<div class="post-author">Mr_Smoke</div>
					<div class="post-datetime">
						23 Apr 2010, 17:39					</div>
				</div>
				<div class="post-content content">
					<p>Ok, after more testing, it seems that everything is working fine. I don&#039;t know why it hanged the first time, but now it&#039;s booting nicely from the card. The only glitch is that the leds are all messed up while the card is read, which I think is why the sdcard initscript has those led_state functions. It would be nice to re-implement them in the preinit script, but I haven&#039;t had much time to do that so far. One thing to bear in mind though is that if a preinit script is used, then we should get rid of the /etc/modules.d/xx-sdcard file, otherwise it would be loaded twice.</p><p>One question though, hculver: what read/write rates do you get from the sdcard extroot?<br />When I mount the card as a regular filesystem, I can write at about 600kb/sec. However, when it&#039;s mounted as root, I get about 8kb/sec! Any idea what might be causing that ?</p><p>Cheers<br />Romain</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107926">
				<div class="post-metadata">
					<div class="post-num">Post #40</div>
					<div class="post-author">VecH</div>
					<div class="post-datetime">
						26 Apr 2010, 08:21					</div>
				</div>
				<div class="post-content content">
					<p>Please write howto for use sdcard as rootfs</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p108094">
				<div class="post-metadata">
					<div class="post-num">Post #41</div>
					<div class="post-author">VecH</div>
					<div class="post-datetime">
						28 Apr 2010, 17:23					</div>
				</div>
				<div class="post-content content">
					<p>After steps in post <a href="https://forum.openwrt.org/viewtopic.php?pid=107496#p107496">https://forum.openwrt.org/viewtopic.php … 96#p107496</a><br />and reboot device<br />sdcard no mount as rootfs</p><p>help please<br /></p><div class="codebox"><pre><code># df -h
Filesystem                Size      Used Available Use% Mounted on
/dev/root                 2.3M      2.3M         0 100% /rom
tmpfs                     7.0M     44.0K      7.0M   1% /tmp
/dev/mtdblock/4         896.0K    328.0K    568.0K  37% /overlay
mini_fo:/overlay          2.3M      2.3M         0 100% /
/dev/sdcard/part1       956.4M     17.2M    890.6M   2% /mnt</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p108179">
				<div class="post-metadata">
					<div class="post-num">Post #42</div>
					<div class="post-author">Mr_Smoke</div>
					<div class="post-datetime">
						29 Apr 2010, 17:34					</div>
				</div>
				<div class="post-content content">
					<p>Hi there,</p><p>I&#039;ll write a full HOWTO later if you want. So far I just wanted to share some information.<br />Do *NOT* specify the &quot;sync&quot; option in /etc/config/fstab: it will only slow the whole thing down to a crawling 10kb/sec. Most of my readings online suggest that the SD card will do fine when mounted as ext2 without sync, so that&#039;s what I&#039;m doing right now.</p><p>VecH, the post you quote as a reference is merely my starting point. Since then I have made a few significant changes to my image, following recommendations from various people:<br />* create /etc/modules.d/31-sdhc containing the parameters to be passed on when loading the sdhc module (you could also modify the default parameters in sdhc.c but that&#039;s not very clean ...)<br />* edit /lib/preinit/50_determine-usb-root so as to set the proper gpiomask before actually loading the module(s)<br />* add the required packages to the image (extroot, block-mount, ext2 ...)</p><p>I was told that the config files would be better stored in the image (squashfs) so I did as I was told. It has worked nicely for me.</p><p>youngjd, FYI I get about 600kb/sec as write speed and 400kb/sec when reading.</p><p>I still have to come up with a better way to integrate the gpiomask and led handling to the preinit stuff.</p><p>Cheers !</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p108190">
				<div class="post-metadata">
					<div class="post-num">Post #43</div>
					<div class="post-author">VecH</div>
					<div class="post-datetime">
						29 Apr 2010, 19:01					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><blockquote><p>I&#039;ll write a full HOWTO later if you want.</p></blockquote></div><p>very very want ))</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p108569">
				<div class="post-metadata">
					<div class="post-num">Post #44</div>
					<div class="post-author">frameshift18</div>
					<div class="post-datetime">
						5 May 2010, 13:30					</div>
				</div>
				<div class="post-content content">
					<p>I have this same problem using a WRT54GSv4. I have built the firmware from trunk with the required packages.&nbsp; fstab mounts my card to the target mount even with is_rootfs set to 1.</p><p>I have created a /etc/modules.d/31-sdhc file as well as edited /lib/preinit/50_determine-usb-root to set the gpio mask.&nbsp; Although the gpio mask is never set.<br />I am using ext3 on my card. Does a copy of the rootfs have to be on the card for it to mount correctly? Should i be using ext2?</p><p>Any insight? Thanks</p>											<p class="post-edited">(Last edited by <strong>frameshift18</strong> on 5 May 2010, 13:34)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p108577">
				<div class="post-metadata">
					<div class="post-num">Post #45</div>
					<div class="post-author">VecH</div>
					<div class="post-datetime">
						5 May 2010, 14:33					</div>
				</div>
				<div class="post-content content">
					<p>I am wait HOWTO from <strong>Mr_Smoke</strong></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p108583">
				<div class="post-metadata">
					<div class="post-num">Post #46</div>
					<div class="post-author">mazilo</div>
					<div class="post-datetime">
						5 May 2010, 15:40					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>VecH wrote:</cite><blockquote><p>I am wait HOWTO from <strong>Mr_Smoke</strong></p></blockquote></div><p>S/he needs to finish and/or stop smoking, first. <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p108765">
				<div class="post-metadata">
					<div class="post-num">Post #47</div>
					<div class="post-author">Mr_Smoke</div>
					<div class="post-datetime">
						8 May 2010, 15:49					</div>
				</div>
				<div class="post-content content">
					<p>I managed to get extroot on the SD-card to work <strong>without</strong> the additional /etc/modules.d/31-sdhc.</p><p>What I did was simply edit the /etc/init.d/sdcard script a bit so that it could run as part of the preinit stage.</p><p>Here is the script:<br /></p><div class="codebox"><pre><code>#!/bin/sh
#
# Preinit script for sdhc card mod. Based on
# Init script for sdhc card mod - mmc, sd, sdhc support
# Script Version: 1.0
# OpenWRT Version: BACKFIRE 2.4 kernel 


# Save state of led&#039;s in /proc/diag/led/ as shell variables.
save_led_state() {
    for file in /proc/diag/led/*; do
    local var=`basename ${file}`
    local val=`cat ${file}`
    eval &quot;${var}=${val}&quot;
    done
}

# Restore saved led state. Default unknown led&#039;s to state &quot;0&quot;.
restore_led_state() {
    for file in /proc/diag/led/*; do
    local var=`basename ${file}`
    eval &quot;echo \&quot;\${$var:-0}\&quot; &gt; ${file}&quot;
    done
}

# Initialize the SD Card
init_sd_card()
{
    SD_MODNAME=&quot;sdhc&quot;
    SD_MODARG=&quot;&quot;
    SD_CONFIG=&quot;/etc/sdcard.conf&quot;

    # If no config file is found then no need to go any further
    if [ ! -r ${SD_CONFIG} ]; then
        echo &quot;sdcard - config not found: skipping&quot;
        return
    fi
    echo &quot;sdcard - found config at ${SD_CONFIG}&quot;
    . ${SD_CONFIG}

    # We can compute the GPIO pin values supplied in the config file
    let mask=&quot;(1&lt;&lt;$cs)|(1&lt;&lt;$clk)|(1&lt;&lt;$din)|(1&lt;&lt;$dout)&quot;

    # Error if gpio values not set.
    if [ &quot;$mask&quot; -eq &quot;1&quot; ]; then
        echo &quot;sdcard - Gpio pins not set: skipping&quot;
        return
    fi
    echo &quot;sdcard - using cs=$cs clk=$clk din=$din dout=$dout&quot;
    echo &quot;sdcard - computed mask $mask&quot;

    # If the dbg value is &gt; 0, arrange to load the debug enabled module instead.
    [ ${dbg:-0} -eq 0 ] || SD_MODNAME=&quot;${SD_MODNAME}d&quot;

    # Do nothing if the module is already loaded!
    if [ -d &quot;/proc/sdcard&quot; ]; then
        echo &quot;sdcard - Already started...&quot;
        return
    fi

    echo &quot;sdcard - setting gpiomask&quot;
    # Set the diag module gpio mask to disable it from using our GPIO pins
    # It buggers up the led state, so we save, then restore it afterwards
    save_led_state
    echo &quot;$mask&quot; &gt; /proc/diag/gpiomask
    restore_led_state

    # Build module arguments from values in config file.
    # Don&#039;t provide the dbg module argument if set to 0
    for arg in clk din dout cs major maxsec rahead dbg gpio_input gpio_output gpio_enable gpio_control; do
        [ ${arg} == &quot;dbg&quot; ] &amp;&amp; [ ${dbg:-0} -eq 0 ] &amp;&amp; continue
        eval &quot;z=\${${arg}:-z}&quot;
        if [ &quot;$z&quot; != &quot;z&quot; ]; then
        SD_MODARG=&quot;${SD_MODARG} ${arg}=${z}&quot;
        fi
    done
    echo &quot;sdcard - inserting module $SD_MODNAME $SD_MODARG&quot;
    # Insert the kernel module passing appropriate arguments
    insmod $SD_MODNAME $SD_MODARG
    if [ &quot;$?&quot; -gt &quot;0&quot; ] ; then
        echo &quot;sdcard - Card not present or failed to initialize&quot;
        echo &quot;0x0000&quot; &gt; /proc/diag/gpiomask
        restore_led_state
        return;
    fi
    echo &quot;sdcard - Card detected and initialized&quot;
    

}

boot_hook_add preinit_mount_root init_sd_card</code></pre></div><p>Obviously there are a lot of &quot;echo&quot; lines that we could do without, but they are rather helpful when monitoring the boot process, in case something goes wrong.<br />I saved this file as /lib/preinit/45_init-sd-card and let OpenWRT take care of the rest.<br />You still need to set up the sdcard by providing valid settings in /etc/sdcard.conf</p><p>It is worth noting that most of the mods describe on the internet use a pinout that does not correspond to the default arguments of the sdhc kernel module. It might make things a little easier to use a matching pinout, although it does not create much extra effort.</p><p>Cheers.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p109401">
				<div class="post-metadata">
					<div class="post-num">Post #48</div>
					<div class="post-author">bud</div>
					<div class="post-datetime">
						19 May 2010, 14:24					</div>
				</div>
				<div class="post-content content">
					<p>the default pinout in kernel module and init script was changed in<br /><a href="http://article.gmane.org/gmane.comp.embedded.openwrt.devel/5395/match=sdhc+revision">http://article.gmane.org/gmane.comp.emb … c+revision</a></p><p>unfortunately this has not made it into trunk so far. i am going to ring a bell in irc someday soon. i&#039;d really like to streamline with block-extroot then as well.</p><p>..bud</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p109404">
				<div class="post-metadata">
					<div class="post-num">Post #49</div>
					<div class="post-author">VecH</div>
					<div class="post-datetime">
						19 May 2010, 14:31					</div>
				</div>
				<div class="post-content content">
					<p>Who will write the detailed documentation?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p109409">
				<div class="post-metadata">
					<div class="post-num">Post #50</div>
					<div class="post-author">bud</div>
					<div class="post-datetime">
						19 May 2010, 15:20					</div>
				</div>
				<div class="post-content content">
					<p>for the extroot stuff?</p><p>bud</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 2 of 3</div><nav><ul><li><a href="viewtopic.php%3Fid=24250&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=24250&amp;p=3.html">3</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>