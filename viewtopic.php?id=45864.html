<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> NAT Performance between Attitude Adjustment and Barrier Breaker</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 7 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p210193">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						20 Aug 2013, 05:44					</div>
				</div>
				<div class="post-content content">
					<p>Just want to bring up the NAT performance difference on WR1043ND Router between AA and BB</p><p>Attitude Adjustment<br /><span class="postimg"><img src="http://s24.postimg.org/gwo2f2aqb/WR1043_ND_AA.png" alt="http://s24.postimg.org/gwo2f2aqb/WR1043_ND_AA.png" /></span></p><p>Barrier Breaker<br /><span class="postimg"><img src="http://s18.postimg.org/s6ev57tbr/WR1043_ND_Trunk.png" alt="http://s18.postimg.org/s6ev57tbr/WR1043_ND_Trunk.png" /></span></p><p>Exact same images are taken from OpenWRT Download repository.</p>											<p class="post-edited">(Last edited by <strong>alphasparc</strong> on 20 Aug 2013, 11:45)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p210201">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">phuque99</div>
					<div class="post-datetime">
						20 Aug 2013, 08:37					</div>
				</div>
				<div class="post-content content">
					<p>What do you get if you try the following unix commands?</p><p>Sender:<br />dd if=/dev/zero bs=1024K count=5120|nc &lt;dest ip&gt; 5001</p><p>Receiver<br />nc -l -p 5001 &gt; /dev/null</p>											<p class="post-edited">(Last edited by <strong>phuque99</strong> on 20 Aug 2013, 08:58)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p210214">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						20 Aug 2013, 11:46					</div>
				</div>
				<div class="post-content content">
					<p>I am using iperf here it can&#039;t be wrong.<br />You can test it out yourself if you want.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p210231">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">phuque99</div>
					<div class="post-datetime">
						20 Aug 2013, 15:01					</div>
				</div>
				<div class="post-content content">
					<p>iperf, with all the bells and whistles, is frequently slower than plain raw netcat.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p210240">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						20 Aug 2013, 16:15					</div>
				</div>
				<div class="post-content content">
					<p>That does not matter, iperf simulate real world NAT throughput better than netcat.<br />The goal is not to obtain big numbers, it is to improve the NAT throughput by awareness, testing and optimizations.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p210609">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">paradoxmonkey</div>
					<div class="post-datetime">
						24 Aug 2013, 02:17					</div>
				</div>
				<div class="post-content content">
					<p>The screenshots posted look broken from here.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p210618">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">JaLooNz</div>
					<div class="post-datetime">
						24 Aug 2013, 05:49					</div>
				</div>
				<div class="post-content content">
					<p>Same issue over here on TPLink WDR4300. AA gets me &gt;= 200 Mbps while Barrier Breaker caps on at around 170 Mbps.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p213350">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						28 Sep 2013, 06:41					</div>
				</div>
				<div class="post-content content">
					<p>Disregard what I said earlier in my setup SFQ is still active.</p>											<p class="post-edited">(Last edited by <strong>alphasparc</strong> on 2 Nov 2013, 07:17)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p213351">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						28 Sep 2013, 06:44					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>paradoxmonkey wrote:</cite><blockquote><p>The screenshots posted look broken from here.</p></blockquote></div><p>Yes it is broken (self-reminder: DO NOT USE POSTIMAGE from now on)<br />I will just describe what the images says:<br />3.3.8 Attitude Adjustment NAT &gt; 200Mbps<br />3.10 Barrier Breaker NAT &lt; 200Mbps ~ 170Mbps</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p223180">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						19 Jan 2014, 17:04					</div>
				</div>
				<div class="post-content content">
					<p>Hi anyone investigated this issue?<br />It is really a bummer to suffer a performance drop when upgrading to BB...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p224048">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">nozombian</div>
					<div class="post-datetime">
						29 Jan 2014, 16:04					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;d not believe iperf, it gives me far less than I&#039;m able to achieve with normal downloads, but the issue AA vs BB seems to be real. I&#039;d try to compile without ipv6 support and disable ipv6 rules on nat, but I don&#039;t have spare gigabit router to test the difference, on wr841nd I have not spotted any difference, because it&#039;s only 100mbit router, so the cpu is far more powerful than nic.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p224439">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						3 Feb 2014, 15:55					</div>
				</div>
				<div class="post-content content">
					<p>Well I will use this thread to record my blind shots at isolating the issue.<br />I just tried porting over the AA&#039;s RTL8366rb switch driver over to BB.<br />In the process I needed to patch the __devinit and __devexits functions.<br />After succeeding in compiling and tested:<br />Still the same so the culprit is not the switch driver.</p><p>I did try to compile oprofile into the kernel but the package was broken so a bug report was filed.</p>											<p class="post-edited">(Last edited by <strong>alphasparc</strong> on 3 Feb 2014, 15:56)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p224443">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						3 Feb 2014, 16:42					</div>
				</div>
				<div class="post-content content">
					<p>Removed the following patches from 3.10 generic patch folder<br />656-skb_reduce_truesize-helper.patch<br />657-qdisc_reduce_truesize.patch<br />660-fq_codel_defaults.patch<br />661-fq_codel_keep_dropped_stats.patch<br />662-use_fq_codel_by_default.patch<br />663-remove_pfifo_fast.patch<br />Still no joy.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p224460">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">nebbia88</div>
					<div class="post-datetime">
						3 Feb 2014, 20:07					</div>
				</div>
				<div class="post-content content">
					<p>i&#039;ll try this: build from a really old BB svn revision (at a certain time it should be same of AA!) then build something like 2000 svn revision newer, and so on...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p225015">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						10 Feb 2014, 18:24					</div>
				</div>
				<div class="post-content content">
					<p>Actually you can use git bisect for that...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p225847">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						20 Feb 2014, 18:56					</div>
				</div>
				<div class="post-content content">
					<p>I used git bisect<br />Last known Good &gt; 200Mbps <br /><a href="https://dev.openwrt.org/timeline?from=2012-11-29T18%3A37%3A15%2B01%3A00&amp;precision=second">https://dev.openwrt.org/timeline?from=2 … ion=second</a><br />First Encountered Bad &lt; 200Mbps<br /><a href="https://dev.openwrt.org/timeline?from=2012-11-29T18%3A58%3A28%2B01%3A00&amp;precision=second">https://dev.openwrt.org/timeline?from=2 … ion=second</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p225849">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">nebbia88</div>
					<div class="post-datetime">
						20 Feb 2014, 19:14					</div>
				</div>
				<div class="post-content content">
					<p>great work!</p><p>could it be the kernel change in r34414?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p225850">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						20 Feb 2014, 19:21					</div>
				</div>
				<div class="post-content content">
					<p>If I get that right, you are implying between r34408 and 34415.<br />It would be great if you could still narrow it down, as there are several possible culprits.</p><p>I guess we are talking at least about ar71xx architecture, so 34414 is an obvious candidate. But it is the Linux kernel change from 3.3.x to 3.6.x, so rather impossible to pinpoint a reason there.</p><p>The other possibility is 34415, but it concerns Realtek drivers, which should not affect wr1043nd.</p><p>The only other change is the atm patch 34410.</p><p>EDIT:<br />Changelog:<br /><a href="https://dev.openwrt.org/changeset?new=34415%40trunk&amp;old=34408%40trunk">https://dev.openwrt.org/changeset?new=3 … 08%40trunk</a></p>											<p class="post-edited">(Last edited by <strong>hnyman</strong> on 20 Feb 2014, 19:38)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p225935">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						21 Feb 2014, 15:19					</div>
				</div>
				<div class="post-content content">
					<p>Branch: Trunk<br />Build Config: Target WR1043ND, LuCI + All Protocol<br />Test Method: jperf, NAT LAN to WAN<br /><a href="https://dev.openwrt.org/changeset/34408">https://dev.openwrt.org/changeset/34408</a> Result ~240Mbps<br /><a href="https://dev.openwrt.org/changeset/34413">https://dev.openwrt.org/changeset/34413</a> ~220Mbps<br /><a href="https://dev.openwrt.org/changeset/34414">https://dev.openwrt.org/changeset/34414</a> ~190Mbps</p><p>Which is consistent with my observation as current<br />Barrier Breaker&nbsp; ~190Mbps Maximum while <br />Attitude Adjustment&nbsp; ~240Mbps</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p226366">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">Pteridium</div>
					<div class="post-datetime">
						27 Feb 2014, 00:14					</div>
				</div>
				<div class="post-content content">
					<p>Seems that kernel 3.3.8 has better ethernet throughput. :-/</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p226390">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						27 Feb 2014, 06:03					</div>
				</div>
				<div class="post-content content">
					<p>Any help ? I am stucked.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p228810">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						30 Mar 2014, 17:23					</div>
				</div>
				<div class="post-content content">
					<p>I did additional tests on trunk and got this<br />The Blue line is the default NAT performance while I got the Green line after I ran &quot;/etc/init.d/odhcpd stop&quot;.<br />What does odhcpd do that limits the throughput?<br /><span class="postimg"><img src="http://i.imgur.com/bL9Nf32.png" alt="PunBB bbcode test" /></span></p>											<p class="post-edited">(Last edited by <strong>alphasparc</strong> on 30 Mar 2014, 17:24)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p228881">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						31 Mar 2014, 15:34					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>alphasparc wrote:</cite><blockquote><p>I did additional tests on trunk and got this<br />The Blue line is the default NAT performance while I got the Green line after I ran &quot;/etc/init.d/odhcpd stop&quot;.<br />What does odhcpd do that limits the throughput?</p></blockquote></div><p>Sounds strange. Afaik odhcpd is a ipv6 relayd/ra/dhcpv6 server, but plays no role in actual traffic routing. But it adds more ipv6 info and possibly thus complicates routing inside kernel/iproute2/whatever...</p><p>It only adds more ipv6 support. I am wondering if your traffic gets now passed through a ipv6 tunnel, or something like that, which could cause more protocol overehead. Do you have ipv6 in use?</p><p>Could you please verify that result:<br />I would like to see separate <br />a) odhcpd stop. Normal service stop. That will probably remove the ipv6 prefix infos from routing tables etc.<br />b) odhcpd process killed forcefully via kill command. Then the routing rules etc. should still be there and continue affecting performance.</p><p>My guess is that you will see a speed difference in a) and b). odhcpd process itself should have no effect, but the routing rules etc. may have. Having more ipv6 support may add just that much more routing tasks, that the additional work gets visible under heavy speeds.</p><p>(The ipv6 routing information has a lifespan between 10-30 minutes, I think, so please test the speed right after killing the process.)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p228888">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						31 Mar 2014, 17:19					</div>
				</div>
				<div class="post-content content">
					<p>It is as you guess.<br />killing odhcp does not improve performance but stopping odhcp does.<br />So does this means that the current performance of barrier breaker is here to stay?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p228891">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						31 Mar 2014, 17:36					</div>
				</div>
				<div class="post-content content">
					<p>I guess so. Because Openwrt surely wants to provide services with the growing amount of ipv6 use.</p><p>But if you get the developers a bit interested, they might check if there is anything to be done for lightening the routing tasks.<br />The author of odhcpd is CyrusFF (in forum) / cyrus (bug tracker &amp; svn)</p><p><a href="https://github.com/sbyx/odhcpd">https://github.com/sbyx/odhcpd</a><br /><a href="https://dev.openwrt.org/log/trunk/package/network/services/odhcpd">https://dev.openwrt.org/log/trunk/packa … ces/odhcpd</a></p><p>Interesting results, in any case.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>