<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> mwan3; multi-wan policy routing (general topic)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 22 May 2013 and 6 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 29 of 65</div><nav><ul><li><a href="viewtopic.php%3Fid=39052&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=27.html">27</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=28.html">28</a></li><li class="pagination-current"><span>29</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=30.html">30</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=31.html">31</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p231575">
				<div class="post-metadata">
					<div class="post-num">Post #701</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						28 Apr 2014, 17:47					</div>
				</div>
				<div class="post-content content">
					<p>kpv,</p><p>option up &#039;8&#039;</p><p>This setting seems a little extreme to me for anything other than some specialized server/datacenter application.</p><p>Try &#039;2&#039;</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p231622">
				<div class="post-metadata">
					<div class="post-num">Post #702</div>
					<div class="post-author">kpv</div>
					<div class="post-datetime">
						28 Apr 2014, 22:45					</div>
				</div>
				<div class="post-content content">
					<p>Judging by the tcpdump log, it would seem like my OpenWRT test system has no default routes when WANs go down:</p><div class="codebox"><pre><code>laptop bin # tcpdump -i eth0 -n src host xxx.yy.zz.206 and host not xxx.yy.zz.202
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes
20:53:41.932863 ARP, Request who-has 208.67.220.220 tell xxx.yy.zz.206, length 46
20:53:42.927894 ARP, Request who-has 208.67.220.220 tell xxx.yy.zz.206, length 46
20:53:43.927897 ARP, Request who-has 208.67.220.220 tell xxx.yy.zz.206, length 46
20:53:43.938707 ARP, Request who-has 8.8.8.8 tell xxx.yy.zz.206, length 46
20:53:44.937915 ARP, Request who-has 8.8.8.8 tell xxx.yy.zz.206, length 46
20:53:45.937893 ARP, Request who-has 8.8.8.8 tell xxx.yy.zz.206, length 46
20:53:50.949208 ARP, Request who-has 208.67.220.220 tell xxx.yy.zz.206, length 46
20:53:51.947894 ARP, Request who-has 208.67.220.220 tell xxx.yy.zz.206, length 46
20:53:52.947888 ARP, Request who-has 208.67.220.220 tell xxx.yy.zz.206, length 46
20:53:52.954804 ARP, Request who-has 8.8.8.8 tell xxx.yy.zz.206, length 46
20:53:53.948018 ARP, Request who-has 8.8.8.8 tell xxx.yy.zz.206, length 46
20:53:54.947883 ARP, Request who-has 8.8.8.8 tell xxx.yy.zz.206, length 46
20:53:59.965325 ARP, Request who-has 208.67.220.220 tell xxx.yy.zz.206, length 46
20:54:00.957884 ARP, Request who-has 208.67.220.220 tell xxx.yy.zz.206, length 46
20:54:01.957886 ARP, Request who-has 208.67.220.220 tell xxx.yy.zz.206, length 46
20:54:01.970979 ARP, Request who-has 8.8.8.8 tell xxx.yy.zz.206, length 46
20:54:02.967915 ARP, Request who-has 8.8.8.8 tell xxx.yy.zz.206, length 46
^C
17 packets captured
17 packets received by filter
0 packets dropped by kernel
laptop bin #


 7187 root      1360 S    {mwan3track} /bin/sh /usr/sbin/mwan3track wan eth0.2 1 1 2 5 3 8 208.67.222.222 8.8.4.
 8198 root      1360 S    {mwan3track} /bin/sh /usr/sbin/mwan3track wan2 eth0.3 1 1 2 5 3 8 208.67.220.220 8.8.8
 8736 root         0 SW   [kworker/0:0]
 9411 root         0 SW   [kworker/0:3]
 9592 root      1348 S    sleep 5
 9593 root      1352 S    ping -I eth0.3 -c 1 -W 2 8.8.8.8
 9594 root      1356 R    ps
27210 nobody     976 S    /usr/sbin/dnsmasq -C /var/etc/dnsmasq.conf -k
30072 root      1476 S    /sbin/netifd
30178 root      1368 S    udhcpc -p /var/run/udhcpc-eth0.2.pid -s /lib/netifd/dhcp.script -f -t 0 -i eth0.2 -C
30180 root      1368 S    udhcpc -p /var/run/udhcpc-eth0.3.pid -s /lib/netifd/dhcp.script -f -t 0 -i eth0.3 -C</code></pre></div><br /><br /><p>When a WAN goes down on my OpenWRT system, its custom route table (ip route list table 1, 2 etc) apprently gets cleared (see below). Is this normal?</p><p>Not working (both WANs down), custom route tables empty:<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# ip route list table 1
root@OpenWrt:~# ip route list table 2
root@OpenWrt:~# ip rule
0:      from all lookup local
2254:   from all fwmark 0xfe00/0xff00 unreachable
32766:  from all lookup main
32767:  from all lookup default
root@OpenWrt:~#</code></pre></div><p>Working system:<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# mwan3 restart
root@OpenWrt:~# ip route list table 1
default via xxx.yy.zz.31 dev eth0.2
root@OpenWrt:~# ip route list table 2
default via xxx.yy.zz.31 dev eth0.3

root@OpenWrt:~# ip rule
0:      from all lookup local
1001:   from all iif eth0.2 lookup main
1002:   from all iif eth0.3 lookup main
2001:   from all fwmark 0x100/0xff00 lookup 1
2002:   from all fwmark 0x200/0xff00 lookup 2
2254:   from all fwmark 0xfe00/0xff00 unreachable
32766:  from all lookup main
32767:  from all lookup default
root@OpenWrt:~#</code></pre></div><p>In either case, the main routing table remains unchanged:<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         xxx.yy.zz.31    0.0.0.0         UG    10     0        0 eth0.2
0.0.0.0         xxx.yy.zz.31    0.0.0.0         UG    20     0        0 eth0.3
192.168.100.0   0.0.0.0         255.255.252.0   U     0      0        0 br-lan
xxx.yy.zz.0     0.0.0.0         255.255.255.0   U     10     0        0 eth0.2
xxx.yy.zz.0     0.0.0.0         255.255.255.0   U     20     0        0 eth0.3</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p231628">
				<div class="post-metadata">
					<div class="post-num">Post #703</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						28 Apr 2014, 23:15					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>kpv wrote:</cite><blockquote><p>When a WAN goes down on my OpenWRT system, its custom route table (ip route list table 1, 2 etc) apprently gets cleared (see below). Is this normal?</p></blockquote></div><p>Yes</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p231755">
				<div class="post-metadata">
					<div class="post-num">Post #704</div>
					<div class="post-author">kpv</div>
					<div class="post-datetime">
						29 Apr 2014, 21:26					</div>
				</div>
				<div class="post-content content">
					<p>To follow up yesterday&#039;s posts, the issue was solved in the latest mwan3 v1.4-16</p><p>Kudos to Adze!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p232223">
				<div class="post-metadata">
					<div class="post-num">Post #705</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						3 May 2014, 20:17					</div>
				</div>
				<div class="post-content content">
					<p>Latest recommended releases:</p><p>mwan3 1.4-17<br />mwan3-luci 1.2-19</p><p>I&#039;m not likely to be adding any new functionality to the luci application for some time. If I notice anything that could visually look better I will make minor updates.</p><p>If you think you have a great idea for a new feature or changing the existing ones let me know.</p>											<p class="post-edited">(Last edited by <strong>arfett</strong> on 3 May 2014, 20:17)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p232294">
				<div class="post-metadata">
					<div class="post-num">Post #706</div>
					<div class="post-author">r2k</div>
					<div class="post-datetime">
						4 May 2014, 16:41					</div>
				</div>
				<div class="post-content content">
					<p>Hi, thanks for your work. <br />I&#039;m using this with dual wan setup and openvpn tunel for vpn and internet failover - works ok.<br />One thing: I can&#039;t ping router openvpn tunel ip address after starting mwan3.<br />Looks like tun0 iface local ip needs handling in&nbsp; mwan3_connected chain.<br />It might be the case&nbsp; for other p2p ifaces like ppp too.<br />?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p232924">
				<div class="post-metadata">
					<div class="post-num">Post #707</div>
					<div class="post-author">twelvekit</div>
					<div class="post-datetime">
						10 May 2014, 00:53					</div>
				</div>
				<div class="post-content content">
					<p>At least for me a setup with two OpenVPN client doesn&#039;t work.I got managed to change both VPN WANs green in mwan3, but only after applying a lot of changes like removing the pushed routes and setting static default gateways for both VPN WANs.<br />But even after doing these changes mwan3 did not work the desired way, so it seems that this project is not suitable for dynamic VPN connections.It doesn&#039;t make any sense to use this when it requires so much manual intervention.I really would like to see a solution for dynamic vpn connections ( mwan3 however works great for other WANs like dynamic IP &amp; 3G )</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p232928">
				<div class="post-metadata">
					<div class="post-num">Post #708</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						10 May 2014, 01:22					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>twelvekit wrote:</cite><blockquote><p>At least for me a setup with two OpenVPN client doesn&#039;t work.I got managed to change both VPN WANs green in mwan3, but only after applying a lot of changes like removing the pushed routes and setting static default gateways for both VPN WANs.<br />But even after doing these changes mwan3 did not work the desired way, so it seems that this project is not suitable for dynamic VPN connections.It doesn&#039;t make any sense to use this when it requires so much manual intervention.I really would like to see a solution for dynamic vpn connections ( mwan3 however works great for other WANs like dynamic IP &amp; 3G )</p></blockquote></div><p>Do you care to elaborate on how &quot;mwan3 did not work the desired way&quot;?</p><p>Perhaps Adze could respond if you provided anything at all.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p232944">
				<div class="post-metadata">
					<div class="post-num">Post #709</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						10 May 2014, 10:53					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>twelvekit wrote:</cite><blockquote><p>At least for me a setup with two OpenVPN client doesn&#039;t work.I got managed to change both VPN WANs green in mwan3, but only after applying a lot of changes like removing the pushed routes and setting static default gateways for both VPN WANs.</p></blockquote></div><p>That is exactly what you have have to do to make it work. Create a default route for each VPN tunnel and remove any more specific routes.</p><div class="quotebox"><cite>twelvekit wrote:</cite><blockquote><p>But even after doing these changes mwan3 did not work the desired way, so it seems that this project is not suitable for dynamic VPN connections.It doesn&#039;t make any sense to use this when it requires so much manual intervention.I really would like to see a solution for dynamic vpn connections ( mwan3 however works great for other WANs like dynamic IP &amp; 3G )</p></blockquote></div><p>I&#039;m sorry to hear that, but i think your conclusion is incorrect. I have made a setup with 2 physical wans and and 4 openvpn tunnels and i could load-balance all traffic exactly how i wanted it. I&#039;m agreeing with you on the complexity it brings to configure this correctly.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 10 May 2014, 10:54)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p232979">
				<div class="post-metadata">
					<div class="post-num">Post #710</div>
					<div class="post-author">kpv</div>
					<div class="post-datetime">
						10 May 2014, 21:02					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>I&#039;m sorry to hear that, but i think your conclusion is incorrect. I have made a setup with 2 physical wans and and 4 openvpn tunnels and i could load-balance all traffic exactly how i wanted it. I&#039;m agreeing with you on the complexity it brings to configure this correctly.</p></blockquote></div><p>Some more details about how to configure VPN tunnel fail-over with mwan3 would be most helpful.</p><p>Are there any (known) limitations to be aware of?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p232990">
				<div class="post-metadata">
					<div class="post-num">Post #711</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						10 May 2014, 22:25					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>kpv wrote:</cite><blockquote><p>Some more details about how to configure VPN tunnel fail-over with mwan3 would be most helpful.</p><p>Are there any (known) limitations to be aware of?</p></blockquote></div><p>I don&#039;t have this setup running anymore, so no direct examples, but here is how you could do it. Example setup with two physical wans and two vpn wans, where internet traffic is load-balanced through the vpn wans:</p><p>- First create a mwan3 configuration with only two physical wans, like normal, with the exception that you don&#039;t create a default traffic rule (yet).<br />- Create rules for load-balancing vpn traffic. In below example i use a.a.a.a and b.b.b.b as my vpn endpoints.<br />- Setup your vpn connection with e.g. openvpn and don&#039;t accept any pushed routes from peer vpn endpoint.<br />- Create a wan interface in your network config for each vpn tunnel with proto set to none.<br />- Create a route for each vpn wan interface in your network config with an unique metric higher then the physical wans.<br />- Create correct firewall rules to allow vpn traffic.<br />- Edit your mwan3 config and add the two vpn wans.<br />- Create members, policies and rules for the vpn wans and you are done.</p><p>Something would look like this:</p><div class="codebox"><pre><code>config interface &#039;wan&#039;                                                                                                                                                                                                                                                          
        option enabled &#039;1&#039;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                
config interface &#039;wan2&#039;                                                                                                                                                                                                                                                         
        option enabled &#039;1&#039;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                
config interface &#039;vpn1&#039;                                                                                                                                                                                                                                                         
        option enabled &#039;1&#039;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                
config interface &#039;vpn2&#039;                                                                                                                                                                                                                                                         
        option enabled &#039;1&#039;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                
config member &#039;wan_m1_w3&#039;                                                                                                                                                                                                                                                       
        option interface &#039;wan&#039;                                                                                                                                                                                                                                                  
        option metric &#039;1&#039;                                                                                                                                                                                                                                                       
        option weight &#039;3&#039;                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                
config member &#039;wan_m2_w3&#039;                                                                                                                                                                                                                                                       
        option interface &#039;wan&#039;                                                                                                                                                                                                                                                  
        option metric &#039;2&#039;                                                                                                                                                                                                                                                       
        option weight &#039;3&#039;                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                
config member &#039;wan2_m1_w2&#039;                                                                                                                                                                                                                                                      
        option interface &#039;wan2&#039;                                                                                                                                                                                                                                                 
        option metric &#039;1&#039;                                                                                                                                                                                                                                                       
        option weight &#039;2&#039;                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                
config member &#039;wan2_m2_w2&#039;                                                                                                                                                                                                                                                      
        option interface &#039;wan2&#039;                                                                                                                                                                                                                                                 
        option metric &#039;2&#039;                                                                                                                                                                                                                                                       
        option weight &#039;2&#039;                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                
config member &#039;vpn1_m3_w3&#039;                                                                                                                                                                                                                                                      
        option interface &#039;vpn1&#039;                                                                                                                                                                                                                                                 
        option metric &#039;3&#039;                                                                                                                                                                                                                                                       
        option weight &#039;3&#039;                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                
config member &#039;vpn2_m3_w2&#039;                                                                                                                                                                                                                                                      
        option interface &#039;vpn2&#039;                                                                                                                                                                                                                                                 
        option metric &#039;3&#039;                                                                                                                                                                                                                                                       
        option weight &#039;2&#039;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                
config policy &#039;wan_wan2&#039;                                                                                                                                                                                                                                                        
        list use_member &#039;wan_m1_w3&#039;                                                                                                                                                                                                                                             
        list use_member &#039;wan2_m2_w2&#039;                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                
config policy &#039;wan2_wan&#039;                                                                                                                                                                                                                                                        
        list use_member &#039;wan_m2_w3&#039;                                                                                                                                                                                                                                             
        list use_member &#039;wan2_m1_w2&#039;                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                
config policy &#039;balanced&#039;                                                                                                                                                                                                                                                        
        list use_member &#039;wan_m1_w3&#039;                                                                                                                                                                                                                                             
        list use_member &#039;wan2_m1_w2&#039;                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                
config policy &#039;vpn_balance&#039;                                                                                                                                                                                                                                                     
        list use_member &#039;vpn1_m3_w3&#039;                                                                                                                                                                                                                                            
        list use_member &#039;vpn2_m3_w2&#039;                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                
config rule &#039;dns&#039;                                                                                                                                                                                                                                                               
        option dest_port &#039;53&#039;                                                                                                                                                                                                                                                   
        option proto &#039;udp&#039;                                                                                                                                                                                                                                                      
        option use_policy &#039;balance&#039;                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                
config rule &#039;vpn_endpoint1&#039;                                                                                                                                                                                                                                                     
        option dest_ip &#039;a.a.a.a&#039;                                                                                                                                                                                                                                                
        option dest_port &#039;1194&#039;                                                                                                                                                                                                                                                 
        option proto &#039;udp&#039;                                                                                                                                                                                                                                                      
        option use_policy &#039;wan_wan2&#039;

config rule &#039;vpn_endpoint2&#039;                                                                                                                                                                                                                                                     
        option dest_ip &#039;b.b.b.b&#039;                                                                                                                                                                                                                                                 
        option dest_port &#039;1194&#039;                                                                                                                                                                                                                                                 
        option proto &#039;udp&#039;                                                                                                                                                                                                                                                      
        option use_policy &#039;wan2_wan&#039;                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                
config rule &#039;default_rule&#039;                                                                                                                                                                                                                                                      
        option dest_ip &#039;0.0.0.0/0&#039;                                                                                                                                                                                                                                              
        option use_policy &#039;vpn_balance&#039;</code></pre></div>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 10 May 2014, 22:35)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p233002">
				<div class="post-metadata">
					<div class="post-num">Post #712</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						11 May 2014, 06:33					</div>
				</div>
				<div class="post-content content">
					<p>Does mwan3 support ipv6 tunnel forcing traffic to go through certain interface?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p233010">
				<div class="post-metadata">
					<div class="post-num">Post #713</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						11 May 2014, 10:41					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>alphasparc wrote:</cite><blockquote><p>Does mwan3 support ipv6 tunnel forcing traffic to go through certain interface?</p></blockquote></div><p>Yes, based upon your configured rules.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p233047">
				<div class="post-metadata">
					<div class="post-num">Post #714</div>
					<div class="post-author">mkolomiets</div>
					<div class="post-datetime">
						11 May 2014, 21:29					</div>
				</div>
				<div class="post-content content">
					<p>I have some troubles with mwan3 and gre tunnels.</p><p>I have router with two isp connections and&nbsp; failover with mwan3 works fine. But I also have few gre tunnels with ospf routing over them, couple of tunnels for each remote site - one per isp on my router.<br />Tunnels work as expected when mwan3 is disabled, but only I have activated mwan3 traffic flow to remote site stopped. Ospf traffic goes without any troubles, routes are propagated.<br />I tryed a lot of variants of settings, also tryed to isolate local subnet of remote site from mwan3 processing with rules like this:</p><div class="codebox"><pre><code>config rule &#039;vserver01&#039;
    option dest_ip &#039;192.168.122.0/24&#039;
    option use_policy &#039;default&#039;</code></pre></div><p>But hadn&#039;t got success.</p><p>Configs (I show data only for one site, rest have the same configuration):</p><p>/etc/config/network<br /></p><div class="codebox"><pre><code>config interface &#039;lan&#039;
    option ifname &#039;eth0.1&#039;
    option type &#039;bridge&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;192.168.1.1&#039;
    option netmask &#039;255.255.255.0&#039;

config interface &#039;wan&#039;
    option ifname &#039;eth0.10&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;X.X.X.26&#039;
    option netmask &#039;255.255.255.252&#039;
    option gateway &#039;X.X.X.25&#039;
    option metric &#039;10&#039;
    option dns &#039;213.160.128.3 213.160.134.23&#039;

config interface &#039;wanfailover&#039;
    option ifname &#039;eth0.11&#039;
    option proto &#039;dhcp&#039;
    option metric &#039;20&#039;

config interface &#039;vserver011&#039;
    option proto &#039;tunnel&#039;
    option ifname &#039;vserver011&#039;
    option tunnel_start &#039;X.X.X.26&#039;
    option tunnel_end &#039;X.X.X.216&#039;
    option local_address &#039;192.168.251.1&#039;
    option remote_address &#039;192.168.251.2/30&#039;
    option mtu &#039;1476&#039;
    option mode &#039;gre&#039;

config interface &#039;vserver012&#039;
    option proto &#039;tunnel&#039;
    option ifname &#039;vserver012&#039;
    option tunnel_start &#039;X.X.X.82&#039;
    option tunnel_end &#039;X.X.X.216&#039;
    option local_address &#039;192.168.251.5&#039;
    option remote_address &#039;192.168.251.6/30&#039;
    option mtu &#039;1476&#039;
    option mode &#039;gre&#039;</code></pre></div><p>/etc/config/mwan3<br /></p><div class="codebox"><pre><code>config interface &#039;wan&#039;
    option enabled &#039;1&#039;
    list track_ip &#039;X.X.X.25&#039;
    option reliability &#039;1&#039;
    option count &#039;3&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;8&#039;

config interface &#039;wanfailover&#039;
    option enabled &#039;1&#039;
    list track_ip &#039;X.X.X.1&#039;
    option reliability &#039;1&#039;
    option count &#039;3&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;8&#039;

config member &#039;wan1&#039;
    option interface &#039;wan&#039;
    option metric &#039;10&#039;
    option weight &#039;3&#039;

config member &#039;wan2&#039;
    option interface &#039;wanfailover&#039;
    option metric &#039;20&#039;
    option weight &#039;3&#039;

config policy &#039;wan_failover&#039;
    list use_member &#039;wan1&#039;
    list use_member &#039;wan2&#039;

config rule &#039;vserver01&#039;
    option dest_ip &#039;192.168.122.0/24&#039;
    option use_policy &#039;default&#039;

config rule &#039;default_rule&#039;
    option dest_ip &#039;0.0.0.0/0&#039;
    option use_policy &#039;wan_failover&#039;</code></pre></div><p>Diagnostic:<br /></p><div class="codebox"><pre><code>root@gate:~# ip ru li
0:    from all lookup local 
1001:    from all iif eth0.10 lookup main 
1002:    from all iif eth0.11 lookup main 
2001:    from all fwmark 0x100/0xff00 lookup 1 
2002:    from all fwmark 0x200/0xff00 lookup 2 
2254:    from all fwmark 0xfe00/0xff00 unreachable
32765:    from 77.120.245.82 lookup wanfailover_policy 
32766:    from all lookup main 
32767:    from all lookup default</code></pre></div><div class="codebox"><pre><code>root@gate:~# ip ro li
default via X.X.X.25 dev eth0.10  proto static 
default via X.X.X.1 dev eth0.11  proto static  metric 20 
X.X.X.0/23 dev eth0.11  proto static  scope link  metric 20 
192.168.1.0/24 dev br-lan  proto kernel  scope link  src 192.168.1.1 
192.168.122.0/24 via 192.168.251.2 dev vserver011  proto zebra  metric 20 
192.168.251.0/30 dev vserver011  proto kernel  scope link  src 192.168.251.1 
192.168.251.4/30 dev vserver012  proto kernel  scope link  src 192.168.251.5 
X.X.X.24/30 dev eth0.10  proto static  scope link  metric 10 

root@gate:~# ip ro li table 1
default via X.X.X.25 dev eth0.10 

root@gate:~# ip ro li table 2
default via X.X.X.1 dev eth0.11 </code></pre></div><p>On the router:<br /></p><div class="codebox"><pre><code>root@gate:~# ping -I 192.168.1.1 192.168.122.101 &gt;/dev/null 2&gt;&amp;1 &amp;
root@gate:~# tcpdump -i vserver011 -annv proto 1
tcpdump: listening on vserver011, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes
21:08:58.540903 IP (tos 0x0, ttl 64, id 27334, offset 0, flags [DF], proto ICMP (1), length 84)
    192.168.1.1 &gt; 192.168.122.101: ICMP echo request, id 2751, seq 5, length 64
21:08:59.541217 IP (tos 0x0, ttl 64, id 27335, offset 0, flags [DF], proto ICMP (1), length 84)
    192.168.1.1 &gt; 192.168.122.101: ICMP echo request, id 2751, seq 6, length 64
21:09:00.541525 IP (tos 0x0, ttl 64, id 27336, offset 0, flags [DF], proto ICMP (1), length 84)
    192.168.1.1 &gt; 192.168.122.101: ICMP echo request, id 2751, seq 7, length 64</code></pre></div><p>No any packets on other side of tunnel. Tcpdump show no GRE encpsulated packets with ping on the first wan (eth0.10), but on the second (eth0.11) I see:<br /></p><div class="codebox"><pre><code>root@gate:~# tcpdump -i eth0.11 -annv host X.X.X.216
21:13:26.619141 IP (tos 0x0, ttl 255, id 34247, offset 0, flags [DF], proto GRE (47), length 108)
    X.X.X.26 &gt; X.X.X.216: GREv0, Flags [none], length 88
    IP (tos 0x0, ttl 64, id 27602, offset 0, flags [DF], proto ICMP (1), length 84)
    192.168.1.1 &gt; 192.168.122.101: ICMP echo request, id 2751, seq 273, length 64
21:13:27.619426 IP (tos 0x0, ttl 255, id 34254, offset 0, flags [DF], proto GRE (47), length 108)
    X.X.X.26 &gt; X.X.X.216: GREv0, Flags [none], length 88
    IP (tos 0x0, ttl 64, id 27603, offset 0, flags [DF], proto ICMP (1), length 84)
    192.168.1.1 &gt; 192.168.122.101: ICMP echo request, id 2751, seq 274, length 64
21:13:28.619737 IP (tos 0x0, ttl 255, id 34261, offset 0, flags [DF], proto GRE (47), length 108)
    X.X.X.26 &gt; X.X.X.216: GREv0, Flags [none], length 88
    IP (tos 0x0, ttl 64, id 27604, offset 0, flags [DF], proto ICMP (1), length 84)
    192.168.1.1 &gt; 192.168.122.101: ICMP echo request, id 2751, seq 275, length 64</code></pre></div><p>As you can see - source address is from first interface, but packets are sent via second one...</p><p>I need some help from community to identify the causes of such behavior. Tnk</p><p>PS. Sorry for my English.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p233048">
				<div class="post-metadata">
					<div class="post-num">Post #715</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						11 May 2014, 21:49					</div>
				</div>
				<div class="post-content content">
					<p>Hi mkolomiets,</p><p>I see something strange in your &quot;ip rule list&quot; output. What does rule 32765 do?<br />Could you also post output &quot;mwan3 status&quot;?</p><p>I see that you have configured two tunnels to the same remote site. Is that correct? If you wish to have gre tunnel 1 traverse wan 1 and tunnel 2 wan 2, then you need rules for them as well. Please try below config:</p><div class="codebox"><pre><code>config interface &#039;wan&#039;
    option enabled &#039;1&#039;
    list track_ip &#039;X.X.X.25&#039;
    option reliability &#039;1&#039;
    option count &#039;3&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;8&#039;

config interface &#039;wanfailover&#039;
    option enabled &#039;1&#039;
    list track_ip &#039;X.X.X.1&#039;
    option reliability &#039;1&#039;
    option count &#039;3&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;8&#039;

config member &#039;wan1&#039;
    option interface &#039;wan&#039;
    option metric &#039;10&#039;
    option weight &#039;3&#039;

config member &#039;wan2&#039;
    option interface &#039;wanfailover&#039;
    option metric &#039;20&#039;
    option weight &#039;3&#039;

config policy &#039;wan_failover&#039;
    list use_member &#039;wan1&#039;
    list use_member &#039;wan2&#039;

config policy &#039;wan1_only&#039;
    list use_member &#039;wan1&#039;

config policy &#039;wan2_only&#039;
    list use_member &#039;wan2&#039;

config rule &#039;tunnel1&#039;
    option proto &#039;gre&#039;
    option src_ip &#039;x.x.x.26&#039;
    option dest_ip &#039;x.x.x.216&#039;
    option use_policy &#039;wan1_only&#039;

config rule &#039;tunnel2&#039;
    option proto &#039;gre&#039;
    option src_ip &#039;x.x.x.82&#039;
    option dest_ip &#039;x.x.x.216&#039;
    option use_policy &#039;wan2_only&#039;

config rule &#039;default_rule&#039;
    option dest_ip &#039;0.0.0.0/0&#039;
    option use_policy &#039;wan_failover&#039;</code></pre></div>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 11 May 2014, 22:25)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p233058">
				<div class="post-metadata">
					<div class="post-num">Post #716</div>
					<div class="post-author">mkolomiets</div>
					<div class="post-datetime">
						11 May 2014, 23:48					</div>
				</div>
				<div class="post-content content">
					<p>Hi, Adze!<br />Thanks for reply!<br /></p><div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>I see something strange in your &quot;ip rule list&quot; output. What does rule 32765 do?</p></blockquote></div><p>It is mine. This is policy for reply on incoming traffic on wan2. I have tryed to disable this policy, nothing was changed.<br /></p><div class="codebox"><pre><code>root@gate:~# ip ro li table wanfailover_policy
default via 77.120.244.1 dev eth0.11 </code></pre></div><div class="quotebox"><blockquote><p>Could you also post output &quot;mwan3 status&quot;?</p></blockquote></div><p>I lost, sorry. Here it.<br /></p><div class="codebox"><pre><code>root@gate:~# mwan3 status
Interface status:
Interface wan is online (tracking active)
Interface wanfailover is online (tracking active)

Policy wan_failover:
 wan (100%)

Local connected networks:
destination        policy             hits     
------------------------------------------------
127.0.0.0/8        default            41       
224.0.0.0/3        default            1571     
X.X.X.0/23    default            901      
192.168.1.0/24     default            862      
192.168.122.0/24   default            31       
192.168.122.1      default            0        
192.168.123.0/24   default            4        
192.168.123.1      default            0        
192.168.123.2      default            0        
192.168.124.0/24   default            3        
192.168.124.1      default            0        
192.168.200.0/24   default            3        
192.168.200.1      default            0        
192.168.250.0/30   default            0        
192.168.250.4/30   default            4        
192.168.251.0/30   default            1        
192.168.251.4/30   default            4        
192.168.252.0/30   default            0        
192.168.252.4/30   default            4        
192.168.253.0/30   default            0        
192.168.253.4/30   default            0        
X.X.X.24/30  default            901      

Active rules:
source             destination        proto  src-port      dest-port     policy          hits     
---------------------------------------------------------------------------------------------------
0.0.0.0/0          192.168.200.0/24   all                                MARK            0        
0.0.0.0/0          192.168.122.0/24   all                                MARK            0        
0.0.0.0/0          192.168.123.0/24   all                                MARK            0        
0.0.0.0/0          192.168.124.0/24   all                                MARK            0        
0.0.0.0/0          0.0.0.0/0          all                                wan_failover    1902     </code></pre></div><br /><div class="quotebox"><blockquote><p>I see that you have configured two tunnels to the same remote site. Is that correct?</p></blockquote></div><p>Exactly. Those tunnels have different route cost for ospf.</p><div class="quotebox"><blockquote><p>If you wish to have gre tunnel 1 traverse wan 1 and tunnel 2 wan 2, then you need rules for them as well. Please try below config:</p></blockquote></div><p>This is new mwan3 config:<br /></p><div class="codebox"><pre><code>config interface &#039;wan&#039;
    option enabled &#039;1&#039;
    list track_ip &#039;213.160.139.25&#039;
    option reliability &#039;1&#039;
    option count &#039;3&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;8&#039;

config interface &#039;wanfailover&#039;
    option enabled &#039;1&#039;
    list track_ip &#039;77.120.244.1&#039;
    option reliability &#039;1&#039;
    option count &#039;3&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;8&#039;

config member &#039;wan1&#039;
    option interface &#039;wan&#039;
    option metric &#039;10&#039;
    option weight &#039;3&#039;

config member &#039;wan2&#039;
    option interface &#039;wanfailover&#039;
    option metric &#039;20&#039;
    option weight &#039;3&#039;

config policy &#039;wan_failover&#039;
    list use_member &#039;wan1&#039;
    list use_member &#039;wan2&#039;

config policy &#039;wan1_only&#039;
    list use_member &#039;wan1&#039;

config policy &#039;wan2_only&#039;
    list use_member &#039;wan2&#039;

config rule &#039;vserver011&#039;
    option proto &#039;gre&#039;
    option src_ip &#039;X.X.X.26&#039;
    option dest_ip &#039;X.X.X.216&#039;
    option use_policy &#039;wan1_only&#039;

config rule &#039;vserver012&#039;
    option proto &#039;gre&#039;
    option src_ip &#039;X.X.X.82&#039;
    option dest_ip &#039;X.X.X.216&#039;
    option use_policy &#039;wan2_only&#039;

config rule &#039;default_rule&#039;
    option dest_ip &#039;0.0.0.0/0&#039;
    option use_policy &#039;wan_failover&#039;</code></pre></div><p>Nothing changed - gre packets with source address of first wan interface, are outcoming via second wan interface. Some mystique there;)</p><p>Status w/new config, counters for new rules are empty...<br /></p><div class="codebox"><pre><code>Interface status:
Interface wan is online (tracking active)
Interface wanfailover is online (tracking active)

Policy wan1_only:
 wan (100%)

Policy wan2_only:
 wanfailover (100%)

Policy wan_failover:
 wan (100%)

Local connected networks:
destination        policy             hits     
------------------------------------------------
127.0.0.0/8        default            41       
224.0.0.0/3        default            310      
X.X.X.0/23    default            111      
192.168.1.0/24     default            110      
192.168.122.0/24   default            2        
192.168.122.1      default            0        
192.168.123.0/24   default            0        
192.168.123.1      default            0        
192.168.123.2      default            0        
192.168.124.0/24   default            0        
192.168.124.1      default            0        
192.168.200.0/24   default            0        
192.168.200.1      default            0        
192.168.250.0/30   default            0        
192.168.250.4/30   default            0        
192.168.251.0/30   default            0        
192.168.251.4/30   default            0        
192.168.252.0/30   default            0        
192.168.252.4/30   default            0        
192.168.253.0/30   default            0        
192.168.253.4/30   default            0        
X.X.X.24/30  default            111      

Active rules:
source             destination        proto  src-port      dest-port     policy          hits     
---------------------------------------------------------------------------------------------------
X.X.X.26     X.X.X.216     all                                wan1_only       0        
X.X.X.82      X.X.X.216     all                                wan2_only       0        
0.0.0.0/0          0.0.0.0/0          all                                wan_failover    655</code></pre></div><p>Dump for second wan. Not native packets still are there.<br /></p><div class="codebox"><pre><code>root@gate:~# tcpdump -i eth0.11 -annv host X.X.X.26 and host X.X.X.216
tcpdump: listening on eth0.11, link-type EN10MB (Ethernet), capture size 65535 bytes
23:37:07.822965 IP (tos 0x0, ttl 255, id 41032, offset 0, flags [DF], proto GRE (47), length 108)
    X.X.X.26 &gt; X.X.X.216: GREv0, Flags [none], length 88
    IP (tos 0x0, ttl 64, id 24095, offset 0, flags [DF], proto ICMP (1), length 84)
    192.168.1.1 &gt; 192.168.122.101: ICMP echo request, id 3191, seq 2, length 64
23:37:08.823275 IP (tos 0x0, ttl 255, id 41039, offset 0, flags [DF], proto GRE (47), length 108)
    X.X.X.26 &gt; X.X.X.216: GREv0, Flags [none], length 88
    IP (tos 0x0, ttl 64, id 24096, offset 0, flags [DF], proto ICMP (1), length 84)
    192.168.1.1 &gt; 192.168.122.101: ICMP echo request, id 3191, seq 3, length 64</code></pre></div><p>There is some question there. Why ospf packets walk as expected? There are dumps for both wan interfaces:</p><p>eth0.10<br /></p><div class="codebox"><pre><code>22:51:54.050544 IP (tos 0x0, ttl 255, id 10257, offset 0, flags [DF], proto GRE (47), length 92)
    X.X.X.26 &gt; X.X.X.216: GREv0, Flags [none], length 72
    IP (tos 0xc0, ttl 1, id 58484, offset 0, flags [none], proto OSPF (89), length 68)
    192.168.251.1 &gt; 224.0.0.5: OSPFv2, Hello, length 48
    Router-ID 192.168.1.1, Backbone Area, Authentication Type: none (0)
    Options [External]
      Hello Timer 0s, Dead Timer 1s, Mask 255.255.255.252, Priority 1
      Designated Router 192.168.251.2, Backup Designated Router 192.168.251.1
      Neighbor List:
        192.168.122.1
22:51:54.151773 IP (tos 0x0, ttl 241, id 0, offset 0, flags [DF], proto GRE (47), length 92)
    X.X.X.216 &gt; X.X.X.26: GREv0, Flags [none], length 72
    IP (tos 0xc0, ttl 1, id 64135, offset 0, flags [none], proto OSPF (89), length 68)
    192.168.251.2 &gt; 224.0.0.5: OSPFv2, Hello, length 48
    Router-ID 192.168.122.1, Backbone Area, Authentication Type: none (0)
    Options [External]
      Hello Timer 0s, Dead Timer 1s, Mask 255.255.255.252, Priority 1
      Designated Router 192.168.251.2, Backup Designated Router 192.168.251.1
      Neighbor List:
        192.168.1.1</code></pre></div><p>eth0.11<br /></p><div class="codebox"><pre><code>22:58:24.051083 IP (tos 0x0, ttl 255, id 12993, offset 0, flags [DF], proto GRE (47), length 92)
    X.X.X.82 &gt; X.X.X.216: GREv0, Flags [none], length 72
    IP (tos 0xc0, ttl 1, id 57181, offset 0, flags [none], proto OSPF (89), length 68)
    192.168.251.5 &gt; 224.0.0.5: OSPFv2, Hello, length 48
    Router-ID 192.168.1.1, Backbone Area, Authentication Type: none (0)
    Options [External]
      Hello Timer 0s, Dead Timer 1s, Mask 255.255.255.252, Priority 1
      Designated Router 192.168.251.6, Backup Designated Router 192.168.251.5
      Neighbor List:
        192.168.122.1
22:58:24.259344 IP (tos 0x88, ttl 241, id 0, offset 0, flags [DF], proto GRE (47), length 92)
    X.X.X.216 &gt; X.X.X.82: GREv0, Flags [none], length 72
    IP (tos 0xc0, ttl 1, id 59041, offset 0, flags [none], proto OSPF (89), length 68)
    192.168.251.6 &gt; 224.0.0.5: OSPFv2, Hello, length 48
    Router-ID 192.168.122.1, Backbone Area, Authentication Type: none (0)
    Options [External]
      Hello Timer 0s, Dead Timer 1s, Mask 255.255.255.252, Priority 1
      Designated Router 192.168.251.6, Backup Designated Router 192.168.251.5
      Neighbor List:
        192.168.1.1</code></pre></div>											<p class="post-edited">(Last edited by <strong>mkolomiets</strong> on 12 May 2014, 06:40)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p233089">
				<div class="post-metadata">
					<div class="post-num">Post #717</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						12 May 2014, 11:11					</div>
				</div>
				<div class="post-content content">
					<p>Hi mkolomiets,</p><br /><p>Hmmm. I&#039;m not sure what&#039;s wrong, but i have a hunch. Can you confirm that when you stop mwan3 &quot;mwan3 stop&quot;, that all traffic passes the correct gre tunnels? Outgoing as well as incomming?!?</p><p>The reason i ask this is because there is no reason for mwan3 to route traffic out of the second wan, unless a packet from a session is received on the second wan. When a packet from a related or established session is received on a wan interface, all packets for that sessions will be marked to leave that particular wan interface. I suspect that the very first gre tunnel packet traversed the first wan, a reply was sent back to the second wan and all subsequent packets are now marked for second wan.</p><p>Is it possible i could get access to your router and troubleshoot some more?</p><br /><p>Thnx!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p233096">
				<div class="post-metadata">
					<div class="post-num">Post #718</div>
					<div class="post-author">mkolomiets</div>
					<div class="post-datetime">
						12 May 2014, 14:29					</div>
				</div>
				<div class="post-content content">
					<p>Hi<br /></p><div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hmmm. I&#039;m not sure what&#039;s wrong, but i have a hunch. Can you confirm that when you stop mwan3 &quot;mwan3 stop&quot;, that all traffic passes the correct gre tunnels? Outgoing as well as incomming?!?</p></blockquote></div><p>Yes, pings between sites have gone as only I stopped mwan3 service. But I didn&#039;t see those packets on second interface which I showed earlier after I started mwan3 service again.</p><div class="quotebox"><blockquote><p>The reason i ask this is because there is no reason for mwan3 to route traffic out of the second wan, unless a packet from a session is received on the second wan. When a packet from a related or established session is received on a wan interface, all packets for that sessions will be marked to leave that particular wan interface. I suspect that the very first gre tunnel packet traversed the first wan, a reply was sent back to the second wan and all subsequent packets are now marked for second wan.</p></blockquote></div><p>For verify this sentence it is need to disable ospf because it makes a lot of packets. It is possible to define static routes between sites. I&#039;ll test it in the evening today.</p><div class="quotebox"><blockquote><p>Is it possible i could get access to your router and troubleshoot some more?</p></blockquote></div><p>Yes, it is. But I need to reconcile maintenance time - it is production system. What time is acceptable for you?<br />Would be better if that wont in workhours, after 20:00 and until 08:00, GMT+3h. But in any case, I think that it is possible to find another time if need.</p><p>Thank you!</p>											<p class="post-edited">(Last edited by <strong>mkolomiets</strong> on 12 May 2014, 14:31)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p233184">
				<div class="post-metadata">
					<div class="post-num">Post #719</div>
					<div class="post-author">mkolomiets</div>
					<div class="post-datetime">
						13 May 2014, 01:19					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adze!</p><div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hmmm. I&#039;m not sure what&#039;s wrong, but i have a hunch. Can you confirm that when you stop mwan3 &quot;mwan3 stop&quot;, that all traffic passes the correct gre tunnels? Outgoing as well as incomming?!?</p></blockquote></div><p>I have upgraded router with latest firmware and problem has gone:)</p><p>Thank you!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p233228">
				<div class="post-metadata">
					<div class="post-num">Post #720</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						13 May 2014, 12:50					</div>
				</div>
				<div class="post-content content">
					<p>How do you configure a 6in4 tunnel with 1 normal uplink?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p233241">
				<div class="post-metadata">
					<div class="post-num">Post #721</div>
					<div class="post-author">mkolomiets</div>
					<div class="post-datetime">
						13 May 2014, 15:53					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adze!<br />I think that the protocol selector was lost in this row, isn&#039;t it?</p><p>/etc/hotplug.d/iface/15-mwan3<br /></p><div class="codebox"><pre><code>mwan3_set_user_rules_iptables()
{
    local proto src_ip src_port dest_ip dest_port use_policy

...
            *)
            iptables -A mwan3_rules -t mangle -s $src_ip -d $dest_ip -m mark --mark 0/0xff00 -m comment --comment &quot;$1&quot; -j $use_policy &amp;&gt; /dev/null
            ;;
...
}</code></pre></div>											<p class="post-edited">(Last edited by <strong>mkolomiets</strong> on 13 May 2014, 16:19)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p233248">
				<div class="post-metadata">
					<div class="post-num">Post #722</div>
					<div class="post-author">kpv</div>
					<div class="post-datetime">
						13 May 2014, 17:18					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mkolomiets wrote:</cite><blockquote><p>I have upgraded router with latest firmware and problem has gone:)</p><p>Thank you!</p></blockquote></div><p>Do you mean latest mwan3 package v1.4-17, or the latest OpenWRT (e.g. Barrier Breaker r40700+) ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p233250">
				<div class="post-metadata">
					<div class="post-num">Post #723</div>
					<div class="post-author">mkolomiets</div>
					<div class="post-datetime">
						13 May 2014, 17:26					</div>
				</div>
				<div class="post-content content">
					<p>Hi!<br /></p><div class="quotebox"><cite>kpv wrote:</cite><blockquote><div class="quotebox"><cite>mkolomiets wrote:</cite><blockquote><p>I have upgraded router with latest firmware and problem has gone:)</p><p>Thank you!</p></blockquote></div><p>Do you mean latest mwan3 package v1.4-17, or the latest OpenWRT (e.g. Barrier Breaker r40700+) ?</p></blockquote></div><p>Latest OpenWrt. There was a Barrier Breaker 405xx, I have upgraded it to r40749.<br />Mwan3 was latest in both cases.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p233266">
				<div class="post-metadata">
					<div class="post-num">Post #724</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						13 May 2014, 20:46					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>alphasparc wrote:</cite><blockquote><p>How do you configure a 6in4 tunnel with 1 normal uplink?</p></blockquote></div><p>I don&#039;t know, but you don&#039;t need mwan3 for that...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p233267">
				<div class="post-metadata">
					<div class="post-num">Post #725</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						13 May 2014, 20:47					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mkolomiets wrote:</cite><blockquote><p>Hi Adze!<br />I think that the protocol selector was lost in this row, isn&#039;t it?</p></blockquote></div><p>You&#039;re right! I fixed it in version 1.4-18. Thnx!</p>									</div>
			</article>

			
		
						<div class="notice">
				<p>Sorry, posts 726 to 725 are missing from our archive.</p>
			</div>
		
		
	
	<div class="pagination"><div class="pagination-number">Page 29 of 65</div><nav><ul><li><a href="viewtopic.php%3Fid=39052&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=27.html">27</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=28.html">28</a></li><li class="pagination-current"><span>29</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=30.html">30</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=31.html">31</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0.001 -->

</body>
</html>