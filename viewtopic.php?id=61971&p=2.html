<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> 50Mbps download speed with the router used as OpenVpn client?</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 29 Apr 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 2 of 2</div><nav><ul><li><a href="viewtopic.php%3Fid=61971&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p306627">
				<div class="post-metadata">
					<div class="post-num">Post #26</div>
					<div class="post-author">markd1</div>
					<div class="post-datetime">
						7 Jan 2016, 18:12					</div>
				</div>
				<div class="post-content content">
					<p>@rangerZ&nbsp; Chaos Calmer 15.05</p><p>And found encryption level in syslog after reboot:<br />openvpn(pia_client)[1202]: Data Channel Encrypt: Cipher &#039;BF-CBC&#039; initialized with 128 bit key<br />openvpn(pia_client)[1202]: Data Channel Encrypt: Using 160 bit message hash &#039;SHA1&#039; for HMAC authentication<br />openvpn(pia_client)[1202]: Data Channel Decrypt: Cipher &#039;BF-CBC&#039; initialized with 128 bit key<br />openvpn(pia_client)[1202]: Data Channel Decrypt: Using 160 bit message hash &#039;SHA1&#039; for HMAC authentication<br />openvpn(pia_client)[1202]: Control Channel: TLSv1, cipher TLSv1/SSLv3 DHE-RSA-AES256-SHA, 2048 bit RSA</p><p>Changed encryption levels to<br />openvpn(pia_client)[3762]: Data Channel Encrypt: Cipher &#039;AES-256-CBC&#039; initialized with 256 bit key<br />openvpn(pia_client)[3762]: Data Channel Encrypt: Using 256 bit message hash &#039;SHA256&#039; for HMAC authentication<br />openvpn(pia_client)[3762]: Data Channel Decrypt: Cipher &#039;AES-256-CBC&#039; initialized with 256 bit key<br />openvpn(pia_client)[3762]: Data Channel Decrypt: Using 256 bit message hash &#039;SHA256&#039; for HMAC authentication<br />openvpn(pia_client)[3762]: Control Channel: TLSv1, cipher TLSv1/SSLv3 DHE-RSA-AES256-SHA, 4096 bit RSA</p><p>Now my max download is 16Mbps so a drop of 4Mbps. max cpu at the time was 60%</p>											<p class="post-edited">(Last edited by <strong>markd1</strong> on 7 Jan 2016, 19:35)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p306633">
				<div class="post-metadata">
					<div class="post-num">Post #27</div>
					<div class="post-author">juanmartinbravo</div>
					<div class="post-datetime">
						7 Jan 2016, 19:49					</div>
				</div>
				<div class="post-content content">
					<p>@markd1&nbsp; I&#039;m so jealous of your speeds!<br />Did you do any other optimization to get those speeds or you just installed the firmware and then openvpn following the instructions of the guide you posted?</p><div class="quotebox"><cite>RangerZ wrote:</cite><blockquote><p>Is luci-app-openvpn just the GUI? I am of the opinion it should not impact performance.</p><br /><p>@juanmartinbravo the link downloads a file as opposed to opening a web page</p></blockquote></div><p>Yes that app is just gui so it didn&#039;t make any difference.</p><p>Yes. Theatre link opens a file as I wanted to test the download speed using the router terminal to see if it would be much different compared to downloading from a phone/computer</p><div class="quotebox"><cite>arokh wrote:</cite><blockquote><p>Again, I&#039;m talking about compression not cipher. If you are going to use cipher none then your traffic is not private anymore. And don&#039;t just look at CPU usage, look at SIRQ as well, or idle usage which has both SIRQ/CPU subtracted I think.</p></blockquote></div><p>Sorry man. I get lost easily with the terms used on this area and that&#039;s why I could mix up things and ask again to make sure I&#039;m not misunderstanding</p>											<p class="post-edited">(Last edited by <strong>juanmartinbravo</strong> on 7 Jan 2016, 20:01)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p306647">
				<div class="post-metadata">
					<div class="post-num">Post #28</div>
					<div class="post-author">markd1</div>
					<div class="post-datetime">
						7 Jan 2016, 22:32					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>juanmartinbravo wrote:</cite><blockquote><p>just installed the firmware and then openvpn following the instructions of the guide you posted?</p></blockquote></div><p> This. I wouldn&#039;t even know what to optimize.</p><br /><p>I am a little surprised that cpu utilization never got above 60%. I would have expected a number closer to 100%</p>											<p class="post-edited">(Last edited by <strong>markd1</strong> on 7 Jan 2016, 22:33)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p306676">
				<div class="post-metadata">
					<div class="post-num">Post #29</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						8 Jan 2016, 07:10					</div>
				</div>
				<div class="post-content content">
					<p>I spent a lot of time testing some of the settings, and not very good at this.&nbsp; I ended up with these tweaks, though the logs tell me I&#039;m not doing it right.&nbsp; </p><p>&nbsp; &nbsp; option tun_mtu &#039;13000&#039;<br />&nbsp; &nbsp; option fragment &#039;1300&#039;<br />&nbsp; &nbsp; option sndbuf &#039;393216&#039;<br />&nbsp; &nbsp; option rcvbuf &#039;393216&#039;<br />&nbsp; &nbsp; option mssfix &#039;0&#039;</p><p>I do not recall why on any of it.&nbsp; there was lot of reading and a lot of speed testing.&nbsp; Google rcvbuf 393216 and you will find some articles that suggest this value as well as the smaller 65536.</p><p>It seems to work.</p><p>@arokh, are you aware of any OpenWrt notes on the port forwards and firewall rules needed to separate the OpenVPn Server from the router?&nbsp; Not in my skill set.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p306690">
				<div class="post-metadata">
					<div class="post-num">Post #30</div>
					<div class="post-author">juanmartinbravo</div>
					<div class="post-datetime">
						8 Jan 2016, 11:25					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>RangerZ wrote:</cite><blockquote><p>I spent a lot of time testing some of the settings, and not very good at this.&nbsp; I ended up with these tweaks, though the logs tell me I&#039;m not doing it right.&nbsp; </p><p>&nbsp; &nbsp; option tun_mtu &#039;13000&#039;<br />&nbsp; &nbsp; option fragment &#039;1300&#039;<br />&nbsp; &nbsp; option sndbuf &#039;393216&#039;<br />&nbsp; &nbsp; option rcvbuf &#039;393216&#039;<br />&nbsp; &nbsp; option mssfix &#039;0&#039;</p><p>I do not recall why on any of it.&nbsp; there was lot of reading and a lot of speed testing.&nbsp; Google rcvbuf 393216 and you will find some articles that suggest this value as well as the smaller 65536.</p><p>It seems to work.</p><p>@arokh, are you aware of any OpenWrt notes on the port forwards and firewall rules needed to separate the OpenVPn Server from the router?&nbsp; Not in my skill set.</p></blockquote></div><p>tun_mtu &#039;13000&#039; looks like a huge number, you probably will have something in the openvpn log saying that it should be 1500. But if it helps then keep it <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>What improvement did you notice? What speeds could you get before and you can get after doing those changes?</p><p>PS: I&#039;m not an expert neither, but as far as I know you don&#039;t need to open any ports.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p306694">
				<div class="post-metadata">
					<div class="post-num">Post #31</div>
					<div class="post-author">arokh</div>
					<div class="post-datetime">
						8 Jan 2016, 11:49					</div>
				</div>
				<div class="post-content content">
					<p>@RangerZ</p><p>There&#039;s nothing OpenWrt specific about it, just forward port 1194 to your OpenVPN server.</p><p>Messing with the MTU is going to give you more trouble, not more throughput. What you need is to turn off compression and get yourself a faster CPU.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p308222">
				<div class="post-metadata">
					<div class="post-num">Post #32</div>
					<div class="post-author">hunters</div>
					<div class="post-datetime">
						19 Jan 2016, 17:49					</div>
				</div>
				<div class="post-content content">
					<p>Hi to all,<br />I have a test scenario that may be interesting.<br />We are an Italian Phone operator and we use TP-LINK (WR1043ND , WDR4300 and Archer C7) to provide free Wifi connection on the territory through our (or not our) lines (xDSL, FTTK, Wifi and so on) for our customers with these equipments. To do this we use Opwnwrt and OpenVPN (as client) to tunnel all the traffic to our data centers (where OpenVPN servers reside) and have the control of it. What is wierd now is that if I connect the WAN port of one of this equipment in our data center on the switch where the server is located and place my computer behind it i can reach betweek 36 to 42 Mbit/s speed inside the VPN depending on the router model we use.<br />I have to specify that to reach this speed we do not use compression (comp-lzo no) and cipher none on the VPN. This both for performance reason and because it is already traffic that is destined to Internet to be in clear before or later, so crypting is not an issue here.<br />The very weird thing is that when we use these equipments on other kind of connections (xDSL , FTTK, Wireless and so on) we cannot reach more than 10/12 Mbit/s of speed insode the VPN. We tried with another server completely outside of our network too. Just to be sure that is not something depending on our infrastructure. We tried with a WiTi Board too and getting the same result. The WiTi board connected in LAN can reach 65 Mbit/s so it is correct because of the more powerfull CPU it have.<br />With the equipments connected in data centers (LAN) we see the openvpn process keeping 97% of CPU power instead when connected in other places it is keeping 10% (Witi) , 30% (Archer C7) , 35% (WDR4300) , 50% (WR1043ND). So there is a correct and direct relation between the CPU power and the CPU percentage used from the various models.<br />All the tests are made by cable connections and WiFi is left out of the performance tests of the VPN. All the connections are capable of 30 Mbit/s to 100 Mbit/s depending on the type of connection used.<br />The test is made downloading a file that is on the same server that is terminating the VPN so no other party are involved.<br />When we download this test file from that server using the same equipment but going out the VPN we are able to use alle the bandwidth the connection is able to supply without any problem (in LAN it is around 450 Mbit/s) .<br />If we place the same VPN (exactly the same configuration) using a Linux Machine or Mac OSX computer from the same locations we are able to get the full speed of the connection even inside the VPN. So we are sure is not a server side issue.<br />If it was a CPU or Performance issue on the Routers it should do the same when connected in LAN but it is not the case.<br />As my opinion the bottleneck seems to be related on packet switching mechanism or packet delays or similar inside OpenWRT or/and OpenVPN on OpenWRT but we are not able to understand whre the issue can be. We use to fragment the packets of the VPN at 1300 Bytes (fragment 1300 and mssfix) in any VPN (even when it is made in LAN) to be sure to not have MTU issues along the path.<br />This is taking us very mad to solve this issue because customers are getting every day more powerfull connections and starting to ask more bandwidth for their free WiFi access (Hotels, Public parks, Public Administrations and so on).<br />We use UDP protocol and TLS certificates authentication for the VPN.<br />Forgotten to say that we tested with AA,BB,CC versions and the results are identical.<br />If someone have any ideas on this any help is appreciated. We are available to contribute with some money to the community if necessary as the issue starting to become very hot for us as now.<br />Thank you all.<br />Regards,<br />Bye<br />Marcello</p>											<p class="post-edited">(Last edited by <strong>hunters</strong> on 19 Jan 2016, 17:53)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 2 of 2</div><nav><ul><li><a href="viewtopic.php%3Fid=61971&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>