<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> RB-133 lockup</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 12 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p50007">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">osmosis</div>
					<div class="post-datetime">
						8 Jun 2007, 08:16					</div>
				</div>
				<div class="post-content content">
					<p>I am building from the svn HEAD, a kernel for the RB1XX. YAFFS is working, the new interrupt logic looks to be working but periodically the kernel hangs, the symptoms being the console and network are no longer working. There is no panic and my remote syslog server is not recording anything.</p><p>Can anyone provide suggestions on how to debug this scenario? I suspect that this problem is related to the networking and my gut feeling is that the problem is Madwifi/Interrupt related. One way for me to determine the culprit is to remove components (Hardware and Software) until the problem goes away, but this can be very time consuming.</p><p>I have been working at revision 7272 for the last couple of weeks and the 2.19 kernel has been solid on the RB-133 and 133/C hardware.</p><p>Maybe one of the the development guys can provide me a pointer or two to isolate the problem ... or indicate if this is a known problem.</p><p>Thanks,</p><p>Ian</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50032">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">acoul</div>
					<div class="post-datetime">
						8 Jun 2007, 15:53					</div>
				</div>
				<div class="post-content content">
					<p>can you try this&nbsp; with madwifi-0.9.3.1 version?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50054">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">osmosis</div>
					<div class="post-datetime">
						8 Jun 2007, 21:30					</div>
				</div>
				<div class="post-content content">
					<p>The 0.9.3.1 version does not appear to lockup. It was pretty easy to reproduce when using the madwifi on the HEAD as it locked up every 3-4 reboots but 0.9.3.1 has not locked up once in 20 reboots.</p>											<p class="post-edited">(Last edited by <strong>osmosis</strong> on 8 Jun 2007, 21:32)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50178">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">acoul</div>
					<div class="post-datetime">
						10 Jun 2007, 16:09					</div>
				</div>
				<div class="post-content content">
					<p>hope nbd is reading the above report ...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50426">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">osmosis</div>
					<div class="post-datetime">
						13 Jun 2007, 19:13					</div>
				</div>
				<div class="post-content content">
					<p>Everything was working fine with 0.9.3.1 and I mistakenly went back to version on the HEAD and started to have problems again.</p><p>Maybe ndb or someone else can provide some insight as to why a snapshot is being used for Madwifi?</p><p>Thanks,</p><p>Ian</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50474">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">acoul</div>
					<div class="post-datetime">
						14 Jun 2007, 12:17					</div>
				</div>
				<div class="post-content content">
					<p>I guess one of the main goals of open source is to develop and evolve.&nbsp; As long as kamikaze is not stable yet, development and testing is a must and more important perhaps than stability ... looking @ kamikaze_7.06, madwifi-0.9.2.1 may safely go madwifi-0.9.3.1</p>											<p class="post-edited">(Last edited by <strong>acoul</strong> on 14 Jun 2007, 14:51)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50495">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">osmosis</div>
					<div class="post-datetime">
						14 Jun 2007, 18:37					</div>
				</div>
				<div class="post-content content">
					<p>I do understand about the Open Source development process, evolution etc ... I am just trying to understand why a snapshot is being used? There has to be a reason!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50497">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">David Goodenough</div>
					<div class="post-datetime">
						14 Jun 2007, 18:49					</div>
				</div>
				<div class="post-content content">
					<p>Is there a patch somewhere that updates support from 0.9.2.1 to 0.9.3.1?&nbsp; If so it might be worth attaching it to a Trax ticket and adding the ticket number in here so that people can avoid the problem until it gets fixed in svn.</p><p>David</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50516">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">osmosis</div>
					<div class="post-datetime">
						14 Jun 2007, 21:27					</div>
				</div>
				<div class="post-content content">
					<p>I have created a <a href="https://dev.openwrt.org/ticket/1904">ticket</a> and attached an archive that can compiles 0.9.3.1 (Thanks to acoul).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50520">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">juhosg</div>
					<div class="post-datetime">
						14 Jun 2007, 22:27					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>A bit offtopic, but someone can test the new memory detection code on a RB133/RB133C/RB150/RB153? Florian tested it on a Cellvision CAS-771W and on a RB112, i tested it on a ZyXEL Prestige 334WT and it works fine on these boards. I would like to know how it works on the other RouterBOARDs.</p><p>Thanks,<br />Gabor</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50557">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">acoul</div>
					<div class="post-datetime">
						15 Jun 2007, 14:39					</div>
				</div>
				<div class="post-content content">
					<p>I will check on a RB133 and get back to you, thanks</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50593">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">osmosis</div>
					<div class="post-datetime">
						16 Jun 2007, 00:21					</div>
				</div>
				<div class="post-content content">
					<p>Hi Gabor ... good work!</p><p>This is the results of my testing from r7639, which is built entirely from svn (No external changes).</p><p><strong>RB-133 with 1 PCI Card - abbreviated dmesg.</strong></p><div class="codebox"><pre><code>loading kernel from nand... OK
setting up elf image... OK
jumping to kernel code
mem_detect: checking for 64MB chip
mem_detect: 1st pattern at 0x200000 is 0x00
mem_detect: 1st pattern at 0x400000 is 0xff
mem_detect: 1st pattern at 0x800000 is 0x00
mem_detect: 1st pattern at 0x1000000 is 0x55
mem_detect: 2nd pattern at 0x1000000 is 0x55
mem_detect: mirrored data found at 0x1000000
mem_detect: 16MB chip found
mem_detect: 16MB memory found
Linux version 2.6.21.5 (ielbury@nbdev) (gcc version 4.1.2) #1 Fri Jun 15 13:17:13 PDT 2007
ADM5120 revision 8, running at 175MHz
Boot loader is: RouterBOOT
Booted from   : NAND flash
Board is      : RouterBOARD 133
Memory size   : 16MB
CPU revision is: 0001800b
ADM5120 board setup
Determined physical RAM map:
 memory: 00d2d000 @ 002d3000 (usable)
Wasting 23136 bytes for tracking 723 unused pages

...

PCI: mapping irq for device 0000:00:01.0, slot:1, pin:1, irq:6

...</code></pre></div><p><strong>RB-133C with 3 PCI Cards - abbreviated dmesg.</strong></p><div class="codebox"><pre><code>loading kernel from nand... OK
setting up elf image... OK
jumping to kernel code
mem_detect: checking for 64MB chip
mem_detect: 1st pattern at 0x200000 is 0x00
mem_detect: 1st pattern at 0x400000 is 0x7f
mem_detect: 1st pattern at 0x800000 is 0x00
mem_detect: 1st pattern at 0x1000000 is 0x00
mem_detect: 1st pattern at 0x2000000 is 0x55
mem_detect: 2nd pattern at 0x2000000 is 0x55
mem_detect: mirrored data found at 0x2000000
mem_detect: 32MB chip found
mem_detect: 32MB memory found
Linux version 2.6.21.5 (ielbury@nbdev) (gcc version 4.1.2) #1 Fri Jun 15 13:17:13 PDT 2007
ADM5120 revision 8, running at 175MHz
Boot loader is: RouterBOOT
Booted from   : NAND flash
Board is      : RouterBOARD 133
Memory size   : 32MB
CPU revision is: 0001800b
ADM5120 board setup
Determined physical RAM map:
 memory: 01d2d000 @ 002d3000 (usable)
Wasting 23136 bytes for tracking 723 unused pages

...

PCI: mapping irq for device 0000:00:01.0, slot:1, pin:1, irq:6
PCI: mapping irq for device 0000:00:02.0, slot:2, pin:1, irq:7
PCI: mapping irq for device 0000:00:03.0, slot:3, pin:1, irq:8

...

ath_pci: 0.9.4.5 (svn r2420)
PCI: Enabling device 0000:00:01.0 (0000 -&gt; 0002)
ath_pci: switching rfkill capability off
ath_pci: ath_pci: switching per-packet transmit powe
wifi0: 11a rates: 6Mbps 9Mbps 12Mbps 18Mbps 24Mbps 3
wifi0: 11b rates: 1Mbps 2Mbps 5.5Mbps 11Mbps
wifi0: 11g rates: 1Mbps 2Mbps 5.5Mbps 11Mbps 6Mbps 9
wifi0: turboA rates: 6Mbps 9Mbps 12Mbps 18Mbps 24Mbp
wifi0: turboG rates: 6Mbps 12Mbps 18Mbps 24Mbps 36Mb
wifi0: H/W encryption support: WEP AES AES_CCM TKIP
wifi0: mac 10.5 phy 6.1 radio 6.3
wifi0: Use hw queue 1 for WME_AC_BE traffic
wifi0: Use hw queue 0 for WME_AC_BK traffic
wifi0: Use hw queue 2 for WME_AC_VI traffic
wifi0: Use hw queue 3 for WME_AC_VO traffic
wifi0: Use hw queue 8 for CAB traffic
wifi0: Use hw queue 9 for beacons
wifi0: Atheros 5212: mem=0x11400000, irq=6
PCI: Enabling device 0000:00:02.0 (0000 -&gt; 0002)
wifi%d: request_irq failed

...</code></pre></div><p><strong>RB-133C with 3 PCI Cards - /proc/interrupts</strong></p><div class="codebox"><pre><code>root@TestGateway:/# cat /proc/interrupts
           CPU0
  2:          0            MIPS  cascade [INTC]
  6:          0            MIPS  wifi0
  7:      20767            MIPS  timer
  8:          0            INTC  wifi1
  9:        145            INTC  ADM5120 UART
 17:         29            INTC  ethernet switch

ERR:          0</code></pre></div><p><strong>RB-133C with 3 PCI Cards - iwconfig.</strong></p><div class="codebox"><pre><code>root@TestGateway:/# iwconfig
lo        no wireless extensions.

eth0      no wireless extensions.

eth1      no wireless extensions.

eth2      no wireless extensions.

br-lan    no wireless extensions.

imq0      no wireless extensions.

imq1      no wireless extensions.

wifi0     no wireless extensions.

ath0      IEEE 802.11g  ESSID:&quot;XXXXXX&quot;  Nickname:&quot;&quot;
          Mode:Managed  Frequency:2.427 GHz  Access Point: Not-Associated
          Bit Rate:1 Mb/s   Tx-Power:0 dBm   Sensitivity=0/3
          Retry:off   RTS thr:off   Fragment thr:off
          Encryption key:XXXXXXXXX   Security mode:restricted
          Power Management:off
          Link Quality=0/127  Signal level=-256 dBm  Noise level=-256 dBm
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:0   Missed beacon:0</code></pre></div><p>Results:</p><p>- The memory detection logic is working.<br />- PCI interrupt mapping is not correct. There is a conflict with the timer IRQ &lt;-&gt; PCI slot 2.<br />- None of the Wifi PCI cards are working anymore on both the 133 and 133C.</p><p>Cheers,</p><p>Ian</p>											<p class="post-edited">(Last edited by <strong>osmosis</strong> on 16 Jun 2007, 00:31)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50598">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">osmosis</div>
					<div class="post-datetime">
						16 Jun 2007, 01:07					</div>
				</div>
				<div class="post-content content">
					<p>I made the following change in fixup-adm5120.c and all my Wifi cards work now. As this is NOT a proper fix, I have not created a ticket and maybe Gabor can verify???</p><div class="codebox"><pre><code>int __init pcibios_map_irq(struct pci_dev *dev, u8 slot, u8 pin)
{
    int irq;
    
    irq = -1;

    if(slot &gt; 0 &amp;&amp; slot &lt; 4) {
        irq = 10 + slot;
    }
    
    printk(KERN_INFO &quot;PCI: mapping irq for device %s, slot:%u, pin:%u, &quot;
        &quot;irq:%d\n&quot;, pci_name(dev), slot, pin, irq);
        
    return irq;
}</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p50683">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">juhosg</div>
					<div class="post-datetime">
						17 Jun 2007, 19:15					</div>
				</div>
				<div class="post-content content">
					<p>Hello Ian,</p><div class="quotebox"><blockquote><p>Results:</p><p>- The memory detection logic is working.<br />- PCI interrupt mapping is not correct. There is a conflict with the timer IRQ &lt;-&gt; PCI slot 2.<br />- None of the Wifi PCI cards are working anymore on both the 133 and 133C.</p></blockquote></div><p>Thank you for the detailed information. The memory detection logic are still broken on some Edimax devices but this don&#039;t matters here.</p><div class="codebox"><pre><code>if(slot &gt; 0 &amp;&amp; slot &lt; 4) {
        irq = 10 + slot;
    }</code></pre></div><p>The code above assigns irq 11 for slot 1, irq 12 for slot 2, and irq 13 for slot 3. In my opinion this should be something like the code below, because the PCI interrupts counted from 14 since the new IRQ handler.<br /></p><div class="codebox"><pre><code>    if(slot &gt; 0 &amp;&amp; slot &lt; 4) {
        irq = ADM5120_IRQ_PCI0 + slot-1;
    }</code></pre></div><p>Anyway here are new code for PCI IRQ mapping in the svn from now.</p><p>Thanks, <br />Gabor</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>