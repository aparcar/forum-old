<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> build error when compiling ubox</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 3 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p265415">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">tytus64</div>
					<div class="post-datetime">
						13 Feb 2015, 18:40					</div>
				</div>
				<div class="post-content content">
					<p>I hit the following error when building latest openwrt (cloned just today):</p><div class="codebox"><pre><code>make[6]: Entering directory `&lt;mydir&gt;/openwrt/build_dir/target-arm-linux/ubox-2014-10-06&#039;
[ 14%] Building C object CMakeFiles/kmodloader.dir/kmodloader.c.o
&lt;mydir&gt;openwrt/build_dir/target-arm-linux/ubox-2014-10-06/kmodloader.c:35:25: fatal error: libubox/avl.h: No such file or directory
 #include &lt;libubox/avl.h&gt;</code></pre></div><p>I work for Broadcom and I was asked to see if I can get running our new chip with openwrt (at this point just a proof-of-concept). I substituted the tooolchain with our own and pointed to our own kernel tree (all done through make menuconfig).&nbsp; I did not change anything else in the openwrt config - all default packages. </p><p>Unfortunately I am not very familiar with cmake... Below is the full log of the ubox build:</p><div class="codebox"><pre><code>make[3]: Entering directory `/home/promanus/projects/local/openwrt/package/system/ubox&#039;
. /home/promanus/projects/local/openwrt/include/shell.sh; gzip -dc /home/promanus/projects/local/openwrt/dl/ubox-2014-10-06-0b274c16a3f9d235735a4b84215071e1e004caa9.tar.gz | tar -C /home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06/.. -xf - 
touch /home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06/.prepared_529efcce488818d51acdbd7fd631f93d
(cd /home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06; CFLAGS=&quot;-Os -pipe -march=armv7-a -mtune=cortex-a9 -fomit-frame-pointer -fno-strict-aliasing -marm -fno-caller-saves -mfloat-abi=hard &quot; CXXFLAGS=&quot;-Os -pipe -march=armv7-a -mtune=cortex-a9 -fomit-frame-pointer -fno-strict-aliasing -marm -fno-caller-saves -mfloat-abi=hard &quot; LDFLAGS=&quot;-L/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/usr/lib -L/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/lib -L/opt/toolchains/stbgcc-4.8-1.0//usr/lib -L/opt/toolchains/stbgcc-4.8-1.0//lib  &quot; cmake -DCMAKE_SYSTEM_NAME=Linux -DCMAKE_SYSTEM_VERSION=1 -DCMAKE_SYSTEM_PROCESSOR=arm -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_FLAGS_RELEASE=&quot;-DNDEBUG&quot; -DCMAKE_CXX_FLAGS_RELEASE=&quot;-DNDEBUG&quot; -DCMAKE_C_COMPILER=&quot;/opt/toolchains/stbgcc-4.8-1.0/bin/arm-linux-gcc&quot; -DCMAKE_C_COMPILER_ARG1=&quot;&quot; -DCMAKE_CXX_COMPILER=&quot;/opt/toolchains/stbgcc-4.8-1.0/bin/arm-linux-g++&quot; -DCMAKE_CXX_COMPILER_ARG1=&quot;&quot; -DCMAKE_EXE_LINKER_FLAGS:STRING=&quot;-L/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/usr/lib -L/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/lib -L/opt/toolchains/stbgcc-4.8-1.0//usr/lib -L/opt/toolchains/stbgcc-4.8-1.0//lib &quot; -DCMAKE_MODULE_LINKER_FLAGS:STRING=&quot;-L/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/usr/lib -L/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/lib -L/opt/toolchains/stbgcc-4.8-1.0//usr/lib -L/opt/toolchains/stbgcc-4.8-1.0//lib &quot; -DCMAKE_SHARED_LINKER_FLAGS:STRING=&quot;-L/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/usr/lib -L/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/lib -L/opt/toolchains/stbgcc-4.8-1.0//usr/lib -L/opt/toolchains/stbgcc-4.8-1.0//lib &quot; -DCMAKE_AR=&quot;/opt/toolchains/stbgcc-4.8-1.0/bin/arm-linux-ar&quot; -DCMAKE_NM=&quot;/opt/toolchains/stbgcc-4.8-1.0/bin/arm-linux-nm&quot; -DCMAKE_RANLIB=&quot;/opt/toolchains/stbgcc-4.8-1.0/bin/arm-linux-ranlib&quot; -DCMAKE_FIND_ROOT_PATH=&quot;/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux;/home/promanus/projects/local/openwrt/staging_dir/toolchain-arm-linux&quot; -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=BOTH -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY -DCMAKE_STRIP=: -DCMAKE_INSTALL_PREFIX=/usr -DDL_LIBRARY=/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux -DCMAKE_PREFIX_PATH=/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux -DCMAKE_SKIP_RPATH=TRUE  . )
-- The C compiler identification is GNU 4.8.4
-- Check for working C compiler: /opt/toolchains/stbgcc-4.8-1.0/bin/arm-linux-gcc
-- Check for working C compiler: /opt/toolchains/stbgcc-4.8-1.0/bin/arm-linux-gcc -- works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Configuring done
-- Generating done
CMake Warning:
  Manually-specified variables were not used by the project:

    CMAKE_CXX_COMPILER
    CMAKE_CXX_COMPILER_ARG1
    CMAKE_CXX_FLAGS_RELEASE
    CMAKE_FIND_ROOT_PATH_MODE_INCLUDE
    CMAKE_MODULE_LINKER_FLAGS
    DL_LIBRARY


-- Build files have been written to: /home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06
rm -f /home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06/.configured_
touch /home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06/.configured_
CFLAGS=&quot;-Os -pipe -march=armv7-a -mtune=cortex-a9 -fomit-frame-pointer -fno-strict-aliasing -marm -fno-caller-saves -mfloat-abi=hard  -I/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/usr/include -I/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/include -I/opt/toolchains/stbgcc-4.8-1.0//usr/include -I/opt/toolchains/stbgcc-4.8-1.0//include &quot; CXXFLAGS=&quot;-Os -pipe -march=armv7-a -mtune=cortex-a9 -fomit-frame-pointer -fno-strict-aliasing -marm -fno-caller-saves -mfloat-abi=hard  -I/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/usr/include -I/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/include -I/opt/toolchains/stbgcc-4.8-1.0//usr/include -I/opt/toolchains/stbgcc-4.8-1.0//include &quot; LDFLAGS=&quot;-L/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/usr/lib -L/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/lib -L/opt/toolchains/stbgcc-4.8-1.0//usr/lib -L/opt/toolchains/stbgcc-4.8-1.0//lib  &quot; make -j1 -C /home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06/. AR=&quot;arm-linux-ar&quot; AS=&quot;arm-linux-gcc -c -Os -pipe -march=armv7-a -mtune=cortex-a9 -fomit-frame-pointer -fno-strict-aliasing -marm -fno-caller-saves -mfloat-abi=hard&quot; LD=arm-linux-ld NM=&quot;arm-linux-nm&quot; CC=&quot;arm-linux-gcc&quot; GCC=&quot;arm-linux-gcc&quot; CXX=&quot;arm-linux-g++&quot; RANLIB=&quot;arm-linux-ranlib&quot; STRIP=arm-linux-strip OBJCOPY=arm-linux-objcopy OBJDUMP=arm-linux-objdump SIZE=arm-linux-size CROSS=&quot;arm-linux-&quot; ARCH=&quot;arm&quot; ;
make[4]: Entering directory `/home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06&#039;
make[5]: Entering directory `/home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06&#039;
make[6]: Entering directory `/home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06&#039;
Scanning dependencies of target kmodloader
make[6]: Leaving directory `/home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06&#039;
make[6]: Entering directory `/home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06&#039;
[ 14%] Building C object CMakeFiles/kmodloader.dir/kmodloader.c.o
/home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06/kmodloader.c:35:25: fatal error: libubox/avl.h: No such file or directory
 #include &lt;libubox/avl.h&gt;
                         ^
compilation terminated.
make[6]: *** [CMakeFiles/kmodloader.dir/kmodloader.c.o] Error 1
make[6]: Leaving directory `/home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06&#039;
make[5]: *** [CMakeFiles/kmodloader.dir/all] Error 2
make[5]: Leaving directory `/home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06&#039;
make[4]: *** [all] Error 2
make[4]: Leaving directory `/home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06&#039;
make[3]: *** [/home/promanus/projects/local/openwrt/build_dir/target-arm-linux/ubox-2014-10-06/.built] Error 2
make[3]: Leaving directory `/home/promanus/projects/local/openwrt/package/system/ubox&#039;
make[2]: *** [package/system/ubox/compile] Error 2
make[2]: Leaving directory `/home/promanus/projects/local/openwrt&#039;
make[1]: *** [/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/stamp/.package_compile] Error 2
make[1]: Leaving directory `/home/promanus/projects/local/openwrt&#039;
make: *** [world] Error 2</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p265451">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">tytus64</div>
					<div class="post-datetime">
						14 Feb 2015, 00:04					</div>
				</div>
				<div class="post-content content">
					<p>What I eventually end up doing is this:</p><div class="codebox"><pre><code>diff --git a/package/system/ubox/Makefile b/package/system/ubox/Makefile
index de35d58..887c24a 100644
--- a/package/system/ubox/Makefile
+++ b/package/system/ubox/Makefile
@@ -43,4 +43,6 @@ define Package/ubox/install
        ln -s /sbin/kmodloader $(1)/usr/sbin/modprobe
 endef
 
+TARGET_CFLAGS += -I$(STAGING_DIR)/usr/include
+
 $(eval $(call BuildPackage,ubox))</code></pre></div><p>To my surprise I had to add the same change to several other makefiles:<br /></p><div class="codebox"><pre><code>$ git status
On branch 3390
Your branch is up-to-date with &#039;origin/master&#039;.

Changes not staged for commit:
  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)

    modified:   include/site/arm-linux
    modified:   package/network/config/firewall/Makefile
    modified:   package/network/services/odhcpd/Makefile
    modified:   package/system/fstools/Makefile
    modified:   package/system/procd/Makefile
    modified:   package/system/ubox/Makefile
    modified:   package/system/ubus/Makefile
    modified:   package/utils/jsonfilter/Makefile</code></pre></div><p>Not sure if I am doing something wrong here (configuration???). But the changes made do not seem to be related to the custom toolchain and custom kernel...</p><p>Anybody wants to comment?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p265453">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						14 Feb 2015, 00:14					</div>
				</div>
				<div class="post-content content">
					<p>The include path problems are almost certainly related to a custom toolchain. Whats missing in your case is the magic performed by scripts/patch-specs.sh which is called by OpenWrt in the final build stage of GCC.</p><p>That script basically extends the builtin gcc command spec to automatically add -I and -L directives relative to the $STAGING_DIR environment variable, e.g. &quot;-I$STAGING_DIR/include -I$STAGING_DIR/usr/include&quot;. </p><p>This is done to increase the portability of the toolchain, so that there&#039;s no need to funnel -I and -L flags through the entire build, autoconf, etc.</p><p>I do not know how you integrated that external toolchain exactly but if its a standard GCC based one you should be able to apply the patch-specs.sh script manually on it to solve your search path issues.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p265779">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">tytus64</div>
					<div class="post-datetime">
						16 Feb 2015, 18:03					</div>
				</div>
				<div class="post-content content">
					<p>Thanks. Running scripts/patch-specs.sh fixed all include problems. The only change I had to do is the following:</p><div class="codebox"><pre><code>diff --git a/include/site/arm-linux b/include/site/arm-linux
index 80cc8db..40f1a64 100644
--- a/include/site/arm-linux
+++ b/include/site/arm-linux
@@ -26,3 +26,5 @@ ac_cv_sizeof_unsigned_long=4
 ac_cv_sizeof_unsigned_long_long=8
 ac_cv_sizeof_unsigned_short=2
 ac_cv_sizeof_void_p=4
+ac_cv_func_malloc_0_nonnull=yes
+ac_cv_func_realloc_0_nonnull=yes</code></pre></div><p>This change was necessary to fix the following problem:<br /></p><div class="codebox"><pre><code>make[6]: Entering directory `/home/promanus/projects/local/openwrt/build_dir/target-arm-linux/libubox-2015-01-28&#039;
Linking C executable jshn
/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/usr/lib/libjson-c.so: undefined reference to `rpl_malloc&#039;
/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/usr/lib/libjson-c.so: undefined reference to `rpl_realloc&#039;
collect2: error: ld returned 1 exit status
make[6]: *** [jshn] Error 1
make[6]: Leaving directory `/home/promanus/projects/local/openwrt/build_dir/target-arm-linux/libubox-2015-01-28&#039;
make[5]: *** [CMakeFiles/jshn.dir/all] Error 2
make[5]: Leaving directory `/home/promanus/projects/local/openwrt/build_dir/target-arm-linux/libubox-2015-01-28&#039;
make[4]: *** [all] Error 2
make[4]: Leaving directory `/home/promanus/projects/local/openwrt/build_dir/target-arm-linux/libubox-2015-01-28&#039;
make[3]: *** [/home/promanus/projects/local/openwrt/build_dir/target-arm-linux/libubox-2015-01-28/.built] Error 2
make[3]: Leaving directory `/home/promanus/projects/local/openwrt/package/libs/libubox&#039;
make[2]: *** [package/libs/libubox/compile] Error 2
make[2]: Leaving directory `/home/promanus/projects/local/openwrt&#039;
make[1]: *** [/home/promanus/projects/local/openwrt/staging_dir/target-arm-linux/stamp/.package_compile] Error 2
make[1]: Leaving directory `/home/promanus/projects/local/openwrt&#039;
make: *** [world] Error 2</code></pre></div><p>I wonder if I missed something else or this is a legitimate bug?</p>											<p class="post-edited">(Last edited by <strong>tytus64</strong> on 16 Feb 2015, 18:03)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p265909">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						17 Feb 2015, 14:31					</div>
				</div>
				<div class="post-content content">
					<p>I guess it is a kind of semi-legitimate bug. Its likely only encountered by your toolchain because it uses a target name triplet which is not used by any other OpenWrt target.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>