<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> ar9331&#039;s usb stability issue - [SOLVED]</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 23 Mar 2017 and 6 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 11 of 13</div><nav><ul><li><a href="viewtopic.php%3Fid=39956&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39956&amp;p=9.html">9</a></li><li><a href="viewtopic.php%3Fid=39956&amp;p=10.html">10</a></li><li class="pagination-current"><span>11</span></li><li><a href="viewtopic.php%3Fid=39956&amp;p=12.html">12</a></li><li><a href="viewtopic.php%3Fid=39956&amp;p=13.html">13</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p226534">
				<div class="post-metadata">
					<div class="post-num">Post #251</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						1 Mar 2014, 00:08					</div>
				</div>
				<div class="post-content content">
					<p>You need to remove only the &quot;.config&quot; file in the OpenWRT root directory.</p><p>You also need to fetch all the packages from separate feeds and install them before running the &quot;make menuconfig&quot;.</p><p>From the root directory, do:<br /></p><div class="codebox"><pre><code>./scripts/feeds update -a
./scripts/feeds install -a</code></pre></div><p>You should then get some ~3000 packages <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p226540">
				<div class="post-metadata">
					<div class="post-num">Post #252</div>
					<div class="post-author">lizby</div>
					<div class="post-datetime">
						1 Mar 2014, 01:27					</div>
				</div>
				<div class="post-content content">
					<p>Ok, thank you.&nbsp; I didn&#039;t realize that &quot;.config&quot; was an actual file which would not be shown by &quot;ls&quot;.&nbsp; </p><p>Running now.&nbsp; I wonder what time tomorrow it will finish.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p226561">
				<div class="post-metadata">
					<div class="post-num">Post #253</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						1 Mar 2014, 10:06					</div>
				</div>
				<div class="post-content content">
					<p>On a quad core i7, the Full Monty takes about 2h15.</p><p>You can then check into the &quot;logs&quot; directory what happened, especially the &quot;logs/package/error.txt&quot; file: these are the packages in error.</p><p>This procedure is what is performed periodically by the buildbot: <a href="http://buildbot.openwrt.org:8010/">http://buildbot.openwrt.org:8010/</a>.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p226609">
				<div class="post-metadata">
					<div class="post-num">Post #254</div>
					<div class="post-author">lizby</div>
					<div class="post-datetime">
						1 Mar 2014, 22:25					</div>
				</div>
				<div class="post-content content">
					<p>Well, some progress, but I appear stuck again.&nbsp; The first attempt failed saying I needed libssl-dev, so:</p><p>sudo apt-get update<br />sudo apt-get install libssl-dev</p><p>The next pass ran for an hour and 20 minutes, building many packages, but then failed in a way that doesn&#039;t tell me much.&nbsp; The &quot;logs/package/error.txt&quot; file doesn&#039;t exist.</p><p>Here are the last 20 or so lines of the run<br /></p><div class="codebox"><pre><code>rm -f /home/lb/openwrt/aa_r39407/staging_dir/host/bin/python2
(cd /home/lb/openwrt/aa_r39407/staging_dir/host/bin; ln -s python2.7 python2)
rm -f /home/lb/openwrt/aa_r39407/staging_dir/host/bin/python2-config
(cd /home/lb/openwrt/aa_r39407/staging_dir/host/bin; ln -s python2.7-config python2-config)
rm -f /home/lb/openwrt/aa_r39407/staging_dir/host/bin/python-config
(cd /home/lb/openwrt/aa_r39407/staging_dir/host/bin; ln -s python2-config python-config)
test -d /home/lb/openwrt/aa_r39407/staging_dir/host/lib/pkgconfig || /usr/bin/install -c -d -m 755 /home/lb/openwrt/aa_r39407/staging_dir/host/lib/pkgconfig
rm -f /home/lb/openwrt/aa_r39407/staging_dir/host/lib/pkgconfig/python2.pc
(cd /home/lb/openwrt/aa_r39407/staging_dir/host/lib/pkgconfig; ln -s python-2.7.pc python2.pc)
rm -f /home/lb/openwrt/aa_r39407/staging_dir/host/lib/pkgconfig/python.pc
(cd /home/lb/openwrt/aa_r39407/staging_dir/host/lib/pkgconfig; ln -s python2.pc python.pc)
/usr/bin/install -c -m 644 ./Misc/python.man \
                /home/lb/openwrt/aa_r39407/staging_dir/host/share/man/man1/python2.7.1
make[4]: Leaving directory `/home/lb/openwrt/aa_r39407/build_dir/host/Python-2.7.3&#039;
install -m0755 /home/lb/openwrt/aa_r39407/build_dir/host/Python-2.7.3/Parser/pgen /home/lb/openwrt/aa_r39407/staging_dir/host/bin/
touch /home/lb/openwrt/aa_r39407/build_dir/host/Python-2.7.3/.built
make[3]: Leaving directory `/home/lb/openwrt/aa_r39407/feeds/packages/lang/python&#039;
make[2]: Leaving directory `/home/lb/openwrt/aa_r39407&#039;
make[1]: *** [/home/lb/openwrt/aa_r39407/staging_dir/target-mips_r2_uClibc-0.9.33.2/stamp/.package_compile] Error 2
make[1]: Leaving directory `/home/lb/openwrt/aa_r39407&#039;
make: *** [world] Error 2
lb@lb-atom1:~/openwrt/aa_r39407$</code></pre></div>											<p class="post-edited">(Last edited by <strong>lizby</strong> on 1 Mar 2014, 22:26)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p226610">
				<div class="post-metadata">
					<div class="post-num">Post #255</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						1 Mar 2014, 22:33					</div>
				</div>
				<div class="post-content content">
					<p>Make sure you installed all the OpenWRT prerequisites first:<br /><a href="http://wiki.openwrt.org/doc/howto/buildroot.exigence">http://wiki.openwrt.org/doc/howto/buildroot.exigence</a></p><p>Then read carefully how to build OpenWRT:<br /><a href="http://wiki.openwrt.org/doc/howto/build">http://wiki.openwrt.org/doc/howto/build</a></p><p>This should save you a lot of efforts!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p226618">
				<div class="post-metadata">
					<div class="post-num">Post #256</div>
					<div class="post-author">lizby</div>
					<div class="post-datetime">
						2 Mar 2014, 02:48					</div>
				</div>
				<div class="post-content content">
					<p>Well, I&#039;ve built openwrt many dozens of times over the past 6 years and flashed several dozen different devices, but my notes are old and you can always learn something new--thanks for the references.</p><p>In going over those links you referred to, I saw something I hadn&#039;t used before, &quot;make prereq&quot;&nbsp; I tried that, got a little but not much further, and stopped again with Error 2.<br /></p><div class="codebox"><pre><code>make[3]: Leaving directory `/home/lb/openwrt/aa_r39407/feeds/packages/net/axel&#039;
make[2]: Leaving directory `/home/lb/openwrt/aa_r39407&#039;
make[1]: *** [/home/lb/openwrt/aa_r39407/staging_dir/target-mips_r2_uClibc-0.9.33.2/stamp/.package_compile] Error 2
make[1]: Leaving directory `/home/lb/openwrt/aa_r39407&#039;
make: *** [world] Error 2</code></pre></div><p>Again cryptic.&nbsp; I don&#039;t recall in the past having gotten errors for which the meaning was so obscure.&nbsp; I&#039;ll keep looking into prerequisites, but basically I have what I wanted--a way to build an AA image with the serial patch included, and a way to build, if I want additional individual packages.</p>											<p class="post-edited">(Last edited by <strong>lizby</strong> on 2 Mar 2014, 02:49)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p227284">
				<div class="post-metadata">
					<div class="post-num">Post #257</div>
					<div class="post-author">efcis</div>
					<div class="post-datetime">
						11 Mar 2014, 04:12					</div>
				</div>
				<div class="post-content content">
					<p>Hi</p><p>I&#039;m still fighting to use a plain Low Speed keypad with my WR703N, with a hub in between. I&#039;m running BB r39770.</p><p>If I use a High Speed hub, it perfectly works, but if I use a Full Speed hub, it doesn&#039;t (the keypad is not recognized as HID, and no message is displayed in dmesg)</p><p>High Speed Hub (7 ports) :<br /></p><div class="codebox"><pre><code>[  128.180000] usb 1-1: new high-speed USB device number 3 using ehci-platform
[  128.340000] hub 1-1:1.0: USB hub found
[  128.340000] hub 1-1:1.0: 4 ports detected
[  128.620000] usb 1-1.1: new high-speed USB device number 4 using ehci-platform
[  128.740000] hub 1-1.1:1.0: USB hub found
[  128.740000] hub 1-1.1:1.0: 4 ports detected
[  148.450000] usb 1-1.1.1: new low-speed USB device number 5 using ehci-platform
[  148.600000] input: HID 1710:8812 as /devices/platform/ehci-platform/usb1/1-1/1-1.1/1-1.1.1/1-1.1.1:1.0/input/input0
[  148.610000] hid-generic 0003:1710:8812.0001: input,hidraw0: USB HID v1.10 Keyboard [HID 1710:8812] on usb-ehci-platform-1.1.1/input0</code></pre></div><p>Full Speed hub (4 ports)<br /></p><div class="codebox"><pre><code>[  184.550000] usb 1-1: new full-speed USB device number 6 using ehci-platform
[  184.720000] hub 1-1:1.0: USB hub found
[  184.720000] hub 1-1:1.0: 4 ports detected
[  196.840000] usb 1-1.3: new low-speed USB device number 7 using ehci-platform
[  212.920000] hub 1-1:1.0: cannot reset port 3 (err = -145)
[  213.940000] hub 1-1:1.0: cannot reset port 3 (err = -145)
[  214.960000] hub 1-1:1.0: cannot reset port 3 (err = -145)
[  215.980000] hub 1-1:1.0: cannot reset port 3 (err = -145)</code></pre></div><p>I tried another 4 ports FS hub (different model) with the same result :-(</p><p>The build revision suggest that your work / patch described in the thread has been in integrated, so I&#039;m wondering what could be wrong ?</p><p>Any idea ? Thanks !</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p227560">
				<div class="post-metadata">
					<div class="post-num">Post #258</div>
					<div class="post-author">efcis</div>
					<div class="post-datetime">
						14 Mar 2014, 00:48					</div>
				</div>
				<div class="post-content content">
					<p>[Follow-Up]</p><p>When using a LS device (keyboards, mice), a true High Speed hub is necessary.</p><p>Thanks to Squonk for his expertise.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p227707">
				<div class="post-metadata">
					<div class="post-num">Post #259</div>
					<div class="post-author">davor128</div>
					<div class="post-datetime">
						16 Mar 2014, 16:28					</div>
				</div>
				<div class="post-content content">
					<p>Hello!</p><p>Has anybody tried USB port on TPlink MR3220 for USB Audio after the&nbsp; 566-ath9k-ar933x-usb-hang-workaround.patch?</p><p>I tried it today and I get a lot of disturbances (sounds like static) when playing audio.<br />No special messages in dmesg, cheking stream0 values - all O.K.</p><p>Would just like to now if there is something wrong in my build (MPD problems, kernel, alsa....)</p><p>Thanks,<br />Davor.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p227742">
				<div class="post-metadata">
					<div class="post-num">Post #260</div>
					<div class="post-author">davor128</div>
					<div class="post-datetime">
						17 Mar 2014, 00:57					</div>
				</div>
				<div class="post-content content">
					<p>To continue - tried the daily snapshot on Alix2d2 board - no crackling.</p><p>Any comment?</p><br /><p>Thank you,<br />Davor.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p227755">
				<div class="post-metadata">
					<div class="post-num">Post #261</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						17 Mar 2014, 07:29					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>davor128 wrote:</cite><blockquote><p>To continue - tried the daily snapshot on Alix2d2 board - no crackling.</p><p>Any comment?</p><br /><p>Thank you,<br />Davor.</p></blockquote></div><p>Can you try with WiFi turned off?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p227795">
				<div class="post-metadata">
					<div class="post-num">Post #262</div>
					<div class="post-author">davor128</div>
					<div class="post-datetime">
						17 Mar 2014, 17:44					</div>
				</div>
				<div class="post-content content">
					<p>Same situation.</p><p>I have an alix2d2 with the latest trunk and DAC near the Wifi antenna - no problems.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p227816">
				<div class="post-metadata">
					<div class="post-num">Post #263</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						17 Mar 2014, 22:27					</div>
				</div>
				<div class="post-content content">
					<p>So it&#039;s another issue, since the problem we found was related to RF spurious emissions causing the USB PLL to unlock and hang the USB.</p><p>It may cause some glitches in the audio, but if this problems also happens with WiFi turned off, it is something different.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p227830">
				<div class="post-metadata">
					<div class="post-num">Post #264</div>
					<div class="post-author">davor128</div>
					<div class="post-datetime">
						18 Mar 2014, 00:32					</div>
				</div>
				<div class="post-content content">
					<p>I should add that this situation is not &quot;the end of the wrold&quot;...<br />I saw that there is a patch for the USB instability and decided to try.</p><p>You may recall my previous tests with this router.</p><p>I also found that Raspberry Pi also had (or still has) problems using USB port for USB AUDIO.</p><p>Since USB port seems to work in situations where basic data transfer is needed I would say the problem is solved.</p><p>On the other hand, it is interesting to see, what sort of &quot;solutons&quot; are used by manufacturers when developing the product.<br />Puting something on the market even if you now there is a flaw in the product...<br />And then enthusiasts search for the solution.</p><p>I will try some more settings and tests, can&#039;t help my curiosity. Hope my two cats won&#039;t get hurt...:)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p231302">
				<div class="post-metadata">
					<div class="post-num">Post #265</div>
					<div class="post-author">danak6jq</div>
					<div class="post-datetime">
						26 Apr 2014, 02:11					</div>
				</div>
				<div class="post-content content">
					<p>I have a Carambola2-based project, with a LUFA USB CDC-ACM ATmega16U4 device attached, running recently-pulled Barrier Breaker bits (as in today). I believe I have the atkh9k USB stability patch.</p><p>USB stability is great with wifi enabled in STA mode, associated with an AP.</p><p>However, if I am not associated with an AP, USB activity quickly leads to a hang. A reset of the USB device brings the USB<br />back, however it has new Linux /dev links.</p><p>I&#039;m theorizing that the unassociated wifi interface is scanning repeatedly - as evidenced by &#039;iw event&#039; - and this is tripping<br />over some variant of the same issue that&#039;s supposed to be fixed here.</p><p>Any suggestions on how to proceed?</p><p>Thanks -<br />Dana&nbsp; K6JQ</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p231324">
				<div class="post-metadata">
					<div class="post-num">Post #266</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						26 Apr 2014, 12:06					</div>
				</div>
				<div class="post-content content">
					<p>The AR9331 WiFi is using an on-chip synthesizer to generate the local oscillator (LO) frequencies for the receiver and transmitter mixers.</p><p>This synthesizer is a fractional-N synthesizer taking the 40 MHz crystal input as the reference and using an on-chip voltage controlled oscillator (VCO) to provide the desired LO signal based on a phase/frequency locked loop (PLL).</p><p>Unfortunately, it looks like the AR9331 USB in full-speed mode is influenced in some way when there is a required change in the LO frequency, such as when powering up or performing a channel reselection.</p><p>My guess is that the built-in FS USB controller is deriving its clock from this PLL in some way, and as the synthesizer takes approximately 0.2 ms to settle, the USB controller just hangs.</p><p>For an unknown reason, this phenomenon does not happen with the High-Speed USB controller is used.</p><p>If you look at the patch, its role is mainly to disable the USB PLL lock detect when either WiFi power up or channel reselection is performed:<br /><a href="http://patchwork.openwrt.org/patch/4608/">http://patchwork.openwrt.org/patch/4608/</a></p><p>From what you say, we may well have missed one case when the device is not associated... The game is to find where this happens!</p><p>It is not as critical as the original behavior, since it only happens when WiFi is turned on and not in associated STA or AP mode, but I understand this may be serious in some particular cases.</p><p>If you have time to investigate this case, please go ahead and try to determine where the PLL frequency might be changed during scanning, as I won&#039;t have much time to allocate to this problem in the near future.</p>											<p class="post-edited">(Last edited by <strong>Squonk</strong> on 26 Apr 2014, 12:06)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p231346">
				<div class="post-metadata">
					<div class="post-num">Post #267</div>
					<div class="post-author">danak6jq</div>
					<div class="post-datetime">
						26 Apr 2014, 19:47					</div>
				</div>
				<div class="post-content content">
					<p>Thank you for the insight - this confirmed and clarified my understanding of the USB PLL issue (a truly marvelous bit of SoC randomness there).</p><p>While I have not tested it yet, I tend to believe an unassociated AP won&#039;t enounter this problem - based on my possibly incomplete understanding that the AP won&#039;t channel scan and the assumption that unassociated STA mode is repeatedly channel-scanning.</p><p>Unfortunately I am limited to Full and Low Speed with the ATmega16U4; I haven&#039;t tried it yet, but I suspect that limiting to Low Speed would not work-around this issue (likely uses the same hardware path inside the AR9331).</p><p>An application-level work-around for me may be simply disabling the unassociated wifi during USB I/O; sounds nice in theory but rather ugly in practice.</p><p>I&#039;ll take a look at the Wifi driver - admittedly not very familiar with it - and see if I can understand where the unassociated scan case is evading the existing patch. Any advice, help, encouragement is highly appreciated.</p><p>Thanks again!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p231350">
				<div class="post-metadata">
					<div class="post-num">Post #268</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						26 Apr 2014, 20:39					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>danak6jq wrote:</cite><blockquote><p>While I have not tested it yet, I tend to believe an unassociated AP won&#039;t enounter this problem - based on my possibly incomplete understanding that the AP won&#039;t channel scan and the assumption that unassociated STA mode is repeatedly channel-scanning.</p></blockquote></div><p>Yes, the problem is probably coming from the channel scanning.</p><div class="quotebox"><cite>danak6jq wrote:</cite><blockquote><p>Unfortunately I am limited to Full and Low Speed with the ATmega16U4; I haven&#039;t tried it yet, but I suspect that limiting to Low Speed would not work-around this issue (likely uses the same hardware path inside the AR9331).!</p></blockquote></div><p>AFAICT, Low-Spepd USB is not working with the AR9331, unless you put a hub in-between. It is rather strange, since basically the only required change between FS and LS is to divide the clock by 8 (or oversample x8, this is the same), unlike the HS and FS/LS wich uses 2 disttinct controller, the HS handing over to the FS/LS one the corresponding packets.</p><div class="quotebox"><cite>danak6jq wrote:</cite><blockquote><p>I&#039;ll take a look at the Wifi driver - admittedly not very familiar with it - and see if I can understand where the unassociated scan case is evading the existing patch. Any advice, help, encouragement is highly appreciated.</p></blockquote></div><p>Good luck, maybe &quot;iw event&quot; can provide some details? The problem is the PLL startup and channel reselection, so look at when this happens to find the culprit.</p><p>Good luck!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p231746">
				<div class="post-metadata">
					<div class="post-num">Post #269</div>
					<div class="post-author">danak6jq</div>
					<div class="post-datetime">
						29 Apr 2014, 20:29					</div>
				</div>
				<div class="post-content content">
					<p>The issue: un-associated STA Wifi causes hang of Full-Speed USB I/O.</p><p>Experimentation has shown:</p><p>- Simply holding the USB CDC-ACM device open without traffic is adequate to reproduce this issue (may take a minute)<br />- &#039;iw event&#039; indicates, as expected, un-associated STA is repeatedly channel scanning<br />- Disabling fast channel-change in ath9k/hw.c does not make a difference<br />- Issue is 100% reproducible</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p232581">
				<div class="post-metadata">
					<div class="post-num">Post #270</div>
					<div class="post-author">rudebwoy</div>
					<div class="post-datetime">
						6 May 2014, 17:51					</div>
				</div>
				<div class="post-content content">
					<p>Hello Everybody. Thanks for all information found in this topic (especially to Squonk), very useful info. Im fighting with the same issue as Danak6jq is having. Im using Carambola 2 with external usb device (LPC11U3X), and trying to stabilize this communication. As soon as wifi activity disconnects or connects to any network, the communication between usb device and carambola 2 is being dropped. I have patched the firmware with the 566 patch from 8devices forum, but this has not solved this issue at all. I have tested also with other patch 561 from the openwrt resources, but this didn&#039;t help with this issue. Im still having not stable communication that can still be broken through wifi activity. Im not sure if i made this firmware correctly. You are writing that the problems are solved with this patch, but im not sure if i did it properly, cause i made firmware build with this patch. Is this really SOLVED and i can not follow correctly Your instructions, or is it still possible that i have done sth wrong and it is still possible that this wont work with patches too. The build can only be prepared with one of this two patches, both is not possible to compile, compilation errors (im checking with patch 561(so called) - (from Openwrt) and called 566 (from 8Devices). Is it right what im doing? Is there any possibility to check if this patch is included in running system what i have loaded into Carambola 2 device. Can You help me somehow with this issue? Im sorry for my English, hope You understand what i mean. I must to have stable communication between USB and Carambola 2 without influence of wifi activity. Thank You for the answer.</p>											<p class="post-edited">(Last edited by <strong>rudebwoy</strong> on 6 May 2014, 17:56)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p232607">
				<div class="post-metadata">
					<div class="post-num">Post #271</div>
					<div class="post-author">danak6jq</div>
					<div class="post-datetime">
						6 May 2014, 21:41					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>rudebwoy wrote:</cite><blockquote><p>Hello Everybody. Thanks for all information found in this topic (especially to Squonk), very useful info. Im fighting with the same issue as Danak6jq is having. Im using Carambola 2 with external usb device (LPC11U3X), and trying to stabilize this communication. As soon as wifi activity disconnects or connects to any network, the communication between usb device and carambola 2 is being dropped. I have patched the firmware with the 566 patch from 8devices forum, but this has not solved this issue at all. I have tested also with other patch 561 from the openwrt resources, but this didn&#039;t help with this issue. Im still having not stable communication that can still be broken through wifi activity. Im not sure if i made this firmware correctly. You are writing that the problems are solved with this patch, but im not sure if i did it properly, cause i made firmware build with this patch. Is this really SOLVED and i can not follow correctly Your instructions, or is it still possible that i have done sth wrong and it is still possible that this wont work with patches too. The build can only be prepared with one of this two patches, both is not possible to compile, compilation errors (im checking with patch 561(so called) - (from Openwrt) and called 566 (from 8Devices). Is it right what im doing? Is there any possibility to check if this patch is included in running system what i have loaded into Carambola 2 device. Can You help me somehow with this issue? Im sorry for my English, hope You understand what i mean. I must to have stable communication between USB and Carambola 2 without influence of wifi activity. Thank You for the answer.</p></blockquote></div><p>I personally wondered if patch 566 was really applied, but I tinkered with the patch and confirmed that it is indeed present on my firmware build. This left me believing that the patch solves a worse problem - that the AR9331 running as an AP kills the USB. If you use the AR9331 as a client/STA, and it is unassociated, it will still kill the USB.</p><p>Ultimately, I gave up on a patch solution for this, and tested a passive USB 2.0 hub between the AR9331 and my USB peripherhal, and, as expected, USB operation has been stable. The side-effect for me is that adding a USB 2.0 hub means my project will have an external USB port now, which is a feature I was considering anyway. So I&#039;m happy enough.</p><p>I do have doubts that any software patch will resolve this issue anyway.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p232650">
				<div class="post-metadata">
					<div class="post-num">Post #272</div>
					<div class="post-author">rudebwoy</div>
					<div class="post-datetime">
						7 May 2014, 09:10					</div>
				</div>
				<div class="post-content content">
					<p>Thank You danak6jq. I have got the same result as You wrote. Anyway this thread will stay opened for OpenWrt developers if somebody want to help and patch this issue.<br />Thank You one more time</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p232780">
				<div class="post-metadata">
					<div class="post-num">Post #273</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						8 May 2014, 10:39					</div>
				</div>
				<div class="post-content content">
					<p>I will try to explain the root cause for this bug, it may help to understand the situation...</p><p>Basically, a piezoelectric crystal provides a very stable (~30 ppm or parts per millions, not per cent!)&nbsp; filter for an oscillator in the Mhz range, on the AR9331, it is either a 25 MHz or 40 MHz crystal.</p><p>However, the WiFi RF requires much higher frequencies in the 2.4 GHz range but still very stable, and moreover, the ability to have not a single stable but variable frequencies in this band in order to cover the different available channels.</p><p>This is achieved through the use of an electronic circuit called a PLL (Phase-Locked Loop) that uses the lowest frequency crystal-based oscillator to &quot;drive&quot; the highest frequency oscillator: when the highest frequency oscillator is &quot;late&quot; compared to the stable lowest frequency one, its is boosted a little, if &quot;early&quot;, it is slowed down a little, so the highest frequency oscillator is &quot;phased-locked&quot; with the lowest one.</p><p>Unfortunately&nbsp; in the AR9331, it looks like that, changing the RF PLL frequency affects the USB clock, which is also derived from the single 25 MHz crystal-based oscillator by (I hope!) a separate PLL to generate the 12 MHz required for the Full-Speed USB OHCI controller clock. For an unknown reason, it does not affect the 480 MHz clock required by the separate High-Speed USB EHCI controller, which usually handles over FS traffic down to the OHCI one...</p><p>Thus, the AR9331 has a problem when starting the RF oscillator or changing the WiFi channel, and what the patch basically does is to &quot;hold&quot; the USB PLL while doing these actions.</p><p>But it looks like there is still a case that is not handled correctly when a client is not associated to an AP and regularly sends WiFi &quot;Probe Request&quot; packets on the different available channels to get a list of available APs, causing the same problem on the USB.</p><p>IMHO, it is not a major problem though, since when not associated, you can&#039;t do much anyway, but it is nevertheless the same bug, we just have to find where to put the missing workaround macro!</p><p>So I think you are safe as long as you are either an AP or an associated client, please report if not.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p232803">
				<div class="post-metadata">
					<div class="post-num">Post #274</div>
					<div class="post-author">danak6jq</div>
					<div class="post-datetime">
						8 May 2014, 17:19					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Squonk wrote:</cite><blockquote><p>But it looks like there is still a case that is not handled correctly when a client is not associated to an AP and regularly sends WiFi &quot;Probe Request&quot; packets on the different available channels to get a list of available APs, causing the same problem on the USB.</p><p>IMHO, it is not a major problem though, since when not associated, you can&#039;t do much anyway, but it is nevertheless the same bug, we just have to find where to put the missing workaround macro!</p><p>So I think you are safe as long as you are either an AP or an associated client, please report if not.</p></blockquote></div><p>I beg to differ regarding the seriousness of this issue in embedded application of the AR9331 where the Wifi interface is configured as a client / STA. First of all, in an embedded application, Wifi connectivity is not required to function as a standalone system - think of the AR9331 as an application CPU that happens to have both an Ethernet and Wifi interface available as needed (and not a Wifi device that happens to be able to run applications).</p><p>Further, the stability of the AR9331 with client-mode Wifi is directly impacted by that of an associated AP. If the AR9331 client Wifi is associated with an AP, and the AP is rebooted or power is interrupted, even a fairly short interruption of AP assocation will cause the AR9331 to enter Wifi scan mode and the USB is likely to be broken.</p><p>Once the USB is broken, programmatic recovery is difficult, if possible at all.</p>											<p class="post-edited">(Last edited by <strong>danak6jq</strong> on 8 May 2014, 17:24)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p232811">
				<div class="post-metadata">
					<div class="post-num">Post #275</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						8 May 2014, 17:50					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>danak6jq wrote:</cite><blockquote><p>I beg to differ regarding the seriousness of this issue in embedded application of the AR9331 where the Wifi interface is configured as a client / STA. First of all, in an embedded application, Wifi connectivity is not required to function as a standalone system - think of the AR9331 as an application CPU that happens to have both an Ethernet and Wifi interface available as needed (and not a Wifi device that happens to be able to run applications).</p></blockquote></div><p>In this case, you can just turn off WiFi.</p><div class="quotebox"><cite>danak6jq wrote:</cite><blockquote><p>Further, the stability of the AR9331 with client-mode Wifi is directly impacted by that of an associated AP. If the AR9331 client Wifi is associated with an AP, and the AP is rebooted or power is interrupted, even a fairly short interruption of AP assocation will cause the AR9331 to enter Wifi scan mode and the USB is likely to be broken.</p><p>Once the USB is broken, programmatic recovery is difficult, if possible at all.</p></blockquote></div><p>Yes, good point on this one!</p><p>So, we need to find the spots where we need to add the missing workaround macros.</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 11 of 13</div><nav><ul><li><a href="viewtopic.php%3Fid=39956&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39956&amp;p=9.html">9</a></li><li><a href="viewtopic.php%3Fid=39956&amp;p=10.html">10</a></li><li class="pagination-current"><span>11</span></li><li><a href="viewtopic.php%3Fid=39956&amp;p=12.html">12</a></li><li><a href="viewtopic.php%3Fid=39956&amp;p=13.html">13</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0.001 -->

</body>
</html>