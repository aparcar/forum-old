<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> OpenVPN Client Can&#039;t Connect</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 29 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p168899">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">rdibley</div>
					<div class="post-datetime">
						2 Jun 2012, 20:05					</div>
				</div>
				<div class="post-content content">
					<p>I installed OpenVPN on a WRT54GS running Backfire 10.03.1 (r29592), with the 2.4 kernel.&nbsp; I am connecting from a Mac using Tunnelblick.&nbsp; The client gets as far as contacting the server, then hangs waiting for a response.&nbsp; OpenVPN is running on the server, but /tmp/openvpn-status.log file does not show any logs at the time when I tried to connect.&nbsp; I think I have the firewall settings set correctly, but I&#039;m not sure what to check at this point.&nbsp; I looked at the LuCI Status-&gt;Firewall page, and it shows that four packets were received (this was after a few attempts):</p><div class="codebox"><pre><code>Rule#        3
Pkts.            4
Traffic        168.00 B
Target        ACCEPT
Prot.            udp
Flags            --
In            *
Out            *
Source        0.0.0.0/0
Destination    0.0.0.0/0
Options        udp dpt:1194</code></pre></div><p>What else can I do to diagnose the problem?&nbsp; Does the status on the LuCI indicate the packets received by the router, or those passed through the firewall?&nbsp; What other tools would I use to test the functionality of the firewall?</p><p>Tunnelblick client log:</p><div class="codebox"><pre><code>2012-06-02 09:22:17 *Tunnelblick: OS X 10.6.8; Tunnelblick 3.2.6 (build 2891.3007)
2012-06-02 09:22:17 *Tunnelblick: Attempting connection with OpenVPN; Set nameserver = 1; monitoring connection
2012-06-02 09:22:17 *Tunnelblick: /Applications/Tunnelblick.app/Contents/Resources/openvpnstart start OpenVPN.tblk 1338 1 0 0 0 114 -atDASNGWrdasngw 
2012-06-02 09:22:17 *Tunnelblick: openvpnstart message: Loading tap.kext
2012-06-02 09:22:17 OpenVPN 2.2.1 i386-apple-darwin10.7.1 [SSL] [LZO2] [PKCS11] [eurephia] built on May  2 2012
2012-06-02 09:22:17 MANAGEMENT: TCP Socket listening on 127.0.0.1:1338
2012-06-02 09:22:17 Need hold release from management interface, waiting...
2012-06-02 09:22:17 MANAGEMENT: Client connected from 127.0.0.1:1338
2012-06-02 09:22:17 MANAGEMENT: CMD &#039;pid&#039;
2012-06-02 09:22:17 MANAGEMENT: CMD &#039;state on&#039;
2012-06-02 09:22:17 MANAGEMENT: CMD &#039;state&#039;
2012-06-02 09:22:17 MANAGEMENT: CMD &#039;hold release&#039;
2012-06-02 09:22:17 NOTE: the current --script-security setting may allow this configuration to call user-defined scripts
2012-06-02 09:22:17 *Tunnelblick: openvpnstart: /Applications/Tunnelblick.app/Contents/Resources/openvpn/openvpn-2.2.1/openvpn --cd /Users/rdibley/Library/Application Support/Tunnelblick/Configurations/OpenVPN.tblk/Contents/Resources --daemon --management 127.0.0.1 1338 --config /Users/rdibley/Library/Application Support/Tunnelblick/Configurations/OpenVPN.tblk/Contents/Resources/config.ovpn --log /Library/Application Support/Tunnelblick/Logs/-SUsers-Srdibley-SLibrary-SApplication Support-STunnelblick-SConfigurations-SOpenVPN.tblk-SContents-SResources-Sconfig.ovpn.1_0_0_0_114.1338.openvpn.log --management-query-passwords --management-hold --script-security 2 --up /Applications/Tunnelblick.app/Contents/Resources/client.up.tunnelblick.sh -m -w -d -a -atDASNGWrdasngw --down /Applications/Tunnelblick.app/Contents/Resources/client.down.tunnelblick.sh -m -w -d -a -atDASNGWrdasngw --up-restart
2012-06-02 09:22:17 *Tunnelblick: Established communication with OpenVPN
2012-06-02 09:22:17 WARNING: file &#039;Mac.key&#039; is group or others accessible
2012-06-02 09:22:17 LZO compression initialized
2012-06-02 09:22:17 Control Channel MTU parms [ L:1574 D:138 EF:38 EB:0 ET:0 EL:0 ]
2012-06-02 09:22:17 Socket Buffers: R=[42080-&gt;65536] S=[9216-&gt;65536]
2012-06-02 09:22:17 MANAGEMENT: &gt;STATE:1338654137,RESOLVE,,,
2012-06-02 09:22:17 Data Channel MTU parms [ L:1574 D:1450 EF:42 EB:135 ET:32 EL:0 AF:3/1 ]
2012-06-02 09:22:17 Local Options hash (VER=V4): &#039;d79ca330&#039;
2012-06-02 09:22:17 Expected Remote Options hash (VER=V4): &#039;f7df56b8&#039;
2012-06-02 09:22:17 UDPv4 link local: [undef]
2012-06-02 09:22:17 UDPv4 link remote: xxx.xxx.xxx.xxx:1194
2012-06-02 09:22:17 MANAGEMENT: &gt;STATE:1338654137,WAIT,,,</code></pre></div><p>Just prior to posting this, I thought I&#039;d increase the verbosity on the client side and see if there was anything else in the log.&nbsp; The log below continues where the previous log ended above, and repeats:</p><div class="codebox"><pre><code>2012-06-02 09:55:35 us=397105 MANAGEMENT: &gt;STATE:1338656135,WAIT,,,
2012-06-02 09:55:35 us=397134 ACK reliable_can_send active=1 current=1 : [1] 0
2012-06-02 09:55:35 us=397152 ACK reliable_send ID 0 (size=4 to=2)
2012-06-02 09:55:35 us=397169 Reliable -&gt; TCP/UDP
2012-06-02 09:55:35 us=397188 ACK reliable_send_timeout 2 [1] 0
2012-06-02 09:55:35 us=397205 TLS: tls_process: timeout set to 2
2012-06-02 09:55:35 us=397240 TLS: tls_multi_process: i=1 state=S_INITIAL, mysid=ab059c8d 25e14e64, stored-sid=00000000 00000000, stored-ip=[undef]
2012-06-02 09:55:35 us=397268 TLS: tls_multi_process: i=2 state=S_UNDEF, mysid=00000000 00000000, stored-sid=00000000 00000000, stored-ip=[undef]
2012-06-02 09:55:35 us=397299 RANDOM USEC=124100
2012-06-02 09:55:35 us=397321 SE_RESET
2012-06-02 09:55:35 us=397342 SE_CTL rwflags=0x0003 ev=5 fast=1 cap=1024 maxfd=-1 arg=0x00202160
2012-06-02 09:55:35 us=397360 SE_CTL rwflags=0x0002 ev=4 fast=1 cap=1024 maxfd=5 arg=0x001f77d0
2012-06-02 09:55:35 us=397383 I/O WAIT T?|T?|SR|SW [1/124100]
2012-06-02 09:55:35 us=397402 SE_WAIT_FAST maxfd=5 tv=1/124100
2012-06-02 09:55:35 us=397430 SE_WAIT[4,0] rwflags=0x0002 arg=0x001f77d0
2012-06-02 09:55:35 us=397448 SE_WAIT[5,1] rwflags=0x0002 arg=0x00202160
2012-06-02 09:55:35 us=397465  event_wait returned 2
2012-06-02 09:55:35 us=397482 I/O WAIT status=0x0082
2012-06-02 09:55:35 us=397560 UDPv4 WRITE [14] to xxx.xxx.xxx.xxx:1194: P_CONTROL_HARD_RESET_CLIENT_V2 kid=0 sid=e4d8d757 10ceb891 [ ] pid=0 DATA 
2012-06-02 09:55:35 us=397687 UDPv4 write returned 14
2012-06-02 09:55:35 us=397727 TLS: tls_multi_process: i=0 state=S_PRE_START, mysid=e4d8d757 10ceb891, stored-sid=00000000 00000000, stored-ip=xxx.xxx.xxx.xxx:1194
2012-06-02 09:55:35 us=397748 TLS: tls_process: chg=0 ks=S_PRE_START lame=S_UNDEF to_link-&gt;len=0 wakeup=604800</code></pre></div><p>These are my settings in /etc/config/firewall:</p><div class="codebox"><pre><code>config &#039;rule&#039;                            
        option &#039;target&#039; &#039;ACCEPT&#039;        
        option &#039;_name&#039; &#039;VPN&#039;         
        option &#039;src&#039; &#039;wan&#039;                    
        option &#039;dest_port&#039; &#039;1194&#039;            
        option &#039;family&#039; &#039;ipv4&#039;                   
        option &#039;proto&#039; &#039;udp&#039;</code></pre></div><p>Server /etc/config/openvpn:</p><div class="codebox"><pre><code>config &#039;openvpn&#039; &#039;lan&#039;
        option &#039;enable&#039; &#039;1&#039;
        option &#039;port&#039; &#039;1194
        option &#039;proto&#039; &#039;udp&#039;
        option &#039;dev&#039; &#039;tap0&#039;

        option &#039;client_to_client&#039; &#039;1&#039;
        option &#039;keepalive&#039; &#039;10 120&#039;
        option &#039;comp_lzo&#039; &#039;1&#039;
        option &#039;persist_key&#039; &#039;1&#039;
        option &#039;persist_tun&#039; &#039;1&#039;
        option &#039;verb&#039; &#039;11&#039;
        option &#039;ifconfig_pool_persist&#039; &#039;/tmp/ipp.txt&#039;
        option &#039;log&#039; &#039;/tmp/openvpn-status.log&#039;
        option &#039;ca&#039; &#039;/etc/openvpn/ca.crt&#039;
        option &#039;cert&#039; &#039;/etc/openvpn/server.crt&#039;
        option &#039;key&#039; &#039;/etc/openvpn/server.key&#039;
        option &#039;dh&#039; &#039;/etc/openvpn/dh1024.pem&#039;

        option &#039;server_bridge&#039; &#039;10.1.1.1 255.255.255.0 10.1.1.151 10.1.1.200&#039;
        list &#039;push&#039; &#039;dhcp-option DNS 10.1.1.1&#039;</code></pre></div><p>Tunnelblick client configuration:</p><div class="codebox"><pre><code>##############################################
# Sample client-side OpenVPN 2.0 config file #
# for connecting to multi-client server.     #
#                                            #
# This configuration can be used by multiple #
# clients, however each client should have   #
# its own cert and key files.                #
#                                            #
# On Windows, you might want to rename this  #
# file so it has a .ovpn extension           #
##############################################

# Specify that we are a client and that we
# will be pulling certain config file directives
# from the server.
client

# Use the same setting as you are using on
# the server.
# On most systems, the VPN will not function
# unless you partially or fully disable
# the firewall for the TUN/TAP interface.
dev tap
;dev tun

# Windows needs the TAP-Win32 adapter name
# from the Network Connections panel
# if you have more than one.  On XP SP2,
# you may need to disable the firewall
# for the TAP adapter.
;dev-node MyTap

# Are we connecting to a TCP or
# UDP server?  Use the same setting as
# on the server.
;proto tcp
proto udp

# The hostname/IP and port of the server.
# You can have multiple remote entries
# to load balance between the servers.
remote xxx.xxx.xxx.xxx 1194
;remote my-server-2 1194

# Choose a random host from the remote
# list for load-balancing.  Otherwise
# try hosts in the order specified.
;remote-random

# Keep trying indefinitely to resolve the
# host name of the OpenVPN server.  Very useful
# on machines which are not permanently connected
# to the internet such as laptops.
resolv-retry infinite

# Most clients don&#039;t need to bind to
# a specific local port number.
nobind

# Downgrade privileges after initialization (non-Windows only)
;user nobody
;group nobody

# Try to preserve some state across restarts.
persist-key
persist-tun

# If you are connecting through an
# HTTP proxy to reach the actual OpenVPN
# server, put the proxy server/IP and
# port number here.  See the man page
# if your proxy server requires
# authentication.
;http-proxy-retry # retry on connection failures
;http-proxy [proxy server] [proxy port #]

# Wireless networks often produce a lot
# of duplicate packets.  Set this flag
# to silence duplicate packet warnings.
;mute-replay-warnings

# SSL/TLS parms.
# See the server config file for more
# description.  It&#039;s best to use
# a separate .crt/.key file pair
# for each client.  A single ca
# file can be used for all clients.
ca ca.crt
cert Mac.crt
key Mac.key

# Verify server certificate by checking
# that the certicate has the nsCertType
# field set to &quot;server&quot;.  This is an
# important precaution to protect against
# a potential attack discussed here:
#  http://openvpn.net/howto.html#mitm
#
# To use this feature, you will need to generate
# your server certificates with the nsCertType
# field set to &quot;server&quot;.  The build-key-server
# script in the easy-rsa folder will do this.
ns-cert-type server

# If a tls-auth key is used on the server
# then every client must also have the key.
;tls-auth ta.key 1

# Select a cryptographic cipher.
# If the cipher option is used on the server
# then you must also specify it here.
;cipher x

# Enable compression on the VPN link.
# Don&#039;t enable this unless it is also
# enabled in the server config file.
comp-lzo

# Set log file verbosity.
verb 3

# Silence repeating messages
;mute 20</code></pre></div><p>(I changed my IP address to xxx.xxx.xxx.xxx in everything above)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170910">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">rdibley</div>
					<div class="post-datetime">
						25 Jun 2012, 18:36					</div>
				</div>
				<div class="post-content content">
					<p>Wow. I can&#039;t believe I missed this. I forgot a single quote in the server&#039;s /etc/config/openvpn file. It was on the &#039;port&#039; option. So, it should read:</p><div class="codebox"><pre><code>config &#039;openvpn&#039; &#039;lan&#039;
        option &#039;enable&#039; &#039;1&#039;
        option &#039;port&#039; &#039;1194&#039;
        option &#039;proto&#039; &#039;udp&#039;
        option &#039;dev&#039; &#039;tap0&#039;

        option &#039;client_to_client&#039; &#039;1&#039;
        option &#039;keepalive&#039; &#039;10 120&#039;
        option &#039;comp_lzo&#039; &#039;1&#039;
        option &#039;persist_key&#039; &#039;1&#039;
        option &#039;persist_tun&#039; &#039;1&#039;
        option &#039;verb&#039; &#039;11&#039;
        option &#039;ifconfig_pool_persist&#039; &#039;/tmp/ipp.txt&#039;
        option &#039;log&#039; &#039;/tmp/openvpn-status.log&#039;
        option &#039;ca&#039; &#039;/etc/openvpn/ca.crt&#039;
        option &#039;cert&#039; &#039;/etc/openvpn/server.crt&#039;
        option &#039;key&#039; &#039;/etc/openvpn/server.key&#039;
        option &#039;dh&#039; &#039;/etc/openvpn/dh1024.pem&#039;

        option &#039;server_bridge&#039; &#039;10.1.1.1 255.255.255.0 10.1.1.151 10.1.1.200&#039;
        list &#039;push&#039; &#039;dhcp-option DNS 10.1.1.1&#039;</code></pre></div><p>I was trying to use a different port, and noticed (using netstat) that it kept going back to the default, which led me to finding the problem. I don&#039;t know how I didn&#039;t notice that before. <br />It now appears to be working.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>