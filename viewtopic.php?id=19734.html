<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Firewall settings for OpenVPN on Kamikaze 8.09 - no connection</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 11 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p85396">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">Netzfetz</div>
					<div class="post-datetime">
						8 Apr 2009, 20:20					</div>
				</div>
				<div class="post-content content">
					<p>Hi!</p><p>3 years of absence <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>After years of happily using all WhiteRussians up to version 0.9 on my 3 WRT54Gv2.2 I tried the new Kamikaze 8.09 with kernel 2.6.<br />So far I am very pleased with the new uci, stability and easy setup.<br />BUT: Setting up the firewall for OpenVPN is a mess! A least there is not a single howto for OpenVPN on Kamikaze 8.09 (counterexamples welcome!). Well, there are forum entries but they always bypass the new clean config structure and use crippled old config files and iptables directly.</p><p>What I want to achieve: the WRT54G should work as VPN server. The clients connect to it from the internet through the wan port (via a routed VPN tunnel) and should then be able to reach the public internet via the WRT54G. This is the most simple roadwarrior setup: clients anywhere in the world get a secured internet connection by using the home internet connection.</p><p>Enough text.</p><p>Here&#039;s what I did so far:</p><p>1. Installed openvpn and all dependencies. (Be aware: the most recent libopenssl_0.9.8i-3 produces a false error: &quot;not enough memory&quot;. You have to use the slightly older libopenssl_0.9.8i-1 from 8.09 RC2 instead which works perfectly.)</p><p>2. Created all keys and certificates and set up the config files for vpn-server and clients. This is fairly easy and clear due to the excellent docs for OpenVPN.<br />On the WRT54G I used the sample-server part of /etc/config/openvpn with mostly the default settings since I want to use a routed tunnel (the &quot;easier&quot; way...).</p><p>3. In /etc/config/network I added<br /></p><div class="codebox"><pre><code>#### VPN configuration
config interface    vpn
    option ifname    tun0
    option proto    none</code></pre></div><p>4. Set up openvpn to be started automatically with </p><div class="codebox"><pre><code>/etc/init.d/openvpn enable</code></pre></div><p>5. Now comes the difficult part: firewall.<br />I added the following to /etc/config/firewall:<br /></p><div class="codebox"><pre><code>config zone
    option name        vpn
    option input    ACCEPT
    option output    ACCEPT
    option forward    REJECT

config forwarding
    option src    lan
    option dest    vpn

config forwarding
    option src    vpn
    option dest    lan

config rule
    option name        vpn
    option dest        wan        #&#039;src wan&#039; isn&#039;t working either
    option dest_port    1234
    option proto    udp
    option target    ACCEPT</code></pre></div><p>What is wrong?<br />How can that most simple VPN-setup work?</p><p>Interesting notice: With WhiteRussian installed I could ping the router&#039;s IP (dynamically assigned by the ISP) from the internet by default.<br />With Kamikaze I can&#039;t. There is simply no response. I guess that might be the problem. What needs to be changed?</p><p>Thanks for any help!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85448">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Netzfetz</div>
					<div class="post-datetime">
						9 Apr 2009, 10:50					</div>
				</div>
				<div class="post-content content">
					<p>Hi.</p><p>Still no solution but I think I forgot to clarify the problem itself:<br />OpenVPN is runnig smoothly on client and server but the server&#039;s firewall doesn&#039;t let the client in to establish a VPN tunnel:<br />Client&#039;s attempts to connect stop with the message &quot;TLS Error: TLS key negotiation failed to occur within 60 seconds&quot;.</p><p>According to OpenVPN&#039;s HowTo the server&#039;s firewall still blocks the VPN port.<br />But WHY? I thought my &#039;config rule&#039; should be enough to open that udp port!?<br />What else is blocking?</p><p>Since in this case the VPN server is also the NAT gateway I don&#039;t need to set up a port forward rule (right??).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85490">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">Netzfetz</div>
					<div class="post-datetime">
						9 Apr 2009, 21:57					</div>
				</div>
				<div class="post-content content">
					<p>Once again a little bit of details:</p><p>For testing I activated inclusion of firewall.user in /etc/config/firewall and tried the following in firewall.user:<br /></p><div class="codebox"><pre><code>iptables -A INPUT -i tun+ -j ACCEPT
iptables -A FORWARD -i tun+ -j ACCEPT
iptables -t nat -A prerouting_rule -i $WAN -p udp --dport 1234 -j ACCEPT
iptables -A input_rule -i $WAN -p udp -j ACCEPT</code></pre></div><p>Changed nothing.<br />This:<br /></p><div class="codebox"><pre><code>iptables -I OUTPUT -o tun+ -j ACCEPT
iptables -I INPUT -i tun+ -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -I FORWARD -o tun+ -j ACCEPT
iptables -I FORWARD -i tun+ -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -t nat -I POSTROUTING -o tun+ -j MASQUERADE</code></pre></div><p>Didn&#039;t work either.</p><p>How the heck can I get the firewall accepting connections from outside (internet)??</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85593">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">buildster</div>
					<div class="post-datetime">
						11 Apr 2009, 02:01					</div>
				</div>
				<div class="post-content content">
					<p>The followings in /etc/config/firewall work for me.</p><div class="codebox"><pre><code>config zone
        option name             lan
        option network          &quot;lan vpn&quot;
        option input            ACCEPT
        option output           ACCEPT
        option forward          ACCEPT

# open a port for OpenVPN connections
config rule
        option  src             wan
        option  dest_port       1194
        option  target          ACCEPT
        option  proto           udp</code></pre></div><p>Hope they can be some help to you.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85652">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">Netzfetz</div>
					<div class="post-datetime">
						12 Apr 2009, 01:35					</div>
				</div>
				<div class="post-content content">
					<p>Thanx!<br />BTW: I realized that I forgot to set the $WAN variable in my first try of firewall.user - STUPID. So this works for me now:<br /></p><div class="codebox"><pre><code>WAN=$(uci get network.wan.ifname)

iptables -A INPUT -i tun+ -j ACCEPT
iptables -A FORWARD -i tun+ -j ACCEPT
iptables -t nat    -A prerouting_rule    -i $WAN -p udp --dport 1234    -j ACCEPT
iptables        -A input_rule        -i $WAN -p udp                    -j ACCEPT</code></pre></div><p>But I&#039;ll give your version a try since it is nicer to just use the config/firewall and not the old firewall.user.</p>											<p class="post-edited">(Last edited by <strong>Netzfetz</strong> on 12 Apr 2009, 01:41)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85653">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">Netzfetz</div>
					<div class="post-datetime">
						12 Apr 2009, 02:23					</div>
				</div>
				<div class="post-content content">
					<p>Hmm, buildster, your settings for zone &quot;lan&quot; don&#039;t work for me...<br />I have to stick to the firewall.user file.<br />Does anyone know how to translate these iptables back to the nicer uci options for config/firewall?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85655">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">buildster</div>
					<div class="post-datetime">
						12 Apr 2009, 03:59					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Netzfetz wrote:</cite><blockquote><p>Hmm, buildster, your settings for zone &quot;lan&quot; don&#039;t work for me...<br />I have to stick to the firewall.user file.<br />Does anyone know how to translate these iptables back to the nicer uci options for config/firewall?</p></blockquote></div><p>An assumption of my firewall settings for zone lan is that you still have the following defined in /etc/config/network, in addition to interface lan:</p><div class="codebox"><pre><code>#### VPN configuration
config interface    vpn
    option ifname   tun0
    option proto    none
    option auto     disable # perhaps, optional</code></pre></div><p>With those settings, no need to touch firewall.user.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85656">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">Netzfetz</div>
					<div class="post-datetime">
						12 Apr 2009, 04:27					</div>
				</div>
				<div class="post-content content">
					<p>Yep, I still have the vpn interface set in /etc/config/network. Exactly the same as you.<br />But I still do need the following line in firewall.user:<br /></p><div class="codebox"><pre><code>iptables -A input_rule -i $(uci get network.wan.ifname) -p udp --dport 1234 -j ACCEPT</code></pre></div><p>Otherwise OpenVPN can not establish a connection.</p><p>Somehow this must be set as an &quot;input_rule&quot;. The Chain &quot;zone_wan&quot; (as it is set by &#039;config rule&#039;) does not work for this.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85688">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">Netzfetz</div>
					<div class="post-datetime">
						12 Apr 2009, 19:37					</div>
				</div>
				<div class="post-content content">
					<p>The above line in /etc/firewall.user and the setting for the vpn interface in /etc/config/network are the ONLY two things that are necessary for a VPN connection to work. All the other settings do not change anything.</p><p>Does someone know how to write that iptables line in /etc/firewall.user in uci style?</p><p>Now I am stuck again: the vpn connection is up and running but from a client I can only ping the vpn server itself (10.8.0.1) and the router&#039;s lan IP (192.168.1.1). A client can not access the internet or another IP in the router&#039;s lan.<br />What&#039;s the best way to change that? Static routes (I want to avoid that)? Bridging of interfaces?</p><p>I already tried the push route and DNS stuff in vpn server config but that did not help.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85781">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">Netzfetz</div>
					<div class="post-datetime">
						13 Apr 2009, 23:52					</div>
				</div>
				<div class="post-content content">
					<p>Arrrgh: SPAM! But why in my thread only?? <img src="https://forum.openwrt.org/img/smilies/mad.png" width="15" height="15" alt="mad" /></p><p>BTW: I found a solution!<br />With the following code in /etc/firewall.user the whole OpenVPN setup finally works as desired:<br /></p><div class="codebox"><pre><code>WAN=$(uci get network.wan.ifname)
VPN=$(uci get network.vpn.ifname)

iptables -A input_rule  -i $WAN -p udp --dport 1234     -j ACCEPT
iptables -I     INPUT   -i $VPN                         -j ACCEPT
iptables -I     FORWARD -i $VPN                         -j ACCEPT
iptables -I     OUTPUT  -o $VPN                         -j ACCEPT
iptables -I     FORWARD -o $VPN                         -j ACCEPT</code></pre></div><p>Any idea how to put that in /etc/config/firewall to get rid of /etc/firewall.user?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p85842">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">zorxd</div>
					<div class="post-datetime">
						14 Apr 2009, 18:20					</div>
				</div>
				<div class="post-content content">
					<p>I have this :</p><div class="codebox"><pre><code>config &#039;zone&#039;
        option &#039;name&#039; &#039;vpn&#039;
        option &#039;input&#039; &#039;ACCEPT&#039;
        option &#039;output&#039; &#039;ACCEPT&#039;
        option &#039;forward&#039; &#039;ACCEPT&#039;
        option &#039;network&#039; &#039;vpn&#039;


config &#039;forwarding&#039;
        option &#039;src&#039; &#039;lan&#039;
        option &#039;dest&#039; &#039;vpn&#039;
        option &#039;forward&#039; &#039;ACCEPT&#039;</code></pre></div><p>and my vpn works fine</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p88016">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">therealcmj</div>
					<div class="post-datetime">
						15 May 2009, 01:59					</div>
				</div>
				<div class="post-content content">
					<p>After quite a bit of head pounding I have the same sort of configuration working.</p><p>/etc/config/network:<br /></p><div class="codebox"><pre><code>config &#039;interface&#039; &#039;vpn&#039;
        option &#039;ifname&#039; &#039;tun0&#039;
        option &#039;proto&#039; &#039;none&#039;
        option &#039;auto&#039; &#039;disable&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;</code></pre></div><p>/etc/config/firewall:<br /></p><div class="codebox"><pre><code>config &#039;rule&#039;
        option &#039;_name&#039; &#039;OpenVPN&#039;
        option &#039;src&#039; &#039;wan&#039;
        option &#039;target&#039; &#039;ACCEPT&#039;
        option &#039;proto&#039; &#039;udp&#039;
        option &#039;dest_port&#039; &#039;1194&#039;

config &#039;zone&#039;
        option &#039;name&#039; &#039;vpn&#039;
        option &#039;input&#039; &#039;ACCEPT&#039;
        option &#039;output&#039; &#039;ACCEPT&#039;
        option &#039;forward&#039; &#039;ACCEPT&#039;
        option &#039;network&#039; &#039;vpn&#039;

config &#039;forwarding&#039;
        option &#039;src&#039; &#039;lan&#039;
        option &#039;dest&#039; &#039;vpn&#039;
        option &#039;forward&#039; &#039;ACCEPT&#039;

config &#039;forwarding&#039;
        option &#039;src&#039; &#039;vpn&#039;
        option &#039;dest&#039; &#039;lan&#039;</code></pre></div><p>My next question is whether I need to have more than one tun interface when I have more than one client. At the moment I have a single VPN client, but very shortly I&#039;ll have more than one. Under Kamikaze 7.0 I had an iptables rule like the one Netzfetz showed above which applied to input interface tun+.</p><p>On a separate note, the GUI won&#039;t allow you to specify source/destination ports when configuring firewall rules. Any known workaround to that?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p91869">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">kennedy101</div>
					<div class="post-datetime">
						25 Jul 2009, 22:10					</div>
				</div>
				<div class="post-content content">
					<p>@12</p><p>Much head banging here too trying to get the firewall to pass traffic from VPN road warrior to internal LAN. Thanks for the firewall and network rules. Worked like a champ!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p92990">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">johnf</div>
					<div class="post-datetime">
						21 Aug 2009, 05:09					</div>
				</div>
				<div class="post-content content">
					<p>Great thread, thought I&#039;d add one or two things.</p><p>If you have more than one vpn client connecting in, you can specify tun+ instead of tun0, which will match all tun interfaces, not just the first to connect to tun0.</p><p>This is what I have in /etc/config/network:</p><div class="codebox"><pre><code>config &#039;interface&#039; &#039;vpn&#039;
        option &#039;ifname&#039; &#039;tun+&#039;
        option &#039;proto&#039; &#039;none&#039;</code></pre></div><p>As far as I can tell, nothing else is necessary in the network config, at least with 8.09.1.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94210">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">Dogge</div>
					<div class="post-datetime">
						13 Sep 2009, 16:10					</div>
				</div>
				<div class="post-content content">
					<p>Can&#039;t get this to work with a stock 8.09.1 (brcm47xx) for a WL500GPv1 downloaded from downloads.openwrt.org.</p><p>This is what I did after flashing 8.09.1:</p><div class="codebox"><pre><code>root@OpenWrt:~# passwd
root@OpenWrt:~# opkg update; opkg install openvpn ntpclient</code></pre></div><div class="codebox"><pre><code>root@OpenWrt:~# mkdir -p /etc/openvpn</code></pre></div><div class="codebox"><pre><code>me@box$ scp static.key root@192.168.1.1:/etc/openvpn/static.key</code></pre></div><div class="codebox"><pre><code>root@OpenWrt:~# /etc/init.d/openvpn enable
root@OpenWrt:~# reboot</code></pre></div><p>My network, firewall and openvpn UCI configuration files:<br /></p><div class="codebox"><pre><code>package &#039;network&#039;

config &#039;switch&#039; &#039;eth0&#039;
        option &#039;vlan0&#039; &#039;1 2 3 4 5*&#039;
        option &#039;vlan1&#039; &#039;0 5&#039;

config &#039;interface&#039; &#039;loopback&#039;
        option &#039;ifname&#039; &#039;lo&#039;
        option &#039;proto&#039; &#039;static&#039;
        option &#039;ipaddr&#039; &#039;127.0.0.1&#039;
        option &#039;netmask&#039; &#039;255.0.0.0&#039;

config &#039;interface&#039; &#039;lan&#039;
        option &#039;type&#039; &#039;bridge&#039;
        option &#039;ifname&#039; &#039;eth0.0&#039;
        option &#039;proto&#039; &#039;static&#039;
        option &#039;netmask&#039; &#039;255.255.255.0&#039;
        option &#039;ipaddr&#039; &#039;192.168.1.1&#039;

config &#039;interface&#039; &#039;wan&#039;
        option &#039;ifname&#039; &#039;eth0.1&#039;
        option &#039;proto&#039; &#039;dhcp&#039;

config &#039;interface&#039; &#039;vpn&#039;
        option &#039;proto&#039; &#039;none&#039;
        option &#039;ifname&#039; &#039;tun+&#039;</code></pre></div><div class="codebox"><pre><code>package &#039;firewall&#039;

config &#039;defaults&#039;
        option &#039;syn_flood&#039; &#039;1&#039;
        option &#039;input&#039; &#039;ACCEPT&#039;
        option &#039;output&#039; &#039;ACCEPT&#039;
        option &#039;forward&#039; &#039;REJECT&#039;

config &#039;zone&#039;
        option &#039;name&#039; &#039;lan&#039;
        option &#039;input&#039; &#039;ACCEPT&#039;
        option &#039;output&#039; &#039;ACCEPT&#039;
        option &#039;forward&#039; &#039;REJECT&#039;

config &#039;zone&#039;
        option &#039;name&#039; &#039;wan&#039;
        option &#039;input&#039; &#039;REJECT&#039;
        option &#039;output&#039; &#039;ACCEPT&#039;
        option &#039;forward&#039; &#039;REJECT&#039;
        option &#039;masq&#039; &#039;1&#039;

config &#039;forwarding&#039;
        option &#039;src&#039; &#039;lan&#039;
        option &#039;dest&#039; &#039;wan&#039;
        option &#039;mtu_fix&#039; &#039;1&#039;

config &#039;include&#039;
        option &#039;path&#039; &#039;/etc/firewall.user&#039;

config &#039;zone&#039;
        option &#039;name&#039; &#039;vpn&#039;
        option &#039;input&#039; &#039;ACCEPT&#039;
        option &#039;forward&#039; &#039;ACCEPT&#039;
        option &#039;output&#039; &#039;ACCEPT&#039;
        option &#039;network&#039; &#039;vpn&#039;

config &#039;forwarding&#039;
        option &#039;src&#039; &#039;lan&#039;
        option &#039;dest&#039; &#039;vpn&#039;

config &#039;forwarding&#039;
        option &#039;src&#039; &#039;vpn&#039;
        option &#039;dest&#039; &#039;lan&#039;</code></pre></div><div class="codebox"><pre><code>package &#039;openvpn&#039;

config &#039;openvpn&#039; &#039;custom_config&#039;
        option &#039;enable&#039; &#039;0&#039;
        option &#039;config&#039; &#039;/etc/openvpn/my-vpn.conf&#039;

config &#039;openvpn&#039; &#039;sample_server&#039;
        option &#039;enable&#039; &#039;0&#039;
        option &#039;port&#039; &#039;1194&#039;
        option &#039;proto&#039; &#039;udp&#039;
        option &#039;dev&#039; &#039;tun&#039;
        option &#039;ca&#039; &#039;ca.crt&#039;
        option &#039;cert&#039; &#039;server.crt&#039;
        option &#039;key&#039; &#039;server.key&#039;
        option &#039;dh&#039; &#039;dh1024.pem&#039;
        option &#039;server&#039; &#039;10.8.0.0 255.255.255.0&#039;
        option &#039;ifconfig_pool_persist&#039; &#039;ipp.txt&#039;
        option &#039;keepalive&#039; &#039;10 120&#039;
        option &#039;comp_lzo&#039; &#039;1&#039;
        option &#039;persist_key&#039; &#039;1&#039;
        option &#039;persist_tun&#039; &#039;1&#039;
        option &#039;status&#039; &#039;openvpn-status.log&#039;
        option &#039;verb&#039; &#039;3&#039;

config &#039;openvpn&#039; &#039;sample_client&#039;
        option &#039;enable&#039; &#039;0&#039;
        option &#039;client&#039; &#039;1&#039;
        option &#039;dev&#039; &#039;tun&#039;
        option &#039;proto&#039; &#039;udp&#039;
        list &#039;remote&#039; &#039;my_server_1 1194&#039;
        option &#039;resolv_retry&#039; &#039;infinite&#039;
        option &#039;nobind&#039; &#039;1&#039;
        option &#039;persist_key&#039; &#039;1&#039;
        option &#039;persist_tun&#039; &#039;1&#039;
        option &#039;ca&#039; &#039;ca.crt&#039;
        option &#039;cert&#039; &#039;client.crt&#039;
        option &#039;key&#039; &#039;client.key&#039;
        option &#039;comp_lzo&#039; &#039;1&#039;
        option &#039;verb&#039; &#039;3&#039;

config &#039;openvpn&#039; &#039;server_routed_ptp&#039;
        option &#039;dev&#039; &#039;tun&#039;
        option &#039;proto&#039; &#039;udp&#039;
        option &#039;port&#039; &#039;1194&#039;
        option &#039;ifconfig&#039; &#039;10.0.0.1 10.0.0.2&#039;
        option &#039;mssfix&#039; &#039;1420&#039;
        option &#039;keepalive&#039; &#039;10 60&#039;
        option &#039;verb&#039; &#039;3&#039;
        option &#039;comp_lzo&#039; &#039;1&#039;
        option &#039;secret&#039; &#039;/etc/openvpn/static.key&#039;
        option &#039;enable&#039; &#039;1&#039;</code></pre></div><p>But no tun interface in the iptables rules <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><div class="codebox"><pre><code>root@OpenWrt:~# ( iptables -nvL; iptables -t nat -nvL )           
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID 
   47  5255 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED 
    1    68 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0           
    3   172 syn_flood  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp flags:0x17/0x02 
    3   172 input_rule  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    3   172 input      all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain FORWARD (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID 
    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED 
    0     0 forwarding_rule  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 forward    all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 reject     all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID 
   43  6147 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED 
    1    68 ACCEPT     all  --  *      lo      0.0.0.0/0            0.0.0.0/0           
    3   212 output_rule  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    3   212 output     all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain forward (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 zone_lan_forward  all  --  br-lan *       0.0.0.0/0            0.0.0.0/0           

Chain forwarding_lan (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain forwarding_rule (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain forwarding_vpn (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain forwarding_wan (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain input (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    3   172 zone_lan   all  --  br-lan *       0.0.0.0/0            0.0.0.0/0           

Chain input_lan (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain input_rule (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain input_vpn (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain input_wan (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain output (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    3   212 zone_lan_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_wan_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_vpn_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain output_rule (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain reject (3 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 REJECT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           reject-with tcp-reset 
    0     0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           reject-with icmp-port-unreachable 

Chain syn_flood (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    3   172 RETURN     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp flags:0x17/0x02 limit: avg 25/sec burst 50 
    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain zone_lan (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    3   172 input_lan  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    3   172 zone_lan_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain zone_lan_ACCEPT (3 references)
 pkts bytes target     prot opt in     out     source               destination         
    3   172 ACCEPT     all  --  br-lan *       0.0.0.0/0            0.0.0.0/0           
    3   212 ACCEPT     all  --  *      br-lan  0.0.0.0/0            0.0.0.0/0           

Chain zone_lan_DROP (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DROP       all  --  br-lan *       0.0.0.0/0            0.0.0.0/0           
    0     0 DROP       all  --  *      br-lan  0.0.0.0/0            0.0.0.0/0           

Chain zone_lan_MSSFIX (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 TCPMSS     tcp  --  *      br-lan  0.0.0.0/0            0.0.0.0/0           tcp flags:0x06/0x02 TCPMSS clamp to PMTU 

Chain zone_lan_REJECT (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 reject     all  --  br-lan *       0.0.0.0/0            0.0.0.0/0           
    0     0 reject     all  --  *      br-lan  0.0.0.0/0            0.0.0.0/0           

Chain zone_lan_forward (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 zone_vpn_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_wan_MSSFIX  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_wan_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 forwarding_lan  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_lan_REJECT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain zone_vpn (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 input_vpn  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_vpn_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain zone_vpn_ACCEPT (4 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_vpn_DROP (0 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_vpn_MSSFIX (0 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_vpn_REJECT (0 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_vpn_forward (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 zone_lan_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 forwarding_vpn  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_vpn_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain zone_wan (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 input_wan  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_wan_REJECT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain zone_wan_ACCEPT (2 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_wan_DROP (0 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_wan_MSSFIX (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_wan_REJECT (2 references)
 pkts bytes target     prot opt in     out     source               destination         

root@OpenWrt:~# ( iptables -nvL; iptables -t nat -nvL )           
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID 
  189 15623 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED 
    1    68 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0           
   22  1312 syn_flood  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp flags:0x17/0x02 
   31  2468 input_rule  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
   31  2468 input      all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain FORWARD (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID 
    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED 
    0     0 forwarding_rule  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 forward    all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 reject     all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID 
  190 33143 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED 
    1    68 ACCEPT     all  --  *      lo      0.0.0.0/0            0.0.0.0/0           
    3   212 output_rule  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    3   212 output     all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain forward (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 zone_lan_forward  all  --  br-lan *       0.0.0.0/0            0.0.0.0/0           

Chain forwarding_lan (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain forwarding_rule (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain forwarding_vpn (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain forwarding_wan (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain input (1 references)
 pkts bytes target     prot opt in     out     source               destination         
   31  2468 zone_lan   all  --  br-lan *       0.0.0.0/0            0.0.0.0/0           

Chain input_lan (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain input_rule (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain input_vpn (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain input_wan (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain output (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    3   212 zone_lan_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_wan_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_vpn_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain output_rule (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain reject (3 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 REJECT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           reject-with tcp-reset 
    0     0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           reject-with icmp-port-unreachable 

Chain syn_flood (1 references)
 pkts bytes target     prot opt in     out     source               destination         
   22  1312 RETURN     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp flags:0x17/0x02 limit: avg 25/sec burst 50 
    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain zone_lan (1 references)
 pkts bytes target     prot opt in     out     source               destination         
   31  2468 input_lan  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
   31  2468 zone_lan_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain zone_lan_ACCEPT (3 references)
 pkts bytes target     prot opt in     out     source               destination         
   31  2468 ACCEPT     all  --  br-lan *       0.0.0.0/0            0.0.0.0/0           
    3   212 ACCEPT     all  --  *      br-lan  0.0.0.0/0            0.0.0.0/0           

Chain zone_lan_DROP (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DROP       all  --  br-lan *       0.0.0.0/0            0.0.0.0/0           
    0     0 DROP       all  --  *      br-lan  0.0.0.0/0            0.0.0.0/0           

Chain zone_lan_MSSFIX (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 TCPMSS     tcp  --  *      br-lan  0.0.0.0/0            0.0.0.0/0           tcp flags:0x06/0x02 TCPMSS clamp to PMTU 

Chain zone_lan_REJECT (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 reject     all  --  br-lan *       0.0.0.0/0            0.0.0.0/0           
    0     0 reject     all  --  *      br-lan  0.0.0.0/0            0.0.0.0/0           

Chain zone_lan_forward (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 zone_vpn_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_wan_MSSFIX  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_wan_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 forwarding_lan  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_lan_REJECT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain zone_vpn (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 input_vpn  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_vpn_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain zone_vpn_ACCEPT (4 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_vpn_DROP (0 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_vpn_MSSFIX (0 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_vpn_REJECT (0 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_vpn_forward (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 zone_lan_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 forwarding_vpn  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_vpn_ACCEPT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain zone_wan (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 input_wan  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_wan_REJECT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain zone_wan_ACCEPT (2 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_wan_DROP (0 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_wan_MSSFIX (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_wan_REJECT (2 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_wan_forward (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 forwarding_wan  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 zone_wan_REJECT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
Chain PREROUTING (policy ACCEPT 72 packets, 11505 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   72 11505 zone_lan_prerouting  all  --  br-lan *       0.0.0.0/0            0.0.0.0/0           
   72 11505 prerouting_rule  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain POSTROUTING (policy ACCEPT 4 packets, 280 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    4   280 postrouting_rule  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    4   280 zone_wan_nat  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain OUTPUT (policy ACCEPT 5 packets, 348 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain postrouting_rule (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain prerouting_lan (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain prerouting_rule (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain prerouting_vpn (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain prerouting_wan (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_lan_nat (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MASQUERADE  all  --  *      br-lan  0.0.0.0/0            0.0.0.0/0           

Chain zone_lan_prerouting (1 references)
 pkts bytes target     prot opt in     out     source               destination         
   72 11505 prerouting_lan  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain zone_vpn_nat (0 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_vpn_prerouting (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 prerouting_vpn  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain zone_wan_nat (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain zone_wan_prerouting (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 prerouting_wan  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
root@OpenWrt:~#</code></pre></div><p>What I&#039;m doing wrong? I&#039;d like to make the full config working with using UCI.</p>											<p class="post-edited">(Last edited by <strong>Dogge</strong> on 13 Sep 2009, 16:37)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p94213">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">Dogge</div>
					<div class="post-datetime">
						13 Sep 2009, 17:54					</div>
				</div>
				<div class="post-content content">
					<p>Stupid me. Forgot a <strong>&#039;ifup vpn&#039;</strong>. Then everything is fine.</p><p>Almost fine. The VPN connection isn&#039;t brought up on boot. There was an attempt (<a href="https://dev.openwrt.org/changeset/17544">https://dev.openwrt.org/changeset/17544</a>) to fix this, but it was not the right way.</p><p>To bring up the VPN connection on boot, use the OpenVPN up/down parameters.</p><div class="codebox"><pre><code>root@OpenWrt:~# uci set openvpn.server_routed_ptp.up=&#039;&quot;/sbin/ifup vpn&quot;&#039;
root@OpenWrt:~# uci set openvpn.server_routed_ptp.down=&#039;&quot;/sbin/ifdown vpn&quot;&#039;
root@OpenWrt:~# uci commit openvpn
root@OpenWrt:~# reboot</code></pre></div><p>This is just a workaround. Finally ifup/ifdown and adding/deleting firewall rules/zones should be managed via hotplug.</p><p>If you are using trunk you also have to add the openvpn.server_routed_ptp.script_security option. This is because trunk uses a newer version of OpenVPN.<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# uci set openvpn.server_routed_ptp.script_security=2
root@OpenWrt:~# uci commit openvpn
root@OpenWrt:~# /etc/init.d/openvpn restart</code></pre></div>											<p class="post-edited">(Last edited by <strong>Dogge</strong> on 13 Sep 2009, 20:20)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>