<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> New package: mwan2; testers wanted.</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 31 Mar 2018 and 27 Apr 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 8 of 14</div><nav><ul><li><a href="viewtopic.php%3Fid=33129&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=33129&amp;p=6.html">6</a></li><li><a href="viewtopic.php%3Fid=33129&amp;p=7.html">7</a></li><li class="pagination-current"><span>8</span></li><li><a href="viewtopic.php%3Fid=33129&amp;p=9.html">9</a></li><li><a href="viewtopic.php%3Fid=33129&amp;p=10.html">10</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=33129&amp;p=14.html">14</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p170179">
				<div class="post-metadata">
					<div class="post-num">Post #176</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						17 Jun 2012, 15:47					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>crisman wrote:</cite><blockquote><p>is it supposed to work with 2 wans having the same gateway address?</p></blockquote></div><p>No</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170180">
				<div class="post-metadata">
					<div class="post-num">Post #177</div>
					<div class="post-author">crisman</div>
					<div class="post-datetime">
						17 Jun 2012, 15:55					</div>
				</div>
				<div class="post-content content">
					<p>ok, any plan to add that feature? is it a limitation in openwrt? thanks</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170181">
				<div class="post-metadata">
					<div class="post-num">Post #178</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						17 Jun 2012, 16:02					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;d like to get that feature in, but you&#039;ll have to help me with that. Can you show me your routing table and your network config when both your wan connections are up (before installing mwan2)?</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 17 Jun 2012, 16:02)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170223">
				<div class="post-metadata">
					<div class="post-num">Post #179</div>
					<div class="post-author">alan614</div>
					<div class="post-datetime">
						18 Jun 2012, 06:21					</div>
				</div>
				<div class="post-content content">
					<p>Thank you Adze! This script actually works. I&#039;ve never been able to get my buffalo wzr-hp-ag300h to work with multiwan (though that may be a function of my limited network administration knowledge), but here load balancing is actually happening. Thank you, keep up the good work!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170306">
				<div class="post-metadata">
					<div class="post-num">Post #180</div>
					<div class="post-author">padams</div>
					<div class="post-datetime">
						18 Jun 2012, 21:26					</div>
				</div>
				<div class="post-content content">
					<p>alan614 - any config you could share on the wzr-hp-ag300h would be welcome.</p><p>I can get dual wan ports setup with static IP&#039;s, but when I install the mwan2 package and configure, nothing sems to happen.&nbsp; Point a client out to the Internet via the router and I cannot reach any websites.</p><p>Turn off mwan2 and which ever WAN connection I set the lower routing matrix number on is used and works fine.</p><p>I don&#039;t seem to be able to understand what the issue is...</p><br /><p>Also - do you have QoS working alongside the mwan2 package?&nbsp; That is what I am hoping to achieve.</p><br /><p>Regards</p><p>Paul Adams</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170307">
				<div class="post-metadata">
					<div class="post-num">Post #181</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						18 Jun 2012, 21:31					</div>
				</div>
				<div class="post-content content">
					<p>Hi padams,</p><br /><p>Maybe i can help... could you post me your firewall network and mwan2 config? And maybe could you also post the outcome of &quot;ip rule list&quot;, &quot;route -n&quot;, &quot;iptables -L -t mangle -v -n&quot; and &quot;ip route list table 3&quot;?</p><br /><p>Thanks.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170315">
				<div class="post-metadata">
					<div class="post-num">Post #182</div>
					<div class="post-author">padams</div>
					<div class="post-datetime">
						18 Jun 2012, 22:57					</div>
				</div>
				<div class="post-content content">
					<p>Thank you.</p><br /><p>Firewall</p><p>config defaults<br />&nbsp; &nbsp; option input &#039;DROP&#039;<br />&nbsp; &nbsp; option forward &#039;REJECT&#039;<br />&nbsp; &nbsp; option output &#039;ACCEPT&#039;<br />&nbsp; &nbsp; option syn_flood &#039;1&#039;<br />&nbsp; &nbsp; option drop_invalid &#039;1&#039;</p><p>config zone<br />&nbsp; &nbsp; option name &#039;local&#039;<br />&nbsp; &nbsp; option network &#039;lan&#039;<br />&nbsp; &nbsp; option input &#039;ACCEPT&#039;<br />&nbsp; &nbsp; option forward &#039;REJECT&#039;<br />&nbsp; &nbsp; option output &#039;ACCEPT&#039;</p><p>config zone<br />&nbsp; &nbsp; option name &#039;internet&#039;<br />&nbsp; &nbsp; option network &#039;wan wan2&#039;<br />&nbsp; &nbsp; option input &#039;DROP&#039;<br />&nbsp; &nbsp; option forward &#039;DROP&#039;<br />&nbsp; &nbsp; option output &#039;ACCEPT&#039;<br />&nbsp; &nbsp; option masq &#039;1&#039;</p><p>config forwarding<br />&nbsp; &nbsp; option src &#039;local&#039;<br />&nbsp; &nbsp; option dest &#039;internet&#039;</p><p>config include<br />&nbsp; &nbsp; &nbsp; &nbsp; option path &#039;/etc/firewall.user&#039;</p><br /><br /><p>Network<br />config interface &#039;loopback&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;lo&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr &#039;127.0.0.1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;255.0.0.0&#039;</p><p>config interface &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;eth0.1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option type &#039;bridge&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option _orig_ifname &#039;eth0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option _orig_bridge &#039;true&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dns &#039;10.10.10.38&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr &#039;10.10.10.38&#039;</p><p>config interface &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;eth1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option _orig_ifname &#039;eth1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option _orig_bridge &#039;false&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr &#039;96.53.67.50&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option gateway &#039;96.53.67.49&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dns &#039;64.59.144.18 64.59.144.19&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;255.255.255.252&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option apn &#039;internet&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option defaultroute &#039;0&#039;</p><p>config switch<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;eth0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option reset &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option enable_vlan &#039;1&#039;</p><p>config switch_vlan<br />&nbsp; &nbsp; &nbsp; &nbsp; option device &#039;eth0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option vlan &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ports &#039;0t 2 3 4&#039;</p><p>config switch_vlan<br />&nbsp; &nbsp; &nbsp; &nbsp; option device &#039;eth0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option vlan &#039;2&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ports &#039;0t 1&#039;</p><p>config interface &#039;wan2&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ifname &#039;eth0.2&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option _orig_ifname &#039;eth0.2&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option _orig_bridge &#039;false&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option ipaddr &#039;204.244.82.18&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option gateway &#039;204.244.82.17&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dns &#039;204.244.3.130 204.244.3.129&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;255.255.255.248&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option apn &#039;internet&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option defaultroute &#039;0&#039;</p><p>config route<br />&nbsp; &nbsp; &nbsp; &nbsp; option interface &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;0.0.0.0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;0.0.0.0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option metric &#039;10&#039;</p><p>config route<br />&nbsp; &nbsp; &nbsp; &nbsp; option interface &#039;wan2&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;0.0.0.0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option netmask &#039;0.0.0.0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option metric &#039;20&#039;</p><br /><p>mwan2</p><p>config &#039;interface&#039; &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;enabled&#039; &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;metric&#039; &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;weight&#039; &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;track_ip&#039; &#039;mail.pchtg.ca&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;count&#039; &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;timeout&#039; &#039;2&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;interval&#039; &#039;5&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;down&#039; &#039;3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;up&#039; &#039;8&#039;</p><p>config &#039;interface&#039; &#039;wan2&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;enabled&#039; &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;metric&#039; &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;weight&#039; &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;track_ip&#039; &#039;mail.pchtg.ca&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;count&#039; &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;timeout&#039; &#039;2&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;interval&#039; &#039;5&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;down&#039; &#039;3&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;up&#039; &#039;8&#039;</p><p>config &#039;rule&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;src_ip&#039; &#039;10.10.10.0/24&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; #option &#039;proto&#039; &#039;tcp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; #option &#039;dest_port&#039; &#039;995&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;equalize&#039; &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list &#039;use_interface&#039; &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list &#039;use_interface&#039; &#039;wan2&#039;</p><p>config &#039;rule&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;dest_ip&#039; &#039;0.0.0.0/0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; #option &#039;equalize&#039; &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list &#039;use_interface&#039; &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list &#039;use_interface&#039; &#039;wan2&#039;</p><br /><br /><br /><p>IP rule list:<br />root@TestRouter:~# ip rule list<br />0:&nbsp; &nbsp; &nbsp; from all lookup local<br />192:&nbsp; &nbsp; from 96.53.67.50 fwmark 0x0/0x8000 lookup 1<br />256:&nbsp; &nbsp; from all fwmark 0x100/0xff00 lookup 1<br />258:&nbsp; &nbsp; from all fwmark 0x300/0xff00 lookup 3<br />32766:&nbsp; from all lookup main<br />32767:&nbsp; from all lookup default</p><br /><p>route -n<br />root@TestRouter:~# route -n<br />Kernel IP routing table<br />Destination&nbsp; &nbsp; &nbsp;Gateway&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Genmask&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Flags Metric Ref&nbsp; &nbsp; Use Iface<br />0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;10&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth1<br />0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;20&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth0.2<br />10.10.10.0&nbsp; &nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 br-lan<br />96.53.67.48&nbsp; &nbsp; &nbsp;0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.252 U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth1<br />204.244.82.16&nbsp; &nbsp;0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.248 U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth0.2</p><br /><br /><p>iptables -L -t mangle -v -n<br />root@TestRouter:~# iptables -L -t mangle -v -n<br />Chain PREROUTING (policy ACCEPT 3859 packets, 367K bytes)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination<br /> 5092&nbsp; 481K mwan2_pre&nbsp; all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0</p><p>Chain INPUT (policy ACCEPT 3832 packets, 363K bytes)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination</p><p>Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination</p><p>Chain OUTPUT (policy ACCEPT 5157 packets, 2076K bytes)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination<br /> 6871 3056K mwan2_pre&nbsp; all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0</p><p>Chain POSTROUTING (policy ACCEPT 5157 packets, 2076K bytes)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination<br /> 6870 3056K mwan2_post&nbsp; all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0</p><p>Chain mwan2_default (1 references)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination<br />&nbsp; &nbsp;93 16848 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 224.0.0.0/3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mark match !0x8000/0x8000 MARK or 0x8000<br /> 6942 2963K MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 10.10.10.0/24&nbsp; &nbsp; &nbsp; &nbsp;mark match !0x8000/0x8000 MARK or 0x8000<br /> 2336&nbsp; 214K MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 96.53.67.48/30&nbsp; &nbsp; &nbsp; mark match !0x8000/0x8000 MARK or 0x8000<br />&nbsp; &nbsp; 8&nbsp; &nbsp;732 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 204.244.82.16/29&nbsp; &nbsp; mark match !0x8000/0x8000 MARK or 0x8000</p><p>Chain mwan2_post (1 references)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination<br /> 1168 74456 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; eth1&nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mark match !0x8000/0x8000 MARK xset 0x100/0xff00<br /> 5255 2953K MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mark match 0x8000/0x8000 MARK and 0xffff7fff<br /> 6870 3056K CONNMARK&nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CONNMARK save mask 0xff00</p><p>Chain mwan2_pre (2 references)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination<br />11963 3537K CONNMARK&nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CONNMARK restore mask 0xff00<br />&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; eth1&nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK xset 0x8100/0xff00<br />&nbsp; &nbsp; 4&nbsp; &nbsp;240 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; eth0.2 *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK xset 0x8200/0xff00<br />11959 3537K mwan2_default&nbsp; all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mark match !0x8000/0x8000<br /> 1651&nbsp; 105K mwan2_rules&nbsp; all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mark match 0x0/0xff00</p><p>Chain mwan2_rules (1 references)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination<br />&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;10.10.10.0/24&nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mark match 0x0/0xff00 MARK xset 0x300/0xff00<br /> 1275 81300 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mark match 0x0/0xff00 MARK xset 0x300/0xff00</p><br /><br /><p>ip route list table 3<br />root@TestRouter:~# ip route list table 3<br />default dev eth1&nbsp; metric 1</p><br /><p>Thank you in advance for your help.</p><p>Regards</p><p>Paul Adams</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170316">
				<div class="post-metadata">
					<div class="post-num">Post #183</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						18 Jun 2012, 23:10					</div>
				</div>
				<div class="post-content content">
					<p>Please try the following network config:</p><div class="codebox"><pre><code>config interface &#039;loopback&#039;
        option ifname &#039;lo&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;127.0.0.1&#039;
        option netmask &#039;255.0.0.0&#039;

config interface &#039;lan&#039;
        option ifname &#039;eth0.1&#039;
        option type &#039;bridge&#039;
        option proto &#039;static&#039;
        option netmask &#039;255.255.255.0&#039;
        option _orig_ifname &#039;eth0&#039;
        option _orig_bridge &#039;true&#039;
        #option dns &#039;10.10.10.38&#039; &lt;- This does not mean advertise this as dns server on lan, but overrides dns settings for lookups.
        option ipaddr &#039;10.10.10.38&#039;

config interface &#039;wan&#039;
        option ifname &#039;eth1&#039;
        option _orig_ifname &#039;eth1&#039;
        option _orig_bridge &#039;false&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;96.53.67.50&#039;
        option gateway &#039;96.53.67.49&#039;
        option dns &#039;64.59.144.18 64.59.144.19&#039;
        option netmask &#039;255.255.255.252&#039;
        #option apn &#039;internet&#039;
        option metric &#039;10&#039;
        #option defaultroute &#039;0&#039;

config switch
        option name &#039;eth0&#039;
        option reset &#039;1&#039;
        option enable_vlan &#039;1&#039;

config switch_vlan
        option device &#039;eth0&#039;
        option vlan &#039;1&#039;
        option ports &#039;0t 2 3 4&#039;

config switch_vlan
        option device &#039;eth0&#039;
        option vlan &#039;2&#039;
        option ports &#039;0t 1&#039;

config interface &#039;wan2&#039;
        option ifname &#039;eth0.2&#039;
        option _orig_ifname &#039;eth0.2&#039;
        option _orig_bridge &#039;false&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;204.244.82.18&#039;
        option gateway &#039;204.244.82.17&#039;
        option dns &#039;204.244.3.130 204.244.3.129&#039;
        option netmask &#039;255.255.255.248&#039;
        #option apn &#039;internet&#039;
        option metric &#039;20&#039;
        #option defaultroute &#039;0&#039;</code></pre></div><p>Also try to comment out the track_ip option in the mwan2 config at first or use an ip address to prevent lookup problems.<br />Then reboot, wait a moment for all interfaces to settle, and then post the outcome of &quot;iptables -L -t mangle -v -n&quot; and &quot;ip route list table 3&quot; again please.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 18 Jun 2012, 23:21)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170321">
				<div class="post-metadata">
					<div class="post-num">Post #184</div>
					<div class="post-author">padams</div>
					<div class="post-datetime">
						19 Jun 2012, 00:17					</div>
				</div>
				<div class="post-content content">
					<p>Thanks - I got confused looking at examples.</p><p>OK - changes made, track IP set to thier gateways for each interface, rebooted.</p><br /><p>Here&#039;s the resutls of the 2 commands below...</p><br /><p>root@TestRouter:~# iptables -L -t mangle -v -n<br />Chain PREROUTING (policy ACCEPT 960 packets, 97064 bytes)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination<br /> 1064&nbsp; 112K mwan2_pre&nbsp; all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0</p><p>Chain INPUT (policy ACCEPT 949 packets, 88110 bytes)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination</p><p>Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination</p><p>Chain OUTPUT (policy ACCEPT 1284 packets, 991K bytes)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination<br /> 1394 1024K mwan2_pre&nbsp; all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0</p><p>Chain POSTROUTING (policy ACCEPT 1284 packets, 991K bytes)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination<br /> 1393 1024K mwan2_post&nbsp; all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0</p><p>Chain mwan2_default (1 references)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination<br />&nbsp; &nbsp;21 11050 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 224.0.0.0/3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mark match !0x8000/0x8000 MARK or 0x8000<br /> 2057 1061K MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 10.10.10.0/24&nbsp; &nbsp; &nbsp; &nbsp;mark match !0x8000/0x8000 MARK or 0x8000<br />&nbsp; &nbsp;72&nbsp; 7488 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 96.53.67.48/30&nbsp; &nbsp; &nbsp; mark match !0x8000/0x8000 MARK or 0x8000<br />&nbsp; &nbsp;29&nbsp; 2436 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 204.244.82.16/29&nbsp; &nbsp; mark match !0x8000/0x8000 MARK or 0x8000</p><p>Chain mwan2_post (1 references)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination<br />&nbsp; &nbsp;36&nbsp; 2736 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; eth1&nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mark match !0x8000/0x8000 MARK xset 0x100/0xff00<br />&nbsp; &nbsp;20&nbsp; 1491 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; eth0.2&nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mark match !0x8000/0x8000 MARK xset 0x200/0xff00<br /> 1304 1015K MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mark match 0x8000/0x8000 MARK and 0xffff7fff<br /> 1393 1024K CONNMARK&nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CONNMARK save mask 0xff00</p><p>Chain mwan2_pre (2 references)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination<br /> 2458 1137K CONNMARK&nbsp; &nbsp;all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CONNMARK restore mask 0xff00<br />&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; eth1&nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK xset 0x8100/0xff00<br />&nbsp; &nbsp;46&nbsp; 6570 MARK&nbsp; &nbsp; &nbsp; &nbsp;all&nbsp; --&nbsp; eth0.2 *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MARK xset 0x8200/0xff00<br /> 2412 1130K mwan2_default&nbsp; all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mark match !0x8000/0x8000<br />&nbsp; &nbsp;73&nbsp; 5267 mwan2_rules&nbsp; all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mark match 0x0/0xff00</p><p>Chain mwan2_rules (1 references)<br /> pkts bytes target&nbsp; &nbsp; &nbsp;prot opt in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination</p><br /><br /><br /><p>root@TestRouter:~# ip route list table 3<br />default&nbsp; metric 1<br />&nbsp; &nbsp; &nbsp; &nbsp; nexthop via 96.53.67.49&nbsp; dev eth1 weight 1<br />&nbsp; &nbsp; &nbsp; &nbsp; nexthop via 204.244.82.17&nbsp; dev eth0.2 weight 1</p><br /><br /><p>The &quot;wan&quot; connection is currently unplugged as that IP is in use on the live network, but the wan2 interface is connected and correct.&nbsp; I assume this should not matter because in the even of the &#039;wan&#039; interface failing, &#039;wan2&#039; should get all the traffic anyway.</p><br /><p>Thanks again</p><p>Paul Adams</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170323">
				<div class="post-metadata">
					<div class="post-num">Post #185</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						19 Jun 2012, 00:25					</div>
				</div>
				<div class="post-content content">
					<p>Looks alot better <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" />. You are only missing a default rule (but this could be from not completely C/P the output). Make sure you have at least one mwan2 rule configured.</p><p>And indeed, all traffic should pass wan2 in the event that wan fails.</p><p>Does it work OK now ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170324">
				<div class="post-metadata">
					<div class="post-num">Post #186</div>
					<div class="post-author">padams</div>
					<div class="post-datetime">
						19 Jun 2012, 00:36					</div>
				</div>
				<div class="post-content content">
					<p>No.&nbsp; Use the ping tool from luci - all pings fail.&nbsp; Use the router as a default gateway out for a client - cannot get to google.</p><br /><p>BUT - change the metric&#039;s around (wan now = 20 and wan2 now = 10), reboot, works fine.</p><p>Change it back, does not work.</p><br /><p>It&#039;s as if mwan2 is not running at all - like OpenWRT is not using it???</p><p>Paul</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170325">
				<div class="post-metadata">
					<div class="post-num">Post #187</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						19 Jun 2012, 00:44					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>padams wrote:</cite><blockquote><p>It&#039;s as if mwan2 is not running at all - like OpenWRT is not using it???</p></blockquote></div><p>Maybe you are right. Could you please check if mark value is set &quot;cat /proc/net/nf_conntrack&quot;:</p><div class="codebox"><pre><code>root@mars:~# cat /proc/net/nf_conntrack
ipv4     2 icmp     1 22 src=82.170.123.114 dst=8.8.8.8 type=8 code=0 id=5249 packets=1 bytes=84 src=8.8.8.8 dst=82.170.123.114 type=0 code=0 id=5249 packets=1 bytes=84 mark=256 use=2
ipv4     2 tcp      6 22 TIME_WAIT src=192.168.33.9 dst=2.22.233.34 sport=55447 dport=80 packets=4 bytes=220 src=2.22.233.34 dst=82.170.123.114 sport=80 dport=55447 packets=2 bytes=112 [ASSURED] mark=256 use=2
ipv4     2 icmp     1 17 src=192.168.33.2 dst=8.8.4.4 type=8 code=0 id=9445 packets=1 bytes=84 src=8.8.4.4 dst=82.170.123.114 type=0 code=0 id=9445 packets=1 bytes=84 mark=256 use=2
ipv4     2 tcp      6 82 TIME_WAIT src=192.168.33.9 dst=87.233.15.240 sport=55440 dport=80 packets=12 bytes=2485 src=87.233.15.240 dst=82.170.123.114 sport=80 dport=55440 packets=8 bytes=1352 [ASSURED] mark=256 use=2
ipv6     10 udp      17 33 src=fe80:0000:0000:0000:4a5d:60ff:fee3:624b dst=2001:0610:064d:0001:0000:0000:0000:0003 sport=31466 dport=53 packets=1 bytes=71 [UNREPLIED] src=2001:0610:064d:0001:0000:0000:0000:0003 dst=fe80:0000:0000:0000:4a5d:60ff:fee3:624b sport=53 dport=31466 packets=0 bytes=0 mark=0 use=2
ipv4     2 tcp      6 53 CLOSE_WAIT src=192.168.33.9 dst=188.40.166.25 sport=55498 dport=80 packets=7 bytes=1866 src=188.40.166.25 dst=82.170.123.114 sport=80 dport=55498 packets=5 bytes=584 [ASSURED] mark=256 use=2
ipv4     2 icmp     1 7 src=82.170.123.114 dst=8.8.8.8 type=8 code=0 id=5236 packets=1 bytes=84 src=8.8.8.8 dst=82.170.123.114 type=0 code=0 id=5236 packets=1 bytes=84 mark=256 use=2
ipv4     2 tcp      6 53 CLOSE_WAIT src=192.168.33.9 dst=188.40.166.25 sport=55496 dport=80 packets=11 bytes=3532 src=188.40.166.25 dst=82.170.123.114 sport=80 dport=55496 packets=8 bytes=1188 [ASSURED] mark=256 use=2
ipv4     2 icmp     1 13 src=192.168.34.3 dst=8.8.4.4 type=8 code=0 id=5242 packets=1 bytes=84 src=8.8.4.4 dst=192.168.34.3 type=0 code=0 id=5242 packets=1 bytes=84 mark=512 use=2
ipv4     2 tcp      6 102 TIME_WAIT src=192.168.33.9 dst=188.64.64.61 sport=55527 dport=80 packets=14 bytes=2091 src=188.64.64.61 dst=82.170.123.114 sport=80 dport=55527 packets=16 bytes=15865 [ASSURED] mark=256 use=2
ipv4     2 tcp      6 3487 ESTABLISHED src=192.168.33.9 dst=216.137.59.174 sport=55455 dport=80 packets=4 bytes=712 src=216.137.59.174 dst=82.170.123.114 sport=80 dport=55455 packets=3 bytes=526 [ASSURED] mark=256 use=2
ipv4     2 tcp      6 52 TIME_WAIT src=192.168.33.9 dst=213.239.154.20 sport=55483 dport=80 packets=20 bytes=1791 src=213.239.154.20 dst=82.170.123.114 sport=80 dport=55483 packets=18 bytes=19127 [ASSURED] mark=256 use=2</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170326">
				<div class="post-metadata">
					<div class="post-num">Post #188</div>
					<div class="post-author">padams</div>
					<div class="post-datetime">
						19 Jun 2012, 00:49					</div>
				</div>
				<div class="post-content content">
					<p>Hmmm - I see a lot of mark = 0&nbsp; in my output...</p><p>Paul</p><br /><br /><p>root@TestRouter:~# cat /proc/net/nf_conntrack<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 43 src=10.10.10.12 dst=10.10.10.255 sport=137 dport=137 packets=6 bytes=468 [UNREPLIED] src=10.10.10.255 dst=10.10.10.12 sport=137 dport=137 packets=0 bytes=0 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 icmp&nbsp; &nbsp; &nbsp;1 29 src=204.244.82.18 dst=204.244.82.17 type=8 code=0 id=3838 packets=1 bytes=84 src=204.244.82.17 dst=204.244.82.18 type=0 code=0 id=3838 packets=1 bytes=84 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 3 src=204.244.82.18 dst=66.254.57.165 sport=57154 dport=123 packets=1 bytes=76 src=66.254.57.165 dst=204.244.82.18 sport=123 dport=57154 packets=1 bytes=76 mark=512 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 icmp&nbsp; &nbsp; &nbsp;1 14 src=204.244.82.18 dst=204.244.82.17 type=8 code=0 id=3819 packets=1 bytes=84 src=204.244.82.17 dst=204.244.82.18 type=0 code=0 id=3819 packets=1 bytes=84 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 50 src=10.10.10.128 dst=10.10.10.255 sport=137 dport=137 packets=9 bytes=702 [UNREPLIED] src=10.10.10.255 dst=10.10.10.128 sport=137 dport=137 packets=0 bytes=0 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 tcp&nbsp; &nbsp; &nbsp; 6 3599 ESTABLISHED src=10.10.10.59 dst=10.10.10.38 sport=50417 dport=22 packets=32 bytes=3176 src=10.10.10.38 dst=10.10.10.59 sport=22 dport=50417 packets=33 bytes=10262 [ASSURED] mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 15 src=10.10.10.163 dst=10.10.10.255 sport=138 dport=138 packets=1 bytes=229 [UNREPLIED] src=10.10.10.255 dst=10.10.10.163 sport=138 dport=138 packets=0 bytes=0 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 59 src=10.10.10.125 dst=10.10.10.255 sport=137 dport=137 packets=3 bytes=234 [UNREPLIED] src=10.10.10.255 dst=10.10.10.125 sport=137 dport=137 packets=0 bytes=0 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 39 src=204.244.82.18 dst=208.83.212.8 sport=47322 dport=123 packets=1 bytes=76 src=208.83.212.8 dst=204.244.82.18 sport=123 dport=47322 packets=1 bytes=76 mark=512 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 58 src=10.10.10.125 dst=255.255.255.255 sport=68 dport=67 packets=1 bytes=328 [UNREPLIED] src=255.255.255.255 dst=10.10.10.125 sport=67 dport=68 packets=0 bytes=0 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 38 src=10.10.10.9 dst=10.10.10.255 sport=137 dport=137 packets=1 bytes=78 [UNREPLIED] src=10.10.10.255 dst=10.10.10.9 sport=137 dport=137 packets=0 bytes=0 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 55 src=10.10.10.153 dst=10.10.10.255 sport=138 dport=138 packets=1 bytes=229 [UNREPLIED] src=10.10.10.255 dst=10.10.10.153 sport=138 dport=138 packets=0 bytes=0 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 5 src=204.244.82.18 dst=67.212.74.220 sport=48608 dport=123 packets=1 bytes=76 src=67.212.74.220 dst=204.244.82.18 sport=123 dport=48608 packets=1 bytes=76 mark=512 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 icmp&nbsp; &nbsp; &nbsp;1 24 src=204.244.82.18 dst=204.244.82.17 type=8 code=0 id=3833 packets=1 bytes=84 src=204.244.82.17 dst=204.244.82.18 type=0 code=0 id=3833 packets=1 bytes=84 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 35 src=204.244.82.18 dst=66.254.57.165 sport=46849 dport=123 packets=1 bytes=76 src=66.254.57.165 dst=204.244.82.18 sport=123 dport=46849 packets=1 bytes=76 mark=512 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 32 src=204.244.82.18 dst=66.96.30.35 sport=40351 dport=123 packets=1 bytes=76 src=66.96.30.35 dst=204.244.82.18 sport=123 dport=40351 packets=1 bytes=76 mark=512 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 icmp&nbsp; &nbsp; &nbsp;1 9 src=204.244.82.18 dst=204.244.82.17 type=8 code=0 id=3815 packets=1 bytes=84 src=204.244.82.17 dst=204.244.82.18 type=0 code=0 id=3815 packets=1 bytes=84 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 19 src=10.10.10.132 dst=10.10.10.255 sport=138 dport=138 packets=1 bytes=229 [UNREPLIED] src=10.10.10.255 dst=10.10.10.132 sport=138 dport=138 packets=0 bytes=0 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 37 src=204.244.82.18 dst=67.212.74.220 sport=50853 dport=123 packets=1 bytes=76 src=67.212.74.220 dst=204.244.82.18 sport=123 dport=50853 packets=1 bytes=76 mark=512 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 52 src=10.10.10.30 dst=10.10.10.255 sport=42637 dport=3052 packets=36 bytes=18252 [UNREPLIED] src=10.10.10.255 dst=10.10.10.30 sport=3052 dport=42637 packets=0 bytes=0 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 50 src=10.10.10.152 dst=255.255.255.255 sport=68 dport=67 packets=1 bytes=341 [UNREPLIED] src=255.255.255.255 dst=10.10.10.152 sport=67 dport=68 packets=0 bytes=0 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 7 src=204.244.82.18 dst=208.83.212.8 sport=33059 dport=123 packets=1 bytes=76 src=208.83.212.8 dst=204.244.82.18 sport=123 dport=33059 packets=1 bytes=76 mark=512 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 tcp&nbsp; &nbsp; &nbsp; 6 3544 ESTABLISHED src=10.10.10.59 dst=78.24.191.177 sport=50410 dport=443 packets=11 bytes=1478 src=78.24.191.177 dst=204.244.82.18 sport=443 dport=50410 packets=15 bytes=15515 [ASSURED] mark=512 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 35 src=10.10.10.156 dst=10.10.10.255 sport=138 dport=138 packets=1 bytes=229 [UNREPLIED] src=10.10.10.255 dst=10.10.10.156 sport=138 dport=138 packets=0 bytes=0 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 47 src=10.10.10.21 dst=10.10.10.255 sport=138 dport=138 packets=1 bytes=229 [UNREPLIED] src=10.10.10.255 dst=10.10.10.21 sport=138 dport=138 packets=0 bytes=0 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 tcp&nbsp; &nbsp; &nbsp; 6 3540 ESTABLISHED src=10.10.10.59 dst=78.24.191.177 sport=50411 dport=443 packets=7 bytes=780 src=78.24.191.177 dst=204.244.82.18 sport=443 dport=50411 packets=7 bytes=5302 [ASSURED] mark=512 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 icmp&nbsp; &nbsp; &nbsp;1 19 src=204.244.82.18 dst=204.244.82.17 type=8 code=0 id=3824 packets=1 bytes=84 src=204.244.82.17 dst=204.244.82.18 type=0 code=0 id=3824 packets=1 bytes=84 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 icmp&nbsp; &nbsp; &nbsp;1 4 src=204.244.82.18 dst=204.244.82.17 type=8 code=0 id=3811 packets=1 bytes=84 src=204.244.82.17 dst=204.244.82.18 type=0 code=0 id=3811 packets=1 bytes=84 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 unknown&nbsp; 2 495 src=10.10.10.3 dst=224.0.0.1 packets=14 bytes=448 [UNREPLIED] src=224.0.0.1 dst=10.10.10.3 packets=0 bytes=0 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 0 src=10.10.10.135 dst=10.10.10.255 sport=137 dport=137 packets=3 bytes=234 [UNREPLIED] src=10.10.10.255 dst=10.10.10.135 sport=137 dport=137 packets=0 bytes=0 mark=0 use=2<br />ipv4&nbsp; &nbsp; &nbsp;2 udp&nbsp; &nbsp; &nbsp; 17 53 src=10.10.10.128 dst=10.10.10.255 sport=138 dport=138 packets=4 bytes=817 [UNREPLIED] src=10.10.10.255 dst=10.10.10.128 sport=138 dport=138 packets=0 bytes=0 mark=0 use=2</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170327">
				<div class="post-metadata">
					<div class="post-num">Post #189</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						19 Jun 2012, 00:57					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>padams wrote:</cite><blockquote><p>Hmmm - I see a lot of mark = 0&nbsp; in my output...</p></blockquote></div><p>Output looks OK!... What strikes me is the output of &quot;ip route list table 3&quot; you posted earlier:</p><div class="quotebox"><cite>padams wrote:</cite><blockquote><p>root@TestRouter:~# ip route list table 3<br />default&nbsp; metric 1<br />&nbsp; &nbsp; &nbsp; &nbsp; nexthop via 96.53.67.49&nbsp; dev eth1 weight 1<br />&nbsp; &nbsp; &nbsp; &nbsp; nexthop via 204.244.82.17&nbsp; dev eth0.2 weight 1</p></blockquote></div><p>This indicates that both links are alive.. Which is not the case. The track function should bring it down if it is not reachable...</p><p>You can manually trigger hotplug to bring interfaces up or down by:<br /></p><div class="codebox"><pre><code>ACTION=ifup DEVICE=eth1 INTERFACE=wan /sbin/hotplug-call iface
ACTION=ifdown DEVICE=eth0.2 INTERFACE=wan2 /sbin/hotplug-call iface</code></pre></div>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 19 Jun 2012, 01:05)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170329">
				<div class="post-metadata">
					<div class="post-num">Post #190</div>
					<div class="post-author">padams</div>
					<div class="post-datetime">
						19 Jun 2012, 01:16					</div>
				</div>
				<div class="post-content content">
					<p>Yes - I agree, the &#039;WAN&#039; link should be shutting down.</p><p>Tried the command - gave an error, so I tried just /sbin/hotplug-call eth1</p><p>And the system log shows:</p><p>Jun 18 15:16:58 TestRouter user.notice ifup: Enabling Router Solicitations on wan (eth1)<br />Jun 18 15:16:58 TestRouter user.notice root: mwan2: Adding rules for interface wan (eth1)<br />Jun 18 15:16:59 TestRouter user.info firewall: removing wan (eth1) from zone internet<br />Jun 18 15:16:59 TestRouter user.info firewall: adding wan (eth1) to zone internet</p><p>Jun 18 15:17:17 TestRouter user.notice ifup: Enabling Router Solicitations on wan (eth1)<br />Jun 18 15:17:17 TestRouter user.notice root: mwan2: Adding rules for interface wan (eth1)<br />Jun 18 15:17:18 TestRouter user.info firewall: removing wan (eth1) from zone internet<br />Jun 18 15:17:18 TestRouter user.info firewall: adding wan (eth1) to zone internet</p><p>Jun 18 15:18:08 TestRouter user.notice ifup: Enabling Router Solicitations on wan (eth1)<br />Jun 18 15:18:08 TestRouter user.notice root: mwan2: Adding rules for interface wan (eth1)<br />Jun 18 15:18:09 TestRouter user.info firewall: removing wan (eth1) from zone internet<br />Jun 18 15:18:09 TestRouter user.info firewall: adding wan (eth1) to zone internet</p><br /><p>Regards</p><p>Paul</p>											<p class="post-edited">(Last edited by <strong>padams</strong> on 19 Jun 2012, 01:27)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170331">
				<div class="post-metadata">
					<div class="post-num">Post #191</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						19 Jun 2012, 01:26					</div>
				</div>
				<div class="post-content content">
					<p>Will get back to you...</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 19 Jun 2012, 01:31)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170332">
				<div class="post-metadata">
					<div class="post-num">Post #192</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						19 Jun 2012, 01:39					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>padams wrote:</cite><blockquote><p>Tried the command - gave an error</p></blockquote></div><p>This is probably where it goes wrong, because mwan2 relies on this command to work... What kind of error?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170350">
				<div class="post-metadata">
					<div class="post-num">Post #193</div>
					<div class="post-author">alan614</div>
					<div class="post-datetime">
						19 Jun 2012, 07:29					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>padams wrote:</cite><blockquote><p>alan614 - any config you could share on the wzr-hp-ag300h would be welcome.</p><p>I can get dual wan ports setup with static IP&#039;s, but when I install the mwan2 package and configure, nothing sems to happen.&nbsp; Point a client out to the Internet via the router and I cannot reach any websites.</p><p>Turn off mwan2 and which ever WAN connection I set the lower routing matrix number on is used and works fine.</p><p>I don&#039;t seem to be able to understand what the issue is...</p><br /><p>Also - do you have QoS working alongside the mwan2 package?&nbsp; That is what I am hoping to achieve.</p><br /><p>Regards</p><p>Paul Adams</p></blockquote></div><p>I&#039;m on attitude adjustment r32130<br /></p><div class="codebox"><pre><code>config interface &#039;loopback&#039;
    option ifname &#039;lo&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;127.0.0.1&#039;
    option netmask &#039;255.0.0.0&#039;

config interface &#039;lan&#039;
    option ifname &#039;eth0.1&#039;
    option type &#039;bridge&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;192.168.1.1&#039;
    option netmask &#039;255.255.255.0&#039;

config interface &#039;wan&#039;
    option ifname &#039;eth1&#039;
    option proto &#039;dhcp&#039;
    option peerdns &#039;0&#039;
    option dns &#039;8.8.8.8 8.8.4.4&#039;
    option metric &#039;10&#039;

config switch
    option name &#039;eth0&#039;
    option reset &#039;1&#039;
    option enable_vlan &#039;1&#039;

config switch_vlan
    option device &#039;eth0&#039;
    option vlan &#039;1&#039;
    option ports &#039;0t 2 3 4&#039;

config switch_vlan
    option device &#039;eth0&#039;
    option vlan &#039;2&#039;
    option ports &#039;0t 1&#039;

config interface &#039;wan2&#039;
    option ifname &#039;eth0.2&#039;
    option proto &#039;dhcp&#039;
    option peerdns &#039;0&#039;
    option dns &#039;8.8.8.8 8.8.4.4&#039;
    option metric &#039;20&#039;
    option macaddr &#039;4C:E6:76:C2:65:15&#039;</code></pre></div><p>Made the 4th LAN port the wan port. I&#039;m not sure if giving the wan2 interface a unique mac address was necessary but it seemed harmless enough. Both of my broadband connections (ADSL and Cable) are DHCP so the wan interfaces are basic enough. The interfaces need to be brought down and back up or you can reboot your router though I don&#039;t think it is necessary.</p><p>As for QoS, I&#039;m still observing that. If my torrents maxes out both connections, web surfing suffers even if the port and service for bittorrent is set to low priority while port 80 is given normal. But I&#039;m only using Luci for the qos, lowering the Download speed of my wan2(as it&#039;s more inconsistent) seems to sometimes help.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170352">
				<div class="post-metadata">
					<div class="post-num">Post #194</div>
					<div class="post-author">alan614</div>
					<div class="post-datetime">
						19 Jun 2012, 07:35					</div>
				</div>
				<div class="post-content content">
					<p>my mwan2 config for padams<br /></p><div class="codebox"><pre><code>config &#039;interface&#039; &#039;wan&#039;
    option &#039;enabled&#039; &#039;1&#039;
    option &#039;metric&#039; &#039;1&#039;
    option &#039;weight&#039; &#039;1&#039;
    option &#039;track_ip&#039; &#039;8.8.8.8&#039;
    option &#039;count&#039; &#039;1&#039;
    option &#039;timeout&#039; &#039;2&#039;
    option &#039;interval&#039; &#039;5&#039;
    option &#039;down&#039; &#039;3&#039;
    option &#039;up&#039; &#039;8&#039;

config &#039;interface&#039; &#039;wan2&#039;
    option &#039;enabled&#039; &#039;1&#039;
    option &#039;metric&#039; &#039;1&#039;
    option &#039;weight&#039; &#039;1&#039;
    option &#039;track_ip&#039; &#039;8.8.8.8&#039;
    option &#039;count&#039; &#039;1&#039;
    option &#039;timeout&#039; &#039;2&#039;
    option &#039;interval&#039; &#039;5&#039;
    option &#039;down&#039; &#039;3&#039;
    option &#039;up&#039; &#039;8&#039;

config &#039;rule&#039;
    option &#039;dest_ip&#039; &#039;192.168.0.0/16&#039;
    list &#039;use_interface&#039; &#039;default&#039;

config &#039;rule&#039;
    option &#039;dest_port&#039; &#039;22&#039;
    list &#039;use_interface&#039; &#039;wan&#039;

config &#039;rule&#039;
    option &#039;dest_ip&#039; &#039;0.0.0.0/0&#039;
    option &#039;equalize&#039; &#039;1&#039;
    list &#039;use_interface&#039; &#039;wan&#039;
    list &#039;use_interface&#039; &#039;wan2&#039;
    #list &#039;use_interface&#039; &#039;wan3&#039;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170354">
				<div class="post-metadata">
					<div class="post-num">Post #195</div>
					<div class="post-author">alan614</div>
					<div class="post-datetime">
						19 Jun 2012, 07:48					</div>
				</div>
				<div class="post-content content">
					<p>Adze,</p><p>I don&#039;t know if this is helpful with regards to the qos, but here the output on my router<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# iptables -L mwan2_pre -t mangle -v
Chain mwan2_pre (2 references)
 pkts bytes target     prot opt in     out     source               destination         
  21M   12G CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK restore mask 0xff00 
2655K 3042M MARK       all  --  eth0.2 any     anywhere             anywhere            MARK xset 0x8200/0xff00 
6641K 5458M MARK       all  --  eth1   any     anywhere             anywhere            MARK xset 0x8100/0xff00 
  12M 3908M mwan2_default  all  --  any    any     anywhere             anywhere            mark match !0x8000/0x8000 
 360K   39M mwan2_rules  all  --  any    any     anywhere             anywhere            mark match 0x0/0xff00

root@OpenWrt:~# iptables -L mwan2_post -t mangle -v
Chain mwan2_post (1 references)
 pkts bytes target     prot opt in     out     source               destination         
1748K  573M MARK       all  --  any    eth1    anywhere             anywhere            mark match !0x8000/0x8000 MARK xset 0x100/0xff00 
2377K  311M MARK       all  --  any    eth0.2  anywhere             anywhere            mark match !0x8000/0x8000 MARK xset 0x200/0xff00 
2069K 2573M MARK       all  --  any    any     anywhere             anywhere            mark match 0x8000/0x8000 MARK and 0xffff7fff 
  12M 4673M CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK save mask 0xff00

root@OpenWrt:~# iptables -L mwan2_post -t mangle -v
Chain mwan2_post (1 references)
 pkts bytes target     prot opt in     out     source               destination         
1748K  573M MARK       all  --  any    eth1    anywhere             anywhere            mark match !0x8000/0x8000 MARK xset 0x100/0xff00 
2377K  311M MARK       all  --  any    eth0.2  anywhere             anywhere            mark match !0x8000/0x8000 MARK xset 0x200/0xff00 
2069K 2573M MARK       all  --  any    any     anywhere             anywhere            mark match 0x8000/0x8000 MARK and 0xffff7fff 
  12M 4673M CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK save mask 0xff00 

root@OpenWrt:~# iptables -L mwan2_rules -t mangle -v
Chain mwan2_rules (1 references)
 pkts bytes target     prot opt in     out     source               destination         
  109  5729 MARK       all  --  any    any     anywhere             192.168.0.0/16      mark match 0x0/0xff00 MARK xset 0x8000/0xff00 
50553 7117K MARK       all  --  any    any     anywhere             anywhere            mark match 0x0/0xff00 statistic mode random probability 0.500000 MARK xset 0x200/0xff00 
50148 7090K MARK       all  --  any    any     anywhere             anywhere            mark match 0x0/0xff00 statistic mode random probability 1.000000 MARK xset 0x100/0xff00

root@OpenWrt:~# iptables -L qos_Default -t mangle -v
Chain qos_Default (4 references)
 pkts bytes target     prot opt in     out     source               destination         
6205K 1442M CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK restore mask 0xff 
 850K   97M qos_Default_ct  all  --  any    any     anywhere             anywhere            mark match 0x0/0xff 
61912   61M MARK       all  --  any    any     anywhere             anywhere            mark match 0x1/0xff length 400:65535 MARK and 0xffffff00 
    0     0 MARK       all  --  any    any     anywhere             anywhere            mark match 0x2/0xff length 800:65535 MARK and 0xffffff00 
 3391 1044K MARK       udp  --  any    any     anywhere             anywhere            mark match 0x0/0xff length 0:500 MARK xset 0x2/0xff 
19906 3014K MARK       icmp --  any    any     anywhere             anywhere            MARK xset 0x1/0xff 
 671K   71M MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x0/0xff tcp spts:1024:65535 dpts:1024:65535 MARK xset 0x4/0xff 
59828   60M MARK       udp  --  any    any     anywhere             anywhere            mark match 0x0/0xff udp spts:1024:65535 dpts:1024:65535 MARK xset 0x4/0xff 
 4703  269K MARK       tcp  --  any    any     anywhere             anywhere            length 0:128 mark match !0x4/0xff tcp flags:FIN,SYN,RST,PSH,ACK,URG/SYN MARK xset 0x1/0xff 
67271 3261K MARK       tcp  --  any    any     anywhere             anywhere            length 0:128 mark match !0x4/0xff tcp flags:FIN,SYN,RST,PSH,ACK,URG/ACK MARK xset 0x1/0xff

root@OpenWrt:~# iptables -L qos_Default_ct -t mangle -v
Chain qos_Default_ct (1 references)
 pkts bytes target     prot opt in     out     source               destination         
 1284  131K MARK       all  --  any    any     anywhere             anywhere            mark match 0x0/0xff LAYER7 l7proto skypetoskype MARK xset 0x1/0xff 
    8   320 MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x0/0xff tcp multiport ports ssh,domain MARK xset 0x1/0xff 
 2030  137K MARK       udp  --  any    any     anywhere             anywhere            mark match 0x0/0xff udp multiport ports ssh,domain MARK xset 0x1/0xff 
 4831  269K MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x0/0xff tcp multiport ports ftp-data,ftp,smtp,www,pop3,https,imaps,pop3s MARK xset 0x3/0xff 
52736 2702K MARK       tcp  --  any    any     anywhere             anywhere            mark match 0x0/0xff tcp multiport ports 51413 MARK xset 0x4/0xff 
 101K   21M MARK       udp  --  any    any     anywhere             anywhere            mark match 0x0/0xff udp multiport ports 51413 MARK xset 0x4/0xff 
  186 23923 MARK       all  --  any    any     anywhere             anywhere            mark match 0x0/0xff LAYER7 l7proto bittorrent MARK xset 0x4/0xff 
 850K   97M CONNMARK   all  --  any    any     anywhere             anywhere            CONNMARK save mask 0xff</code></pre></div><p>Another thing, would be possible to direct traffic to a wan according to l7 service? For example, I would like to direct the skypetoskype l7 service to wan</p><p>Thanks</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170420">
				<div class="post-metadata">
					<div class="post-num">Post #196</div>
					<div class="post-author">padams</div>
					<div class="post-datetime">
						19 Jun 2012, 18:50					</div>
				</div>
				<div class="post-content content">
					<p>THANK YOU!</p><p>Copied your config - removed the MAC address line - adjusted for my static IP addresses - it works fine.</p><p>The only difference I can see is these two lines in network...</p><p>option _orig_ifname &#039;eth1&#039;<br />option _orig_bridge &#039;false&#039;</p><br /><p>I might try putting them back one by one to see which one is causing the issue - but it is working fine now.</p><p>Boots with both interfaces, shuts down wan (eth1) as it should, wan2 (eth0.2) continues without issues.&nbsp; Client surf the internet just fine.</p><p>:-)</p><br /><p>Regards</p><p>Paul Adams</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170440">
				<div class="post-metadata">
					<div class="post-num">Post #197</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						19 Jun 2012, 21:57					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>padams wrote:</cite><blockquote><p>Boots with both interfaces, shuts down wan (eth1) as it should, wan2 (eth0.2) continues without issues.&nbsp; Client surf the internet just fine.</p></blockquote></div><p>Nice&nbsp; &nbsp;<img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170441">
				<div class="post-metadata">
					<div class="post-num">Post #198</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						19 Jun 2012, 22:00					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>alan614 wrote:</cite><blockquote><p>Another thing, would be possible to direct traffic to a wan according to l7 service? For example, I would like to direct the skypetoskype l7 service to wan.</p></blockquote></div><p>That should not be very hard to realize. I&#039;ll try to update mwan2 with this feature..</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170536">
				<div class="post-metadata">
					<div class="post-num">Post #199</div>
					<div class="post-author">padams</div>
					<div class="post-datetime">
						20 Jun 2012, 21:48					</div>
				</div>
				<div class="post-content content">
					<p>Hello - me again...</p><p>Adze - I see from other posts you started mwan2 because you could not get OpenVPN to working correctly with dual wan.&nbsp; Maybe you could give me some advice on OpenVPN / mwan2 / routing.</p><p>I&#039;m using TUN connections, site-to-site.&nbsp; I can set mwan2 to respect that certain ports goto certain wan links - so that takes care of establishing the actual tunnels (this works OK - tunnels established).</p><br /><p>I&#039;m using route add -net commands in the openvpn setup on the server to add routes to the client networks.&nbsp; When both tunnels to one remote network are up, routing stops.&nbsp; I assume this is because both metrics are 0.</p><p>How do I correctly setup OpenVPN so that it uses one tunnel per destination OR weights routing correctly?&nbsp; Ideally - I&#039;d like to preference on tunnel over another.&nbsp; For example - use the wan baed TUN links normally, but in the event of a wann failure, use the wan2 based TUN links.</p><p>I&#039;d like to hear how you run your OpenVPN link with mwan2.</p><br /><p>I hope the explination makes sense.</p><p>regards</p><p>Paul Adams</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p170540">
				<div class="post-metadata">
					<div class="post-num">Post #200</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						20 Jun 2012, 22:10					</div>
				</div>
				<div class="post-content content">
					<p>Hi Paul,</p><br /><p>I&#039;m not sure if i understand you correctly, but i assume you want to create a site-to-site vpn with two load-balanced tunnels. I didn&#039;t try this myself, but i did manage to get a redundant site-to-site vpn using one tunnel at a time.</p><p>To correctly connect to remote sites you need two things: Create a route for that subnet to the tunnel interface (DON&#039;T use a default route) and add a network rule in mwan2 config for that site-subnet to use the default routing table (list &#039;use_interface&#039; &#039;default&#039;). Be sure to trigger mwan2 after making changes in the mwan2 config.</p><p>Redundancy is created by the fact that if one wan interface is down, openvpn will try to re-establish the tunnel from the other wan. So for active-backup scenario, you don&#039;t have to create two openvpn tunnels.</p><p>If you want to give load-balancing on two vpn tunnels a try, i&#039;d be happy to help. Please PM me as it is an experiment for me also...</p><br /><p>Thanks.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 20 Jun 2012, 22:24)</p>
									</div>
			</article>

			
		
						<div class="notice">
				<p>Sorry, posts 201 to 200 are missing from our archive.</p>
			</div>
		
		
	
	<div class="pagination"><div class="pagination-number">Page 8 of 14</div><nav><ul><li><a href="viewtopic.php%3Fid=33129&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=33129&amp;p=6.html">6</a></li><li><a href="viewtopic.php%3Fid=33129&amp;p=7.html">7</a></li><li class="pagination-current"><span>8</span></li><li><a href="viewtopic.php%3Fid=33129&amp;p=9.html">9</a></li><li><a href="viewtopic.php%3Fid=33129&amp;p=10.html">10</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=33129&amp;p=14.html">14</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0.001 -->

</body>
</html>