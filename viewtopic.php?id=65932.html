<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Question - Force DNS Traffic on IPV4 only</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 2 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p330225">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">perseus</div>
					<div class="post-datetime">
						30 Jun 2016, 23:01					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>I have OpenWRT Bleeding Edge r49296 on Linksys EA3500 (Marvell Kirkwood). The configuration is perfect otherwise Really loving the material Theme BTW. I use a PPPOE connection for my ISP.</p><p>I wish to use OpenDNS in order to block certain websites on my home network, as my version of Parental Controls. I did configure that part fine and I see my traffic on my OpenDNS dashboard. However, they do not support enhanced features on IPV6. So brings me to my question. </p><p>Is it possible to force DNS traffic to go out over IPv4 instead of IPv6? that way I can still use IPV6 on Lan side. If that&#039;s not an option, How does one disable IPv6 connectivity in OpenWRT?</p><p>Be kind and provide the luci steps rather than SSH steps. I know the SSH way is preferred. But Putty and Windows are giving me a separate problem with VPN and I&#039;d prefer not to use it, unless its the last resort.</p><p>Kindly let me know. Thanks for the time invested.<br />Edit - Did see&nbsp; <a href="https://forum.openwrt.org/viewtopic.php?id=47953">how to disable / turn off ipv6 support in bb</a><br />and found out to be not that useful.</p>											<p class="post-edited">(Last edited by <strong>perseus</strong> on 30 Jun 2016, 23:05)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p330326">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">cvmiller</div>
					<div class="post-datetime">
						2 Jul 2016, 07:06					</div>
				</div>
				<div class="post-content content">
					<p>I am not a big fan of turning off IPv6. IPv6 is the future of the internet.&nbsp; It sounds like you need to bug OpenDNS for feature parity on IPv6 for a longterm solution.</p><p>In the short term, you could block DNS requests over IPv6 at the firewall, but that won&#039;t stop OpenDNS from return IPv6 AAAA records over IPv4, which may not solve your problem.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p330346">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">perseus</div>
					<div class="post-datetime">
						2 Jul 2016, 18:52					</div>
				</div>
				<div class="post-content content">
					<p>Thank you cvmiller for taking the time to respond. I will see about implementing at Firewall level.</p><p>Here&#039;s what I am trying to do. Due to lack of usable Parental Controls, I was forced to use OpenDNS as a way to block certain websites. Even if I implement your suggestion Android and IOS apps for the likes of youtube tend to circumvent DNS lookup and go to the site directly. Possibly with hardcoded IP addresses. So it defeats my use of a block at OpenDNS. I did try to configure Tiny Proxy however, I want it to be transparant to all devices. And I don&#039;t find ways of doing so. Or my search-Fu is weak.</p><p>So my unrelated question is, how does one go about blocking such requests ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p330347">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">cvmiller</div>
					<div class="post-datetime">
						2 Jul 2016, 19:23					</div>
				</div>
				<div class="post-content content">
					<p>perseus,</p><p>It must be challenging to restrict internet access as a parent these days, when kids are so tech savvy. </p><p>DNS uses UDP port 53 when making requests over IPv4 and IPv6. So in order to block IPv6 DNS requests, you need to configure the firewall to block UDP Port 53 over IPv6.</p><p>But as you pointed out, if people are using IP addresses directly, blocking DNS lookups won&#039;t stop the connections.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p330501">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">perseus</div>
					<div class="post-datetime">
						4 Jul 2016, 22:34					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>cvmiller wrote:</cite><blockquote><p>perseus,</p><p>It must be challenging to restrict internet access as a parent these days, when kids are so tech savvy. </p><p>DNS uses UDP port 53 when making requests over IPv4 and IPv6. So in order to block IPv6 DNS requests, you need to configure the firewall to block UDP Port 53 over IPv6.</p></blockquote></div><p>Indeed that was the suggestion offered in this thread to block Port 53 requests. After taking your suggestion, I followed the steps to block such requests. Now all pcs who try to go to youtube website, are indeed blocked. But the youtube app on smartphones and tablets don&#039;t seem to have any such issues, as they access directly with IP Address.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p330511">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						5 Jul 2016, 02:28					</div>
				</div>
				<div class="post-content content">
					<p>If you&#039;re not hijacking DNS requests that might be a reason. Some Androids have Google DNS servers (both IPv4 and IPv6) hardcoded, so they can resolve domain names still.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p330545">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">perseus</div>
					<div class="post-datetime">
						5 Jul 2016, 16:28					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>stangri wrote:</cite><blockquote><p>If you&#039;re not hijacking DNS requests that might be a reason. Some Androids have Google DNS servers (both IPv4 and IPv6) hardcoded, so they can resolve domain names still.</p></blockquote></div><p>I know right. Although I have ways to block at Android level using DroidWall, I wish I can do the same at Router level or something. Would a properly configured Tinyproxy achieve blocking such requests where Google&#039;s DNS is hardcoded?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p330555">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						5 Jul 2016, 18:23					</div>
				</div>
				<div class="post-content content">
					<p>Run the code below in the console once, it will create the necessary firewall rules:<br /></p><div class="codebox"><pre><code>uci set firewall.@include[0]=include
uci set firewall.@include[0].path=/etc/firewall.user
uci commit firewall
ip=$(uci -q -P/var/state get network.lan.ipaddr)
ip6=$(echo $(uci -q -P/var/state get network.globals.ula_prefix) | cut -d/ -f1) &amp;&amp; [ &quot;$ip6&quot; ] &amp;&amp; ip6=${ip6}1
if [ ! -z $ip -a ! -z $ip6 ]; then
    grep -q &quot;ip6tables -t nat -A PREROUTING -i br-lan -p udp --dport 53 -j DNAT --to-destination \[$ip6\]&quot; /etc/firewall.user || &quot;ip6tables -t nat -A PREROUTING -i br-lan -p udp --dport 53 -j DNAT --to-destination [$ip6]&quot; &gt;&gt; /etc/firewall.user
    grep -q &quot;ip6tables -t nat -A PREROUTING -i br-lan -p tcp --dport 53 -j DNAT --to-destination \[$ip6\]&quot; /etc/firewall.user || &quot;ip6tables -t nat -A PREROUTING -i br-lan -p tcp --dport 53 -j DNAT --to-destination [$ip6]&quot; &gt;&gt; /etc/firewall.user
fi
if [ ! -z $ip ]; then
    grep -q &quot;iptables -t nat -A prerouting_rule -i br-lan -p udp --dport 53 -j DNAT --to $ip&quot; /etc/firewall.user || &quot;iptables -t nat -A prerouting_rule -i br-lan -p udp --dport 53 -j DNAT --to $ip&quot; &gt;&gt; /etc/firewall.user
    grep -q &quot;iptables -t nat -A prerouting_rule -i br-lan -p tcp --dport 53 -j DNAT --to $ip&quot; /etc/firewall.user || &quot;iptables -t nat -A prerouting_rule -i br-lan -p tcp --dport 53 -j DNAT --to $ip&quot; &gt;&gt; /etc/firewall.user
fi
/etc/init.d/firewall reload &gt;/dev/null  2&gt;&amp;1</code></pre></div><p>Or you can just edit /etc/firewall.user manually. <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p330633">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">perseus</div>
					<div class="post-datetime">
						6 Jul 2016, 16:07					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>stangri wrote:</cite><blockquote><p>Run the code below in the console once, it will create the necessary firewall rules:</p><p>Or you can just edit /etc/firewall.user manually. <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p></blockquote></div><p>Thank you. That worked. However the Apps with the hardcoded IPs still get through though. But oh well, nothing you can do there right ? DroidWall to the rescue.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>