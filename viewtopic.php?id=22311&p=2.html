<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> WNDR3700 exploration</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 1 Oct 2014 and 7 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 2 of 20</div><nav><ul><li><a href="viewtopic.php%3Fid=22311&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=22311&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=22311&amp;p=4.html">4</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=22311&amp;p=20.html">20</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p96638">
				<div class="post-metadata">
					<div class="post-num">Post #26</div>
					<div class="post-author">Borromini</div>
					<div class="post-datetime">
						30 Oct 2009, 03:13					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>whiskas wrote:</cite><blockquote><p>@all:<br/>Does nobody else have this router? There is absolutely NO BRICKING RISK since we&#039;re only running ramdisk-images (if i not specifically interrupt the bootup, the router loads the netgear firmware). Also if you do not solder or rampage inside your router, you STILL HAVE WARRANTY. The serial-cable is easily built with a connector for the serial header, the screws are right under the rubber feet. Even the environment-args in uboot are not saved until one specifically calls &#039;saveenv&#039;.</p></blockquote></div><p>I don&#039;t, unfortunately. I&#039;m still running on 802.11g hardware for the moment and I have other financial priorities than upgrading my WLAN, as much as I&#039;d love to.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p96657">
				<div class="post-metadata">
					<div class="post-num">Post #27</div>
					<div class="post-author">vexingviking</div>
					<div class="post-datetime">
						30 Oct 2009, 17:59					</div>
				</div>
				<div class="post-content content">
					<p>I get my unit this afternoon, so I will definitely do some poking around. Have to make an impromptu serial cable tonight!</p><p>UPDATE</p><p>@whiskas</p><p>I&#039;m currently at the point you&#039;ve lead up to so far. My homemade serial logic-level converter works well, using a nice two-transistor design. I have a base ramdisk image running and more experimentation is pending...</p>											<p class="post-edited">(Last edited by <strong>vexingviking</strong> on 1 Nov 2009, 02:56)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p96800">
				<div class="post-metadata">
					<div class="post-num">Post #28</div>
					<div class="post-author">whiskas</div>
					<div class="post-datetime">
						3 Nov 2009, 17:52					</div>
				</div>
				<div class="post-content content">
					<p>Another success! I got one of the LAN-ports working!</p><p>I&#039;ll sort out the settings and files needed and post them here soon.</p><p>Edit:<br/></p><div class="codebox"><pre><code>--- trunk/target/linux/ar71xx/base-files/lib/ar71xx.sh~    2009-10-08 11:54:10.000000000 +0200
+++ trunk/target/linux/ar71xx/base-files/lib/ar71xx.sh    2009-11-03 12:11:35.000000000 +0100
@@ -70,6 +70,9 @@
     *WRT160NL)
         name=&quot;wrt160nl&quot;
         ;;
+    *WNDR3700)
+        name=&quot;wndr3700&quot;
+        ;;
     *WRT400N)
         name=&quot;wrt400n&quot;
         ;;</code></pre></div><div class="codebox"><pre><code>--- trunk/target/linux/ar71xx/config-2.6.30~    2009-11-03 17:44:01.000000000 +0100
+++ trunk/target/linux/ar71xx/config-2.6.30    2009-11-03 18:11:12.000000000 +0100
@@ -19,6 +19,7 @@
 CONFIG_AR71XX_MACH_WNR2000=y
 CONFIG_AR71XX_MACH_WP543=y
 CONFIG_AR71XX_MACH_WRT160NL=y
+CONFIG_AR71XX_MACH_WNDR3700=y
 CONFIG_AR71XX_MACH_WRT400N=y
 CONFIG_AR71XX_WDT=y
 # CONFIG_ARCH_HAS_ILOG2_U32 is not set</code></pre></div><div class="codebox"><pre><code>--- trunk/target/linux/ar71xx/config-2.6.31~    2009-11-03 17:44:01.000000000 +0100
+++ trunk/target/linux/ar71xx/config-2.6.31    2009-11-03 18:11:36.000000000 +0100
@@ -21,6 +21,7 @@
 CONFIG_AR71XX_MACH_WNR2000=y
 CONFIG_AR71XX_MACH_WP543=y
 CONFIG_AR71XX_MACH_WRT160NL=y
+CONFIG_AR71XX_MACH_WNDR3700=y
 CONFIG_AR71XX_MACH_WRT400N=y
 CONFIG_AR71XX_WDT=y
 # CONFIG_ARCH_HAS_ILOG2_U32 is not set</code></pre></div><div class="codebox"><pre><code>--- trunk/target/linux/ar71xx/files/arch/mips/ar71xx/Kconfig~    2009-11-03 17:44:00.000000000 +0100
+++ trunk/target/linux/ar71xx/files/arch/mips/ar71xx/Kconfig    2009-11-03 18:12:16.000000000 +0100
@@ -35,6 +35,10 @@
     bool &quot;Linksys WRT160NL board support&quot;
     default y
 
+config AR71XX_MACH_WNDR3700
+    bool &quot;Netgear WNDR3700 board support&quot;
+    default y
+
 config AR71XX_MACH_WRT400N
     bool &quot;Linksys WRT400N board support&quot;
     default y</code></pre></div><div class="codebox"><pre><code>--- trunk/target/linux/ar71xx/files/arch/mips/ar71xx/Makefile~    2009-11-03 17:44:00.000000000 +0100
+++ trunk/target/linux/ar71xx/files/arch/mips/ar71xx/Makefile    2009-11-03 18:12:38.000000000 +0100
@@ -29,4 +29,5 @@
 obj-$(CONFIG_AR71XX_MACH_WNR2000)    += mach-wnr2000.o
 obj-$(CONFIG_AR71XX_MACH_WP543)        += mach-wp543.o
 obj-$(CONFIG_AR71XX_MACH_WRT160NL)    += mach-wrt160nl.o
+obj-$(CONFIG_AR71XX_MACH_WNDR3700)    += mach-wndr3700.o
 obj-$(CONFIG_AR71XX_MACH_WRT400N)    += mach-wrt400n.o</code></pre></div><div class="codebox"><pre><code>--- trunk/target/linux/ar71xx/files/arch/mips/ar71xx/prom.c~    2009-11-03 18:06:57.000000000 +0100
+++ trunk/target/linux/ar71xx/files/arch/mips/ar71xx/prom.c    2009-11-03 18:13:31.000000000 +0100
@@ -92,6 +92,9 @@
         .name        = &quot;WRT160NL&quot;,
         .mach_type    = AR71XX_MACH_WRT160NL,
     }, {
+        .name        = &quot;WNDR3700&quot;,
+        .mach_type    = AR71XX_MACH_WNDR3700,
+    }, {
         .name        = &quot;WP543&quot;,
         .mach_type    = AR71XX_MACH_WP543,
     }, {</code></pre></div><div class="codebox"><pre><code>--- trunk/target/linux/ar71xx/files/arch/mips/include/asm/mach-ar71xx/ar71xx.h~    2009-11-03 17:44:00.000000000 +0100
+++ trunk/target/linux/ar71xx/files/arch/mips/include/asm/mach-ar71xx/ar71xx.h    2009-11-03 18:14:05.000000000 +0100
@@ -144,6 +144,7 @@
     AR71XX_MACH_WNR2000,    /* NETGEAR WNR2000 */
     AR71XX_MACH_WP543,    /* Compex WP543 */
     AR71XX_MACH_WRT160NL,    /* Linksys WRT160NL */
+    AR71XX_MACH_WNDR3700,    /* Netgear WNDR3700 */
     AR71XX_MACH_WRT400N,    /* Linksys WRT400N */
 };</code></pre></div><p>This was basically what juhosg changed to introduce the wrt160nl <a href="https://dev.openwrt.org/changeset/16068/">here</a>.</p><p>Now two new files: trunk/target/linux/ar71xx/profiles/netgear.mk<br/></p><div class="codebox"><pre><code>#
# Copyright (C) 2009 OpenWrt.org
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#

define Profile/WNDR3700
    NAME:=Netgear WNDR3700
    PACKAGES:=kmod-ath9k hostapd-mini kmod-usb-core kmod-usb-ohci kmod-usb2 swconfig
endef

define Profile/WNDR3700/Description
    Package set optimized for the Netgear WNDR3700.
endef

$(eval $(call Profile,WNDR3700))</code></pre></div><p>trunk/target/linux/ar71xx/files/arch/mips/ar71xx/mach-wndr3700.c<br/></p><div class="codebox"><pre><code>/*
 *  Netgear WNDR3700 board support
 *
 *  Copyright (C) 2009 Marco Porsch
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License version 2 as published
 *  by the Free Software Foundation.
 */

#include &lt;linux/platform_device.h&gt;
//#include &lt;linux/mtd/mtd.h&gt;
//#include &lt;linux/mtd/partitions.h&gt;
//#include &lt;linux/spi/spi.h&gt;
//#include &lt;linux/spi/flash.h&gt;
#include &lt;linux/input.h&gt;

#include &lt;asm/mips_machine.h&gt;
#include &lt;asm/mach-ar71xx/ar71xx.h&gt;

#include &quot;devices.h&quot;

static void __init wndr3700_setup(void)
{
    ar71xx_add_device_mdio(0x0);

    ar71xx_eth0_data.phy_if_mode = PHY_INTERFACE_MODE_RGMII;
    ar71xx_eth0_data.phy_mask = 0xf;
    ar71xx_eth0_data.speed = SPEED_1000;
    ar71xx_eth0_data.duplex = DUPLEX_FULL;

    ar71xx_eth1_data.phy_if_mode = PHY_INTERFACE_MODE_RGMII;
    ar71xx_eth1_data.phy_mask = 0x10;

    ar71xx_add_device_eth(0);
    ar71xx_add_device_eth(1);

    //ar71xx_add_device_usb();
    //ar91xx_add_device_wmac();
}

MIPS_MACHINE(AR71XX_MACH_WNDR3700, &quot;Netgear WNDR3700&quot;, wndr3700_setup);</code></pre></div><p>After this, the WNDR3700 target should show up in menuconfig and should be recognized with the correct bootarg.</p>											<p class="post-edited">(Last edited by <strong>whiskas</strong> on 3 Nov 2009, 19:43)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p96863">
				<div class="post-metadata">
					<div class="post-num">Post #29</div>
					<div class="post-author">vexingviking</div>
					<div class="post-datetime">
						4 Nov 2009, 07:13					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>whiskas wrote:</cite><blockquote><p>Another success! I got one of the LAN-ports working!</p></blockquote></div><p>Excellent news! </p><p>I applied your patch and now have eth0, eth1, and br-lan interfaces. Is this actually for one of the LAN ports, or is it the one WAN port? I expected the LAN ports would all depend on a driver for the rtl8366sr switch. I would like to help in getting the rtl8366sr hardware working, but I need more familiarity with OpenWRT. Could it just be a matter of adapting the OpenWRT build system for the U-Boot rtl8366sr driver included in some vendor firmware packages such as Belkin&#039;s F5D8235v2-2.01.07-GPL.tar.gz?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p96870">
				<div class="post-metadata">
					<div class="post-num">Post #30</div>
					<div class="post-author">whiskas</div>
					<div class="post-datetime">
						4 Nov 2009, 11:09					</div>
				</div>
				<div class="post-content content">
					<p>I think, that every network device has a kind of general interface, by which it can be used for a network boot or other simple functions. Another thing will be the network switching and throughput for LAN-WAN. This is what a driver is needed for. For this driver a skilled programmer will know how to use the various sources included in the vendor packages.<br/>For now i&#039;m quiet fine with the basic functions of the LAN. I&#039;m curious, if it will also be this easy to activate the pci-devices. Once recognized, these should be supported by the ath9k-driver. At least i hope so <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink"/></p><p>By playing around with ping, it seemed to me, that only the LAN-port works; don&#039;t know, what is needed for the WAN.</p>											<p class="post-edited">(Last edited by <strong>whiskas</strong> on 4 Nov 2009, 11:11)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p96877">
				<div class="post-metadata">
					<div class="post-num">Post #31</div>
					<div class="post-author">whiskas</div>
					<div class="post-datetime">
						4 Nov 2009, 15:57					</div>
				</div>
				<div class="post-content content">
					<p>I found something interesting <a href="http://www.pudn.com/downloads105/sourcecode/unix_linux/detail430984_en.html/">here</a>. This seems to be the sourcecode of one of the modules used in the stock firmware: ag7100-mod.ko. Dunno what it is used for though..</p><p>Edit: there is a <a href="https://forum.openwrt.org/viewtopic.php?id=14765">thread on this topic</a>. I guess the code is now included in the ar71xx-tree.</p>											<p class="post-edited">(Last edited by <strong>whiskas</strong> on 4 Nov 2009, 16:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p96921">
				<div class="post-metadata">
					<div class="post-num">Post #32</div>
					<div class="post-author">whiskas</div>
					<div class="post-datetime">
						5 Nov 2009, 14:15					</div>
				</div>
				<div class="post-content content">
					<p>Weird.. after appying the following patch, i get pci-devices..<br/></p><div class="codebox"><pre><code>--- trunk/build_dir/linux-ar71xx/linux-2.6.30.9/arch/mips/ar71xx/mach-wndr3700.c    2009-11-05 13:08:53.000000000 +0100
+++ trunk/target/linux/ar71xx/files/arch/mips/ar71xx/mach-wndr3700.c    2009-11-05 13:08:25.000000000 +0100
@@ -14,12 +14,25 @@
 //#include &lt;linux/spi/spi.h&gt;
 //#include &lt;linux/spi/flash.h&gt;
 #include &lt;linux/input.h&gt;
+#include &lt;asm/mach-ar71xx/pci.h&gt;
 
 #include &lt;asm/mips_machine.h&gt;
 #include &lt;asm/mach-ar71xx/ar71xx.h&gt;
 
 #include &quot;devices.h&quot;
 
+static struct ar71xx_pci_irq wndr3700_pci_irqs[] __initdata = {
+    {
+        .slot    = 0,
+        .pin    = 1,
+        .irq    = AR71XX_PCI_IRQ_DEV0,
+    }, {
+        .slot    = 1,
+        .pin    = 1,
+        .irq    = AR71XX_PCI_IRQ_DEV1,
+    }
+};
+
 static void __init wndr3700_setup(void)
 {
     ar71xx_add_device_mdio(0x0);
@@ -37,6 +50,8 @@
 
     ar71xx_add_device_usb();
     //ar91xx_add_device_wmac();
+
+    ar71xx_pci_init(ARRAY_SIZE(wndr3700_pci_irqs), wndr3700_pci_irqs);
 }
 
 MIPS_MACHINE(AR71XX_MACH_WNDR3700, &quot;Netgear WNDR3700&quot;, wndr3700_setup);</code></pre></div><p>But the devices are:</p><div class="codebox"><pre><code>root@OpenWrt:/# cat proc/bus/pci/devices 
0000    07001107        0                      8                       1                       0                       0    0
0088    168cff1d        31              10000000                       0                       0                       0    0
0090    168cff1d        0               10010000                       0                       0                       0    0


root@OpenWrt:/# lspci 
00:00.0 Non-VGA unclassified device: Device 0700:1107 (rev 01)
00:11.0 Ethernet controller: Atheros Communications Inc. AR5008 Wireless Network Adapter (rev 01)
00:12.0 Ethernet controller: Atheros Communications Inc. AR5008 Wireless Network Adapter (rev 01)</code></pre></div><p>Should be some AR9xxx with pci-id 168c:0029?! Whats wrong here?</p><p>dmesg says:</p><div class="codebox"><pre><code>MIPS: machine is Netgear WNDR3700
registering PCI controller with io_map_base unsetpin
bio: create slab &lt;bio-0&gt; at 0
pci 0000:00:00.0: PME# supported from D0 D1 D2 D3hot
pci 0000:00:00.0: PME# disabled
PCI: mapping irq 48 to pin1@0000:00:11.0
PCI: mapping irq 50 to pin1@0000:00:12.0</code></pre></div><p>I get the IRQs only with these settings, but the two AR5008s appear no matter whatever slot or pin i use.</p>											<p class="post-edited">(Last edited by <strong>whiskas</strong> on 5 Nov 2009, 19:25)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p96998">
				<div class="post-metadata">
					<div class="post-num">Post #33</div>
					<div class="post-author">entee</div>
					<div class="post-datetime">
						6 Nov 2009, 22:22					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>whiskas wrote:</cite><blockquote><div class="codebox"><pre><code>root@OpenWrt:/# lspci 
00:00.0 Non-VGA unclassified device: Device 0700:1107 (rev 01)
00:11.0 Ethernet controller: Atheros Communications Inc. AR5008 Wireless Network Adapter (rev 01)
00:12.0 Ethernet controller: Atheros Communications Inc. AR5008 Wireless Network Adapter (rev 01)</code></pre></div><p>Should be some AR9xxx with pci-id 168c:0029?! Whats wrong here?</p><p>I get the IRQs only with these settings, but the two AR5008s appear no matter whatever slot or pin i use.</p></blockquote></div><p>Are you sure you&#039;re supposed to be getting AR9xxx? Check out this link: <a href="http://www.atheros.com/pt/AR5008Bulletins.htm">http://www.atheros.com/pt/AR5008Bulletins.htm</a></p><p>From some quick (5 minute) googling it looks like the AR9xxx series and the AR5008 are related.</p><p>Links:<br/><a href="http://www.atheros.com/pt/AR9002Bulletins.htm">http://www.atheros.com/pt/AR9002Bulletins.htm</a><br/><a href="http://www.atheros.com/pt/AR9001Bulletins.htm">http://www.atheros.com/pt/AR9001Bulletins.htm</a></p><p>Apparently the 9 series are the successors to the 5 series. Maybe the chips are announcing themselves as the preceding iteration? Is there any way to verify that the chip on the board is actually a 9 series? Or more exactly, to confirm that the PCI report for a 9 series isn&#039;t the same as what you&#039;re getting?</p><p>If I&#039;m totally missing something then feel free to correct me. Thanks for all the work you&#039;re doing, it&#039;s great to see it coming along nicely!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97056">
				<div class="post-metadata">
					<div class="post-num">Post #34</div>
					<div class="post-author">vexingviking</div>
					<div class="post-datetime">
						8 Nov 2009, 22:18					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>entee wrote:</cite><blockquote><p>Are you sure you&#039;re supposed to be getting AR9xxx?</p></blockquote></div><p>According to <a href="http://cateee.net/lkddb/web-lkddb/ATH9K.html">this</a>, that PCI device ID, 168c:0029, should show up as &quot;AR922X Wireless Network Adapter.&quot;</p>											<p class="post-edited">(Last edited by <strong>vexingviking</strong> on 8 Nov 2009, 22:25)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97065">
				<div class="post-metadata">
					<div class="post-num">Post #35</div>
					<div class="post-author">aorlinsk</div>
					<div class="post-datetime">
						9 Nov 2009, 01:08					</div>
				</div>
				<div class="post-content content">
					<p>I just wrote a small C program to make an image with a patched header from a freshly built image.<br/>Compile with gcc -o wndr3700 wndr3700.c<br/>Basic usage is ./wndr3700 orig_file patched_file</p><p>Get it here : <a href="http://aorlinsk2.free.fr/openwrt/wndr3700/">http://aorlinsk2.free.fr/openwrt/wndr3700/</a></p><p>It should be easy to integrate it in the toolchain and generate &quot;ready to load in uboot via tftp&quot; images (it looks like images to flash have a different header...)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97074">
				<div class="post-metadata">
					<div class="post-num">Post #36</div>
					<div class="post-author">ratbug</div>
					<div class="post-datetime">
						9 Nov 2009, 07:27					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>aorlinsk wrote:</cite><blockquote><p>I just wrote a small C program to make an image with a patched header from a freshly built image.<br/>Compile with gcc -o wndr3700 wndr3700.c<br/>Basic usage is ./wndr3700 orig_file patched_file</p><p>Get it here : <a href="http://aorlinsk2.free.fr/openwrt/wndr3700/">http://aorlinsk2.free.fr/openwrt/wndr3700/</a></p><p>It should be easy to integrate it in the toolchain and generate &quot;ready to load in uboot via tftp&quot; images (it looks like images to flash have a different header...)</p></blockquote></div><p>I&#039;m not clear on your program, does it achieve step 3.2 to 3.4 in post #11 automatically?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97079">
				<div class="post-metadata">
					<div class="post-num">Post #37</div>
					<div class="post-author">aorlinsk</div>
					<div class="post-datetime">
						9 Nov 2009, 11:17					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ratbug wrote:</cite><blockquote><div class="quotebox"><cite>aorlinsk wrote:</cite><blockquote><p>I just wrote a small C program to make an image with a patched header from a freshly built image.<br/>Compile with gcc -o wndr3700 wndr3700.c<br/>Basic usage is ./wndr3700 orig_file patched_file</p><p>Get it here : <a href="http://aorlinsk2.free.fr/openwrt/wndr3700/">http://aorlinsk2.free.fr/openwrt/wndr3700/</a></p><p>It should be easy to integrate it in the toolchain and generate &quot;ready to load in uboot via tftp&quot; images (it looks like images to flash have a different header...)</p></blockquote></div><p>I&#039;m not clear on your program, does it achieve step 3.2 to 3.4 in post #11 automatically?</p></blockquote></div><p>Yes, steps 3.1 to 3.4.<br/>Basic usage is ./wndr3700 openwrt-ar71xx-uImage-lzma.bin openwrt-ar71xx-uImage-lzma-wndr3700.bin</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97080">
				<div class="post-metadata">
					<div class="post-num">Post #38</div>
					<div class="post-author">whiskas</div>
					<div class="post-datetime">
						9 Nov 2009, 11:51					</div>
				</div>
				<div class="post-content content">
					<p>@ entee &amp; vexingviking:<br/>To be absolutely sure we would need to see some photos of the hardware with the antenna foils removed (FCC photos or something alike). But since smallnetbuilder and the stock firmware relate to a 92xx chipset, i am quiet sure it should not be the 5008. You are right, the 5008 is the predecessor of the 9xxx chipsets. The 5008 was the first atheros draft-n chipset. But the pci-id 168c:0029 should really give &quot;AR922X Wireless Network Adapter&quot;, but the stock firmware said 9280. Strange..</p><p>@ aorlinsk:<br/>Thanks! Works great! I&#039;ve grown tired of typing the number and checksum by hand, but was too lazy/stupid to write a script myself <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink"/></p><br/><p>Right now i have edited the first lines of &quot;linux-2.6.xx.x/drivers/net/wireless/ath9k/pci.c&quot; to accept the ID &quot;ff1d&quot;. But the OS hangs without any output as soon as i insert the ath9k-module.</p><p>So is there a problem with ath9k or the PCI connection? Is there a way to test the function of a pci-device? Or some outputs of &quot;lspci -vvvvxxx&quot; that make it clear that the device is working?</p>											<p class="post-edited">(Last edited by <strong>whiskas</strong> on 9 Nov 2009, 12:04)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97085">
				<div class="post-metadata">
					<div class="post-num">Post #39</div>
					<div class="post-author">aorlinsk</div>
					<div class="post-datetime">
						9 Nov 2009, 12:47					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>whiskas wrote:</cite><blockquote><p>So is there a problem with ath9k or the PCI connection? Is there a way to test the function of a pci-device? Or some outputs of &quot;lspci -vvvvxxx&quot; that make it clear that the device is working?</p></blockquote></div><p>Maybe the system uses an AHB bus... an alternate to PCI. See this topic for more details : <a href="https://forum.openwrt.org/viewtopic.php?id=18113">https://forum.openwrt.org/viewtopic.php?id=18113</a></p><br/><p>For the rtl8366sr switch I went through various GPL distributions, and I am quite confident to get a full switch support :<br/>- As seen in a previous post, in the linksys Uboot archive there is a file board/ar7100/wndr3700u/rtl8366s_phy.c. It looks like not to be the switch driver itself, but the driver to make the leds blink when there is activity on the network / show amber/green color on 1Gbps/100Mbps connections...<br/>it can be useful though.</p><p>- In the Asus RT-N15 GPL archives, it looks like there is switch driver for linux kernel 2.4 (includes + src) : relevant files seems to be rtl8366s_api.c, rtl8366s_asicdrv.c ...&nbsp; In the 2.4 kernel the switch is implemented as a char device. There is also a tool (and c source) called rtl8366 that seems to setup the switch through the char interface.</p><p>- In the Belkin F5D8235-4 GPL archive, the Uboot SDK provides the switch driver in Uboot_SDK_3200/drivers/rtl8366SR. The files have the same names of the ones found in the asus archives. I will have a closer look to this implementation, because Uboot seems to include lots of linux headers, and it could happen that the uboot driver being just the same as a linux one (see references to linux 2.6 in rmain.c).</p><br/><p>I will have a try tonight of making kernel modules from those files...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97104">
				<div class="post-metadata">
					<div class="post-num">Post #40</div>
					<div class="post-author">whiskas</div>
					<div class="post-datetime">
						9 Nov 2009, 17:36					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m now quiet sure the problem is the pci system. I&#039;ve tried both madwifi and ath9k with modified sources to accept the 5008. Both crashed:</p><div class="codebox"><pre><code>PCI: Enabling device 0000:00:11.0 (0000 -&gt; 0002)
ath9k 0000:00:11.0: failed to initialize device
ath9k: probe of 0000:00:11.0 failed with error -122
PCI: Enabling device 0000:00:12.0 (0000 -&gt; 0002)
ath9k 0000:00:12.0: failed to initialize device
ath9k: probe of 0000:00:12.0 failed with error -122


ath_pci: trunk
PCI: Enabling device 0000:00:11.0 (0000 -&gt; 0002)
Atheros HAL provided by OpenWrt, DD-WRT and MakSat Technologies
wifi0: unable to attach hardware: &#039;Hardware didn&#039;t respond as expected&#039; (HAL status 3)
ath_pci: ath_attach failed: 6
PCI: Enabling device 0000:00:12.0 (0000 -&gt; 0002)
Atheros HAL provided by OpenWrt, DD-WRT and MakSat Technologies
wifi0: unable to attach hardware: &#039;Hardware didn&#039;t respond as expected&#039; (HAL status 3)
ath_pci: ath_attach failed: 6</code></pre></div><p>But about the pci-thing i&#039;m quiet out of ideas.. By the way, the WRT400N, which is the same hardware with different switch, suffers the same problem.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97108">
				<div class="post-metadata">
					<div class="post-num">Post #41</div>
					<div class="post-author">vexingviking</div>
					<div class="post-datetime">
						9 Nov 2009, 19:21					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>whiskas wrote:</cite><blockquote><p>To be absolutely sure we would need to see some photos of the hardware with the antenna foils removed (FCC photos or something alike).</p></blockquote></div><p>Unfortunately, it looks like the <a href="https://gullfoss2.fcc.gov/prod/oet/forms/blobs/retrieve.cgi?attachment_id=1150474&amp;native_or_pdf=pdf">FCC photos</a> won&#039;t be too helpful. The photos are low resolution and the Atheros chip under the small black heatsink is too scuffed up to read, while the chips under the RF shielding are still covered.</p>											<p class="post-edited">(Last edited by <strong>vexingviking</strong> on 9 Nov 2009, 19:22)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97130">
				<div class="post-metadata">
					<div class="post-num">Post #42</div>
					<div class="post-author">vexingviking</div>
					<div class="post-datetime">
						10 Nov 2009, 06:51					</div>
				</div>
				<div class="post-content content">
					<p>I contacted Realtek regarding programming documentation for the gigabit switch chipset. Unfortunately, Realtek requires developers to sign non-disclosure agreements in exchange for any information. Since non-disclosure agreements are invariably harmful to the open-source community, this seems like a poor route. Let&#039;s hope the code from Belkin&#039;s UBoot SDK will be enough...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97135">
				<div class="post-metadata">
					<div class="post-num">Post #43</div>
					<div class="post-author">yjchang</div>
					<div class="post-datetime">
						10 Nov 2009, 08:14					</div>
				</div>
				<div class="post-content content">
					<p>It seems u-boot has initialized the PCI, so kernel does not need to initialize it again.</p><p>I removed the PCI init code, and WNDR3700 PCI seems work normally.</p><div class="codebox"><pre><code>diff --git a/target/linux/ar71xx/files/arch/mips/pci/pci-ar71xx.c b/target/linux/ar71xx/files/arch/mips/pci/pci-ar71xx.
index b2d36ca..4f63335 100644
--- a/target/linux/ar71xx/files/arch/mips/pci/pci-ar71xx.c
+++ b/target/linux/ar71xx/files/arch/mips/pci/pci-ar71xx.c
@@ -38,7 +38,7 @@
 
 static void __iomem *ar71xx_pcicfg_base;
 static DEFINE_SPINLOCK(ar71xx_pci_lock);
-static int ar71xx_pci_fixup_enable;
+static int ar71xx_pci_fixup_enable = 0;
 
 static inline void ar71xx_pci_delay(void)
 {
@@ -302,15 +302,13 @@ static struct pci_controller ar71xx_pci_controller = {
 
 int __init ar71xx_pcibios_init(void)
 {
+#if 0
        ar71xx_device_stop(RESET_MODULE_PCI_BUS | RESET_MODULE_PCI_CORE);
        ar71xx_pci_delay();
 
        ar71xx_device_start(RESET_MODULE_PCI_BUS | RESET_MODULE_PCI_CORE);
        ar71xx_pci_delay();
 
-       ar71xx_pcicfg_base = ioremap_nocache(AR71XX_PCI_CFG_BASE,
-                                               AR71XX_PCI_CFG_SIZE);
-
        ar71xx_ddr_wr(AR71XX_DDR_REG_PCI_WIN0, PCI_WIN0_OFFS);
        ar71xx_ddr_wr(AR71XX_DDR_REG_PCI_WIN1, PCI_WIN1_OFFS);
        ar71xx_ddr_wr(AR71XX_DDR_REG_PCI_WIN2, PCI_WIN2_OFFS);
@@ -326,6 +324,10 @@ int __init ar71xx_pcibios_init(void)
        (void)ar71xx_pci_be_handler(1);
 
        ar71xx_pci_fixup_enable = 1;
+#endif
+       ar71xx_pcicfg_base = ioremap_nocache(AR71XX_PCI_CFG_BASE,
+                                               AR71XX_PCI_CFG_SIZE);
+
        register_pci_controller(&amp;ar71xx_pci_controller);
 
        return 0;</code></pre></div><p>Here is the dump of /proc/bus/pci/devices with above change.</p><div class="codebox"><pre><code>root@OpenWrt:/# cat /proc/bus/pci/devices 
0000    07001107        0           8              1             0             0             0               0             0                10000000             100                0                       0                       0                       0               0
0088    168c0029        30              10000000                       0                       0                      0                0                       0                       0                   10000 
              0                0                       0                       0                       0               0
0090    168c0029        31              10010000                       0                       0                       0                0                       0                       0                   10000 
              0                0                       0                       0                       0 
              0</code></pre></div><p>I know this kind of patch is bad, but I&#039;ve no idea how to make pci-ar71xx.c support both cases of PCI being initialized and not being initialized. </p><p>However, there is still unknown issue to cause ath9k unable to work on WND3700.<br/></p><div class="codebox"><pre><code>cfg80211: Regulatory domain: US
        (start_freq - end_freq @ bandwidth), (max_antenna_gain, max_eirp)
        (2402000 KHz - 2472000 KHz @ 40000 KHz), (600 mBi, 2700 mBm)
        (5170000 KHz - 5190000 KHz @ 40000 KHz), (600 mBi, 2300 mBm)
        (5190000 KHz - 5210000 KHz @ 40000 KHz), (600 mBi, 2300 mBm)
        (5210000 KHz - 5230000 KHz @ 40000 KHz), (600 mBi, 2300 mBm)
        (5230000 KHz - 5330000 KHz @ 40000 KHz), (600 mBi, 2300 mBm)
        (5735000 KHz - 5835000 KHz @ 40000 KHz), (600 mBi, 3000 mBm)
cfg80211: Calling CRDA for country: US
SCSI subsystem initialized
usbcore: registered new interface driver ar9170usb
ath9k 0000:00:11.0: failed to initialize device
ath9k: probe of 0000:00:11.0 failed with error -22
ath9k 0000:00:12.0: failed to initialize device
ath9k: probe of 0000:00:12.0 failed with error -22</code></pre></div><p>BTW, below provide another way in target/linux/ar71xx/image/Makefile to create WNDR3700 firmware directly.<br/></p><div class="codebox"><pre><code>define Image/Build/WNDR3700
        cp $(KDIR)/vmlinux $(KDIR)/vmlinux-$(2)
        $(STAGING_DIR_HOST)/bin/patch-cmdline $(KDIR)/vmlinux-$(2) &#039;$(strip $(3))&#039;
        $(STAGING_DIR_HOST)/bin/lzma e $(KDIR)/vmlinux-$(2) $(KDIR)/vmlinux-$(2).7z
        mkimage -A mips -O linux -T kernel -C lzma -n &quot;Linux Kernel Image&quot; -a 0x80060000 -e $$$$(readelf -a $(KDIR)/vm\
linux.elf |grep &quot;Entry&quot;|cut -d&quot;:&quot; -f 2) -d $(KDIR)/vmlinux-$(2).7z $(KDIR)/vmlinux-$(2).7z.uImage.stage1
        dd if=$(KDIR)/vmlinux-$(2).7z.uImage.stage1 of=$(KDIR)/vmlinux-$(2).7z.uImage.head1 bs=1 skip=8 count=56
        echo -n &#039;3700&#039; &gt; $(KDIR)/vmlinux-$(2).7z.uImage.head2
        dd if=/dev/zero bs=4 count=1 &gt;&gt; $(KDIR)/vmlinux-$(2).7z.uImage.head2
        cat $(KDIR)/vmlinux-$(2).7z.uImage.head1 &gt;&gt; $(KDIR)/vmlinux-$(2).7z.uImage.head2
        (cd $(KDIR); rm -rf crca*)
        (cd $(KDIR); crc32 $(KDIR)/vmlinux-$(2).7z.uImage.head2 | split -b 2 - crc)
        echo -n &#039;3700&#039; &gt; $(KDIR)/vmlinux-$(2).7z.uImage.head3
        (export CRCHEX=`cat $(KDIR)/crcaa`; export CRCOCT=`printf &quot;%03o\n&quot; 0x$$$$CRCHEX`; if [ $$$$CRCOCT = &quot;000&quot; ]; t\
hen dd if=/dev/zero bs=1 count=1 &gt;&gt; $(KDIR)/vmlinux-$(2).7z.uImage.head3; else echo -n -e &#039;\0&#039;$$$$CRCOCT &gt;&gt; $(KDIR)/vm\
linux-$(2).7z.uImage.head3; fi)
        (export CRCHEX=`cat $(KDIR)/crcab`; export CRCOCT=`printf &quot;%03o\n&quot; 0x$$$$CRCHEX`; if [ $$$$CRCOCT = &quot;000&quot; ]; t\
hen dd if=/dev/zero bs=1 count=1 &gt;&gt; $(KDIR)/vmlinux-$(2).7z.uImage.head3; else echo -n -e &#039;\0&#039;$$$$CRCOCT &gt;&gt; $(KDIR)/vm\
linux-$(2).7z.uImage.head3; fi)
        (export CRCHEX=`cat $(KDIR)/crcac`; export CRCOCT=`printf &quot;%03o\n&quot; 0x$$$$CRCHEX`; if [ $$$$CRCOCT = &quot;000&quot; ]; t\
hen dd if=/dev/zero bs=1 count=1 &gt;&gt; $(KDIR)/vmlinux-$(2).7z.uImage.head3; else echo -n -e &#039;\0&#039;$$$$CRCOCT &gt;&gt; $(KDIR)/vm\
linux-$(2).7z.uImage.head3; fi)
        (export CRCHEX=`cat $(KDIR)/crcad`; export CRCOCT=`printf &quot;%03o\n&quot; 0x$$$$CRCHEX`; if [ $$$$CRCOCT = &quot;000&quot; ]; t\
hen dd if=/dev/zero bs=1 count=1 &gt;&gt; $(KDIR)/vmlinux-$(2).7z.uImage.head3; else echo -n -e &#039;\0&#039;$$$$CRCOCT &gt;&gt; $(KDIR)/vm\
linux-$(2).7z.uImage.head3; fi)
        cat $(KDIR)/vmlinux-$(2).7z.uImage.head1 &gt;&gt; $(KDIR)/vmlinux-$(2).7z.uImage.head3
        cat $(KDIR)/vmlinux-$(2).7z.uImage.head3 &gt; $(KDIR)/vmlinux-$(2).7z.uImage
        dd if=$(KDIR)/vmlinux-$(2).7z.uImage.stage1 bs=64 skip=1 &gt;&gt; $(KDIR)/vmlinux-$(2).7z.uImage
        cp -f $(KDIR)/vmlinux-$(2).7z.uImage /home/spencer/sshfs/sun/tftpboot/
        ( \                                                                                                            
                dd if=$(KDIR)/vmlinux-$(2).7z.uImage bs=896k conv=sync; \                                              
                dd if=$(KDIR)/root.$(1); \
        ) &gt; $(call imgname,$(1),$(2)).bin;
endef</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97136">
				<div class="post-metadata">
					<div class="post-num">Post #44</div>
					<div class="post-author">whiskas</div>
					<div class="post-datetime">
						10 Nov 2009, 11:58					</div>
				</div>
				<div class="post-content content">
					<p>Thank you yjchang! This is great news! You are my hero of the day <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p><p>Lets get on.. <br/>Still neither ath9k nor modified madwifi activate wireless:<br/></p><div class="codebox"><pre><code>ath_pci: trunk
Atheros HAL provided by OpenWrt, DD-WRT and MakSat Technologies
wifi0: unable to attach hardware: &#039;No hardware present or device not yet supported&#039; (HAL status 1)
ath_pci: ath_attach failed: 6
Atheros HAL provided by OpenWrt, DD-WRT and MakSat Technologies
wifi0: unable to attach hardware: &#039;No hardware present or device not yet supported&#039; (HAL status 1)
ath_pci: ath_attach failed: 6</code></pre></div><p>However now these lines are missing:<br/></p><div class="codebox"><pre><code>PCI: Enabling device 0000:00:11.0 (0000 -&gt; 0002)

...

PCI: Enabling device 0000:00:12.0 (0000 -&gt; 0002)</code></pre></div><p>I don&#039;t know, whether this is normal, or we commented out a bit too much. </p><p>If PCI is ok, our next target will be ath9k. We should take a look into their <a href="http://www.mail-archive.com/ath9k-devel@lists.ath9k.org/">mailing-list</a> or write to them about this.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97209">
				<div class="post-metadata">
					<div class="post-num">Post #45</div>
					<div class="post-author">whiskas</div>
					<div class="post-datetime">
						11 Nov 2009, 14:40					</div>
				</div>
				<div class="post-content content">
					<p><a href="http://www.mail-archive.com/ath9k-devel@lists.ath9k.org/msg02566.html">I wrote to the ath9k-devel-list.</a></p><p>So the <a href="http://www.atheros.com/pt/AR9002AP-4XHG.htm">Atheros platform this router is based on</a> is not supported until now. Development is stalled due to lack of devices.<br/>A solution would be a device donation to the openWrt-developers. Anyone had his paycheck recently or stumbled over some? <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink"/></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97227">
				<div class="post-metadata">
					<div class="post-num">Post #46</div>
					<div class="post-author">whiskas</div>
					<div class="post-datetime">
						11 Nov 2009, 18:24					</div>
				</div>
				<div class="post-content content">
					<p>I have traced the error so far:</p><p>trunk/build_dir/linux-ar71xx/compat-wireless-2009-08-20/drivers/net/wireless/ath/ath9k/eeprom.c<br/>in function &#039;ath9k_hw_eeprom_init&#039; default eeprom is chosen<br/>-&gt;<br/>trunk/build_dir/linux-ar71xx/compat-wireless-2009-08-20/drivers/net/wireless/ath/ath9k/eeprom_def.c<br/>in function &#039;ath9k_hw_def_check_eeprom&#039; a magic number 0x00 is read (instead of 0xA55A or 0x5AA5) which returns error code 22 (invalid)</p><p>I&#039;ve printed out the further &#039;contents&#039; of the eeprom/nvram but all is just zeros. Same for &#039;4k&#039; and &#039;AR9287&#039; eeprom profile.</p><p>Hm.. does this design have a different eeprom reading procedure, or is the eeprom/nvram just uninitialized/unaccessible due to PCI-problems?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97247">
				<div class="post-metadata">
					<div class="post-num">Post #47</div>
					<div class="post-author">Dragon</div>
					<div class="post-datetime">
						12 Nov 2009, 03:34					</div>
				</div>
				<div class="post-content content">
					<p>Nice to see some work being done on this, I was hoping that at some point in future would be able to get more uptodate openwrt on as I&#039;ve got one of these myself, but alas I can&#039;t really experiment due to it needing to stay &#039;up&#039; for rest of family</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97253">
				<div class="post-metadata">
					<div class="post-num">Post #48</div>
					<div class="post-author">yjchang</div>
					<div class="post-datetime">
						12 Nov 2009, 09:44					</div>
				</div>
				<div class="post-content content">
					<p>ath9k seems try to get calibration data from eeprom when the device is connected via PCI. <br/>However, on WNDR3700, the calibration data is saved in flash instead of in eeprom, so ath9k initialize failed on WNDR3700.</p><p>I&#039;ve done some changes on openwrt and ath9k driver to make ath9k get calibration from flash.</p><p>in openwrt, base on trunk@18066<br/></p><div class="codebox"><pre><code>diff --git a/target/linux/ar71xx/files/arch/mips/ar71xx/devices.c b/target/linux/ar71xx/files/arch/mips/ar71xx/devices.c
index 90869a8..a009f74 100644
--- a/target/linux/ar71xx/files/arch/mips/ar71xx/devices.c
+++ b/target/linux/ar71xx/files/arch/mips/ar71xx/devices.c
@@ -772,6 +772,26 @@ void __init ar91xx_add_device_wmac(void)
     platform_device_register(&amp;ar91xx_wmac_device);
 }
 
+static struct ath9k_platform_data ar71xx_wmac_data;
+
+static struct platform_device ar71xx_wmac_device = {
+    .name        = &quot;ath9k_flashcalc&quot;,
+    .id        = -1,
+    .dev = {
+        .platform_data = &amp;ar71xx_wmac_data,
+    },
+};
+
+void __init ar71xx_add_device_wmac(unsigned int addr)
+{
+    u8 *ee = (u8 *) KSEG1ADDR(addr);
+
+    memcpy(ar71xx_wmac_data.eeprom_data, ee,
+           sizeof(ar71xx_wmac_data.eeprom_data));
+
+    platform_device_register(&amp;ar71xx_wmac_device);
+}
+
 static struct platform_device ar71xx_dsa_switch_device = {
     .name        = &quot;dsa&quot;,
     .id        = 0,
diff --git a/target/linux/ar71xx/files/arch/mips/ar71xx/devices.h b/target/linux/ar71xx/files/arch/mips/ar71xx/devices.h
index 6c72126..23c4985 100644
--- a/target/linux/ar71xx/files/arch/mips/ar71xx/devices.h
+++ b/target/linux/ar71xx/files/arch/mips/ar71xx/devices.h
@@ -56,6 +56,8 @@ void ar71xx_add_device_wdt(void) __init;
 
 void ar91xx_add_device_wmac(void) __init;
 
+void ar71xx_add_device_wmac(unsigned int addr) __init;
+
 void ar71xx_add_device_dsa(unsigned int id,
                struct dsa_platform_data *d) __init;
 
diff --git a/target/linux/ar71xx/files/arch/mips/ar71xx/mach-wndr3700.c b/target/linux/ar71xx/files/arch/mips/ar71xx/mach-wndr3700.c
index ade34f6..2119d8d 100644
--- a/target/linux/ar71xx/files/arch/mips/ar71xx/mach-wndr3700.c
+++ b/target/linux/ar71xx/files/arch/mips/ar71xx/mach-wndr3700.c
@@ -183,6 +183,8 @@ static void __init wndr3700_setup(void)
     ar71xx_add_device_usb();
 
     ar71xx_pci_init(ARRAY_SIZE(wndr3700_pci_irqs), wndr3700_pci_irqs);
+
+    ar71xx_add_device_wmac(0x1f7f1000);
 }
 
 MIPS_MACHINE(AR71XX_MACH_WNDR3700, &quot;Netgear WNDR3700&quot;, wndr3700_setup);</code></pre></div><p>in ath9k, base on compat-wireless-2009-10-09<br/></p><div class="codebox"><pre><code>diff --git a/drivers/net/wireless/ath/ath9k/ath9k.h b/drivers/net/wireless/ath/ath9k/ath9k.h
index 13dd020..0529c8b 100644
--- a/drivers/net/wireless/ath/ath9k/ath9k.h
+++ b/drivers/net/wireless/ath/ath9k/ath9k.h
@@ -561,6 +561,7 @@ struct ath_softc {
     struct tasklet_struct bcon_tasklet;
     struct ath_hw *sc_ah;
     void __iomem *mem;
+    u16 *cal_data;
     int irq;
     spinlock_t sc_resetlock;
     spinlock_t sc_serial_rw;
diff --git a/drivers/net/wireless/ath/ath9k/pci.c b/drivers/net/wireless/ath/ath9k/pci.c
index 63059b6..b751927 100644
--- a/drivers/net/wireless/ath/ath9k/pci.c
+++ b/drivers/net/wireless/ath/ath9k/pci.c
@@ -15,6 +15,8 @@
  */
 
 #include &lt;linux/nl80211.h&gt;
+#include &lt;linux/ath9k_platform.h&gt;
+#include &lt;linux/platform_device.h&gt;
 #include &lt;linux/pci.h&gt;
 #include &quot;ath9k.h&quot;
 
@@ -62,6 +64,12 @@ static void ath_pci_cleanup(struct ath_common *common)
 static bool ath_pci_eeprom_read(struct ath_common *common, u32 off, u16 *data)
 {
     struct ath_hw *ah = (struct ath_hw *) common-&gt;ah;
+    struct ath_softc *sc = (struct ath_softc *) common-&gt;priv;
+
+    if (sc-&gt;cal_data){
+        *data = sc-&gt;cal_data[off];
+        return true;
+    }
 
     common-&gt;ops-&gt;read(ah, AR5416_EEPROM_OFFSET + (off &lt;&lt; AR5416_EEPROM_S));
 
@@ -103,6 +111,22 @@ const static struct ath_bus_ops ath_pci_bus_ops = {
     .bt_coex_prep = ath_pci_bt_coex_prep,
 };
 
+static int ath_set_cal_data(struct ath_softc *sc)
+{
+    struct device *d;
+    struct platform_device *pd;
+    struct ath9k_platform_data *pdata;
+
+    d = bus_find_device_by_name(&amp;platform_bus_type, NULL, &quot;ath9k_flashcalc&quot;);
+    if (d){
+        pd = to_platform_device(d);
+        pdata = (struct ath9k_platform_data *) pd-&gt;dev.platform_data;
+        sc-&gt;cal_data = pdata-&gt;eeprom_data;
+    }else{
+        sc-&gt;cal_data = NULL;
+    }
+}
+
 static int ath_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 {
     void __iomem *mem;
@@ -200,6 +224,7 @@ static int ath_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
     sc-&gt;dev = &amp;pdev-&gt;dev;
     sc-&gt;mem = mem;
 
+    ath_set_cal_data(sc);
     pci_read_config_word(pdev, PCI_SUBSYSTEM_ID, &amp;subsysid);
     ret = ath_init_device(id-&gt;device, sc, subsysid, &amp;ath_pci_bus_ops);
     if (ret) {</code></pre></div><p>whiskas, maybe you will fail on using the patches since our version of openwrt or ath9k driver is not synced. but I think you can get the idea of what I&#039;ve done.</p><p>But, there are still some other issues. I can not make wireless station connect to WNDR3700 even the interfaces are up. <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad"/></p>											<p class="post-edited">(Last edited by <strong>yjchang</strong> on 12 Nov 2009, 11:38)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97263">
				<div class="post-metadata">
					<div class="post-num">Post #49</div>
					<div class="post-author">aorlinsk</div>
					<div class="post-datetime">
						12 Nov 2009, 12:25					</div>
				</div>
				<div class="post-content content">
					<p>By the way do you have some tips to avoid a full kernel rebuild after each code change ?</p><p>At the moment I do &quot;make target/linux/clean &amp;&amp; make&quot; to use my changes, but this is quite long....<br/>I&#039;ve seen the targets &quot;target/linux/update&quot; and &quot;target/linux/refresh&quot; but I have no idea how to use them.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p97266">
				<div class="post-metadata">
					<div class="post-num">Post #50</div>
					<div class="post-author">yjchang</div>
					<div class="post-datetime">
						12 Nov 2009, 13:15					</div>
				</div>
				<div class="post-content content">
					<p>Actually, after I modified file in build_dir/linux-ar71xx/linux-2.6.30.8 I do &quot;make&quot; directly, and then only the modified file would be rebuilt.<br/>I am not sure if this is a right way, but at least it works well for me. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 2 of 20</div><nav><ul><li><a href="viewtopic.php%3Fid=22311&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=22311&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=22311&amp;p=4.html">4</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=22311&amp;p=20.html">20</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0.001 -->

</body>
</html>