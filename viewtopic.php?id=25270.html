<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Loadbalancing Multi-WAN ? with TP-Link WR1043ND or Netgear WNDR3700</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 30 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p111239">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">Priyantha Bleeker</div>
					<div class="post-datetime">
						15 Jun 2010, 11:08					</div>
				</div>
				<div class="post-content content">
					<p>Hi, I have posted this post in the &#039;Multi-WAN&#039; topic but it was advised there to open a new subject about it so here is my question:</p><div class="quotebox"><cite>Priyantha Bleeker wrote:</cite><blockquote><p>Has somebody already experience with this in combination with a Netgear WNDR3700 or TP-Link WR1043ND (I have them both with OpenWRT installed) working ?</p><p>And does this method mean that you may use both(or more) connections together to burst download and upload speeds by example ?<br />My home situation is right now the following:<br />- 1 ADSL(2) connection of 8 Mbit<br />- 1 ADSL(2) connection of 8/10 Mbit is comming soon<br />- 1 ADSL(2) connection of 8/10 Mbit is comming maybe <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>I do use right now a Linksys VPN-Router(type I don&#039;t know at the moment) which is connected with my Alcatel SpeedTouch 546v6 ADSL2 modem, that lot is connected to my Cisco 2924 as my main switch to distribute trough my building(I do live in a company building). On the main floor I have 1 Netgear WNDR3700 with OpenWRT running to provide WiFi access and two TP-Link 1043ND also to provide WiFi access, all three of these WiFi devices to have their own small &#039;network&#039; at this moment(from the Linksys VPN-Router trough my Cisco everything is connected to the WAN ports on the WiFI devices), but this is not the ideal situation I think.</p><p>I think I would like the following devices to use for the new situation:</p><p>- Cisco 2924 as my main switch to all the patchpanels trough the building<br />- Alcatel SpeedTouch 546v6 ADSL2 modem<br />- &quot;Some&quot; ADSL(2) modem<br />- &quot;Some&quot; ADSL(2) modem(for maybe the third line)<br />- TP-Link 1043ND with OpenWRT<br />- TP-Link 1043ND with OpenWRT<br />- Nethear WNDR3700 with OpenWRT</p><p>I think it is best to move the old Linksys VPN-Router, which is used right now, move away and not to use it anymore.<br />The idea is I think to use one of the TP-Link&#039;s OR the Netgear as my main router, with Multi-WAN Load Balancing thingie on it, and use the other WiFI devices to provide WiFi access trough the building just as plain AccessPoints without routing or NAT-ting them self.</p><p>So the question is <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /> Which is best solution ? How do I build this properly ?</p><p>Thanks in Advance.</p><p>Greetz, Priyantha</p></blockquote></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p111449">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Priyantha Bleeker</div>
					<div class="post-datetime">
						18 Jun 2010, 16:40					</div>
				</div>
				<div class="post-content content">
					<p>Maybe somebody who can point me in a direction ?</p><p>Regards,<br />Priyantha</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p111601">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">Priyantha Bleeker</div>
					<div class="post-datetime">
						20 Jun 2010, 13:30					</div>
				</div>
				<div class="post-content content">
					<p>Well, alread 82 viewers, but nobody can post a reply ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p111634">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">Priyantha Bleeker</div>
					<div class="post-datetime">
						21 Jun 2010, 01:39					</div>
				</div>
				<div class="post-content content">
					<p>After some help on IRC from the very kind user&nbsp; &#039;soma&#039; I am a bit further now <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>My config files looks now this way.</p><p>/etc/config/network:<br /></p><div class="codebox"><pre><code>config &#039;interface&#039; &#039;loopback&#039;
        option &#039;ifname&#039; &#039;lo&#039;
        option &#039;proto&#039; &#039;static&#039;
        option &#039;ipaddr&#039; &#039;127.0.0.1&#039;
        option &#039;netmask&#039; &#039;255.0.0.0&#039;

config &#039;interface&#039; &#039;lan&#039;
        option &#039;ifname&#039; &#039;eth0.1&#039;
        option &#039;type&#039; &#039;bridge&#039;
        option &#039;proto&#039; &#039;static&#039;
        option &#039;netmask&#039; &#039;255.255.255.0&#039;
        option &#039;ipaddr&#039; &#039;192.168.3.44&#039;
        option &#039;gateway&#039; &#039;192.168.3.1&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;

config &#039;interface&#039; &#039;wan&#039;
        option &#039;ifname&#039; &#039;eth0.2&#039;
        option &#039;proto&#039; &#039;dhcp&#039;

config &#039;interface&#039; &#039;wan2&#039;
        option &#039;ifname&#039; &#039;eth0.3&#039;
        option &#039;proto&#039; &#039;dhcp&#039;

config &#039;switch&#039;
        option &#039;name&#039; &#039;rtl8366rb&#039;
        option &#039;reset&#039; &#039;1&#039;
        option &#039;enable_vlan&#039; &#039;1&#039;

config &#039;switch_vlan&#039;
        option &#039;device&#039; &#039;rtl8366rb&#039;
        option &#039;vlan&#039; &#039;1&#039;
        option &#039;ports&#039; &#039;2 3 4 5t&#039;

config &#039;switch_vlan&#039;
        option &#039;device&#039; &#039;rtl8366rb&#039;
        option &#039;vlan&#039; &#039;2&#039;
        option &#039;ports&#039; &#039;0 5t&#039;

config &#039;switch_vlan&#039;
        option &#039;device&#039; &#039;rtl8366rb&#039;
        option &#039;vlan&#039; &#039;3&#039;
        option &#039;ports&#039; &#039;1 5t&#039;</code></pre></div><p>/etc/config/multiwan:<br /></p><div class="codebox"><pre><code>config &#039;multiwan&#039; &#039;config&#039;
        option &#039;default_route&#039; &#039;balancer&#039;

config &#039;interface&#039; &#039;wan&#039;
        option &#039;weight&#039; &#039;10&#039;
        option &#039;health_interval&#039; &#039;10&#039;
        option &#039;icmp_hosts&#039; &#039;dns&#039;
        option &#039;timeout&#039; &#039;3&#039;
        option &#039;health_fail_retries&#039; &#039;3&#039;
        option &#039;health_recovery_retries&#039; &#039;5&#039;
        option &#039;failover_to&#039; &#039;wan2&#039;
        option &#039;dns&#039; &#039;auto&#039;

config &#039;interface&#039; &#039;wan2&#039;
        option &#039;weight&#039; &#039;10&#039;
        option &#039;health_interval&#039; &#039;10&#039;
        option &#039;icmp_hosts&#039; &#039;gateway&#039;
        option &#039;timeout&#039; &#039;3&#039;
        option &#039;health_fail_retries&#039; &#039;3&#039;
        option &#039;health_recovery_retries&#039; &#039;5&#039;
        option &#039;failover_to&#039; &#039;balancer&#039;
        option &#039;dns&#039; &#039;auto&#039;

config &#039;mwanfw&#039;
        option &#039;dst&#039; &#039;www.whatismyip.com&#039;
        option &#039;wanrule&#039; &#039;fastbalancer&#039;</code></pre></div><p>/etc/config/firewall:<br /></p><div class="codebox"><pre><code>config &#039;defaults&#039;
        option &#039;syn_flood&#039; &#039;1&#039;
        option &#039;input&#039; &#039;ACCEPT&#039;
        option &#039;output&#039; &#039;ACCEPT&#039;
        option &#039;forward&#039; &#039;REJECT&#039;

config &#039;zone&#039;
        option &#039;name&#039; &#039;lan&#039;
        option &#039;input&#039; &#039;ACCEPT&#039;
        option &#039;output&#039; &#039;ACCEPT&#039;
        option &#039;forward&#039; &#039;REJECT&#039;

config &#039;zone&#039;
        option &#039;name&#039; &#039;wan&#039;
        option &#039;input&#039; &#039;REJECT&#039;
        option &#039;output&#039; &#039;ACCEPT&#039;
        option &#039;forward&#039; &#039;REJECT&#039;
        option &#039;masq&#039; &#039;1&#039;
        option &#039;mtu_fix&#039; &#039;1&#039;
        option &#039;network&#039; &#039;wan wan2&#039;

config &#039;forwarding&#039;
        option &#039;src&#039; &#039;lan&#039;
        option &#039;dest&#039; &#039;wan&#039;

config &#039;rule&#039;
        option &#039;src&#039; &#039;wan&#039;
        option &#039;proto&#039; &#039;udp&#039;
        option &#039;dest_port&#039; &#039;68&#039;
        option &#039;target&#039; &#039;ACCEPT&#039;
        option &#039;family&#039; &#039;ipv4&#039;

config &#039;rule&#039;
        option &#039;src&#039; &#039;wan&#039;
        option &#039;proto&#039; &#039;icmp&#039;
        option &#039;icmp_type&#039; &#039;echo-request&#039;
        option &#039;target&#039; &#039;ACCEPT&#039;

config &#039;include&#039;
        option &#039;path&#039; &#039;/etc/firewall.user&#039;</code></pre></div><p>The wan2 port is configured and is working like it should</p><p>My routering stuff:</p><p>&quot;ip route show&quot;:<br /></p><div class="codebox"><pre><code>root@OpenWrt:/etc/config# ip route show
212.67.182.102 via 213.148.226.1 dev eth0.2
192.168.3.0/24 dev br-lan  proto kernel  scope link  src 192.168.3.44
192.168.1.0/24 dev eth0.3  proto kernel  scope link  src 192.168.1.71
213.148.226.0/24 dev eth0.2  proto kernel  scope link  src 213.148.226.77
default via 192.168.1.254 dev eth0.3
default via 213.148.226.1 dev eth0.2</code></pre></div><p>&quot;ip rule show&quot;:<br /></p><div class="codebox"><pre><code>root@OpenWrt:/etc/config# ip rule show
0:      from all lookup local
300:    from all fwmark 0x1 lookup LoadBalancer
310:    from 213.148.226.77 lookup MWAN1
311:    from all fwmark 0x10 lookup MWAN1
320:    from 192.168.1.71 lookup MWAN2
321:    from all fwmark 0x20 lookup MWAN2
32766:  from all lookup main
32767:  from all lookup default</code></pre></div><p>&quot;ip neigh show&quot;:<br /></p><div class="codebox"><pre><code>root@OpenWrt:/etc/config# ip neigh show
192.168.1.1 dev eth0.3  FAILED
213.148.226.1 dev eth0.2 lladdr 00:09:b6:8e:90:90 REACHABLE
192.168.1.254 dev eth0.3 lladdr 00:24:17:69:21:d2 REACHABLE
192.168.3.99 dev br-lan lladdr 00:23:7d:e7:04:9a REACHABLE</code></pre></div><p>&quot;ip ntable show&quot;:<br /></p><div class="codebox"><pre><code>root@OpenWrt:/etc/config# ip ntable show
inet arp_cache
    thresh1 128 thresh2 512 thresh3 1024 gc_int 30000
    refcnt 1 reachable 36840 base_reachable 30000 retrans 1000
    gc_stale 60000 delay_probe 5000 queue 3
    app_probes 0 ucast_probes 3 mcast_probes 3
    anycast_delay 1000 proxy_delay 800 proxy_queue 64 locktime 1000

inet arp_cache
    dev mon.wlan0
    refcnt 1 reachable 26680 base_reachable 30000 retrans 1000
    gc_stale 60000 delay_probe 5000 queue 3
    app_probes 0 ucast_probes 3 mcast_probes 3
    anycast_delay 1000 proxy_delay 800 proxy_queue 64 locktime 1000

inet arp_cache
    dev wlan0
    refcnt 1 reachable 17680 base_reachable 30000 retrans 1000
    gc_stale 60000 delay_probe 5000 queue 3
    app_probes 0 ucast_probes 3 mcast_probes 3
    anycast_delay 1000 proxy_delay 800 proxy_queue 64 locktime 1000

inet arp_cache
    dev br-lan
    refcnt 2 reachable 36610 base_reachable 30000 retrans 1000
    gc_stale 60000 delay_probe 5000 queue 3
    app_probes 0 ucast_probes 3 mcast_probes 3
    anycast_delay 1000 proxy_delay 800 proxy_queue 64 locktime 1000

inet arp_cache
    dev imq1
    refcnt 1 reachable 18590 base_reachable 30000 retrans 1000
    gc_stale 60000 delay_probe 5000 queue 3
    app_probes 0 ucast_probes 3 mcast_probes 3
    anycast_delay 1000 proxy_delay 800 proxy_queue 64 locktime 1000

inet arp_cache
    dev imq0
    refcnt 1 reachable 28870 base_reachable 30000 retrans 1000
    gc_stale 60000 delay_probe 5000 queue 3
    app_probes 0 ucast_probes 3 mcast_probes 3
    anycast_delay 1000 proxy_delay 800 proxy_queue 64 locktime 1000

inet arp_cache
    dev eth0.3
    refcnt 4 reachable 32930 base_reachable 30000 retrans 1000
    gc_stale 60000 delay_probe 5000 queue 3
    app_probes 0 ucast_probes 3 mcast_probes 3
    anycast_delay 1000 proxy_delay 800 proxy_queue 64 locktime 1000

inet arp_cache
    dev eth0.2
    refcnt 2 reachable 31990 base_reachable 30000 retrans 1000
    gc_stale 60000 delay_probe 5000 queue 3
    app_probes 0 ucast_probes 3 mcast_probes 3
    anycast_delay 1000 proxy_delay 800 proxy_queue 64 locktime 1000

inet arp_cache
    dev eth0.1
    refcnt 1 reachable 34180 base_reachable 30000 retrans 1000
    gc_stale 60000 delay_probe 5000 queue 3
    app_probes 0 ucast_probes 3 mcast_probes 3
    anycast_delay 1000 proxy_delay 800 proxy_queue 64 locktime 1000

inet arp_cache
    dev eth0
    refcnt 1 reachable 21160 base_reachable 30000 retrans 1000
    gc_stale 60000 delay_probe 5000 queue 3
    app_probes 0 ucast_probes 3 mcast_probes 3
    anycast_delay 1000 proxy_delay 800 proxy_queue 64 locktime 1000

inet arp_cache
    dev lo
    refcnt 2 reachable 33990 base_reachable 30000 retrans 1000
    gc_stale 60000 delay_probe 5000 queue 3
    app_probes 0 ucast_probes 3 mcast_probes 3
    anycast_delay 1000 proxy_delay 800 proxy_queue 64 locktime 1000</code></pre></div><p>Some output from the &#039;old&#039; &quot;route&quot; command</p><p>&quot;route -n&quot;:<br /></p><div class="codebox"><pre><code>root@OpenWrt:/etc/config# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
212.67.182.102  213.148.226.1   255.255.255.255 UGH   0      0        0 eth0.2
192.168.3.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0.3
213.148.226.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0.2
0.0.0.0         192.168.1.254   0.0.0.0         UG    0      0        0 eth0.3
0.0.0.0         213.148.226.1   0.0.0.0         UG    0      0        0 eth0.2</code></pre></div><p>Some interface information</p><p>&quot;ip link show&quot;:<br /></p><div class="codebox"><pre><code>root@OpenWrt:/etc/config# ip link show
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 94:0c:6d:f1:7d:84 brd ff:ff:ff:ff:ff:ff
3: eth0.1@eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP
    link/ether 94:0c:6d:f1:7d:84 brd ff:ff:ff:ff:ff:ff
4: eth0.2@eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP
    link/ether 94:0c:6d:f1:7d:84 brd ff:ff:ff:ff:ff:ff
5: eth0.3@eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP
    link/ether 94:0c:6d:f1:7d:84 brd ff:ff:ff:ff:ff:ff
8: imq0: &lt;NOARP&gt; mtu 16000 qdisc noop state DOWN qlen 11000
    link/void
9: imq1: &lt;NOARP&gt; mtu 16000 qdisc noop state DOWN qlen 11000
    link/void
27: br-lan: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN
    link/ether 94:0c:6d:f1:7d:84 brd ff:ff:ff:ff:ff:ff
28: wlan0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state DORMANT qlen 1000
    link/ether 94:0c:6d:f1:7d:84 brd ff:ff:ff:ff:ff:ff
29: mon.wlan0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UNKNOWN qlen 1000
    link/ieee802.11/radiotap 94:0c:6d:f1:7d:84 brd ff:ff:ff:ff:ff:ff</code></pre></div><p>The problem right now is the following, eth0.3(which is wan2) is now my &#039;default&#039; internet connection, and I thought that there shouldn&#039;t a &#039;default&#039; internet connection, I thought it would ALWAYS using both connections, with one of the two for the specific &#039;handshake&#039; for sessions and sort of stuff. But using both connections to ensure the highest speed which is possible.<br />The connection on WAN2 is the slowest of both <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>Well I am hoping that there will be some reactions now after I did discover this all by myself with the kind help of the IRC user &quot;soma&quot;.</p><p>Regards,<br />Priyantha</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119085">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">Bad Joker</div>
					<div class="post-datetime">
						15 Oct 2010, 04:20					</div>
				</div>
				<div class="post-content content">
					<p>Man, thanks for your investigations <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I will try a similar config with my cable line and an 3g connection as backup. Seems to work as I expected.</p><p>Maybe to point you into the right direction: The balancer just can use one line per connection. When the first line is busy and more bandwidth is needed from other connections, the balancer will use the second line for them.</p><p>Because the balancer cannot handle the NAT with different IP&#039;s from different lines for one connection, this is nearly impossible, would be against the IP laws <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>So you will feel the speed of the second line just in an multi user environment, or when you are downloading with multiple threads perhaps. Maybe try to download five linux images per ftp at the same time and add all speed to check if the balancer does his job.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>