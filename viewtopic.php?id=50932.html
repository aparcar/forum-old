<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> openwrt+wifidog +authpuppy using facebook login</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 30 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p235512">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">kavastudios</div>
					<div class="post-datetime">
						3 Jun 2014, 13:18					</div>
				</div>
				<div class="post-content content">
					<p>Hi<br />I have a working ap with wifidog and I want my users first have to make a social login using facebook before allowing them to navigate freely.</p><p>I&#039;m using wifidog with the cms external plugin to show a customized page for login, everything is working fine except the facebook login because i need to manually configure wifidog with the ip&#039;s used by facebook. I&#039;ve managed to configure the list of this ip&#039;s but as facebook use akamai cdn for css,js and static content the facebook login screens aren&#039;t loading properly.</p><p>akamai use more than 4k different ip&#039;s so it&#039;s going to be a little bit hard to configure (and find) all of them.</p><p>or how i could define the iptables rules using the domains instead of the ip&#039;s?<br />facebook login elements use the following domains:<br />connect.facebook.net <br />*.facebook.com <br />*.akamaihd.net</p><p>what i could do to allow my users sign in using facebook?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p235515">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">3zl</div>
					<div class="post-datetime">
						3 Jun 2014, 14:51					</div>
				</div>
				<div class="post-content content">
					<p>you may try </p><p><a href="https://code.launchpad.net/~alliancecsf-dev/authpuppy/apAuthFacebookPlugin">https://code.launchpad.net/~alliancecsf â€¦ bookPlugin</a></p><p>would be interested if authpuppy works though.</p><p>We did have some problems time ago and had a glimpse at the code, but decided to wait for new Symphony version, which didnt came.</p><p>We also asked for somebody to rewrite/transport the code, but they did ask too much mony for the job.</p><p>regards<br />3zl</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p235553">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">kavastudios</div>
					<div class="post-datetime">
						3 Jun 2014, 21:29					</div>
				</div>
				<div class="post-content content">
					<p>Hi</p><p>Wich type of problems did you found?</p><p>anything special to be aware of?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p235581">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">kavastudios</div>
					<div class="post-datetime">
						4 Jun 2014, 00:11					</div>
				</div>
				<div class="post-content content">
					<p>Hi Again, I&#039;ve installed the proxyplugin and the facebook plugin, the facebook plugin works, but I have the problem that the js,css files are not loading because they&#039;re from akamai, i added the akamai domains to the proxy but still not loading.</p><p>Btw, i have the authpuppy running outside the ap in a remote server, should i run it inside the ap?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p235587">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">3zl</div>
					<div class="post-datetime">
						4 Jun 2014, 01:51					</div>
				</div>
				<div class="post-content content">
					<p>AFAIK woulnt be a good idea to put it indo the AP, and not neccesary.</p><p>We just started a thread abt CP on Openwrt in general</p><p><a href="https://forum.openwrt.org/viewtopic.php?id=50938">https://forum.openwrt.org/viewtopic.php?id=50938</a></p><p>Regarding Authpuppy problems : if i recall right there was some wierd behaviour in user-rights managment</p><p>What version did you install ? Its still Symfony 1.6 ?</p><p>regards<br />3zl</p>											<p class="post-edited">(Last edited by <strong>3zl</strong> on 4 Jun 2014, 21:18)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p235604">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">kavastudios</div>
					<div class="post-datetime">
						4 Jun 2014, 06:54					</div>
				</div>
				<div class="post-content content">
					<p>Hi<br />I&#039;ve used the authpuppy 1.0.0-stable release. I think the symfony still the 1.6.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p235658">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">vldts</div>
					<div class="post-datetime">
						4 Jun 2014, 21:04					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>I am also interested in the same issue. But now can&#039;t get apAuthFacebookPlugin works. Can somebody help me? Wich are the steep to install it?</p><p>Thanks</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p235678">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">kavastudios</div>
					<div class="post-datetime">
						5 Jun 2014, 00:06					</div>
				</div>
				<div class="post-content content">
					<p>Hi</p><p>I&#039;ve added the following rules to the wifidog.con under the global ruleset.&nbsp; those are the ip&#039;s used by facebook </p><p>FirewallRule allow to 204.15.20.0/22 <br />FirewallRule allow to 69.63.176.0/20 <br />FirewallRule allow to 66.220.144.0/20 <br />FirewallRule allow to 66.220.144.0/21 <br />FirewallRule allow to 69.63.184.0/21 <br />FirewallRule allow to 69.63.176.0/21 <br />FirewallRule allow to 74.119.76.0/22 <br />FirewallRule allow to 69.171.255.0/24 <br />FirewallRule allow to 173.252.64.0/18 <br />FirewallRule allow to 69.171.224.0/19 <br />FirewallRule allow to 69.171.224.0/20 <br />FirewallRule allow to 103.4.96.0/22 <br />FirewallRule allow to 69.63.176.0/24 <br />FirewallRule allow to 173.252.64.0/19 <br />FirewallRule allow to 173.252.70.0/24 <br />FirewallRule allow to 31.13.64.0/18 <br />FirewallRule allow to 31.13.24.0/21 <br />FirewallRule allow to 66.220.152.0/21 <br />FirewallRule allow to 66.220.159.0/24 <br />FirewallRule allow to 69.171.239.0/24 <br />FirewallRule allow to 69.171.240.0/20 <br />FirewallRule allow to 31.13.64.0/19 <br />FirewallRule allow to 31.13.64.0/24 <br />FirewallRule allow to 31.13.65.0/24 <br />FirewallRule allow to 31.13.67.0/24 <br />FirewallRule allow to 31.13.68.0/24 <br />FirewallRule allow to 31.13.69.0/24 <br />FirewallRule allow to 31.13.70.0/24 <br />FirewallRule allow to 31.13.71.0/24 <br />FirewallRule allow to 31.13.72.0/24 <br />FirewallRule allow to 31.13.73.0/24 <br />FirewallRule allow to 31.13.74.0/24 <br />FirewallRule allow to 31.13.75.0/24 <br />FirewallRule allow to 31.13.76.0/24 <br />FirewallRule allow to 31.13.77.0/24 <br />FirewallRule allow to 31.13.96.0/19 <br />FirewallRule allow to 31.13.66.0/24 <br />FirewallRule allow to 173.252.96.0/19 <br />FirewallRule allow to 69.63.178.0/24 <br />FirewallRule allow to 31.13.78.0/24 <br />FirewallRule allow to 31.13.79.0/24 <br />FirewallRule allow to 31.13.80.0/24 <br />FirewallRule allow to 31.13.82.0/24 <br />FirewallRule allow to 31.13.83.0/24 <br />FirewallRule allow to 31.13.84.0/24 <br />FirewallRule allow to 31.13.85.0/24 <br />FirewallRule allow to 31.13.86.0/24 <br />FirewallRule allow to 31.13.87.0/24 <br />FirewallRule allow to 31.13.88.0/24 <br />FirewallRule allow to 31.13.89.0/24 <br />FirewallRule allow to 31.13.90.0/24 <br />FirewallRule allow to 31.13.91.0/24 <br />FirewallRule allow to 31.13.92.0/24 <br />FirewallRule allow to 31.13.93.0/24 <br />FirewallRule allow to 31.13.94.0/24 <br />FirewallRule allow to 31.13.95.0/24 <br />FirewallRule allow to 69.171.253.0/24 <br />FirewallRule allow to 69.63.186.0/24 <br />FirewallRule allow to 31.13.81.0/24 <br />FirewallRule allow to 204.15.20.0/22 <br />FirewallRule allow to 69.63.176.0/20 <br />FirewallRule allow to 69.63.176.0/21 <br />FirewallRule allow to 69.63.184.0/21 <br />FirewallRule allow to 66.220.144.0/20 <br />FirewallRule allow to 69.63.176.0/20<br />FirewallRule allow to 23.0.0.0/12 </p><p>Now the facebook login dialog loads but without js/ css, those are served by fbstatic-a.akamaihd.net<br />but the ip range change everyday! even within minutes.<br />for example, for mexico I&#039;ve found the next ranges</p><p>&nbsp; FirewallRule allow to&nbsp; 187.210.45.0/24<br />&nbsp; FirewallRule allow to 148.250.0.0/16<br />&nbsp; FirewallRule allow to 148.208.0.0/12<br />&nbsp; FirewallRule allow to 148.224.0.0/12<br />&nbsp; FirewallRule allow to 148.248.0.0/15<br />&nbsp; FirewallRule allow to 148.202.0.0/15<br />&nbsp; FirewallRule allow to 148.240.0.0/13<br />&nbsp; FirewallRule allow to 148.204.0.0/14<br />&nbsp; FirewallRule allow to 148.201.0.0/16 </p><p>But for sure they are gonna change tomorrow and could be different depending of your country or city (akamai works at isp level)</p><p>If we could find a way to whitelist the fbstatic-a.akamaihd.net&nbsp; using the domain and not a fixed ip, i think that would be the solution to our problems.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p235682">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">qasdfdsaq</div>
					<div class="post-datetime">
						5 Jun 2014, 00:52					</div>
				</div>
				<div class="post-content content">
					<p>A transparent proxy would do exactly that, though it&#039;s a bit of a dirty hack.</p><p>Also, what was the point of:<br /></p><div class="codebox"><pre><code>FirewallRule allow to 31.13.64.0/24
FirewallRule allow to 31.13.65.0/24
FirewallRule allow to 31.13.67.0/24
FirewallRule allow to 31.13.68.0/24
FirewallRule allow to 31.13.69.0/24
FirewallRule allow to 31.13.70.0/24
FirewallRule allow to 31.13.71.0/24
FirewallRule allow to 31.13.72.0/24
FirewallRule allow to 31.13.73.0/24
FirewallRule allow to 31.13.74.0/24
FirewallRule allow to 31.13.75.0/24
FirewallRule allow to 31.13.76.0/24
FirewallRule allow to 31.13.77.0/24
FirewallRule allow to 31.13.78.0/24
FirewallRule allow to 31.13.79.0/24
FirewallRule allow to 31.13.80.0/24
FirewallRule allow to 31.13.82.0/24
FirewallRule allow to 31.13.83.0/24
FirewallRule allow to 31.13.84.0/24
FirewallRule allow to 31.13.85.0/24
FirewallRule allow to 31.13.86.0/24
FirewallRule allow to 31.13.87.0/24
FirewallRule allow to 31.13.88.0/24
FirewallRule allow to 31.13.89.0/24
FirewallRule allow to 31.13.90.0/24
FirewallRule allow to 31.13.91.0/24
FirewallRule allow to 31.13.92.0/24
FirewallRule allow to 31.13.93.0/24
FirewallRule allow to 31.13.94.0/24
FirewallRule allow to 31.13.95.0/24 </code></pre></div><p>When you already have<br /></p><div class="codebox"><pre><code>FirewallRule allow to 31.13.64.0/19 </code></pre></div><p>It is literally 30 lines duplicating the exact same rule.</p><p>P.S. Facebook themselves list the following IP ranges:<br /></p><div class="codebox"><pre><code>31.13.24.0/21
31.13.64.0/18
66.220.144.0/20 
69.63.176.0/20 
69.171.224.0/19 
74.119.76.0/22 
103.4.96.0/22 
173.252.64.0/18 
204.15.20.0/22</code></pre></div><p>You would basically reduce your filter list by 90% by using that list.</p>											<p class="post-edited">(Last edited by <strong>qasdfdsaq</strong> on 5 Jun 2014, 00:57)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p235683">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">qasdfdsaq</div>
					<div class="post-datetime">
						5 Jun 2014, 01:01					</div>
				</div>
				<div class="post-content content">
					<p>Although another dirty hack would be to locally host copies of the required files off akamaihd.net. It&#039;s not as if the load from your local hotspot clients is going to really need a load-balanced CDN anyway.</p><p>Though you&#039;ve probably considered this already, whitelisting <em>all</em> of Facebook (and potentially akamai&#039;s) IPs is basically giving everyone free free access to all of Facebook without logging in.</p>											<p class="post-edited">(Last edited by <strong>qasdfdsaq</strong> on 5 Jun 2014, 01:02)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p235688">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">kavastudios</div>
					<div class="post-datetime">
						5 Jun 2014, 02:36					</div>
				</div>
				<div class="post-content content">
					<p>Hi, how could work with the transparent proxy?<br />what configurations i would have to do in wifidog?</p><p>I considered the free access to facebook for the login pourpouse. <br />Akamai contents are the ones not loading,&nbsp; i could host those css/js needed but then how i say to clients to load those local files?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p235737">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">qasdfdsaq</div>
					<div class="post-datetime">
						5 Jun 2014, 14:42					</div>
				</div>
				<div class="post-content content">
					<p>Transparent proxy isn&#039;t particularly easy to set up or explain and probably needs a second machine/router.</p><p>Locally hosting the akamai stuff is pretty easy though. You already have a basic http server running so the basic process is find out what files are loaded, download them, and put them into the same directory structure on your http server. Then create a short-lived DNS entry that points fbstatic-a.akamaihd.net to the IP of your router for non-logged in clients, and/or a static entry that points it to a &quot;real&quot; IP and a firewall rule to redirect traffic to that IP to your local server for non-logged in clients.</p><p>A transparent proxy could also do the above without (technically) breaking standards, but I&#039;m not entirely sure what micro-packges are available for Openwrt, and fitting a full-blown Apache install with loadable modules is probably not going to work on an embedded device unless it&#039;s one of those with 128MB flash...</p>											<p class="post-edited">(Last edited by <strong>qasdfdsaq</strong> on 5 Jun 2014, 14:44)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p235740">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">qasdfdsaq</div>
					<div class="post-datetime">
						5 Jun 2014, 14:52					</div>
				</div>
				<div class="post-content content">
					<p>After having a quick look, tinyproxy seems to fit the bill:<br /><a href="http://wiki.openwrt.org/doc/howto/proxy.tinyproxy">http://wiki.openwrt.org/doc/howto/proxy.tinyproxy</a></p><p>If you set the firewall rules in wifidog to redirect non-logged-in users to the proxy and then set tinyproxy&#039;s allow rules to appropriate DNS entries (e.g. fbstatic-a.akamaihd.net, *.facebook.com, etc) you should be sorted.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>