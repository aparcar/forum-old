<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> How to Configure DNS (OpenDNS etc)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 17 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p297322">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						25 Oct 2015, 02:25					</div>
				</div>
				<div class="post-content content">
					<p><strong>How to Configure DNS (OpenDNS etc) and remove your ISPs DNS</strong></p><p><strong>THE SHORT ANSWER</strong><br />Network =&gt; Interfaces =&gt; WAN =&gt; EDIT =&gt; Common Configurations =&gt; Advanced Settings<br />Use DNS servers advertised by peer&nbsp; &nbsp; Uncheck<br />Use Custom DNS Servers&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[Add your DNS servers here]<br />Save and Apply<br />Reboot</p><p><strong>THE LONG STORY</strong><br />I realized yesterday after reading this post that I did not have my DNS servers configured as I wanted, but still not clear on how to do this.&nbsp; <a href="https://forum.openwrt.org/viewtopic.php?id=60477">https://forum.openwrt.org/viewtopic.php?id=60477</a></p><p>In Luci Status =&gt; Overview Network =&gt; IPV4 WAN Status I have 4 entries, and I only want the first 2.&nbsp; <br /></p><div class="codebox"><pre><code>DNS 1: 209.244.0.3
DNS 2: 209.244.0.4
DNS 3: 208.59.247.45
DNS 4: 208.59.247.46</code></pre></div><p>I now know the following:<br />Network =&gt; Interfaces =&gt;LAN =&gt;EDIT =&gt; Common Configurations =&gt; Use Custom DNS Servers adds an entry to the /tmp/resolve.conf.auto file, which I believe is called by the /etc/config/dhcp file, in the config dnsmasq section:&nbsp; option resolvfile &#039;/tmp/resolv.conf.auto&#039;.&nbsp; The entry looks like<br /></p><div class="codebox"><pre><code># Interface lan
nameserver 209.244.0.3
nameserver 209.244.0.4</code></pre></div><p>I can add a section to the /etc/config/network file for the interface lan or wan as follows:<br /></p><div class="codebox"><pre><code>option dns &#039;209.244.0.3 209.244.0.4&#039;</code></pre></div><p> and this is added to the resolve.conf.auto file.</p><p>There is a section in the resolve.conf.auto file that is for my ISP (RCN) as follows.<br /></p><div class="codebox"><pre><code>nameserver 208.59.247.45    
nameserver 208.59.247.46
search cable.rcn.com</code></pre></div><p>These are my ISP DNS servers, which I do not wish to use.&nbsp; I deleted them from the file, but they returned after a reboot.</p><p>Eventually I came across this post <a href="https://forum.openwrt.org/viewtopic.php?pid=181228#p181228">https://forum.openwrt.org/viewtopic.php … 28#p181228</a></p><div class="quotebox"><cite>davidkennedy85 wrote:</cite><blockquote><p> In case any other noobs come across this, you have to uncheck the &quot;Use DNS servers advertised by peer&quot; setting under WAN &gt; Advanced before you can set DNS servers for the WAN to use.</p></blockquote></div><p>This check box controls the availability of the “Use Custom DNS servers” on the WAN side.&nbsp; It also adds a line to the config “&nbsp; &nbsp; option peerdns &#039;0&#039; “ which appears to be the key in ignoring the ISPs DNS settings in the resolve.conf.auto file.&nbsp; </p><p><strong>QUESTIONS</strong></p><p>I have learned that I can set a DSN on the LAN side.&nbsp; What does this do, if anything?&nbsp; Do I want this?</p><p>Where does DNSMASQ actually stores its data (cache), and how do I view this?</p><p><strong>Public DNS Servers</strong><br /><a href="http://pcsupport.about.com/od/tipstricks/a/free-public-dns-servers.htm">http://pcsupport.about.com/od/tipstrick … ervers.htm</a><br /><a href="http://www.getdriver.com/how-to/2498/free-fast-public-dns-server-faster-browsing-experience.html">http://www.getdriver.com/how-to/2498/fr … ience.html</a></p>											<p class="post-edited">(Last edited by <strong>RangerZ</strong> on 25 Oct 2015, 02:26)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297344">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Middling</div>
					<div class="post-datetime">
						25 Oct 2015, 10:14					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>RangerZ wrote:</cite><blockquote><p>I have learned that I can set a DSN on the LAN side.&nbsp; What does this do, if anything?&nbsp; Do I want this?</p></blockquote></div><p>I don&#039;t think putting it in the lan config of /etc/config/network will do anything.</p><p>The clients on your network don&#039;t query the DNS servers you set up in the &quot;wan&quot; config directly.&nbsp; When they request an IP via DHCP they are also supplied a list of name servers but, by default, this list of name servers only points to the router (you can have dnsmasq return a list of external DNS servers instead of itself during DHCP responses, but that will break name resolution of hosts on the local network).</p><p>The computer sends a DNS request to the router and then dnsmasq on the router uses its own list of nameservers (the ones you defined in /etc/config/network or the peer DNS sent by your ISP) from /tmp/resolv.conf.auto to make the request and return the answer to you.</p><div class="quotebox"><blockquote><p>Where does DNSMASQ actually stores its data (cache), and how do I view this?</p></blockquote></div><p>When you restart dnsmasq OpenWrt builds a dnsmasq.conf file from the config data in /etc/config/dhcp.&nbsp; This rebuilt file is in /tmp/etc/dnsmasq.conf.&nbsp; </p><p>I don&#039;t know where dnsmasq actually caches returned DNS queries.</p><p>dnsmasq is an <a href="https://web.archive.org/web/20150905110928/http://www.linuxjournal.com/content/dnsmasq-pint-sized-super-d%C3%A6mon">extremely powerful</a> tool that is often over-looked.&nbsp; On my own network i have it doing DHCP for multiple subnets each with their own subdomain, DNS-SD to advertise services, CNAMEs for local machines, Google DNS for most domains but OpenNIC for their custom TLDs, and Ad-blocking at the DNS-Level.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297378">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						25 Oct 2015, 18:18					</div>
				</div>
				<div class="post-content content">
					<p>Thank you for the reply</p><p>So if I understand, this is basically why I see my routers IP on the clients (DNS Servers) when I do an ipconfig /all.&nbsp; It&#039;s relaying to the WAN side DNS config.</p><p>The real problem, and point of the post was to share the problems I encountered trying to get the right config into the /tmp/resolv.conf.auto.&nbsp; One post I saw on DNSCrypt said to disable the line pointing to the file (can be done in Luci) but this still seem to be processed. (DHCP and DNS =&gt; Resolv and Hosts File =&gt; Ignore Resolve File checkbox for those interested)</p><p>Reading the article you referenced, it talks about the DNSMASQ.CONF file, but mine is empty.&nbsp; All the related config is in DHCP and NETWORK.&nbsp; I even added some servers to the DNSMASQ.CONF file, but they did not make their way into the resolv.conf.auto.&nbsp; Not sure what is a bug or just lack of understanding/docu.&nbsp; It seems DNSMASQ should be configured through this file.</p><p>The article also references the \etc\hosts file.&nbsp; I am running an OpenVPN server on this device, and having issues with the clients not reliably browsing the Windows Network.&nbsp; I can get to any device by IP, and generally I know the few I need, but I would rather browse.&nbsp; Can I take advantage of this file (toolset) to help with this issue?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297403">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">Middling</div>
					<div class="post-datetime">
						25 Oct 2015, 21:14					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>RangerZ wrote:</cite><blockquote><p>Thank you for the reply</p><p>So if I understand, this is basically why I see my routers IP on the clients (DNS Servers) when I do an ipconfig /all.&nbsp; It&#039;s relaying to the WAN side DNS config.</p></blockquote></div><p>Yes, dnsmasq sits in between.</p><div class="quotebox"><blockquote><p>The real problem, and point of the post was to share the problems I encountered trying to get the right config into the /tmp/resolv.conf.auto.&nbsp; One post I saw on DNSCrypt said to disable the line pointing to the file (can be done in Luci) but this still seem to be processed. (DHCP and DNS =&gt; Resolv and Hosts File =&gt; Ignore Resolve File checkbox for those interested)</p></blockquote></div><p>As you discovered, the /tmp/resolv.conf.auto file is generated by the settings for your &quot;wan&quot; interface in /etc/config/network.</p><p>If you don&#039;t define any dns servers it will use the ones supplied by your ISP.&nbsp; If you define some, like so</p><div class="codebox"><pre><code>    option dns &#039;8.8.8.8 8.8.4.4&#039;</code></pre></div><p>then it will use the name servers you defined <strong>and</strong> the ones supplied by your ISP.</p><p>Adding</p><div class="codebox"><pre><code>    option peerdns &#039;0&#039;</code></pre></div><p>will make it use <strong>only</strong> your defined name servers, ignoring your ISP supplied DNS.</p><p>If you have IPv6 connectivity your &quot;wan6&quot; interface can also have its own IPv6 DNS servers set in a similar manner.</p><div class="codebox"><pre><code>    option dns &#039;2001:4860:4860::8888 2001:4860:4860::8844&#039;
    option peerdns &#039;0&#039;</code></pre></div><p>(all these servers in my example are for Google&#039;s Public DNS).</p><p>I&#039;ve never used DNSCrypt but the <a href="http://wiki.openwrt.org/inbox/dnscrypt">page</a> seems fairly simple.</p><div class="quotebox"><blockquote><p>Reading the article you referenced, it talks about the DNSMASQ.CONF file, but mine is empty.&nbsp; All the related config is in DHCP and NETWORK.&nbsp; I even added some servers to the DNSMASQ.CONF file, but they did not make their way into the resolv.conf.auto.&nbsp; Not sure what is a bug or just lack of understanding/docu.&nbsp; It seems DNSMASQ should be configured through this file.</p></blockquote></div><p>OpenWrt regenerates its own dnsmasq.conf file (stored as /tmp/etc/dnsmasq.conf) from the settings in /etc/config/dhcp.&nbsp; /etc/dnsmasq.conf <strong>can</strong> be used for additional configuration, but /tmp/etc/dnsmasq.conf is used first.&nbsp; Just use the &quot;wan&quot; interface as above for your DNS servers.</p><div class="quotebox"><blockquote><p>The article also references the \etc\hosts file.&nbsp; I am running an OpenVPN server on this device, and having issues with the clients not reliably browsing the Windows Network.&nbsp; I can get to any device by IP, and generally I know the few I need, but I would rather browse.&nbsp; Can I take advantage of this file (toolset) to help with this issue?</p></blockquote></div><p>Windows Network Browsing doesn&#039;t use standard DNS, but the weird-ass Netbios so this won&#039;t help with that, but because dnsmasq is doing your DHCP you should be able to access machines by the name they register (either the raw name, or name.domain where .domain is what you set in /etc/config/dhcp).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297426">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">frietpan</div>
					<div class="post-datetime">
						26 Oct 2015, 00:40					</div>
				</div>
				<div class="post-content content">
					<p>A few days ago i came across this post <a href="http://www.techrepublic.com/blog/linux-and-open-source/using-dnsmasq-for-dns-and-dhcp-services/">http://www.techrepublic.com/blog/linux- … -services/</a>&nbsp; it helped me a bit to get started.&nbsp; I have subscribed to this topic. I hope to learn more about dnsmasq too.</p><p>the manpage is HUGE <a href="http://www.thekelleys.org.uk/dnsmasq/docs/dnsmasq-man.html">http://www.thekelleys.org.uk/dnsmasq/do … q-man.html</a><br />but it&#039;s not clear how to use all that info. </p><p>Does anyone know if there is an official manual? (other then the manpage)</p><p>Maybe this can also be used in the documentation:<br /><a href="https://www.linux.com/learn/tutorials/516220-dnsmasq-for-easy-lan-name-services">https://www.linux.com/learn/tutorials/5 … e-services</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297473">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">Middling</div>
					<div class="post-datetime">
						26 Oct 2015, 12:41					</div>
				</div>
				<div class="post-content content">
					<p>By default dnsmasq will take the hostname your client computer gives it during the DHCP process and then add the domain name you defined in /etc/config/dhcp, allowing any other machine on the network to access the client by name.</p><p>If the client doesn&#039;t give dnsmasq its own name or you want to give it a different name it&#039;s possible.&nbsp; Here&#039;s a snippet of my /etc/config/dhcp to illustrate:</p><div class="codebox"><pre><code>config dnsmasq
        option domainneeded &#039;1&#039;
        option boguspriv &#039;1&#039;
        option localise_queries &#039;1&#039;
        option rebind_protection &#039;1&#039;
        option rebind_localhost &#039;1&#039;
        option expandhosts &#039;1&#039;
        option authoritative &#039;1&#039;
        option leasefile &#039;/tmp/dhcp.leases&#039;
        option resolvfile &#039;/tmp/resolv.conf.auto&#039;
        option local &#039;/lan.example.org/&#039;
        option domain &#039;lan.example.org&#039;

config dhcp &#039;lan&#039;
        option interface &#039;lan&#039;
        option leasetime &#039;12h&#039;
        option dhcpv6 &#039;server&#039;
        option ra &#039;server&#039;
        option start &#039;201&#039;
        option limit &#039;50&#039;
        option ra_management &#039;1&#039;

config host
        option name &#039;orange&#039;
        option mac &#039;b6:fc:6d:51:bf:4f&#039;
        option ip &#039;192.168.0.51&#039;

config host
        option name &#039;orange&#039;
        option mac &#039;9a:07:f1:ba:53:cc&#039;
        option ip &#039;192.168.0.52&#039;</code></pre></div><p>In the example above the machine called &#039;orange&#039; has two entries, with different MAC addresses and reserved IPs (one for wifi and one for ethernet).&nbsp; Connect the machine to the network and it gets the relevant IP for the interface and becomes accessible to other machines on the network as <em>orange.lan.example.org</em>.&nbsp; If both wifi and ethernet are connected at the same time then orange.lan.example.org goes to which ever interface connected most recently.</p><p>Because dnsmasq only adds an entry to the DNS when a DHCP lease is created and you might reboot your router between lease renewals it&#039;s best to make sure that any servers on your network are always resolvable.&nbsp; You can set these in /etc/hosts or use &quot;config domain&quot; (which OpenWrt uses to generate its own /tmp/hosts/dhcp in the same format as /etc/hosts and dnsmasq uses first):</p><p>/etc/config/dhcp<br /></p><div class="codebox"><pre><code>config host
        option name &#039;files&#039;
        option mac &#039;06:4a:e5:63:cb:14&#039;
        option ip &#039;192.168.0.10&#039;

config domain
        option name &#039;files&#039;
        option ip &#039;192.168.0.10&#039;</code></pre></div><p>Now <em>files.lan.example.org</em> will always resolve.</p><p>Say we&#039;re designing a new version of the website <a href="http://www.example.com">www.example.com</a>, so we install a webserver onto our files.lan.example.org machine and redirect <a href="http://www.example.com">www.example.com</a> to it for just people on our network to test out the new design.</p><p>/etc/config/dhcp<br /></p><div class="codebox"><pre><code>config cname
        option cname &#039;www.example.com&#039;
        option target &#039;files.lan.example.org&#039;</code></pre></div><p>All this won&#039;t help the OP with his Windows Network Browsing problem, but it should let him address machines by a known or defined name instead of having to remember IPs.&nbsp; Running a <a href="https://technet.microsoft.com/en-us/library/cc781189(v=ws.10).aspx">WINS</a> server and announcing it via DHCP </p><div class="codebox"><pre><code>config dhcp &#039;lan&#039;
        option interface &#039;lan&#039;
        option leasetime &#039;12h&#039;
        option dhcpv6 &#039;server&#039;
        option ra &#039;server&#039;
        option start &#039;201&#039;
        option limit &#039;50&#039;
        option ra_management &#039;1&#039;
# The following announces the IP address of your WINS server.
# Adjust to match server&#039;s IP
        list dhcp_option &#039;44,192.168.0.10&#039;</code></pre></div><p><em>might</em> help with Windows Network Browser but Windows is something i&#039;ve successfully avoided using for the past 15 years so can&#039;t say for sure.</p>											<p class="post-edited">(Last edited by <strong>Middling</strong> on 26 Oct 2015, 16:20)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297485">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						26 Oct 2015, 15:33					</div>
				</div>
				<div class="post-content content">
					<p>@Middling, I would like to thank you for taking the time to write a detailed and comprehensive response to this post.&nbsp; </p><p>I understand much, but not all of this.&nbsp; I will do some testing and more reading.&nbsp; </p><p>My option local and option domain is the default &quot;lan&quot;.&nbsp; I assume I can just use the [device].lan.&nbsp; I will test this next time I am on the road.</p><p>What I was really hoping to accomplish is to be able to use the file browser and just &quot;click&quot; my way through the network shares, so while the above is easier than remembering the IP, it still relies on recall.&nbsp; I guess this is more Samba related, but it&#039;s a nice to have.&nbsp; I can just create a short cut to the IP to address this.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297492">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">frietpan</div>
					<div class="post-datetime">
						26 Oct 2015, 16:09					</div>
				</div>
				<div class="post-content content">
					<p>thanks midding for the educational post. </p><p>@RangerZ<br />For WINS / NETBIOS you need Samba<br /><a href="http://wiki.openwrt.org/doc/howto/cifs.server?s">http://wiki.openwrt.org/doc/howto/cifs.server?s</a>[]=wins</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297494">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">Middling</div>
					<div class="post-datetime">
						26 Oct 2015, 16:20					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>RangerZ wrote:</cite><blockquote><p>My option local and option domain is the default &quot;lan&quot;.&nbsp; I assume I can just use the [device].lan.&nbsp; I will test this next time I am on the road.</p></blockquote></div><p>Yeah, [device].lan by default.&nbsp; You can set it to whatever you want and i usually prefer to use something within a domain i own.</p><div class="quotebox"><blockquote><p>What I was really hoping to accomplish is to be able to use the file browser and just &quot;click&quot; my way through the network shares, so while the above is easier than remembering the IP, it still relies on recall.&nbsp; I guess this is more Samba related, but it&#039;s a nice to have.&nbsp; I can just create a short cut to the IP to address this.</p></blockquote></div><p>If you&#039;re running Samba somewhere on your network it&#039;s really easy to get it working as a WINS server.&nbsp; Simply add</p><div class="codebox"><pre><code>wins support = yes</code></pre></div><p>to your Samba config and restart it.</p><p>Then add the dhcp_option listed in my earlier post to your OpenWrt&#039;s /etc/config/dhcp file and restart dnsmasq.</p><p>The next time your local Windows machines connect and do a DHCP request they will be informed there&#039;s a WINS server on the network and register their names with it.</p><p>I suspect that your network browsing problem is with your OpenVPN config, especially if machines connected to your VPN are on a different subnet.&nbsp; From <a href="https://forums.openvpn.net/topic12832.html">this thread</a> it looks like adding</p><div class="codebox"><pre><code>push &quot;dhcp-option WINS 192.168.0.10&quot;</code></pre></div><p>to your OpenVPN server.conf file will supply the WINS server address to VPN-connected clients.&nbsp; They should then register their addresses with the WINS server and all Windows machines, local and VPN, should query the WINS server for details of Network Browsable machines.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297500">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						26 Oct 2015, 17:18					</div>
				</div>
				<div class="post-content content">
					<p>I am not totally following the WINS server.&nbsp; </p><p>Do I need to install any software to perform this or is it part of samba (already installed)?</p><div class="codebox"><pre><code># The following announces the IP address of your WINS server.
# Adjust to match server&#039;s IP
        list dhcp_option &#039;44,192.168.0.10&#039;</code></pre></div><p>Is this IP my routers LAN IP (192.168.111.1)?&nbsp; If not where do I get it?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297507">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">Middling</div>
					<div class="post-datetime">
						26 Oct 2015, 18:31					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>RangerZ wrote:</cite><blockquote><p>I am not totally following the WINS server.&nbsp; </p><p>Do I need to install any software to perform this or is it part of samba (already installed)?</p></blockquote></div><p>It&#039;s part of Samba, just not enabled by default.&nbsp; In your smb.conf file, under the [global] section add<br /></p><div class="codebox"><pre><code>wins support = yes</code></pre></div><p>to enable it.</p><p>Some places online suggest you want a few extra options to ensure Windows XP and later register with the WINS server.</p><div class="codebox"><pre><code>wins support = Yes
os level = 99
domain master = yes
preferred master = yes</code></pre></div><p>If you&#039;re using FreeNAS instead of running Samba on a server directly the above goes in the &quot;Auxiliary parameters&quot; box in your &quot;CIFS Settings&quot;.</p><div class="quotebox"><blockquote><div class="codebox"><pre><code># The following announces the IP address of your WINS server.
# Adjust to match server&#039;s IP
        list dhcp_option &#039;44,192.168.0.10&#039;</code></pre></div><p>Is this IP my routers LAN IP (192.168.111.1)?&nbsp; If not where do I get it?</p></blockquote></div><p>It&#039;s the IP of your Samba server.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297532">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						26 Oct 2015, 21:10					</div>
				</div>
				<div class="post-content content">
					<p>So going back through the above, I think I want to make the following changes:<br /></p><div class="codebox"><pre><code>smb.conf.template (per Samba wiki)
[global] 
    wins support = Yes
    os level = 99
    domain master = yes
    preferred master = yes

dhcp.conf
config dhcp &#039;lan&#039;
    # The following announces the IP address of your WINS server.
    # Adjust to match server&#039;s IP
    list dhcp_option &#039;44,192.168.111.1&#039;

OpenVPN Server Config
    push &quot;dhcp-option WINS 192.168.111.1&quot;</code></pre></div><p>For the follow on-readers, the &#039;list dhcp-option&quot; is noted here:<br /><a href="http://wiki.openwrt.org/doc/howto/cifs.server">http://wiki.openwrt.org/doc/howto/cifs.server</a> which uses the 44<br /><a href="http://wiki.openwrt.org/doc/uci/dhcp#dhcp_option_example_to_set_an_alternative_default_gateway">http://wiki.openwrt.org/doc/uci/dhcp#dh … lt_gateway</a> which explains DHCP parameters and some other examples<br /><a href="http://www.networksorcery.com/enp/protocol/bootp/options.htm">http://www.networksorcery.com/enp/proto … ptions.htm</a> and here which lists possible values for the list dhcp_options.&nbsp; 44 is &quot;NetBIOS over TCP/IP name server&quot;, which now seems obvious.</p><p>Reading up on the OS level values <a href="https://www.samba.org/samba/docs/using_samba/ch07.html">here</a> I see you are recommending the value be moved from its current value of 20 to 99, which makes it the highest priority on the LAN (to the best of my knowledge). I have every device on my LAN configured with a static IP on this device, so I can always properly see the host name.&nbsp; I do have a Synology NAS, and not sure it it is relevant. So, this would move the basic function of browsing control from the individual machine to the routers new WINS server.&nbsp; Please correct my semantics.</p><p>Looking at your DHCP snippet above, I see you do not have the line<br /></p><div class="codebox"><pre><code>    option readethers &#039;1&#039;</code></pre></div><p>which I think is the default.&nbsp; Any relevant reason?&nbsp; I see my \etc\ethers is empty, so I guess it&#039;s ignored.&nbsp; I do see all my static IPs in the /tmp/etc/dnsmasq.conf</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297555">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">Middling</div>
					<div class="post-datetime">
						27 Oct 2015, 00:33					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>RangerZ wrote:</cite><blockquote><p>So going back through the above, I think I want to make the following changes:</p></blockquote></div><p>Looks good.&nbsp; Theoretically this should work, but i&#039;ve just spent a few hours unsuccessfully trying to get network browsing working across subnets.</p><p>The WINS server seems to work fine and, thanks to the DHCP option, clients in both subnets register their names with it.&nbsp; Once i <a href="http://www.npcglib.org/~stathis/blog/2013/02/18/windows-task-sharing-files-across-different-subnets/">modified the Windows firewall</a> i was able to access machines in the other subnet using \\machine-name but they still didn&#039;t populate the Network view.</p><p>I suspect it <em>may</em> be due to Master Browser Elections.&nbsp; For some reason as soon as a Windows machine came up in the same subnet as the Samba server it would start an election to become the network&#039;s master browser, and Samba would lose EVERY SINGLE TIME.&nbsp; I even tried upping the &quot;os level&quot; to 255, but Samba still lost.</p><p>I&#039;m stuck, and the whole thing just served to remind me how much i dislike trying to do anything on Windows. ^_^</p><p>You might be better served asking on the Samba mailing list.&nbsp; Sorry i couldn&#039;t help solve this one.</p><div class="quotebox"><blockquote><p>I do have a Synology NAS, and not sure it it is relevant.</p></blockquote></div><p>It&#039;s probably running a version of Samba too, so it might be worth seeing if WINS can be enabled on that and save yourself having to run it on the router.</p><div class="quotebox"><blockquote><p>Looking at your DHCP snippet above, I see you do not have the line<br /></p><div class="codebox"><pre><code>    option readethers &#039;1&#039;</code></pre></div><p>which I think is the default.&nbsp; Any relevant reason?&nbsp; I see my \etc\ethers is empty, so I guess it&#039;s ignored.&nbsp; I do see all my static IPs in the /tmp/etc/dnsmasq.conf</p></blockquote></div><p>At one point i did configure some things in /etc/ethers but IIRC it wasn&#039;t included in the configuration backup and i got bit when i wiped the router and attempted to reload my config.&nbsp; These days i configure most dnsmasq stuff in /etc/config/dhcp with a handful of extra /etc/dnsmasq.conf.whatever files for extras.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297561">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						27 Oct 2015, 01:35					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for all your help.&nbsp; I will proceed with caution.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297602">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">Middling</div>
					<div class="post-datetime">
						27 Oct 2015, 12:14					</div>
				</div>
				<div class="post-content content">
					<p>Success!</p><p>I switched from using the Samba server on my FreeNAS to the package for OpenWrt.&nbsp; I don&#039;t know if it&#039;s a bug in Samba 4.x that causes it to lose the browser election process or what, but the Samba 3.6.x package for OpenWrt does win if configured correctly.</p><p>Here&#039;s a howto:</p><p>Install the Samba server on your OpenWrt:</p><div class="codebox"><pre><code>opkg update
opkg install samba36-server</code></pre></div><p>Edit /etc/config/samba </p><div class="codebox"><pre><code>config samba
    option &#039;name&#039;            &#039;OpenWrt&#039;
    option &#039;workgroup&#039;        &#039;WORKGROUP&#039;
    option &#039;description&#039;        &#039;WINS server&#039;
# Not doing any file sharing on this Samba server so disable homes.
    option &#039;homes&#039;            &#039;0&#039;
# Make sure all the interfaces you want are listed.  I have wired, 2.4GHz wifi, and
# 5GHz wifi on different subnets and i&#039;m excluding my guest wifi.  Also include the
# loopback interface.
    option interface &#039;lo lan wifi5_priv wifi_priv&#039;</code></pre></div><p>Edit /etc/samba/smb.conf.template to enable WINS and up the os level.</p><div class="codebox"><pre><code>[global]
    netbios name = |NAME| 
    display charset = |CHARSET|
    interfaces = |INTERFACES|
    server string = |DESCRIPTION|
    unix charset = |CHARSET|
    workgroup = |WORKGROUP|
# This server just does WINS and local/domain master browser duties
# so it doesn&#039;t need to appear in network browse lists.
    browseable = no
    deadtime = 30
    domain master = yes
    encrypt passwords = true
    enable core files = no
    guest account = nobody
    guest ok = yes
    invalid users = root
    local master = yes
    load printers = no
    map to guest = Bad User
    max protocol = SMB2
    min receivefile size = 16384
    null passwords = yes
    obey pam restrictions = yes
# Increase the &quot;os level&quot; so this server always wins local master elections
    os level = 255
    passdb backend = smbpasswd
    preferred master = yes
    printable = no
    security = user
    smb encrypt = disabled
    smb passwd file = /etc/samba/smbpasswd
    socket options = TCP_NODELAY IPTOS_LOWDELAY
    syslog = 2
    use sendfile = yes
    writeable = yes
# Add the following two lines to enable WINS and name resolution
    wins support = yes    
    name resolve order = wins lmhosts hosts bcast</code></pre></div><p>Restart Samba</p><div class="codebox"><pre><code>/etc/init.d/samba restart</code></pre></div><p>Edit your /etc/config/dhcp and make sure you&#039;re sending your router&#039;s lan IP as the WINS server:</p><div class="codebox"><pre><code>config dhcp &#039;lan&#039;
    # The following announces the IP address of your WINS server.
    # Adjust to match server&#039;s IP
    list dhcp_option &#039;44,192.168.111.1&#039;</code></pre></div><p>Do the same for your OpenVPN config.</p><p>Restart dnsmasq and OpenVPN.</p><p>Reconnect a machine to the network so it does another DHCP request.</p><p>All your machines, from multiple subnets, should now appear in the Network section of Explorer.</p><p>I tested this across multiple subnets using Windows 7 VMs, an old Windows Vista laptop and Linux.&nbsp; All seems to be working fine.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297619">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						27 Oct 2015, 14:25					</div>
				</div>
				<div class="post-content content">
					<p>Thanks again for the followup.&nbsp; </p><p>I am only running a single subnet.&nbsp; How can I test that Samba is in control over Windows?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297622">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">Middling</div>
					<div class="post-datetime">
						27 Oct 2015, 15:16					</div>
				</div>
				<div class="post-content content">
					<p>Open a command prompt on Windows and run</p><div class="codebox"><pre><code>nbtstat -a netbiosname-of-router</code></pre></div><p>If the response contains a line beginning</p><div class="codebox"><pre><code>..__MSBROWSE__.</code></pre></div><p>then it&#039;s the local master browser.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297624">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						27 Oct 2015, 15:54					</div>
				</div>
				<div class="post-content content">
					<p>I have done no new config as yet and get the following.&nbsp; What is this telling me?<br /></p><div class="codebox"><pre><code>GB CT Adapter:
Node IpAddress: [192.168.111.53] Scope Id: []

           NetBIOS Remote Machine Name Table

       Name               Type         Status
    ---------------------------------------------
    OPENWRT        &lt;00&gt;  UNIQUE      Registered
    OPENWRT        &lt;03&gt;  UNIQUE      Registered
    OPENWRT        &lt;20&gt;  UNIQUE      Registered
    WORKGROUP      &lt;1B&gt;  UNIQUE      Registered
    WORKGROUP      &lt;1E&gt;  GROUP       Registered
    WORKGROUP      &lt;00&gt;  GROUP       Registered

    MAC Address = 00-00-00-00-00-00</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297642">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">wzhang</div>
					<div class="post-datetime">
						27 Oct 2015, 19:24					</div>
				</div>
				<div class="post-content content">
					<p>Create a new file /etc/resolv.conf.opendns with the following content (OpenDNS)</p><p>nameserver 208.67.222.222<br />nameserver 208.67.220.220</p><p>Change option resolvfile &#039;/tmp/resolv.conf.auto&#039; to option resolvfile &#039;/tmp/resolv.conf.opendns&#039; in /etc/config/dhcp.&nbsp; &nbsp;</p><p>Reboot the router.</p><p>Your local machine names should still work since it&#039;s just changing the upstream DNS to OpenDNS.</p>											<p class="post-edited">(Last edited by <strong>wzhang</strong> on 27 Oct 2015, 19:25)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297644">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">Middling</div>
					<div class="post-datetime">
						27 Oct 2015, 19:42					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>RangerZ wrote:</cite><blockquote><p>I have done no new config as yet and get the following.&nbsp; What is this telling me?</p></blockquote></div><p>I think it&#039;s just saying that OpenWrt exists as a NetBIOS host on the network and can be accessed at \\OpenWrt.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297674">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						27 Oct 2015, 23:14					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Middling wrote:</cite><blockquote><p>Open a command prompt on Windows and run</p><div class="codebox"><pre><code>nbtstat -a netbiosname-of-router</code></pre></div><p>If the response contains a line beginning</p><div class="codebox"><pre><code>..__MSBROWSE__.</code></pre></div><p>then it&#039;s the local master browser.</p></blockquote></div><p>I guess as I had not configured anything I expected to see the MSBROWSE in the nbtstat response.</p><p>I have had some business come up and will probably not get back to this for a few days or more.</p><p>Thanks again!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p297677">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">RangerZ</div>
					<div class="post-datetime">
						27 Oct 2015, 23:19					</div>
				</div>
				<div class="post-content content">
					<p>@wzhang, I had not tried a new file, but the /tmp/resolv.conf.auto kept inheriting the DNS from my ISP after each reboot.&nbsp; The secret was to disable the Use DNS servers advertised by peer check box, and then I could edit the DNS entries directly in LuCi.&nbsp; </p><p>I am using the L3 DNS servers, as some reading I did led me to believe they are fastest.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>