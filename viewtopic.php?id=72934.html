<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> OpenVPN client problem when wan IP change</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 21 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p370490">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">thanosz</div>
					<div class="post-datetime">
						5 Jan 2018, 09:23					</div>
				</div>
				<div class="post-content content">
					<p>Hello,<br />I am using Chaos Calmer on a tplink-wdr3600 router which connects to the internet through an ADSL modem using pppoe (bridged mode).</p><p>I have also setup the router to be an OpenVPN client in order to redirect all traffic to a private VPN service. </p><p>This works OK. The problem is when the Internet provider forces a change of my public IP. In this case connectivity is lost, the router cannot ping public ip addresses and the only way to restore this is to restart the openvpn connection (/etc/init.d/openvpn restart).</p><p>This seems to be a routing problem but I cannot figure out how to fix it without restarting the openvpn service.</p><p>Here is what happens when I stop and start the WAN (pppoe-wan) interface which results in a public IP change:</p><p>Fri Jan&nbsp; 5 07:46:47 2018 daemon.info pppd[22923]: Terminating on signal 15<br />Fri Jan&nbsp; 5 07:46:47 2018 daemon.info pppd[22923]: Connect time 480.5 minutes.<br />Fri Jan&nbsp; 5 07:46:47 2018 daemon.info pppd[22923]: Sent 63767325 bytes, received 386872459 bytes.<br />Fri Jan&nbsp; 5 07:46:47 2018 daemon.notice netifd: Network device &#039;pppoe-wan&#039; link is down<br />Fri Jan&nbsp; 5 07:46:48 2018 daemon.notice pppd[22923]: Connection terminated.<br />Fri Jan&nbsp; 5 07:46:48 2018 daemon.info pppd[22923]: Sent PADT<br />Fri Jan&nbsp; 5 07:46:48 2018 daemon.info pppd[22923]: Exit.<br />Fri Jan&nbsp; 5 07:46:48 2018 daemon.notice netifd: Interface &#039;wan&#039; is now down<br />Fri Jan&nbsp; 5 07:46:48 2018 daemon.warn dnsmasq[28417]: no servers found in /tmp/resolv.conf.auto, will retry<br />Fri Jan&nbsp; 5 07:46:48 2018 user.notice ddns-scripts[23033]: myddns_ipv4: PID &#039;23033&#039; terminated by &#039;SIGTERM&#039; at 2018-01-05 07:46<br />Fri Jan&nbsp; 5 07:46:48 2018 user.notice ddns-scripts[23034]: dynu: PID &#039;23034&#039; terminated by &#039;SIGTERM&#039; at 2018-01-05 07:46<br />Fri Jan&nbsp; 5 07:46:52 2018 daemon.notice netifd: Interface &#039;wan&#039; is setting up now<br />Fri Jan&nbsp; 5 07:46:52 2018 daemon.info pppd[31225]: Plugin rp-pppoe.so loaded.<br />Fri Jan&nbsp; 5 07:46:52 2018 daemon.info pppd[31225]: RP-PPPoE plugin version 3.8p compiled against pppd 2.4.7<br />Fri Jan&nbsp; 5 07:46:52 2018 daemon.notice pppd[31225]: pppd 2.4.7 started by root, uid 0<br />Fri Jan&nbsp; 5 07:46:52 2018 daemon.info pppd[31225]: PPP session is 570<br />Fri Jan&nbsp; 5 07:46:52 2018 daemon.warn pppd[31225]: Connected to 00:90:1a:a3:fa:ff via interface eth0.2<br />Fri Jan&nbsp; 5 07:46:52 2018 daemon.info pppd[31225]: Using interface pppoe-wan<br />Fri Jan&nbsp; 5 07:46:52 2018 daemon.notice pppd[31225]: Connect: pppoe-wan &lt;--&gt; eth0.2<br />Fri Jan&nbsp; 5 07:46:52 2018 kern.info kernel: [77929.800000] pppoe-wan: renamed from ppp0<br />Fri Jan&nbsp; 5 07:46:52 2018 daemon.notice pppd[31225]: PAP authentication succeeded<br />Fri Jan&nbsp; 5 07:46:52 2018 daemon.notice pppd[31225]: peer from calling number 00:90:1A:A3:FA:FF authorized<br />Fri Jan&nbsp; 5 07:46:53 2018 daemon.notice pppd[31225]: local&nbsp; IP address 176.58.xx.xx<br />Fri Jan&nbsp; 5 07:46:53 2018 daemon.notice pppd[31225]: remote IP address 62.169.xx.xx<br />Fri Jan&nbsp; 5 07:46:53 2018 daemon.notice pppd[31225]: primary&nbsp; &nbsp;DNS address 62.169.xx.xx<br />Fri Jan&nbsp; 5 07:46:53 2018 daemon.notice pppd[31225]: secondary DNS address 212.152.xx.xx<br />Fri Jan&nbsp; 5 07:46:53 2018 daemon.notice netifd: Network device &#039;pppoe-wan&#039; link is up<br />Fri Jan&nbsp; 5 07:46:53 2018 daemon.notice netifd: Interface &#039;wan&#039; is now up<br />Fri Jan&nbsp; 5 07:46:53 2018 daemon.info dnsmasq[28417]: reading /tmp/resolv.conf.auto<br />Fri Jan&nbsp; 5 07:46:53 2018 daemon.info dnsmasq[28417]: using nameserver 208.67.222.222#53<br />Fri Jan&nbsp; 5 07:46:53 2018 daemon.info dnsmasq[28417]: using nameserver 45.76.95.185#53<br />Fri Jan&nbsp; 5 07:46:53 2018 daemon.info dnsmasq[28417]: using nameserver 172.25.4.22#53 for domain intranet.unify.com<br />Fri Jan&nbsp; 5 07:46:53 2018 daemon.info dnsmasq[28417]: using nameserver 172.25.4.22#53 for domain global-intra.net<br />Fri Jan&nbsp; 5 07:46:53 2018 daemon.info dnsmasq[28417]: using nameserver 172.25.4.22#53 for domain global-ad.net<br />Fri Jan&nbsp; 5 07:46:53 2018 daemon.info dnsmasq[28417]: using local addresses only for domain lan<br />Fri Jan&nbsp; 5 07:46:53 2018 daemon.info dnsmasq[28417]: using nameserver 62.169.xx.xx#53<br />Fri Jan&nbsp; 5 07:46:53 2018 daemon.info dnsmasq[28417]: using nameserver 212.152.xx/xx#53<br />Fri Jan&nbsp; 5 07:46:54 2018 user.notice firewall: Reloading firewall due to ifup of wan (pppoe-wan)<br />Fri Jan&nbsp; 5 07:46:54 2018 daemon.err openvpn(vpnarea)[23302]: write UDPv4: Operation not permitted (code=1)<br />Fri Jan&nbsp; 5 07:46:54 2018 daemon.err openvpn(vpnarea)[23302]: write UDPv4: Operation not permitted (code=1)<br />Fri Jan&nbsp; 5 07:46:54 2018 daemon.err openvpn(vpnarea)[23302]: write UDPv4: Operation not permitted (code=1)<br />Fri Jan&nbsp; 5 07:46:54 2018 daemon.err openvpn(vpnarea)[23302]: write UDPv4: Operation not permitted (code=1)<br />Fri Jan&nbsp; 5 07:46:54 2018 daemon.err openvpn(vpnarea)[23302]: write UDPv4: Operation not permitted (code=1)<br />Fri Jan&nbsp; 5 07:46:54 2018 daemon.err openvpn(vpnarea)[23302]: write UDPv4: Operation not permitted (code=1)<br />Fri Jan&nbsp; 5 07:46:54 2018 daemon.err openvpn(vpnarea)[23302]: write UDPv4: Operation not permitted (code=1)<br />Fri Jan&nbsp; 5 07:46:54 2018 daemon.err openvpn(vpnarea)[23302]: write UDPv4: Operation not permitted (code=1)<br />Fri Jan&nbsp; 5 07:46:54 2018 daemon.err openvpn(vpnarea)[23302]: write UDPv4: Operation not permitted (code=1)<br />Fri Jan&nbsp; 5 07:46:54 2018 daemon.err openvpn(vpnarea)[23302]: write UDPv4: Operation not permitted (code=1)<br />Fri Jan&nbsp; 5 07:46:54 2018 daemon.err openvpn(vpnarea)[23302]: write UDPv4: Operation not permitted (code=1)<br />Fri Jan&nbsp; 5 07:48:03 2018 daemon.notice openvpn(vpnarea)[23302]: TLS: tls_process: killed expiring key<br />Fri Jan&nbsp; 5 07:48:11 2018 daemon.notice openvpn(vpnarea)[23302]: TLS: soft reset sec=0 bytes=166725872/0 pkts=121976/0<br />Fri Jan&nbsp; 5 07:48:47 2018 daemon.notice openvpn(vpnarea)[23302]: [VPNArea] Inactivity timeout (--ping-restart), restarting<br />Fri Jan&nbsp; 5 07:48:47 2018 daemon.notice openvpn(vpnarea)[23302]: TCP/UDP: Closing socket<br />Fri Jan&nbsp; 5 07:48:47 2018 daemon.notice openvpn(vpnarea)[23302]: SIGUSR1[soft,ping-restart] received, process restarting<br />Fri Jan&nbsp; 5 07:48:47 2018 daemon.notice openvpn(vpnarea)[23302]: Restart pause, 2 second(s)<br />Fri Jan&nbsp; 5 07:48:49 2018 daemon.notice openvpn(vpnarea)[23302]: Re-using SSL/TLS context<br />Fri Jan&nbsp; 5 07:48:49 2018 daemon.notice openvpn(vpnarea)[23302]: LZO compression initialized<br />Fri Jan&nbsp; 5 07:48:49 2018 daemon.notice openvpn(vpnarea)[23302]: Control Channel MTU parms [ L:1570 D:138 EF:38 EB:0 ET:0 EL:0 ]<br />Fri Jan&nbsp; 5 07:48:49 2018 daemon.notice openvpn(vpnarea)[23302]: Socket Buffers: R=[163840-&gt;327680] S=[163840-&gt;327680]<br />Fri Jan&nbsp; 5 07:48:49 2018 daemon.notice openvpn(vpnarea)[23302]: Data Channel MTU parms [ L:1570 D:1450 EF:70 EB:135 ET:0 EL:0 AF:3/1 ]<br />Fri Jan&nbsp; 5 07:48:49 2018 daemon.notice openvpn(vpnarea)[23302]: UDPv4 link local: [undef]<br />Fri Jan&nbsp; 5 07:48:49 2018 daemon.notice openvpn(vpnarea)[23302]: UDPv4 link remote: [AF_INET]159.148.xx.xx:443</p><p>You can see that after two minutes, the openvpn service picks up the connectivity loss and tries to reconnect but it seems that the server cannot be reached as the initial packet from server is never received.</p><br /><br /><br /><br /><br /><br /><br /><br /><p>Here is what should be happening instead (i.e. on /etc/init.d/openvpn start)</p><p>Fri Jan&nbsp; 5 07:52:00 2018 daemon.notice openvpn(vpnarea)[32051]: OpenVPN 2.3.6 mips-openwrt-linux-gnu [SSL (OpenSSL)] [LZO] [EPOLL] [MH] [IPv6] built on Jul 25 2015<br />Fri Jan&nbsp; 5 07:52:00 2018 daemon.notice openvpn(vpnarea)[32051]: library versions: OpenSSL 1.0.2g&nbsp; 1 Mar 2016, LZO 2.08<br />Fri Jan&nbsp; 5 07:52:00 2018 daemon.notice openvpn(vpnarea)[32051]: LZO compression initialized<br />Fri Jan&nbsp; 5 07:52:00 2018 daemon.notice openvpn(vpnarea)[32051]: Control Channel MTU parms [ L:1570 D:138 EF:38 EB:0 ET:0 EL:0 ]<br />Fri Jan&nbsp; 5 07:52:00 2018 daemon.notice openvpn(vpnarea)[32051]: Socket Buffers: R=[163840-&gt;131072] S=[163840-&gt;131072]<br />Fri Jan&nbsp; 5 07:52:00 2018 daemon.notice openvpn(vpnarea)[32051]: Data Channel MTU parms [ L:1570 D:1450 EF:70 EB:135 ET:0 EL:0 AF:3/1 ]<br />Fri Jan&nbsp; 5 07:52:00 2018 daemon.notice openvpn(vpnarea)[32051]: NOTE: UID/GID downgrade will be delayed because of --client, --pull, or --up-delay<br />Fri Jan&nbsp; 5 07:52:00 2018 daemon.notice openvpn(vpnarea)[32051]: UDPv4 link local: [undef]<br />Fri Jan&nbsp; 5 07:52:00 2018 daemon.notice openvpn(vpnarea)[32051]: UDPv4 link remote: [AF_INET]159.148.xx.xx:443<br />Fri Jan&nbsp; 5 07:52:00 2018 daemon.notice openvpn(vpnarea)[32051]: TLS: Initial packet from [AF_INET]159.148.xx.xx:443, sid=33d7383b 4a6ee272<br />Fri Jan&nbsp; 5 07:52:00 2018 daemon.warn openvpn(vpnarea)[32051]: WARNING: this configuration may cache passwords in memory -- use the auth-nocache option to prevent this<br />Fri Jan&nbsp; 5 07:52:01 2018 daemon.notice openvpn(vpnarea)[32051]: VERIFY OK: depth=1, C=CH, ST=CH, L=Zurich, O=Offshore Security LTD, OU= , CN=VPNArea, name= , emailAddress=keys@vpnarea.com<br />Fri Jan&nbsp; 5 07:52:01 2018 daemon.notice openvpn(vpnarea)[32051]: VERIFY OK: nsCertType=SERVER<br />Fri Jan&nbsp; 5 07:52:01 2018 daemon.notice openvpn(vpnarea)[32051]: VERIFY OK: depth=0, C=CH, ST=CH, L=Zurich, O=Offshore Security LTD, OU= , CN=VPNArea, name= , emailAddress=keys@vpnarea.com<br />Fri Jan&nbsp; 5 07:52:09 2018 daemon.notice openvpn(vpnarea)[32051]: Data Channel Encrypt: Cipher &#039;AES-256-CBC&#039; initialized with 256 bit key<br />Fri Jan&nbsp; 5 07:52:09 2018 daemon.notice openvpn(vpnarea)[32051]: Data Channel Encrypt: Using 256 bit message hash &#039;SHA256&#039; for HMAC authentication<br />Fri Jan&nbsp; 5 07:52:09 2018 daemon.notice openvpn(vpnarea)[32051]: Data Channel Decrypt: Cipher &#039;AES-256-CBC&#039; initialized with 256 bit key<br />Fri Jan&nbsp; 5 07:52:09 2018 daemon.notice openvpn(vpnarea)[32051]: Data Channel Decrypt: Using 256 bit message hash &#039;SHA256&#039; for HMAC authentication<br />Fri Jan&nbsp; 5 07:52:09 2018 daemon.notice openvpn(vpnarea)[32051]: Control Channel: TLSv1, cipher TLSv1/SSLv3 DHE-RSA-AES256-SHA, 4096 bit RSA<br />Fri Jan&nbsp; 5 07:52:09 2018 daemon.notice openvpn(vpnarea)[32051]: [VPNArea] Peer Connection Initiated with [AF_INET]159.148.xx.xx:443<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: SENT CONTROL [VPNArea]: &#039;PUSH_REQUEST&#039; (status=1)<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: PUSH: Received control message: &#039;PUSH_REPLY,redirect-gateway def1 bypass-dhcp,dhcp-option DNS 208.67.220.220,dhcp-option DNS 208.67.222.222,sndbuf 393216,rcvbuf 393216,route 10.186.35.1,topology net30,ping 10,ping-restart 120,ifconfig 10.186.35.6 10.186.35.5&#039;<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: OPTIONS IMPORT: timers and/or timeouts modified<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: OPTIONS IMPORT: --sndbuf/--rcvbuf options modified<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: Socket Buffers: R=[131072-&gt;327680] S=[131072-&gt;327680]<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: OPTIONS IMPORT: --ifconfig/up options modified<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: OPTIONS IMPORT: route options modified<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: OPTIONS IMPORT: --ip-win32 and/or --dhcp-option options modified<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: TUN/TAP device tun0 opened<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: TUN/TAP TX queue length set to 100<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: do_ifconfig, tt-&gt;ipv6=0, tt-&gt;did_ifconfig_ipv6_setup=0<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice netifd: Interface &#039;vpnarea&#039; is enabled<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice netifd: Network device &#039;tun0&#039; link is up<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice netifd: Interface &#039;vpnarea&#039; has link connectivity <br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice netifd: Interface &#039;vpnarea&#039; is setting up now<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: /sbin/ifconfig tun0 10.186.35.6 pointopoint 10.186.35.5 mtu 1500<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice netifd: Interface &#039;vpnarea&#039; is now up<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: /sbin/route add -net 159.148.xx.xx netmask 255.255.255.255 gw 62.169.xx.xx<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: /sbin/route add -net 0.0.0.0 netmask 128.0.0.0 gw 10.186.35.5<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: /sbin/route add -net 128.0.0.0 netmask 128.0.0.0 gw 10.186.35.5<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: /sbin/route add -net 10.186.35.1 netmask 255.255.255.255 gw 10.186.35.5<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: UID set to nobody<br />Fri Jan&nbsp; 5 07:52:11 2018 daemon.notice openvpn(vpnarea)[32051]: Initialization Sequence Completed<br />Fri Jan&nbsp; 5 07:52:12 2018 user.notice firewall: Reloading firewall due to ifup of vpnarea (tun0)</p><br /><p>Any ideas would be much appreciated</p><p>Thanks</p>											<p class="post-edited">(Last edited by <strong>thanosz</strong> on 5 Jan 2018, 09:28)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>