<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Recommended method for shaping VPN traffic ?</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 5 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p234624">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">kpv</div>
					<div class="post-datetime">
						26 May 2014, 20:16					</div>
				</div>
				<div class="post-content content">
					<p>What is the recommended method for shaping traffic inside a VPN tunnel ? (OpenVPN and IPsec)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p234670">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">qasdfdsaq</div>
					<div class="post-datetime">
						27 May 2014, 02:32					</div>
				</div>
				<div class="post-content content">
					<p>qos-scripts</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p234760">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">kpv</div>
					<div class="post-datetime">
						27 May 2014, 18:22					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>qasdfdsaq wrote:</cite><blockquote><p>qos-scripts</p></blockquote></div><p>I was aware of that package, but based on some preliminary testing it didn&#039;t seem very effective for shaping traffic inside the VPN tunnel, e.g. in a test I performed earlier short RTP VoIP packets sent via an OpenVPN tunnel over UDP/1194 had a latency between 10-230ms. Same with pings over the same tunnel.</p><p>For OpenVPN tunnels, should I add the tunnel interface(s) tun0, tun1 etc to qos-scripts ?</p><p>For IPsec tunnels, should I mark ESP traffic and shape the encrypted traffic on wan ? (but afaik qos-scripts disregards DSCP/ToS bits). Or is there a IPsec tunnel pseudo-device I could use?</p><p>TIA.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p234769">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">qasdfdsaq</div>
					<div class="post-datetime">
						27 May 2014, 19:29					</div>
				</div>
				<div class="post-content content">
					<p>Are you shaping the outgoing traffic over the WAN or the traffic within the tunnel when you had the 10-230ms latency? As you suggest, you do need to use the tun interfaces to shape the traffic, however that&#039;s assuming you have no non-VPN traffic also traversing the link.</p><p>Or are you trying to guarantee QoS for the OpenVPN traffic over other traffic (e.g. unencrypted HTTP) regardless of what is passing through the tunnel?</p><p>And what sort of connection is on the upstream?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p234771">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">kpv</div>
					<div class="post-datetime">
						27 May 2014, 19:46					</div>
				</div>
				<div class="post-content content">
					<p>For my tests I was using a mix of encrypted (ping, voip) and plain traffic (wget, iperf).</p><p>I only shaped the wan interface (not tun/tap/etc), hoping that the qos-scripts rules for reclassifying small sized packets would automatically take care of any encrypted interactive traffic (e.g. ICMP packets, VoIP RTP) sent over wan in encapsulated in UDP packets by OpenVPN.</p><p>Upstream is a 100M/100M LAN connection, shaped to 95/95 (I&#039;m just testing inside my LAN).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p234810">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">qasdfdsaq</div>
					<div class="post-datetime">
						28 May 2014, 01:57					</div>
				</div>
				<div class="post-content content">
					<p>Unfortunately not. QoS based on packet size is dubious at best. Plus the fact that small packets in higher level protocols won&#039;t necessarily translate into small packets when encapsulated in the VPN.</p><p>You could set it to prioritize <em>all</em> traffic over the VPN or otherwise you&#039;d have to shape the tunnel itself. Or nest it.</p>											<p class="post-edited">(Last edited by <strong>qasdfdsaq</strong> on 28 May 2014, 01:57)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>