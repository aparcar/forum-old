<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> IPsec Site-to-Site tunnel up, but traffic only in one direction</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 25 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p253696">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">Ahimoth</div>
					<div class="post-datetime">
						9 Nov 2014, 10:29					</div>
				</div>
				<div class="post-content content">
					<p>Looking for some help here. I&#039;ve been working on this for two days now. Followed the IPsec and Site-to-Site wiki articles, and have tried various different configs and can&#039;t get it past this stage. I tried the firewall.sh script from the OpenWrt wiki, but that threw a bunch of chain/rule not found errors and did not fix the tunnel issue, so have removed that script. Found leftfirewall=yes to help get things moving, but it seems only partially.</p><p>Situation:<br />Machine in Site_A can ping machine in Site_B<br />But, machine in Site_B fails to ping machine in Site_A</p><p>I get the same results for TCP connections, A to B works, but B to A does not.</p><p>Based on the Traceroutes, it seems like packets initiated from Site_B are not routing through the tunnel, and instead just wander out onto the internet.</p><p>Any help would be appreciated.</p><p>Setup:<br />OpenWRT trunk on TP-Link Archer C7<br />Setting up a site to site vpn using strongswan between the openWrt device and an Amazon VPC VPN gateway</p><br /><br /><p>root@OpenWrt:~# cat /etc/ipsec.conf<br /># generated by /etc/init.d/ipsec<br />version 2<br />config setup<br />&nbsp; charondebug = &quot;ike 2,knl 2&quot;<br />conn amazon_ppa-amazon_ppa_lan<br />&nbsp; keyexchange=ikev1<br />&nbsp; left=site_B_public<br />&nbsp; right=site_A_public<br />&nbsp; leftsubnet=192.168.1.0/24<br />&nbsp; authby=psk<br />&nbsp; rightsubnet=10.8.0.0/16<br />&nbsp; auto=start<br />&nbsp; dpdaction=restart<br />&nbsp; dpddelay=10s<br />&nbsp; dpdtimeout=30s<br />&nbsp; leftfirewall=yes<br />&nbsp; esp=aes128-sha1-modp1024!<br />&nbsp; ike=aes128-sha1-modp1024!<br />&nbsp; ikelifetime=28800s<br />&nbsp; type=tunnel<br />&nbsp; </p><p>&nbsp; <br />&nbsp; <br />root@OpenWrt:~# ipsec statusall<br />Status of IKE charon daemon (strongSwan 5.2.1, Linux 3.10.58, mips):<br />&nbsp; uptime: 35 minutes, since Nov 09 07:24:23 2014<br />&nbsp; malloc: sbrk 106496, mmap 0, used 100512, free 5984<br />&nbsp; worker threads: 11 of 16 idle, 5/0/0/0 working, job queue: 0/0/0/0, scheduled: 6<br />&nbsp; loaded plugins: charon aes des sha1 sha2 md5 pem pkcs1 gmp random nonce x509 revocation hmac stroke kernel-netlink socket-default updown attr farp dhcp<br />Listening IP addresses:<br />&nbsp; site_B_public<br />&nbsp; 192.168.1.1<br />Connections:<br />amazon_ppa-amazon_ppa_lan:&nbsp; site_B_public...site_A_public&nbsp; IKEv1, dpddelay=10s<br />amazon_ppa-amazon_ppa_lan:&nbsp; &nbsp;local:&nbsp; [site_B_public] uses pre-shared key authentication<br />amazon_ppa-amazon_ppa_lan:&nbsp; &nbsp;remote: [site_A_public] uses pre-shared key authentication<br />amazon_ppa-amazon_ppa_lan:&nbsp; &nbsp;child:&nbsp; 192.168.1.0/24 === 10.8.0.0/16 TUNNEL, dpdaction=restart<br />Security Associations (1 up, 0 connecting):<br />amazon_ppa-amazon_ppa_lan[1]: ESTABLISHED 35 minutes ago, site_B_public[site_B_public]...site_A_public[site_A_public]<br />amazon_ppa-amazon_ppa_lan[1]: IKEv1 SPIs: xxxxxxxxxxxxxxx_i* xxxxxxxxxxxxxxxxx_r, pre-shared key reauthentication in 7 hours<br />amazon_ppa-amazon_ppa_lan[1]: IKE proposal: AES_CBC_128/HMAC_SHA1_96/PRF_HMAC_SHA1/MODP_1024<br />amazon_ppa-amazon_ppa_lan{1}:&nbsp; INSTALLED, TUNNEL, ESP SPIs: xxxxxxxx_i xxxxxxxx_o<br />amazon_ppa-amazon_ppa_lan{1}:&nbsp; AES_CBC_128/HMAC_SHA1_96, 3192 bytes_i (36 pkts, 117s ago), 2614 bytes_o (33 pkts, 46s ago), rekeying in 10 minutes<br />amazon_ppa-amazon_ppa_lan{1}:&nbsp; &nbsp;192.168.1.0/24 === 10.8.0.0/16</p><p>&nbsp; </p><p>--- From Site_A to Site_B<br />C:\Users\Administrator&gt;tracert 192.168.1.117</p><p>Tracing route to AHIMOTH-DEV [192.168.1.117]<br />over a maximum of 30 hops:</p><p>&nbsp; 1&nbsp; &nbsp; &nbsp;1 ms&nbsp; &nbsp; &nbsp;2 ms&nbsp; &nbsp; &nbsp;1 ms&nbsp; 169.254.249.17<br />&nbsp; 2&nbsp; &nbsp; &nbsp;1 ms&nbsp; &nbsp; &nbsp;1 ms&nbsp; &nbsp; &nbsp;1 ms&nbsp; 169.254.249.25<br />&nbsp; 3&nbsp; &nbsp; 46 ms&nbsp; &nbsp; 49 ms&nbsp; &nbsp; 49 ms&nbsp; 192.168.1.1<br />&nbsp; 4&nbsp; &nbsp; 53 ms&nbsp; &nbsp; 41 ms&nbsp; &nbsp; 42 ms&nbsp; AHIMOTH-DEV [192.168.1.117]</p><p>Trace complete.<br />&nbsp; </p><p>&nbsp; <br />-- From Site_B to Site_A<br />C:\&gt;tracert 10.8.15.233</p><p>Tracing route to 10.8.15.233 over a maximum of 30 hops</p><p>&nbsp; 1&nbsp; &nbsp; &lt;1 ms&nbsp; &nbsp; &lt;1 ms&nbsp; &nbsp; &lt;1 ms&nbsp; 192.168.1.1<br />&nbsp; 2&nbsp; &nbsp; 12 ms&nbsp; &nbsp; 16 ms&nbsp; &nbsp; 18 ms&nbsp; cpe-172-248-64-1.socal.res.rr.com [172.248.64.1]<br />&nbsp; 3&nbsp; &nbsp; 17 ms&nbsp; &nbsp; 13 ms&nbsp; &nbsp; 15 ms&nbsp; 24.30.170.57<br />&nbsp; 4&nbsp; &nbsp; 20 ms&nbsp; &nbsp; 24 ms&nbsp; &nbsp; 15 ms&nbsp; agg33.tustcaft01r.socal.rr.com [72.129.27.66]<br />&nbsp; 5&nbsp; &nbsp; 23 ms&nbsp; &nbsp; 19 ms&nbsp; &nbsp; 18 ms&nbsp; agg1.lsaicaev02v.socal.rr.com [72.129.61.67]<br />&nbsp; 6&nbsp; &nbsp; 15 ms&nbsp; &nbsp; 20 ms&nbsp; &nbsp; 19 ms&nbsp; agg1.lsaicaev04r.socal.rr.com [72.129.55.5]<br />&nbsp; 7&nbsp; &nbsp; 16 ms&nbsp; &nbsp; 21 ms&nbsp; &nbsp; 19 ms&nbsp; tge1-1.lsaicaev06r.socal.rr.com [72.129.55.255]<br />&nbsp; 8&nbsp; &nbsp; 18 ms&nbsp; &nbsp; 18 ms&nbsp; &nbsp; 15 ms&nbsp; 72.129.55.41<br />&nbsp; 9&nbsp; 72.129.55.41&nbsp; reports: Destination net unreachable.</p><p>Trace complete.</p><br /><br /><br /><p>root@OpenWrt:~# route -n<br />Kernel IP routing table<br />Destination&nbsp; &nbsp; &nbsp;Gateway&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Genmask&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Flags Metric Ref&nbsp; &nbsp; Use Iface<br />0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;172.248.64.1&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth0<br />172.248.64.0&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.240.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 eth0<br />192.168.1.0&nbsp; &nbsp; &nbsp;0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 br-lan</p><br /><br /><br /><p>root@OpenWrt:~# cat /etc/config/firewall</p><p>config defaults<br />&nbsp; &nbsp; &nbsp; &nbsp; option syn_flood &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option input &#039;REJECT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option output &#039;REJECT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option forward &#039;REJECT&#039;</p><p>config zone<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list network &#039;lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option input &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option output &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option forward &#039;REJECT&#039;</p><p>config zone<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list network &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list network &#039;wan6&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option output &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option masq &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option mtu_fix &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option input &#039;DROP&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option forward &#039;DROP&#039;</p><p>config zone<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;vpn&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option network &#039; &#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option input &#039;REJECT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option output &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option forward &#039;REJECT&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;Allow-DHCP-Renew&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;udp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest_port &#039;68&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option family &#039;ipv4&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;Allow-Ping&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;icmp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option icmp_type &#039;echo-request&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option family &#039;ipv4&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option enabled &#039;0&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;Allow-DHCPv6&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;udp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src_ip &#039;fe80::/10&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src_port &#039;547&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest_ip &#039;fe80::/10&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest_port &#039;546&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option family &#039;ipv6&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;Allow-ICMPv6-Input&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;icmp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;echo-request&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;echo-reply&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;destination-unreachable&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;packet-too-big&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;time-exceeded&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;bad-header&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;unknown-header-type&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;router-solicitation&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;neighbour-solicitation&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;router-advertisement&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;neighbour-advertisement&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option limit &#039;1000/sec&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option family &#039;ipv6&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;Allow-ICMPv6-Forward&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest &#039;*&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;icmp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;echo-request&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;echo-reply&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;destination-unreachable&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;packet-too-big&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;time-exceeded&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;bad-header&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list icmp_type &#039;unknown-header-type&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option limit &#039;1000/sec&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option family &#039;ipv6&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;IPSEC ESP&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;esp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src_ip &#039;site_A_public/24&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;IPSEC UDP-500&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;udp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest_port &#039;500&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src_ip &#039;site_A_public/24&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;IPSEC UDP-4500&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;udp&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest_port &#039;4500&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src_ip &#039;site_A_public/24&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;IPSEC AH&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;ah&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src_ip &#039;site_A_public/24&#039;</p><p>config include<br />&nbsp; &nbsp; &nbsp; &nbsp; option path &#039;/etc/firewall.user&#039;</p><p>config forwarding<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest &#039;wan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;lan&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;Incoming IPSec tunnels&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;vpn&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;all&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest_ip &#039;192.168.1.0/24&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest &#039;lan&#039;</p><p>config rule<br />&nbsp; &nbsp; &nbsp; &nbsp; option target &#039;ACCEPT&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option name &#039;Outgoing IPSec tunnel&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest &#039;vpn&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option proto &#039;all&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option dest_ip &#039;10.8.0.0/16&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option src &#039;lan&#039;</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p253757">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Ahimoth</div>
					<div class="post-datetime">
						9 Nov 2014, 22:32					</div>
				</div>
				<div class="post-content content">
					<p>I seem to have gotten it working with this:</p><p>iptables -t nat -I POSTROUTING -d 10.8.0.0/16 -s 192.168.1.0/24 -j ACCEPT</p><br /><p>Is this the correct way to apply this, or should it go into some other chain, etc?</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>