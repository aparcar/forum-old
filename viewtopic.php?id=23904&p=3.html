<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Multi-WAN Load Balancing</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 29 Mar 2018 and 3 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 3 of 14</div><nav><ul><li><a href="viewtopic.php%3Fid=23904&amp;p=1.html">1</a></li><li><a href="viewtopic.php%3Fid=23904&amp;p=2.html">2</a></li><li class="pagination-current"><span>3</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=4.html">4</a></li><li><a href="viewtopic.php%3Fid=23904&amp;p=5.html">5</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=14.html">14</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p105861">
				<div class="post-metadata">
					<div class="post-num">Post #51</div>
					<div class="post-author">andyballon</div>
					<div class="post-datetime">
						2 Apr 2010, 05:30					</div>
				</div>
				<div class="post-content content">
					<p>hi, </p><p>hold off on that last order. i think issue 1. is caused by issue 2.<br />my dsl blinked and i got this:</p><p>=====<br />root@culiat-wg:~# ip route show table 123<br />121.96.128.1 dev ppp0&nbsp; proto kernel&nbsp; scope link&nbsp; src 121.96.157.113<br />114.108.202.0/24 dev eth0.1&nbsp; proto kernel&nbsp; scope link&nbsp; src 114.108.202.15<br />192.168.1.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.1.1<br />default<br />&nbsp; &nbsp; &nbsp; &nbsp; nexthop via 114.108.202.1&nbsp; dev eth0.1 weight 1<br />&nbsp; &nbsp; &nbsp; &nbsp; nexthop via 121.96.128.1&nbsp; dev ppp0 weight 1<br />=====</p><p>not static proto but i still have multipath. and the interfaces logs show wan2 still routing packets.<br />i won&#039;t delete/edit post #50 so people can check their connections before suspecting multiwan.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p105862">
				<div class="post-metadata">
					<div class="post-num">Post #52</div>
					<div class="post-author">andyballon</div>
					<div class="post-datetime">
						2 Apr 2010, 05:36					</div>
				</div>
				<div class="post-content content">
					<p>btw, the significance of the above is everything happened during the same internet session.<br />here&#039;s wan2 routing alongside wan after the blink:<br />--<br />Interface wan<br />RX: 296347 Pkts. (239.31 MB)<br />TX: 246788 Pkts. (57.27 MB)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />Interface wan2<br />RX: 22062 Pkts. (13.51 MB)<br />TX: 27993 Pkts. (13.81 MB)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p106005">
				<div class="post-metadata">
					<div class="post-num">Post #53</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						4 Apr 2010, 04:18					</div>
				</div>
				<div class="post-content content">
					<p>Hey Andy,</p><p>If health monitor is enabled on that interface, even if the Multi-WAN script is loaded before the ppp connection is established, it will detect the changes and update the routing tables and netfilter rules when it becomes available and ready for use.<br />I did post a change, specifying the static for routes of the other tables, as this is more appropriate, but this will not have any effect on your current performance.</p><p>Thanks,<br />- Craig</p>											<p class="post-edited">(Last edited by <strong>SouthPawn</strong> on 4 Apr 2010, 09:00)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p106025">
				<div class="post-metadata">
					<div class="post-num">Post #54</div>
					<div class="post-author">andyballon</div>
					<div class="post-datetime">
						4 Apr 2010, 16:00					</div>
				</div>
				<div class="post-content content">
					<p>hi craig,</p><p>thanks for the update. i guess i&#039;ll just download it and test it next weekend. vacation&#039;s over so i&#039;m back to work again.<br />stupid question but where do i turn on the health monitor? <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /><br />although, i do see the routing adjust when my ip address changes. right now i&#039;m itching to do a `ip route show table 123 | grep default | wc -l` if that&#039;s not equal to 2 then i&#039;d restart multiwan.<br />reason why i&#039;m still bickering over the late interface is i&#039;m still having the issue although i may be the only one seeing the difference, i&#039;m sure it&#039;s very common since heterogeneous connections are common for fault tolerance and i&#039;m sure the pppoe authentication delay vs the dhcp ack is causing the disparity.<br />here&#039;s what i have so far (this is the i version with the hand fixed luci. not the k yet. ):<br />=====<br />root@culiat-wg:~# ip route show table 123<br />202.78.96.80 dev ppp0&nbsp; proto kernel&nbsp; scope link&nbsp; src 110.55.231.21<br />114.108.202.0/24 dev eth0.1&nbsp; proto kernel&nbsp; scope link&nbsp; src 114.108.202.179<br />192.168.1.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.1.1<br />default via 114.108.202.1 dev eth0.1<br />root@culiat-wg:~# /etc/init.d/multiwan restart<br />root@culiat-wg:~# ip route show table 123<br />202.78.96.80 dev ppp0&nbsp; proto kernel&nbsp; scope link&nbsp; src 110.55.231.21<br />114.108.202.0/24 dev eth0.1&nbsp; proto kernel&nbsp; scope link&nbsp; src 114.108.202.179<br />192.168.1.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.1.1<br />root@culiat-wg:~# ip route show table 123<br />202.78.96.80 dev ppp0&nbsp; proto kernel&nbsp; scope link&nbsp; src 110.55.231.21<br />114.108.202.0/24 dev eth0.1&nbsp; proto kernel&nbsp; scope link&nbsp; src 114.108.202.179<br />192.168.1.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.1.1<br />default<br />&nbsp; &nbsp; &nbsp; &nbsp; nexthop via 114.108.202.1&nbsp; dev eth0.1 weight 1<br />&nbsp; &nbsp; &nbsp; &nbsp; nexthop via 202.78.96.80&nbsp; dev ppp0 weight 1<br />=====<br />that&#039;s after more than 10 minutes that the router has been powered on and i checked that the pppoe connection was already up.<br />notice multipath started working after i restarted the script. i&#039;m sure there is a cleaner solution to this but as i said probably checking the interfaces, 10 seconds apart after starting multiwan could be the solution OR the health monitor but pls tell me where to turn it on. i&#039;m using backfire 10.03-rc2.<br />i&#039;ll test the k version when i get the chance and give more feedback. <br />overall, it&#039;s a superb implementation of multipath networking. i think yours is the only one i came upon that really worked. fyi, i&#039;ve been doing multipath routing since lokiwall and you&#039;ll get really tired tracing the scripts to make it work. yours worked out of the box. my initial setup using your script was one isp on each router that&#039;s why i didn&#039;t have the lagging pppoe issue before. i got bold and connected both isp on one router with the other router just used to spread the workload that&#039;s why i&#039;m seeing the delay now. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>regards,<br />andy</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p106054">
				<div class="post-metadata">
					<div class="post-num">Post #55</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						4 Apr 2010, 23:09					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>andyballon wrote:</cite><blockquote><p>hi craig,</p><p>thanks for the update. i guess i&#039;ll just download it and test it next weekend. vacation&#039;s over so i&#039;m back to work again.<br />stupid question but where do i turn on the health monitor? <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /><br />although, i do see the routing adjust when my ip address changes. right now i&#039;m itching to do a `ip route show table 123 | grep default | wc -l` if that&#039;s not equal to 2 then i&#039;d restart multiwan.<br />reason why i&#039;m still bickering over the late interface is i&#039;m still having the issue although i may be the only one seeing the difference, i&#039;m sure it&#039;s very common since heterogeneous connections are common for fault tolerance and i&#039;m sure the pppoe authentication delay vs the dhcp ack is causing the disparity.<br />here&#039;s what i have so far (this is the i version with the hand fixed luci. not the k yet. ):<br />=====<br />root@culiat-wg:~# ip route show table 123<br />202.78.96.80 dev ppp0&nbsp; proto kernel&nbsp; scope link&nbsp; src 110.55.231.21<br />114.108.202.0/24 dev eth0.1&nbsp; proto kernel&nbsp; scope link&nbsp; src 114.108.202.179<br />192.168.1.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.1.1<br />default via 114.108.202.1 dev eth0.1<br />root@culiat-wg:~# /etc/init.d/multiwan restart<br />root@culiat-wg:~# ip route show table 123<br />202.78.96.80 dev ppp0&nbsp; proto kernel&nbsp; scope link&nbsp; src 110.55.231.21<br />114.108.202.0/24 dev eth0.1&nbsp; proto kernel&nbsp; scope link&nbsp; src 114.108.202.179<br />192.168.1.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.1.1<br />root@culiat-wg:~# ip route show table 123<br />202.78.96.80 dev ppp0&nbsp; proto kernel&nbsp; scope link&nbsp; src 110.55.231.21<br />114.108.202.0/24 dev eth0.1&nbsp; proto kernel&nbsp; scope link&nbsp; src 114.108.202.179<br />192.168.1.0/24 dev br-lan&nbsp; proto kernel&nbsp; scope link&nbsp; src 192.168.1.1<br />default<br />&nbsp; &nbsp; &nbsp; &nbsp; nexthop via 114.108.202.1&nbsp; dev eth0.1 weight 1<br />&nbsp; &nbsp; &nbsp; &nbsp; nexthop via 202.78.96.80&nbsp; dev ppp0 weight 1<br />=====<br />that&#039;s after more than 10 minutes that the router has been powered on and i checked that the pppoe connection was already up.<br />notice multipath started working after i restarted the script. i&#039;m sure there is a cleaner solution to this but as i said probably checking the interfaces, 10 seconds apart after starting multiwan could be the solution OR the health monitor but pls tell me where to turn it on. i&#039;m using backfire 10.03-rc2.<br />i&#039;ll test the k version when i get the chance and give more feedback. <br />overall, it&#039;s a superb implementation of multipath networking. i think yours is the only one i came upon that really worked. fyi, i&#039;ve been doing multipath routing since lokiwall and you&#039;ll get really tired tracing the scripts to make it work. yours worked out of the box. my initial setup using your script was one isp on each router that&#039;s why i didn&#039;t have the lagging pppoe issue before. i got bold and connected both isp on one router with the other router just used to spread the workload that&#039;s why i&#039;m seeing the delay now. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>regards,<br />andy</p></blockquote></div><p>Hey Andy,</p><p>Looking at the problem your experiencing it&#039;s either, </p><p>A. The firewall is blocking the ICMP requests/responses, or B. The DNS servers are not responding to an icmp ping. </p><p>The reason it keeps getting dropped of the load balancer routing table (123), is the Multi-WAN script beleives it&#039;s a failed link. (Check syslog to verify this.)</p><p>Try selecting Gateway or Disable on the Health Monitor ICMP Host setting.</p><p>Thanks Andy,<br />-Craig</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p106064">
				<div class="post-metadata">
					<div class="post-num">Post #56</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						5 Apr 2010, 03:56					</div>
				</div>
				<div class="post-content content">
					<p>Craig,</p><p>I converted the .lua translation file to the appropriate bianry format used in recent revisions, you can find it here:<br /><a href="http://luci.subsignal.org/~jow/mw-i18n/">http://luci.subsignal.org/~jow/mw-i18n/</a></p><p>The &quot;multiwan.en.lmo&quot; file must be placed into /usr/lib/lua/luci/i18n/ .</p><p>~ JoW</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p106071">
				<div class="post-metadata">
					<div class="post-num">Post #57</div>
					<div class="post-author">andyballon</div>
					<div class="post-datetime">
						5 Apr 2010, 08:00					</div>
				</div>
				<div class="post-content content">
					<p>hi craig,</p><p>thanks for the update. that may be my problem. i have health monitor turned off. yes i checked before and an isp&#039;s dns server was not responding to pings that&#039;s why i disabled it. i was planning to put up my own check but i&#039;m not sure if dead gateway detection is properly implemented in the openwrt&#039;s kernel. anyway, i haven&#039;t got time now to check that but i think last word i got from the internet is it&#039;s properly implemented in the 2.6 kernel. that&#039;s why i&#039;m updated to 2.6 kernel. anyway, your scripts are giving me more download than the higher rated isp so that means it&#039;s working. (btw, when i say that i&#039;m not saying i&#039;m just downloading 1 big file. what i mean is i&#039;m downloading several files that when you add them up it&#039;s going more than the higher rated internet connection.)<br />btw, i mentioned lokiwall as a relic above but upon checking they&#039;re active again. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> that&#039;s a pretty cool application. and they got a gui now! makes me look double silly. <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /><br />so, i&#039;ll turn on health check later when i get home and see how everything goes.<br />btw#2, if you have not implemented this in the k version maybe look into it?<br />&quot;&nbsp; &nbsp; ip rule add prio 5 table main<br />&nbsp; &nbsp; ip route del default table main<br />&quot;<br />i was doing that after running multiwan but forgot to mention it before. that puts the main table ahead of the default table and the main table is the one that does mutlipath routing. i&#039;m not sure if that&#039;s still needed but it&#039;s in nano.txt. </p><p>thanks,<br />andy</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p106100">
				<div class="post-metadata">
					<div class="post-num">Post #58</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						5 Apr 2010, 18:32					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>andyballon wrote:</cite><blockquote><p>hi craig,<br />btw#2, if you have not implemented this in the k version maybe look into it?<br />&quot;&nbsp; &nbsp; ip rule add prio 5 table main<br />&nbsp; &nbsp; ip route del default table main<br />&quot;<br />i was doing that after running multiwan but forgot to mention it before. that puts the main table ahead of the default table and the main table is the one that does mutlipath routing. i&#039;m not sure if that&#039;s still needed but it&#039;s in nano.txt. </p><p>thanks,<br />andy</p></blockquote></div><p>Each of the routing tables set up by the multiwan have a copy of the main routing table, a default gateway will be required regardless of whether we use it or not. I could set the default gateway to the loopback address 127.0.0.1, but I find it more human readable to keep both default gateways there, as well it&#039;s a point a reference to see if the routing table has been changed by some external event.</p><p>Thanks Andy,<br />-Craig</p>											<p class="post-edited">(Last edited by <strong>SouthPawn</strong> on 5 Apr 2010, 18:54)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p106310">
				<div class="post-metadata">
					<div class="post-num">Post #59</div>
					<div class="post-author">rockpilp</div>
					<div class="post-datetime">
						7 Apr 2010, 23:12					</div>
				</div>
				<div class="post-content content">
					<p>Hi Craig,</p><p>As an early poster on the Dual-Wan thread, I wanted to congratulate you on the great improvements you&#039;ve made in the past few weeks/months.</p><p>I do agree with some of the other commenters that the LuCi module could use some help text.</p><p>Here are some suggestions:</p><p><span class="postimg"><img src="http://s3.amazonaws.com/ember/tQh7HTPbablmUiSzPd1CIP3c2D4nSjXK_l.png" alt="http://s3.amazonaws.com/ember/tQh7HTPbablmUiSzPd1CIP3c2D4nSjXK_l.png" /></span></p>											<p class="post-edited">(Last edited by <strong>rockpilp</strong> on 7 Apr 2010, 23:14)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p106350">
				<div class="post-metadata">
					<div class="post-num">Post #60</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						8 Apr 2010, 11:13					</div>
				</div>
				<div class="post-content content">
					<p>Hi Craig,</p><br /><p>Yesterday one of my isp&#039;s had a mayor malfunction. Didn&#039;t notice a thing until i read it in the news the day after (affected 400.000 customers). After this i checked the logging in the router and indeed saw some notifications that one of my isp had failed and had recovered. Never noticed a thing <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>Just wanted to let you know this succes stroy <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><br /><p>Adze.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p106394">
				<div class="post-metadata">
					<div class="post-num">Post #61</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						8 Apr 2010, 19:40					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>rockpilp wrote:</cite><blockquote><p>Hi Craig,</p><p>As an early poster on the Dual-Wan thread, I wanted to congratulate you on the great improvements you&#039;ve made in the past few weeks/months.</p><p>I do agree with some of the other commenters that the LuCi module could use some help text.</p></blockquote></div><p>Thanks rockpilp, I do agree that there may be some confusion on what the DNS configuration file does. <br />Essentially its the file we&#039;re going to write to, and perhaps that should be stated. </p><p>One of the functions that the script does is gather the dns server settings from the different interfaces and creates netfilter rules to always send dns client queries to their corresponding WAN interface, and then inserts all those entries in to the resolv.conf.auto which should be linked within the /tmp folder as to not write to the physical file system.</p><p>Ideally this setting would not need to exist and all interfaces with dns settings would be written to the resolv.conf.auto, however at the moment the interface that is initialized last gets it&#039;s dns written and any interfaces before it are simply overwritten instead of being appended to.</p><div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hi Craig,</p><br /><p>Yesterday one of my isp&#039;s had a mayor malfunction. Didn&#039;t notice a thing until i read it in the news the day after (affected 400.000 customers). After this i checked the logging in the router and indeed saw some notifications that one of my isp had failed and had recovered. Never noticed a thing <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>Just wanted to let you know this succes stroy <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><br /><p>Adze.</p></blockquote></div><p>Awesomesauce! </p><p>Thanks for all the feed back! <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />-Craig</p>											<p class="post-edited">(Last edited by <strong>SouthPawn</strong> on 8 Apr 2010, 19:44)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p106687">
				<div class="post-metadata">
					<div class="post-num">Post #62</div>
					<div class="post-author">skerit</div>
					<div class="post-datetime">
						12 Apr 2010, 19:34					</div>
				</div>
				<div class="post-content content">
					<p>Can someone maybe post a few files that are needed for this to run correctly? I believe just editing the luci module isn&#039;t enough and some configuration files need modifications too, am I correct?<br />I&#039;ve been trying to get this thing to run for weeks but it just won&#039;t do anything.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p106691">
				<div class="post-metadata">
					<div class="post-num">Post #63</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						12 Apr 2010, 20:14					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>skerit wrote:</cite><blockquote><p>Can someone maybe post a few files that are needed for this to run correctly? I believe just editing the luci module isn&#039;t enough and some configuration files need modifications too, am I correct?<br />I&#039;ve been trying to get this thing to run for weeks but it just won&#039;t do anything.</p></blockquote></div><p>Hey Skerit,</p><p>Please provide a few more specifics about what the problem is, are you seeing anything in syslog? what platform, version? does /etc/config/multiwan exist?</p><p>Thanks Skerit,<br />-Craig</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p106850">
				<div class="post-metadata">
					<div class="post-num">Post #64</div>
					<div class="post-author">andyballon</div>
					<div class="post-datetime">
						14 Apr 2010, 16:48					</div>
				</div>
				<div class="post-content content">
					<p>skerit, you need this packages for multiwan: ip, iptables, iptables-utils, iptables-mod-conntrack, iptables-mod-conntrack-extra<br />then you need to break off a port for the additional wan. then you can configure everything from the web interface - Network &gt; Interfaces Wan, Wan2.<br />Network &gt; Multiwan <br />I have been using this for two weeks now and it&#039;s working properly for me. I&#039;ve tried it on pppoe, static ip, dhcp wan interfaces and several kamikaze and backfire versions.<br />Please provide more details on your setup and i&#039;ll try to pitch in on getting your router to work. although i might have more time during the weekend but southpawn is here.</p><p>@southpawn - fyi this is working great for me. just trying to get equal cost multipath to work more efficiently. &lt;greedy&gt; <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107418">
				<div class="post-metadata">
					<div class="post-num">Post #65</div>
					<div class="post-author">kubu</div>
					<div class="post-datetime">
						20 Apr 2010, 20:38					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for providing multiwan!</p><p>I installed multiwan_1.0k.ipk and luci-app-multiwan_1.0k.ipk from <a href="ftp://ftp.netlab7.com">ftp://ftp.netlab7.com</a>/ on an Asus wl-500gp with Backfire 10.03 brcm 47xx generic image. I have two wan interfaces (wan15cable and wan14dsl), each having a public IP address configured by dhcp. Multiwan finds the interfaces and configures them. Failover seems to work -- apart from DNS complaining:&nbsp; nameserver 195.186.1.162 refused to do a recursive query.</p><p>However load balancing does not. Traffic is always forwarded through the second interface as configured in /etc/config/multiwan. If I change the order of the interfaces in that file - traffic is forwarded trough the other interface. I observe traffic by the max download speed of a couple of torrents and the traffic counter on the interfaces as shown by ifconfig.</p><p>Any ideas?</p><p>Thanks<br />Kubu</p><div class="codebox"><pre><code># route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.1.0      0.0.0.0         255.255.255.0   U     0      0        0 eth0.13
92.105.81.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0.14
91.138.20.0     0.0.0.0         255.255.252.0   U     0      0        0 eth0.15
0.0.0.0         91.138.20.1     0.0.0.0         UG    0      0        0 eth0.15
0.0.0.0         92.105.81.1     0.0.0.0         UG    0      0        0 eth0.14</code></pre></div><div class="codebox"><pre><code># ip route show table 123
192.168.1.0/24 dev eth0.13  proto kernel  scope link  src 192.168.1.1
92.105.81.0/24 dev eth0.14  proto kernel  scope link  src 92.105.81.205
91.138.20.0/22 dev eth0.15  proto kernel  scope link  src 91.138.21.138
default  proto static
        nexthop via 92.105.81.1  dev eth0.14 weight 8
        nexthop via 91.138.20.1  dev eth0.15 weight 4</code></pre></div><div class="codebox"><pre><code># ip route show table 10
192.168.1.0/24 dev eth0.13  proto kernel  scope link  src 192.168.1.1
92.105.81.0/24 dev eth0.14  proto kernel  scope link  src 92.105.81.205
91.138.20.0/22 dev eth0.15  proto kernel  scope link  src 91.138.21.138
default via 92.105.81.1 dev eth0.14  proto static  src 92.105.81.205</code></pre></div><div class="codebox"><pre><code># ip route show table 20
192.168.1.0/24 dev eth0.13  proto kernel  scope link  src 192.168.1.1
92.105.81.0/24 dev eth0.14  proto kernel  scope link  src 92.105.81.205
91.138.20.0/22 dev eth0.15  proto kernel  scope link  src 91.138.21.138
default via 91.138.20.1 dev eth0.15  proto static  src 91.138.21.138</code></pre></div><p>The configuration is:<br /></p><div class="codebox"><pre><code># cat /etc/config/multiwan

config &#039;multiwan&#039; &#039;config&#039;
        option &#039;default_route&#039; &#039;balancer&#039;
        option &#039;resolv_conf&#039; &#039;/tmp/resolv.conf.auto&#039;

config &#039;interface&#039; &#039;wan14dsl&#039;
        option &#039;timeout&#039; &#039;3&#039;
        option &#039;health_fail_retries&#039; &#039;3&#039;
        option &#039;health_recovery_retries&#039; &#039;5&#039;
        option &#039;health_interval&#039; &#039;60&#039;
        option &#039;icmp_hosts&#039; &#039;gateway&#039;
        option &#039;weight&#039; &#039;8&#039;
        option &#039;failover_to&#039; &#039;balancer&#039;

config &#039;interface&#039; &#039;wan15cable&#039;
        option &#039;timeout&#039; &#039;3&#039;
        option &#039;health_fail_retries&#039; &#039;3&#039;
        option &#039;health_recovery_retries&#039; &#039;5&#039;
        option &#039;health_interval&#039; &#039;60&#039;
        option &#039;icmp_hosts&#039; &#039;gateway&#039;
        option &#039;weight&#039; &#039;4&#039;
        option &#039;failover_to&#039; &#039;balancer&#039;</code></pre></div><p>I reduced the health_interval. Failures of connections are very rare events. I do not fully understand the option failover_to.</p><p>To avoid problems with DNS I configured Google&#039;s public DNS server for the two interfaces:<br /></p><div class="codebox"><pre><code># cat /etc/config/network

config &#039;interface&#039; &#039;wan15cable&#039;
        option &#039;ifname&#039; &#039;eth0.15&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;
        option &#039;dns&#039; &#039;8.8.8.8&#039;
        option &#039;proto&#039; &#039;dhcp&#039;

config &#039;interface&#039; &#039;wan14dsl&#039;
        option &#039;ifname&#039; &#039;eth0.14&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;
        option &#039;dns&#039; &#039;8.8.4.4&#039;
        option &#039;proto&#039; &#039;dhcp&#039;</code></pre></div>											<p class="post-edited">(Last edited by <strong>kubu</strong> on 21 Apr 2010, 17:20)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107441">
				<div class="post-metadata">
					<div class="post-num">Post #66</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						21 Apr 2010, 00:40					</div>
				</div>
				<div class="post-content content">
					<p>I think it would be best if you could, post the /etc/config/multiwan file to take a look at it, everything appears to be fine atleast on the routing table, but I&#039;d also check that the other routing tables are in tact, 10 and 20.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107500">
				<div class="post-metadata">
					<div class="post-num">Post #67</div>
					<div class="post-author">malakudi</div>
					<div class="post-datetime">
						21 Apr 2010, 16:56					</div>
				</div>
				<div class="post-content content">
					<p>I had the same problem as above. It seems I was missing packages iptables-mod-ipopt and kmod-ipt-ipopt (which provide -m mark and -j MARK options, among others)</p>											<p class="post-edited">(Last edited by <strong>malakudi</strong> on 21 Apr 2010, 17:00)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107508">
				<div class="post-metadata">
					<div class="post-num">Post #68</div>
					<div class="post-author">kubu</div>
					<div class="post-datetime">
						21 Apr 2010, 17:22					</div>
				</div>
				<div class="post-content content">
					<p>SOLVED! iptables-mod-ipopt and kmod-ipt-ipopt where missing. May the dependencies for the packet be fixed?</p><p>Thanks a lot!</p><p>Can someone explain me how failover_to affects failover?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107509">
				<div class="post-metadata">
					<div class="post-num">Post #69</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						21 Apr 2010, 17:27					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ll update that today, but failover_to essentially specifies where the traffic should be forwarded for the wan in the event that the wan fails. </p><p>So if your default route or outbound rules are set to use the primary wan, and the primary wan has the secondary wan as it&#039;s failover_to setting it will forward traffic destined to the primary wan to the secondary. </p><p>Things that are set to use Load Balancer will failover automatically as wans are removed from the routing table during failover.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107513">
				<div class="post-metadata">
					<div class="post-num">Post #70</div>
					<div class="post-author">malakudi</div>
					<div class="post-datetime">
						21 Apr 2010, 18:05					</div>
				</div>
				<div class="post-content content">
					<p>I have another problem (which I am trying to fix but haven&#039;t found how to patch the multiwan script yet). One of my wan setup is a ppp interface. It seems the route &quot;default dev ppp0&nbsp; scope link&quot; is not handled well from the multiwan script. The script adds this route to all routing tables (table 10, 20 and 123). If I remove this route by hand, then multiwan works fine. It adds a default route as &quot;default via GATEWAYIP dev ppp0&quot; for table 20 and a correct multilink route in table 123.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107526">
				<div class="post-metadata">
					<div class="post-num">Post #71</div>
					<div class="post-author">malakudi</div>
					<div class="post-datetime">
						21 Apr 2010, 20:37					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>malakudi wrote:</cite><blockquote><p>I have another problem (which I am trying to fix but haven&#039;t found how to patch the multiwan script yet). One of my wan setup is a ppp interface. It seems the route &quot;default dev ppp0&nbsp; scope link&quot; is not handled well from the multiwan script. The script adds this route to all routing tables (table 10, 20 and 123). If I remove this route by hand, then multiwan works fine. It adds a default route as &quot;default via GATEWAYIP dev ppp0&quot; for table 20 and a correct multilink route in table 123.</p></blockquote></div><p>OK, I fixed this by changing:<br />ip route | grep link | while read ROUTE<br />to<br />ip route | grep link | grep -Ev ^default | while read ROUTE</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107528">
				<div class="post-metadata">
					<div class="post-num">Post #72</div>
					<div class="post-author">kubu</div>
					<div class="post-datetime">
						21 Apr 2010, 20:50					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>SouthPawn wrote:</cite><blockquote><p>I&#039;ll update that today, but failover_to essentially specifies where the traffic should be forwarded for the wan in the event that the wan fails. </p><p>So if your default route or outbound rules are set to use the primary wan, and the primary wan has the secondary wan as it&#039;s failover_to setting it will forward traffic destined to the primary wan to the secondary. </p><p>Things that are set to use Load Balancer will failover automatically as wans are removed from the routing table during failover.</p></blockquote></div><p>Thanks for your explanation.</p><p>Failover works well. However, I still seem to have problems properly resolving some hostnames after a failover (manual ifdown of one interface). dnsmasq complained about the DNS server not resolving queries... :-/ Brining both interfaces backup (manually by ifup) does change. </p><p>As far as I know, outbound queries to DNS servers shal be bound to the respective interface, corret?</p>											<p class="post-edited">(Last edited by <strong>kubu</strong> on 21 Apr 2010, 22:38)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107699">
				<div class="post-metadata">
					<div class="post-num">Post #73</div>
					<div class="post-author">andyballon</div>
					<div class="post-datetime">
						23 Apr 2010, 20:32					</div>
				</div>
				<div class="post-content content">
					<p>I can confirm that iptables-mod-ipopt and kmod-ipt-ipopt are needed for load balancing. That&#039;s what I was missing if I did not install qos-scripts.<br />The above workaround for ppp0 didn&#039;t work for me.:( <br />I have the dsl line still lagging behind the cable line.<br />For the DNS I configured mine with identical public DNS servers and I never had problems with it. <br />You got a great product here Craig! <br />It&#039;s a winner!<br /><img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107705">
				<div class="post-metadata">
					<div class="post-num">Post #74</div>
					<div class="post-author">SouthPawn</div>
					<div class="post-datetime">
						23 Apr 2010, 21:00					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for the kind words!, I added this to the dependency, as well as the recommendation for ppp connections from kubu.<br />I did also update the DNS queries, so it should go to the correct interface anything thrown at the listed dns servers.</p><p>Thanks again,<br />-Craig</p>											<p class="post-edited">(Last edited by <strong>SouthPawn</strong> on 23 Apr 2010, 21:00)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p107794">
				<div class="post-metadata">
					<div class="post-num">Post #75</div>
					<div class="post-author">andyballon</div>
					<div class="post-datetime">
						25 Apr 2010, 04:54					</div>
				</div>
				<div class="post-content content">
					<p>I hope the thread owner doesn&#039;t mind. I&#039;m doing this for a friend.<br />Here&#039;s a 30 minute guide to setting up Multi-wan on a WRT54GL.<br /></p><div class="codebox"><pre><code>1. Install Backfire 10.03
- for first time install see Openwrt documentation
- for upgrades from Kamikaze use the .trx and install via the web interface
- for bricked &lt;smirk&gt; routers see tftp install of .bin file
http://wiki.openwrt.org/doc/howto/tftp
note: don&#039;t forget to login via telnet and change root passwd for ssh to work

2. Create extra Vlan for Wan2
I do this via /etc/config/newtork.
note: I removed port &quot;0&quot; from eth0_0 and gave it to eth0_2.
You can configure wan and wan2 proto as dhcp to strt and then use the web interface to configure the pppoe or static ip later.
Use the same DNS servers I&#039;m using if you&#039;re having DNS problems. Some ISPs only allow DNS connections from their IP blocks.
 ---------------------------------------------------
root@culiat-wg:~# cat /etc/config/network

config &#039;switch&#039; &#039;eth0&#039;
        option &#039;enable&#039; &#039;1&#039;

config &#039;switch_vlan&#039; &#039;eth0_0&#039;
        option &#039;device&#039; &#039;eth0&#039;
        option &#039;vlan&#039; &#039;0&#039;
        option &#039;ports&#039; &#039;1 2 3 5&#039;

config &#039;switch_vlan&#039; &#039;eth0_1&#039;
        option &#039;device&#039; &#039;eth0&#039;
        option &#039;vlan&#039; &#039;1&#039;
        option &#039;ports&#039; &#039;4 5&#039;

config &#039;switch_vlan&#039; &#039;eth0_2&#039;
        option &#039;device&#039; &#039;eth0&#039;
        option &#039;vlan&#039; &#039;2&#039;
        option &#039;ports&#039; &#039;0 5&#039;

config &#039;interface&#039; &#039;loopback&#039;
        option &#039;ifname&#039; &#039;lo&#039;
        option &#039;proto&#039; &#039;static&#039;
        option &#039;ipaddr&#039; &#039;127.0.0.1&#039;
        option &#039;netmask&#039; &#039;255.0.0.0&#039;

config &#039;interface&#039; &#039;lan&#039;
        option &#039;type&#039; &#039;bridge&#039;
        option &#039;ifname&#039; &#039;eth0.0&#039;
        option &#039;proto&#039; &#039;static&#039;
        option &#039;stp&#039; &#039;1&#039;
        option &#039;ipaddr&#039; &#039;192.168.1.1&#039;
        option &#039;netmask&#039; &#039;255.255.255.0&#039;

config &#039;interface&#039; &#039;wan&#039;
        option &#039;ifname&#039; &#039;eth0.1&#039;
        option &#039;proto&#039; &#039;dhcp&#039;
        option &#039;dns&#039; &#039;216.146.35.113 216.146.36.113 8.8.8.8 8.8.4.4&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;

config &#039;interface&#039; &#039;wan2&#039;
        option &#039;ifname&#039; &#039;eth0.2&#039;
        option &#039;dns&#039; &#039;216.146.35.113 216.146.36.113 8.8.8.8 8.8.4.4&#039;
        option &#039;proto&#039; &#039;dhcp&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;

3. Install prerequisite software
ip, iptables, iptables-utils, iptables-mod-conntrack, iptables-mod-conntrack-extra, iptables-mod-ipopt and kmod-ipt-ipopt
this is how I do it:
a. go to backfire packages: http://downloads.openwrt.org/backfire/10.03/brcm47xx/packages/
b. right click a link to a package and &quot;Copy Link Location&quot;
c. go to /tmp directory and run 
&quot;opkg install http://downloads.openwrt.org/backfire/10.03/brcm47xx/packages/ip_2.6.29-1-2_brcm47xx.ipk&quot;
note: if you&#039;re new to all of this it&#039;s better to install all the applications first including multiwan before configuring vlans so your internet connection does not go kookie on you. If you did because you&#039;re folowing this guide, then just shutdown a interface like so: &quot;ifconfig eth0.2 down&quot;

4. Install multiwan and it&#039;s web control package (luci-app)
Reboot to refresh the web ui. I always need to do this otherwise the link does not show up in networking.

5. Configure Wans &amp;&amp; configure multiwan
Wans:
Network &gt; Interfaces &gt; Wan/WAN2
note: when asked which firewall zone to add wan2 choose wan so it has the same firewall rules for wan connections. Otherwise you&#039;ll have to manually recreate the fw rules for wan2.

Multiwan:
Network &gt; Multiwan
checkout the bottom page to see samples of the settings.
here&#039;s how i got mine setup:
a. I only have two internet connections so I always remove the last two wan interfaces. I also comment out MWAN3 and MWAN4 in /etc/iproute2/rt_tables (although it may not be necessary).
b. Load Balancer Distribution = 1 for even connection distribution
note: You&#039;ll get per connection distribution not per packet so don&#039;t expect one download to come from both gateways. Lots of talk on this in the internet.
Failover = LoadBalancer for both links
c.Traffic Rules
note: checkout the examples
Source, Destination, protocol, Ports, WAN Uplink
all, all,all,all, Load Balancer
all, all, UDP, all, wan &lt;-- this is so all vpn and voip connection goes through 1 gateway only
that&#039;s it! 

6. Test.
- Status &gt; Interfaces should show traffic going through both interfaces.
- route distribution
root@culiat-wg:~# ip route show table 123
192.168.2.0/24 dev eth0.2  proto kernel  scope link  src 192.168.2.214
192.168.1.0/24 dev br-lan  proto kernel  scope link  src 192.168.1.1
114.108.201.0/24 dev eth0.1  proto kernel  scope link  src 114.108.201.49
default  proto static
        nexthop via 114.108.201.1  dev eth0.1 weight 1
        nexthop via 192.168.2.1  dev eth0.2 weight 1
- &quot;route&quot; should give you two default gateways
- try a torrent with lots of seeders. If you have a internet line that can do 90kbps max download, and another that can do 180kbps max if multiwan is working properly you should get a download rate greater than the higher rated link.
- pulling the plug from a wan port should still give you internet connection

7. Troubleshooting
There&#039;s a problem if 
- when you refresh the Interface status page and the Transfer rate of one interface does not change
- when you you go the the Interface Status page you only see one wan interface
- when you do &quot;route&quot; you only get one default gateway
- when you do &quot;ip route show table 123&quot; you don&#039;t get nexthops
- etc.
Fix:
- post your problem in the thread. :D

8. Extras
If you have two or more connections to the same ISP you should try:
 - ECMP using quagga http://quagga.net/faq/kodgehopper-ecmp.html &lt;-- hard core network stuff (makes you feel like a genius. :D)
 - Channel bonding &lt;-- this gives you per packet load distribution (effectively doubles your transfer rates)
 
That&#039;s it! Multiwan gives you protection from internet disconnection and doubles your transfer rate during heavy usage. 
Register for a free DDNS account and when you&#039;re in the office ask your maid to turn on the power on your routers and show off your shining new multiwan connection to your office mates. Open up several consoles and start downloading from several high bandwidth sites (kernel.org, nvidai, ati, etc.). show them how you&#039;re getting a combined download rate faster than the rated capacity of your individual internet subscriptions. Makes you top dog until the wife discovers you&#039;re paying for two internet lines. :D</code></pre></div>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 3 of 14</div><nav><ul><li><a href="viewtopic.php%3Fid=23904&amp;p=1.html">1</a></li><li><a href="viewtopic.php%3Fid=23904&amp;p=2.html">2</a></li><li class="pagination-current"><span>3</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=4.html">4</a></li><li><a href="viewtopic.php%3Fid=23904&amp;p=5.html">5</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=23904&amp;p=14.html">14</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>