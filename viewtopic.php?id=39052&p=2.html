<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> mwan3; multi-wan policy routing (general topic)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 22 May 2013 and 6 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 2 of 65</div><nav><ul><li><a href="viewtopic.php%3Fid=39052&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=4.html">4</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p179022">
				<div class="post-metadata">
					<div class="post-num">Post #26</div>
					<div class="post-author">RussellSenior</div>
					<div class="post-datetime">
						22 Sep 2012, 01:03					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>The way i got my router originated traffic to load-balance is by adding an ip alias on the loopback interface. Then create a default route <strong>with the ip alias as source</strong> in the main routing table with a lower metric than the lowest wan interface. You will have something like this:</p></blockquote></div><p>That&#039;s working for me now too.&nbsp; Would I be wrong to suggest that seems incredibly kludgy? ;-)</p><p>Also, what does that look like in your /etc/config/network?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p179067">
				<div class="post-metadata">
					<div class="post-num">Post #27</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						22 Sep 2012, 21:21					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>RussellSenior wrote:</cite><blockquote><p>Would I be wrong to suggest that seems incredibly kludgy? ;-)</p></blockquote></div><p>Yes. ;-) I find it rather elegant...</p><div class="quotebox"><cite>RussellSenior wrote:</cite><blockquote><p>Also, what does that look like in your /etc/config/network?</p></blockquote></div><div class="codebox"><pre><code>config alias
    option interface loopback
    option proto    static
    option ipaddr    192.168.1.1
    option netmask    255.255.255.255</code></pre></div><p>The static can&#039;t be set in /etc/config/network, as there is no option for source. I added it to &quot;/etc/rc.local&quot;.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p179265">
				<div class="post-metadata">
					<div class="post-num">Post #28</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						24 Sep 2012, 23:35					</div>
				</div>
				<div class="post-content content">
					<p>Load balancing the router-generated traffic works fine once I used a low metric on the route.</p>											<p class="post-edited">(Last edited by <strong>arfett</strong> on 27 Sep 2012, 03:06)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p179269">
				<div class="post-metadata">
					<div class="post-num">Post #29</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						25 Sep 2012, 00:22					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>arfett wrote:</cite><blockquote><p>Now I&#039;m just trying to find a way to stop openwrt from automatically entering routes with metric 0 for wan interfaces which are configured statically.</p></blockquote></div><p>Can you explain some more please? What process is setting these static routes? If they are for VPN tunnels and are specific routes, you&#039;re fine. If they are default routes, then you indeed should find a way to not set those routes.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p179271">
				<div class="post-metadata">
					<div class="post-num">Post #30</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						25 Sep 2012, 00:34					</div>
				</div>
				<div class="post-content content">
					<p>??</p><p>Weird... I have two wan&#039;s with static addresses. I dont have that problem.</p><div class="codebox"><pre><code>config interface &#039;wan1&#039;
    option ifname &#039;eth0.1&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;95.97.227.172&#039;
    option netmask &#039;255.255.255.248&#039;
    option gateway &#039;95.97.227.169&#039;
    option metric &#039;10&#039;
    option accept_ra &#039;1&#039;

config interface &#039;wan2&#039;
    option ifname &#039;eth0.2&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;213.154.232.12&#039;
    option netmask &#039;255.255.255.248&#039;
    option gateway &#039;213.154.232.9&#039;
    option metric &#039;20&#039;
    option accept_ra &#039;1&#039;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p179273">
				<div class="post-metadata">
					<div class="post-num">Post #31</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						25 Sep 2012, 00:41					</div>
				</div>
				<div class="post-content content">
					<p>Before and after reconnect, everything OK:<br /></p><div class="codebox"><pre><code>root@mars:/etc/uci-defaults# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.2.1     0.0.0.0         UG    5      0        0 lo
0.0.0.0         95.97.227.169   0.0.0.0         UG    10     0        0 eth0.1
0.0.0.0         213.154.232.9   0.0.0.0         UG    20     0        0 eth0.2
95.97.227.168   0.0.0.0         255.255.255.248 U     10     0        0 eth0.1
192.168.33.0    0.0.0.0         255.255.255.0   U     0      0        0 br-lan
213.154.232.8   0.0.0.0         255.255.255.248 U     20     0        0 eth0.2</code></pre></div><div class="quotebox"><cite>arfett wrote:</cite><blockquote><p>Also if you use DHCP on those I can GUARANTEE you will see the behavior unless you use something other than the default udhcpc.</p></blockquote></div><p>Also works with udhcpc fine here...</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 25 Sep 2012, 00:43)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p179275">
				<div class="post-metadata">
					<div class="post-num">Post #32</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						25 Sep 2012, 00:47					</div>
				</div>
				<div class="post-content content">
					<p>I guess you&#039;re not using the latest trunk with netifd than?</p><p>Stock behaviour of OpenWrt is to set the default route with the metric that you have set it with in /etc/config/network. This works for dhcp and static. Even works for pppoe and pppoa since recently (not in the wiki yet, but tested and works), which saved me a lot of headaches when i started on mwan3.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 25 Sep 2012, 00:50)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p180095">
				<div class="post-metadata">
					<div class="post-num">Post #33</div>
					<div class="post-author">alan614</div>
					<div class="post-datetime">
						5 Oct 2012, 16:53					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adze,</p><p>I was wondering if you would have an idea on how to implement this. There are 2 dsl connections and an openvpn tunnel will be opened in each. After which all traffic will be load balanced to go only to those 2 tunnels. I&#039;m having trouble getting the vpn tunnel to open on the 2nd dsl connection. Even if I&#039;ve set the dest_ip to go through the wan2_only, openvpn seems to only open eth1. The next part I imagine is to make mwan3 tun0 and tun1 interfaces, members then policies and to have dest_ip 0.0.0.0/0 to something like tun0_tun1_loadbalanced</p><p>As always though, great work, been using since mwan2 so thanks again for continuing development on this.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p180338">
				<div class="post-metadata">
					<div class="post-num">Post #34</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						11 Oct 2012, 15:30					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>alan614 wrote:</cite><blockquote><p>Hi Adze,</p><p>I was wondering if you would have an idea on how to implement this. There are 2 dsl connections and an openvpn tunnel will be opened in each. After which all traffic will be load balanced to go only to those 2 tunnels. I&#039;m having trouble getting the vpn tunnel to open on the 2nd dsl connection. Even if I&#039;ve set the dest_ip to go through the wan2_only, openvpn seems to only open eth1. The next part I imagine is to make mwan3 tun0 and tun1 interfaces, members then policies and to have dest_ip 0.0.0.0/0 to something like tun0_tun1_loadbalanced</p></blockquote></div><br /><p>What i would do is the following. Before even installing mwan3 configure your network. Create two static default routes to your ISP&#039;s with different metrics. Create specific routes for the VPN gateway to the corresponding VPN tunnel endpoints. Create some temporary test routes to see if traffic traveres the right VPN tunnel. If this all works you can continue installing mwan3.</p><p>Remove the temporary statics and create default routes for each vpn tunnel with different metrics than the default routes already in place. Add all 4 interfaces to mwan3 config (2 real interfaces and 2 virtual tunnels). Create mwan3 rules for the specific routes you set for the VPN gateways and set this rule to use the default policy. Then create rules for traffic you want to send out the corresponding VPN tunnel.</p><p>I think this will do the trick...</p><p>I can help you if you like. Pls PM me if you need some help.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 11 Oct 2012, 15:30)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p180462">
				<div class="post-metadata">
					<div class="post-num">Post #35</div>
					<div class="post-author">alan614</div>
					<div class="post-datetime">
						13 Oct 2012, 20:25					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for the reply Adze!</p><p>I&#039;ll study up and give your idea a shot. I&#039;ll PM you if I run up a wall. Thanks! <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182558">
				<div class="post-metadata">
					<div class="post-num">Post #36</div>
					<div class="post-author">rysi3k</div>
					<div class="post-datetime">
						6 Nov 2012, 20:01					</div>
				</div>
				<div class="post-content content">
					<p>Hello Adze,<br />I have questions and problems in configuring mwan3 to work with 1 wired WAN (eth0.2) and 1 usb dongle 3g (3g-aero) as fail-over.<br />I have studied this topic, topic about mwan2 and other forum (polish) but don&#039;t have answer to my questions.</p><p>1. I&#039;m pinging from LAN to WAN IP and when i unplug WAN cable, ping begins to loss packets and for working i must restart it to make it work with 3g, this is normal behavior?</p><div class="codebox"><pre><code>in LAN:

 ping 178.239.142.104
PING 178.239.142.104 (178.239.142.104): 56 data bytes
64 bytes from 178.239.142.104: seq=0 ttl=55 time=30.539 ms &lt;-- WAN wired
64 bytes from 178.239.142.104: seq=1 ttl=55 time=30.391 ms
64 bytes from 178.239.142.104: seq=2 ttl=55 time=31.171 ms
^C
--- 178.239.142.104 ping statistics ---
50 packets transmitted, 3 packets received, 94% packet loss
round-trip min/avg/max = 30.391/30.700/31.171 ms

(unplugged wire -&gt; losing packets, so I stopped ping process and start it again)

ping 178.239.142.104
PING 178.239.142.104 (178.239.142.104): 56 data bytes
64 bytes from 178.239.142.104: seq=0 ttl=59 time=124.667 ms &lt;-- ping time tells that is going through 3g
64 bytes from 178.239.142.104: seq=1 ttl=59 time=157.990 ms
64 bytes from 178.239.142.104: seq=2 ttl=59 time=278.065 ms
64 bytes from 178.239.142.104: seq=3 ttl=59 time=208.805 ms
64 bytes from 178.239.142.104: seq=4 ttl=59 time=338.577 ms
64 bytes from 178.239.142.104: seq=5 ttl=59 time=318.770 ms
^C
--- 178.239.142.104 ping statistics ---
6 packets transmitted, 6 packets received, 0% packet loss
round-trip min/avg/max = 124.667/237.812/338.577 ms

router:
logread -f
Nov  6 18:33:49 OpenWrt user.notice root: mwan3: Interface wan (eth0.2) is offline
Nov  6 18:33:49 OpenWrt user.notice root: mwan3: ifdown interface wan (eth0.2)
Nov  6 18:33:51 OpenWrt user.info firewall: removing wan (eth0.2) from zone wan
Nov  6 18:33:51 OpenWrt user.notice miniupnpd: removing firewall rules for eth0.2 from zone wan
Nov  6 18:33:51 OpenWrt user.notice root: stopping ntpclient</code></pre></div><p>2. Next, when I plug WAN cable again (and ping works through 3g interface), packets are still transmitted through 3g, there is no switch to normal WAN, that&#039;s ok?</p><div class="codebox"><pre><code>in LAN:
 ping 178.239.142.104
PING 178.239.142.104 (178.239.142.104): 56 data bytes
64 bytes from 178.239.142.104: seq=0 ttl=59 time=143.225 ms &lt;--- 3g
64 bytes from 178.239.142.104: seq=1 ttl=59 time=135.859 ms

(plugged again, ping still goes through 3g)

64 bytes from 178.239.142.104: seq=21 ttl=59 time=375.685 ms
64 bytes from 178.239.142.104: seq=22 ttl=59 time=115.702 ms
64 bytes from 178.239.142.104: seq=23 ttl=59 time=125.320 ms
^C
--- 178.239.142.104 ping statistics ---
25 packets transmitted, 24 packets received, 4% packet loss
round-trip min/avg/max = 105.765/156.636/375.685 ms

(restart ping)

-&gt; ping 178.239.142.104
PING 178.239.142.104 (178.239.142.104): 56 data bytes
64 bytes from 178.239.142.104: seq=0 ttl=55 time=30.659 ms
64 bytes from 178.239.142.104: seq=1 ttl=55 time=30.616 ms
^C
--- 178.239.142.104 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 30.616/30.637/30.659 ms

router:
logread -f
Nov  6 18:36:46 OpenWrt user.notice root: mwan3: Lost 27 ping(s) on interface wan (eth0.2)
Nov  6 18:36:56 OpenWrt user.notice root: mwan3: Interface wan (eth0.2) is online
Nov  6 18:36:57 OpenWrt user.notice ifup: Allowing Router Advertisements on wan (eth0.2)
Nov  6 18:36:57 OpenWrt user.notice root: mwan3: ifup interface wan (eth0.2)
Nov  6 18:36:58 OpenWrt user.info sysinit: /sbin/hotplug-call: eval: line 1: arithmetic syntax error &lt;--- ????
Nov  6 18:36:59 OpenWrt user.info firewall: adding wan (eth0.2) to zone wan
Nov  6 18:36:59 OpenWrt user.notice root: starting ntpclient
Nov  6 18:37:01 OpenWrt user.info syslog: SNet version started</code></pre></div><p>3. I have configured 3g_only policy to one host in Internet, it works great but when I lose WAN connection and then recover, 3g_only policy is skipped and packets are transmitted through default WAN interface. I think it&#039;s bug.</p><div class="codebox"><pre><code>LAN:
ping 178.239.142.103
PING 178.239.142.103 (178.239.142.103): 56 data bytes
64 bytes from 178.239.142.103: seq=0 ttl=59 time=114.638 ms
64 bytes from 178.239.142.103: seq=1 ttl=59 time=137.409 ms
64 bytes from 178.239.142.103: seq=2 ttl=59 time=137.772 ms
64 bytes from 178.239.142.103: seq=3 ttl=59 time=127.574 ms
64 bytes from 178.239.142.103: seq=4 ttl=59 time=127.494 ms
64 bytes from 178.239.142.103: seq=5 ttl=59 time=97.655 ms
64 bytes from 178.239.142.103: seq=6 ttl=59 time=127.428 ms

(now unplugged cable)

64 bytes from 178.239.142.103: seq=7 ttl=59 time=127.944 ms
64 bytes from 178.239.142.103: seq=8 ttl=59 time=137.534 ms
64 bytes from 178.239.142.103: seq=9 ttl=59 time=127.438 ms
64 bytes from 178.239.142.103: seq=10 ttl=59 time=127.405 ms
64 bytes from 178.239.142.103: seq=11 ttl=59 time=147.516 ms
64 bytes from 178.239.142.103: seq=12 ttl=59 time=178.079 ms
64 bytes from 178.239.142.103: seq=13 ttl=59 time=137.632 ms
64 bytes from 178.239.142.103: seq=14 ttl=59 time=117.660 ms
64 bytes from 178.239.142.103: seq=15 ttl=59 time=137.402 ms
64 bytes from 178.239.142.103: seq=16 ttl=59 time=137.862 ms
^C
--- 178.239.142.103 ping statistics ---
17 packets transmitted, 17 packets received, 0% packet loss
round-trip min/avg/max = 97.655/132.143/178.079 ms

(restart ping, still 3g - nice, in router logread nothing special - same as above)

 ping 178.239.142.103
PING 178.239.142.103 (178.239.142.103): 56 data bytes
64 bytes from 178.239.142.103: seq=0 ttl=59 time=144.467 ms
64 bytes from 178.239.142.103: seq=1 ttl=59 time=156.569 ms
64 bytes from 178.239.142.103: seq=2 ttl=59 time=157.202 ms
64 bytes from 178.239.142.103: seq=3 ttl=59 time=137.295 ms
64 bytes from 178.239.142.103: seq=4 ttl=59 time=137.326 ms

(plugged cable again, still 3g, router as above)

64 bytes from 178.239.142.103: seq=22 ttl=59 time=172.131 ms
64 bytes from 178.239.142.103: seq=23 ttl=59 time=162.011 ms
64 bytes from 178.239.142.103: seq=24 ttl=59 time=132.268 ms
64 bytes from 178.239.142.103: seq=25 ttl=59 time=122.700 ms
^C
--- 178.239.142.103 ping statistics ---
26 packets transmitted, 26 packets received, 0% packet loss
round-trip min/avg/max = 122.463/182.312/433.090 ms

(restart ping)

-&gt; ping 178.239.142.103
PING 178.239.142.103 (178.239.142.103): 56 data bytes
64 bytes from 178.239.142.103: seq=0 ttl=55 time=30.884 ms &lt;-- ?? why WAN?
64 bytes from 178.239.142.103: seq=1 ttl=55 time=30.535 ms
^C
--- 178.239.142.103 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 30.535/30.709/30.884 ms</code></pre></div><p>4. I don&#039;t want have connected 3g interface all the time, how disable it and allow to ifup when nessecary?<br />5. It&#039;s possible to connect another wired WAN connection to loadbalancing, but this connection has same gateway as first, this is problem?</p><p>Logs and outputs:</p><p>ping -c 1 -I eth0.2 <a href="http://www.google.com">www.google.com</a><br /></p><div class="codebox"><pre><code>PING www.google.com (173.194.65.99): 56 data bytes
64 bytes from 173.194.65.99: seq=0 ttl=47 time=36.085 ms

--- www.google.com ping statistics ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 36.085/36.085/36.085 ms


ping -c 1 -I 3g-aero www.google.com
PING www.google.com (173.194.65.103): 56 data bytes
64 bytes from 173.194.65.103: seq=0 ttl=45 time=222.763 ms

--- www.google.com ping statistics ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 222.763/222.763/222.763 ms



root@OpenWrt:~# logread | grep mw
Nov  6 18:27:16 OpenWrt user.notice root: mwan3: ifup interface wan (eth0.2)
Nov  6 18:28:27 OpenWrt user.notice root: mwan3: ifup interface aero (3g-aero)
Nov  6 18:28:41 OpenWrt user.notice root: mwan3: ifup interface wan (eth0.2)
Nov  6 18:28:47 OpenWrt user.notice root: mwan3: ifup interface aero (3g-aero)


 ifconfig | grep inet
          inet addr:37.209.135.133  P-t-P:10.64.64.64  Mask:255.255.255.255
          inet addr:10.0.0.1  Bcast:10.0.0.255  Mask:255.255.255.0
          inet addr:156.17.227.63  Bcast:156.17.227.127  Mask:255.255.255.128
          inet addr:127.0.0.1  Mask:255.0.0.0

root@OpenWrt:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         156.17.227.126  0.0.0.0         UG    10     0        0 eth0.2
0.0.0.0         10.64.64.64     0.0.0.0         UG    30     0        0 3g-aero
10.0.0.0        0.0.0.0         255.255.255.0   U     0      0        0 br-lan
10.64.64.64     0.0.0.0         255.255.255.255 UH    0      0        0 3g-aero
156.17.227.0    0.0.0.0         255.255.255.128 U     10     0        0 eth0.2


root@OpenWrt:~# ip rule show
0:      from all lookup local
1001:   from 156.17.227.63 fwmark 0x0/0x8000 lookup 1001
1002:   from 37.209.135.133 fwmark 0x0/0x8000 lookup 1002
1008:   from all fwmark 0x100/0xff00 lookup 1001
1009:   from all fwmark 0x200/0xff00 lookup 1002
1016:   from all fwmark 0x1000/0xff00 lookup 1016
1017:   from all fwmark 0x1100/0xff00 lookup 1017
1018:   from all fwmark 0x1200/0xff00 lookup 1018
1019:   from all fwmark 0x1300/0xff00 lookup 1019
32766:  from all lookup main
32767:  from all lookup default


root@OpenWrt:~# ip route list table 1001
default via 156.17.227.126 dev eth0.2
root@OpenWrt:~# ip route list table 1002
default via 10.64.64.64 dev 3g-aero
root@OpenWrt:~# ip route list table 1008
root@OpenWrt:~# ip route list table 1009
root@OpenWrt:~# ip route list table 1016
default via 156.17.227.126 dev eth0.2  metric 1
blackhole default  metric 1000
root@OpenWrt:~# ip route list table 1017
default via 10.64.64.64 dev 3g-aero  metric 1
blackhole default  metric 1000
root@OpenWrt:~# ip route list table 1018
default  metric 1
        nexthop via 10.64.64.64  dev 3g-aero weight 2
        nexthop via 156.17.227.126  dev eth0.2 weight 1
blackhole default  metric 1000
root@OpenWrt:~# ip route list table 1019
default via 156.17.227.126 dev eth0.2  metric 1
default via 10.64.64.64 dev 3g-aero  metric 2
blackhole default  metric 1000

BEFORE UNPLUG CABLE:
root@OpenWrt:~# iptables -L mwan3_pre -t mangle -v -n
Chain mwan3_pre (2 references)
 pkts bytes target     prot opt in     out     source               destination
 1902  395K CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0           CONNMARK restore mask 0xff00
    4   204 MARK       all  --  3g-aero *       0.0.0.0/0            0.0.0.0/0           MARK xset 0x8200/0xff00
  262 69176 MARK       all  --  eth0.2 *       0.0.0.0/0            0.0.0.0/0           MARK xset 0x8100/0xff00
 1470  300K mwan3_default  all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match !0x8000/0x8000
  291 29110 mwan3_rules  all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff00
root@OpenWrt:~#  iptables -L mwan3_post -t mangle -v -n
Chain mwan3_post (1 references)
 pkts bytes target     prot opt in     out     source               destination
    2   168 MARK       all  --  *      3g-aero  0.0.0.0/0            0.0.0.0/0           mark match !0x8000/0x8000 MARK xset 0x200/0xff00
  437  171K MARK       all  --  *      eth0.2  0.0.0.0/0            0.0.0.0/0           mark match !0x8000/0x8000 MARK xset 0x100/0xff00
  818  320K MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x8000/0x8000 MARK and 0xffff7fff
 1482  515K CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0           CONNMARK save mask 0xff00
root@OpenWrt:~#  iptables -L mwan3_default -t mangle -v -n
Chain mwan3_default (1 references)
 pkts bytes target     prot opt in     out     source               destination
   43  8539 MARK       all  --  *      *       0.0.0.0/0            224.0.0.0/3         mark match !0x8000/0x8000 MARK or 0x8000
  126 18060 MARK       all  --  *      *       0.0.0.0/0            10.0.0.0/24         mark match !0x8000/0x8000 MARK or 0x8000
    0     0 MARK       all  --  *      *       0.0.0.0/0            10.64.64.64         mark match !0x8000/0x8000 MARK or 0x8000
    0     0 MARK       all  --  *      *       0.0.0.0/0            156.17.227.0/25     mark match !0x8000/0x8000 MARK or 0x8000
root@OpenWrt:~# iptables -L mwan3_rules -t mangle -v -n
Chain mwan3_rules (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 MARK       all  --  *      *       0.0.0.0/0            178.239.142.103     mark match 0x0/0xff00 MARK xset 0x1100/0xff00
   50  2981 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff00 MARK xset 0x1300/0xff00

AFTER CABLE UNPLUG:
 iptables -L mwan3_rules -t mangle -v -n
Chain mwan3_rules (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 MARK       all  --  *      *       0.0.0.0/0            178.239.142.103     mark match 0x0/0xff00 MARK xset 0x1100/0xff00
   20  1648 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff00 MARK xset 0x1300/0xff00


AFTER PLUG CALBE AGAIN:
root@OpenWrt:~#  iptables -L mwan3_pre -t mangle -v -n
Chain mwan3_pre (2 references)
 pkts bytes target     prot opt in     out     source               destination
33046   16M CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0           CONNMARK restore mask 0xff00
 1421  176K MARK       all  --  eth0.2 *       0.0.0.0/0            0.0.0.0/0           MARK xset 0x8100/0xff00
10110   12M MARK       all  --  3g-aero *       0.0.0.0/0            0.0.0.0/0           MARK xset 0x8200/0xff00
19272 2411K mwan3_default  all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match !0x8000/0x8000
 2588  186K mwan3_rules  all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x0/0xff00
root@OpenWrt:~#  iptables -L mwan3_post -t mangle -v -n
Chain mwan3_post (1 references)
 pkts bytes target     prot opt in     out     source               destination
 2582  206K MARK       all  --  *      eth0.2  0.0.0.0/0            0.0.0.0/0           mark match !0x8000/0x8000 MARK xset 0x100/0xff00
 7681  841K MARK       all  --  *      3g-aero  0.0.0.0/0            0.0.0.0/0           mark match !0x8000/0x8000 MARK xset 0x200/0xff00
14977   14M MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0           mark match 0x8000/0x8000 MARK and 0xffff7fff
28207   16M CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0           CONNMARK save mask 0xff00
root@OpenWrt:~#  iptables -L mwan3_default -t mangle -v -n
Chain mwan3_default (1 references)
 pkts bytes target     prot opt in     out     source               destination
  515  193K MARK       all  --  *      *       0.0.0.0/0            224.0.0.0/3         mark match !0x8000/0x8000 MARK or 0x8000
 1399  269K MARK       all  --  *      *       0.0.0.0/0            10.0.0.0/24         mark match !0x8000/0x8000 MARK or 0x8000
    0     0 MARK       all  --  *      *       0.0.0.0/0            10.64.64.64         mark match !0x8000/0x8000 MARK or 0x8000
 2837  286K MARK       all  --  *      *       0.0.0.0/0            156.17.227.0/25     mark match !0x8000/0x8000 MARK or 0x8000
root@OpenWrt:~#  iptables -L mwan3_rules -t mangle -v -n
Chain mwan3_rules (1 references)
 pkts bytes target     prot opt in     out     source               destination &lt;-- empty??
root@OpenWrt:~#</code></pre></div><p>Configs:<br /></p><div class="codebox"><pre><code>cat /etc/config/network

config interface &#039;loopback&#039;
        option ifname &#039;lo&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;127.0.0.1&#039;
        option netmask &#039;255.0.0.0&#039;

config interface &#039;lan&#039;
        option ifname &#039;eth0.1&#039;
        option type &#039;bridge&#039;
        option proto &#039;static&#039;
        option netmask &#039;255.255.255.0&#039;
        option ipaddr &#039;10.0.0.1&#039;
        option dns &#039;8.8.8.8 8.8.4.4&#039;

config interface &#039;wan&#039;
        option ifname &#039;eth0.2&#039;
        option proto &#039;dhcp&#039;
        option metric &#039;10&#039;

config switch
        option name &#039;rtl8366rb&#039;
        option reset &#039;1&#039;
        option enable_vlan &#039;1&#039;

config switch_vlan
        option device &#039;rtl8366rb&#039;
        option vlan &#039;1&#039;
        option ports &#039;1 2 3 4 5t&#039;

config switch_vlan
        option device &#039;rtl8366rb&#039;
        option vlan &#039;2&#039;
        option ports &#039;0 5t&#039;

config interface &#039;aero&#039;
        option proto &#039;3g&#039;
        option service &#039;umts&#039;
        option device &#039;/dev/ttyUSB0&#039;
        option apn &#039;darmowy&#039;
        option metric &#039;30&#039;



cat /etc/config/firewall

config defaults
        option syn_flood &#039;1&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;
        option drop_invalid &#039;1&#039;

config zone
        option name &#039;lan&#039;
        option network &#039;lan&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;

config zone
        option name &#039;wan&#039;
        option input &#039;REJECT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;
        option masq &#039;1&#039;
        option mtu_fix &#039;1&#039;
        option network &#039;wan aero&#039;

config forwarding
        option src &#039;lan&#039;
        option dest &#039;wan&#039;

config rule
        option name &#039;Allow-DHCP-Renew&#039;
        option src &#039;wan&#039;
        option proto &#039;udp&#039;
        option dest_port &#039;68&#039;
        option target &#039;ACCEPT&#039;
        option family &#039;ipv4&#039;

config rule
        option name &#039;Allow-Ping&#039;
        option src &#039;wan&#039;
        option proto &#039;icmp&#039;
        option icmp_type &#039;echo-request&#039;
        option family &#039;ipv4&#039;
        option target &#039;ACCEPT&#039;


config include
        option path &#039;/etc/firewall.user&#039;



cat /etc/config/mwan3

config interface &#039;wan&#039;
        option enabled &#039;1&#039;
        list track_ip &#039;8.8.4.4&#039;
        list track_ip &#039;8.8.8.8&#039;
        option reliability &#039;1&#039;
        option count &#039;1&#039;
        option interval &#039;5&#039;
        option timeout &#039;1&#039;
        option down &#039;3&#039;
        option up &#039;3&#039;

config interface &#039;aero&#039;
        option enabled &#039;1&#039;
        list track_ip &#039;8.8.8.8&#039;
        list track_ip &#039;8.8.4.4&#039;
        option reliability &#039;1&#039;
        option count &#039;1&#039;
        option timeout &#039;2&#039;
        option interval &#039;5&#039;
        option down &#039;3&#039;
        option up &#039;3&#039;

config member &#039;wan_m1&#039;
        option interface &#039;wan&#039;
        option metric &#039;1&#039;
        option weight &#039;1&#039;

config member &#039;wan_m2&#039;
        option interface &#039;wan&#039;
        option metric &#039;2&#039;
        option weight &#039;1&#039;

config member &#039;3g_m1&#039;
        option interface &#039;aero&#039;
        option metric &#039;1&#039;
        option weight &#039;2&#039;

config member &#039;3g_m2&#039;
        option interface &#039;aero&#039;
        option metric &#039;2&#039;
        option weight &#039;2&#039;

config policy &#039;wan_only&#039;
        list use_member &#039;wan_m1&#039;

config policy &#039;3g_only&#039;
        list use_member &#039;3g_m1&#039;

config policy &#039;wan_3g_loadbalanced&#039;
        list use_member &#039;wan_m1&#039;
        list use_member &#039;3g_m1&#039;

config policy &#039;wan_pri_3g_sec&#039;
        list use_member &#039;wan_m1&#039;
        list use_member &#039;3g_m2&#039;

config rule
        option proto &#039;all&#039;
        option use_policy &#039;3g_only&#039;
        option dest_ip &#039;178.239.142.103&#039;

config rule
        option dest_ip &#039;0.0.0.0/0&#039;
        option use_policy &#039;wan_pri_3g_sec&#039;</code></pre></div><p>i have also noticed this:<br /></p><div class="codebox"><pre><code>Nov  6 18:05:37 OpenWrt user.info firewall: adding wan (eth0.2) to zone wan
Nov  6 18:05:38 OpenWrt user.info syslog: SNet version started
Nov  6 18:05:38 OpenWrt user.info sysinit: uci: Entry not found &lt;--- ???
Nov  6 18:05:39 OpenWrt user.notice miniupnpd: adding firewall rules for eth0.2 to zone wan</code></pre></div><p>Thanks for any help with this <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />Greetings</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182595">
				<div class="post-metadata">
					<div class="post-num">Post #37</div>
					<div class="post-author">thdyck</div>
					<div class="post-datetime">
						7 Nov 2012, 04:08					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adze,</p><p>Thanks very much to you and Arfett for creating mwan3 and the luci plugin.</p><p>I have tested it with two cable modem connections (one with DHCP, one static IPs) with static source IP policy-based routing, and it is working well overall. This is with a TPLink WR1043ND using the ar71xx packages from your web site running on OpenWrt 12.09 beta 1.</p><p>I have some questions on usage:</p><p>1. Is there a way to specific which WAN IP outgoing traffic should come from? For example, on the interface with the static IPs, I have five public IPs assigned and would like specified internal servers go to out IP1, IP2, etc. matching up to public DNS names pointing to IP1, IP2, etc. However, when I direct traffic from server1 and server2 out this interface, all traffic comes from a single source IP, the main IP of the interface. (I have added the four other IPs as IP aliases on the interface.) I tried using Source NATing for this, but it didn&#039;t work at least initially. If you have any advice on how to do this, that would be appreciated.</p><p>2. If I want all IPs in a given subnet to always send traffic out interface WAN2 except that, if WAN2 is down, then they should use WAN1, is the policy &quot;wan2_pri_wan1_sec&quot; the correct one to use?</p><p>3. The rules have autogenerated names such as cfg0d92bd. Is it OK to change these to use more descriptive rule names such as &quot;DMZ subnet source to use WAN2&quot;?</p><p>4. If an interface fails the ping test, I would like to get an alert of some kind. Is there a suggested way to get this? Send the syslog to a remote syslog server and look for a specific syslog alert string there?</p><p>5. To control the time for an interface failover, is it (Ping interval+Ping timeout) in seconds x Interface down number of pings? For example, the default configuration is a 2 second ping timeout and a 5 second ping interval, and 3 failed pings to mark an interface down, so the sequence would be ping 1 works, interface fails right after, wait 5 sec, ping 2 fails (2 sec timeout), wait 5 sec, ping 3 fails (2 sec timeout), wait 5 sec, ping 4 fails (2 sec), initiate failover to other interface? This would be 21 seconds plus the failover time.</p><p>6. LUCI item: In the &quot;Multiwan policy configuration&quot; and &quot;Multiwan rule configuration&quot; LuCI pages, it would be nice to have the &quot;Member used&quot; and &quot;Policy assigned&quot; fields be drop-down lists to avoid typos.</p><p>7. LUCI item: In &quot;Multiwan interface configuration&quot;, just the first Test IP shows in the web page.</p><p>8. Any news on getting these packages into the opkg repository for Attitude Adjustment?</p><p>Thanks again,<br />Tim</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182719">
				<div class="post-metadata">
					<div class="post-num">Post #38</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						8 Nov 2012, 15:12					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>rysi3k wrote:</cite><blockquote><p>1. I&#039;m pinging from LAN to WAN IP and when i unplug WAN cable, ping begins to loss packets and for working i must restart it to make it work with 3g, this is normal behavior?</p></blockquote></div><p>Yes. mwan3 marks traffic based on sessions. Only on a new session will mwan3 determine which interface to exit. Once you have a ping running on your desktop machine, all subsequent pings are considered to be one session. Maybe i wiil change this in the future for icmp. The reason mwan3 works this way is that when a failed wan comes back online, all current transfers keep working.</p><div class="quotebox"><cite>rysi3k wrote:</cite><blockquote><p>2. Next, when I plug WAN cable again (and ping works through 3g interface), packets are still transmitted through 3g, there is no switch to normal WAN, that&#039;s ok?</p></blockquote></div><p>Yes, same reason as question 1.</p><div class="quotebox"><cite>rysi3k wrote:</cite><blockquote><p>3. I have configured 3g_only policy to one host in Internet, it works great but when I lose WAN connection and then recover, 3g_only policy is skipped and packets are transmitted through default WAN interface. I think it&#039;s bug.</p></blockquote></div><p>It looks like a bug, although i can&#039;t seem to reproduce it on my own router. Maybe i could get access to your router sometimes and do some more testing? I will try to reproduce it later on, but i am kinda busy this week.. Thanks for the extensive info.</p><div class="quotebox"><cite>rysi3k wrote:</cite><blockquote><p>4. I don&#039;t want have connected 3g interface all the time, how disable it and allow to ifup when nessecary?</p></blockquote></div><p>Look for the demand option in your network config.</p><div class="quotebox"><cite>rysi3k wrote:</cite><blockquote><p>5. It&#039;s possible to connect another wired WAN connection to loadbalancing, but this connection has same gateway as first, this is problem?</p></blockquote></div><p>No... that is not possible...</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 8 Nov 2012, 16:41)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182726">
				<div class="post-metadata">
					<div class="post-num">Post #39</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						8 Nov 2012, 17:00					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>thdyck wrote:</cite><blockquote><p>1. Is there a way to specific which WAN IP outgoing traffic should come from? For example, on the interface with the static IPs, I have five public IPs assigned and would like specified internal servers go to out IP1, IP2, etc. matching up to public DNS names pointing to IP1, IP2, etc. However, when I direct traffic from server1 and server2 out this interface, all traffic comes from a single source IP, the main IP of the interface. (I have added the four other IPs as IP aliases on the interface.) I tried using Source NATing for this, but it didn&#039;t work at least initially. If you have any advice on how to do this, that would be appreciated.</p></blockquote></div><p>This is outside the scope of mwan3, but is possible. Define your own nat rules based on source ip addresses and add them before the general MASQ rule.</p><div class="quotebox"><cite>thdyck wrote:</cite><blockquote><p>2. If I want all IPs in a given subnet to always send traffic out interface WAN2 except that, if WAN2 is down, then they should use WAN1, is the policy &quot;wan2_pri_wan1_sec&quot; the correct one to use?</p></blockquote></div><p>Yes... Assuming that this policy has the correct members set. It is just a policy name...</p><div class="quotebox"><cite>thdyck wrote:</cite><blockquote><p>3. The rules have autogenerated names such as cfg0d92bd. Is it OK to change these to use more descriptive rule names such as &quot;DMZ subnet source to use WAN2&quot;?</p></blockquote></div><p>Yes, but spaces are not allowed.</p><div class="quotebox"><cite>thdyck wrote:</cite><blockquote><p>4. If an interface fails the ping test, I would like to get an alert of some kind. Is there a suggested way to get this? Send the syslog to a remote syslog server and look for a specific syslog alert string there?</p></blockquote></div><p>You can try logtrigger to trigger an event in case of specific log entry.</p><div class="quotebox"><cite>thdyck wrote:</cite><blockquote><p>5. To control the time for an interface failover, is it (Ping interval+Ping timeout) in seconds x Interface down number of pings? For example, the default configuration is a 2 second ping timeout and a 5 second ping interval, and 3 failed pings to mark an interface down, so the sequence would be ping 1 works, interface fails right after, wait 5 sec, ping 2 fails (2 sec timeout), wait 5 sec, ping 3 fails (2 sec timeout), wait 5 sec, ping 4 fails (2 sec), initiate failover to other interface? This would be 21 seconds plus the failover time.</p></blockquote></div><p>Yes. The total time it takes for mwan3 to consider an interface down is: ((( count * timeout ) + interval ) * down). So for default it is ((( 1 * 2 ) + 5 ) * 3 ) = 21 sec. Default value for up is: ((( 1 * rtt ) + 5 ) * 5 ) = &gt;25 sec (where rtt is roundtriptime for ping reply).</p><div class="quotebox"><cite>thdyck wrote:</cite><blockquote><p>6. LUCI item: In the &quot;Multiwan policy configuration&quot; and &quot;Multiwan rule configuration&quot; LuCI pages, it would be nice to have the &quot;Member used&quot; and &quot;Policy assigned&quot; fields be drop-down lists to avoid typos.</p></blockquote></div><p>WiP, but it&#039;s more Arfett&#039;s project.</p><div class="quotebox"><cite>thdyck wrote:</cite><blockquote><p>7. LUCI item: In &quot;Multiwan interface configuration&quot;, just the first Test IP shows in the web page.</p></blockquote></div><p>Not the case here... works fine...</p><div class="quotebox"><cite>thdyck wrote:</cite><blockquote><p>8. Any news on getting these packages into the opkg repository for Attitude Adjustment?</p></blockquote></div><p>No, but there is no need. You can add my repository to feeds.conf.default. This to keep a clear seperation between OpenWRT project and my packages.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 8 Nov 2012, 20:08)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182999">
				<div class="post-metadata">
					<div class="post-num">Post #40</div>
					<div class="post-author">bearh</div>
					<div class="post-datetime">
						12 Nov 2012, 01:34					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>I&#039;ve just installed new openwrt on a new router (NETGEAR 3800). I added mwan3 support. Now wan interfaces are working correctly but mwan3 does not. I tried to guess what causes the problem by typing mwan3 commands. The Internet works correctly until I type:</p><div class="codebox"><pre><code>root@signum:~# ip rule add pref 1009 fwmark 0x200/0xff00 table 1002</code></pre></div><p>I have no idea why it does not work. iptables rules looks as good as ip route table.</p><p>Could anyone help me to solve this problem?</p><p>Some details:<br />Now I am using 2 wan interfaces: <br />1. wan_static: eth1.10 10.0.1.2/30<br />2. wan_dynamic: eth1 10.0.1.6/30<br />During tests wan_dynamic is offline (problem with provider)</p><p>Troubleshooting:<br /></p><div class="codebox"><pre><code>root@signum:~# ip rule show
0:    from all lookup local 
1001:    from 10.0.1.6 fwmark 0x0/0x8000 lookup 1001 
1002:    from 10.0.1.2 fwmark 0x0/0x8000 lookup 1002 
1008:    from all fwmark 0x100/0xff00 lookup 1001 
1009:    from all fwmark 0x200/0xff00 lookup 1002 
1016:    from all fwmark 0x1000/0xff00 lookup 1016 
1017:    from all fwmark 0x1100/0xff00 lookup 1017 
1018:    from all fwmark 0x1200/0xff00 lookup 1018 
32766:    from all lookup main 
32767:    from all lookup default

root@signum:~# ip route list table 1001
root@signum:~# ip route list table 1002
default via 10.0.1.1 dev eth1.10 
root@signum:~# ip route list table 1008
root@signum:~# ip route list table 1009
root@signum:~# ip route list table 1016
blackhole default  metric 1000 
root@signum:~# ip route list table 1017
blackhole default  metric 1000 
root@signum:~# ip route list table 1018
blackhole default  metric 1000

root@signum:~# iptables -L mwan3_pre -t mangle -v -n
Chain mwan3_pre (2 references)
 pkts bytes target     prot opt in     out     source               destination         
84815   19M CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0           CONNMARK restore mask 0xff00 
 9462 4118K MARK       all  --  eth1.10 *       0.0.0.0/0            0.0.0.0/0           MARK set 0x2008 
    0     0 MARK       all  --  eth1   *       0.0.0.0/0            0.0.0.0/0           MARK xset 0x8100/0xff00

root@signum:~# iptables -L mwan3_post -t mangle -v -n
Chain mwan3_post (1 references)
 pkts bytes target     prot opt in     out     source               destination         
11605 2894K MARK       all  --  *      eth1.10  0.0.0.0/0            0.0.0.0/0           mark match !0x8000/0x8000 MARK xset 0x200/0xff00 
  857 71988 MARK       all  --  *      eth1    0.0.0.0/0            0.0.0.0/0           mark match !0x8000/0x8000 MARK xset 0x100/0xff00 
71585   18M CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0           CONNMARK save mask 0xff00</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183011">
				<div class="post-metadata">
					<div class="post-num">Post #41</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						12 Nov 2012, 09:15					</div>
				</div>
				<div class="post-content content">
					<p>Hi bearh,</p><br /><p>Could you paste me your mwan3 config and the default routing table please?</p><br /><p>Thnx</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183049">
				<div class="post-metadata">
					<div class="post-num">Post #42</div>
					<div class="post-author">bearh</div>
					<div class="post-datetime">
						12 Nov 2012, 20:35					</div>
				</div>
				<div class="post-content content">
					<p>Hello</p><p>Thanks for help.</p><p>Here goes mwan3 config. There is also interface for 3g failover, but I didn&#039;t test it (it was commented out).</p><div class="codebox"><pre><code>config &#039;interface&#039; &#039;wan_static&#039;
    option &#039;enabled&#039; &#039;1&#039;
    list &#039;track_ip&#039; &#039;8.8.4.4&#039;
    list &#039;track_ip&#039; &#039;8.8.8.8&#039;
    list &#039;track_ip&#039; &#039;208.67.222.222&#039;
    list &#039;track_ip&#039; &#039;208.67.220.220&#039;
    option &#039;reliability&#039; &#039;2&#039;
    option &#039;count&#039; &#039;1&#039;
    option &#039;timeout&#039; &#039;2&#039;
    option &#039;interval&#039; &#039;5&#039;
    option &#039;down&#039; &#039;3&#039;
    option &#039;up&#039; &#039;8&#039;

config &#039;interface&#039; &#039;wan_dynamic&#039;
    option &#039;enabled&#039; &#039;1&#039;
    list &#039;track_ip&#039; &#039;8.8.8.8&#039;
    list &#039;track_ip&#039; &#039;8.8.4.4&#039;
    list &#039;track_ip&#039; &#039;208.67.220.220&#039;
    list &#039;track_ip&#039; &#039;208.67.222.222&#039;
    option &#039;reliability&#039; &#039;2&#039;
    option &#039;count&#039; &#039;1&#039;
    option &#039;timeout&#039; &#039;2&#039;
    option &#039;interval&#039; &#039;5&#039;
    option &#039;down&#039; &#039;3&#039;
    option &#039;up&#039; &#039;8&#039;

config &#039;interface&#039; &#039;gsm&#039;
    option &#039;enabled&#039; &#039;1&#039;
    list &#039;track_ip&#039; &#039;8.8.8.8&#039;
    list &#039;track_ip&#039; &#039;208.67.220.220&#039;
    list &#039;track_ip&#039; &#039;194.204.152.34&#039;
    option &#039;reliability&#039; &#039;2&#039;
    option &#039;count&#039; &#039;1&#039;
    option &#039;timeout&#039; &#039;4&#039;
    option &#039;interval&#039; &#039;60&#039;
    option &#039;down&#039; &#039;4&#039;
    option &#039;up&#039; &#039;8&#039;

config &#039;member&#039; &#039;wan_static_pri&#039;
    option &#039;interface&#039; &#039;wan_static&#039;
    option &#039;metric&#039; &#039;2&#039;
    option &#039;weight&#039; &#039;6&#039;

config &#039;member&#039; &#039;wan_dynamic_pri&#039;
    option &#039;interface&#039; &#039;wan_dynamic&#039;
    option &#039;metric&#039; &#039;2&#039;
    option &#039;weight&#039; &#039;6&#039;

config &#039;member&#039; &#039;mobile_failover&#039;
    option &#039;interface&#039; &#039;gsm&#039;
    option &#039;metric&#039; &#039;6&#039;
    option &#039;weight&#039; &#039;2&#039;

config &#039;policy&#039; &#039;wan_static_only&#039;
    list &#039;use_member&#039; &#039;wan_static_pri&#039;

config &#039;policy&#039; &#039;wan_dynamic_only&#039;
    list &#039;use_member&#039; &#039;wan_dynamic_pri&#039;

config &#039;policy&#039; &#039;wan_loadbalanced&#039;
    list &#039;use_member&#039; &#039;wan_static_pri&#039;
    list &#039;use_member&#039; &#039;wan_dynamic_pri&#039;
    list &#039;use_member&#039; &#039;mobile_failover&#039;

#config &#039;policy&#039; &#039;mobile_only&#039;
#    list &#039;use_member&#039; &#039;mobile_failover&#039;


config &#039;rule&#039;
    option &#039;proto&#039; &#039;udp&#039;
    option &#039;src_ip&#039; &#039;10.0.2.2/32&#039;
    option &#039;src_port&#039; &#039;5060&#039;
    option &#039;use_policy&#039; &#039;wan_dynamic_only&#039;

config &#039;rule&#039;
    option &#039;proto&#039; &#039;udp&#039;
    option &#039;src_ip&#039; &#039;10.0.2.2/32&#039;
    option &#039;src_port&#039; &#039;10000:20000&#039;
    option &#039;use_policy&#039; &#039;wan_dynamic_only&#039;

config &#039;rule&#039;
    option &#039;dest_ip&#039; &#039;0.0.0.0/0&#039;
    option &#039;use_policy&#039; &#039;wan_loadbalanced&#039;</code></pre></div><p>Default routing table:</p><div class="codebox"><pre><code>root@signum:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
10.0.1.4        0.0.0.0         255.255.255.252 U     0      0        0 eth1
10.0.1.0        0.0.0.0         255.255.255.252 U     0      0        0 eth1.10
10.0.7.0        0.0.0.0         255.255.255.0   U     0      0        0 eth0.4
10.0.0.0        0.0.0.0         255.255.255.0   U     0      0        0 eth0.5
10.1.0.0        0.0.0.0         255.255.255.0   U     0      0        0 eth0.3
10.0.8.0        0.0.0.0         255.255.255.0   U     0      0        0 eth0.6
10.0.4.0        0.0.0.0         255.255.254.0   U     0      0        0 eth0.2
10.0.2.0        0.0.0.0         255.255.254.0   U     0      0        0 eth0.3
0.0.0.0         10.0.1.5        0.0.0.0         UG    10     0        0 eth1
0.0.0.0         10.0.1.1        0.0.0.0         UG    20     0        0 eth1.10</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183396">
				<div class="post-metadata">
					<div class="post-num">Post #43</div>
					<div class="post-author">bearh</div>
					<div class="post-datetime">
						16 Nov 2012, 09:50					</div>
				</div>
				<div class="post-content content">
					<p>Hello again,</p><p>I noticed something strange on wan (eth1, eth1.10) interfaces (masquerade): the outgoing traffic looks correctly but incoming is doubled:</p><p>tcpdump -n -i eth1:<br /></p><div class="codebox"><pre><code>07:38:30.914435 IP 8.8.8.8.53 &gt; 10.0.1.2.54028: 35837 1/0/0 A 69.171.246.16 (60)
07:38:30.914620 IP 8.8.8.8.53 &gt; 10.0.2.242.54028: 35837 1/0/0 A 69.171.246.16 (60)</code></pre></div><p>10.0.1.2 is openwrt router and 10.0.2.242 is lan destination</p><p>EDIT:</p><p>After some investigation I found that mwan3 works correctly when qos is stopped. Is it possible to run qos and mwan3 simultaneously?</p>											<p class="post-edited">(Last edited by <strong>bearh</strong> on 16 Nov 2012, 11:23)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183416">
				<div class="post-metadata">
					<div class="post-num">Post #44</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						16 Nov 2012, 12:12					</div>
				</div>
				<div class="post-content content">
					<p>Hi bearh,</p><br /><p>One thing strikes me: Your wan interfaces are eth1 and eth1.10. I think this is a problem. As eth1 is a trunk; a tagged frame for vlan0 is not really rfc. I would suggest you change this to eth1.x and eth1.10. (generally don&#039;t use vlan0).</p><p>You mentioned that when you disable QoS, mwan3 works fine. There are different implementations of QoS in OpenWRT. If your QoS package uses mark mask correctly it should work with QoS. If your QoS package does not use mark mask, then it would be a problem. Mwan3 works with mark mask.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183428">
				<div class="post-metadata">
					<div class="post-num">Post #45</div>
					<div class="post-author">bearh</div>
					<div class="post-datetime">
						16 Nov 2012, 14:56					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adze,</p><p>I wish I could configure both wan interfaces to work on vlan10 and vlan11, but my modems have problem with it. It works fine now on vlan0 and vlan10. </p><p>I checked the QoS scripts and realized that you are probably right. They don&#039;t use mark masks. I will use other QoS or repair existing scripts and it should solve my problem.</p><p>Thanks for help.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183546">
				<div class="post-metadata">
					<div class="post-num">Post #46</div>
					<div class="post-author">th3marco</div>
					<div class="post-datetime">
						18 Nov 2012, 00:16					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adze</p><p>I have no Internet access (OpenWrt Attitude Adjustment 12.09-beta2 / LuCI 0.11 Branch (0.11+svn9402))</p><p><span class="postimg"><img src="http://www.abload.de/img/wanpou25.png" alt="PunBB bbcode test" /></span><br />&nbsp; &nbsp; <br />I have these 2 WAN Wi-Fi networks // 2 WIFI USB radio</p><div class="codebox"><pre><code>route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.2.1     0.0.0.0         UG    0      0        0 wlan2
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan
192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 wlan2
192.168.3.0     0.0.0.0         255.255.255.0   U     0      0        0 wlan1

ping -c 1 -I wlan2  www.google.com
PING www.google.com (173.194.35.148): 56 data bytes
64 bytes from 173.194.35.148: seq=0 ttl=49 time=34.755 ms

--- www.google.com ping statistics ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 34.755/34.755/34.755 ms

 ping -c 1 -I wlan1  www.google.com
PING www.google.com (173.194.35.146): 56 data bytes
64 bytes from 173.194.35.146: seq=0 ttl=58 time=32.232 ms

--- www.google.com ping statistics ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 32.232/32.232/32.232 ms


cat  /etc/config/mwan3

config interface &#039;wan2&#039;
        option enabled &#039;1&#039;
        option reliability &#039;1&#039;
        option count &#039;1&#039;
        option timeout &#039;2&#039;
        option interval &#039;5&#039;
        option down &#039;3&#039;
        option up &#039;8&#039;
        list track_ip &#039;8.8.8.8&#039;

config member &#039;wan1_m1_w3&#039;
        option metric &#039;1&#039;
        option weight &#039;3&#039;
        option interface &#039;wan3&#039;

config member &#039;wan1_m2_w3&#039;
        option metric &#039;2&#039;
        option weight &#039;3&#039;
        option interface &#039;wan3&#039;

config member &#039;wan2_m1_w2&#039;
        option interface &#039;wan2&#039;
        option metric &#039;1&#039;
        option weight &#039;2&#039;

config member &#039;wan2_m2_w2&#039;
        option interface &#039;wan2&#039;
        option metric &#039;2&#039;
        option weight &#039;2&#039;

config policy &#039;wan1_only&#039;
        list use_member &#039;wan2_m1_w3&#039;

config policy &#039;wan2_only&#039;
        list use_member &#039;wan2_m1_w2&#039;

config policy &#039;wan1_wan2_loadbalanced&#039;
        list use_member &#039;wan2_m1_w3&#039;
        list use_member &#039;wan3_m1_w2&#039;

config policy &#039;wan1_pri_wan2_sec&#039;
        list use_member &#039;wan1_m1_w3&#039;
        list use_member &#039;wan2_m2_w2&#039;

config policy &#039;wan2_pri_wan1_sec&#039;
        list use_member &#039;wan1_m2_w3&#039;
        list use_member &#039;wan2_m1_w2&#039;

config rule
        option src_ip &#039;192.168.21.0/24&#039;
        option proto &#039;tcp&#039;
        option dest_port &#039;563&#039;
        option use_policy &#039;wan2_only&#039;

config rule
        option src_ip &#039;192.168.21.0/24&#039;
        option proto &#039;tcp&#039;
        option dest_port &#039;995&#039;
        option use_policy &#039;wan1_only&#039;

config rule
        option dest_ip &#039;88.154.0.0/16&#039;
        option proto &#039;tcp&#039;
        option dest_port &#039;1024:65535&#039;
        option equalize &#039;1&#039;
        option use_policy &#039;wan1_wan2_loadbalanced&#039;

config rule
        option dest_ip &#039;77.11.41.0/24&#039;
        option proto &#039;tcp&#039;
        option dest_port &#039;1024:65535&#039;
        option use_policy &#039;wan1_pri_wan2_sec&#039;

config rule
        option dest_ip &#039;112.136.0.0/16&#039;
        option proto &#039;udp&#039;
        option dest_port &#039;5352&#039;
        option use_policy &#039;wan2_pri_wan1_sec&#039;

config rule
        option dest_ip &#039;0.0.0.0/0&#039;
        option use_policy &#039;wan1_wan2_loadbalanced&#039;

config interface &#039;wan3&#039;
        option enabled &#039;1&#039;
        list track_ip &#039;8.8.8.8&#039;
        option reliability &#039;1&#039;
        option count &#039;1&#039;
        option timeout &#039;2&#039;
        option interval &#039;5&#039;
        option down &#039;3&#039;
        option up &#039;3&#039;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183594">
				<div class="post-metadata">
					<div class="post-num">Post #47</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						18 Nov 2012, 16:30					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>th3marco wrote:</cite><blockquote><p>Hi Adze</p><p>I have no Internet access<br /></p><div class="codebox"><pre><code>route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.2.1     0.0.0.0         UG    0      0        0 wlan2
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan
192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 wlan2
192.168.3.0     0.0.0.0         255.255.255.0   U     0      0        0 wlan1</code></pre></div></blockquote></div><p>You haven&#039;t followed my instructions... Spot the difference between your routing table and the one in the example...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183699">
				<div class="post-metadata">
					<div class="post-num">Post #48</div>
					<div class="post-author">th3marco</div>
					<div class="post-datetime">
						19 Nov 2012, 18:32					</div>
				</div>
				<div class="post-content content">
					<p>hello Adze</p><p>I&#039;ve tried it but it&#039;s not about</p><p>Can you help me? What settings I need to make examples?</p><p>Thank you very much</p><div class="codebox"><pre><code>root@OpenWrt:~# ip rule
0:      from all lookup local
1002:   from 192.168.3.100 fwmark 0x0/0x8000 lookup 1002
1009:   from all fwmark 0x200/0xff00 lookup 1002
1016:   from all fwmark 0x1000/0xff00 lookup 1016
1017:   from all fwmark 0x1100/0xff00 lookup 1017
1018:   from all fwmark 0x1200/0xff00 lookup 1018
1019:   from all fwmark 0x1300/0xff00 lookup 1019
1020:   from all fwmark 0x1400/0xff00 lookup 1020
32766:  from all lookup main
32767:  from all lookup default

root@OpenWrt:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.2.1     0.0.0.0         UG    0      0        0 wlan2
192.168.0.0     0.0.0.0         255.255.255.0   U     0      0        0 wlan0
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan
192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 wlan2
192.168.3.0     0.0.0.0         255.255.255.0   U     0      0        0 wlan3

root@OpenWrt:~# cat /etc/config/network

config interface &#039;loopback&#039;
        option ifname &#039;lo&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;127.0.0.1&#039;
        option netmask &#039;255.0.0.0&#039;

config interface &#039;lan&#039;
        option ifname &#039;eth0.1&#039;
        option type &#039;bridge&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;192.168.1.1&#039;
        option netmask &#039;255.255.255.0&#039;

config switch
        option name &#039;rtl8366rb&#039;
        option reset &#039;1&#039;
        option enable_vlan &#039;1&#039;

config switch_vlan
        option device &#039;rtl8366rb&#039;
        option vlan &#039;1&#039;
        option ports &#039;1 2 3 4 5t&#039;

config switch_vlan
        option device &#039;rtl8366rb&#039;
        option vlan &#039;2&#039;
        option ports &#039;0 5t&#039;

config interface &#039;wan2&#039;
        option _orig_ifname &#039;wlan1&#039;
        option _orig_bridge &#039;false&#039;
        option proto &#039;dhcp&#039;

config interface &#039;wan3&#039;
        option proto &#039;dhcp&#039;

config interface &#039;wan&#039;
        option proto &#039;dhcp&#039;


root@OpenWrt:~# cat /etc/config/firewall

config defaults
        option syn_flood &#039;1&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;

config zone
        option name &#039;lan&#039;
        option network &#039;lan&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;

config zone
        option name &#039;wan&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;
        option masq &#039;1&#039;
        option mtu_fix &#039;1&#039;
        option input &#039;REJECT&#039;
        option network &#039;wwan wan&#039;

config rule
        option name &#039;Allow-DHCP-Renew&#039;
        option src &#039;wan&#039;
        option proto &#039;udp&#039;
        option dest_port &#039;68&#039;
        option target &#039;ACCEPT&#039;
        option family &#039;ipv4&#039;

config rule
        option name &#039;Allow-Ping&#039;
        option src &#039;wan&#039;
        option proto &#039;icmp&#039;
        option icmp_type &#039;echo-request&#039;
        option family &#039;ipv4&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-DHCPv6&#039;
        option src &#039;wan&#039;
        option proto &#039;udp&#039;
        option src_ip &#039;fe80::/10&#039;
        option src_port &#039;547&#039;
        option dest_ip &#039;fe80::/10&#039;
        option dest_port &#039;546&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-ICMPv6-Input&#039;
        option src &#039;wan&#039;
        option proto &#039;icmp&#039;
        list icmp_type &#039;echo-request&#039;
        list icmp_type &#039;echo-reply&#039;
        list icmp_type &#039;destination-unreachable&#039;
        list icmp_type &#039;packet-too-big&#039;
        list icmp_type &#039;time-exceeded&#039;
        list icmp_type &#039;bad-header&#039;
        list icmp_type &#039;unknown-header-type&#039;
        list icmp_type &#039;router-solicitation&#039;
        list icmp_type &#039;neighbour-solicitation&#039;
        list icmp_type &#039;router-advertisement&#039;
        list icmp_type &#039;neighbour-advertisement&#039;
        option limit &#039;1000/sec&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-ICMPv6-Forward&#039;
        option src &#039;wan&#039;
        option dest &#039;*&#039;
        option proto &#039;icmp&#039;
        list icmp_type &#039;echo-request&#039;
        list icmp_type &#039;echo-reply&#039;
        list icmp_type &#039;destination-unreachable&#039;
        list icmp_type &#039;packet-too-big&#039;
        list icmp_type &#039;time-exceeded&#039;
        list icmp_type &#039;bad-header&#039;
        list icmp_type &#039;unknown-header-type&#039;
        option limit &#039;1000/sec&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config include
        option path &#039;/etc/firewall.user&#039;

config zone
        option forward &#039;REJECT&#039;
        option output &#039;ACCEPT&#039;
        option input &#039;REJECT&#039;
        option masq &#039;1&#039;
        option mtu_fix &#039;1&#039;
        option name &#039;wan2&#039;
        option network &#039;wan2&#039;

config zone
        option name &#039;wan3&#039;
        option forward &#039;REJECT&#039;
        option output &#039;ACCEPT&#039;
        option network &#039;wan3&#039;
        option input &#039;REJECT&#039;
        option masq &#039;1&#039;
        option mtu_fix &#039;1&#039;

config forwarding
        option dest &#039;wan&#039;
        option src &#039;lan&#039;

config forwarding
        option dest &#039;wan2&#039;
        option src &#039;lan&#039;

config forwarding
        option dest &#039;wan3&#039;
        option src &#039;lan&#039;

root@OpenWrt:~# clear
root@OpenWrt:~# cat /etc/config/firewall

config defaults
        option syn_flood &#039;1&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;

config zone
        option name &#039;lan&#039;
        option network &#039;lan&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;

config zone
        option name &#039;wan&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;
        option masq &#039;1&#039;
        option mtu_fix &#039;1&#039;
        option input &#039;REJECT&#039;
        option network &#039;wwan wan&#039;

config rule
        option name &#039;Allow-DHCP-Renew&#039;
        option src &#039;wan&#039;
        option proto &#039;udp&#039;
        option dest_port &#039;68&#039;
        option target &#039;ACCEPT&#039;
        option family &#039;ipv4&#039;

config rule
        option name &#039;Allow-Ping&#039;
        option src &#039;wan&#039;
        option proto &#039;icmp&#039;
        option icmp_type &#039;echo-request&#039;
        option family &#039;ipv4&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-DHCPv6&#039;
        option src &#039;wan&#039;
        option proto &#039;udp&#039;
        option src_ip &#039;fe80::/10&#039;
        option src_port &#039;547&#039;
        option dest_ip &#039;fe80::/10&#039;
        option dest_port &#039;546&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-ICMPv6-Input&#039;
        option src &#039;wan&#039;
        option proto &#039;icmp&#039;
        list icmp_type &#039;echo-request&#039;
        list icmp_type &#039;echo-reply&#039;
        list icmp_type &#039;destination-unreachable&#039;
        list icmp_type &#039;packet-too-big&#039;
        list icmp_type &#039;time-exceeded&#039;
        list icmp_type &#039;bad-header&#039;
        list icmp_type &#039;unknown-header-type&#039;
        list icmp_type &#039;router-solicitation&#039;
        list icmp_type &#039;neighbour-solicitation&#039;
        list icmp_type &#039;router-advertisement&#039;
        list icmp_type &#039;neighbour-advertisement&#039;
        option limit &#039;1000/sec&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow-ICMPv6-Forward&#039;
        option src &#039;wan&#039;
        option dest &#039;*&#039;
        option proto &#039;icmp&#039;
        list icmp_type &#039;echo-request&#039;
        list icmp_type &#039;echo-reply&#039;
        list icmp_type &#039;destination-unreachable&#039;
        list icmp_type &#039;packet-too-big&#039;
        list icmp_type &#039;time-exceeded&#039;
        list icmp_type &#039;bad-header&#039;
        list icmp_type &#039;unknown-header-type&#039;
        option limit &#039;1000/sec&#039;
        option family &#039;ipv6&#039;
        option target &#039;ACCEPT&#039;

config include
        option path &#039;/etc/firewall.user&#039;

config zone
        option forward &#039;REJECT&#039;
        option output &#039;ACCEPT&#039;
        option input &#039;REJECT&#039;
        option masq &#039;1&#039;
        option mtu_fix &#039;1&#039;
        option name &#039;wan2&#039;
        option network &#039;wan2&#039;

config zone
        option name &#039;wan3&#039;
        option forward &#039;REJECT&#039;
        option output &#039;ACCEPT&#039;
        option network &#039;wan3&#039;
        option input &#039;REJECT&#039;
        option masq &#039;1&#039;
        option mtu_fix &#039;1&#039;

config forwarding
        option dest &#039;wan&#039;
        option src &#039;lan&#039;

config forwarding
        option dest &#039;wan2&#039;
        option src &#039;lan&#039;

config forwarding
        option dest &#039;wan3&#039;
        option src &#039;lan&#039;</code></pre></div>											<p class="post-edited">(Last edited by <strong>th3marco</strong> on 19 Nov 2012, 21:04)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183739">
				<div class="post-metadata">
					<div class="post-num">Post #49</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						20 Nov 2012, 10:06					</div>
				</div>
				<div class="post-content content">
					<p>Hi Th3marco,</p><br /><p>Please try to set metrics on the different wan interfaces, as i explained in OP.</p><p>/etc/config/network<br /></p><div class="codebox"><pre><code>config interface &#039;loopback&#039;
        option ifname &#039;lo&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;127.0.0.1&#039;
        option netmask &#039;255.0.0.0&#039;

config interface &#039;lan&#039;
        option ifname &#039;eth0.1&#039;
        option type &#039;bridge&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;192.168.1.1&#039;
        option netmask &#039;255.255.255.0&#039;

config switch
        option name &#039;rtl8366rb&#039;
        option reset &#039;1&#039;
        option enable_vlan &#039;1&#039;

config switch_vlan
        option device &#039;rtl8366rb&#039;
        option vlan &#039;1&#039;
        option ports &#039;1 2 3 4 5t&#039;

config switch_vlan
        option device &#039;rtl8366rb&#039;
        option vlan &#039;2&#039;
        option ports &#039;0 5t&#039;

config interface &#039;wan2&#039;
        option proto &#039;dhcp&#039;
        option metric &#039;20&#039;

config interface &#039;wan3&#039;
        option proto &#039;dhcp&#039;
        option metric &#039;30&#039;

config interface &#039;wan&#039;
        option proto &#039;dhcp&#039;
        option metric &#039;10&#039;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183757">
				<div class="post-metadata">
					<div class="post-num">Post #50</div>
					<div class="post-author">th3marco</div>
					<div class="post-datetime">
						20 Nov 2012, 13:41					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adze</p><p>Internet is now thanks for the help but the speed :-(</p><p>I reach only 6 Mbit / s<br />wlan0 = 10 Mbit/s <br />wlan1 = 10 Mbit/s<br />wlan2 = 5 Mbit/s</p><p>Wi-Fi signal 99% 1000mw :-)</p><p>Mwan3 Speedtest.Net<br /><span class="postimg"><img src="http://www.speedtest.net/result/2319830928.png" alt="PunBB bbcode test" /></span></p><p><span class="postimg"><img src="http://www.abload.de/img/unbenannti6ui9.png" alt="PunBB bbcode test" /></span></p><p><span class="postimg"><img src="http://www.abload.de/img/fwnju9q.png" alt="PunBB bbcode test" /></span></p><div class="codebox"><pre><code>ping -c 1 -I wlan0 [url=http://www.google.com]www.google.com[/url]
PING [url=http://www.google.com]www.google.com[/url] (173.194.35.145): 56 data bytes
--- [url=http://www.google.com]www.google.com[/url] ping statistics ---
1 packets transmitted, 0 packets received, 100% packet loss

ping -c 1 -I wlan1 [url=http://www.google.com]www.google.com[/url]
PING [url=http://www.google.com]www.google.com[/url] (173.194.35.147): 56 data bytes
--- [url=http://www.google.com]www.google.com[/url] ping statistics ---
1 packets transmitted, 0 packets received, 100% packet loss

ping -c 1 -I wlan2 [url=http://www.google.com]www.google.com[/url]
PING [url=http://www.google.com]www.google.com[/url] (173.194.35.148): 56 data bytes
64 bytes from 173.194.35.148: seq=0 ttl=58 time=31.466 ms

--- [url=http://www.google.com]www.google.com[/url] ping statistics ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 31.466/31.466/31.466 ms

ip route list
default via 192.168.0.1 dev wlan0  proto static  metric 10
default via 192.168.3.1 dev wlan2  proto static  metric 20
default via 192.168.2.1 dev wlan1  proto static  metric 30
192.168.0.0/24 dev wlan0  proto static  scope link  metric 10
192.168.1.0/24 dev br-lan  proto kernel  scope link  src 192.168.1.1
192.168.2.0/24 dev wlan1  proto static  scope link  metric 30
192.168.3.0/24 dev wlan2  proto static  scope link  metric 20

route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.0.1     0.0.0.0         UG    10     0        0 wlan0
0.0.0.0         192.168.3.1     0.0.0.0         UG    20     0        0 wlan2
0.0.0.0         192.168.2.1     0.0.0.0         UG    30     0        0 wlan1
192.168.0.0     0.0.0.0         255.255.255.0   U     10     0        0 wlan0
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan
192.168.2.0     0.0.0.0         255.255.255.0   U     30     0        0 wlan1
192.168.3.0     0.0.0.0         255.255.255.0   U     20     0        0 wlan2

logread | grep mwan3
Nov 20 12:09:22 OpenWrt user.notice root: mwan3: ifup interface wan2 (wlan2)
Nov 20 12:09:37 OpenWrt user.notice root: mwan3: ifup interface wan2 (wlan2)
Nov 20 12:12:10 OpenWrt user.notice root: mwan3: Lost 1 ping(s) on interface wan2 (wlan2)

cat /etc/config/network
config interface &#039;loopback&#039;
        option ifname &#039;lo&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;127.0.0.1&#039;
        option netmask &#039;255.0.0.0&#039;

config interface &#039;lan&#039;
        option ifname &#039;eth0.1&#039;
        option type &#039;bridge&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;192.168.1.1&#039;
        option netmask &#039;255.255.255.0&#039;

config switch
        option name &#039;rtl8366rb&#039;
        option reset &#039;1&#039;
        option enable_vlan &#039;1&#039;

config switch_vlan
        option device &#039;rtl8366rb&#039;
        option vlan &#039;1&#039;
        option ports &#039;1 2 3 4 5t&#039;

config switch_vlan
        option device &#039;rtl8366rb&#039;
        option vlan &#039;2&#039;
        option ports &#039;0 5t&#039;

config interface &#039;wan2&#039;
        option proto &#039;dhcp&#039;
        option metric &#039;20&#039;

config interface &#039;wan3&#039;
        option proto &#039;dhcp&#039;
        option metric &#039;30&#039;

config interface &#039;wan&#039;
        option proto &#039;dhcp&#039;
        option metric &#039;10&#039;</code></pre></div>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 2 of 65</div><nav><ul><li><a href="viewtopic.php%3Fid=39052&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=4.html">4</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>