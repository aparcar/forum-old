<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Tp-Link TL1034ND USB Samba miniDLNA Windows</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 20 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p206528">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">enoon</div>
					<div class="post-datetime">
						5 Jul 2013, 20:47					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>So far I managed to connect my USB drive to the router:</p><p>with the following start-up command for the router:</p><p>ntfs-3g /dev/sda1 /mnt/media/ -o rw,sync</p><p>Also I&#039;ve configured to share it with samba with the default template and:</p><p>[/etc/config/samba]</p><p>config samba<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;name&#039;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&#039;OpenWrt&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;workgroup&#039;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#039;WORKGROUP&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;description&#039;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#039;OpenWrt&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;homes&#039;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#039;1&#039;</p><p>config sambashare<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;name&#039; &#039;media&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;path&#039; &#039;/mnt/media&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;guest_ok&#039; &#039;yes&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;create_mask&#039; &#039;0700&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;dir_mask&#039; &#039;0700&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;read_only&#039; &#039;no&#039;</p><p>Also my miniDLAN configuration as follows:</p><p>[/etc/config/minidlna]<br />config minidlna config<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;enabled&#039; &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option port &#039;8200&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option interface &#039;br-lan&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option friendly_name &#039;DLNA Server&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option db_dir &#039;/mnt/media/minidlna&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option log_dir &#039;/mnt/media/minidlna/log&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option inotify &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option enable_tivo &#039;0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option strict_dlna &#039;0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option presentation_url &#039;<a href="http://192.168.1.1:8200/">http://192.168.1.1:8200/</a>&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option notify_interval &#039;60&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option serial &#039;12345678&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option model_number &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option root_container &#039;.&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; list media_dir &#039;P,/mnt/media&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option album_art_names &#039;Cover.jpg/cover.jpg/AlbumArtSmall.jpg/albumartsmall.jpg/AlbumArt.jpg/albumart.jpg/Album.jpg/album.jpg/Folder.jpg/folder.jpg/Thumb.jpg/th...</p><p>Two issues with this:<br />1) the samba share is very slow, for copying is ~2300kbytes/s (my usb drive is USB3.0 compatible). OS: Windows 8.</p><p>2) the minidlna server is not showing any files, although I have Movies, Pictures and Audio in the share.<br />I was able to view pictures with &#039;P,/mnt/media/pictures&#039;, but &#039;V,/mnt/media/movies&#039; were not showing up. Is it possible for minidlna to scan the whole root folder and share picture/video/audio automatically?</p><p>Attitude Adjustment 12.09</p>											<p class="post-edited">(Last edited by <strong>enoon</strong> on 5 Jul 2013, 21:36)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p206618">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">ashkanull</div>
					<div class="post-datetime">
						7 Jul 2013, 12:13					</div>
				</div>
				<div class="post-content content">
					<p>1.try with linux filesystems they consume less resources. <a href="https://forum.openwrt.org/viewtopic.php?id=27750">https://forum.openwrt.org/viewtopic.php?id=27750</a><br />2.there are also some tweaks with formatting your flash to adjust the blocks on flash blocks more info : <a href="http://www.raspberrypi.org/phpBB3/viewtopic.php?f=9&amp;t=850">http://www.raspberrypi.org/phpBB3/viewt … &amp;t=850</a> .<br />3.you can also manage flags such as noatime in fstab <a href="http://wiki.openwrt.org/doc/uci/fstab">http://wiki.openwrt.org/doc/uci/fstab</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p206630">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">Boompje123</div>
					<div class="post-datetime">
						7 Jul 2013, 13:38					</div>
				</div>
				<div class="post-content content">
					<p>Use ext3 (or ext4 but personally I have better experience with ext3)</p><p>Change the sync flag to async or remove it completely<br />Should help with speed</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p206747">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">enoon</div>
					<div class="post-datetime">
						8 Jul 2013, 21:29					</div>
				</div>
				<div class="post-content content">
					<p>here is my update:</p><p>restarted with a fresh install<br />formatted the USB 3.0 external hdd as ext4<br />mounted<br />configured samba<br />configured dlna</p><p>problem #2 seems to be solved, all my files are seen and scanned by the server so I gave only the root dir /mnt/media to miniDLNA config and it successfully lists audio/video/images for the TV</p><p>regarding problem #1:</p><p>Seems like the flag sync slows down even the ext4 file system, so instead of ~2500k/s it&#039;s writing/reading with ~4500 which has exactly as same performance as with the NTFS filesystem.</p><p>I&#039;ve also put the NOTRACK option in the firewall.</p><p>It must be something else, only the basic packages were installed like kmod-usb-core kmod-usb-ohci kmod-usb-storage kmod-usb2 samba36-server and minidlna.</p><p>The format was made with no_journaling option and is mounted like:<br />/dev/sda1 on /mnt/media type ext4 (rw,relatime,user_xattr,barrier=1,data=ordered)</p><p>Anyone any ideas for the slow USB speed problem?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p206769">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">C007dudz</div>
					<div class="post-datetime">
						9 Jul 2013, 06:50					</div>
				</div>
				<div class="post-content content">
					<p>not sure if this could help but you can try some of the points here.</p><p><a href="http://aspiregemstone.blogspot.com/2011/07/hacking-tp-link-wr1043nd-part-4.html">http://aspiregemstone.blogspot.com/2011 … art-4.html</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p206792">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">enoon</div>
					<div class="post-datetime">
						9 Jul 2013, 20:09					</div>
				</div>
				<div class="post-content content">
					<p>Great article for fine tuning thanks.</p><p>I connected an ethernet cable and tried to use samba got ~8500kilo/sec which is far from normal throughput.<br />As for the resources Samba is the greediest:</p><p>CPU:&nbsp; 19% usr&nbsp; 47% sys&nbsp; &nbsp;0% nic&nbsp; &nbsp;0% idle&nbsp; &nbsp;0% io&nbsp; &nbsp;0% irq&nbsp; 32% sirq<br />Load average: 3.31 1.78 0.88 2/53 7272<br />&nbsp; PID&nbsp; PPID USER&nbsp; &nbsp; &nbsp;STAT&nbsp; &nbsp;VSZ %VSZ %CPU COMMAND<br /> 5802&nbsp; 1777 nobody&nbsp; &nbsp;R&nbsp; &nbsp; &nbsp;3688&nbsp; 13%&nbsp; 65% /usr/sbin/smbd -D<br />&nbsp; 477&nbsp; &nbsp; &nbsp;2 root&nbsp; &nbsp; &nbsp;SW&nbsp; &nbsp; &nbsp; &nbsp;0&nbsp; &nbsp;0%&nbsp; 12% [usb-storage]<br />&nbsp; &nbsp; 3&nbsp; &nbsp; &nbsp;2 root&nbsp; &nbsp; &nbsp;SW&nbsp; &nbsp; &nbsp; &nbsp;0&nbsp; &nbsp;0%&nbsp; &nbsp;6% [ksoftirqd/0]<br /> 4068&nbsp; &nbsp; &nbsp;1 root&nbsp; &nbsp; &nbsp;S&nbsp; &nbsp; &nbsp;1432&nbsp; &nbsp;5%&nbsp; &nbsp;3% hostapd -P /var/run/wifi-phy0.pid -B<br />&nbsp; &nbsp; 4&nbsp; &nbsp; &nbsp;2 root&nbsp; &nbsp; &nbsp;SW&nbsp; &nbsp; &nbsp; &nbsp;0&nbsp; &nbsp;0%&nbsp; &nbsp;2% [kworker/0:0]<br />&nbsp; 746&nbsp; &nbsp; &nbsp;2 root&nbsp; &nbsp; &nbsp;SW&nbsp; &nbsp; &nbsp; &nbsp;0&nbsp; &nbsp;0%&nbsp; &nbsp;2% [flush-8:0]<br />&nbsp; &nbsp;95&nbsp; &nbsp; &nbsp;2 root&nbsp; &nbsp; &nbsp;DW&nbsp; &nbsp; &nbsp; &nbsp;0&nbsp; &nbsp;0%&nbsp; &nbsp;1% [kswapd0]<br />&nbsp; &nbsp; 5&nbsp; &nbsp; &nbsp;2 root&nbsp; &nbsp; &nbsp;SW&nbsp; &nbsp; &nbsp; &nbsp;0&nbsp; &nbsp;0%&nbsp; &nbsp;0% [kworker/u:0]<br /> 6986&nbsp; 6981 root&nbsp; &nbsp; &nbsp;R&nbsp; &nbsp; &nbsp;1500&nbsp; &nbsp;5%&nbsp; &nbsp;0% top<br /> 1716&nbsp; &nbsp; &nbsp;1 root&nbsp; &nbsp; &nbsp;S&nbsp; &nbsp; &nbsp;1156&nbsp; &nbsp;4%&nbsp; &nbsp;0% /usr/sbin/uhttpd -f -h /www -r WiFiGr<br /> 1696&nbsp; &nbsp; &nbsp;1 root&nbsp; &nbsp; &nbsp;S&nbsp; &nbsp; &nbsp;9160&nbsp; 31%&nbsp; &nbsp;0% /usr/bin/minidlna -f /tmp/minidlna.co<br /> 4863&nbsp; 1777 root&nbsp; &nbsp; &nbsp;S&nbsp; &nbsp; &nbsp;3688&nbsp; 13%&nbsp; &nbsp;0% /usr/sbin/smbd -D<br /> 1779&nbsp; &nbsp; &nbsp;1 root&nbsp; &nbsp; &nbsp;S&nbsp; &nbsp; &nbsp;3196&nbsp; 11%&nbsp; &nbsp;0% /usr/sbin/nmbd -D<br /> 1777&nbsp; &nbsp; &nbsp;1 root&nbsp; &nbsp; &nbsp;S&nbsp; &nbsp; &nbsp;3116&nbsp; 11%&nbsp; &nbsp;0% /usr/sbin/smbd -D<br />&nbsp; 745&nbsp; &nbsp;674 root&nbsp; &nbsp; &nbsp;S&nbsp; &nbsp; &nbsp;1620&nbsp; &nbsp;6%&nbsp; &nbsp;0% /usr/sbin/pppd nodetach ipparam wan i<br />&nbsp; 674&nbsp; &nbsp; &nbsp;1 root&nbsp; &nbsp; &nbsp;S&nbsp; &nbsp; &nbsp;1540&nbsp; &nbsp;5%&nbsp; &nbsp;0% /sbin/netifd<br />&nbsp; 619&nbsp; &nbsp; &nbsp;1 root&nbsp; &nbsp; &nbsp;S&nbsp; &nbsp; &nbsp;1508&nbsp; &nbsp;5%&nbsp; &nbsp;0% /sbin/syslogd -l 8 -C16<br />&nbsp; &nbsp; 1&nbsp; &nbsp; &nbsp;0 root&nbsp; &nbsp; &nbsp;S&nbsp; &nbsp; &nbsp;1504&nbsp; &nbsp;5%&nbsp; &nbsp;0% init<br /> 6981&nbsp; 6848 root&nbsp; &nbsp; &nbsp;S&nbsp; &nbsp; &nbsp;1504&nbsp; &nbsp;5%&nbsp; &nbsp;0% -ash<br />^C142&nbsp; 2141 root&nbsp; &nbsp; &nbsp;S&nbsp; &nbsp; &nbsp;1504&nbsp; &nbsp;5%&nbsp; &nbsp;0% -ash</p><p>Something still seems wrong, but can;t figure out what exactly, any ideeas?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p206804">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">Boompje123</div>
					<div class="post-datetime">
						9 Jul 2013, 22:39					</div>
				</div>
				<div class="post-content content">
					<p>Read up on the kind of speeds other people are getting USB HDD (ext4) &gt; LAN on the 1043nd. Are you very far off?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p206808">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">enoon</div>
					<div class="post-datetime">
						9 Jul 2013, 23:20					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Boompje123 wrote:</cite><blockquote><p>Read up on the kind of speeds other people are getting USB HDD (ext4) &gt; LAN on the 1043nd. Are you very far off?</p></blockquote></div><p>Yes: ~4500kylobytes per second instead of 10MB/s</p><p>PS: recently partitioned and formatted as ext4. Same slow speed.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p207167">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">enoon</div>
					<div class="post-datetime">
						15 Jul 2013, 09:09					</div>
				</div>
				<div class="post-content content">
					<p>So any thoughts on what should be the issue?</p><p>USB 3.0 external hdd connected and mounted as ext3 fs and shared over the network with samba has a terrible slow speed 4500k/s.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p207296">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">C007dudz</div>
					<div class="post-datetime">
						16 Jul 2013, 17:32					</div>
				</div>
				<div class="post-content content">
					<p>have you tried adding swap space to your config?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p207349">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">enoon</div>
					<div class="post-datetime">
						17 Jul 2013, 08:53					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>C007dudz wrote:</cite><blockquote><p>have you tried adding swap space to your config?</p></blockquote></div><p>No.</p><p>Swap space on the external drive you mean, I guess.<br />You think that there is not enough memory to do large transfers on the device, and it should overflow to swap?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p207353">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">C007dudz</div>
					<div class="post-datetime">
						17 Jul 2013, 10:08					</div>
				</div>
				<div class="post-content content">
					<p>yup, that&#039;s what I think.. a swap space to the external drive could help in that. The device has a small amount of ram in it and the link that I have posted earlier, well, I checked the other pages in that site and it seems he had modified the device with a larger ram, so I think, to fix the ram issue, why not add a swap space. I did that with a former device of mine (E3000 with DDwrt actually, now dead) running minidlna, samba, and rtorrent, and it survived for a few years running without hiccups (apart from me being a noob who tried to upgrade it through wifi, now it&#039;s dead).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p207365">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">alphasparc</div>
					<div class="post-datetime">
						17 Jul 2013, 13:37					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>C007dudz wrote:</cite><blockquote><p>yup, that&#039;s what I think.. a swap space to the external drive could help in that. The device has a small amount of ram in it and the link that I have posted earlier, well, I checked the other pages in that site and it seems he had modified the device with a larger ram, so I think, to fix the ram issue, why not add a swap space. I did that with a former device of mine (E3000 with DDwrt actually, now dead) running minidlna, samba, and rtorrent, and it survived for a few years running without hiccups (apart from me being a noob who tried to upgrade it through wifi, now it&#039;s dead).</p></blockquote></div><p>Actually it didn&#039;t crash not just because I upgraded the RAM.<br />I just updated the post to reflect the changes I did to sysctl.conf to ensure that the router will never crash.<br />It crashes usually because it runs out of memory too fast before it can allocate them.<br />And it is fine to upgrade openwrt over wifi as long as the MD5 sum match the firmware file and you should run<br />sysctl -w vm.drop_caches=1 <br />to free up RAM to take in the firmware in /tmp/ directory.</p>											<p class="post-edited">(Last edited by <strong>alphasparc</strong> on 17 Jul 2013, 13:39)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>