<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> WNDRv4 fit for openwrt - english</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 8 Feb 2018 and 2 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 2 of 17</div><nav><ul><li><a href="viewtopic.php%3Fid=41094&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=41094&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=41094&amp;p=4.html">4</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=41094&amp;p=17.html">17</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p204812">
				<div class="post-metadata">
					<div class="post-num">Post #26</div>
					<div class="post-author">geistio</div>
					<div class="post-datetime">
						17 Jun 2013, 09:23					</div>
				</div>
				<div class="post-content content">
					<p>Hi!</p><p>Isn&#039;t there at least some kind of &quot;test build&quot; somewhere around?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p205279">
				<div class="post-metadata">
					<div class="post-num">Post #27</div>
					<div class="post-author">ronluna</div>
					<div class="post-datetime">
						21 Jun 2013, 21:43					</div>
				</div>
				<div class="post-content content">
					<p>Any news?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p205281">
				<div class="post-metadata">
					<div class="post-num">Post #28</div>
					<div class="post-author">mancr</div>
					<div class="post-datetime">
						21 Jun 2013, 22:12					</div>
				</div>
				<div class="post-content content">
					<p>Hi, I´ve sucessfully build image with GPL NETGEAR firmware, as a result I have an openwrt sysupgrade firmware , but now I can´t not flash into the device ( WNDR3700v4 ) . I´ve investigated and seems that I need to generate a factory openwrt firmware, but anyone knows how is possible ? I´m reading about openwrt build generator but is not clear for me..</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p205528">
				<div class="post-metadata">
					<div class="post-num">Post #29</div>
					<div class="post-author">jolouis</div>
					<div class="post-datetime">
						24 Jun 2013, 17:43					</div>
				</div>
				<div class="post-content content">
					<p>The NETGEAR GPL firmware is easy enough to build and flash to your device. The problem is that it is based on a very old version of openWRT (it&#039;s running kernel 2.6.31), and includes some binary kernel modules and packages to make it work (Ethernet driver, WLAN driver, etc). The busybox and kernel packages are also heavily modified to support the Atheros NAND flash, but what modifications were made to actually make that happen remain undocumented at this point.</p><p>If you&#039;re happy with an older version of openWRT with heavy hacks to the boot process/etc, then the Netgear GPL is workable... but if you want full modern openWRT my understanding is that somebody needs to figure out a driver/support for the NAND flash controller (and probably a few other bits and pieces).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p205632">
				<div class="post-metadata">
					<div class="post-num">Post #30</div>
					<div class="post-author">mancr</div>
					<div class="post-datetime">
						25 Jun 2013, 10:51					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for the response jolouis. as you mentioned GPL is easy to build , and i´m happy with the old kernel version of WRT. My problem is that I didn´t find a way to flash the image, as&nbsp; a result from building GPL I have a sysupgrade.bin that I was trying to flash using tftp but no success, do you know what other methods can work or as alternate how can I pass my sysupgrade image to a factory image ?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p206438">
				<div class="post-metadata">
					<div class="post-num">Post #31</div>
					<div class="post-author">jolouis</div>
					<div class="post-datetime">
						4 Jul 2013, 19:08					</div>
				</div>
				<div class="post-content content">
					<p>When you build the Netgear GPL image if you have done everything correctly you should see in the bin directory a file called &quot;WNDR3400-V1.0.1.42.img&quot; (might vary slightly depending on what version of the GPL SDK you downloaded). If you don&#039;t, re-run your build and double check to make sure things actually succeeded and you have the proper WNDR3400/WNDR4300 target selected. Don&#039;t be fooled, none of the other bin or image files in that directory are able to be flashed to the router.</p><p>Once you&#039;ve got the WNDR3400 image file mentioned above, you can upload it to the router by using the bootloader&#039;s TFTP recovery. To do this, power on the router while holding the small reset button on the bottom. Keep holding it, and the power led will blink amber, then wait a few seconds, and finally start blinking green. Once it&#039;s blinking green, you can TFTP the .img file to 192.168.1.1</p><p>It&#039;s NAND flash, so the write process is pretty quick compared to other routers (usually &lt; 30 seconds), but what I found is for some bizarre reason the router won&#039;t recognize the new firmware (it always gives an Atheros bus error), until you actually power the thing off and back on again. So after your TFTP upload, wait 45-60 seconds to be safe, then power the router off and on again. From that point you should be booting into your build.</p><p>One important thing to note here: the Netgear GPL firmware does a pretty nasty job of hijacking and fudging the normal openWRT boot process. The router also doesn&#039;t do the normal SquashFS/JFFS2 overlay filesystem that you&#039;d expect: instead you get a readonly squashFS, a writeable JFFS2 on /apps (or something like that), and some proprietary &quot;config&quot; partition that holds all of the Netgear settings. With some work you can get it fairly close to the normal openWRT again, but all the steps to that are far beyond what I&#039;d be able to write up.</p>											<p class="post-edited">(Last edited by <strong>jolouis</strong> on 4 Jul 2013, 19:09)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p210765">
				<div class="post-metadata">
					<div class="post-num">Post #32</div>
					<div class="post-author">Zsub</div>
					<div class="post-datetime">
						25 Aug 2013, 16:46					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m currently trying to ubinize the ar71xx target, but I&#039;m afraid I&#039;ll wipe the bootloader if I misconfigure UBI, so I&#039;m kind of afraid to flash generated images <img src="https://forum.openwrt.org/img/smilies/tongue.png" width="15" height="15" alt="tongue"/></p><p>The patch (using trunk) is attached for anyone with a serial cable and more experience and confidence to review (please do) and test. I am fairly sure about the UBIFS_OPTS and UBINIZE_OPTS, as a block is 0x20000 (128KiB), and a page is 0x800(2048B), see also the OEM bootlog on the wiki.</p><div class="codebox"><pre><code>diff --git target/linux/ar71xx/Makefile target/linux/ar71xx/Makefile
index f32c6a3..a64d67d 100644
--- target/linux/ar71xx/Makefile
+++ target/linux/ar71xx/Makefile
@@ -9,7 +9,7 @@ include $(TOPDIR)/rules.mk
 ARCH:=mips
 BOARD:=ar71xx
 BOARDNAME:=Atheros AR7xxx/AR9xxx
-FEATURES:=squashfs targz mips16
+FEATURES:=squashfs ubifs targz mips16
 CFLAGS:=-Os -pipe -mips32r2 -mtune=34kc -mno-branch-likely
 SUBTARGETS:=generic nand

diff --git target/linux/ar71xx/config-3.10 target/linux/ar71xx/config-3.10
index 6c75f14..2556b08 100644
--- target/linux/ar71xx/config-3.10
+++ target/linux/ar71xx/config-3.10
@@ -120,8 +120,11 @@ CONFIG_CPU_R4K_CACHE_TLB=y
 CONFIG_CPU_R4K_FPU=y
 CONFIG_CPU_SUPPORTS_32BIT_KERNEL=y
 CONFIG_CPU_SUPPORTS_HIGHMEM=y
+CONFIG_CRC16=y
+CONFIG_CRYPTO_DEFLATE=y
+CONFIG_CRYPTO_LZO=y
+CONFIG_CRYPTO_XZ=y
 CONFIG_CSRC_R4K=y
-CONFIG_DECOMPRESS_LZMA=y
 CONFIG_DMA_NONCOHERENT=y
 CONFIG_EARLY_PRINTK=y
 CONFIG_ETHERNET_PACKET_MANGLE=y
@@ -185,6 +188,8 @@ CONFIG_IRQ_WORK=y
 # CONFIG_LEDS_TRIGGER_NETDEV is not set
 # CONFIG_LEDS_TRIGGER_TIMER is not set
 # CONFIG_LEDS_WNDR3700_USB is not set
+CONFIG_LZO_COMPRESS=y
+CONFIG_LZO_DECOMPRESS=y
 # CONFIG_M25PXX_USE_FAST_READ is not set
 CONFIG_MARVELL_PHY=y
 CONFIG_MDIO_BOARDINFO=y
@@ -204,10 +209,18 @@ CONFIG_MTD_M25P80=y
 # CONFIG_MTD_MAP_BANK_WIDTH_1 is not set
 # CONFIG_MTD_MAP_BANK_WIDTH_4 is not set
 CONFIG_MTD_MYLOADER_PARTS=y
+CONFIG_MTD_NAND=y
+CONFIG_MTD_NAND_ECC=y
 CONFIG_MTD_PHYSMAP=y
 CONFIG_MTD_REDBOOT_DIRECTORY_BLOCK=-2
 CONFIG_MTD_REDBOOT_PARTS=y
+# CONFIG_MTD_SM_COMMON is not set
 CONFIG_MTD_TPLINK_PARTS=y
+CONFIG_MTD_UBI=y
+CONFIG_MTD_UBI_BEB_LIMIT=20
+# CONFIG_MTD_UBI_FASTMAP is not set
+# CONFIG_MTD_UBI_GLUEBI is not set
+CONFIG_MTD_UBI_WL_THRESHOLD=4096
 CONFIG_MTD_UIMAGE_SPLIT=y
 CONFIG_MTD_WRT160NL_PARTS=y
 CONFIG_MYLOADER=y
@@ -260,7 +273,14 @@ CONFIG_SYS_SUPPORTS_32BIT_KERNEL=y
 CONFIG_SYS_SUPPORTS_ARBIT_HZ=y
 CONFIG_SYS_SUPPORTS_BIG_ENDIAN=y
 CONFIG_TICK_CPU_ACCOUNTING=y
+CONFIG_UBIFS_FS=y
+CONFIG_UBIFS_FS_ADVANCED_COMPR=y
+CONFIG_UBIFS_FS_LZO=y
+CONFIG_UBIFS_FS_XZ=y
+CONFIG_UBIFS_FS_ZLIB=y
 CONFIG_UIDGID_CONVERTED=y
 CONFIG_USB_ARCH_HAS_XHCI=y
 CONFIG_USB_SUPPORT=y
+CONFIG_ZLIB_DEFLATE=y
+CONFIG_ZLIB_INFLATE=y
 CONFIG_ZONE_DMA_FLAG=0
diff --git target/linux/ar71xx/image/Makefile target/linux/ar71xx/image/Makefile
index b755a9d..02b7146 100644
--- target/linux/ar71xx/image/Makefile
+++ target/linux/ar71xx/image/Makefile
@@ -9,6 +9,9 @@ include $(INCLUDE_DIR)/image.mk

 JFFS2_BLOCKSIZE = 64k 128k 256k

+UBIFS_OPTS = -m 2048 -e 126KiB -c 4096
+UBINIZE_OPTS = -m 2048 -p 128KiB
+
 define imgname
 $(BIN_DIR)/$(IMG_PREFIX)-$(2)-$(patsubst jffs2-%,jffs2,$(patsubst squashfs-%,squashfs,$(1)))
 endef
diff --git target/linux/ar71xx/image/ubinize.cfg target/linux/ar71xx/image/ubinize.cfg
new file mode 100644
index 0000000..49d55b9
--- /dev/null
+++ target/linux/ar71xx/image/ubinize.cfg
@@ -0,0 +1,14 @@
+[rootfs]
+# Volume mode (other option is static)
+mode=ubi
+# Source image
+image=root.ubifs
+# Volume ID in UBI image
+vol_id=0
+# Allow for dynamic resize
+vol_type=dynamic
+# Volume name
+vol_name=rootfs
+# Autoresize volume at first mount
+vol_flags=autoresize
+</code></pre></div>											<p class="post-edited">(Last edited by <strong>Zsub</strong> on 25 Aug 2013, 18:51)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211335">
				<div class="post-metadata">
					<div class="post-num">Post #33</div>
					<div class="post-author">jhuymaier</div>
					<div class="post-datetime">
						1 Sep 2013, 02:34					</div>
				</div>
				<div class="post-content content">
					<p>Any update on this patch??? this router deserves alot more attention it has great capacity and ram plus decent performance im running dd-wrt and am willing to test i just dont like to use linux to compile so if someone wants to compile a image ill gladly test</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211694">
				<div class="post-metadata">
					<div class="post-num">Post #34</div>
					<div class="post-author">Zsub</div>
					<div class="post-datetime">
						6 Sep 2013, 00:02					</div>
				</div>
				<div class="post-content content">
					<p>Nope, apparently there is no one more experienced who also owns this model and has time to comment on it <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p><p>Although I have identified some possible biiig issues with that patch, mainly that it may break the normal overlay functionality quite horribly, but I&#039;m not sure wether OpenWRT can cope with that.</p><p>I am not willing to provide binary builds, as those images may brick the router and I don&#039;t even feel comfortable installing them on my own device, because I am not quite sure I&#039;d be able to recover from that brick. So for now pretty much no work is being done. Although I am going to buy a serial cable and fix the board headers so I can easily use it, but as for time, best if you now think: &quot;that&#039;s going to be _at least_ another year&quot; <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink"/></p><p>However, anyone you may know who can judge this patch, please do send them here!</p>											<p class="post-edited">(Last edited by <strong>Zsub</strong> on 6 Sep 2013, 00:35)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211869">
				<div class="post-metadata">
					<div class="post-num">Post #35</div>
					<div class="post-author">falstaff</div>
					<div class="post-datetime">
						8 Sep 2013, 01:15					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>I&#039;m new to OpenWRT development (not user, I run OpenWRT already for years, but so far I had a supported device :-)). However, I have experience with embedded linux development, including U-boot etc..</p><p>@dlang<br/>I tried this too, when loading the initramfs using TFTP recover mode, the console says &quot;File has bad checksum!&quot; I suspect that this recovery mode is not ment to load this initramfs file.</p><br/><p>The kernel built with latest git snapshot doesn&#039;t support the NAND at all, so you don&#039;t see any partition in Linux (/proc/mtd).</p><p>(@Zsub)<br/>I then patched my tree with Zsub&#039;s patch and built a image. The initramfs still doesn&#039;t see the MTD partitions. Dmesg also doesn&#039;t show any MTD partition parsing output. </p><p>Netgears kernel shows this output:<br/></p><div class="codebox"><pre><code>Atheros on-chip NAND FLash Controller Driver, Version 0.1 (c) 2010 Atheros Communications, Ltd.
Ath Nand ID[878555a0]: 2c:f1:80:95:02
ONFI MICRON      MT29F1G08ABADAWP   
Micron NAND 128MiB 3,3V 8-bit [128MB]
12 cmdlinepart partitions found on MTD device ath-nand</code></pre></div><p>This output is completly missing so I suspect that the SoC NAND Driver is missing...</p><br/><p>Booting the initramfs is relativly easy, however you need to open your device... First build the image and copy it to your TFTP server (running at 192.168.1.2 and serving /srv/tftp/ in my case):<br/></p><div class="codebox"><pre><code>$ #build openwrt as documented
$ cd bin/ar71xx/
$ cp openwrt-ar71xx-generic-wndr4300-initramfs-uImage.bin /srv/tftp/wndr4300.img</code></pre></div><p>Then I hooked up my device to the serial console to gain access to U-Boot. Press space to abort the automatic boot process and type these commands:<br/></p><div class="codebox"><pre><code>ar7240&gt; setenv serverip 192.168.1.2
ar7240&gt; setenv bootfile wndr4300.img
ar7240&gt; tftpboot
....
ar7240&gt; bootm</code></pre></div><p>The kernel then successfully boots and drops me to a root shell.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211871">
				<div class="post-metadata">
					<div class="post-num">Post #36</div>
					<div class="post-author">falstaff</div>
					<div class="post-datetime">
						8 Sep 2013, 02:00					</div>
				</div>
				<div class="post-content content">
					<p>Ok, needed to add one more kernel driver:<br/>CONFIG_MTD_NAND_AR934X</p><p>The partitions are recognized:<br/></p><div class="codebox"><pre><code>[    2.730000] NAND device: Manufacturer ID: 0x2c, Chip ID: 0xf1 (Micron NAND 128MiB 3,3V 8-bit), 128MiB, page size: 2048, OOB size: 64
[    2.740000] Scanning device for bad blocks
[    2.850000] 12 cmdlinepart partitions found on MTD device ar934x-nfc
[    2.860000] Creating 12 MTD partitions on &quot;ar934x-nfc&quot;:
[    2.860000] 0x000000000000-0x000000040000 : &quot;u-boot&quot;
[    2.870000] 0x000000040000-0x000000080000 : &quot;u-boot-env&quot;
[    2.880000] 0x000000080000-0x0000000c0000 : &quot;caldata&quot;
[    2.880000] 0x0000000c0000-0x000000140000 : &quot;pot&quot;
[    2.890000] 0x000000140000-0x000000340000 : &quot;language&quot;
[    2.900000] 0x000000340000-0x0000003c0000 : &quot;config&quot;
[    2.900000] 0x0000003c0000-0x0000006c0000 : &quot;traffic_meter&quot;
[    2.910000] 0x0000006c0000-0x0000007e0000 : &quot;kernel&quot;
[    2.920000] 0x0000007e0000-0x000001fc0000 : &quot;rootfs&quot;
[    2.920000] mtd: partition &quot;rootfs&quot; set to be root filesystem
[    2.930000] __nand_correct_data: uncorrectable ECC error
[    2.930000] split_squashfs: error occured while reading from &quot;ar934x-nfc&quot;
[    2.940000] 0x0000006c0000-0x000001fc0000 : &quot;firmware&quot;
[    2.950000] 0x000001fc0000-0x000002000000 : &quot;caldata_backup&quot;
[    2.950000] 0x000002000000-0x000008000000 : &quot;reserved&quot;</code></pre></div><p>And I get a lot of these errors:<br/>[&nbsp; &nbsp;23.420000] __nand_correct_data: uncorrectable ECC error__nand_correct_data: uncorrectable ECC error</p><p>I tried to do a read test, on the original firmware I get this output<br/></p><div class="codebox"><pre><code>md5sum /dev/mtdblock7
caaebae0814cee76def07b0d2b4d5a67  /dev/mtdblock7</code></pre></div><p>On the new kernel, I get this:<br/></p><div class="codebox"><pre><code>[   49.960000] __nand_correct_data: uncorrectable ECC error
[   49.960000] __nand_correct_data: uncorrectable ECC error[   49.970000] end_request: I/O error, dev mtdblock7, sector 0
[   49.970000] Buffer I/O error on device mtdblock7, logical block 0</code></pre></div><p>The driver looks broken (for this device)...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p211913">
				<div class="post-metadata">
					<div class="post-num">Post #37</div>
					<div class="post-author">falstaff</div>
					<div class="post-datetime">
						9 Sep 2013, 00:50					</div>
				</div>
				<div class="post-content content">
					<p>Good news: I think the driver works correctly, but the original driver didn&#039;t used the ECC feature.. When I erease a partition and do a md5sum, it works. When I do a md5sum of the same partition in the original firmware, I even get the same md5sum!</p><p>Next step is flashing and running the image. But as far as I can tell the on board U-Boot checks some magics on the kernel (0x33373033 same as CONFIG_WNDR3700V3?) as well as on the rootfs. The image header for the rootfs, is just before the actual partition, see here:</p><div class="codebox"><pre><code>011ffc0 3337 3033 a041 3b05 50b3 4ec9 008b 0004
011ffd0 8000 2000 8028 2bc0 b75d 5d85 0505 0203
011ffe0 4d49 5053 204f 7065 6e57 7274 204c 696e
011fff0 7578 2d32 2e36 2e33 3100 0000 0000 0000
0120000</code></pre></div><p>Ugly! The actual check is done by loadn_dniimg/chk_dniimg which seem to be Netgear specific commands.</p><br/><p>But one can easily load/run the image without verification:<br/></p><div class="codebox"><pre><code>nand read 0x81000000 0x6c0000 0x120000
bootm</code></pre></div><p>But saving custom environment variables is not possible in given u-boot :-( </p><p>Since I&#039;m new to OpenWRT development, anybody knows if OpenWRT does such magic hacks in image generation? If yes, where is this code located? Any idea how to work around this issue?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212118">
				<div class="post-metadata">
					<div class="post-num">Post #38</div>
					<div class="post-author">Zsub</div>
					<div class="post-datetime">
						11 Sep 2013, 21:02					</div>
				</div>
				<div class="post-content content">
					<p>I think those image headers are in the ar71xx/image/Makefile somewhere. For example, around &quot;define Image/Build/CyberTAN&quot;, line 627, this code can be found: </p><div class="codebox"><pre><code>        -$(STAGING_DIR_HOST)/bin/addpattern -B $(2) -v v$(4) \
                -i $(KDIR)/image.tmp \
                -o $(call sysupname,$(1),$(2))</code></pre></div><p>Also, the ubinize.cfg I posted as part of that horrible patch probably will not work when you flash it, as it only contains one partition and no overlay whatsoever. Viewing your MTD layout from the wiki (THANKS!!!) it seems like a good idea to use UBI on mtd8, initially. There are some issues with JFFS2 over UBI, an additional UBI-glue component needs to be installed. However, the image should boot even if no JFFS is present, I&#039;d venture.</p><p>But you&#039;re the one actually managing to fix the mess I posted, so my hat&#039;s off to you <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink"/></p>											<p class="post-edited">(Last edited by <strong>Zsub</strong> on 11 Sep 2013, 21:20)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212127">
				<div class="post-metadata">
					<div class="post-num">Post #39</div>
					<div class="post-author">jolouis</div>
					<div class="post-datetime">
						11 Sep 2013, 22:56					</div>
				</div>
				<div class="post-content content">
					<p>Further to Zsub&#039;s comment, if you compare the Netgear GPL sources you&#039;ll find in their target they call some specific binary to generate the image, which I would guess adds the headers and funky things needed for the bootloader to accept it.</p><p>For the GPL source:<br/>target/linux/wndr4300/image/Makefile:</p><div class="codebox"><pre><code>define Image/Build/WNDR4300
..(does a bunch of stuff here)..
$(STAGING_DIR_HOST)/bin/mkdniimg \
                -B $(MODULE_NAME) -v $(FW_VERSION) -r $(FW_REGION) -H $(HW_ID) \
                -i $(call imgname,$(1),$(2))-sysupgrade.bin \
                -o $(BIN_DIR)/$(MODULE_NAME)-$(FW_VERSION)$(FW_REGION).img</code></pre></div><p>The mkdniimg command is what stands out, as that seems to be some strange binary that Netgear ships with the GPL code which I suspect adds the unusual headers to the image.</p><p>Notice that this mkdniimg is already used for other Netgear targets like the original WNDR3700... I suspect if you compare the build process for that specific device to what you&#039;re trying to implement you may be able to get things working.</p><p>Keep at it, looks like you&#039;re getting very close!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212132">
				<div class="post-metadata">
					<div class="post-num">Post #40</div>
					<div class="post-author">falstaff</div>
					<div class="post-datetime">
						12 Sep 2013, 00:37					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for the answers! I found that this funky header patching is already implemented since the initramfs needs it too. Its basically the same as before, just the numbers are slightly different...</p><p>The whole thing grew a bit since my last post. I could manage to flash a UBI/UBIFS root image and boot a kernel. However, still a long way to get a easily flashable image, since I did this manually and had to do several work arounds.</p><p>Read the technical detail in my E-Mail to the openwrt-devel mailing list:<br/><a href="https://lists.openwrt.org/pipermail/openwrt-devel/2013-September/021351.html">https://lists.openwrt.org/pipermail/ope … 21351.html</a></p><p>This is how I did the actual flashing right now:<br/></p><ol class="decimal"><li><p>Patch the Sources with Zsub patch and add the additional kernel configuration CONFIG_MTD_NAND_AR934X</p></li><li><p>Generate the UBI image with enabled UBI tools (part of busybox)</p></li><li><p>Generate a Kernel with fixed cmdline (console=ttyS0,115200 board=WNDR4300 ubi.mtd=8 rootdelay=5 root=ubi0:rootfs rootfstype=ubifs mtdparts=...) and patched magic (taken from the intermediate files)</p></li><li><p>Opened the device, hookup serial console, enter U-Boot</p></li><li><p>Run the initramfs image (loaded through TFTP)</p></li><li><p>Erased partition mtd8</p></li><li><p>Create UBI volume</p></li><li><p>Flashed the UBIFS root filesystem to mtd8</p></li><li><p>Enter U-Boot again</p></li><li><p>Load the kernel over TFTP</p></li><li><p>Flash the kernel in U-Boot on mtd7</p></li></ol><p>I now can start the kernel and have a running OpenWRT distribution. However, theres no overlay, and the root filesystem is read/writeable. </p><p>The default boot instructions check the root partitions CRC. But since I have a writeable filesystem there, this CRC would always change..</p><p>Therefor I have to currently manually boot the kernel. I&#039;m not sure if its possible to overwrite the U-Boot environment, at least there are no such commands inside U-Boot.</p><p>I need advice from advanced developers how to proceed, since there are many ways to go now and I would prefer the way which will be accepted upstream :-)</p><p>One thing which I don&#039;t fully understand right now: How/when is the overlay done? Does the kernel boot first with the Rom rootfs and some init scripts does the overlay? Where are the relevant commands?</p>											<p class="post-edited">(Last edited by <strong>falstaff</strong> on 12 Sep 2013, 00:37)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212133">
				<div class="post-metadata">
					<div class="post-num">Post #41</div>
					<div class="post-author">falstaff</div>
					<div class="post-datetime">
						12 Sep 2013, 00:40					</div>
				</div>
				<div class="post-content content">
					<p>@Zsub<br/>Regarding MTD layout, you are welcome <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/> I really needed such a thing since I was about to mess with the Flash. One wrong number and you are screwed <img src="https://forum.openwrt.org/img/smilies/yikes.png" width="15" height="15" alt="yikes"/></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212182">
				<div class="post-metadata">
					<div class="post-num">Post #42</div>
					<div class="post-author">jolouis</div>
					<div class="post-datetime">
						12 Sep 2013, 16:44					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><blockquote><p>One thing which I don&#039;t fully understand right now: How/when is the overlay done? Does the kernel boot first with the Rom rootfs and some init scripts does the overlay? Where are the relevant commands?</p></blockquote></div><p>Overlay and rootfs mounting is handled by the preinit scripts located in /lib/preinit on the SquashFS partition usually. Take a look at the wiki entry for details:<br/><a href="http://wiki.openwrt.org/doc/techref/process.boot">http://wiki.openwrt.org/doc/techref/process.boot</a></p><p>I&#039;m not sure of all the details on how that first SquashFS/rom usually gets mounted (I assume the bootloader does this somewhere somehow), but the preinit scripts are responsible for actually setting up the overlay and doing the pivot_root to it before the rest of the normal init continues.</p><p>I&#039;m not sure where you&#039;re planning to go next, but it might be possible to add the WNDR4300 to the AR71XX makefile as a new machine/subtarget, similar to what exists for the WNDR3700 et al. You can add kernel command lines, MTD configurations,etc all there... It&#039;s a bit old now but try taking a look at the patch which added support for the old WNDR3700:<br/><a href="https://dev.openwrt.org/ticket/8727">https://dev.openwrt.org/ticket/8727</a></p><br/><p>On an side note, I would just like to ask if anyone can tell me why exactly all this UBI stuff is needed for NAND. My understanding was that the issue with NAND was that SquashFS would fail if the NAND controller reallocated blocks in response to bad ones.... Yet the Netgear GPL firmware still uses the normal SquashFS and JFFS2 (they don&#039;t use it an an overlay in the same way, but that&#039;s more their configuration choice than anything I believe). So is Netgear shipping a product that could brick the first time a block in NAND goes bad, or ??</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212214">
				<div class="post-metadata">
					<div class="post-num">Post #43</div>
					<div class="post-author">falstaff</div>
					<div class="post-datetime">
						12 Sep 2013, 22:57					</div>
				</div>
				<div class="post-content content">
					<p>Regarding NAND: JFFS2 has NAND support, so this is not the problem. Then, I don&#039;t think that the controller by itself does any relocating. As far as I understand, the bootloader does a simplistic approach of bad block handling: If write fails, it just takes the next block. If read fails, it just takes the next block too. Since new bad blocks usually come up upon writing, the bootloader can usually read a Squashfs image without errors. The question is, what happens if a block fails while reading? (according to <a href="http://wiki.openwrt.org/doc/techref/flash">http://wiki.openwrt.org/doc/techref/flash</a> this <em>can</em> happen...) </p><p>The bootloader does a CRC check after loading the rootfs to RAM. So if this happens, this would end up in a CRC error and the router would switch to recovery mode. I guess this happens rare enough that Netgear can live with it.. So currently, to me it looks like Netgear uses this basic bad block handling along with the fact that squashfs is read only...</p><p>As I write this, it looks to me that doing exactly the same would the simplest way to bring OpenWRT to this router too. Although I would prefer a UBI solution. but since its quite hard to bring UBI on the router, it might be a start for now...</p><p>The UBI/UBIFS only solution (with a rw part overlaying a ro part, but both on the same UBI volume) would better in terms of bad block handling (it handles bad blocks even on read, it would relocate that block somewhere else). But UBIFS would need boot process changes (no CRC check on rootfs), either by replacing U-Boot with an altered one or writing a non standard environment.</p><p>For me it looks like there are two ways to go:<br/></p><ol class="decimal"><li><p>Stay close on Netgear&#039;s implementation and use squashfs/jffs2.</p></li><li><p>Go the idealistic way and use UBI/UBIFS. Since this would need a lot of changes anyway, we could even alter the MTD partition table, e.g. using the whole NAND (which would give as incredible amount of flash!!)</p></li></ol>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212326">
				<div class="post-metadata">
					<div class="post-num">Post #44</div>
					<div class="post-author">Zsub</div>
					<div class="post-datetime">
						14 Sep 2013, 14:07					</div>
				</div>
				<div class="post-content content">
					<p>I just saw a <a href="https://lists.openwrt.org/pipermail/openwrt-devel/2013-September/021406.html">post</a> to the devel-list in which someone identifies a preferred way forward and explains some things quite nicely.</p><p>I even managed to <a href="https://lists.openwrt.org/pipermail/openwrt-devel/2013-September/021414.html">reply</a> <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile"/></p><p>I also updated the <a href="http://wiki.openwrt.org/toh/netgear/wndr4300#opening.the.case">wiki-page</a> with some photos.</p><p>Maybe we should have a nice place where we can post the output from git-diff or somesuch, so we can always have the latest version of a patch without having to keep posting them here. Maybe a github gist?</p><p>I tried to buy stuff to attach a serial cable to my router, but the electronics shop that I previously held in high regard have slightly disappointed me. So you guys&#039;ll have to wait until tuesday before I can really contribute <img src="https://forum.openwrt.org/img/smilies/tongue.png" width="15" height="15" alt="tongue"/></p>											<p class="post-edited">(Last edited by <strong>Zsub</strong> on 15 Sep 2013, 10:47)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212493">
				<div class="post-metadata">
					<div class="post-num">Post #45</div>
					<div class="post-author">Zsub</div>
					<div class="post-datetime">
						16 Sep 2013, 11:28					</div>
				</div>
				<div class="post-content content">
					<p>I have forked the OpenWrt trunk repo on Github, available read-only here: <a href="https://github.com/Zsub/openwrt">https://github.com/Zsub/openwrt</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212543">
				<div class="post-metadata">
					<div class="post-num">Post #46</div>
					<div class="post-author">falstaff</div>
					<div class="post-datetime">
						16 Sep 2013, 23:19					</div>
				</div>
				<div class="post-content content">
					<p>Ok, now I think I bricked my device... At least the device doesn&#039;t make it to the U-Boot prompt anymore:</p><div class="codebox"><pre><code>WASP BootROM Ver. 1.1
Nand Flash init
ONFI: Control setting = 0xb44
hdr: [0xffffffff : 0xffffffff : 0xffffffff : 0xffffffff]
nand_load_fw: read 2097151 pages
ExcCode 03 -&gt; TLB(store)
EPC bfc01328, BadVAddr ffffffff, Cause 0000000c, Status 10400006

R0 (r0) = 00000000  R8 (t0) = ffffffff  R16(s0) = 00000023  R24(t8) = 2e070009
R1 (at) = 00000001  R9 (t1) = 000000c0  R17(s1) = 00000800  R25(t9) = bfc010f4
R2 (v0) = 000000ff  R10(t2) = 000000ff  R18(s2) = 00030000  R26(k0) = ffffffff
R3 (v1) = 00000001  R11(t3) = 000f1b40  R19(s3) = 00010000  R27(k1) = bd007bf0
R4 (a0) = ffffffff  R12(t4) = 000003e6  R20(s4) = 00000800  R28(gp) = 2e670009
R5 (a1) = bd004010  R13(t5) = 00000500  R21(s5) = ffffffff  R29(sp) = bd007f60
R6 (a2) = 000007ef  R14(t6) = 26470009  R22(s6) = ffffffff  R30(fp) = 00000000
R7 (a3) = ffffffff  R15(t7) = 266b0009  R23(s7) = bd000000  R31(ra) = bfc055f0

[bd007f60]  0000002c  bfc099c0  001fffff  bfc09bb4
[bd007f70]  ffffffff  02000040  ffffffff  ffffffff
[bd007f80]  000007f0  14012201  00000023  bd000000
[bd007f90]  00030000  b8060004  bd000000  00000184
[bd007fa0]  ffffffff  bd000000  00000000  bfc00fd0
[bd007fb0]  28564c02  452a7b95  b7e00442  ce8a4326
[bd007fc0]  e0ee1555  a0f23a6d  a53ea1f4  7a70858a
[bd007fd0]  e8d1318b  efe91a8a  bd007ff0  00000024
[bd007fe0]  bd000000  bd007ff0  b8060004  bfc004fc</code></pre></div><p>What happend? Well, after I turned on the ath79_nfc_set_swap_dma(true); option, I flashed my device using Linux. Things worked, that way. But I had still the issue, if I use U-Boot, I could not boot the system...</p><p>So I switched back to a Kernel without this option, and ended up in 179 bad blocks in the rootfs. Obviously, those were not really bad, but OOB data were corrupted while using the DMA swapped kernel... I could tell that those blocks showed data in the OOB area, while must good once showed just ff:<br/></p><div class="codebox"><pre><code>ar7240&gt; nand dump.oob 0x0000009e0000
Page 009e0000 dump:
OOB:
        85 19 ff ff 00 00 03 20
        ff ff 08 00 ff ff ff ff
        ff ff ff ff ff ff ff ff
        ff ff ff ff ff ff ff ff
        ff ff ff ff ff ff ff ff
        ff ff ff ff ff ff ff ff
        ff ff ff ff ff ff ff ff
        ff ff ff ff ff ff ff ff</code></pre></div><p>So I cleaned them using U-Boot nand erase clean (which clears the OOB data)<br/></p><div class="codebox"><pre><code>ar7240&gt; nand erase clean 0x7e0000 0x17e0000

NAND erase: device 0 offset 0xc, size 0x7e0000 ath_nand_erase: 0xc 63                                                              62Skipped 0 bad blocks

OK</code></pre></div><p>*ouch!* I should have stopped at that very moment, since as you can see, U-boot parsed this command wrong, offset 0xc is not what I typed!!</p><p>However, I started OpenWRT Linux once again using the Initramfs image. I still got those Bad Blocks! I think linux maintains its own table (called BBT, see <a href="http://www.linux-mtd.infradead.org/tech/mtdnand/x144.html">http://www.linux-mtd.infradead.org/tech … /x144.html</a>). I issued &quot;mtd erase rootfs&quot;, but didn&#039;t help since Linux don&#039;t erase bad blocks... I then rebooted and get the output above...</p><br/><p>Btw, as Zsub suggested on the mailing list, I compared the drivers a bit:<br/></p><ul><li><p>The current trunk has software ecc turned on (see target/linux/ar71xx/files/drivers/mtd/nand/ar934x_nfc.c, NAND_ECC_SOFT)</p></li><li><p>The GPL Linux Kernel has hardware ecc on, (ATH_NF_HW_ECC, see git_home/linux-2.6.git/drivers/mtd/nand/ath_nand.c)</p></li><li><p>The GPL U-Boot looks quite the same, hw ecc on (ATH_NF_HW_ECC, see git_home/u-boot.git/board/ar7240/common/ath_nand.c)</p></li></ul><p>I think this difference prevents the kernel from using a U-Boot flashed rootfs. If we don&#039;t wan&#039;t to replace U-Boot on this device (which would be risky anyway) we need to alter our Linux Kernel NAND driver or use Linux (initramfs) to flash the rootfs.</p><br/><p>I will try to recover from the whole situation using a JTAG programmer. Don&#039;t know if I can manage that, and if I&#039;m patient enough doing it... The positive side: If I succeed, I don&#039;t have to fear another brick <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212562">
				<div class="post-metadata">
					<div class="post-num">Post #47</div>
					<div class="post-author">drawz</div>
					<div class="post-datetime">
						17 Sep 2013, 04:03					</div>
				</div>
				<div class="post-content content">
					<p>DD-WRT has WNDR3700v4 support, which is essentially the same as the WNDR4300 but only 2T2R on 5GHz. If you want to sift through their code, there might be something to guide you. That said, I couldn&#039;t even find you a decent starting point since they are so disorganized.</p><p>*edit* there&#039;s a WNDR4300 build of DD-WRT too.</p>											<p class="post-edited">(Last edited by <strong>drawz</strong> on 17 Sep 2013, 06:24)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212635">
				<div class="post-metadata">
					<div class="post-num">Post #48</div>
					<div class="post-author">Zsub</div>
					<div class="post-datetime">
						17 Sep 2013, 20:56					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>falstaff wrote:</cite><blockquote><p>Ok, now I think I bricked my device...<br/>[...]<br/>I will try to recover from the whole situation using a JTAG programmer. Don&#039;t know if I can manage that, and if I&#039;m patient enough doing it... The positive side: If I succeed, I don&#039;t have to fear another brick <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p></blockquote></div><p>Aww darn, that sucks! I&#039;m keeping my fingers crossed for you.</p><p>I&#039;m going to look and see if I can get hardware ECC enabled in OpenWrt, I&#039;ll push to the github repo I posted earlier.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212892">
				<div class="post-metadata">
					<div class="post-num">Post #49</div>
					<div class="post-author">zloop</div>
					<div class="post-datetime">
						21 Sep 2013, 12:24					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>drawz wrote:</cite><blockquote><p>That said, I couldn&#039;t even find you a decent starting point since they are so disorganized.</p><p>*edit* there&#039;s a WNDR4300 build of DD-WRT too.</p></blockquote></div><p>Starting from their support of WNDR3700v4: <br/><a href="http://svn.dd-wrt.com/changeset/20751">http://svn.dd-wrt.com/changeset/20751</a><br/><a href="http://svn.dd-wrt.com/changeset/20752">http://svn.dd-wrt.com/changeset/20752</a><br/>(WNDR3700v4 uses ROUTER_BOARD_WHRHPGN - see utils.c )</p><p>then NAND flash fixups: <a href="http://svn.dd-wrt.com/changeset/20753">http://svn.dd-wrt.com/changeset/20753</a></p><p><a href="https://dev.openwrt.org/changeset/38071">https://dev.openwrt.org/changeset/38071</a><br/>ar71xx: wndr4300: enable HW ECC mode for the NAND controller</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212927">
				<div class="post-metadata">
					<div class="post-num">Post #50</div>
					<div class="post-author">Zsub</div>
					<div class="post-datetime">
						21 Sep 2013, 23:33					</div>
				</div>
				<div class="post-content content">
					<p>While waiting for my parts to arrive so I can *finally* see the serial console, I&#039;m trying some different combo&#039;s of ECC/not and see if perchance U-Boot will eat them via tftp. No luck yet <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 2 of 17</div><nav><ul><li><a href="viewtopic.php%3Fid=41094&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=41094&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=41094&amp;p=4.html">4</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=41094&amp;p=17.html">17</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>