<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Upside-down-ternet for Openwrt</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 29 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p36161">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">beakmyn</div>
					<div class="post-datetime">
						27 Oct 2006, 20:52					</div>
				</div>
				<div class="post-content content">
					<p>Some of you have probably seen upside-down-ternet this guy did<br /><a href="http://www.ex-parrot.com/~pete/upside-down-ternet.html">http://www.ex-parrot.com/~pete/upside-down-ternet.html</a></p><p>As an exercise I&#039;m trying to implement this on the WRT54G. I&#039;m thinking I&#039;ll need to install tinyproxy for the redirection then I believe I can use microperl to peform the redirection script. I&#039;ll admit I haven&#039;t gotten this far yet. I don&#039;t see a dhcpd.conf file on the WRT but I&#039;m guessing I could just set up Static IP addresses based on MAC to create the netblock? I&#039;m learning this as I go so if you&#039;ve got any suggestions they would be appreciated.</p><p>I do have libjpeg and jpegtrans installed for doing the picture flipping. Still trying to get a working gifflip to flip the gif files.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p36175">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">strider22</div>
					<div class="post-datetime">
						28 Oct 2006, 05:29					</div>
				</div>
				<div class="post-content content">
					<p>Rotfl</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p36194">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">cptdondo</div>
					<div class="post-datetime">
						28 Oct 2006, 16:56					</div>
				</div>
				<div class="post-content content">
					<p>Ditto.&nbsp; I think it&#039;s hillarious.</p><p>I can see some cool ideas, too - setting the language to something like turkish, or kiswahili for example - redirecting all google searches to <a href="http://www.google.co.il">http://www.google.co.il</a>/ (or just set up a database of random non-roman aplhabet languages and use those....)</p><p>--Yan</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p36197">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">jake1981</div>
					<div class="post-datetime">
						28 Oct 2006, 18:39					</div>
				</div>
				<div class="post-content content">
					<p>Heh. Great. Have you done any success with it? <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p36203">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">beakmyn</div>
					<div class="post-datetime">
						28 Oct 2006, 21:16					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>jake1981 wrote:</cite><blockquote><p>Heh. Great. Have you done any success with it? <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></blockquote></div><p>Still working on it. I&#039;ve tested the jpeg library and jpegtran so that will flip the images. I think I can install Squid or tinyproxy but I&#039;ve not tested tinyproxy yet (since it&#039;s smaller). All I need is perl and redirection.</p><p>I&#039;m trying to get giffflip working for gifs but got a segmentation fault or gifflip not found error when running it.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p36206">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">jake1981</div>
					<div class="post-datetime">
						28 Oct 2006, 22:36					</div>
				</div>
				<div class="post-content content">
					<p>be sure to write it all here when you got it <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p36286">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">beakmyn</div>
					<div class="post-datetime">
						30 Oct 2006, 16:53					</div>
				</div>
				<div class="post-content content">
					<p>Perhaps it&#039;s just the newbie, I knew getting into this project I&#039;d be over my head, not knowing anything about setting up a Squid proxy, especially on Openwrt (Perhaps I should do this all in desktop linux environment first) but I can&#039;t seem to grasp this statement:</p><p>&quot;That machine runs squid with a trivial redirector that downloads images, uses mogrify to turn them upside down and serves them out of it&#039;s local webserver.&quot;</p><p>Is he just saying, I&#039;ve set up Squid as a transparent proxy and I&#039;ve set up a rule in the squid.conf to redirect all traffic through this &#039;simple perl script&#039; (trivial redirector) I&#039;ve created which uses morgrify to flip the images and then serve them back out using Squid&#039;s built-in webserver (aks transparent proxy). I&#039;m trying to understand if a &quot;trivial redirector&quot; is another program to install or just a line in the .conf file that pushes everything through the perl script.</p><p>Also, is there a stripped down version of the squid.conf? I&#039;ve installed squid_2.5.STABLE13-1_mipsel.ipk I believe it&#039;s got transparent proxy (something I think I need).</p><p>It appears that Tinyproxy only performs rudimentary whitelisting/blacklisting but would be able to run the perl script. Again, being a newbie at this and not knowing the proper terminology makes it difficult to find what I&#039;m looking for.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p37296">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">jake1981</div>
					<div class="post-datetime">
						16 Nov 2006, 10:38					</div>
				</div>
				<div class="post-content content">
					<p>what about setting up those 2 lans with dnsmasq..? or did you just make that static ip allocations are below *.*.*.100 and dynamic after that..?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p37341">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">akfoote</div>
					<div class="post-datetime">
						17 Nov 2006, 06:03					</div>
				</div>
				<div class="post-content content">
					<p>I was thinking of using this guys tactic as well.</p><p>Im thinking of off-loading it to a backend server though to do all the squid / perl stuff.<br />Seems like it will be easier that way.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p37735">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">Lord_Alex</div>
					<div class="post-datetime">
						24 Nov 2006, 13:39					</div>
				</div>
				<div class="post-content content">
					<p>I will be working on this project aswell. I&#039;m doing it for a college assignment, so I have a bit more motivation than most <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>I&#039;ll keep everyone posted.</p><p>---Begin Edit---<br />Keeping in mind that I am running Gentoo, Slackware and Debian (and sometimes Suse), are there any easy HowTo&#039;s for backporting existing packages? As you might immagine, I will be needing ImageMagick.<br />My first tests with Subversion have failed with some sort of SSL crapout (Gentoo, probably my USE flags) and Slackware needs libraries. Next step is Debian.<br />---End Edit---</p><p>Alex.</p>											<p class="post-edited">(Last edited by <strong>Lord_Alex</strong> on 24 Nov 2006, 13:49)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p37834">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">beakmyn</div>
					<div class="post-datetime">
						26 Nov 2006, 15:03					</div>
				</div>
				<div class="post-content content">
					<p>I was going to use Jpegtrans and giftrans on the WRT since they&#039;re smaller and don&#039;t require imagemagick. They can be cross-compiled from their respective libraries. This worked but I got pulled off onto something else so I haven&#039;t gotten to the proxy part.</p>											<p class="post-edited">(Last edited by <strong>beakmyn</strong> on 26 Nov 2006, 15:03)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p38267">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">Lord_Alex</div>
					<div class="post-datetime">
						4 Dec 2006, 00:03					</div>
				</div>
				<div class="post-content content">
					<p>So I have something working for now...</p><p>I needed a second computer though <img src="https://forum.openwrt.org/img/smilies/tongue.png" width="15" height="15" alt="tongue" /><br />I used Debian. make sure you have perl, squid, dhttpd and a coffee.</p><p>in the squid config file (/etc/squid/squid.conf), make sure these directives are set<br /></p><div class="codebox"><pre><code>http_port 80
redirect_program /usr/lib/squid/redirect.pl
redirect_children 2
#http_access allow all
cache_effective_user proxy
cache_effective_group proxy
httpd_accel_host virtual
httpd_accel_port 80
httpd_accel_with_proxy on
httpd_accel_uses_host_header on</code></pre></div><p><span style="color: #FF0000">http_access allow all</span> will permit anybody to use your proxy. Prepare to be hijacked if your proxy faces the interweb!<br />/usr/lib/squid/redirect.pl looks like this:<br /></p><div class="codebox"><pre><code>#!/usr/bin/perl
$|=1;
$count = 0;
$pid = $$;
while (&lt;&gt;) {
        chomp $_;
        if ($_ =~ /(.*\.jpg)/i) {
                $url = $1;
                system(&quot;/usr/bin/wget&quot;, &quot;-q&quot;, &quot;-O&quot;,&quot;/var/www/images/$pid-$count.jpg&quot;, &quot;$url&quot;);
                system(&quot;/usr/bin/mogrify&quot;, &quot;-flip&quot;,&quot;/var/www/images/$pid-$count.jpg&quot;);
                print &quot;http://127.0.0.1:8080/images/$pid-$count.jpg\n&quot;;
        }
        elsif ($_ =~ /(.*\.gif)/i) {
                $url = $1;
                system(&quot;/usr/bin/wget&quot;, &quot;-q&quot;, &quot;-O&quot;,&quot;/var/www/images/$pid-$count.gif&quot;, &quot;$url&quot;);
                system(&quot;/usr/bin/mogrify&quot;, &quot;-flip&quot;,&quot;/var/www/images/$pid-$count.gif&quot;);
                print &quot;http://127.0.0.1:8080/images/$pid-$count.gif\n&quot;;

        }
        else {
                print &quot;$_\n&quot;;;
        }
        $count++;
}</code></pre></div><p>Make sure to add executable permissions to that<br /></p><div class="codebox"><pre><code>alex@navy $ sudo chmod +x /usr/lib/squid/redirect.pl</code></pre></div><p>And your /var/www directory has to have the right permissions. For me, dhttpd (The web server) is running as www-data:www-data and Squid (the proxy) is running as proxy:proxy. For some reason, it&#039;s only working when I chmod the directories 777, so I did this to make everything cool:<br /></p><div class="codebox"><pre><code>alex@navy $ sudo usermod -G proxy www-data
alex@navy $ sudo usermod -G www-data proxy
alex@navy $ sudo chown -R www-data:www-data /var/www
alex@navy $ sudo chmod -R 1777 /var/www</code></pre></div><p>Now you need to make sure the web server is only listening to port 8080 (or whatever you chose in your redirect.pl script). For me, I had to change /etc/default/dhttpd to have <span style="color: blue">OPTIONS=&quot;-p8080&quot;</span>.</p><p>And then (re)start the services to load the new configurations.</p><div class="codebox"><pre><code># /etc/init.d/dhttpd restart
# /etc/init.d/squid restart</code></pre></div><p>So you need to write an IPTABLES rule for your router to forward all packets coming in on the wireless interface with a destination port of 80 to a computer elsewhere on the LAN which has this imagemagick+squid+dhttpd+perl crap running on it. If you get the rules wrong, you might be completely barred from the router. Yes, I am barred from my router at the moment. That means reflashing it.</p><p><span style="color: red">Warning!</span><br />/var/www/images will fill up quickly with the modified images. I set up a cron job to delete everything at ten-minute intervals. (Or 6 times an hour...)<br /></p><div class="codebox"><pre><code>#min    hour   day      mon     wkday   command
*       */6    *        *       *       rm /var/www/images/*</code></pre></div><p>You might think &quot;what if I delete something being downloaded!?&quot;. Linux refuses to suck. Deleting only unlinks the inode, but the process reading it will not notice.</p><br /><p>I&#039;m not going to cross-compile ImageMagick and ALL the dependancies just for the school project. But I might later... when I have spare minutes.</p>											<p class="post-edited">(Last edited by <strong>Lord_Alex</strong> on 4 Dec 2006, 12:25)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p38293">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">Lord_Alex</div>
					<div class="post-datetime">
						4 Dec 2006, 17:38					</div>
				</div>
				<div class="post-content content">
					<p>make sure you install the packages... I just loaded all the iptables packages with <br /></p><div class="codebox"><pre><code>ipkg install kmod-iptables-extra iptables-extra iptables-utils</code></pre></div><p>Now we want to take all packets from the LAN (which is the bridge - br0) that match a destination port of tcp/80 and hurl them at whatever box is running the Squid server. Logically, if your Squid server is ALSO on the lan interface then it&#039;s packets will be rerouted back to itself. So put your Squid on the WAN side of your router, or use a rule to exclude it. (-i br0 <span style="color: red">-s ! suidproxyIP</span> -p tcp)<br />Put this code at the end of /etc/firewall.user<br /></p><div class="codebox"><pre><code>### Transparant Proxy
## -- Connections to internet:80 are routed through proxy:80
iptables -t nat -A prerouting_rule -i br0 -p tcp --dport 80 -j DNAT --to squidproxyIP:80
iptables        -A forwarding_rule -i br0 -p tcp --dport 80 -j ACCEPT</code></pre></div><p>Hopefully this helps somebody out there screw around with their interweb <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Feel free to question me about anything relating to this project.</p><p>-Alex</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p40755">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">0ryan0</div>
					<div class="post-datetime">
						14 Jan 2007, 05:54					</div>
				</div>
				<div class="post-content content">
					<p>I am setting this up at home, and am having some squid problems. I have it such that the wireless is available, but once I try to run it through squid, I get some problems. </p><p>I have an Ubuntu box with two NICs, eth0 (192.168.2.107) goes to the internet, and eth1 (192.168.5.1) goes to the wireless router. I want to flip all the images on the eth1 traffic.</p><p>I do this to set up my iptables:</p><p>---------------------------------------------------------------<br />#clear all<br />iptables --flush<br />iptables --table nat --flush<br />iptables --delete-chain<br />iptables --table nat --delete-chain</p><p>#set up NAT<br />iptables --table nat --append POSTROUTING --out-interface eth0 -j MASQUERADE<br />iptables --append FORWARD --in-interface eth1 -j ACCEPT</p><p>#sent to Squid proxy<br />iptables --table nat --append PREROUTING --in-interface eth1 -p tcp --dport 80 -j DNAT --to 192.168.2.107:80<br />---------------------------------------------------------------</p><p>Everything works fine up until that last line (Namely, I can connect via wireless and browse the web, unflipped). Once I enter that line, I start seeing squid errors on the wireless clients:</p><br /><p>------------------------------------------------------<br />ERROR<br />The requested URL could not be retrieved</p><p>While trying to process the request:</p><p>GET / HTTP/1.1<br />Host: 192.168.2.107<br />User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.9) Gecko/20061206 Firefox/1.5.0.9<br />Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5<br />Accept-Language: en-us,en;q=0.5<br />Accept-Encoding: gzip,deflate<br />Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7<br />Keep-Alive: 300<br />Connection: keep-alive<br />Cookie: testing=1; sid=9228a96093acf06258d85d007c1c4495</p><br /><br /><p>The following error was encountered:</p><p>&nbsp; &nbsp; * Invalid Request </p><p>Some aspect of the HTTP Request is invalid. Possible problems:</p><p>&nbsp; &nbsp; * Missing or unknown request method<br />&nbsp; &nbsp; * Missing URL<br />&nbsp; &nbsp; * Missing HTTP Identifier (HTTP/1.0)<br />&nbsp; &nbsp; * Request is too large<br />&nbsp; &nbsp; * Content-Length missing for POST or PUT requests<br />&nbsp; &nbsp; * Illegal character in hostname; underscores are not allowed </p><p>Your cache administrator is webmaster.<br />Generated Sun, 14 Jan 2007 03:47:33 GMT by ubuntu (squid/2.6.STABLE1) <br />-----------------------------------------------------------</p><br /><p>I put some debug statements in the redirect.pl, and as far as I can tell, it runs, but never gets into the while loop.</p><p>My squid access.log looks like this:</p><p>1168736881.462&nbsp; &nbsp; &nbsp; 1 192.168.5.2 TCP_DENIED/400 1672 GET error:invalid-request - NONE/- text/html</p><p>Any ideas?</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>