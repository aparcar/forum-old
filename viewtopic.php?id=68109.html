<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> (SOLVED... kind of... ) 4G/LTE UQMI - Need Help</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 5 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p341322">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">jeffs</div>
					<div class="post-datetime">
						17 Oct 2016, 03:26					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>I&#039;m finally asking for help after unsuccessfully trying to troubleshoot this issue myself for several month, after reading many posts, and after trying multiple configurations on multiple devices.</p><p>I have a Verizon Novatel USB551L USB modem. I have followed the instructions at (among other recommended configurations): wiki.openwrt.org/doc/recipes/ltedongle to configure the device. This somewhat worked, but the modem continually loses connectivity and does not reconnect. I can usually get it to reconnect by doing an ifdown/ifup on the interface (2x&#039;s usually is needed). However, this isn&#039;t a solution because it drops sometimes every 30-seconds or so - sometimes once in 30-minutes. Eventually I get the following error message from dmesg:</p><p>[13447.010000] ------------[ cut here ]------------<br />[13447.010000] WARNING: CPU: 0 PID: 0 at net/sched/sch_generic.c:303 0x801eb048()<br />[13447.030000] NETDEV WATCHDOG: wwan0 (qmi_wwan): transmit queue 0 timed out<br />[13447.040000] Modules linked in: rt2800soc rt2800mmio rt2800lib pppoe ppp_async iptable_nat rt2x00soc rt2x00mmio rt2x00lib qmi_wwan pppox ppp_generic nf_nat_ipv4 nf_conntrack_ipv6 nf_conntrack_ipv4 mac80211 ipt_REJECT ipt_MASQUERADE cfg80211 xt_time xt_tcpudp xt_state xt_nat xt_multiport xt_mark xt_mac xt_limit xt_id xt_conntrack xt_comment xt_TCPMSS xt_REDIRECT xt_LOG xt_CT usbnet slhc nf_reject_ipv4 nf_nat_masquerade_ipv4 nf_nat_ftp nf_nat nf_log_ipv4 nf_defrag_ipv6 nf_defrag_ipv4 nf_conntrack_rtcache nf_conntrack_ftp nf_conntrack iptable_raw iptable_mangle iptable_filter ip_tables crc_itu_t crc_ccitt compat cdc_wdm ledtrig_usbdev ip6t_REJECT nf_reject_ipv6 nf_log_ipv6 nf_log_common ip6table_raw ip6table_mangle ip6table_filter ip6_tables x_tables ipv6 eeprom_93cx6 mii arc4 crypto_blkcipher leds_gpio ohci_platform ohci_hcd ehci_platform ehci_hcd gpio_button_hotplug usbcore nls_base usb_common<br />[13447.200000] CPU: 0 PID: 0 Comm: swapper Not tainted 3.18.20 #1<br />[13447.210000] Stack : 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000<br />[13447.210000]&nbsp; &nbsp; 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000<br />[13447.210000]&nbsp; &nbsp; 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000<br />[13447.210000]&nbsp; &nbsp; 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000<br />[13447.210000]&nbsp; &nbsp; 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000<br />[13447.210000]&nbsp; &nbsp; ...<br />[13447.280000] Call Trace:[&lt;800138d8&gt;] 0x800138d8<br />[13447.290000] [&lt;800138d8&gt;] 0x800138d8<br />[13447.300000] [&lt;801eb048&gt;] 0x801eb048<br />[13447.310000] [&lt;80023b2c&gt;] 0x80023b2c<br />[13447.310000] [&lt;801eb048&gt;] 0x801eb048<br />[13447.320000] [&lt;80023b88&gt;] 0x80023b88<br />[13447.330000] [&lt;801cddd8&gt;] 0x801cddd8<br />[13447.330000] [&lt;801eb048&gt;] 0x801eb048<br />[13447.340000] [&lt;801eae70&gt;] 0x801eae70<br />[13447.350000] [&lt;8004e630&gt;] 0x8004e630<br />[13447.360000] [&lt;8004ee48&gt;] 0x8004ee48<br />[13447.360000] [&lt;80048600&gt;] 0x80048600<br />[13447.370000] [&lt;80026030&gt;] 0x80026030<br />[13447.380000] [&lt;8004b154&gt;] 0x8004b154<br />[13447.380000] [&lt;8002639c&gt;] 0x8002639c<br />[13447.390000] [&lt;80004430&gt;] 0x80004430<br />[13447.400000] [&lt;80010b2c&gt;] 0x80010b2c<br />[13447.400000] [&lt;80042b9c&gt;] 0x80042b9c<br />[13447.410000] [&lt;80004680&gt;] 0x80004680<br />[13447.420000] [&lt;80008de0&gt;] 0x80008de0<br />[13447.430000] [&lt;802eaaac&gt;] 0x802eaaac<br />[13447.430000] [&lt;802ea354&gt;] 0x802ea354<br />[13447.440000]<br />[13447.440000] ---[ end trace d7c9fae45040968c ]---</p><p>At this point I need to reboot the router. I have tried this on several routers including an Ubiquity AirRouter, HooToo TM02, TL-MR3020, and TL-WR710N_V1. They all experience the same issues.</p><p>I&#039;ve also tried creating a device &#039;Verizon&#039; and setting its protocol to &#039;wwan&#039; and an apn of &#039;vzwinternet&#039; which also works intermittently but eventually fails in the same way. The device seems to get configured correctly early on as seen below:</p><p>[&nbsp; &nbsp;18.340000] qmi_wwan 1-1:1.6: no of_node; not parsing pinctrl DT<br />[&nbsp; &nbsp;18.350000] qmi_wwan 1-1:1.6: cdc-wdm0: USB WDM device<br />[&nbsp; &nbsp;18.360000] qmi_wwan 1-1:1.6 wwan0: register &#039;qmi_wwan&#039; at usb-101c0000.ehci-1, WWAN/QMI device, 00:a0:c6:00:00:00<br />[&nbsp; &nbsp;18.380000] usbcore: registered new interface driver qmi_wwan</p><p>Any suggestions to help me track down this issue would be much appreciated.</p><p>Thank you,</p><p>Jeff</p>											<p class="post-edited">(Last edited by <strong>jeffs</strong> on 24 Oct 2016, 06:32)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341324">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">jeffs</div>
					<div class="post-datetime">
						17 Oct 2016, 04:30					</div>
				</div>
				<div class="post-content content">
					<p>Sorry, thought it important to add this as well:</p><div class="codebox"><pre><code>T:  Bus=01 Lev=01 Prnt=01 Port=00 Cnt=01 Dev#=  2 Spd=480  MxCh= 0
D:  Ver= 2.00 Cls=ef(misc ) Sub=02 Prot=01 MxPS=64 #Cfgs=  1
P:  Vendor=1410 ProdID=b001 Rev= 0.15
S:  Manufacturer=Novatel Wireless, Inc.
S:  Product=Novatel Wireless 4G
S:  SerialNumber=990000463260801
C:* #Ifs= 6 Cfg#= 1 Atr=e0 MxPwr=500mA
A:  FirstIf#= 6 IfCount= 2 Cls=02(comm.) Sub=00 Prot=00
I:* If#= 0 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)
E:  Ad=81(I) Atr=03(Int.) MxPS=  64 Ivl=2ms
E:  Ad=82(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E:  Ad=01(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
I:* If#= 1 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)
E:  Ad=83(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E:  Ad=02(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
I:* If#= 2 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)
E:  Ad=84(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E:  Ad=03(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
I:* If#= 4 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)
E:  Ad=85(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E:  Ad=04(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms
I:* If#= 6 Alt= 0 #EPs= 1 Cls=02(comm.) Sub=06 Prot=00 Driver=qmi_wwan
E:  Ad=86(I) Atr=03(Int.) MxPS=  64 Ivl=2ms
I:  If#= 7 Alt= 0 #EPs= 0 Cls=0a(data ) Sub=00 Prot=00 Driver=qmi_wwan
I:* If#= 7 Alt= 1 #EPs= 2 Cls=0a(data ) Sub=00 Prot=00 Driver=qmi_wwan
E:  Ad=87(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E:  Ad=05(O) Atr=02(Bulk) MxPS= 512 Ivl=4ms</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341362">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">bolvan</div>
					<div class="post-datetime">
						17 Oct 2016, 14:13					</div>
				</div>
				<div class="post-content content">
					<p>Another kernel mode crash. Its good to have kernel with symbols so we can see function names and google for that kind of crash. Btw, good idea to test this modem on a linux PC with the same or close kernel verision. If it runs stable there then crash can be caused by bad or unstable power supply from router. Sometimes this kind of power issue can be healed by additional capacitor on power line.</p>											<p class="post-edited">(Last edited by <strong>bolvan</strong> on 17 Oct 2016, 14:19)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341424">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">jeffs</div>
					<div class="post-datetime">
						18 Oct 2016, 01:13					</div>
				</div>
				<div class="post-content content">
					<p>Thank you Bolvan - good points. I had read posts stating power could be an issue. I tried to eliminate this possibility via two methods: an externally powered USB hub and I ran the USB modem on stock firmware provided by the routers manufacturer (TP Link TL-MR3020 only). The externally powered USB hub experienced the same issue. The stock TP Link firmware did not appear to have connectivity issues. Their firmware is GPL and can be downloaded which I did. However, I couldn&#039;t figure out whether they were using chat/PPP or uqmi to provide connectivity for my modem. Obviously their firmware needs to be capable of both types of modem so they had them both loaded into the source code. But I could not tell what was running as they don&#039;t allow us to look under the hood via telnet/ssh (anyone have a trick?).</p><p>I do see two tickets on dev.openwrt.org regarding this issue from two years ago which appear to not be solved:<br />dev.openwrt.org/ticket/17862<br />This individual suggests a solution based on writing to ttyUSB1 every 30-minutes to keep qmi_wwan from &quot;stalling&quot;. I will try this, but mine seems to stall out even if I&#039;m running a continuous ping so I have little hope here.</p><p>dev.openwrt.org/ticket/16733<br />This person suggests that it only happens on the first USB port. I only have 1 exposed USB port on the router(s). <br />The second ones are internal and I would need to wire them up to expose them. Maybe I&#039;ll try that with one of them. This is also where I heard about the idea of connecting the dongle to an externally powered USB hub.</p><p>And here is another post on the freedesktop developer network:<br />lists.freedesktop.org/archives/libqmi-devel/2015-October/001310.html<br />This link is where I see developers talking about the issue and referencing the first post. This was back in October of 2015 and I see no update since this year old post. And yet it&#039;s still an issue. In this post the developers talk about USB autosuspend and turning it off in the qmi_wwan.c file (would I have to download the file, change the setting, compile it, then replace the executable on the router?). Also, one developer asks if you can still talk to the modem with qmi after it crashes. The answer is no in my case. I can&#039;t remember the exact message but something along the lines of &quot;The service could not be reached&quot;.</p><p>Is it odd that the modem loses connectivity and yet ifconfig reports a valid IP address for the wwan? Pinging the wwan IP returns hits while pinging anything beyond that IP returns nothing. Can the USB port go to sleep? Even when I have a constant ping running? With four routers and two different modems having this issue it seems hard to believe others aren&#039;t talking more about this.</p><p>Again, thank you very much for your thoughts and recommendations. It sure would be nice to put this to bed.</p><p>BTW, why does it tell me &quot;Too more links in message. Allowed 0 links. Reduce number of links and post it again.&quot; when I try to add links to this message?</p><p>Jeff</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341946">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">jeffs</div>
					<div class="post-datetime">
						24 Oct 2016, 06:46					</div>
				</div>
				<div class="post-content content">
					<p>So... after many dropped connections which lead to refused connections which lead to the inability to communicate with the device via uqmi, I finally found a work around. The main problems were A) continual drops and the device not reconnecting even though autoconnect was turned on, and B) eventually the qmi service on the device would lock up or refuse connections. After using minicom to connect to the device and run AT commands to test things, I came across a page that discussed a connection process that was very similar to the 3g howto for OpenWRT. So combining them I came up with a solution that works. Odd how it&#039;s an LTE/qmi dongle but the 3g setup is what works. </p><p>I&#039;m tempted to edit the 3g Dongle recipe (down where it talks about LTE/QMI) to discuss how I got mine to work and add a note on the 4G/LTE page that a possible second solution exists if that recipe doesn&#039;t work. However, I&#039;m diving deeper under the hood than ever before and don&#039;t want to ruffle feathers if I got it wrong. Looking for input here - should I add my solution there? Yes or no - do I even have rights to edit it? Suggestions?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341947">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						24 Oct 2016, 07:22					</div>
				</div>
				<div class="post-content content">
					<p>I would recommend documenting steps you&#039;ve taken so far here on the forum and seeking comments on them, it might help you make edits to the wiki when you&#039;re done.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>