<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> mwan3; multi-wan policy routing (general topic)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 22 May 2013 and 6 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 51 of 65</div><nav><ul><li><a href="viewtopic.php%3Fid=39052&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=49.html">49</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=50.html">50</a></li><li class="pagination-current"><span>51</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=52.html">52</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=53.html">53</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p272760">
				<div class="post-metadata">
					<div class="post-num">Post #1251</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						16 Apr 2015, 19:25					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>pier4r wrote:</cite><blockquote><p>Nice, thanks. Maybe we could write it on the wiki page? I didn&#039;t know it (i thought was the latest)</p><p>Suggestion: i don&#039;t know if github provides a bit of space for distribution of binaries, in the case github does not, what about a public dropbox folder o similar?</p></blockquote></div><p>Is there a reason you can&#039;t just install from opkg or through LuCI or download the file from the OpenWrt downloads pages?</p><p><a href="http://downloads.openwrt.org/snapshots/trunk/ar71xx/generic/packages/packages/">http://downloads.openwrt.org/snapshots/ … /packages/</a></p>											<p class="post-edited">(Last edited by <strong>arfett</strong> on 16 Apr 2015, 19:26)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p273282">
				<div class="post-metadata">
					<div class="post-num">Post #1252</div>
					<div class="post-author">pier4r</div>
					<div class="post-datetime">
						21 Apr 2015, 14:00					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>arfett wrote:</cite><blockquote><p>Is there a reason you can&#039;t just install from opkg or through LuCI or download the file from the OpenWrt downloads pages?</p><p><a href="http://downloads.openwrt.org/snapshots/trunk/ar71xx/generic/packages/packages/">http://downloads.openwrt.org/snapshots/ … /packages/</a></p></blockquote></div><p>Hmm, i know that the package is very good but i didn&#039;t analyzed it thoroughly, therefore, using owrt 12.09 i don&#039;t know if i can take it from the trunk repositories.</p><p>I mean, i always used the linked provided (so the 1.4-24 version) and it worked, i&#039;m happy and unfortunately i don&#039;t have too much time to test eventual problems (sorry). But i can understand that is already great that this package is provided for free with open source, so i just asked, i don&#039;t want to criticize <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> .</p><p>At the end for personal purposes i just made a mirror on the local server.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p274082">
				<div class="post-metadata">
					<div class="post-num">Post #1253</div>
					<div class="post-author">alastair</div>
					<div class="post-datetime">
						27 Apr 2015, 04:35					</div>
				</div>
				<div class="post-content content">
					<p>Hi, another prospective mwan3/OpenVPN user here. Like others in this thread, I&#039;m having trouble setting the default route metric on the tun0 interface, and have it detected by mwan3. Here&#039;s my routing table:</p><div class="codebox"><pre><code>root@openwrt:~# ip -4 route
0.0.0.0/1 via 10.165.1.5 dev tun0 
default via 100.8.122.1 dev eth1  proto static  metric 10 
10.165.1.1 via 10.165.1.5 dev tun0  metric 20 
10.165.1.5 dev tun0  proto kernel  scope link  src 10.165.1.6 
100.8.122.0/24 dev eth1  proto static  scope link  metric 10 
108.61.57.220 via 100.8.122.1 dev eth1 
128.0.0.0/1 via 10.165.1.5 dev tun0 
192.168.1.0/24 dev br-lan  proto kernel  scope link  src 192.168.1.1 
192.168.2.0/24 dev eth0.2  proto kernel  scope link  src 192.168.2.1 </code></pre></div><p>As you can see, the desired metric (20) is applied, but not to the default route.</p><p>I&#039;m using a commercial VPN provider, and I suspect they&#039;re using &#039;redirect-gateway def1&#039;.</p><p>Someone previously mentioned <a href="https://community.openvpn.net/openvpn/wiki/IgnoreRedirectGateway">https://community.openvpn.net/openvpn/w … ectGateway</a> - has anyone tried these workarounds, successfully or not?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p274126">
				<div class="post-metadata">
					<div class="post-num">Post #1254</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						27 Apr 2015, 12:29					</div>
				</div>
				<div class="post-content content">
					<p>Hi alastair,</p><p>Looking at the link you posted, i think it will work. Try adding to following lines to your OpenVPN client config:</p><div class="codebox"><pre><code>route-nopull
route 0.0.0.0 0.0.0.0 vpn_gateway 20</code></pre></div><p>If i&#039;m not mistaken, this will set a default route towards your vpn_gateway with metric 20. Note: vpn_gateway keyword is a special build-in OpenVPN macro, so do not replace it with an ip address.</p><p>More info: <a href="https://community.openvpn.net/openvpn/wiki/OverridingAPushedRouteInTheClientsConfigThrowsAndError">https://community.openvpn.net/openvpn/w … wsAndError</a></p><p>Please let me know if this works, as we can then add it to the wiki</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 27 Apr 2015, 12:41)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p274239">
				<div class="post-metadata">
					<div class="post-num">Post #1255</div>
					<div class="post-author">alastair</div>
					<div class="post-datetime">
						28 Apr 2015, 03:36					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hi alastair,</p><p>Looking at the link you posted, i think it will work. Try adding to following lines to your OpenVPN client config:</p><div class="codebox"><pre><code>route-nopull
route 0.0.0.0 0.0.0.0 vpn_gateway 20</code></pre></div><p>If i&#039;m not mistaken, this will set a default route towards your vpn_gateway with metric 20. Note: vpn_gateway keyword is a special build-in OpenVPN macro, so do not replace it with an ip address.</p><p>More info: <a href="https://community.openvpn.net/openvpn/wiki/OverridingAPushedRouteInTheClientsConfigThrowsAndError">https://community.openvpn.net/openvpn/w … wsAndError</a></p><p>Please let me know if this works, as we can then add it to the wiki</p></blockquote></div><p>That works just fine, thanks!</p><div class="codebox"><pre><code>root@openwrt:/etc# ip route
default via 100.8.122.1 dev eth1  proto static  metric 10 
default via 10.166.1.9 dev tun0  metric 20 
10.166.1.9 dev tun0  proto kernel  scope link  src 10.166.1.10 
100.8.122.0/24 dev eth1  proto static  scope link  metric 10 
192.168.1.0/24 dev br-lan  proto kernel  scope link  src 192.168.1.1 
192.168.2.0/24 dev eth0.2  proto kernel  scope link  src 192.168.2.1 </code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p274358">
				<div class="post-metadata">
					<div class="post-num">Post #1256</div>
					<div class="post-author">darkdje</div>
					<div class="post-datetime">
						28 Apr 2015, 22:05					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>darkdje wrote:</cite><blockquote><p>Hi Adze and thank you for mwan3</p><p>For now everything works fine when using as load balancing, but that&#039;s not my final goal here<br />I tried to configure it to do one thing. I have two network:</p><p>The first one is a simple internet connection than I connect to wan interface. As it&#039;s coming from my internet provider it give me <br />a IP: 192.168.2.0/24&nbsp; // GW: 192.168.2.1&nbsp; // DNS:192.168.2.1 by DHCP</p><p>The second one is a private network. It give also everything by DHCP: IP: 128.127.15.0/24 // GW: 128.127.15.1 //DNS: 172.26.101.1. This network is here to provide just a few &quot;url&quot; like &quot;timing-data.aks&quot;</p><p>So What I want to do is to force the DNS resolution of &quot;timing-data.aks&quot; with 172.26.101.1 DNS and show the page with the good network. All the others web access will be redirect to the internet connection.</p><p>After reading a lot of page here, I&#039;ve seen &quot;fovecifer&quot; who wanted to do almost the same with a vpn but maybe not in DNS point of view.</p><p>1. He create an &quot;ipset&quot; for his particular url<br />As I&#039;ve never configured network whitout GUI, I don&#039;t really know which file to modify with my ssh access and what to write in it.</p><p>2. I think I have to configure my DNSMasq to resolv timing-data.aks with the good DNS and write it into ipset<br />I think that everything as to be done in /etc/config/dhcp but I don&#039;t really know which line to add.</p><p>3. I think that here I have to configure mwan3 rules to transfer all the network to wan exept for my ipset to wan2.<br />This one, I think I understand how to type it&nbsp; but I will see when I will succeed for 1 and 2.</p><p>Am I in the good direction to make my network working?</p><p>PS: sorry for my bad english</p></blockquote></div><div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hi darkdje,</p><p>What you are trying to do is pretty straightforward. First make sure you have the correct software versions running. You need dnsmasq with ipset support; ipset version 6.24 and mwan3 version 1.6-1 (or higher ofcourse). Make sure that you have a mwan3 rule configured that routes traffic towards 172.26.101.1 over correct wan.</p><p>You need to edit /etc/dnsmasq.conf and add the following lines.<br /></p><div class="codebox"><pre><code>#Lookup timing-data.aks at specific dns server
server=/timing-data.aks/172.26.101.1
#populate ipset timing-data with timing-data.aks resolv results 
ipset=/timing-data.aks/timing-data</code></pre></div><p>After dnsmasq restart, you can use the ipset &quot;timing-data&quot; in your mwan3 rules. Good luck</p></blockquote></div><p>I only try it today and unfortunatly it doesn&#039;t work</p><p>I tried a nslookup of the url trought the router and it says that their its not internaly register (not sur of the word mine is in frenche). However, if I force nslookup with 172.26.101.1 it give me the right ip adress.</p><p>In mwan3 I have:<br />1- Destiation dressa: 172.26.101.1/32 wan2_only<br />2- ipset: timing-data wan2_only<br />3- Source address: 0.0.0.0/0 wan_anly</p><p>maybe i have done something wrong.</p><p>When I check the ipset (ipset list timing). Their no address in it.</p>											<p class="post-edited">(Last edited by <strong>darkdje</strong> on 28 Apr 2015, 22:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p274407">
				<div class="post-metadata">
					<div class="post-num">Post #1257</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						29 Apr 2015, 04:56					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>darkdje wrote:</cite><blockquote><p>maybe i have done something wrong.</p></blockquote></div><p>Show us your configs so we can look at them.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p274416">
				<div class="post-metadata">
					<div class="post-num">Post #1258</div>
					<div class="post-author">darkdje</div>
					<div class="post-datetime">
						29 Apr 2015, 09:08					</div>
				</div>
				<div class="post-content content">
					<p>So Here is my config file. I have wan1 offline. What I tried to do is make Wan2 working, but my computer answer with DNS problem. I will add wan1 after.</p><p>Mwan Config<br /></p><div class="quotebox"><blockquote><p>config policy &#039;wan2_only&#039;<br />&nbsp; &nbsp; list use_member &#039;wan2_m1_w2&#039;<br />&nbsp; &nbsp; option last_resort &#039;default&#039;</p><p>config policy &#039;wan_only&#039;<br />&nbsp; &nbsp; list use_member &#039;wan_m1_w3&#039;<br />&nbsp; &nbsp; option last_resort &#039;default&#039;</p><p>config policy &#039;balanced&#039;<br />&nbsp; &nbsp; list use_member &#039;wan_m1_w3&#039;<br />&nbsp; &nbsp; list use_member &#039;wan2_m1_w2&#039;</p><p>config policy &#039;wan_wan2&#039;<br />&nbsp; &nbsp; list use_member &#039;wan_m1_w3&#039;<br />&nbsp; &nbsp; list use_member &#039;wan2_m2_w2&#039;</p><p>config policy &#039;wan2_wan&#039;<br />&nbsp; &nbsp; list use_member &#039;wan_m2_w3&#039;<br />&nbsp; &nbsp; list use_member &#039;wan2_m1_w2&#039;</p><p>config rule &#039;dns_alk&#039;<br />&nbsp; &nbsp; option dest_ip &#039;172.26.101.1/32&#039;<br />&nbsp; &nbsp; option proto &#039;all&#039;<br />&nbsp; &nbsp; option sticky &#039;0&#039;<br />&nbsp; &nbsp; option use_policy &#039;wan2_only&#039;</p><p>config rule &#039;timing_data&#039;<br />&nbsp; &nbsp; option proto &#039;all&#039;<br />&nbsp; &nbsp; option sticky &#039;0&#039;<br />&nbsp; &nbsp; option use_policy &#039;wan2_only&#039;<br />&nbsp; &nbsp; option ipset &#039;timing&#039;</p><p>config rule &#039;cosworth_data&#039;<br />&nbsp; &nbsp; option proto &#039;all&#039;<br />&nbsp; &nbsp; option sticky &#039;0&#039;<br />&nbsp; &nbsp; option ipset &#039;cosworth&#039;<br />&nbsp; &nbsp; option use_policy &#039;wan2_only&#039;</p><p>config rule &#039;fiawec&#039;<br />&nbsp; &nbsp; option proto &#039;all&#039;<br />&nbsp; &nbsp; option sticky &#039;0&#039;<br />&nbsp; &nbsp; option ipset &#039;fia&#039;<br />&nbsp; &nbsp; option use_policy &#039;wan2_only&#039;</p><p>config rule &#039;alk_tcp_port&#039;<br />&nbsp; &nbsp; option dest_port &#039;10011&#039;<br />&nbsp; &nbsp; option proto &#039;tcp&#039;<br />&nbsp; &nbsp; option sticky &#039;0&#039;<br />&nbsp; &nbsp; option use_policy &#039;wan2_only&#039;</p><p>config rule &#039;alk_udp_port&#039;<br />&nbsp; &nbsp; option dest_port &#039;10011&#039;<br />&nbsp; &nbsp; option sticky &#039;0&#039;<br />&nbsp; &nbsp; option use_policy &#039;wan2_only&#039;<br />&nbsp; &nbsp; option proto &#039;udp&#039;</p><p>config rule &#039;default_rule&#039;<br />&nbsp; &nbsp; option dest_ip &#039;0.0.0.0/0&#039;<br />&nbsp; &nbsp; option proto &#039;all&#039;<br />&nbsp; &nbsp; option sticky &#039;0&#039;<br />&nbsp; &nbsp; option use_policy &#039;wan_wan2&#039;</p><p>config interface &#039;wan&#039;<br />&nbsp; &nbsp; list track_ip &#039;8.8.4.4&#039;<br />&nbsp; &nbsp; list track_ip &#039;8.8.8.8&#039;<br />&nbsp; &nbsp; list track_ip &#039;208.67.222.222&#039;<br />&nbsp; &nbsp; list track_ip &#039;208.67.220.220&#039;<br />&nbsp; &nbsp; option reliability &#039;2&#039;<br />&nbsp; &nbsp; option count &#039;1&#039;<br />&nbsp; &nbsp; option timeout &#039;2&#039;<br />&nbsp; &nbsp; option interval &#039;5&#039;<br />&nbsp; &nbsp; option down &#039;3&#039;<br />&nbsp; &nbsp; option up &#039;8&#039;<br />&nbsp; &nbsp; option enabled &#039;1&#039;</p><p>config interface &#039;wan2&#039;<br />&nbsp; &nbsp; option reliability &#039;1&#039;<br />&nbsp; &nbsp; option count &#039;1&#039;<br />&nbsp; &nbsp; option timeout &#039;2&#039;<br />&nbsp; &nbsp; option interval &#039;5&#039;<br />&nbsp; &nbsp; option down &#039;3&#039;<br />&nbsp; &nbsp; option up &#039;8&#039;<br />&nbsp; &nbsp; option enabled &#039;1&#039;<br />&nbsp; &nbsp; list track_ip &#039;128.127.15.1&#039;</p><p>config member &#039;wan_m1_w3&#039;<br />&nbsp; &nbsp; option interface &#039;wan&#039;<br />&nbsp; &nbsp; option metric &#039;1&#039;<br />&nbsp; &nbsp; option weight &#039;3&#039;</p><p>config member &#039;wan_m2_w3&#039;<br />&nbsp; &nbsp; option interface &#039;wan&#039;<br />&nbsp; &nbsp; option metric &#039;2&#039;<br />&nbsp; &nbsp; option weight &#039;3&#039;</p><p>config member &#039;wan2_m1_w2&#039;<br />&nbsp; &nbsp; option interface &#039;wan2&#039;<br />&nbsp; &nbsp; option metric &#039;1&#039;<br />&nbsp; &nbsp; option weight &#039;2&#039;</p><p>config member &#039;wan2_m2_w2&#039;<br />&nbsp; &nbsp; option interface &#039;wan2&#039;<br />&nbsp; &nbsp; option metric &#039;2&#039;<br />&nbsp; &nbsp; option weight &#039;2&#039;</p></blockquote></div><p>Network Config</p><div class="quotebox"><blockquote><p>config interface &#039;loopback&#039;<br />&nbsp; &nbsp; option ifname &#039;lo&#039;<br />&nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; option ipaddr &#039;127.0.0.1&#039;<br />&nbsp; &nbsp; option netmask &#039;255.0.0.0&#039;</p><p>config globals &#039;globals&#039;<br />&nbsp; &nbsp; option ula_prefix &#039;fdf9:81e2:cf68::/48&#039;</p><p>config interface &#039;lan&#039;<br />&nbsp; &nbsp; option ifname &#039;eth0.1&#039;<br />&nbsp; &nbsp; option force_link &#039;1&#039;<br />&nbsp; &nbsp; option type &#039;bridge&#039;<br />&nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; option netmask &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; option ip6assign &#039;60&#039;<br />&nbsp; &nbsp; option ipaddr &#039;192.168.2.1&#039;<br />&nbsp; &nbsp; option gateway &#039;192.168.2.1&#039;<br />&nbsp; &nbsp; option broadcast &#039;192.168.2.255&#039;</p><p>config interface &#039;wan&#039;<br />&nbsp; &nbsp; option ifname &#039;eth0.2&#039;<br />&nbsp; &nbsp; option proto &#039;dhcp&#039;<br />&nbsp; &nbsp; option metric &#039;10&#039;</p><p>config interface &#039;wan6&#039;<br />&nbsp; &nbsp; option ifname &#039;eth0.2&#039;<br />&nbsp; &nbsp; option proto &#039;dhcpv6&#039;</p><p>config switch<br />&nbsp; &nbsp; option name &#039;switch0&#039;<br />&nbsp; &nbsp; option reset &#039;1&#039;<br />&nbsp; &nbsp; option enable_vlan &#039;1&#039;<br />&nbsp; &nbsp; option mirror_source_port &#039;0&#039;<br />&nbsp; &nbsp; option enable_vlan4k &#039;1&#039;<br />&nbsp; &nbsp; option mirror_monitor_port &#039;1&#039;</p><p>config switch_vlan<br />&nbsp; &nbsp; option device &#039;switch0&#039;<br />&nbsp; &nbsp; option vlan &#039;1&#039;<br />&nbsp; &nbsp; option ports &#039;2 3 4 5t&#039;</p><p>config switch_vlan<br />&nbsp; &nbsp; option device &#039;switch0&#039;<br />&nbsp; &nbsp; option vlan &#039;2&#039;<br />&nbsp; &nbsp; option ports &#039;0 5t&#039;</p><p>config switch_vlan<br />&nbsp; &nbsp; option device &#039;switch0&#039;<br />&nbsp; &nbsp; option vlan &#039;3&#039;<br />&nbsp; &nbsp; option ports &#039;1 5t&#039;</p><p>config interface &#039;wan2&#039;<br />&nbsp; &nbsp; option proto &#039;dhcp&#039;<br />&nbsp; &nbsp; option ifname &#039;eth0.3&#039;<br />&nbsp; &nbsp; option metric &#039;20&#039;</p><p>config switch_vlan<br />&nbsp; &nbsp; option device &#039;switch0&#039;<br />&nbsp; &nbsp; option vlan &#039;4&#039;<br />&nbsp; &nbsp; option ports &#039;5t&#039;</p><p>config interface &#039;hotspot&#039;<br />&nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; option ifname &#039;eth0.4&#039;<br />&nbsp; &nbsp; option ipaddr &#039;192.168.200.1&#039;<br />&nbsp; &nbsp; option netmask &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; option type &#039;bridge&#039;<br />&nbsp; &nbsp; option defaultroute &#039;0&#039;</p></blockquote></div><p>Mwan Statut</p><div class="quotebox"><blockquote><p>Interface status:<br /> interface wan is offline (tracking down)<br /> interface wan2 is online (tracking active)</p><p>Policy balanced:<br /> wan2 (100%)</p><p>Policy wan2_only:<br /> wan2 (100%)</p><p>Policy wan2_wan:<br /> wan2 (100%)</p><p>Policy wan_only:<br /> default</p><p>Policy wan_wan2:<br /> wan2 (100%)</p><p>Known networks:<br /> 192.168.2.0<br /> 127.0.0.0/8<br /> 128.127.15.1<br /> 192.168.2.255<br /> 192.168.2.1<br /> 192.168.200.0/24<br /> 192.168.2.0/24<br /> 128.127.15.0<br /> 192.168.200.255<br /> 127.255.255.255<br /> 224.0.0.0/3<br /> 127.0.0.0<br /> 192.168.200.0<br /> 128.127.15.152<br /> 128.127.15.255<br /> 192.168.200.1<br /> 128.127.15.0/24<br /> 127.0.0.1</p><p>Active rules:<br />&nbsp; 332 21196 - wan2_only&nbsp; all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 172.26.101.1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0 - wan2_only&nbsp; all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; match-set timing dst <br />&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0 - wan2_only&nbsp; all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; match-set cosworth dst <br />&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0 - wan2_only&nbsp; all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; match-set fia dst <br />&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0 - wan2_only&nbsp; tcp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; multiport sports 0:65535 multiport dports 10011 <br />&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0 - wan2_only&nbsp; udp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; multiport sports 0:65535 multiport dports 10011 <br /> 4026&nbsp; 437K - wan_wan2&nbsp; all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0</p></blockquote></div><p>dnsmasq.conf<br /></p><div class="quotebox"><blockquote><p># Change the following lines if you want dnsmasq to serve SRV<br /># records.<br /># You may add multiple srv-host lines.<br /># The fields are &lt;name&gt;,&lt;target&gt;,&lt;port&gt;,&lt;priority&gt;,&lt;weight&gt;</p><p># A SRV record sending LDAP for the example.com domain to<br /># ldapserver.example.com port 289<br />#srv-host=_ldap._tcp.example.com,ldapserver.example.com,389</p><p># Two SRV records for LDAP, each with different priorities<br />#srv-host=_ldap._tcp.example.com,ldapserver.example.com,389,1<br />#srv-host=_ldap._tcp.example.com,ldapserver.example.com,389,2</p><p># A SRV record indicating that there is no LDAP server for the domain<br /># example.com<br />#srv-host=_ldap._tcp.example.com</p><p># The following line shows how to make dnsmasq serve an arbitrary PTR<br /># record. This is useful for DNS-SD.</p><p># The fields are &lt;name&gt;,&lt;target&gt;<br />#ptr-record=_http._tcp.dns-sd-services,&quot;New Employee Page._http._tcp.dns-sd-ser$</p><p># Change the following lines to enable dnsmasq to serve TXT records.<br /># These are used for things like SPF and zeroconf.<br /># The fields are &lt;name&gt;,&lt;text&gt;,&lt;text&gt;...</p><p>#Example SPF.<br />#txt-record=example.com,&quot;v=spf1 a -all&quot;</p><p>#Example zeroconf<br />#txt-record=_http._tcp.example.com,name=value,paper=A4</p><p># Provide an alias for a &quot;local&quot; DNS name. Note that this _only_ works<br /># for targets which are names from DHCP or /etc/hosts. Give host<br /># &quot;bert&quot; another name, bertrand<br /># The fields are &lt;cname&gt;,&lt;target&gt;<br />#cname=bertand,bert</p><p>#Address which look at specific DNS<br />server=/timing-data.aks/172.26.101.1<br />server=/cosworth-data.aks/172.26.101.1<br />server=/intranet.fiawec.com/172.26.101.1</p><br /><p>#ipset creation with that specific rules<br />ipset=/timing-data.aks/timing<br />ipset=/cosworth-data.aks/cosworth<br />ipset=/intranet.fiawec.com/fia</p></blockquote></div><p>After some hours of investigation, ti seems to work with adresse like <a href="http://www.URL.com">www.URL.com</a> but as my intranet url never work with <a href="http://www.timing-data.aks">www.timing-data.aks</a>, but only with timing-data.aks, it seems that my DNSmasq doesn&#039;t work on them fine. I search for an option to work on that.</p>											<p class="post-edited">(Last edited by <strong>darkdje</strong> on 29 Apr 2015, 12:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p274550">
				<div class="post-metadata">
					<div class="post-num">Post #1259</div>
					<div class="post-author">alastair</div>
					<div class="post-datetime">
						30 Apr 2015, 05:28					</div>
				</div>
				<div class="post-content content">
					<p>Just wanted to say thanks so much to Adze - mwan3 is amazingly powerful, and it is is exactly the reason why I run OpenWRT in the first place. Thanks again.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p274640">
				<div class="post-metadata">
					<div class="post-num">Post #1260</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						30 Apr 2015, 22:54					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>darkdje wrote:</cite><blockquote><p>After some hours of investigation, ti seems to work with adresse like <a href="http://www.URL.com">www.URL.com</a> but as my intranet url never work with <a href="http://www.timing-data.aks">www.timing-data.aks</a>, but only with timing-data.aks, it seems that my DNSmasq doesn&#039;t work on them fine. I search for an option to work on that.</p></blockquote></div><p>That&#039;s pretty strange, as this is what dnsmasq example config has to say:</p><div class="codebox"><pre><code># Add the IPs of all queries to yahoo.com, google.com, and their
# subdomains to the vpn and search ipsets:
ipset=/yahoo.com/google.com/vpn,search</code></pre></div><p>Which would suggest that it should also work without subdomain.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 30 Apr 2015, 22:56)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p274759">
				<div class="post-metadata">
					<div class="post-num">Post #1261</div>
					<div class="post-author">kikimora</div>
					<div class="post-datetime">
						1 May 2015, 16:33					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><div class="quotebox"><cite>darkdje wrote:</cite><blockquote><p>After some hours of investigation, ti seems to work with adresse like <a href="http://www.URL.com">www.URL.com</a> but as my intranet url never work with <a href="http://www.timing-data.aks">www.timing-data.aks</a>, but only with timing-data.aks, it seems that my DNSmasq doesn&#039;t work on them fine. I search for an option to work on that.</p></blockquote></div><p>That&#039;s pretty strange, as this is what dnsmasq example config has to say:</p><div class="codebox"><pre><code># Add the IPs of all queries to yahoo.com, google.com, and their
# subdomains to the vpn and search ipsets:
ipset=/yahoo.com/google.com/vpn,search</code></pre></div><p>Which would suggest that it should also work without subdomain.</p></blockquote></div><br /><p>Your *.timing-data.aks queries are being forwarded to a custom DNS server 172.26.101.1 . Does it respond properly?</p><p>dig @172.26.101.1 <a href="http://www.timing-data.aks">www.timing-data.aks</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p275875">
				<div class="post-metadata">
					<div class="post-num">Post #1262</div>
					<div class="post-author">dir2cas</div>
					<div class="post-datetime">
						10 May 2015, 20:54					</div>
				</div>
				<div class="post-content content">
					<p>I am currently trying to set up mwan3, but I faced the following issue.</p><p>I have 2 WAN links, and they were tested OK, before proceeding to mwan3. Now, I am trying to test the failover feature, but it seems that it does not detect the link failure. I have a manageable switch that the router is connected to. Both ISPs are also attached to the same switch. I am imitating WAN link fault disabling the phy interface towards one of the providers, but mwan3 does not detect it.</p><p>Here are some dumps:<br /></p><div class="codebox"><pre><code># The switch output first - see the interface is disabled administratively
sw1#sh int desc | i WAN
Fa0/1                          admin down     down     WAN1_ISP1_/24Mbps/
Fa0/2                          up             up       WAN2_ISP2_/45Mbps/

# eth0.2 - wan1 (that is passing via the disables port above)
# eth0.3 - wan2 (that is UP)
[root@RTR-TEST:~]# ping -c 3 -I eth0.3 4.2.2.2
PING 4.2.2.2 (4.2.2.2) from 46.249.80.XX eth0.3: 56(84) bytes of data.
64 bytes from 4.2.2.2: icmp_req=1 ttl=57 time=43.9 ms
64 bytes from 4.2.2.2: icmp_req=2 ttl=57 time=43.4 ms
^C
--- 4.2.2.2 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 43.420/43.690/43.961/0.341 ms

[root@RTR-TEST:~]# ping -c 3 -I eth0.2 4.2.2.2
PING 4.2.2.2 (4.2.2.2) from 46.40.125.XX eth0.2: 56(84) bytes of data.
64 bytes from 4.2.2.2: icmp_req=1 ttl=57 time=43.4 ms
64 bytes from 4.2.2.2: icmp_req=2 ttl=57 time=43.4 ms
64 bytes from 4.2.2.2: icmp_req=3 ttl=57 time=43.3 ms

--- 4.2.2.2 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2002ms
rtt min/avg/max/mdev = 43.305/43.413/43.489/0.187 ms

# But traceroute shows:
[root@RTR-TEST:~]# traceroute -i eth0.2 4.2.2.2     
traceroute to 4.2.2.2 (4.2.2.2), 30 hops max, 38 byte packets
 1  46.40.125.XX (46.40.125.XX)  2991.095 ms !H  *  995.269 ms !H
[root@RTR-TEST:~]# traceroute -i eth0.3 4.2.2.2
traceroute to 4.2.2.2 (4.2.2.2), 30 hops max, 38 byte packets
 1  46-249-80-1.net1.bg (46.249.80.1)  0.486 ms  0.631 ms  0.412 ms
 2  T960-25.net1.bg (37.157.189.25)  0.793 ms  0.757 ms  0.440 ms
 3  37.157.189.1 (37.157.189.1)  0.656 ms  1.425 ms  1.261 ms
 4  37.157.189.2 (37.157.189.2)  0.921 ms  1.083 ms  0.777 ms
 5  212.162.46.121 (212.162.46.121)  1.564 ms  1.455 ms  0.971 ms
................................. (output truncated)     

# mwan3 still considers the wan1 as alive
[root@RTR-TEST:~]# mwan3 status
Interface status:
Interface wan1 is online (tracking active)
Interface wan2 is online (tracking active)

Policy balanced:
 wan2 (60%)
 wan1 (40%)

Policy wan1_only:
 wan1 (100%)

Policy wan1_wan2:
 wan1 (100%)

Policy wan2_only:
 wan2 (100%)

Policy wan2_wan1:
 wan2 (100%)

Known networks:
destination        policy             hits     
-----------------------------------------------
127.0.0.0/8        default            104      
................................. (output truncated)     

Active rules:
source             destination        proto  src-port      dest-port     policy          hits     
--------------------------------------------------------------------------------------------------
&lt;Internal_host&gt;      0.0.0.0/0          all                                wan1_only       98       
&lt;Internal_host&gt;     0.0.0.0/0          all                                wan2_only       86       
&lt;Internal_host&gt;      0.0.0.0/0          all                                wan1_wan2       0        
&lt;Internal_host&gt;     0.0.0.0/0          all                                wan2_wan1       0        
&lt;Internal_host&gt;     0.0.0.0/0          all                                wan2_wan1       0        
0.0.0.0/0          46.40.72.13        all                                wan1_only       130      
0.0.0.0/0          46.40.72.9         all                                wan1_only       37       
0.0.0.0/0          95.87.194.4        all                                wan2_only       2        
0.0.0.0/0          212.73.140.25      all                                wan1_wan2       0        
0.0.0.0/0          217.9.234.235      all                                wan1_wan2       0        
0.0.0.0/0          217.9.234.234      all                                wan2_wan1       0        
0.0.0.1/0.0.0.1    0.0.0.0/0          tcp    0:65535       443           wan2_wan1       31       
0.0.0.0/0          10.0.0.0/8         all                                MARK            55       
0.0.0.0/0          172.16.0.0/12      all                                MARK            0        
0.0.0.0/0          192.168.0.0/16     all                                MARK            0        
0.0.0.0/0          0.0.0.0/0          all                                balanced        568      </code></pre></div><p>mwan3 is correctly configured:<br /></p><div class="codebox"><pre><code>[root@RTR-TEST:~]# cat /etc/config/mwan3

config interface &#039;wan1&#039;
    option enabled &#039;1&#039;
    list track_ip &#039;46.40.125.1&#039;
    list track_ip &#039;212.73.140.119&#039;
    list track_ip &#039;8.8.8.8&#039;
    list track_ip &#039;208.67.222.222&#039;
    list track_ip &#039;208.67.220.220&#039;
    option reliability &#039;3&#039;
    option count &#039;5&#039;
    option timeout &#039;2&#039;
    option interval &#039;20&#039;
    option down &#039;1&#039;
    option up &#039;3&#039;

config interface &#039;wan2&#039;
    option enabled &#039;1&#039;
    list track_ip &#039;46.249.80.1&#039;
    list track_ip &#039;87.120.130.66&#039;
    list track_ip &#039;8.8.8.8&#039;
    list track_ip &#039;208.67.222.222&#039;
    list track_ip &#039;208.67.220.220&#039;
    option reliability &#039;3&#039;
    option count &#039;5&#039;
    option timeout &#039;2&#039;
    option interval &#039;20&#039;
    option down &#039;1&#039;
    option up &#039;3&#039;

config member &#039;wan1_m10_w2&#039;
    option interface &#039;wan1&#039;
    option metric &#039;10&#039;
    option weight &#039;2&#039;

config member &#039;wan1_m20_w2&#039;
    option interface &#039;wan1&#039;
    option metric &#039;20&#039;
    option weight &#039;2&#039;

config member &#039;wan2_m10_w3&#039;
    option interface &#039;wan2&#039;
    option metric &#039;10&#039;
    option weight &#039;3&#039;

config member &#039;wan2_m20_w3&#039;
    option interface &#039;wan2&#039;
    option metric &#039;20&#039;
    option weight &#039;3&#039;

####################################
# POLICY:
####################################
config policy &#039;wan1_only&#039;
        list use_member &#039;wan1_m10_w2&#039;

config policy &#039;wan2_only&#039;
        list use_member &#039;wan2_m10_w3&#039;

config policy &#039;wan1_wan2&#039;
        list use_member &#039;wan1_m10_w2&#039;
        list use_member &#039;wan2_m20_w3&#039;

config policy &#039;wan2_wan1&#039;
        list use_member &#039;wan1_m20_w2&#039;
        list use_member &#039;wan2_m10_w3&#039;

config policy &#039;balanced&#039;
        list use_member &#039;wan1_m10_w2&#039;
        list use_member &#039;wan2_m10_w3&#039;

####################################
# RULES:
####################################
................................. (output truncated)     </code></pre></div><p>I also have to mention that I am using my own customly built firmware image in which I have swapped the busybox ping with the full package:<br />CONFIG_PACKAGE_iputils-ping=y<br />CONFIG_PACKAGE_iputils-ping6=y<br />The mwan3 package together with its luci module have been also integrated into the image.</p><p>I edited the Public address in the output, if you need more details, please give me an email to send them to.</p><p>p.s. missed another packages that may interfere with mwan3&#039;s operation<br /></p><div class="codebox"><pre><code>[root@RTR-TEST:~]# opkg list_installed | grep conntr
conntrack-tools - 1.0.0-1
iptables-mod-conntrack-extra - 1.4.21-1
kmod-ipt-conntrack - 3.10.49-1
kmod-ipt-conntrack-extra - 3.10.49-1
kmod-nf-conntrack-netlink - 3.10.49-1
libnetfilter-conntrack - 1.0.3-1

# Here is a notice while troubleshooting - seems like a mismatch in the NAT table:
[root@RTR-TEST:~]# conntrack -L | grep 8.8.8.8
icmp     1 29 src=46.249.80.XX dst=8.8.8.8 type=8 code=0 id=6210 packets=4 bytes=368 src=8.8.8.8 dst=46.249.80.XX type=0 code=0 id=6210 packets=4 bytes=368 mark=512 use=1
icmp     1 16 src=46.40.125.XX dst=8.8.8.8 type=8 code=0 id=6203 packets=5 bytes=460 src=8.8.8.8 dst=46.249.80.XX type=0 code=0 id=6203 packets=5 bytes=460 mark=512 use=1
conntrack v1.0.0 (conntrack-tools): 152 flow entries have been shown.</code></pre></div>											<p class="post-edited">(Last edited by <strong>dir2cas</strong> on 10 May 2015, 23:02)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p275919">
				<div class="post-metadata">
					<div class="post-num">Post #1263</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						11 May 2015, 10:50					</div>
				</div>
				<div class="post-content content">
					<p>Hi dir2cas,</p><br /><p>Your output (ping tests on eth0.2 and eth0.3) suggest that both wan interfaces are UP, as you get ping replies on both of them. Mwan3 relies on that. It is not a mwan3 problem...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p275926">
				<div class="post-metadata">
					<div class="post-num">Post #1264</div>
					<div class="post-author">dir2cas</div>
					<div class="post-datetime">
						11 May 2015, 12:54					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hi dir2cas,</p><br /><p>Your output (ping tests on eth0.2 and eth0.3) suggest that both wan interfaces are UP, as you get ping replies on both of them. Mwan3 relies on that. It is not a mwan3 problem...</p></blockquote></div><p>Yes, but it is exactly the problem. Ping was running despite the fact that the wan1 link was interrupted. It was done indirectly looking from the router&#039;s perspective, since no phy link to the router was interrupted, but the one to the ISP1 (wan1/eth0.2).</p><p>As you can see from the conntrack table output, seems like the ping -I eth0.2 somehow passes via the second wan, that was operational (eth0.3/wan2).</p><p>Actually the first issue was fixed after I modified the packet size of the ping that mwan3track is running. As I mentioned, I am using the full ping package (iputils-ping), which considers the preset mwan3track packet size as invalid (and it is actually):<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ping -I $2 -c $4 -W $5 -s 4 -q $track_ip &amp;&gt; /dev/null<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ping -I $2 -c $4 -W $5 -s 64 -q $track_ip &amp;&gt; /dev/null</p><p>It is good to change this value in the next version of your tool. </p><p>After fixing that, mwan3 started actually to do some real tracking and started logging some events. But here, I am facing the other issue, that was described in the previous post.</p><p>During the failover test, after the interruption of wan1 took place, some strange things started to happen:<br />- I can see failed ping via wan2, which is wan that was NOT interrupted<br />- but at the same time some of the pings passes successfully via wan1 (that is interrupted).</p><p>I will do a small modification of mwantrack in order to log the packet loss values and I will try show you the situation described.</p><p>My assumption so far, is that the issue is caused by a malfunction of the conntrack mechanism, that does not give the possibility mwan3 to detect the problem correctly, but will be glad if you can help me to further find the root cause.</p>											<p class="post-edited">(Last edited by <strong>dir2cas</strong> on 11 May 2015, 15:53)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p275974">
				<div class="post-metadata">
					<div class="post-num">Post #1265</div>
					<div class="post-author">dir2cas</div>
					<div class="post-datetime">
						11 May 2015, 20:53					</div>
				</div>
				<div class="post-content content">
					<p>OK, here is a dump from the 10 minutes test that I ran.</p><p>All the timestamps in the log and the switch output are 100% correct and syncronized, since the switch is also configured to send the logs to the router&#039;s syslog-ng.</p><p>1) I did a small modification of mwan3track in order to keep a track of the Packet loss towards each mwan3 trackable targets.<br /></p><div class="codebox"><pre><code>[root@RTR-TEST:~]# diff /rom/usr/sbin/mwan3track /usr/sbin/mwan3track 
--- /rom/usr/sbin/mwan3track
+++ /usr/sbin/mwan3track
@@ -13,15 +13,23 @@
 track_ips=$(echo $* | cut -d &#039; &#039; -f 9-99)
 host_up_count=0
 lost=0
+PLOSS_DEFAULT=&quot;100&quot;     #Default Packet loss rate in %
+PLOSS_THRESHOLD=&quot;5&quot;     #Packet loss rate in %, that triggers host condition change (up|down)
 
 while true; do
 
     for track_ip in $track_ips; do
-        ping -I $2 -c $4 -W $5 -s 4 -q $track_ip &amp;&gt; /dev/null
-        if [ $? -eq 0 ]; then
+        #ping -I $2 -c $4 -W $5 -s 4 -q $track_ip &amp;&gt; /dev/null
+        PING_RESULT=$($(which ping) -I $2 -c $4 -W $5 -s 64 -q $track_ip | grep &quot;packet loss&quot;) &amp;&gt; /dev/null
+        PLOSS=$(echo &quot;${PING_RESULT}&quot; | sed -e &#039;s/^.*received, //&#039; -e &#039;s/^.*errors, //&#039; -e &#039;s/% packet loss.*//&#039;)
+        if [ -z &quot;${PLOSS}&quot; ]; then PLOSS=${PLOSS_DEFAULT}; fi
+        
+        #if [ $? -eq 0 ]; then
+        if [ &quot;${PLOSS}&quot; -le &quot;${PLOSS_THRESHOLD}&quot; ]; then
             let host_up_count++
         else
             let lost++
+            logger -t mwan3track -p notice &quot;Tracked host issue detected on Interface $1 ($2): $track_ip -&gt; ${PLOSS}% packet loss&quot;
         fi
     done
         
[root@RTR-TEST:~]# </code></pre></div><p>2) The mwan3 interface configuration<br /></p><div class="codebox"><pre><code>[root@RTR-TEST:~]# cat /etc/config/mwan3

config interface &#039;wan1&#039;
    option enabled &#039;1&#039;
    list track_ip &#039;46.40.125.1&#039;
    list track_ip &#039;212.73.140.119&#039;
    list track_ip &#039;8.8.8.8&#039;
    list track_ip &#039;208.67.222.222&#039;
    list track_ip &#039;208.67.220.220&#039;
    option reliability &#039;3&#039;
    option count &#039;5&#039;
    option timeout &#039;2&#039;
    option interval &#039;20&#039;
    option down &#039;1&#039;
    option up &#039;3&#039;

config interface &#039;wan2&#039;
    option enabled &#039;1&#039;
    list track_ip &#039;46.249.80.1&#039;
    list track_ip &#039;87.120.130.66&#039;
    list track_ip &#039;8.8.8.8&#039;
    list track_ip &#039;208.67.222.222&#039;
    list track_ip &#039;208.67.220.220&#039;
    option reliability &#039;3&#039;
    option count &#039;5&#039;
    option timeout &#039;2&#039;
    option interval &#039;20&#039;
    option down &#039;1&#039;
    option up &#039;3&#039;</code></pre></div><p>3) Test started - the switchport facing the ISP1 is administratively disabled (switch logging can be seen in the router&#039;s log as mentioned).</p><div class="codebox"><pre><code>sw1#
sw1#conf t
Enter configuration commands, one per line.  End with CNTL/Z.
sw1(config)#int fa 0/1
sw1(config-if)#shut
sw1(config-if)#^Z
sw1#sh int desc | i WAN
Fa0/1                          admin down     down     WAN1_/24Mbps/
Fa0/2                          up             up       WAN2_/45Mbps/
sw1#sh clock           
20:02:17.252 EEST Mon May 11 2015
sw1#
sw1#
sw1#conf t             
Enter configuration commands, one per line.  End with CNTL/Z.
sw1(config)#int fa 0/1
sw1(config-if)#no shut
sw1(config-if)#^Z
sw1#sh int desc | i WAN
Fa0/1                          up             up       WAN1_/24Mbps/
Fa0/2                          up             up       WAN2_/45Mbps/
sw1#sh clock           
20:08:58.666 EEST Mon May 11 2015
sw1#</code></pre></div><p>4) After WAN1 interruption you can see that there are several trackable hosts that seems pingable via the disables link (wan1), but the ping failes via the operational link (wan2).<br />It even happened 2 times for those 10 minutes that the wan1 was detected to go UP and down again after a while. Through the whole period the switch port handling the link to ISP1 (t.e. wan1) was down, so no ping should ever pass via wan1(eth0.2).</p><p>There are several failed pings via wan2 (that fully operational at this moment) on a random bases (I suppose)<br /></p><div class="codebox"><pre><code>May 11 20:02:13 sw1 2001: May 11 20:02:12 EEST: %SYS-5-CONFIG_I: Configured from console by dir2cas on vty0
May 11 20:02:14 sw1 2002: May 11 20:02:13 EEST: %LINK-5-CHANGED: Interface FastEthernet0/1, changed state to administratively down
May 11 20:02:15 sw1 2003: May 11 20:02:14 EEST: %LINEPROTO-5-UPDOWN: Line protocol on Interface FastEthernet0/1, changed state to down
May 11 20:02:20 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 208.67.220.220 -&gt; 100% packet loss
May 11 20:02:32 RTR-TEST mwan3track: Tracked host issue detected on Interface wan2 (eth0.3): 208.67.220.220 -&gt; 100% packet loss
May 11 20:02:38 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 11 20:02:42 RTR-TEST mwan3track: Tracked host issue detected on Interface wan2 (eth0.3): 8.8.8.8 -&gt; 100% packet loss
May 11 20:03:08 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 208.67.222.222 -&gt; 100% packet loss
May 11 20:03:14 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 8.8.8.8 -&gt; 100% packet loss
May 11 20:03:20 RTR-TEST mwan3track: Tracked host issue detected on Interface wan2 (eth0.3): 208.67.222.222 -&gt; 100% packet loss
May 11 20:03:24 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 11 20:03:24 RTR-TEST mwan3track: Interface wan1 (eth0.2) is offline
May 11 20:03:24 RTR-TEST mwan3: ifdown interface wan1 (eth0.2)
May 11 20:03:26 RTR-TEST mwan3track: Tracked host issue detected on Interface wan2 (eth0.3): 8.8.8.8 -&gt; 100% packet loss
May 11 20:03:28 RTR-TEST root: stopping ntpclient
May 11 20:04:10 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 11 20:04:10 RTR-TEST mwan3track: Lost 20 ping(s) on interface wan1 (eth0.2)
May 11 20:04:52 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 11 20:04:52 RTR-TEST mwan3track: Lost 5 ping(s) on interface wan1 (eth0.2)
May 11 20:05:34 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 11 20:05:34 RTR-TEST mwan3track: Lost 5 ping(s) on interface wan1 (eth0.2)
May 11 20:05:35 RTR-TEST mwan3track: Interface wan1 (eth0.2) is online
May 11 20:05:35 RTR-TEST mwan3: ifup interface wan1 (eth0.2)
May 11 20:05:38 RTR-TEST firewall: Reloading firewall due to ifup of wan1 (eth0.2)
May 11 20:05:41 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 208.67.220.220 -&gt; 100% packet loss
May 11 20:05:52 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 212.73.140.119 -&gt; 100% packet loss
May 11 20:05:55 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 11 20:05:56 RTR-TEST mwan3track: Interface wan1 (eth0.2) is offline
May 11 20:06:01 RTR-TEST mwan3track: Tracked host issue detected on Interface wan2 (eth0.3): 208.67.222.222 -&gt; 100% packet loss
May 11 20:06:11 RTR-TEST mwan3track: Tracked host issue detected on Interface wan2 (eth0.3): 87.120.130.66 -&gt; 100% packet loss
May 11 20:06:41 RTR-TEST mwan3: ifdown interface wan1 (eth0.2)
May 11 20:06:45 RTR-TEST mwan3track: Tracked host issue detected on Interface wan2 (eth0.3): 208.67.222.222 -&gt; 60% packet loss
May 11 20:07:26 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 11 20:07:26 RTR-TEST mwan3track: Lost 20 ping(s) on interface wan1 (eth0.2)
May 11 20:08:09 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 11 20:08:09 RTR-TEST mwan3track: Lost 5 ping(s) on interface wan1 (eth0.2)
May 11 20:08:51 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 11 20:08:51 RTR-TEST mwan3track: Lost 5 ping(s) on interface wan1 (eth0.2)
May 11 20:08:51 RTR-TEST mwan3track: Interface wan1 (eth0.2) is online
May 11 20:08:51 RTR-TEST mwan3: ifup interface wan1 (eth0.2)
May 11 20:08:55 sw1 2004: May 11 20:08:54 EEST: %SYS-5-CONFIG_I: Configured from console by dir2cas on vty0
May 11 20:08:55 RTR-TEST firewall: Reloading firewall due to ifup of wan1 (eth0.2)
May 11 20:08:56 sw1 2005: May 11 20:08:55 EEST: %LINK-3-UPDOWN: Interface FastEthernet0/1, changed state to up
May 11 20:08:56 sw1 2006: May 11 20:08:56 EEST: %LINEPROTO-5-UPDOWN: Line protocol on Interface FastEthernet0/1, changed state to up
May 11 20:08:58 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 208.67.220.220 -&gt; 100% packet loss
May 11 20:09:08 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 8.8.8.8 -&gt; 100% packet loss
May 11 20:09:17 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 11 20:09:17 RTR-TEST mwan3track: Interface wan1 (eth0.2) is offline
May 11 20:09:25 RTR-TEST root: starting ntpclient
May 11 20:09:27 RTR-TEST mwan3: ifdown interface wan1 (eth0.2)
May 11 20:09:30 RTR-TEST root: stopping ntpclient
May 11 20:10:11 RTR-TEST mwan3track: Lost 15 ping(s) on interface wan1 (eth0.2)
May 11 20:11:31 RTR-TEST mwan3track: Interface wan1 (eth0.2) is online
May 11 20:11:32 RTR-TEST mwan3: ifup interface wan1 (eth0.2)
May 11 20:11:35 RTR-TEST firewall: Reloading firewall due to ifup of wan1 (eth0.2)
May 11 20:11:36 RTR-TEST root: starting ntpclient</code></pre></div><p>5) You can see that even after the switch port towards ISP1 was brought up which should lead to a fully operational wan1, mwan3 detects a link fault and after more than 2 minutes restores the link again as it should.</p><p>As a conclusion, I am currently not able to identify the root cause. It is related either with the conntrack package/mechanism or with mwan3 marking rules.</p><p>Any ideas would be fairly helful.</p><p>BR, dir2cas</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p276054">
				<div class="post-metadata">
					<div class="post-num">Post #1266</div>
					<div class="post-author">belliash</div>
					<div class="post-datetime">
						12 May 2015, 12:05					</div>
				</div>
				<div class="post-content content">
					<p>Is it possible to use mwan3 to configure 3G connection as a failover, but only for outgoing traffic coming from one specific host inside the network? Can mwan3 execute some script (event handler) when switching connections?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p276062">
				<div class="post-metadata">
					<div class="post-num">Post #1267</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						12 May 2015, 13:48					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>5) You can see that even after the switch port towards ISP1 was brought up which should lead to a fully operational wan1, mwan3 detects a link fault and after more than 2 minutes restores the link again as it should.</p><p>Any ideas would be fairly helful.</p><p>BR, dir2cas</p></blockquote></div><p>As you altered the ping size in mwan3track, you should also change the lines 169, 170 and 174 in /etc/hotplug.d/iface/15-mwan3 file. You should set the length to (28 + #ping size). This is probably the reason that lines do not correctly fail back.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p276064">
				<div class="post-metadata">
					<div class="post-num">Post #1268</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						12 May 2015, 13:49					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>belliash wrote:</cite><blockquote><p>Is it possible to use mwan3 to configure 3G connection as a failover, but only for outgoing traffic coming from one specific host inside the network?</p></blockquote></div><p>Yes<br /></p><div class="quotebox"><cite>belliash wrote:</cite><blockquote><p>Can mwan3 execute some script (event handler) when switching connections?</p></blockquote></div><p>Yes, You can place your own scripts in /etc/hotplug.d/iface/</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p276075">
				<div class="post-metadata">
					<div class="post-num">Post #1269</div>
					<div class="post-author">dir2cas</div>
					<div class="post-datetime">
						12 May 2015, 15:48					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>5) You can see that even after the switch port towards ISP1 was brought up which should lead to a fully operational wan1, mwan3 detects a link fault and after more than 2 minutes restores the link again as it should.</p><p>Any ideas would be fairly helful.</p><p>BR, dir2cas</p></blockquote></div><p>As you altered the ping size in mwan3track, you should also change the lines 169, 170 and 174 in /etc/hotplug.d/iface/15-mwan3 file. You should set the length to (28 + #ping size). This is probably the reason that lines do not correctly fail back.</p></blockquote></div><p>Right.<br />I found it yesterday after performing the test. In fact the &quot;ping -s 8&quot; does the job (it produces normal ping request/reply). This corresponds to a packet length of 36 bytes.</p><p>In fact after this correction, I do not see drops on the operational wan2, but the wan1 tracking (that is interrupted) works correctly only for the wan1&#039;s gateway. The other target hosts do not get detected.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p276118">
				<div class="post-metadata">
					<div class="post-num">Post #1270</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						12 May 2015, 21:44					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>In fact after this correction, I do not see drops on the operational wan2, but the wan1 tracking (that is interrupted) works correctly only for the wan1&#039;s gateway. The other target hosts do not get detected.</p></blockquote></div><p>Can you confirm with tcpdump that the ping requests do leave the correct interface?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p276181">
				<div class="post-metadata">
					<div class="post-num">Post #1271</div>
					<div class="post-author">dir2cas</div>
					<div class="post-datetime">
						13 May 2015, 17:26					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>In fact after this correction, I do not see drops on the operational wan2, but the wan1 tracking (that is interrupted) works correctly only for the wan1&#039;s gateway. The other target hosts do not get detected.</p></blockquote></div><p>Can you confirm with tcpdump that the ping requests do leave the correct interface?</p></blockquote></div><p>All the tests done so far are pointing to the same problem.</p><p>Here is the latest one, that proves it. If you want tcpdump tests, I will have to check it doing some port mirroring on the switch, because this is e test router that has no tcpdump installed and has no free space because of the custom image that is full with different stiff. I hope that iftop is enough.</p><p>1) Switch port facing ISP1 (wan1) disabled<br /></p><div class="codebox"><pre><code>sw1#conf t
Enter configuration commands, one per line.  End with CNTL/Z.
sw1(config)#int fa 0/1
sw1(config-if)#shu
sw1(config-if)#shutdown
sw1(config-if)#
sw1(config-if)#^Z
sw1#sh int desc | i WAN
Fa0/1                          admin down     down     WAN1_/24Mbps/
Fa0/2                          up             up       WAN2_/45Mbps/</code></pre></div><p>2) Ping test using the same parameters like mwan3track (I restored the initial code). Here I used one of the host targets that is tracked only via wan1.<br />The purpose is that we would like the ping to be treated by mwan3 the same way as it is done by the real tracking tool (mwan3track). You can see that ping is successful, despite the wan1 link is interrupted.</p><div class="codebox"><pre><code>[root@RTR-TEST:~]# $(which ping) -c 5 -W 1 -s 4 -I eth0.2 212.73.140.119
PING 212.73.140.119 (212.73.140.119) from 46.40.125.XX eth0.2: 4(32) bytes of data.
12 bytes from 212.73.140.119: icmp_req=1 ttl=59
12 bytes from 212.73.140.119: icmp_req=2 ttl=59
12 bytes from 212.73.140.119: icmp_req=3 ttl=59
12 bytes from 212.73.140.119: icmp_req=4 ttl=59
12 bytes from 212.73.140.119: icmp_req=5 ttl=59

--- 212.73.140.119 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4005ms

[root@RTR-TEST:~]# $(which ping) -c 5 -W 1 -s 4 -I eth0.2 212.73.140.119
PING 212.73.140.119 (212.73.140.119) from 46.40.125.XX eth0.2: 4(32) bytes of data.
12 bytes from 212.73.140.119: icmp_req=1 ttl=59
12 bytes from 212.73.140.119: icmp_req=2 ttl=59
12 bytes from 212.73.140.119: icmp_req=3 ttl=59
12 bytes from 212.73.140.119: icmp_req=4 ttl=59
12 bytes from 212.73.140.119: icmp_req=5 ttl=59

--- 212.73.140.119 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4006ms</code></pre></div><div class="codebox"><pre><code>[root@RTR-TEST:~]# cat /etc/config/mwan3 | head -n 29

config interface &#039;wan1&#039;
        option enabled &#039;1&#039;
        list track_ip &#039;46.40.125.1&#039;
        list track_ip &#039;212.73.140.119&#039;
        list track_ip &#039;8.8.8.8&#039;
        list track_ip &#039;208.67.222.222&#039;
        list track_ip &#039;208.67.220.220&#039;
        option reliability &#039;3&#039;
        option count &#039;5&#039;
        option timeout &#039;2&#039;
        option interval &#039;20&#039;
        option down &#039;1&#039;
        option up &#039;3&#039;

config interface &#039;wan2&#039;
        option enabled &#039;1&#039;
        list track_ip &#039;46.249.80.1&#039;
        list track_ip &#039;87.120.130.66&#039;
        list track_ip &#039;8.8.8.8&#039;
        list track_ip &#039;208.67.222.222&#039;
        list track_ip &#039;208.67.220.220&#039;
        option reliability &#039;3&#039;
        option count &#039;5&#039;
        option timeout &#039;2&#039;
        option interval &#039;20&#039;
        option down &#039;1&#039;
        option up &#039;3&#039;</code></pre></div><p>3) Iftop verifies that no traffic is passing via wan1(eth0.2) / ISP1 link, which should be correct<br /></p><div class="codebox"><pre><code>[root@RTR-TEST:~]# iftop -n -P -f &quot;icmp&quot; -i eth0.2

                           12.5kb                      25.0kb                     37.5kb                      50.0kb                62.5kb
└──────────────────────────┴───────────────────────────┴──────────────────────────┴───────────────────────────┴───────────────────────────</code></pre></div><p>4) However the ping towards 212.73.140.119 is seen on wan2 (eth0.3). As seen above 212.73.140.119 is not part of the wan2 target hosts eligible for tracking.<br /></p><div class="codebox"><pre><code>[root@RTR-TEST:~]# iftop -n -P -f &quot;icmp&quot; -i eth0.3

                           12.5kb                      25.0kb                     37.5kb                      50.0kb                62.5kb
└──────────────────────────┴───────────────────────────┴──────────────────────────┴───────────────────────────┴───────────────────────────
46.249.80.XX                                            =&gt; 212.73.140.119                                           384b    256b    185b
                                                        &lt;=                                                          384b    256b    185b
46.249.80.XX                                            =&gt; 8.8.8.8                                                    0b    128b     71b
                                                        &lt;=                                                            0b    128b     71b
46.249.80.XX                                            =&gt; 192.58.128.30                                              0b    115b     64b
                                                        &lt;=                                                            0b    115b     64b
46.249.80.XX                                            =&gt; 208.67.222.222                                             0b    102b     71b
                                                        &lt;=                                                            0b    102b     57b</code></pre></div><p>5) The log - mwan3 detects the fault only towards wan1&#039;s gateway, but not to the other trackable targets.<br /></p><div class="codebox"><pre><code>May 13 11:37:46 sw1 2066: May 13 11:37:45 EEST: %LINK-5-CHANGED: Interface FastEthernet0/1, changed state to administratively down
May 13 11:37:46 sw1 2067: May 13 11:37:46 EEST: %LINEPROTO-5-UPDOWN: Line protocol on Interface FastEthernet0/1, changed state to down
May 13 11:37:46 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 60% packet loss
May 13 11:38:31 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 13 11:39:14 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 13 11:39:56 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 13 11:40:42 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 13 11:41:25 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 13 11:41:31 sw1 2068: May 13 11:41:30 EEST: %SYS-5-CONFIG_I: Configured from console by dir2cas on vty0 (10.0.20.200)
May 13 11:42:05 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 13 11:42:48 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 13 11:43:33 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 13 11:44:18 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 13 11:44:59 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 13 11:45:42 RTR-TEST mwan3track: Tracked host issue detected on Interface wan1 (eth0.2): 46.40.125.1 -&gt; 100% packet loss
May 13 11:45:44 sw1 2069: May 13 11:45:43 EEST: %SYS-5-CONFIG_I: Configured from console by dir2cas on vty0 (10.0.20.200)
May 13 11:45:46 sw1 2070: May 13 11:45:45 EEST: %LINK-3-UPDOWN: Interface FastEthernet0/1, changed state to up
May 13 11:45:46 sw1 2071: May 13 11:45:46 EEST: %LINEPROTO-5-UPDOWN: Line protocol on Interface FastEthernet0/1, changed state to up</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p276253">
				<div class="post-metadata">
					<div class="post-num">Post #1272</div>
					<div class="post-author">kubco2</div>
					<div class="post-datetime">
						14 May 2015, 10:09					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>thank you for mwan3, it works fine for me.</p><p>I need help. I want run openvpn client seamlessly with &quot;float&quot; option on server, but mwan3 keeps old session on offline interface, so ovpn client firstly do timeout-restart(a lot of seconds) and then reconnect instead hop to another IP.</p><p>Am I able to force to use preferred interface by rule?</p><p>Thanks for help.</p>											<p class="post-edited">(Last edited by <strong>kubco2</strong> on 14 May 2015, 10:41)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p276453">
				<div class="post-metadata">
					<div class="post-num">Post #1273</div>
					<div class="post-author">PrivateTraveler</div>
					<div class="post-datetime">
						16 May 2015, 07:15					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>I apologize for a newbie question, but here it goes:&nbsp; I have a TPLink MR3020 with Barrier Breaker installed and I&#039;m using it to secure my network connection while I travel/visit public hotspots (think Starbucks, coworking spaces, airports, hotels, etc).&nbsp; The device has one wireless radio, an ethernet port and a USB port, which currently hosts a thumb drive mounted as /boot.&nbsp; </p><p>The LAN connection and wwan are both clients and can connect to an external network.&nbsp; The wifi is split into the wwan client and a lan station that broadcasts its own wifi network, dhcp, etc.&nbsp; I basically followed this tutorial - <a href="https://www.loganmarchione.com/2015/02/openwrt-with-openvpn-client-on-tp-link-tl-mr3020-3/">https://www.loganmarchione.com/2015/02/ … -mr3020-3/</a> to configure the box, including the openvpn connection.</p><p>When I change /etc/config/wireless to include more than one client entry, the box hangs, and I am unable to boot or connect.&nbsp; As soon as I comment out all but one client configurations, it works fine. </p><p>I&#039;m hoping to be able to set up mwan3 to support multiple configurations.&nbsp; That way, if I&#039;m in a hotel, I can connect, and I can move to Starbucks or an airport lounge (or my office) without having to drop into failsafe to make the access point config change.&nbsp; Bridging multiple connections (e.g. Starbucks and xfinitywifi) would be awesome, but that&#039;s an even more specialized case...</p><p>Can you assist?&nbsp; Do I need a second wifi adapter to support this?&nbsp; </p><p>Thank you for your help.</p>											<p class="post-edited">(Last edited by <strong>PrivateTraveler</strong> on 16 May 2015, 07:16)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p276597">
				<div class="post-metadata">
					<div class="post-num">Post #1274</div>
					<div class="post-author">dinman</div>
					<div class="post-datetime">
						18 May 2015, 00:59					</div>
				</div>
				<div class="post-content content">
					<p>Hello,<br />I am using mwan3 v1.6-1 and luci-app-mwan3 v1.4-2.<br />I have 6 WAN everything is working fine for few hours and then most of the WAN are going OFFLINE&nbsp; &quot;tracking down&quot;.</p><p>ping -I eth0.30 google.fr are correctly responding.<br />Here is my configuration :</p><br /><div class="codebox"><pre><code>~# cat /etc/config/mwan3 

config rule &#039;wan1_network&#039;
        option proto &#039;all&#039;
        option sticky &#039;0&#039;
        option use_policy &#039;wan1_only&#039;
        option dest_ip &#039;192.168.1.0/24&#039;

config rule &#039;wan2_network&#039;
        option proto &#039;all&#039;
        option sticky &#039;0&#039;
        option use_policy &#039;wan2_only&#039;
        option dest_ip &#039;192.168.2.0/24&#039;

config rule &#039;youtube&#039;
        option sticky &#039;1&#039;
        option dest_port &#039;80,443&#039;
        option proto &#039;tcp&#039;
        option use_policy &#039;balanced&#039;

config rule &#039;https&#039;
        option sticky &#039;1&#039;
        option dest_port &#039;443&#039;
        option proto &#039;tcp&#039;
        option use_policy &#039;balanced&#039;

config rule &#039;default_rule&#039;
        option dest_ip &#039;0.0.0.0/0&#039;
        option use_policy &#039;balanced&#039;

config member &#039;wan1&#039;
        option interface &#039;WAN1&#039;
        option weight &#039;8&#039;
        option metric &#039;1&#039;

config member &#039;wan2&#039;
        option interface &#039;WAN2&#039;
        option weight &#039;8&#039;
        option metric &#039;1&#039;

config member &#039;wan3&#039;
        option interface &#039;WAN3&#039;
        option weight &#039;8&#039;
        option metric &#039;1&#039;

config member &#039;wan4&#039;
        option interface &#039;WAN4&#039;
        option weight &#039;8&#039;
        option metric &#039;1&#039;

config member &#039;wan5&#039;
        option interface &#039;WAN5&#039;
        option weight &#039;8&#039;
        option metric &#039;1&#039;

config member &#039;wan6&#039;
        option interface &#039;WAN6&#039;
        option weight &#039;8&#039;
        option metric &#039;1&#039;

config policy &#039;balanced&#039;
        option last_resort &#039;unreachable&#039;
        list use_member &#039;wan1&#039;
        list use_member &#039;wan2&#039;
        list use_member &#039;wan3&#039;
        list use_member &#039;wan4&#039;
        list use_member &#039;wan5&#039;
        list use_member &#039;wan6&#039;
config interface &#039;WAN1&#039;
        option enabled &#039;1&#039;
        list track_ip &#039;8.8.8.8&#039;
        option reliability &#039;1&#039;
        option count &#039;1&#039;
        option timeout &#039;2&#039;
        option interval &#039;5&#039;
        option down &#039;3&#039;
        option up &#039;3&#039;

config interface &#039;WAN2&#039;
        option enabled &#039;1&#039;
        list track_ip &#039;8.8.4.4&#039;
        option reliability &#039;1&#039;
        option count &#039;1&#039;
        option timeout &#039;2&#039;
        option interval &#039;5&#039;
        option down &#039;3&#039;
        option up &#039;3&#039;

config interface &#039;WAN3&#039;
        option enabled &#039;1&#039;
        list track_ip &#039;176.31.81.4&#039;
        option reliability &#039;1&#039;
        option count &#039;1&#039;
        option timeout &#039;2&#039;
        option interval &#039;5&#039;
        option down &#039;3&#039;
        option up &#039;3&#039;

config interface &#039;WAN4&#039;
        option enabled &#039;1&#039;
        list track_ip &#039;176.31.81.4&#039;
        option reliability &#039;1&#039;
        option count &#039;1&#039;
        option timeout &#039;2&#039;
        option interval &#039;5&#039;
        option down &#039;3&#039;
        option up &#039;3&#039;

config interface &#039;WAN5&#039;
        option enabled &#039;1&#039;
        list track_ip &#039;176.31.81.4&#039;
        option reliability &#039;1&#039;
        option count &#039;1&#039;
        option timeout &#039;2&#039;
        option interval &#039;5&#039;
        option down &#039;3&#039;
        option up &#039;3&#039;

config interface &#039;WAN6&#039;
        option enabled &#039;1&#039;
        list track_ip &#039;8.8.8.8&#039;
        option reliability &#039;1&#039;
        option count &#039;1&#039;
        option timeout &#039;2&#039;
        option interval &#039;5&#039;
        option down &#039;3&#039;
        option up &#039;3&#039;
config policy &#039;wan2_only&#039;
        list use_member &#039;wan2&#039;
        option last_resort &#039;unreachable&#039;

config policy &#039;wan1_only&#039;
        list use_member &#039;wan1&#039;
        option last_resort &#039;unreachable&#039;</code></pre></div><br /><p> I must restart mwan3 to get the WAN back to ONLINE.</p><p>How to resolv the probeme ?<br />Thanks for your help.</p>											<p class="post-edited">(Last edited by <strong>dinman</strong> on 18 May 2015, 01:13)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p276628">
				<div class="post-metadata">
					<div class="post-num">Post #1275</div>
					<div class="post-author">paramobilus</div>
					<div class="post-datetime">
						18 May 2015, 10:39					</div>
				</div>
				<div class="post-content content">
					<p>Hello!</p><p>I don&#039;t know where it&#039;s better to write, so I write here.<br />I try to use mwan3 with dynamic routing protocols (ospf with bird) and encountered a strange behavior.<br />Bird gets route to network (10.18.10.0/24) from the remote router, and adds it to the current kernel routing table. However, traffic to the announced network continues to go through the default route via eth0.101. I can see it if I run traceroute or tcpdump. </p><div class="codebox"><pre><code>root@izh-pk-h1:~# ip route ls
default via 172.24.40.1 dev eth0.101  proto static  metric 10 
default via 217.14.207.25 dev pppoe-isp2  proto static  metric 20 
10.18.8.0/24 dev br-lan  proto kernel  scope link  src 10.18.8.1 
10.18.10.0/24 via 172.16.18.2 dev tun_h2  proto bird 
172.16.18.2 dev tun_h2  proto kernel  scope link  src 172.16.18.1 
.......

root@izh-pk-h1:~# traceroute 10.18.10.1
traceroute to 10.18.10.1 (10.18.10.1), 30 hops max, 38 byte packets
 1  172.24.40.1 (172.24.40.1)  0.552 ms  0.643 ms  0.548 ms
 2  *  *  *
 3  *  *  *

root@izh-pk-h1:~# netstat -rn
Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
0.0.0.0         172.24.40.1     0.0.0.0         UG        0 0          0 eth0.101
0.0.0.0         217.14.207.25   0.0.0.0         UG        0 0          0 pppoe-isp2
10.18.8.0       0.0.0.0         255.255.255.0   U         0 0          0 br-lan
10.18.10.0      172.16.18.2     255.255.255.0   UG        0 0          0 tun_h2
172.16.18.2     0.0.0.0         255.255.255.255 UH        0 0          0 tun_h2
.....</code></pre></div><p>Also, if I add a static route manually via “route add -net ...”, he also does not apply &quot;on the fly&quot;. This continues for as long as I&#039;m not reloading firewall. As soon as I restart firewall, traffic starts to go on the desired route, as expected. This behavior does not occur if mwan3 not installed and used by a single connection to the ISP. Please help to understand where I should look for a solution: in mwan3, in bird4, or in an openwrt routing in general.</p><p>p.s. Openwrt 14.07, mwan3 - 1.5-10, bird4 - 1.4.3-1</p>											<p class="post-edited">(Last edited by <strong>paramobilus</strong> on 18 May 2015, 10:46)</p>
									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 51 of 65</div><nav><ul><li><a href="viewtopic.php%3Fid=39052&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=49.html">49</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=50.html">50</a></li><li class="pagination-current"><span>51</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=52.html">52</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=53.html">53</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0.001 -->

</body>
</html>