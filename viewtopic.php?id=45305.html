<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> extroot not working in r37374</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 21 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p207384">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">kurczaq</div>
					<div class="post-datetime">
						17 Jul 2013, 18:07					</div>
				</div>
				<div class="post-content content">
					<p>I installed latest snapshot&nbsp; BARRIER BREAKER (Bleeding Edge, r37374) on TL-MR3220v2, but cannot get extroot working. Strictly followed the section for &quot;trunk&quot; in:</p><p><a href="http://wiki.openwrt.org/doc/howto/extroot#openwrt.barrier.breaker.trunk">http://wiki.openwrt.org/doc/howto/extro … aker.trunk</a></p><p>here what I get:</p><p>----------------------------------------------</p><p>cat /etc/config/fstab <br />config &#039;global&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; anon_swap&nbsp; &nbsp; &nbsp; &nbsp;&#039;0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; anon_mount&nbsp; &nbsp; &nbsp; &#039;0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; auto_swap&nbsp; &nbsp; &nbsp; &nbsp;&#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; auto_mount&nbsp; &nbsp; &nbsp; &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; delay_root&nbsp; &nbsp; &nbsp; &#039;0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; check_fs&nbsp; &nbsp; &nbsp; &nbsp; &#039;0&#039;</p><p>config &#039;mount&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; target&nbsp; &#039;/&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; uuid&nbsp; &nbsp; &#039;03c8f96c-2442-4d20-829a-291d3c8af67c&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; enabled &#039;1&#039;</p><p>config &#039;swap&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; uuid&nbsp; &nbsp; &#039;79c753a0-a066-49b1-a386-ec7121409912&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; enabled &#039;1&#039;</p><p>----------------------------------------------</p><p>block detect<br />config &#039;global&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; anon_swap&nbsp; &nbsp; &nbsp; &nbsp;&#039;0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; anon_mount&nbsp; &nbsp; &nbsp; &#039;0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; auto_swap&nbsp; &nbsp; &nbsp; &nbsp;&#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; auto_mount&nbsp; &nbsp; &nbsp; &#039;1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; delay_root&nbsp; &nbsp; &nbsp; &#039;0&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; check_fs&nbsp; &nbsp; &nbsp; &nbsp; &#039;0&#039;</p><p>config &#039;mount&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; target&nbsp; &#039;/mnt/sda1&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; uuid&nbsp; &nbsp; &#039;03c8f96c-2442-4d20-829a-291d3c8af67c&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; enabled &#039;0&#039;</p><p>config &#039;swap&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; uuid&nbsp; &nbsp; &#039;79c753a0-a066-49b1-a386-ec7121409912&#039;<br />&nbsp; &nbsp; &nbsp; &nbsp; option&nbsp; enabled &#039;0&#039;</p><p>----------------------------------------------<br />df<br />Filesystem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1K-blocks&nbsp; &nbsp; &nbsp; Used Available Use% Mounted on<br />rootfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1088&nbsp; &nbsp; &nbsp; &nbsp;968&nbsp; &nbsp; &nbsp; &nbsp;120&nbsp; 89% /<br />/dev/root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1792&nbsp; &nbsp; &nbsp; 1792&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 100% /rom<br />tmpfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 14464&nbsp; &nbsp; &nbsp; &nbsp; 52&nbsp; &nbsp; &nbsp;14412&nbsp; &nbsp;0% /tmp<br />/dev/mtdblock3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1088&nbsp; &nbsp; &nbsp; &nbsp;968&nbsp; &nbsp; &nbsp; &nbsp;120&nbsp; 89% /overlay<br />overlayfs:/overlay&nbsp; &nbsp; &nbsp; &nbsp; 1088&nbsp; &nbsp; &nbsp; &nbsp;968&nbsp; &nbsp; &nbsp; &nbsp;120&nbsp; 89% /<br />tmpfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 512&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp;512&nbsp; &nbsp;0% /dev</p><p>----------------------------------------------<br />free<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;total&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;used&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;free&nbsp; &nbsp; &nbsp; &nbsp;shared&nbsp; &nbsp; &nbsp; buffers<br />Mem:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;28932&nbsp; &nbsp; &nbsp; &nbsp; 18932&nbsp; &nbsp; &nbsp; &nbsp; 10000&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1592<br />-/+ buffers:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 17340&nbsp; &nbsp; &nbsp; &nbsp; 11592<br />Swap:&nbsp; &nbsp; &nbsp; &nbsp; 65532&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 65532</p><p>----------------------------------------------</p><p>If I modify target for &#039;mount&#039; to be /mnt instead of /, it mounts the sda1 partition in /mnt (as ext4) after each reboot. For some strange reason target / does not work. The swap partition gets mounted without trouble. No output in dmsg <img src="https://forum.openwrt.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /></p><p>any idea how to resolve it?</p>											<p class="post-edited">(Last edited by <strong>kurczaq</strong> on 17 Jul 2013, 18:37)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p207386">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">kurczaq</div>
					<div class="post-datetime">
						17 Jul 2013, 18:41					</div>
				</div>
				<div class="post-content content">
					<div class="codebox"><pre><code>root@OpenWrt:~# df
Filesystem           1K-blocks      Used Available Use% Mounted on
rootfs                    1088       972       116  89% /
/dev/root                 1792      1792         0 100% /rom
tmpfs                    14464        52     14412   0% /tmp
/dev/mtdblock3            1088       972       116  89% /overlay
overlayfs:/overlay        1088       972       116  89% /
tmpfs                      512         0       512   0% /dev
/dev/sda1              7242816     25084   6826772   0% /mnt</code></pre></div><p>I&#039;m getting this with target &quot;/mnt&quot; - mounts without trouble. No error message in dmesg:</p><p>[&nbsp; &nbsp;16.530000] EXT4-fs (sda1): mounted filesystem with ordered data mode. Opts: <br />[&nbsp; &nbsp;16.670000] Adding 65532k swap on /dev/sda2.&nbsp; Priority:-1 extents:1 across:65532k </p><p>but why the heck I cannot use it for extroot with target &#039;/&#039; ????</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p207387">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">kurczaq</div>
					<div class="post-datetime">
						17 Jul 2013, 18:53					</div>
				</div>
				<div class="post-content content">
					<div class="codebox"><pre><code>root@OpenWrt:/mnt# pivot_root . mnt
root@OpenWrt:/# df
Filesystem           1K-blocks      Used Available Use% Mounted on
df: /proc/mounts: No such file or directory
root@OpenWrt:/# mount
mount: no /proc/mounts</code></pre></div><p>so pivot_root is working, however something is screwed during boot, right? How can I fix it?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p207388">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">DarkStarXxX</div>
					<div class="post-datetime">
						17 Jul 2013, 18:53					</div>
				</div>
				<div class="post-content content">
					<p>Router Model is ar71xx based?</p><p>Take a look here : <a href="https://forum.openwrt.org/viewtopic.php?id=44939">https://forum.openwrt.org/viewtopic.php?id=44939</a></p><p><a href="https://dev.openwrt.org/ticket/13763">https://dev.openwrt.org/ticket/13763</a></p><p>Seems that extroot is broken on most based ar71xx Routers.</p><p>I wish we could get back the old Block-Mount (that worked for over 2 Years perfect here).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p207390">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">kurczaq</div>
					<div class="post-datetime">
						17 Jul 2013, 19:04					</div>
				</div>
				<div class="post-content content">
					<p>I followed <a href="http://wiki.openwrt.org/doc/howto/extroot#openwrt.barrier.breaker.trunk">http://wiki.openwrt.org/doc/howto/extro … aker.trunk</a></p><p>but no success...</p><p>it seems to have problems to mount &amp; pivot the root file system, when target is &#039;/&#039;. Maybe we can do it with a script manually?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p207393">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">kurczaq</div>
					<div class="post-datetime">
						17 Jul 2013, 19:52					</div>
				</div>
				<div class="post-content content">
					<p>the &#039;block&#039; cmd has some hidden options (not shown with block -h):</p><p>block extroot<br />block hotplug</p><p>so I assume that in the startup scripts for AR71xx there is a missing call for that?</p><p>just &#039;block mount&#039; will not mount an extroot FS, I looked into the source code of ubox:</p><div class="codebox"><pre><code>        if (!strcmp(argv[1], &quot;mount&quot;))
            return main_mount(argc, argv);</code></pre></div><p>that one goes into</p><div class="codebox"><pre><code>static int mount_device(struct blkid_struct_probe *pr, int hotplug)
{
    struct mount *m;
    char *device = basename(pr-&gt;dev);

    if (!pr)
        return -1;

    if (!strcmp(pr-&gt;id-&gt;name, &quot;swap&quot;)) {
        if (hotplug &amp;&amp; !auto_swap)
            return -1;
        m = find_swap(pr-&gt;uuid, device);
        if (m || anon_swap)
            swapon(pr-&gt;dev, (m) ? (m-&gt;prio) : (0));

        return 0;
    }

    if (hotplug &amp;&amp; !auto_mount)
        return -1;

    if (find_mount_point(pr-&gt;dev)) {
        fprintf(stderr, &quot;%s is already mounted\n&quot;, pr-&gt;dev);
        return -1;
    }

    m = find_block(pr-&gt;uuid, pr-&gt;label, device, NULL);
    if (m &amp;&amp; m-&gt;extroot)
        return -1;</code></pre></div><p>so no / or /overlay targets can ever be mounted with &#039;block mount&#039; - instead &#039;block extroot&#039; must be used. IMO.</p><p>can someone check that this call is done on startup on AR71xx? I have no clue where to look.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p208142">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">makakasirapuka</div>
					<div class="post-datetime">
						26 Jul 2013, 12:35					</div>
				</div>
				<div class="post-content content">
					<p>any updates? I created two partitions: a swap and an ext2 on my usb flash drive. Interestingly to note, my swap partition seems to be mounted okay. However the overlayed ext2 doesn&#039;t seem to nount. no obvious errors tho..</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p208146">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						26 Jul 2013, 12:50					</div>
				</div>
				<div class="post-content content">
					<p><a href="https://forum.openwrt.org/viewtopic.php?pid=208144#p208144">https://forum.openwrt.org/viewtopic.php … 44#p208144</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p208168">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">makakasirapuka</div>
					<div class="post-datetime">
						26 Jul 2013, 15:59					</div>
				</div>
				<div class="post-content content">
					<p>jow, just sent you credentials to log via ssh. probably, no need anymore? <br />I&#039;d just have to flash the latest version of trunk (what does the term &#039;trunk&#039; mean btw?)<br />funny, the ubox was &#039;younger&#039;, but the problem persists: <br />opkg list_installed ubox<br />ubox - 2013-07-24-f3a6e775a1e52ea6f85a145d60a88b3f6356a96c</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p208169">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						26 Jul 2013, 16:02					</div>
				</div>
				<div class="post-content content">
					<p>Your ubox is too old.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p208170">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">makakasirapuka</div>
					<div class="post-datetime">
						26 Jul 2013, 16:13					</div>
				</div>
				<div class="post-content content">
					<p>so have you worked out the fix? is there a&nbsp; compiled firmware for mr-3020, or should I build it from scratch?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p208171">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						26 Jul 2013, 16:14					</div>
				</div>
				<div class="post-content content">
					<p>Yes and the fix was committed ~4hours ago, so either build yourself or wait until the snapshot binaries are rebuilt in 24-48 hours.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p208172">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">makakasirapuka</div>
					<div class="post-datetime">
						26 Jul 2013, 16:22					</div>
				</div>
				<div class="post-content content">
					<p>okay, thank you! <br />The latest build is dated 25-Jul-2013 01:45&nbsp; (I&#039;m looking at <a href="http://downloads.openwrt.org/snapshots/trunk/ar71xx/)">http://downloads.openwrt.org/snapshots/trunk/ar71xx/)</a><br />so, when the date changes I can just upgrade the firmware and it should be working?<br />thanks!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p208176">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">kurczaq</div>
					<div class="post-datetime">
						26 Jul 2013, 16:55					</div>
				</div>
				<div class="post-content content">
					<p>@jow thanks for fixing!</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>