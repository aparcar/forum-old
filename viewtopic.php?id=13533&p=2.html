<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Port forwarding stops working after a while</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 4 Mar 2018 and 18 Apr 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 2 of 6</div><nav><ul><li><a href="viewtopic.php%3Fid=13533&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=13533&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=13533&amp;p=4.html">4</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=13533&amp;p=6.html">6</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p63404">
				<div class="post-metadata">
					<div class="post-num">Post #26</div>
					<div class="post-author">Tex-Twil</div>
					<div class="post-datetime">
						14 Feb 2008, 17:34					</div>
				</div>
				<div class="post-content content">
					<p>Hello,<br/>I have also the 500gp and I have the same problem ... I&#039;m right now compiling the dev version to see if it will solve the problem.</p><p>Since I would also like to open the ssh access to my openwrt from the internet, I uncommented the following lines in the/etc/firewall.user file:</p><div class="codebox"><pre><code>iptables -t nat -A prerouting_wan -p tcp --dport 22 -j ACCEPT
iptables        -A input_wan      -p tcp --dport 22 -j ACCEPT</code></pre></div><p>But this has also no effect. Can you confirm this ?</p><br/><p>Edit: I tried this trick to forward a port as shown here <a href="https://dev.openwrt.org/ticket/2558">https://dev.openwrt.org/ticket/2558</a><br/></p><div class="codebox"><pre><code>iptables -t nat -A prerouting_wan -p tcp --dport 4800 -j DNAT --to 192.168.1.10
iptables          -A forwarding_wan -p tcp --dport 4800 -d 192.168.1.10 -j ACCEPT</code></pre></div><p>I of course adapted it to my network but this also doesn&#039;t work !</p><p>Regards,<br/>Tex</p>											<p class="post-edited">(Last edited by <strong>Tex-Twil</strong> on 14 Feb 2008, 17:53)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p63449">
				<div class="post-metadata">
					<div class="post-num">Post #27</div>
					<div class="post-author">Tex-Twil</div>
					<div class="post-datetime">
						15 Feb 2008, 10:45					</div>
				</div>
				<div class="post-content content">
					<p>Hello,<br/>this is getting me crazy. I really can get the ports open on the internet even if this workaround is supposed to work : <a href="https://dev.openwrt.org/ticket/2558">https://dev.openwrt.org/ticket/2558</a>&nbsp; !! Could someone help me to find out what am I doing wrong ?</p><p>This issue makes my router totally useless <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad"/></p><p>edit: Switching back to White Russian sovled my problems <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink"/></p><p>Thanks,<br/>Tex</p>											<p class="post-edited">(Last edited by <strong>Tex-Twil</strong> on 17 Feb 2008, 14:48)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p63571">
				<div class="post-metadata">
					<div class="post-num">Post #28</div>
					<div class="post-author">freeman</div>
					<div class="post-datetime">
						17 Feb 2008, 15:28					</div>
				</div>
				<div class="post-content content">
					<p>Anybody knows, is it fixed development version from git?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p63832">
				<div class="post-metadata">
					<div class="post-num">Post #29</div>
					<div class="post-author">Tex-Twil</div>
					<div class="post-datetime">
						21 Feb 2008, 18:30					</div>
				</div>
				<div class="post-content content">
					<p>Eug asked me by email this question:<br/></p><div class="quotebox"><blockquote><p>Which White Russian version did you switch to (to solve the iptables problem)?</p></blockquote></div><p>I use the lastest stable version :<br/></p><div class="codebox"><pre><code>$ cat /etc/banner
  _______                     ________        __
 |       |.-----.-----.-----.|  |  |  |.----.|  |_
 |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|
 |_______||   __|_____|__|__||________||__|  |____|
          |__| W I R E L E S S   F R E E D O M
 WHITE RUSSIAN (0.9) -------------------------------
  * 2 oz Vodka   Mix the Vodka and Kahlua together
  * 1 oz Kahlua  over ice, then float the cream or
  * 1/2oz cream  milk on the top.
 ---------------------------------------------------</code></pre></div><p>cheeers.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p64589">
				<div class="post-metadata">
					<div class="post-num">Post #30</div>
					<div class="post-author">mpeterson</div>
					<div class="post-datetime">
						4 Mar 2008, 23:36					</div>
				</div>
				<div class="post-content content">
					<p>Any news on this issue? I think it should be a priority fix.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p65423">
				<div class="post-metadata">
					<div class="post-num">Post #31</div>
					<div class="post-author">sumpfralle</div>
					<div class="post-datetime">
						20 Mar 2008, 06:13					</div>
				</div>
				<div class="post-content content">
					<p>switching to Kamikaze 7.09 with kernel 2.6 (instead of 2.4) fixes this issue for me (linksys wrt54).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p69333">
				<div class="post-metadata">
					<div class="post-num">Post #32</div>
					<div class="post-author">kaldek</div>
					<div class="post-datetime">
						9 Jun 2008, 03:10					</div>
				</div>
				<div class="post-content content">
					<p>Folks,</p><p>I&#039;m testing this problem on Kamikaze 7.09 (2.4 kernel).&nbsp; After some effort to remove the variables, it appears that it is QoS-scripts causing the fault.&nbsp; I&#039;m yet to say this with certainty though, but I should know within a few days.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p69335">
				<div class="post-metadata">
					<div class="post-num">Post #33</div>
					<div class="post-author">netprince</div>
					<div class="post-datetime">
						9 Jun 2008, 03:41					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m in the process of testing this as well.&nbsp; I haven&#039;t tested removing QOS.&nbsp; I&#039;m currently testing a patch I made to remove certain netfilter extensions from kamikaze 2.4.&nbsp; We can cover more ground by updating this thread, I&#039;ll report back as well...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p69336">
				<div class="post-metadata">
					<div class="post-num">Post #34</div>
					<div class="post-author">placebo</div>
					<div class="post-datetime">
						9 Jun 2008, 06:19					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>kaldek wrote:</cite><blockquote><p>I&#039;m testing this problem on Kamikaze 7.09 (2.4 kernel).&nbsp; After some effort to remove the variables, it appears that it is QoS-scripts causing the fault.&nbsp; I&#039;m yet to say this with certainty though, but I should know within a few days.</p></blockquote></div><p>I doubt it&#039;s the QoS scripts. I don&#039;t use them, and I&#039;ve had this problem as well.</p>											<p class="post-edited">(Last edited by <strong>placebo</strong> on 9 Jun 2008, 06:19)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p69343">
				<div class="post-metadata">
					<div class="post-num">Post #35</div>
					<div class="post-author">kaldek</div>
					<div class="post-datetime">
						9 Jun 2008, 11:03					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>placebo wrote:</cite><blockquote><p>]I doubt it&#039;s the QoS scripts. I don&#039;t use them, and I&#039;ve had this problem as well.</p></blockquote></div><p>Hmm, interesting.&nbsp; Are you sure you have absolutely no queuing configured, even though qos-scripts isn&#039;t being used?</p><p>I was running PacketProtector 2.5 (based off Kamikaze 7.09) and the problem never occurred, however Qos-scripts was broken.&nbsp; I moved back to Kamikaze to get QoS functionality back and that is when the problem started for me.&nbsp; &nbsp;I&#039;ve since disabled QoS and the problem has not occurred again in four days, even with some hefty downloads.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p69472">
				<div class="post-metadata">
					<div class="post-num">Post #36</div>
					<div class="post-author">netprince</div>
					<div class="post-datetime">
						12 Jun 2008, 01:00					</div>
				</div>
				<div class="post-content content">
					<p>I have a test router which is showing promise, 15 days with correct port forwarding.&nbsp; I have removed all of the netfilter modules I&#039;m not using.&nbsp; Perhaps someone else would like to test what I have done...</p><p>I compiled kamikaze 2.4 with the following netfilter modules removed:</p><div class="codebox"><pre><code>  rm target/linux/generic-2.4/patches/603-netfilter_nat_pptp.patch
  rm target/linux/generic-2.4/patches/606-netfilter_NETMAP.patch
  rm target/linux/generic-2.4/patches/608-netfilter_ipset.patch
  rm target/linux/generic-2.4/patches/609-netfilter_string.patch
  rm target/linux/generic-2.4/patches/611-netfilter_condition.patch
  rm target/linux/generic-2.4/patches/612-netfilter_quota.patch
  rm target/linux/generic-2.4/patches/613-netfilter_nat_h323.patch
  rm target/linux/generic-2.4/patches/614-netfilter_nat_rtsp.patch
  rm target/linux/generic-2.4/patches/615-netfilter_nat_mms.patch
  rm target/linux/generic-2.4/patches/617-netfilter_time.patch
  rm target/linux/generic-2.4/patches/620-netfilter_iprange.patch
  rm target/linux/generic-2.4/patches/621-netfilter_random.patch
  rm target/linux/generic-2.4/patches/622-netfilter_ipset_porthash.patch
  rm target/linux/generic-2.4/patches/623-netfilter_ip6t_reject.patch</code></pre></div><p>Now, after removing those files, it takes a bit of work to get things compiling again.&nbsp; I have some patches, but they might not apply cleanly for you.&nbsp; &nbsp;You might have to work these out by hand...</p><br/><div class="codebox"><pre><code>diff -urN package.old/kernel/modules/netfilter.mk package/kernel/modules/netfilter.mk
--- package.old/kernel/modules/netfilter.mk    2008-05-19 14:55:29.000000000 -0400
+++ package/kernel/modules/netfilter.mk    2008-05-19 14:56:18.000000000 -0400
@@ -206,6 +206,7 @@
 define KernelPackage/ipt-iprange
   SUBMENU:=$(NF_MENU)
   TITLE:=Module for matching ip ranges
+  DEPENDS:=@LINUX_2_6
   FILES:=$(foreach mod,$(IPT_IPRANGE-m),$(LINUX_DIR)/net/$(mod).$(LINUX_KMOD_SUFFIX))
   AUTOLOAD:=$(call AutoLoad,40,$(notdir $(IPT_IPRANGE-m)))
 endef
@@ -221,6 +222,7 @@
   SUBMENU:=$(NF_MENU)
   TITLE:=IPSET Modules
   KCONFIG:=$(KCONFIG_IPT_IPSET)
+  DEPENDS:=@LINUX_2_6
   FILES:=$(foreach mod,$(IPT_IPSET-m),$(LINUX_DIR)/net/$(mod).$(LINUX_KMOD_SUFFIX))
   AUTOLOAD:=$(call AutoLoad,40,$(notdir $(IPT_IPSET-m)))
 endef

diff -urN target.old/linux/generic-2.4/patches/610-netfilter_connbytes.patch target/linux/generic-2.4/patches/610-netfilter_connbytes.patch
--- target.old/linux/generic-2.4/patches/610-netfilter_connbytes.patch    2008-05-19 14:40:13.000000000 -0400
+++ target/linux/generic-2.4/patches/610-netfilter_connbytes.patch    2008-05-19 14:52:05.000000000 -0400
@@ -1,16 +1,3 @@
-Index: linux-2.4.35.4/net/ipv4/netfilter/Config.in
-===================================================================
---- linux-2.4.35.4.orig/net/ipv4/netfilter/Config.in
-+++ linux-2.4.35.4/net/ipv4/netfilter/Config.in
-@@ -11,6 +11,8 @@ if [ &quot;$CONFIG_IP_NF_CONNTRACK&quot; != &quot;n&quot; ];
-   dep_tristate &#039;  Amanda protocol support&#039; CONFIG_IP_NF_AMANDA $CONFIG_IP_NF_CONNTRACK
-   dep_tristate &#039;  TFTP protocol support&#039; CONFIG_IP_NF_TFTP $CONFIG_IP_NF_CONNTRACK
-   dep_tristate &#039;  IRC protocol support&#039; CONFIG_IP_NF_IRC $CONFIG_IP_NF_CONNTRACK
-+  dep_tristate &#039;  Connection tracking flow accounting&#039; CONFIG_IP_NF_CT_ACCT $CONFIG_IP_NF_CONNTRACK
-+  dep_tristate &#039;  Connection byte counter support&#039; CONFIG_IP_NF_MATCH_CONNBYTES $CONFIG_IP_NF_CT_ACCT $CONFIG_IP_NF_CONNTRACK $CONFIG_IP_NF_IPTABLES
-   dep_tristate &#039;  GRE protocol support&#039; CONFIG_IP_NF_CT_PROTO_GRE $CONFIG_IP_NF_CONNTRACK
-   dep_tristate &#039;   PPTP protocol support&#039; CONFIG_IP_NF_PPTP $CONFIG_IP_NF_CT_PROTO_GRE
- fi
 Index: linux-2.4.35.4/net/ipv4/netfilter/Makefile
 ===================================================================
 --- linux-2.4.35.4.orig/net/ipv4/netfilter/Makefile
@@ -439,27 +426,15 @@
 +};
 +
 +#endif
-Index: linux-2.4.35.4/net/ipv4/netfilter/ip_conntrack_proto_gre.c
-===================================================================
---- linux-2.4.35.4.orig/net/ipv4/netfilter/ip_conntrack_proto_gre.c
-+++ linux-2.4.35.4/net/ipv4/netfilter/ip_conntrack_proto_gre.c
-@@ -237,16 +237,16 @@ static unsigned int gre_print_conntrack(
- /* Returns verdict for packet, and may modify conntrack */
- static int gre_packet(struct ip_conntrack *ct,
-               struct iphdr *iph, size_t len,
--              enum ip_conntrack_info conntrackinfo)
-+              enum ip_conntrack_info ctinfo)
- {
-     /* If we&#039;ve seen traffic both ways, this is a GRE connection.
-      * Extend timeout. */
-     if (ct-&gt;status &amp; IPS_SEEN_REPLY) {
--        ip_ct_refresh_acct(ct, ct-&gt;proto.gre.stream_timeout);
-+        ip_ct_refresh_acct(ct, ctinfo, iph, ct-&gt;proto.gre.stream_timeout);
-         /* Also, more likely to be important, and not a probe. */
-         set_bit(IPS_ASSURED_BIT, &amp;ct-&gt;status);
-     } else
--        ip_ct_refresh_acct(ct, ct-&gt;proto.gre.timeout);
-+        ip_ct_refresh_acct(ct, ctinfo, iph, ct-&gt;proto.gre.timeout);
-     
-     return NF_ACCEPT;
- }
+diff -urN linux-2.4.35.4.old/net/ipv4/netfilter/Config.in linux-2.4.35.4/net/ipv4/netfilter/Config.in
+--- linux-2.4.35.4.old/net/ipv4/netfilter/Config.in   2008-05-16 09:51:20.000000000 -0400
++++ linux-2.4.35.4/net/ipv4/netfilter/Config.in       2008-05-16 09:52:55.000000000 -0400
+@@ -11,6 +11,8 @@
+   dep_tristate &#039;  Amanda protocol support&#039; CONFIG_IP_NF_AMANDA $CONFIG_IP_NF_CONNTRACK
+   dep_tristate &#039;  TFTP protocol support&#039; CONFIG_IP_NF_TFTP $CONFIG_IP_NF_CONNTRACK
+   dep_tristate &#039;  IRC protocol support&#039; CONFIG_IP_NF_IRC $CONFIG_IP_NF_CONNTRACK
++  dep_tristate &#039;  Connection tracking flow accounting&#039; CONFIG_IP_NF_CT_ACCT $CONFIG_IP_NF_CONNTRACK
++  dep_tristate &#039;  Connection byte counter support&#039; CONFIG_IP_NF_MATCH_CONNBYTES $CONFIG_IP_NF_CT_ACCT $CONFIG_IP_NF_CONNTRACK $CONFIG_IP_NF_IPTABLES
+ fi
+
+ if [ &quot;$CONFIG_EXPERIMENTAL&quot; = &quot;y&quot; ]; then</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p69529">
				<div class="post-metadata">
					<div class="post-num">Post #37</div>
					<div class="post-author">placebo</div>
					<div class="post-datetime">
						13 Jun 2008, 01:14					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>kaldek wrote:</cite><blockquote><p>Hmm, interesting.&nbsp; Are you sure you have absolutely no queuing configured, even though qos-scripts isn&#039;t being used?</p></blockquote></div><p>Is there any queueing configured by default? I&#039;m running a fairly stock version of Kamikaze.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p69534">
				<div class="post-metadata">
					<div class="post-num">Post #38</div>
					<div class="post-author">kaldek</div>
					<div class="post-datetime">
						13 Jun 2008, 03:22					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>placebo wrote:</cite><blockquote><div class="quotebox"><cite>kaldek wrote:</cite><blockquote><p>Hmm, interesting.&nbsp; Are you sure you have absolutely no queuing configured, even though qos-scripts isn&#039;t being used?</p></blockquote></div><p>Is there any queueing configured by default? I&#039;m running a fairly stock version of Kamikaze.</p></blockquote></div><p>No, there&#039;s no queuing by default.</p><p>My system ran for a week with no issues, and I enabled QoS again about three days ago.&nbsp; Port redirection is still working, so I&#039;m now having to doubt my initial assessments.</p><p>There is ONE other thing I&#039;ve done though during this process which might be affecting it:&nbsp; I enabled swap space on a USB stick.</p><p>I think the only thing I can do for now is sit back and basically use the router until the problem occurs again.&nbsp; I need to run some packet tracing at that point in time to see if my internal servers are getting packets on random ports, as other folks have described.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p69804">
				<div class="post-metadata">
					<div class="post-num">Post #39</div>
					<div class="post-author">kaldek</div>
					<div class="post-datetime">
						19 Jun 2008, 04:49					</div>
				</div>
				<div class="post-content content">
					<p>Hey folks,</p><p>The router has been up for 13 days now with no failures.&nbsp; During this uptime I have disabled and enabled QoS without a restart.</p><p>I will now reboot the router with QoS enabled and give it a few more days to see if the problem occurs.&nbsp; &nbsp;Once again, I can only say that using a swapfile is the only change I believe I have made.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p69833">
				<div class="post-metadata">
					<div class="post-num">Post #40</div>
					<div class="post-author">netprince</div>
					<div class="post-datetime">
						19 Jun 2008, 16:12					</div>
				</div>
				<div class="post-content content">
					<p>I recently thought trunk had fixed this problem, the router was up for 2 months, then it stopped forwarding.&nbsp; Its hard to debug a problem thats not easy to reproduce...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p69862">
				<div class="post-metadata">
					<div class="post-num">Post #41</div>
					<div class="post-author">kaldek</div>
					<div class="post-datetime">
						20 Jun 2008, 03:32					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>netprince wrote:</cite><blockquote><p>I recently thought trunk had fixed this problem, the router was up for 2 months, then it stopped forwarding.&nbsp; Its hard to debug a problem thats not easy to reproduce...</p></blockquote></div><p>Hmmm.&nbsp; If it&#039;s up for two months and then fails, it has to be some form of resource exhaustion.&nbsp; What is needed therefore is a quick diagnostics script to gather all of the relevant details.</p><p>I&#039;ll have a think about what should be grabbed and put one together this weekend, and I&#039;ll publish the script in this thread.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p69863">
				<div class="post-metadata">
					<div class="post-num">Post #42</div>
					<div class="post-author">placebo</div>
					<div class="post-datetime">
						20 Jun 2008, 03:38					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>netprince wrote:</cite><blockquote><p>I recently thought trunk had fixed this problem, the router was up for 2 months, then it stopped forwarding.&nbsp; Its hard to debug a problem thats not easy to reproduce...</p></blockquote></div><p>What happened with your netfilter patches? I assume you did that on a different router since your previous post suggests that one would have been up for a month now.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p70203">
				<div class="post-metadata">
					<div class="post-num">Post #43</div>
					<div class="post-author">netprince</div>
					<div class="post-datetime">
						28 Jun 2008, 06:19					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>placebo wrote:</cite><blockquote><div class="quotebox"><cite>netprince wrote:</cite><blockquote><p>I recently thought trunk had fixed this problem, the router was up for 2 months, then it stopped forwarding.&nbsp; Its hard to debug a problem thats not easy to reproduce...</p></blockquote></div><p>What happened with your netfilter patches? I assume you did that on a different router since your previous post suggests that one would have been up for a month now.</p></blockquote></div><p>So far, the router with the patches is working.&nbsp; I only have it installed in one location though, I dont have any other router which uses port forwarding...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p70351">
				<div class="post-metadata">
					<div class="post-num">Post #44</div>
					<div class="post-author">sternklang</div>
					<div class="post-datetime">
						2 Jul 2008, 15:13					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m running X-wrt snapshots (r11520) and have this same problem. I don&#039;t have QoS enabled. I get maybe 2 days of forwarding before I have to reboot.</p><p>I look forward to the diagnostic script when it is available, I&#039;ll be glad to run it here. Please let me know if there is any other info that would be useful in diagnosing this.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p70404">
				<div class="post-metadata">
					<div class="post-num">Post #45</div>
					<div class="post-author">kaldek</div>
					<div class="post-datetime">
						3 Jul 2008, 04:01					</div>
				</div>
				<div class="post-content content">
					<p>This is a very simple script that will gather the really high level stuff that I&#039;m wanting to take a look at the next time mine has a problem:</p><div class="codebox"><pre><code>#!/bin/sh

iptables -L -n -t filter -vv &gt; /tmp/diag_iptables_filter
iptables -L -n -t nat -vv &gt; /tmp/diag_iptables_nat
iptables -L -n -t mangle -vv &gt; /tmp/diag_iptables_mangle
cat /proc/meminfo &gt; /tmp/diag_meminfo
cat /proc/net/ip_conntrack &gt; /tmp/diag_ip_conntrack
cat /proc/net/ip_conntrack | wc -l &gt; /tmp/diag_active_connections
cat /proc/sys/net/ipv4/netfilter/ip_conntrack_max &gt; /tmp/diag_max_connections
lsmod &gt; /tmp/diag_lsmod
cat /etc/firewall.user &gt; /tmp/diag_firewall.user
uptime &gt; /tmp/diag_uptime
tar zcvf /tmp/portfw_diag_`date -I`.tgz /tmp/diag_*</code></pre></div><p>You could merely paste the above into a shell prompt or save them to a file and keep it handy.&nbsp; Either way the result is a file located in the /tmp folder called &quot;portfw_diag_&lt;date&gt;.tgz&quot;.&nbsp; The script should be run when the problem is happening, not after rebooting of course.</p><p>After this I&#039;m going to knock up a short script to enable some detailed Firewall logging so that we can see what IPTables is doing as a connection attempt is made.&nbsp; &nbsp; Ultimately I think this is a resource exhaustion problem, but the question is <strong>which</strong> resource.</p>											<p class="post-edited">(Last edited by <strong>kaldek</strong> on 3 Jul 2008, 04:03)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p70424">
				<div class="post-metadata">
					<div class="post-num">Post #46</div>
					<div class="post-author">sternklang</div>
					<div class="post-datetime">
						3 Jul 2008, 14:37					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for this script. I tried running it last night, but when I tried to scp the tgz file back to my desktop I ran into the same issue -- my ssh/scp port, which is one of those I forward, was not accessible from my router. Since this was not being forwarded but was being used locally on the router, this may not be a port forwarding issue per se.</p><p>I rebooted so I could copy the file over, but unfortunately I forgot to copy it out of the /tmp fs first. 8-O I&#039;ll re-run this in a day or two when the problem manifests again.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p70442">
				<div class="post-metadata">
					<div class="post-num">Post #47</div>
					<div class="post-author">recnelis</div>
					<div class="post-datetime">
						4 Jul 2008, 01:49					</div>
				</div>
				<div class="post-content content">
					<p>Think it might be related to the off-by-one bug? <a href="https://dev.openwrt.org/cgi-bin/trac.fcgi/ticket/2570">https://dev.openwrt.org/cgi-bin/trac.fcgi/ticket/2570</a> and <a href="http://forum.openwrt.org/viewtopic.php?id=12165">http://forum.openwrt.org/viewtopic.php?id=12165</a></p><p>I&#039;m not entirely convinced that it&#039;s a netfilter bug. Port forwarding was fine years ago when I last used 2.4 and was working fine on 2.6 until I switched to OpenWrt and a WRT54GL. I&#039;d try 2.6 again, but I need wireless. sumpfralle mentioned earlier 2.6 fixes port forwarding for him, not sure if his problems were due to the off-by-one thing. I added logging into the prerouting and forward chains, and it confirms the presence of the bug in 7.09. Here&#039;s the rules I threw in to replicate the bug:</p><div class="codebox"><pre><code>iptables -t nat -A prerouting_wan -p tcp --dport 25002 -j LOG --log-prefix &quot;PREROUTING: &quot;                          
iptables -t nat -A prerouting_wan -p tcp --dport 25002 -j DNAT --to &lt;LAN IP&gt;:25002                       
iptables        -A forwarding_wan -p tcp -j LOG --log-prefix &quot;FORWARD: &quot;                                     
iptables        -A forwarding_wan -p tcp --dport 25002 -j LOG --log-prefix &quot;TEST2: &quot;                         
iptables        -A forwarding_wan -p tcp --dport 25002 -d &lt;LAN IP&gt; -j ACCEPT</code></pre></div><p>This is the result:</p><div class="codebox"><pre><code>Jul  3 10:45:30 Openwrt user.warn kernel: PREROUTING: IN=eth0.1 OUT= MAC=&lt;MAC&gt; SRC=&lt;SRC&gt; DST=&lt;Openwrt&gt; LEN=60 TOS=0x00 PREC=0x20 TTL=46 ID=36889 DF PROTO=TCP SPT=41892 DPT=25002 WINDOW=5840 RES=0x00 CWR ECE SYN URGP=0 
Jul  3 10:45:30 Openwrt user.warn kernel: FORWARD: IN=eth0.1 OUT=br-lan SRC=&lt;SRC&gt; DST=&lt;LAN IP&gt; LEN=60 TOS=0x00 PREC=0x20 TTL=45 ID=36889 DF PROTO=TCP SPT=41892 DPT=25003 WINDOW=5840 RES=0x00 CWR ECE SYN URGP=0</code></pre></div><p>Note that DPT goes from 25002 in the prerouting chain to 25003 in the forward chain and the TEST2 log rule is never hit. Of course, 8.08 was announced recently, maybe it&#039;s fixed in that?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p70444">
				<div class="post-metadata">
					<div class="post-num">Post #48</div>
					<div class="post-author">sternklang</div>
					<div class="post-datetime">
						4 Jul 2008, 02:06					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ve been running nightly snapshots and updated to the snapshot as of Monday. It&#039;s not fixed in that, so I don&#039;t know if a fix will be available in 8.08.</p><p>Thanks for pointing this out. I will test the off-by-one behavior after the long weekend. 2.6 is not an option as I am running on a WRT54GL and need wireless.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p70449">
				<div class="post-metadata">
					<div class="post-num">Post #49</div>
					<div class="post-author">kaldek</div>
					<div class="post-datetime">
						4 Jul 2008, 03:47					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>recnelis wrote:</cite><blockquote><p>Think it might be related to the off-by-one bug? <a href="https://dev.openwrt.org/cgi-bin/trac.fcgi/ticket/2570">https://dev.openwrt.org/cgi-bin/trac.fcgi/ticket/2570</a> and <a href="http://forum.openwrt.org/viewtopic.php?id=12165">http://forum.openwrt.org/viewtopic.php?id=12165</a></p><p>I&#039;m not entirely convinced that it&#039;s a netfilter bug.</p></blockquote></div><p>Neither am I.&nbsp; However, some live testing when the problem occurs will help here.</p><p>There are some folks experience this right now, so I&#039;m going to knock up a script which does the following:</p><p>- Accepts the published port and the real port as arguments<br/>- Sniffs the external interface and internal interface for the ports supplied in the arguments (using tcpdump)<br/>- Stores the output to dump files in /tmp</p><p>With the script running, a few attempts to get through the router can be made, and we will then see if the ports are being forwarded but off by one.&nbsp; The script can then terminate (I may do this as a separate script which just does a killall on all tcpdump processes).</p><p>P.S.&nbsp; I should add that the tcpdump check is important, because response packets to an off-by-one error would likely have the TCP &quot;RESET&quot; flag set and won&#039;t make it through the Firewall at the other end, nor be accepted by the client PC.&nbsp; OpenWRT by default <strong>does</strong> allow unsolicited outbound packets at least, making this test a little easier.</p>											<p class="post-edited">(Last edited by <strong>kaldek</strong> on 4 Jul 2008, 03:51)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p70450">
				<div class="post-metadata">
					<div class="post-num">Post #50</div>
					<div class="post-author">netprince</div>
					<div class="post-datetime">
						4 Jul 2008, 04:36					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>sternklang wrote:</cite><blockquote><p>I&#039;ve been running nightly snapshots and updated to the snapshot as of Monday. It&#039;s not fixed in that, so I don&#039;t know if a fix will be available in 8.08.</p><p>Thanks for pointing this out. I will test the off-by-one behavior after the long weekend. 2.6 is not an option as I am running on a WRT54GL and need wireless.</p></blockquote></div><p>If you are interested, I&#039;ll post one of my hacked images.&nbsp; Perhaps it will fix your router, but if not we&#039;ll know its not a problem with the modules I removed...</p><p>EDIT: <a href="http://www.psyc.vt.edu/openwrt/openwrt-brcm-2.4-squashfs.trx">http://www.psyc.vt.edu/openwrt/openwrt- … uashfs.trx</a></p>											<p class="post-edited">(Last edited by <strong>netprince</strong> on 4 Jul 2008, 04:39)</p>
									</div>
			</article>

			
		
						<div class="notice">
				<p>Sorry, posts 51 to 50 are missing from our archive.</p>
			</div>
		
		
	
	<div class="pagination"><div class="pagination-number">Page 2 of 6</div><nav><ul><li><a href="viewtopic.php%3Fid=13533&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li><li><a href="viewtopic.php%3Fid=13533&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=13533&amp;p=4.html">4</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=13533&amp;p=6.html">6</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>