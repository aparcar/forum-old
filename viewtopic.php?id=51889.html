<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Having problem to reconnect modem after going down</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 14 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p241872">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">solliq</div>
					<div class="post-datetime">
						28 Jul 2014, 12:05					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>I have to Chinese routers which are similar and both have Ericsson F5521gw<br /> modem inside. I am having trouble with both of them, disconnection at what appears to be random times then being unable to reconnect again.</p><p>I am currently running Bleeding Edge, r41336 and the modems go up an running without problems after hard restart:</p><div class="codebox"><pre><code>Tue Aug  5 09:45:20 2014 user.emerg syslog: Waiting for Registration..(120 sec max)........
Tue Aug  5 09:45:21 2014 user.emerg syslog: Registered on Home network: &quot;Telenor SE&quot;,2 
Tue Aug  5 09:45:21 2014 user.emerg syslog: Signal Quality: 99,99
Tue Aug  5 09:45:22 2014 daemon.notice netifd: Interface &#039;3G&#039; is now down
Tue Aug  5 09:45:22 2014 daemon.notice netifd: Interface &#039;3G&#039; is setting up now
Tue Aug  5 09:45:22 2014 user.emerg syslog: setting up led USB
Tue Aug  5 09:45:22 2014 user.emerg syslog: - init complete -
Tue Aug  5 09:45:25 2014 daemon.notice netifd: 3G (1111): SIM ready
Tue Aug  5 09:45:25 2014 daemon.notice netifd: 3G (1111): PIN set successfully
Tue Aug  5 09:45:25 2014 daemon.notice pppd[1141]: pppd 2.4.6 started by root, uid 0
Tue Aug  5 09:45:26 2014 local2.info chat[1144]: abort on (BUSY)
Tue Aug  5 09:45:26 2014 local2.info chat[1144]: abort on (NO CARRIER)
Tue Aug  5 09:45:26 2014 local2.info chat[1144]: abort on (ERROR)
Tue Aug  5 09:45:26 2014 local2.info chat[1144]: report (CONNECT)
Tue Aug  5 09:45:26 2014 local2.info chat[1144]: timeout set to 10 seconds
Tue Aug  5 09:45:26 2014 local2.info chat[1144]: send (AT&amp;F^M)
Tue Aug  5 09:45:26 2014 local2.info chat[1144]: expect (OK)
Tue Aug  5 09:45:27 2014 local2.info chat[1144]: AT&amp;F^M^M
Tue Aug  5 09:45:27 2014 local2.info chat[1144]: OK
Tue Aug  5 09:45:27 2014 local2.info chat[1144]:  -- got it
Tue Aug  5 09:45:27 2014 local2.info chat[1144]: send (ATE1^M)
Tue Aug  5 09:45:27 2014 local2.info chat[1144]: expect (OK)
Tue Aug  5 09:45:27 2014 local2.info chat[1144]: ^M
Tue Aug  5 09:45:27 2014 local2.info chat[1144]: ATE1^M^M
Tue Aug  5 09:45:27 2014 local2.info chat[1144]: OK
Tue Aug  5 09:45:27 2014 local2.info chat[1144]:  -- got it
Tue Aug  5 09:45:27 2014 local2.info chat[1144]: send (AT+CGDCONT=1,&quot;IP&quot;,&quot;internet.telenor.se&quot;^M)
Tue Aug  5 09:45:27 2014 local2.info chat[1144]: timeout set to 30 seconds
Tue Aug  5 09:45:27 2014 local2.info chat[1144]: expect (OK)
Tue Aug  5 09:45:27 2014 local2.info chat[1144]: ^M
Tue Aug  5 09:45:27 2014 local2.info chat[1144]: AT+CGDCONT=1,&quot;IP&quot;,&quot;internet.telenor.se&quot;^M^M
Tue Aug  5 09:45:27 2014 local2.info chat[1144]: OK
Tue Aug  5 09:45:27 2014 local2.info chat[1144]:  -- got it
Tue Aug  5 09:45:27 2014 local2.info chat[1144]: send (ATD*99#^M)
Tue Aug  5 09:45:27 2014 local2.info chat[1144]: expect (CONNECT)
Tue Aug  5 09:45:27 2014 local2.info chat[1144]: ^M
Tue Aug  5 09:45:28 2014 local2.info chat[1144]: ATD*99#^M~^?}#@!}!}!} }9}#}%B#}%}(}&quot;}&#039;}&quot;}&quot;}&amp;} } } } }%}&amp;}6&quot;r IA~^M
Tue Aug  5 09:45:28 2014 local2.info chat[1144]: CONNECT
Tue Aug  5 09:45:28 2014 local2.info chat[1144]:  -- got it
Tue Aug  5 09:45:28 2014 local2.info chat[1144]: send ( ^M)
Tue Aug  5 09:45:28 2014 daemon.info pppd[1141]: Serial connection established.
Tue Aug  5 09:45:28 2014 daemon.info pppd[1141]: Using interface 3g-3G
Tue Aug  5 09:45:28 2014 daemon.notice pppd[1141]: Connect: 3g-3G &lt;--&gt; /dev/ttyACM0
Tue Aug  5 09:45:29 2014 daemon.info pppd[1141]: CHAP authentication succeeded: Congratulations!
Tue Aug  5 09:45:29 2014 daemon.notice pppd[1141]: CHAP authentication succeeded
Tue Aug  5 09:45:32 2014 daemon.warn pppd[1141]: Could not determine remote IP address: defaulting to 10.64.64.64
Tue Aug  5 09:45:32 2014 daemon.notice pppd[1141]: local  IP address 46.195.239.18
Tue Aug  5 09:45:32 2014 daemon.notice pppd[1141]: remote IP address 10.64.64.64
Tue Aug  5 09:45:32 2014 daemon.notice pppd[1141]: primary   DNS address 195.54.122.221
Tue Aug  5 09:45:32 2014 daemon.notice pppd[1141]: secondary DNS address 195.54.122.211
Tue Aug  5 09:45:32 2014 daemon.notice netifd: Network device &#039;3g-3G&#039; link is up
Tue Aug  5 09:45:32 2014 daemon.notice netifd: Interface &#039;3G&#039; is now up
Tue Aug  5 09:45:32 2014 user.notice firewall: Reloading firewall due to ifup of 3G (3g-3G)
Tue Aug  5 09:45:35 2014 daemon.info dnsmasq[1033]: reading /tmp/resolv.conf.auto
Tue Aug  5 09:45:35 2014 daemon.info dnsmasq[1033]: using local addresses only for domain lan
Tue Aug  5 09:45:35 2014 daemon.info dnsmasq[1033]: using nameserver 195.54.122.221#53
Tue Aug  5 09:45:35 2014 daemon.info dnsmasq[1033]: using nameserver 195.54.122.211#53
Tue Aug  5 09:51:13 2014 daemon.info pppd[1141]: System time change detected.</code></pre></div><p>And I have written a cron job that every 5th minute goes in, tries t download a webpage, and if the download was unsuccessful, try to reconnect with command:</p><div class="codebox"><pre><code>gcom -g /dev/ttyACM1</code></pre></div><p>which it seems using this command like wakes the modem up and</p><div class="codebox"><pre><code>ifup 3G</code></pre></div><p>to connect the the modem.<br />When the modem goes down, a soft reboot doesn&#039;t help, then the modem is still unable to connect to the net, but running gcom-command says that the modem is registers with the service provider and give me a good signal quality.<br />In the systemlog, it says the same thing as when it connects to the net only after the whole procedure, it says</p><div class="codebox"><pre><code>Mon Jul 21 12:25:28 2014 user.emerg syslog:  ***SIM ERROR***
Mon Jul 21 12:25:28 2014 user.emerg syslog: Check device port configuration.
Mon Jul 21 12:25:28 2014 user.emerg syslog: Check SIM is inserted
Mon Jul 21 12:25:28 2014 user.emerg syslog: Test SIM in a mobile phone?
Mon Jul 21 12:25:29 2014 daemon.info pppd[1035]: Terminating on signal 15
Mon Jul 21 12:25:29 2014 daemon.info pppd[1035]: Connect time 0.4 minutes.
Mon Jul 21 12:25:29 2014 daemon.info pppd[1035]: Sent 6363 bytes, received 40667 bytes.
Mon Jul 21 12:25:29 2014 daemon.notice netifd: Network device &#039;3g-3G&#039; link is down
Mon Jul 21 12:25:29 2014 daemon.notice pppd[1035]: Connection terminated.
Mon Jul 21 12:25:29 2014 user.emerg syslog: setting up led USB
Mon Jul 21 12:25:29 2014 daemon.info pppd[1035]: Exit.
Mon Jul 21 12:25:29 2014 daemon.notice netifd: Interface &#039;3G&#039; is now down</code></pre></div><p>I&#039;ve tried different services providers here in Sweden (Tre and Telenor) and since I do not have any other problems when using other modems, the Ericsson modems most be the issue.</p><p>I&#039;ve read about many people having similar problems when running on Windows.<br />But since this modem is quite common, I was wondering if anyone else have had a look at this problem.</p>											<p class="post-edited">(Last edited by <strong>solliq</strong> on 5 Aug 2014, 11:06)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p242130">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">neryba</div>
					<div class="post-datetime">
						30 Jul 2014, 09:39					</div>
				</div>
				<div class="post-content content">
					<p>gcom&nbsp; use script where it set on modem AT+CFUN=1, you can try to set modem AT+CFUN=4 and after 10s try to set back AT+CFUN=1, maybe it helps. Or find some gpio which respond for power on modem, if device have this.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p242682">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">solliq</div>
					<div class="post-datetime">
						4 Aug 2014, 11:49					</div>
				</div>
				<div class="post-content content">
					<p>I will try this and get back to you with results, sounds promising since the connect is up and running again after a hard restart i.e. unpluggning and then repluggning the router.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p242807">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">solliq</div>
					<div class="post-datetime">
						5 Aug 2014, 11:03					</div>
				</div>
				<div class="post-content content">
					<p>I tried the suggestion, running the command:</p><div class="codebox"><pre><code>echo &quot;AT+CFUN=4&quot; &gt; /dev/ttyACM0</code></pre></div><p>waiting 10 seconds or so then running the command </p><div class="codebox"><pre><code>echo &quot;AT+CFUN=1&quot; &gt; /dev/ttyACM0</code></pre></div><p>It seems it didn&#039;t work, do now know what is wrong but I can not verify that the command has been accepted by the modem.</p><p>When looking into the log when trying to reconnect the modem it looks something like this:</p><div class="codebox"><pre><code>Tue Aug  5 09:45:28 2014 daemon.info pppd[1141]: Serial connection established.
Tue Aug  5 09:45:28 2014 daemon.info pppd[1141]: Using interface 3g-3G
Tue Aug  5 09:45:28 2014 daemon.notice pppd[1141]: Connect: 3g-3G &lt;--&gt; /dev/ttyACM0
Tue Aug  5 09:45:29 2014 daemon.info pppd[1141]: CHAP authentication succeeded: Congratulations!
Tue Aug  5 09:45:29 2014 daemon.notice pppd[1141]: CHAP authentication succeeded</code></pre></div><p>then nothing else, but there is no connection registered.</p><p>I also tried to change the modem to a used one I bought, a Ericsson F3507g, I think the name is but seems the problem remains.</p><p>Since the problem is no with the modem itself it seems, I will try to change the topic to something more relatable.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p242817">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">neryba</div>
					<div class="post-datetime">
						5 Aug 2014, 11:45					</div>
				</div>
				<div class="post-content content">
					<p>sometimes standard echo cannot send command without new row character.</p><div class="codebox"><pre><code>echo &quot;AT+CFUN=4\015&quot; &gt; /dev/ttyACM0</code></pre></div><p>Or find AT command witch can reload modem.</p><p>Did you found GPIO responded to USB/PCIe power?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p243090">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">solliq</div>
					<div class="post-datetime">
						7 Aug 2014, 13:10					</div>
				</div>
				<div class="post-content content">
					<p>Hmm it seems to be working now with the command you listed neryba, using </p><div class="codebox"><pre><code>echo &quot;AT+CFUN=4&quot; &gt; /dev/ttyACM0</code></pre></div><p>hangs up the modem but after a couple of seconds the router tries to reconnect again which I can only assume is equal to the command</p><div class="codebox"><pre><code>echo &quot;AT+CFUN=1&quot; &gt; /dev/ttyACM0</code></pre></div><p>but i could see some troubles with the reconnect as well, I will test a bit so see if the modem actually succeds in connecting after running CFUN=4 or if I have to run the command CFUN=1 before.</p><p>So the only way to achieve a hard reboot of the modem itself would be to turn of the GPIO as suggested.</p><p>I do not know how to look for which GPIO the modem is connected to though, how is that localized?</p><p>EDIT:</p><p>By using the commands CFUN=4 to hang up the modem, the router will try to reconnect and it seems it wont be able to do so until I run the command CFUN=1 again.<br />Maybe next time the modem hangs up by itself, I can run the command CFUN=1 directly.</p>											<p class="post-edited">(Last edited by <strong>solliq</strong> on 7 Aug 2014, 13:27)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p243456">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">solliq</div>
					<div class="post-datetime">
						11 Aug 2014, 12:00					</div>
				</div>
				<div class="post-content content">
					<p>I made a cron job that checks if i could wget google.com and if not, tries to run the commands discussed above.<br />It seems to be working, at least better then before since the internet was working even after a couple weekend and no resetting.</p><p>I will get back with more information in the near future if something else occurs.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p243825">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">solliq</div>
					<div class="post-datetime">
						14 Aug 2014, 13:09					</div>
				</div>
				<div class="post-content content">
					<p>After 4.5 days the router worked nice, reconnecting each time it dropped connection but today the router would just not manage to reconnect itself again.</p><p>It tried several times to reconnect and maybe it would succeed in the end but I did a hard reset and the connection was up and running again.</p><p>I would like to know which GPIO and how to set the GPIO status so I can adjust the previously made cron job to turn on and off the modem instead.</p><p>I assume the command to change the GPIO status is:</p><div class="codebox"><pre><code>echo 1 &gt; {something to GPIO}</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p243829">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">neryba</div>
					<div class="post-datetime">
						14 Aug 2014, 13:39					</div>
				</div>
				<div class="post-content content">
					<p>yes, you need test all free gpios. all reserved you can see </p><div class="codebox"><pre><code>cat /sys/kernel/debug/gpio</code></pre></div><p>and try all free with ex gpio12 </p><div class="codebox"><pre><code>echo 12 &gt; /sys/class/gpio/export
echo &quot;out&quot; &gt; /sys/class/gpio/gpio12/direction
echo 1 &gt; /sys/class/gpio/gpio12/value
#wait some time
echo 0 &gt; /sys/class/gpio/gpio12/value</code></pre></div>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>