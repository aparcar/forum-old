<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> WNR1000v2: some success! (need advice on board-specific init)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 16 Apr 2018 and 18 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=51504&amp;p=2.html">2</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p239596">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">supertanker</div>
					<div class="post-datetime">
						8 Jul 2014, 04:10					</div>
				</div>
				<div class="post-content content">
					<p>Hello all;</p><p>I picked up a Netgear WNR1000v2 VC router at a garage sale recently ($5!) and I&#039;ve been hacking at it. </p><p>The WNR1000v2 contains, according to <a href="https://wikidevi.com/wiki/Netgear_WNR1000v2">https://wikidevi.com/wiki/Netgear_WNR1000v2</a></p><p>* Atheros AR7240 CPU (300MHz)<br />* 4MB Flash<br />* 32MB RAM (Woooh! I thought it&#039;d only had 16MB at first)<br />* U-Boot accessible by serial console<br />* Atheros AR9285 B/G/N wifi chip with one connector<br />* AR7240 Ethernet Switch<br />* Runs a heavily modified OpenWRT 7.09 Kamikaze stock.</p><p>I&#039;ve used these forum posts as a starting point:<br /><a href="https://forum.openwrt.org/viewtopic.php?id=18279">https://forum.openwrt.org/viewtopic.php?id=18279</a><br /><a href="https://forum.openwrt.org/viewtopic.php?id=23387">https://forum.openwrt.org/viewtopic.php?id=23387</a></p><p>So far, I&#039;ve managed to compile OpenWRT Backfire and Attitude Adjustment ar71xx ramdisk images and, with a serial cable, have successfully booted into them. I did have to modify the magic number of the image to allow the modified u-Boot bootloader to boot it. I used the utility here <a href="http://aorlinsk2.free.fr/openwrt/wndr3700/">http://aorlinsk2.free.fr/openwrt/wndr3700/</a> but modified to use the magic number 0x31303030 (ASCII 1000 in hex) instead of ASCII 3700.</p><p>However, once the router boots, I have no network interfaces in either Backfire or Attitude Adjustment.&nbsp; For giggles, I tried appending board=WNR2000 to the bootargs, but that resulted in a freeze in Backfire and a kernel panic in Attitude Adjustment. There appears to be some board-specific initialization that needs to happen&nbsp; to enable the network devices, and I&#039;m not sure where to go from here.</p><p>mach-wnr2000.c (in arch/mips/ath79) looks interesting. What would I have to do to use this file as a base for the WNR1000v2?</p><p>Some other information:</p><p>In OpenWRT, I probed for GPIOs and came up with the following information:</p><p>There are 18 GPIOs registered.<br />The following GPIOs control LEDS: </p><div class="codebox"><pre><code>0    WAN amber    active low
1    power amber    active low
11    power green    active low
12    LAN4 amber    active low</code></pre></div><p>The rest of the GPIOs are unknown:</p><div class="codebox"><pre><code>2    (value always 1)
3    (value always 0)
4    (value always 0)
5    (value always 0)
6    (value always 0)
7    (value always 0)
8    (value always 0)
9    (value always 1)
10    (value always 1)
13    (value always 0)
14    (value always 0)
15    (value always 0)
16    (value always 0)
17    (value always 0)</code></pre></div><p>Given that there are three GPIOs with values stuck at 1 and three buttons, I&#039;m assuming that three of these are, in fact, tied to the buttons. However, I couldn&#039;t get them to react when pressing the buttons while echoing the value in a shell loop. I also don&#039;t know what the GPIOs are for the wireless LED and the WPS LED, or for WAN green and the rest of the LAN LEDs.</p><p>I have not touched flash memory at all, although the flash layout is somewhat peculiar:<br /></p><div class="codebox"><pre><code>dev:    size   erasesize  name
mtd0: 00040000 00010000 &quot;u-boot&quot;
mtd1: 00010000 00010000 &quot;u-boot-env&quot;
mtd2: 00350000 00010000 &quot;rootfs&quot;
mtd3: 00010000 00010000 &quot;config&quot;
mtd4: 00020000 00010000 &quot;language_table&quot;
mtd5: 00010000 00010000 &quot;pot&quot;
mtd6: 00010000 00010000 &quot;traffic_meter&quot;
mtd7: 00010000 00010000 &quot;ART&quot;
mtd8: 0034ffc0 00010000 &quot;mount_fs&quot;</code></pre></div><p>The kernel and rootfs are lumped together in the same partition. It is booted by loading the file from the partition via the fsload command (which means that Netgear&#039;s U-Boot knows how to grok the filesystem?) and booting from that location in memory.</p><p>So, I&#039;d appreciate a nudge in the right direction:</p><p>1) What do I need to do to start working on board-specific code for this device based off of the WNR2000&#039;s board file? Will creating another .c file and adding it to the Makefile be sufficient?</p><p>2) How can I track down the correct GPIOs for the missing buttons and LEDs?</p><p>For debug information, here&#039;s the boot log from the serial console:<br /><a href="http://jacksontech.net/wnr1000v2/serial_log_aa.txt">http://jacksontech.net/wnr1000v2/serial_log_aa.txt</a> (Attitude Adjustment)<br /><a href="http://jacksontech.net/wnr1000v2/serial_log_stock.txt">http://jacksontech.net/wnr1000v2/serial_log_stock.txt</a> (Stock firmware)</p><p>Note that the AA boot log is much shorter; it doesn&#039;t even try to init the network devices.</p><p>Edit: Fixed router name. WNR, not WRN. Gah!</p>											<p class="post-edited">(Last edited by <strong>supertanker</strong> on 8 Jul 2014, 04:11)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p242086">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">supertanker</div>
					<div class="post-datetime">
						30 Jul 2014, 01:22					</div>
				</div>
				<div class="post-content content">
					<p>I thought I&#039;d make an update, since I have successfully put OpenWRT onto this device.</p><p>The WNR1000v2 is similar enough to the WNR2000v3 to where the board init code can be used. Since I really wanted to get this working, I did nasty hacky things; I commented out all of the GPIO code in mach-wnr2000v3.c and changed the WNR2000v3&#039;s magic number in not one but two files; replacing 0x32303033 (2003) with 0x31303030 (1000) to keep the WNR1000v2&#039;s bootloader happy and (I think) to keep the kernel happy as well when it tries finding the rootfs. I spent most of the time trying to get the device to find the rootfs; it seemed to magically work when I found and replaced the second magic number...or maybe that was from removing GPIO LED support, which I disabled in the kernel build options after reading a bug report that claimed that the GPIO could interfere with reading from the flash chip. Sadly, I can&#039;t find that bug report now. This may or may not have made the device suddenly find its rootfs because I made this change at the same time I changed the magic numbers.</p><p>I compiled the &quot;WNR2000v3&quot; subtarget and flashed the image using the u-boot console, loading the image via TFTP. Bam.</p><p>Observations: the device works very well. I have it set up in client (routed) mode. Using 40MHz channels, in an area with little wireless interference, I can send TO the host behind the router at about 5.5-6.5MB/s from a TP-Link WR1043ND running stock firmware. I can send FROM the host behind the router to a machine on the main LAN at 9-10MB/s. I&#039;m not sure how to account for the speed difference. It may be that the TP-Link, with its 3 antennas, is better at receiving than the single antenna WNR1000v2. It could also be that the TP-Link has lousy txpower (I haven&#039;t done much surveying to find out), or a wireless-G router near the TP-Link is interfering with things. Either way, even 5.5MB/s is a massive improvement from the 2MB/s I had with the previous wireless bridge between two wireless-G routers.</p><p>Obviously, with no GPIO init code and no GPIO LED support, the LEDs are wonky. The LAN switch controls its own port LEDs and the blue wifi LED works, but the green WPS LED and the power light do not; the WPS LED does not enable at all (then again, I don&#039;t use WPS...) and the power light stays amber instead of switching to green after boot. The buttons do not work either, but who needs buttons, right?</p><p>If anyone wants to formally add support for this old router, use the WNR2000v3 code as a base. The router works very well with OpenWRT.</p><p>If you have one of these, try putting OpenWRT on it before you bin it. The stock firmware is so, so bad. The &quot;Advanced&quot; Wireless Settings page won&#039;t work in Firefox; it only seems to work in IE because of some strange JavaScript specific thing they did. I had to use IE11 to disable WPS!</p><p>Footnote: There are two versions of the WNR1000v2; Netgear&#039;s stock version and a Comcast version, which has &quot;VC&quot; at the end of its model number. Comcast apparently gave out a bunch of these routers with their Internet service awhile back. The Comcast branded version appears to have identical hardware to the stock version and the firmware appears to be identical (in functionality and appearance) as well, although you can only flash Comcast firmware onto a WNR1000v2 VC, not stock firmware. (This limitation appears to be enforced by the web UI, not the bootloader). My router is a WNR1000v2 VC, but I suspect the above works with the stock WNR1000v2 as well.</p><p>Thanks to fuhry&#039;s work on the WNR2000; it inspired me to get a serial cable and start hacking on this device.</p>											<p class="post-edited">(Last edited by <strong>supertanker</strong> on 30 Jul 2014, 01:26)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p253684">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">m007averick</div>
					<div class="post-datetime">
						9 Nov 2014, 07:07					</div>
				</div>
				<div class="post-content content">
					<p>Would you be able to provide this image of yours? I also have the same model and would love to use openwrt on that. I understand that only I am responsible for putting openwrt on my router and it &quot;may&quot; turn into a brick.<br />TIA</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p257755">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">SaltwaterC</div>
					<div class="post-datetime">
						15 Dec 2014, 18:11					</div>
				</div>
				<div class="post-content content">
					<p>I (unknowingly) replicated some of the supertanker&#039;s work. However, I&#039;ve a WNR1000v2 and the magic number is 0x31303031 which I found by comparing known magic numbers against factory firmwares, and then looking into the WNR1000v2 factory firmware and the 1.0.0.5 GPL firmware which I built from the sources which were made available by Netgear.</p><p>I&#039;ve a working build and I also made a patch against the Barrier Breaker tree. I didn&#039;t have to solder an UART header onto the board as most of the information is already available from various sources. In fact, all that I needed was the pesky magic number.</p><p>I used the WNR612v2 as template, since on WikiDevi it is stated that it has identical hardware as WNR1000v2, but WNR612v2 has only two LAN ports. I used that board as template for adding WNR1000v2 support. It worked on the first try, but the power LED was in the wrong state.</p><p>It has four states (off, amber, green, amber+green) and it is controlled via GPIO 1 and 11 as supertanker mentioned. It was booting in amber+green, when it should have been green. Flashing the latest factory firmware (1.1.2.58) before flashing OpenWrt fixed this issue.</p><p>The only things that don&#039;t work are the WPS and rfkill buttons. It is a non-issue for me.</p><p>I made available all the information in a gist, including the images if you don&#039;t have the patience for building your own: <a href="https://gist.github.com/SaltwaterC/ef49c8a4df81c8896153">https://gist.github.com/SaltwaterC/ef49c8a4df81c8896153</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262392">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">dsfraser</div>
					<div class="post-datetime">
						22 Jan 2015, 04:47					</div>
				</div>
				<div class="post-content content">
					<p>Thank you very much to SaltwaterC.&nbsp; I was able to get my old wnr1000v2-VC (free Comcast model) loaded with Openwrt.&nbsp; I tried your pre-builds but it would not take them.&nbsp; A little digging around showed me that the VC model had a different &#039;Magic Number&#039;, 1001 for the stock unit and 1000 for the VC model.&nbsp; I downloaded the source and the very simple to follow instructions from SaltwaterC&#039;s site.&nbsp; Changed the two Magic Number entries in his patch file (before applying it) and did a make.&nbsp; A hour or so later I was able to tftp openwrt onto my router.</p><p>To save anyone else the trouble (actually is was kind of fun) of building a VC version I have placed my files on my site.</p><p><a href="https://sites.google.com/site/dorkdogprojects/code-examples">https://sites.google.com/site/dorkdogpr … e-examples</a></p><p>Grab the wnr1000v2-VC.zip</p><p>Thanks again</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262476">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">SaltwaterC</div>
					<div class="post-datetime">
						22 Jan 2015, 17:23					</div>
				</div>
				<div class="post-content content">
					<p>You&#039;re welcome. I think that with the help of a hex editor you can even flash a 612v2 firmware on any of these, but the device name would be wrong on the status page. Your work confirms supertanker&#039;s findings, that 1000v2-VC has a different magic number. I&#039;ll update the patches with both versions, getting Chaos Calmer to match properly in the process as the patch was made from the Barrier Breaker patch.</p><p>I am curious about 1000v2h2 though. It looks to be the same as 1000v2, but it has two internal antennas instead of that external antenna that 1000v2 has. I couldn&#039;t find a different support page on Netgear&#039;s website, hence I assume that it uses the same firmware files. If somebody has this model, it would be helpful to give it a try.</p><p>FYI, this is the ticket on the issue tracker: <a href="https://dev.openwrt.org/ticket/18633">https://dev.openwrt.org/ticket/18633</a></p><p>Edit:</p><div class="quotebox"><blockquote><p>I didn&#039;t have to solder an UART header onto the board</p></blockquote></div><p>I need to amend my previous statement. You don&#039;t have to solder an UART header as it&#039;s already there. I didn&#039;t have to use it, but I opened the unit to see if there&#039;s room for improvement.</p>											<p class="post-edited">(Last edited by <strong>SaltwaterC</strong> on 22 Jan 2015, 17:35)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262489">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">J1mbo</div>
					<div class="post-datetime">
						22 Jan 2015, 20:28					</div>
				</div>
				<div class="post-content content">
					<p>How do you get to be able to TFTP to these? I tried to unlock the telnet interface on the WN604 (same hardware apparently) but was unable to do so.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262491">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">SaltwaterC</div>
					<div class="post-datetime">
						22 Jan 2015, 20:40					</div>
				</div>
				<div class="post-content content">
					<p>You have to place it in failsafe mode. Explained in the gist which I posted above: <a href="https://gist.github.com/SaltwaterC/ef49c8a4df81c8896153#install">https://gist.github.com/SaltwaterC/ef49 … 53#install</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262510">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">J1mbo</div>
					<div class="post-datetime">
						22 Jan 2015, 22:53					</div>
				</div>
				<div class="post-content content">
					<p>Thanks!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262556">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">SaltwaterC</div>
					<div class="post-datetime">
						23 Jan 2015, 10:46					</div>
				</div>
				<div class="post-content content">
					<p>BTW, WN604 looks like it uses different kind of firmware. I see that the official firmware is packaged as a tar which contains a kernel file and a rootfs file (squashfs), with some md5 checksums. Even though the hardware is the same, I think the flashing procedure is different.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262558">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">J1mbo</div>
					<div class="post-datetime">
						23 Jan 2015, 11:10					</div>
				</div>
				<div class="post-content content">
					<p>Interesting, thanks. Presumable the TFTP method of booting would though work?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262586">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">SaltwaterC</div>
					<div class="post-datetime">
						23 Jan 2015, 17:11					</div>
				</div>
				<div class="post-content content">
					<p>@J1mbo: don&#039;t know. I don&#039;t have access to an unit and it retails for an obscene price (aka it costs pretty much the same as my TL-WR1043ND V2).</p><p>@WNR1000v2-VC owners: I&#039;ve upgraded the patch and created new builds, including builds for WNR1000v2-VC against the latest Barrier Breaker branch. Can someone please test them? The magic number is correct for each model. I want to update the ticket on the issue tracker and this would be helpful. In the mean time, I&#039;ll update the Chaos Calmer patch as it fails to merge cleanly against the latest trunk.</p><p>Here&#039;s what&#039;s returned with the latest builds:</p><div class="quotebox"><blockquote><p>~/P/openwrt-wnr1000v2 (master) head -c 192 openwrt-ar71xx-generic-wnr1000v2-squashfs-factory-barrier-breaker-r44065.img | xxd<br />0000000: 6465 7669 6365 3a57 4e52 3130 3030 5632&nbsp; device:WNR1000V2<br />0000010: 0a76 6572 7369 6f6e 3a56 4f70 656e 5772&nbsp; .version:VOpenWr<br />0000020: 742e 7234 3430 3635 0a72 6567 696f 6e3a&nbsp; t.r44065.region:<br />0000030: 0a00 0000 0000 0000 0000 0000 0000 0000&nbsp; ................<br />0000040: 0000 0000 0000 0000 0000 0000 0000 0000&nbsp; ................<br />0000050: 0000 0000 0000 0000 0000 0000 0000 0000&nbsp; ................<br />0000060: 0000 0000 0000 0000 0000 0000 0000 0000&nbsp; ................<br />0000070: 0000 0000 0000 0000 0000 0000 0000 0000&nbsp; ................<br />0000080: 3130 3031 a288 c4fa 54c2 53ff 0011 2400&nbsp; 1001....T.S...$.<br />0000090: bf07 0000 bf07 0000 07d5 6094 0505 0700&nbsp; ..........`.....<br />00000a0: 4d49 5053 204f 7065 6e57 7274 204c 696e&nbsp; MIPS OpenWrt Lin<br />00000b0: 7578 2d33 2e31 302e 3439 0000 0000 0000&nbsp; ux-3.10.49......<br />~/P/openwrt-wnr1000v2 (master) head -c 192 openwrt-ar71xx-generic-wnr1000v2-vc-squashfs-factory-barrier-breaker-r44065.img | xxd<br />0000000: 6465 7669 6365 3a57 4e52 3130 3030 5632&nbsp; device:WNR1000V2<br />0000010: 2d56 430a 7665 7273 696f 6e3a 564f 7065&nbsp; -VC.version:VOpe<br />0000020: 6e57 7274 2e72 3434 3036 350a 7265 6769&nbsp; nWrt.r44065.regi<br />0000030: 6f6e 3a0a 0000 0000 0000 0000 0000 0000&nbsp; on:.............<br />0000040: 0000 0000 0000 0000 0000 0000 0000 0000&nbsp; ................<br />0000050: 0000 0000 0000 0000 0000 0000 0000 0000&nbsp; ................<br />0000060: 0000 0000 0000 0000 0000 0000 0000 0000&nbsp; ................<br />0000070: 0000 0000 0000 0000 0000 0000 0000 0000&nbsp; ................<br />0000080: 3130 3030 a6a0 e377 54c2 5402 0011 2400&nbsp; 1000...wT.T...$.<br />0000090: bf07 0000 bf07 0000 21a5 6e9d 0505 0700&nbsp; ........!.n.....<br />00000a0: 4d49 5053 204f 7065 6e57 7274 204c 696e&nbsp; MIPS OpenWrt Lin<br />00000b0: 7578 2d33 2e31 302e 3439 0000 0000 0000&nbsp; ux-3.10.49......</p></blockquote></div>											<p class="post-edited">(Last edited by <strong>SaltwaterC</strong> on 23 Jan 2015, 17:12)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262633">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">dsfraser</div>
					<div class="post-datetime">
						24 Jan 2015, 05:11					</div>
				</div>
				<div class="post-content content">
					<p>I tried both of the new builds for the VC model (bin &amp; img) and I&#039;m sorry I could not get them to work.&nbsp; Since I had a modified build of your wnr1000v2 I first tried the sysupgrade.bin.&nbsp; It seemed to load OK from the web page, the power led went black for 30 or so seconds then came back on for a few seconds and then went black again.&nbsp; I could not ping the router.&nbsp; I next tried tftp and the factory.img file.&nbsp; It responded the same way as the sysupgrade.</p><p>I reinstalled the img file I had made and the router came back to life... perhaps something failing in the boot sequence??</p><p>I have never seen a v2h2 model of the wnr1000 but I did find a third magic number in the last netgear open source files.&nbsp; There are listed as wnr1000v2 - 0x31030331, wnr1000v2-VC - 0x31030330 and wnr1000v2-VM - 0x31303032 (whatever that one is).</p><p>I also tried rebuilding the firmware from your new code and patches, there is no target for making the wnr1000v2-VC, should it build with the wnr1000v2?</p><p>I look forward to trying a trunk build.</p><p>Thanks for all your work on this router.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262649">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">SaltwaterC</div>
					<div class="post-datetime">
						24 Jan 2015, 11:34					</div>
				</div>
				<div class="post-content content">
					<p>Based on what&#039;s happening for WNR612v2 / N150R (same devices), I tried to use another profile instead of another target, but I didn&#039;t call the multi profile. I was wrong about two things:</p><p>1. It doesn&#039;t work without call MultiProfile. I though it would.<br />2. It doesn&#039;t work with images built for other devices, even though it&#039;s the same hardware and the built images are almost the same. Checked them by doing a diff on the hex dump. I hex edited my images, and yours, and it wouldn&#039;t flash on WNR1000v2, even though the magic number is changed to the correct value. I could try using a sysupgrade image with changed magic number and see what fails by attaching a serial console just to have all the information. The sysupgrade is written, but it boots in failsafe mode.</p><p>The part from 1 can be fixed easily as, again, I&#039;m using WNR612v2 as template. Thanks for the help. I&#039;ll try with a new set of images after fixing the &quot;call MultiProfile&quot; mess which I did. For the moment, I&#039;m taking down the -vc images.</p><p>BTW, this is <a href="https://wikidevi.com/wiki/Netgear_WNR1000v2h2">WNR1000v2h2</a>. It has two internal antennas instead of one U.FL connector, which makes me think of the possibility of adding a secondary antenna.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262732">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">SaltwaterC</div>
					<div class="post-datetime">
						25 Jan 2015, 01:34					</div>
				</div>
				<div class="post-content content">
					<p>I updated the patch and rebuilt the BB images (r44095). dsfraser, can you give them another try, please? This time I used the MultiProfile. The WNR1000v2 images (factory &amp; sysupgrade) work on my device. Hopefully, the WNR1000v2-VC images work as well.</p><p>Sorry for the double post, but the forum doesn&#039;t provide any PM support.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262746">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">dsfraser</div>
					<div class="post-datetime">
						25 Jan 2015, 04:23					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m glad to report that both the new builds of the Sysupgrade bin and Factory imb files install and work on the VC model.</p><p>After looking at the pictures of the wnr1000v2h2 board in the link you sent, I decided to open mine up.&nbsp; The board looks almost exactly the same.&nbsp; There are pads for more then one antenna lead and it appears it would be very easy to add one.</p><p>Thank-you</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262761">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">J1mbo</div>
					<div class="post-datetime">
						25 Jan 2015, 10:26					</div>
				</div>
				<div class="post-content content">
					<p>Update on the WN604 - the TFTP server failsafe mode works OK.</p><ul><li><p>openwrt-ar71xx-generic-wnr1000v2-squashfs-factory-barrier-breaker-r44095.img - image accepted, device restarts but only into failsafe mode</p></li><li><p>openwrt-ar71xx-generic-wnr1000v2-vc-squashfs-factory-barrier-breaker-r44095.img - image not accepted; device doesn&#039;t restart and just flashes green immediately.</p></li></ul><p>Any ideas would be greatly appreciated. The factory firmware file is a tar containing:</p><ul><li><p>kernel.md5 (36 bytes)</p></li><li><p>rootfs.squashfs (2,625,536 bytes)</p></li><li><p>root_fs.md5 (36 bytes)</p></li><li><p>vmlinux.lzma.uImage (655,424 bytes)</p></li></ul><p>However, sending that via TFTP isn&#039;t accepted (it transfers so much, then times-out). I&#039;m not bothered about getting back to the factory firmware but thought it might help work out what is going on.</p>											<p class="post-edited">(Last edited by <strong>J1mbo</strong> on 25 Jan 2015, 10:36)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262978">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">J1mbo</div>
					<div class="post-datetime">
						26 Jan 2015, 22:48					</div>
				</div>
				<div class="post-content content">
					<p>Re WN604; here is the serial port output:</p><div class="codebox"><pre><code>U-Boot 1.1.4-g12193fce-dirty (Dec 14 2009 - 13:39:19)

WN604 (ar7240) U-boot dni7 V0.8
...
## Booting image at 9f050000 ...
   Image Name:   MIPS OpenWrt Linux-3.10.49
   Created:      2015-01-24  22:37:25 UTC
   Image Type:   MIPS Linux Unknown Image (uncompressed)
   Data Size:    1123328 Bytes =  1.1 MB
   Load Address: bf070000
   Entry Point:  bf070000
   Verifying Checksum ... OK
Wrong Image Type for bootm command
Trying eth1
eth1 link down
FAIL
Trying eth0
eth0 link down
FAIL

The Router is in TFTP Server Firmware Recovery mode NOW!
Listening on Port : 69, IP Address: 192.168.1.1...</code></pre></div><p>Here is the boot from the factory firmware:</p><div class="codebox"><pre><code>## Booting image at 9f050000 ...
   Image Name:   Linux Kernel
   Created:      2012-02-16  11:08:50 UTC
   Image Type:   MIPS Linux Kernel Image (lzma compressed)
   Data Size:    655360 Bytes = 640 kB
   Load Address: 80002000
   Entry Point:  801b8000
   Verifying Checksum ... OK
   Uncompressing Kernel Image ... OK
No initrd
## Transferring control to Linux (at address 801b8000) ...
## Giving linux memsize in bytes, 33554432

Starting kernel ...

Booting AR7240(Python)...
Linux version 2.6.15--LSDK-7.3.0.387-WN604_V3.0.2 (root@build) (gcc version 3.4.4) #199 Thu Feb 16 16:35:45 IST 2012
flash_size passed from bootloader = 4</code></pre></div><p>So the issue is the &#039;Wrong Image Type for bootm command&#039;. Here is the bdinfo:</p><div class="codebox"><pre><code>ar7240&gt; bdinfo
boot_params = 0x81F67FA4
memstart    = 0x80000000
memsize     = 0x02000000
flashstart  = 0x9F000000
flashsize   = 0x00400000
flashoffset = 0x0003BE38</code></pre></div><p>And, printenv:</p><div class="codebox"><pre><code>ar7240&gt; printenv
bootdelay=4
baudrate=115200
ethaddr=0x00:0xaa:0xbb:0xcc:0xdd:0xee
filesize=a0040
fileaddr=80800000
memtmp_addr=0x80800000
download=tftp
serverip=192.168.1.12 [your tftpservers IP]
ipaddr=192.168.1.11 [ Ip of the board]
uboot_size=+0x40000
uboot_addr=0x9f000000
erase_uimage=erase ${uboot_addr} ${uboot_size}
uimage=${download} ${memtmp_addr} u-boot.bin;run erase_uimage;cp.b ${memtmp_addr} ${uboot_addr} ${filesize}
kimagename=vmlinux.lzma.uImage
kernel_addr=0x9f050000
kernel_size=+0xB0000
erase_kimage=erase ${kernel_addr} ${kernel_size}
kimage=${download} ${memtmp_addr} ${kimagename};run erase_kimage;cp.b ${memtmp_addr} ${kernel_addr} ${filesize}
rimagename=rootfs.squashfs
rootfs_addr=0x9f100000
rootfs_size=+0x290000
erase_rimage=erase ${rootfs_addr} ${rootfs_size}
rimage=${download} ${memtmp_addr}  ${rimagename};run erase_rimage;cp.b ${memtmp_addr} ${rootfs_addr} ${filesize}
clear_var=era 0x9f390000 +0x50000
bootargs=console=ttyS0,115200 rootfstype=squashfs root=31:03 init=/sbin/init mtdparts=ar7240-nor0:256k(u-boot),64k(u-boot-env),704k(kernel),2624k(rootfs),320k(var),64k(manufacturing-data),64k(ART)
flash_rootfs=run rimage
flash_kernel=run kimage
flash_all=run flash_kernel flash_rootfs clear_var
bootcmd=bootm 0x9f050000
stdin=serial
stdout=serial
stderr=serial
ethact=eth1

Environment size: 1293/65532 bytes
ar7240&gt; printenv
Unknown command &#039;printenv&#039; - try &#039;help&#039;
ar7240&gt; printenv
bootdelay=4
baudrate=115200
ethaddr=0x00:0xaa:0xbb:0xcc:0xdd:0xee
filesize=a0040
fileaddr=80800000
memtmp_addr=0x80800000
download=tftp
serverip=192.168.1.12 [your tftpservers IP]
ipaddr=192.168.1.11 [ Ip of the board]
uboot_size=+0x40000
uboot_addr=0x9f000000
erase_uimage=erase ${uboot_addr} ${uboot_size}
uimage=${download} ${memtmp_addr} u-boot.bin;run erase_uimage;cp.b ${memtmp_addr} ${uboot_addr} ${filesize}
kimagename=vmlinux.lzma.uImage
kernel_addr=0x9f050000
kernel_size=+0xB0000
erase_kimage=erase ${kernel_addr} ${kernel_size}
kimage=${download} ${memtmp_addr} ${kimagename};run erase_kimage;cp.b ${memtmp_addr} ${kernel_addr} ${filesize}
rimagename=rootfs.squashfs
rootfs_addr=0x9f100000
rootfs_size=+0x290000
erase_rimage=erase ${rootfs_addr} ${rootfs_size}
rimage=${download} ${memtmp_addr}  ${rimagename};run erase_rimage;cp.b ${memtmp_addr} ${rootfs_addr} ${filesize}
clear_var=era 0x9f390000 +0x50000
bootargs=console=ttyS0,115200 rootfstype=squashfs root=31:03 init=/sbin/init mtdparts=ar7240-nor0:256k(u-boot),64k(u-boot-env),704k(kernel),2624k(rootfs),320k(var),64k(manufacturing-data),64k(ART)
flash_rootfs=run rimage
flash_kernel=run kimage
flash_all=run flash_kernel flash_rootfs clear_var
bootcmd=bootm 0x9f050000
stdin=serial
stdout=serial
stderr=serial
ethact=eth1

Environment size: 1293/65532 bytes</code></pre></div><p>Any ideas?</p>											<p class="post-edited">(Last edited by <strong>J1mbo</strong> on 26 Jan 2015, 23:57)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p263015">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">SaltwaterC</div>
					<div class="post-datetime">
						27 Jan 2015, 02:09					</div>
				</div>
				<div class="post-content content">
					<p>@dsfraser: thank you for testing the images. I completed the work on the CC patch as well, but I need to see why I can&#039;t get proper images from the build (aka it doesn&#039;t apply the appropriate driver profile and the device won&#039;t boot properly). Unlike the release, the trunk is a little bit fussy about the config and it fails in weird ways. I should start from scratch as incremental builds may be the issue. In the mean time, also figured out <a href="https://dev.openwrt.org/wiki/SubmittingPatches">how to send patches</a>. We&#039;re getting there.</p><br /><p>@J1mbo: I think that probably we should discuss this into another thread, dedicated to WN604.</p><p>To answer your question, my educated guess is that you should place your firmware files (vmlinux.lzma.uImage and rootfs.squashfs) on the root directory of a tftp server running on your computer. From the printenv output, I see that, for example, rimage roughly translates to these steps, which are common for flashing via tftp and attached serial console:</p><div class="quotebox"><blockquote><p>tftp 0x80800000 rootfs.squashfs<br />erase 0x9f100000 +0x290000<br />cp.b 0x80800000 0x9f100000 0x290000</p></blockquote></div><p>I say roughly because it states ${filesize}, but it should match the ${rootfs_size} value from the erase command, therefore it may be recommended to use the above commands instead of running rimage. The same idea may be applied for flashing the kernel image, but you would need to use:</p><div class="quotebox"><blockquote><p>tftp 0x80800000 vmlinux.lzma.uImage<br />erase 0x9f050000 +0xB0000<br />cp.b 0x80800000 0x9f050000 0xB0000</p></blockquote></div><p>After that, you may boot the kernel with <a href="https://sites.google.com/site/linuxkernel88/kernel-exploration/u-boot">bootm</a> by passing the kernel address to it (0x9f050000).</p><p>Please triple check everything that I&#039;ve just said before typing anything in the u-boot console. I may be wrong about, well, everything.</p><p>And whatever you do, stay away from uimage and anything related. If you mess the bootloader, you&#039;re going to be in a world of trouble (<a href="http://wiki.openwrt.org/doc/howto/generic.debrick">read #3</a>).</p><p>As a separate note, my calculations say that the kernel and the rootfs are next to each other: 0x9f050000 + 0xB0000 = 0x9f100000. I guess this information could be used for eventually flashing a potential OpenWrt build in one go instead of having separated files for kernel and squashfs.</p>											<p class="post-edited">(Last edited by <strong>SaltwaterC</strong> on 27 Jan 2015, 02:11)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p263053">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">J1mbo</div>
					<div class="post-datetime">
						27 Jan 2015, 10:12					</div>
				</div>
				<div class="post-content content">
					<p>Thank you so much for the help - and, I will move the content now.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p263058">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">J1mbo</div>
					<div class="post-datetime">
						27 Jan 2015, 10:48					</div>
				</div>
				<div class="post-content content">
					<p>Could you post printenv output from the WNR1000v2?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p263179">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">SaltwaterC</div>
					<div class="post-datetime">
						28 Jan 2015, 00:27					</div>
				</div>
				<div class="post-content content">
					<p>@J1mbo: quite short ...</p><div class="codebox"><pre><code>ar7240&gt; printenv
bootdelay=4
baudrate=115200
ethaddr=0x00:0xaa:0xbb:0xcc:0xdd:0xee
serverip=192.168.1.101
ipaddr=192.168.1.1
bootcmd=fsload 80800000 image/uImage;bootm 80800000
bootargs=console=ttyS0,115200 root=31:08 rootfstype=squashfs init=/etc/preinit mtdparts=ar7240-nor0:256k(u-boot),64k(u-boot-env),3392k(rootfs),64k(config),128k(language_table),64k(pot),64k(traffic_meter),64k(ART),3473344@327744(mount_fs)
stdin=serial
stdout=serial
stderr=serial
ethact=eth1

Environment size: 451/65532 bytes</code></pre></div><p>@dsfraser: I completed the work on Chaos Calmer and successfully flashed my device with it. However, it required a power cycle after flashing the factory image via tftp.</p><p>It booted into failsafe after the flash (&quot;Bad magic number&quot; error shown in serial console), but the failsafe mode after the flash was unusable as it denied flash write access. After a power cycle, it booted Chaos Calmer without any fuss.</p><p>I don&#039;t see why it shouldn&#039;t work for WNR1000v2-VC as the patch itself is just the Barrier Breaker patch changed to match the CC offsets and kernel version, but it would be helpful to have a confirmation before sending it to openwrt-devel. Also, if you don&#039;t mind, the patch may also be tagged with Tested-by, but I need your name and email. While your name appears on the website you posted, I can only guess the rest. If you&#039;re OK with it, please drop me a line on Gmail (I&#039;ve the same username as the one I&#039;m using here). Thank you.</p><p>PS: the build issues were indeed due to having incremental builds, an issue I don&#039;t have with BB. Starting from scratch with a clean tree and a new config, I got the images from the first try.</p><div class="codebox"><pre><code>BusyBox v1.22.1 (2015-01-27 04:58:41 EST) built-in shell (ash)
Enter &#039;help&#039; for a list of built-in commands.

  _______                     ________        __
 |       |.-----.-----.-----.|  |  |  |.----.|  |_
 |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|
 |_______||   __|_____|__|__||________||__|  |____|
          |__| W I R E L E S S   F R E E D O M
 -----------------------------------------------------
 CHAOS CALMER (Bleeding Edge, r44154)
 -----------------------------------------------------
  * 1 1/2 oz Gin            Shake with a glassful
  * 1/4 oz Triple Sec       of broken ice and pour
  * 3/4 oz Lime Juice       unstrained into a goblet.
  * 1 1/2 oz Orange Juice
  * 1 tsp. Grenadine Syrup
 -----------------------------------------------------
root@OpenWrt:/# uname -a
Linux OpenWrt 3.14.29 #1 Tue Jan 27 05:02:37 EST 2015 mips GNU/Linux
root@OpenWrt:/# cat /proc/cpuinfo
system type             : Atheros AR7240 rev 2
machine                 : NETGEAR WNR1000 V2
processor               : 0
cpu model               : MIPS 24Kc V7.4
BogoMIPS                : 226.09
wait instruction        : yes
microsecond timers      : yes
tlb_entries             : 16
extra interrupt vector  : yes
hardware watchpoint     : yes, count: 4, address/irw mask: [0x0ffc, 0x0ffc, 0x0ffb, 0x0ffb]
isa                     : mips1 mips2 mips32r1 mips32r2
ASEs implemented        : mips16
shadow register sets    : 1
kscratch registers      : 0
core                    : 0
VCED exceptions         : not available
VCEI exceptions         : not available</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p263578">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">J1mbo</div>
					<div class="post-datetime">
						31 Jan 2015, 00:05					</div>
				</div>
				<div class="post-content content">
					<p>Now working on WN604 too - see <a href="https://forum.openwrt.org/viewtopic.php?id=55144">this thread</a> <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p264896">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">TeaPot</div>
					<div class="post-datetime">
						10 Feb 2015, 12:23					</div>
				</div>
				<div class="post-content content">
					<p>Thank&#039;s SaltwaterC, using the info from you and Jimbo I&#039;ve managed to get a stack of WN604&#039;s working perfectly. Much appreciated.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p265933">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">jlpapple</div>
					<div class="post-datetime">
						17 Feb 2015, 18:08					</div>
				</div>
				<div class="post-content content">
					<p>Any tips for getting around a tftp &quot;transfer timeout&quot; message when using the Mac OS X Terminal (10.9)? </p><p>I&#039;ve followed Saltwater&#039;s instructions (<a href="https://gist.github.com/SaltwaterC/ef49c8a4df81c8896153">https://gist.github.com/SaltwaterC/ef49c8a4df81c8896153</a>) to the letter for flashing a 1000v2-vc but I can&#039;t upload the new .img to the router. It seems to boot into failsafe mode properly (ping is OK, green light flashing), but it won&#039;t accept a transfer.&nbsp; I&#039;ve configured the network on the Mac to a static IP (192.168.1.2) with the router as 192.168.1.1. Binary and trace enabled.</p><p>I&#039;d love any help with this, thanks!</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=51504&amp;p=2.html">2</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>