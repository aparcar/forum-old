<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Does Openwrt support pivot root/overlay on Ubifs?</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 25 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p255069">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">tusc</div>
					<div class="post-datetime">
						21 Nov 2014, 01:34					</div>
				</div>
				<div class="post-content content">
					<p>Hi all,</p><p>I hope this is the proper forum for this question.</p><p>I&#039;ve been trying to figure out why pivot overlay does not work on the Armada XP platform, in particular a WRT1900AC. I am suspecting it has something to do with ubifs.</p><p>I am currently running trunk release r43336 and cannot get this to work no matter what I place in /etc/config/fstab ( I have tried everything in the extroot wiki page)</p><p>During console bootup I see the following when i have the target set to /overlay in the fstab file. The error it comes back with is &quot;block: extroot: unable to retrieve rootfs information&quot;</p><div class="codebox"><pre><code>[    2.420925] xhci_hcd 0000:01:00.0: xHCI Host Controller
[    2.426201] xhci_hcd 0000:01:00.0: new USB bus registered, assigned bus number 2
[    2.434414] hub 2-0:1.0: USB hub found
[    2.438204] hub 2-0:1.0: 2 ports detected
[    2.442426] xhci_hcd 0000:01:00.0: xHCI Host Controller
[    2.447691] xhci_hcd 0000:01:00.0: new USB bus registered, assigned bus number 3
[    2.455669] hub 3-0:1.0: USB hub found
[    2.459459] hub 3-0:1.0: 2 ports detected
[    2.466644] usbcore: registered new interface driver usb-storage
procd: WDT failed to write: Bad file descriptor
procd: - preinit -
[    2.738049] random: nonblocking pool is initialized
[    2.764267] usb 2-2: new high-speed USB device number 2 using xhci_hcd
Press the [f] key and hit [enter] to enter failsafe mode
Press the [1], [2], [3] or [4] key and hit [enter] to select the debug level
[    2.908613] usb-storage 2-2:1.0: USB Mass Storage device detected
[    2.914912] scsi1 : usb-storage 2-2:1.0
[    3.915104] scsi 1:0:0:0: Direct-Access              Patriot Memory   PMAP PQ: 0 ANSI: 0 CCS
[    3.925331] sd 1:0:0:0: [sda] 15663104 512-byte logical blocks: (8.01 GB/7.46 GiB)
[    3.933106] sd 1:0:0:0: [sda] Write Protect is off
[    3.938147] sd 1:0:0:0: [sda] No Caching mode page found
[    3.943477] sd 1:0:0:0: [sda] Assuming drive cache: write through
[    3.952313] sd 1:0:0:0: [sda] No Caching mode page found
[    3.957660] sd 1:0:0:0: [sda] Assuming drive cache: write through
[    3.964836]  sda: sda1
[    3.968354] sd 1:0:0:0: [sda] No Caching mode page found
[    3.973684] sd 1:0:0:0: [sda] Assuming drive cache: write through
[    3.979814] sd 1:0:0:0: [sda] Attached SCSI removable disk
block: extroot: unable to retrie[    6.066777] UBIFS: background thread &quot;ubifs_bgt0_1&quot; started, PID 438
ve rootfs information
[    6.091855] UBIFS: recovery needed
[    6.155276] UBIFS: recovery completed
[    6.159011] UBIFS: mounted UBI device 0, volume 1, name &quot;rootfs_data&quot;
[    6.165485] UBIFS: LEB size: 126976 bytes (124 KiB), min./max. I/O unit sizes: 2048 bytes/2048 bytes
[    6.174652] UBIFS: FS size: 25522176 bytes (24 MiB, 201 LEBs), journal size 1269760 bytes (1 MiB, 10 LEBs)
[    6.184349] UBIFS: reserved for root: 1205474 bytes (1177 KiB)
[    6.190204] UBIFS: media format: w4/r0 (latest is w4/r0), UUID 31B4D870-7D62-4475-8C9A-BF8A2D9CF46F, small LPT model
switching to overlay
[    6.250775] UBI: attaching mtd8 to ubi1
[    6.341414] UBI: scanning is finished
[    6.349104] UBI warning: print_rsvd_warning: cannot reserve enough PEBs for bad PEB handling, reserved 2, need 12
[    6.359943] UBI: attached mtd8 (name &quot;syscfg&quot;, size 38 MiB) to ubi1
[    6.366247] UBI: PEB size: 131072 bytes (128 KiB), LEB size: 126976 bytes
[    6.373053] UBI: min./max. I/O unit sizes: 2048/2048, sub-page size 2048
[    6.379781] UBI: VID header offset: 2048 (aligned 2048), data offset: 4096
[    6.386682] UBI: good PEBs: 296, bad PEBs: 8, corrupted PEBs: 0
[    6.392618] UBI: user volume: 1, internal volumes: 1, max. volumes count: 128
[    6.399780] UBI: max/mean erase counter: 25/21, WL threshold: 4096, image sequence number: 750244846
[    6.408944] UBI: available PEBs: 0, total reserved PEBs: 296, PEBs reserved for bad PEB handling: 2
[    6.418032] UBI: background thread &quot;ubi_bgt1d&quot; started, PID 445
UBI device number 1, total 296 LEBs (37584896 by[    6.428336] UBIFS: background thread &quot;ubifs_bgt1_0&quot; started, PID 448
tes, 35.8 MiB), available 0 LEBs (0 bytes), LEB size 126976 bytes (124.0 KiB)
[    6.470084] UBIFS: mounted UBI device 1, volume 0, name &quot;syscfg&quot;
[    6.476139] UBIFS: LEB size: 126976 bytes (124 KiB), min./max. I/O unit sizes: 2048 bytes/2048 bytes
[    6.485308] UBIFS: FS size: 35680256 bytes (34 MiB, 281 LEBs), journal size 1777664 bytes (1 MiB, 14 LEBs)
[    6.494995] UBIFS: reserved for root: 1685265 bytes (1645 KiB)
[    6.500846] UBIFS: media format: w4/r0 (latest is w4/r0), UUID 6C76BEAD-F1CC-46B1-9B9B-CCDD36A50A02, small LPT model
procd: - early -
Failed to connect to ubus
procd: - ubus -
procd: - init -
Please press Enter to activate this console.
[    8.564013] NET: Registered protocol family 10
[    8.581819] ip6_tables: (C) 2000-2006 Netfilter Core Team
[    8.592625] leds-tlc59116: Using tlc59116 16-bit LED driver at slave address 0x68</code></pre></div><p>After bootup I can make this volume mount to the /mnt/sda1 directory by typing &quot;block mount&quot; without issue. If I change it back to /overlay target and type the following I get the same error as during bootup:</p><div class="codebox"><pre><code>root@OpenWrt:/etc/config# export PREINIT=1
root@OpenWrt:/etc/config# block extroot
block: extroot: unable to retrieve rootfs information
root@OpenWrt:/etc/config#</code></pre></div><p>contents of /etc/config/fstab</p><div class="codebox"><pre><code>config &#039;global&#039;
        option  anon_swap       &#039;0&#039;
        option  anon_mount      &#039;0&#039;
        option  auto_swap       &#039;1&#039;
        option  auto_mount      &#039;1&#039;
        option  delay_root      &#039;5&#039;
        option  check_fs        &#039;0&#039;

config &#039;mount&#039;
        option  target  &#039;/overlay&#039;
        option  uuid    &#039;675adbeb-75bf-4975-b64b-a8772e8cee9f&#039;
        option  enabled &#039;1&#039;</code></pre></div><div class="codebox"><pre><code>root@OpenWrt:/# df -h
Filesystem                Size      Used Available Use% Mounted on
rootfs                   21.8M    440.0K     20.3M   2% /
/dev/root                 7.5M      7.5M         0 100% /rom
tmpfs                   124.9M    240.0K    124.7M   0% /tmp
/dev/ubi0_1              21.8M    440.0K     20.3M   2% /overlay
overlayfs:/overlay       21.8M    440.0K     20.3M   2% /
ubi1:syscfg              30.8M    272.0K     28.9M   1% /tmp/syscfg
tmpfs                   512.0K         0    512.0K   0% /dev
root@OpenWrt:/# mount
rootfs on / type rootfs (rw)
/dev/root on /rom type squashfs (ro,relatime)
proc on /proc type proc (rw,noatime)
sysfs on /sys type sysfs (rw,noatime)
tmpfs on /tmp type tmpfs (rw,nosuid,nodev,noatime)
/dev/ubi0_1 on /overlay type ubifs (rw,noatime)
overlayfs:/overlay on / type overlayfs (rw,noatime,lowerdir=/,upperdir=/overlay)
ubi1:syscfg on /tmp/syscfg type ubifs (rw,relatime)
tmpfs on /dev type tmpfs (rw,relatime,size=512k,mode=755)
devpts on /dev/pts type devpts (rw,relatime,mode=600)
debugfs on /sys/kernel/debug type debugfs (rw,noatime)</code></pre></div><p>Any help would be greatly appreciated!</p>											<p class="post-edited">(Last edited by <strong>tusc</strong> on 21 Nov 2014, 01:42)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p256767">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Hiro.AK47</div>
					<div class="post-datetime">
						6 Dec 2014, 10:33					</div>
				</div>
				<div class="post-content content">
					<p>Hi tusc,</p><p>I had met a same problem on NetGear WNDR4300.<br />I think extroot isn&#039;t considering ubifs.</p><p>Here is my monkey patch:<br /></p><div class="codebox"><pre><code>*** build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/CMakeLists.txt.orig   2014-11-23 15:16:26.000000000 +0900
--- build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/CMakeLists.txt        2014-12-06 11:24:03.393736772 +0900
***************
*** 48,54 ****
  INSTALL(TARGETS mount_root RUNTIME DESTINATION sbin)

  ADD_EXECUTABLE(block block.c)
! TARGET_LINK_LIBRARIES(block blkid-tiny uci ubox blobmsg_json)
  INSTALL(TARGETS block RUNTIME DESTINATION sbin)

  ADD_EXECUTABLE(jffs2reset jffs2reset.c)
--- 48,54 ----
  INSTALL(TARGETS mount_root RUNTIME DESTINATION sbin)

  ADD_EXECUTABLE(block block.c)
! TARGET_LINK_LIBRARIES(block blkid-tiny uci ubox blobmsg_json ubi-utils)
  INSTALL(TARGETS block RUNTIME DESTINATION sbin)

  ADD_EXECUTABLE(jffs2reset jffs2reset.c)
*** build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/block.c.orig  2014-11-23 15:16:26.000000000 +0900
--- build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/block.c       2014-12-06 16:19:51.085736772 +0900
***************
*** 35,40 ****
--- 35,41 ----
  #include &lt;libubox/avl-cmp.h&gt;

  #include &quot;libblkid-tiny/libblkid-tiny.h&quot;
+ #include &quot;libubi/libubi.h&quot;

  #define ERROR(fmt, ...) do { \
                syslog(LOG_ERR, fmt, ## __VA_ARGS__); \
***************
*** 822,834 ****
        return 0;
  }

  static int check_extroot(char *path)
  {
        struct blkid_struct_probe *pr = NULL;
        char fs[32];

!       if (find_block_mtd(&quot;rootfs&quot;, fs, sizeof(fs)))
!               return -1;

        list_for_each_entry(pr, &amp;devices, list) {
                if (!strcmp(pr-&gt;dev, fs)) {
--- 823,873 ----
        return 0;
  }

+ static int find_block_ubi(libubi_t libubi, char *name, char *ret)
+ {
+       int ubi = 0;
+       int i;
+
+         while (ubi_dev_present(libubi, ubi))
+         {
+                 struct ubi_dev_info dev_info;
+
+                 if (ubi_get_dev_info1(libubi, ubi++, &amp;dev_info))
+                         continue;
+
+               for (i = dev_info.lowest_vol_id; i&lt;= dev_info.highest_vol_id; i++)
+               {
+                       struct ubi_vol_info vol_info;
+
+                       if(ubi_get_vol_info1_nm(libubi, dev_info.dev_num, name, &amp;vol_info))
+                               continue;
+
+                       sprintf(ret, &quot;/dev/ubi%d_%d&quot;, dev_info.dev_num, vol_info.vol_id);
+
+                       return 0;
+               }
+         }
+
+         return -1;
+ }
+
  static int check_extroot(char *path)
  {
        struct blkid_struct_probe *pr = NULL;
        char fs[32];

!       if (find_block_mtd(&quot;rootfs&quot;, fs, sizeof(fs))) {
!               char ubi_dev[32] = { 0 };
!               libubi_t libubi;
!
!               libubi = libubi_open();
!               find_block_ubi(libubi, &quot;rootfs&quot;, ubi_dev);
!               libubi_close(libubi);
!               if (!ubi_dev[0])
!                       return -1;
!               strncpy(fs, &quot;/dev/ubiblock&quot;, sizeof(fs));
!               strncpy(fs + 13, ubi_dev + 8, sizeof(fs) - 13);
!       }

        list_for_each_entry(pr, &amp;devices, list) {
                if (!strcmp(pr-&gt;dev, fs)) {
***************
*** 929,937 ****
  static int main_extroot(int argc, char **argv)
  {
        struct blkid_struct_probe *pr;
!       char fs[32] = { 0 };
        char fs_data[32] = { 0 };
        int err = -1;

        if (!getenv(&quot;PREINIT&quot;))
                return -1;
--- 968,977 ----
  static int main_extroot(int argc, char **argv)
  {
        struct blkid_struct_probe *pr;
!       /* char fs[32] = { 0 }; */
        char fs_data[32] = { 0 };
        int err = -1;
+       libubi_t libubi;

        if (!getenv(&quot;PREINIT&quot;))
                return -1;
***************
*** 944,949 ****
--- 984,990 ----
        mkblkdev();
        cache_load(1);

+       /*
        find_block_mtd(&quot;rootfs&quot;, fs, sizeof(fs));
        if (!fs[0]) {
                ERROR(&quot;extroot: unable to locate rootfs mtdblock\n&quot;);
***************
*** 955,965 ****
--- 996,1009 ----
                ERROR(&quot;extroot: unable to retrieve rootfs information\n&quot;);
                return -3;
        }
+       */

        find_block_mtd(&quot;rootfs_data&quot;, fs_data, sizeof(fs_data));
        if (fs_data[0]) {
                pr = find_block_info(NULL, NULL, fs_data);
                if (pr &amp;&amp; !strcmp(pr-&gt;id-&gt;name, &quot;jffs2&quot;)) {
+                       /* ERROR(&quot;extroot: rootfs_data=%s\n&quot;, fs_data); */
+
                        char cfg[] = &quot;/tmp/jffs_cfg&quot;;

                        mkdir_p(cfg);
***************
*** 974,979 ****
--- 1018,1042 ----
                }
        }

+       memset(fs_data, 0, sizeof(fs_data));
+       libubi = libubi_open();
+       find_block_ubi(libubi, &quot;rootfs_data&quot;, fs_data);
+       libubi_close(libubi);
+       if (fs_data[0]) {
+               /* ERROR(&quot;extroot: rootfs_data=%s\n&quot;, fs_data); */
+
+               char cfg[] = &quot;/tmp/ubifs_cfg&quot;;
+               mkdir_p(cfg);
+               if (!mount(fs_data, cfg, &quot;ubifs&quot;, MS_NOATIME, NULL)) {
+                       err = mount_extroot(cfg);
+                       umount2(cfg, MNT_DETACH);
+               }
+               if (err &lt; 0)
+                       rmdir(&quot;/tmp/overlay&quot;);
+               rmdir(cfg);
+               return err;
+       }
+
        return mount_extroot(NULL);
  }</code></pre></div><p>And, /etc/config/fstab file is here:<br /></p><div class="codebox"><pre><code>config &#039;global&#039;
        option  anon_swap       &#039;0&#039;
        option  anon_mount      &#039;0&#039;
        option  auto_swap       &#039;1&#039;
        option  auto_mount      &#039;1&#039;
        option  delay_root      &#039;15&#039;
        option  check_fs        &#039;0&#039;

config &#039;mount&#039;
        option  target          &#039;/overlay&#039;
        option  uuid            &#039;f67b27e3-163f-4ded-8e32-e7c693591f6f&#039;
        option  fstype          &#039;ext4&#039;
        option  options         &#039;rw,sync,noatime,nodiratime&#039;
        option  enabled_fsck    &#039;1&#039;
        option  enabled         &#039;1&#039;</code></pre></div><p>Then, df output is this:<br /></p><div class="codebox"><pre><code>root@OpenWrt:/# df -h
Filesystem                Size      Used Available Use% Mounted on
rootfs                   28.8G     44.2M     27.3G   0% /
/dev/root                 3.3M      3.3M         0 100% /rom
tmpfs                    61.5M     56.0K     61.5M   0% /tmp
/dev/sda1                28.8G     44.2M     27.3G   0% /overlay
overlayfs:/overlay       28.8G     44.2M     27.3G   0% /
tmpfs                   512.0K         0    512.0K   0% /dev</code></pre></div><p>I have tested it only on my NetGear WNDR4300.<br />But, It maybe works on other ubifs HWs.</p><p>Try it!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p256769">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">Hiro.AK47</div>
					<div class="post-datetime">
						6 Dec 2014, 10:39					</div>
				</div>
				<div class="post-content content">
					<p>I forgot to say.<br />This patch works with both pivot root / pivot overlay.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p256800">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">geryhun</div>
					<div class="post-datetime">
						6 Dec 2014, 19:06					</div>
				</div>
				<div class="post-content content">
					<p>I have exactly the same issue with the same router model.</p><p>Mounting to &quot;/&quot; or &quot;/overlay&quot; does not work regardless of any settings specified in /etc/config/fstab.</p><p>Thanks for sharing the patch, Hiro.AK47!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p256955">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">Hiro.AK47</div>
					<div class="post-datetime">
						8 Dec 2014, 15:14					</div>
				</div>
				<div class="post-content content">
					<p>Hi all,</p><p>I refined previous patch.<br />More robuster and shorter.</p><p>I tested it only on my WNDR4300, and it will work with both pivot root / pivot overlay like before.</p><div class="codebox"><pre><code>--- build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/CMakeLists.txt.orig   2014-11-23 15:16:26.000000000 +0900
+++ build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/CMakeLists.txt        2014-12-06 11:24:03.393736772 +0900
@@ -48,7 +48,7 @@ TARGET_LINK_LIBRARIES(mount_root fstools
 INSTALL(TARGETS mount_root RUNTIME DESTINATION sbin)

 ADD_EXECUTABLE(block block.c)
-TARGET_LINK_LIBRARIES(block blkid-tiny uci ubox blobmsg_json)
+TARGET_LINK_LIBRARIES(block blkid-tiny uci ubox blobmsg_json ubi-utils)
 INSTALL(TARGETS block RUNTIME DESTINATION sbin)

 ADD_EXECUTABLE(jffs2reset jffs2reset.c)
--- build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/block.c.orig  2014-11-23 15:16:26.000000000 +0900
+++ build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/block.c       2014-12-08 19:42:52.906194992 +0900
@@ -35,6 +35,7 @@
 #include &lt;libubox/avl-cmp.h&gt;

 #include &quot;libblkid-tiny/libblkid-tiny.h&quot;
+#include &quot;libubi/libubi.h&quot;

 #define ERROR(fmt, ...) do { \
                syslog(LOG_ERR, fmt, ## __VA_ARGS__); \
@@ -822,13 +823,70 @@ static int find_block_mtd(char *name, ch
        return 0;
 }

+static int find_ubi_vol(libubi_t libubi, char *name, int *dev_num, int *vol_id)
+{
+       int dev = 0;
+
+       while (ubi_dev_present(libubi, dev))
+       {
+               struct ubi_dev_info dev_info;
+               struct ubi_vol_info vol_info;
+
+               if (ubi_get_dev_info1(libubi, dev++, &amp;dev_info))
+                       continue;
+               if (ubi_get_vol_info1_nm(libubi, dev_info.dev_num, name, &amp;vol_info))
+                       continue;
+
+               *dev_num = dev_info.dev_num;
+               *vol_id = vol_info.vol_id;
+
+               return 0;
+       }
+
+       return -1;
+}
+
+static int find_block_ubi(libubi_t libubi, char *name, char *part, int plen)
+{
+       int dev_num;
+       int vol_id;
+       int err = -1;
+
+       err = find_ubi_vol(libubi, name, &amp;dev_num, &amp;vol_id);
+       if (!err)
+               snprintf(part, plen, &quot;/dev/ubi%d_%d&quot;, dev_num, vol_id);
+
+       return err;
+}
+
+static int find_block_ubi_RO(libubi_t libubi, char *name, char *part, int plen)
+{
+       int dev_num;
+       int vol_id;
+       int err = -1;
+
+       err = find_ubi_vol(libubi, name, &amp;dev_num, &amp;vol_id);
+       if (!err)
+               snprintf(part, plen, &quot;/dev/ubiblock%d_%d&quot;, dev_num, vol_id);
+
+       return err;
+}
+
 static int check_extroot(char *path)
 {
        struct blkid_struct_probe *pr = NULL;
        char fs[32];

-       if (find_block_mtd(&quot;rootfs&quot;, fs, sizeof(fs)))
-               return -1;
+       if (find_block_mtd(&quot;rootfs&quot;, fs, sizeof(fs))) {
+               int err = -1;
+               libubi_t libubi;
+
+               libubi = libubi_open();
+               err = find_block_ubi_RO(libubi, &quot;rootfs&quot;, fs, sizeof(fs));
+               libubi_close(libubi);
+               if (err)
+                       return -1;
+       }

        list_for_each_entry(pr, &amp;devices, list) {
                if (!strcmp(pr-&gt;dev, fs)) {
@@ -932,6 +990,7 @@ static int main_extroot(int argc, char *
        char fs[32] = { 0 };
        char fs_data[32] = { 0 };
        int err = -1;
+       libubi_t libubi;

        if (!getenv(&quot;PREINIT&quot;))
                return -1;
@@ -946,8 +1005,13 @@ static int main_extroot(int argc, char *

        find_block_mtd(&quot;rootfs&quot;, fs, sizeof(fs));
        if (!fs[0]) {
-               ERROR(&quot;extroot: unable to locate rootfs mtdblock\n&quot;);
-               return -2;
+               libubi = libubi_open();
+               find_block_ubi_RO(libubi, &quot;rootfs&quot;, fs, sizeof(fs));
+               libubi_close(libubi);
+               if (!fs[0]) {
+                       ERROR(&quot;extroot: unable to locate rootfs mtdblock / ubiblock\n&quot;);
+                       return -2;
+               }
        }

        pr = find_block_info(NULL, NULL, fs);
@@ -974,6 +1038,24 @@ static int main_extroot(int argc, char *
                }
        }

+       memset(fs_data, 0, sizeof(fs_data));
+       libubi = libubi_open();
+       find_block_ubi(libubi, &quot;rootfs_data&quot;, fs_data, sizeof(fs_data));
+       libubi_close(libubi);
+       if (fs_data[0]) {
+               char cfg[] = &quot;/tmp/ubifs_cfg&quot;;
+
+               mkdir_p(cfg);
+               if (!mount(fs_data, cfg, &quot;ubifs&quot;, MS_NOATIME, NULL)) {
+                       err = mount_extroot(cfg);
+                       umount2(cfg, MNT_DETACH);
+               }
+               if (err &lt; 0)
+                       rmdir(&quot;/tmp/overlay&quot;);
+               rmdir(cfg);
+               return err;
+       }
+
        return mount_extroot(NULL);
 }</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p257518">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">geryhun</div>
					<div class="post-datetime">
						12 Dec 2014, 22:46					</div>
				</div>
				<div class="post-content content">
					<p>Thanks, Hiro.AK47, your patch works perfectly on my box, too. Tested with both overlay and pivot root mode, both work fine.</p><p>Here&#039;s an updated version of the patch to make it work with the master branch:</p><div class="codebox"><pre><code>diff -rupN fstools.old/block.c fstools.new/block.c
--- fstools.old/block.c    2014-12-12 17:32:23.833641055 +0100
+++ fstools.new/block.c    2014-12-12 17:36:59.532478289 +0100
@@ -35,6 +35,7 @@
 #include &lt;libubox/avl-cmp.h&gt;
 
 #include &quot;libblkid-tiny/libblkid-tiny.h&quot;
+#include &quot;libubi/libubi.h&quot;
 
 #define ERROR(fmt, ...) do { \
         syslog(LOG_ERR, fmt, ## __VA_ARGS__); \
@@ -823,13 +824,70 @@ static int find_block_mtd(char *name, ch
     return 0;
 }
 
+static int find_ubi_vol(libubi_t libubi, char *name, int *dev_num, int *vol_id)
+{
+       int dev = 0;
+
+       while (ubi_dev_present(libubi, dev))
+       {
+               struct ubi_dev_info dev_info;
+               struct ubi_vol_info vol_info;
+
+               if (ubi_get_dev_info1(libubi, dev++, &amp;dev_info))
+                       continue;
+               if (ubi_get_vol_info1_nm(libubi, dev_info.dev_num, name, &amp;vol_info))
+                       continue;
+
+               *dev_num = dev_info.dev_num;
+               *vol_id = vol_info.vol_id;
+
+               return 0;
+       }
+
+       return -1;
+}
+
+static int find_block_ubi(libubi_t libubi, char *name, char *part, int plen)
+{
+       int dev_num;
+       int vol_id;
+       int err = -1;
+
+       err = find_ubi_vol(libubi, name, &amp;dev_num, &amp;vol_id);
+       if (!err)
+               snprintf(part, plen, &quot;/dev/ubi%d_%d&quot;, dev_num, vol_id);
+
+       return err;
+}
+
+static int find_block_ubi_RO(libubi_t libubi, char *name, char *part, int plen)
+{
+       int dev_num;
+       int vol_id;
+       int err = -1;
+
+       err = find_ubi_vol(libubi, name, &amp;dev_num, &amp;vol_id);
+       if (!err)
+               snprintf(part, plen, &quot;/dev/ubiblock%d_%d&quot;, dev_num, vol_id);
+
+       return err;
+}
+
 static int check_extroot(char *path)
 {
     struct blkid_struct_probe *pr = NULL;
     char fs[32];
 
-    if (find_block_mtd(&quot;rootfs&quot;, fs, sizeof(fs)))
-        return -1;
+       if (find_block_mtd(&quot;rootfs&quot;, fs, sizeof(fs))) {
+               int err = -1;
+               libubi_t libubi;
+
+               libubi = libubi_open();
+               err = find_block_ubi_RO(libubi, &quot;rootfs&quot;, fs, sizeof(fs));
+               libubi_close(libubi);
+               if (err)
+                       return -1;
+       }
 
     list_for_each_entry(pr, &amp;devices, list) {
         if (!strcmp(pr-&gt;dev, fs)) {
@@ -933,6 +991,7 @@ static int main_extroot(int argc, char *
     char fs[32] = { 0 };
     char fs_data[32] = { 0 };
     int err = -1;
+    libubi_t libubi;
 
     if (!getenv(&quot;PREINIT&quot;))
         return -1;
@@ -947,8 +1006,13 @@ static int main_extroot(int argc, char *
 
     find_block_mtd(&quot;rootfs&quot;, fs, sizeof(fs));
     if (!fs[0]) {
-        ERROR(&quot;extroot: unable to locate rootfs mtdblock\n&quot;);
-        return -2;
+               libubi = libubi_open();
+               find_block_ubi_RO(libubi, &quot;rootfs&quot;, fs, sizeof(fs));
+               libubi_close(libubi);
+               if (!fs[0]) {
+                       ERROR(&quot;extroot: unable to locate rootfs mtdblock / ubiblock\n&quot;);
+                       return -2;
+               }
     }
 
     pr = find_block_info(NULL, NULL, fs);
@@ -975,6 +1039,24 @@ static int main_extroot(int argc, char *
         }
     }
 
+       memset(fs_data, 0, sizeof(fs_data));
+       libubi = libubi_open();
+       find_block_ubi(libubi, &quot;rootfs_data&quot;, fs_data, sizeof(fs_data));
+       libubi_close(libubi);
+       if (fs_data[0]) {
+               char cfg[] = &quot;/tmp/ubifs_cfg&quot;;
+
+               mkdir_p(cfg);
+               if (!mount(fs_data, cfg, &quot;ubifs&quot;, MS_NOATIME, NULL)) {
+                       err = mount_extroot(cfg);
+                       umount2(cfg, MNT_DETACH);
+               }
+               if (err &lt; 0)
+                       rmdir(&quot;/tmp/overlay&quot;);
+               rmdir(cfg);
+               return err;
+       }
+
     return mount_extroot(NULL);
 }
 
diff -rupN fstools.old/CMakeLists.txt fstools.new/CMakeLists.txt
--- fstools.old/CMakeLists.txt    2014-12-12 17:32:23.833641055 +0100
+++ fstools.new/CMakeLists.txt    2014-12-12 17:31:48.729637303 +0100
@@ -48,7 +48,7 @@ TARGET_LINK_LIBRARIES(mount_root fstools
 INSTALL(TARGETS mount_root RUNTIME DESTINATION sbin)
 
 ADD_EXECUTABLE(block block.c)
-TARGET_LINK_LIBRARIES(block blkid-tiny uci ubox blobmsg_json)
+TARGET_LINK_LIBRARIES(block blkid-tiny uci ubox blobmsg_json ubi-utils)
 INSTALL(TARGETS block RUNTIME DESTINATION sbin)
 
 ADD_EXECUTABLE(jffs2reset jffs2reset.c)</code></pre></div><p>Your modifications seem to be generic enough so I guess this could be pulled into the master branch as a patch for the fstools package.</p><p>I&#039;m going to create a properly formatted patch with quilt and send that to the devs, indicating - of course - that the patch was provided by you originally.</p><p>Thanks, again!</p>											<p class="post-edited">(Last edited by <strong>geryhun</strong> on 12 Dec 2014, 22:48)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258397">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">Hiro.AK47</div>
					<div class="post-datetime">
						22 Dec 2014, 07:06					</div>
				</div>
				<div class="post-content content">
					<p>Hi geryhun,</p><p>You&#039;re welcome.<br />Thank you for committing patch!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258403">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">Zajec</div>
					<div class="post-datetime">
						22 Dec 2014, 09:16					</div>
				</div>
				<div class="post-content content">
					<p>Just wanted to clarify one thing about this thread. Its name was really confusing for me.</p><p>What you did/discussed there was support for *reading* extroot configuration from ubifs &quot;rootfs_data&quot; partition. It was *not* about using some &quot;ubifs&quot; partition *as* extroot.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p259065">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">tusc</div>
					<div class="post-datetime">
						29 Dec 2014, 17:39					</div>
				</div>
				<div class="post-content content">
					<p>@Zajec,</p><p>given the clarification, has this patch been applied to trunk? Thanks.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p259066">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">Zajec</div>
					<div class="post-datetime">
						29 Dec 2014, 17:41					</div>
				</div>
				<div class="post-content content">
					<p>Support for reading configuration from &quot;rootfs_data&quot; UBI volume has been added to the fstools directly, see:<br /><a href="http://nbd.name/gitweb.cgi?p=fstools.git;a=commitdiff;h=83cf8896a598fb9fc58da0a9bb4f137695f78853">http://nbd.name/gitweb.cgi?p=fstools.gi … 7695f78853</a></p><p>My patches adding support for using UBI volume with ubifs as overlay were not accepted yet.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p262652">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">8ce881ca</div>
					<div class="post-datetime">
						24 Jan 2015, 13:51					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Hiro.AK47 wrote:</cite><blockquote><p>Hi all,</p><p>I refined previous patch.<br />More robuster and shorter.</p><p>I tested it only on my WNDR4300, and it will work with both pivot root / pivot overlay like before.</p><div class="codebox"><pre><code>--- build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/CMakeLists.txt.orig   2014-11-23 15:16:26.000000000 +0900
+++ build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/CMakeLists.txt        2014-12-06 11:24:03.393736772 +0900
@@ -48,7 +48,7 @@ TARGET_LINK_LIBRARIES(mount_root fstools
 INSTALL(TARGETS mount_root RUNTIME DESTINATION sbin)

 ADD_EXECUTABLE(block block.c)
-TARGET_LINK_LIBRARIES(block blkid-tiny uci ubox blobmsg_json)
+TARGET_LINK_LIBRARIES(block blkid-tiny uci ubox blobmsg_json ubi-utils)
 INSTALL(TARGETS block RUNTIME DESTINATION sbin)

 ADD_EXECUTABLE(jffs2reset jffs2reset.c)
--- build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/block.c.orig  2014-11-23 15:16:26.000000000 +0900
+++ build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/block.c       2014-12-08 19:42:52.906194992 +0900
@@ -35,6 +35,7 @@
 #include &lt;libubox/avl-cmp.h&gt;

 #include &quot;libblkid-tiny/libblkid-tiny.h&quot;
+#include &quot;libubi/libubi.h&quot;

 #define ERROR(fmt, ...) do { \
                syslog(LOG_ERR, fmt, ## __VA_ARGS__); \
@@ -822,13 +823,70 @@ static int find_block_mtd(char *name, ch
        return 0;
 }

+static int find_ubi_vol(libubi_t libubi, char *name, int *dev_num, int *vol_id)
+{
+       int dev = 0;
+
+       while (ubi_dev_present(libubi, dev))
+       {
+               struct ubi_dev_info dev_info;
+               struct ubi_vol_info vol_info;
+
+               if (ubi_get_dev_info1(libubi, dev++, &amp;dev_info))
+                       continue;
+               if (ubi_get_vol_info1_nm(libubi, dev_info.dev_num, name, &amp;vol_info))
+                       continue;
+
+               *dev_num = dev_info.dev_num;
+               *vol_id = vol_info.vol_id;
+
+               return 0;
+       }
+
+       return -1;
+}
+
+static int find_block_ubi(libubi_t libubi, char *name, char *part, int plen)
+{
+       int dev_num;
+       int vol_id;
+       int err = -1;
+
+       err = find_ubi_vol(libubi, name, &amp;dev_num, &amp;vol_id);
+       if (!err)
+               snprintf(part, plen, &quot;/dev/ubi%d_%d&quot;, dev_num, vol_id);
+
+       return err;
+}
+
+static int find_block_ubi_RO(libubi_t libubi, char *name, char *part, int plen)
+{
+       int dev_num;
+       int vol_id;
+       int err = -1;
+
+       err = find_ubi_vol(libubi, name, &amp;dev_num, &amp;vol_id);
+       if (!err)
+               snprintf(part, plen, &quot;/dev/ubiblock%d_%d&quot;, dev_num, vol_id);
+
+       return err;
+}
+
 static int check_extroot(char *path)
 {
        struct blkid_struct_probe *pr = NULL;
        char fs[32];

-       if (find_block_mtd(&quot;rootfs&quot;, fs, sizeof(fs)))
-               return -1;
+       if (find_block_mtd(&quot;rootfs&quot;, fs, sizeof(fs))) {
+               int err = -1;
+               libubi_t libubi;
+
+               libubi = libubi_open();
+               err = find_block_ubi_RO(libubi, &quot;rootfs&quot;, fs, sizeof(fs));
+               libubi_close(libubi);
+               if (err)
+                       return -1;
+       }

        list_for_each_entry(pr, &amp;devices, list) {
                if (!strcmp(pr-&gt;dev, fs)) {
@@ -932,6 +990,7 @@ static int main_extroot(int argc, char *
        char fs[32] = { 0 };
        char fs_data[32] = { 0 };
        int err = -1;
+       libubi_t libubi;

        if (!getenv(&quot;PREINIT&quot;))
                return -1;
@@ -946,8 +1005,13 @@ static int main_extroot(int argc, char *

        find_block_mtd(&quot;rootfs&quot;, fs, sizeof(fs));
        if (!fs[0]) {
-               ERROR(&quot;extroot: unable to locate rootfs mtdblock\n&quot;);
-               return -2;
+               libubi = libubi_open();
+               find_block_ubi_RO(libubi, &quot;rootfs&quot;, fs, sizeof(fs));
+               libubi_close(libubi);
+               if (!fs[0]) {
+                       ERROR(&quot;extroot: unable to locate rootfs mtdblock / ubiblock\n&quot;);
+                       return -2;
+               }
        }

        pr = find_block_info(NULL, NULL, fs);
@@ -974,6 +1038,24 @@ static int main_extroot(int argc, char *
                }
        }

+       memset(fs_data, 0, sizeof(fs_data));
+       libubi = libubi_open();
+       find_block_ubi(libubi, &quot;rootfs_data&quot;, fs_data, sizeof(fs_data));
+       libubi_close(libubi);
+       if (fs_data[0]) {
+               char cfg[] = &quot;/tmp/ubifs_cfg&quot;;
+
+               mkdir_p(cfg);
+               if (!mount(fs_data, cfg, &quot;ubifs&quot;, MS_NOATIME, NULL)) {
+                       err = mount_extroot(cfg);
+                       umount2(cfg, MNT_DETACH);
+               }
+               if (err &lt; 0)
+                       rmdir(&quot;/tmp/overlay&quot;);
+               rmdir(cfg);
+               return err;
+       }
+
        return mount_extroot(NULL);
 }</code></pre></div></blockquote></div><p>@Hiro.AK47, hoping you can help.. I&#039;m trying to apply your patch to my WNDR4300 in BreakerBarrier but get the following error : </p><p>Applying patch platform/903-extroot_fix.patch<br />can&#039;t find file to patch at input line 3<br />Perhaps you used the wrong -p or --strip option?<br />The text leading up to this was:<br />--------------------------<br />|--- build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/CMakeLists.txt.orig&nbsp; &nbsp;2014-11-23 15:16:26.000000000 +0900<br />|+++ build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/CMakeLists.txt&nbsp; &nbsp; &nbsp; &nbsp; 2014-12-06 11:24:03.393736772 +0900<br />--------------------------<br />No file to patch.&nbsp; Skipping patch.<br />1 out of 1 hunk ignored<br />can&#039;t find file to patch at input line 14<br />Perhaps you used the wrong -p or --strip option?<br />The text leading up to this was:<br />--------------------------<br />|--- build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/block.c.orig&nbsp; 2014-11-23 15:16:26.000000000 +0900<br />|+++ build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/block.c&nbsp; &nbsp; &nbsp; &nbsp;2014-12-08 19:42:52.906194992 +0900<br />--------------------------<br />No file to patch.&nbsp; Skipping patch.</p><br /><br /><p>If I look at line 14 in your patch file, it references &quot;build_dir/target-mips_34kc_uClibc-0.9.33.2/fstools-2014-06-22/block.c.orig&quot;.&nbsp; However, I don&#039;t have a /fstools-... path at that location but I do have fstools selected as a package in make menuconfig.</p><p>Any ideas?&nbsp; I REALLY appreciate any help you or anyone else can provide on this.&nbsp; Thanks so much!</p>											<p class="post-edited">(Last edited by <strong>8ce881ca</strong> on 24 Jan 2015, 13:53)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p266232">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">tangsoft</div>
					<div class="post-datetime">
						20 Feb 2015, 09:18					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>tusc wrote:</cite><blockquote><p>@Zajec,</p><p>given the clarification, has this patch been applied to trunk? Thanks.</p></blockquote></div><p>@tusc，do you finally figure out getting pivot root working on CC of wrt1900ac?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p266961">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">tangsoft</div>
					<div class="post-datetime">
						26 Feb 2015, 14:17					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>tangsoft wrote:</cite><blockquote><div class="quotebox"><cite>tusc wrote:</cite><blockquote><p>@Zajec,</p><p>given the clarification, has this patch been applied to trunk? Thanks.</p></blockquote></div><p>@tusc，do you finally figure out getting pivot root working on CC of wrt1900ac?</p></blockquote></div><p>Hi,@tusc, as you may knew, it looks like Jow fixed the ubifs extroot bug in trunk44538, I get extroot running on my wrt1900ac.</p><p>------------------------------------------</p><br /><p>BusyBox v1.22.1 (2015-02-26 17:07:50 CST) built-in shell (ash)<br />Enter &#039;help&#039; for a list of built-in commands.</p><p>&nbsp; _______&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;________&nbsp; &nbsp; &nbsp; &nbsp; __<br /> |&nbsp; &nbsp; &nbsp; &nbsp;|.-----.-----.-----.|&nbsp; |&nbsp; |&nbsp; |.----.|&nbsp; |_<br /> |&nbsp; &nbsp;-&nbsp; &nbsp;||&nbsp; _&nbsp; |&nbsp; -__|&nbsp; &nbsp; &nbsp;||&nbsp; |&nbsp; |&nbsp; ||&nbsp; &nbsp;_||&nbsp; &nbsp;_|<br /> |_______||&nbsp; &nbsp;__|_____|__|__||________||__|&nbsp; |____|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |__| W I R E L E S S&nbsp; &nbsp;F R E E D O M<br /> -----------------------------------------------------<br /> CHAOS CALMER (Bleeding Edge, r44541)<br /> -----------------------------------------------------</p><p>&nbsp; * 1 1/2 oz Gin&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Shake with a glassful<br />&nbsp; * 1/4 oz Triple Sec&nbsp; &nbsp; &nbsp; &nbsp;of broken ice and pour<br />&nbsp; * 3/4 oz Lime Juice&nbsp; &nbsp; &nbsp; &nbsp;unstrained into a goblet.<br />&nbsp; * 1 1/2 oz Orange Juice<br />&nbsp; * 1 tsp. Grenadine Syrup<br /> -----------------------------------------------------<br />root@OpenWrt:/# df -h<br />Filesystem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Size&nbsp; &nbsp; &nbsp; Used Available Use% Mounted on<br />rootfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;28.4G&nbsp; &nbsp; &nbsp;53.5M&nbsp; &nbsp; &nbsp;26.9G&nbsp; &nbsp;0% /<br />/dev/root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2.8M&nbsp; &nbsp; &nbsp; 2.8M&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 100% /rom<br />tmpfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;124.8M&nbsp; &nbsp; &nbsp;64.0K&nbsp; &nbsp; 124.7M&nbsp; &nbsp;0% /tmp<br />/dev/sda1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 28.4G&nbsp; &nbsp; &nbsp;53.5M&nbsp; &nbsp; &nbsp;26.9G&nbsp; &nbsp;0% /<br />ubi1:syscfg&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 30.8M&nbsp; &nbsp; 248.0K&nbsp; &nbsp; &nbsp;28.9M&nbsp; &nbsp;1% /tmp/syscfg<br />tmpfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;512.0K&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; 512.0K&nbsp; &nbsp;0% /dev</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p269815">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">_superpops_</div>
					<div class="post-datetime">
						24 Mar 2015, 16:45					</div>
				</div>
				<div class="post-content content">
					<p>So I&#039;m a newbie to OpenWRT.&nbsp; I have a Netgear WNDR4300 (v1) that I flashed with Barrier Breaker (14.07, r42625) via <a href="https://downloads.openwrt.org/barrier_breaker/14.07/ar71xx/nand/openwrt-ar71xx-nand-wndr4300-ubi-factory.img">https://downloads.openwrt.org/barrier_b … actory.img</a></p><p>I&#039;m getting the same error in that my USB drive mounts to /mnt/sda2 instead of /overlay because /dev/ubi0_1 is already mounted to /overlay.&nbsp; I understand from reading the thread that there is a patch to fix this but I&#039;m not sure 1) where to get the patch 2) how to apply the patch.&nbsp; Can someone please help?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p276658">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">valentt</div>
					<div class="post-datetime">
						18 May 2015, 17:44					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Zajec wrote:</cite><blockquote><p>Support for reading configuration from &quot;rootfs_data&quot; UBI volume has been added to the fstools directly, see:<br /><a href="http://nbd.name/gitweb.cgi?p=fstools.git;a=commitdiff;h=83cf8896a598fb9fc58da0a9bb4f137695f78853">http://nbd.name/gitweb.cgi?p=fstools.gi … 7695f78853</a></p><p>My patches adding support for using UBI volume with ubifs as overlay were not accepted yet.</p></blockquote></div><p>What is the status with patches with support for UBI/UBIFS ?</p><p>I downloaded latest OpenWrt git sources and don&#039;t see such option in Buildroot menuconfig, so any information is much appreciated.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p276659">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">valentt</div>
					<div class="post-datetime">
						18 May 2015, 17:46					</div>
				</div>
				<div class="post-content content">
					<p>WIKI says that UBIFS is used for OpenWrt NAND targets [1], then please enable UBIFS also as an option for NOR flash targets also.</p><p>[1] <a href="http://wiki.openwrt.org/doc/techref/filesystems#ubifs">http://wiki.openwrt.org/doc/techref/filesystems#ubifs</a></p>											<p class="post-edited">(Last edited by <strong>valentt</strong> on 18 May 2015, 17:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p276660">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">Zajec</div>
					<div class="post-datetime">
						18 May 2015, 17:49					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>valentt wrote:</cite><blockquote><div class="quotebox"><cite>Zajec wrote:</cite><blockquote><p>Support for reading configuration from &quot;rootfs_data&quot; UBI volume has been added to the fstools directly, see:<br /><a href="http://nbd.name/gitweb.cgi?p=fstools.git;a=commitdiff;h=83cf8896a598fb9fc58da0a9bb4f137695f78853">http://nbd.name/gitweb.cgi?p=fstools.gi … 7695f78853</a></p><p>My patches adding support for using UBI volume with ubifs as overlay were not accepted yet.</p></blockquote></div><p>What is the status with patches with support for UBI/UBIFS ?</p></blockquote></div><p><a href="http://nbd.name/gitweb.cgi?p=fstools.git;a=shortlog">http://nbd.name/gitweb.cgi?p=fstools.git;a=shortlog</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p276661">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">valentt</div>
					<div class="post-datetime">
						18 May 2015, 18:09					</div>
				</div>
				<div class="post-content content">
					<p>@Zajec I see your patched are signed off, so they should be applied to latest trunk, right?</p><p>Please just clarify how to enable UBI/UBIFS for example - for ar71xx targets. I started menuconfig and expected to have UBIFS option for root filesystem but can&#039;t find it. Can you please clarify. Thanks.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p276662">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">Zajec</div>
					<div class="post-datetime">
						18 May 2015, 18:12					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>valentt wrote:</cite><blockquote><p>@Zajec I see your patched are signed off, so they should be applied to latest trunk, right?</p></blockquote></div><p>Signing patches doesn&#039;t imply having them accepted anyhow. But yes, my patches were accepted.</p><div class="quotebox"><cite>valentt wrote:</cite><blockquote><p>Please just clarify how to enable UBI/UBIFS for example - for ar71xx targets. I started menuconfig and expected to have UBIFS option for root filesystem but can&#039;t find it. Can you please clarify. Thanks.</p></blockquote></div><p>I don&#039;t think you really understand UBI / UBIFS / rootfs / overlay or at least your questions aren&#039;t clear enough. This thread was already messy (using UBIFS as overlay vs. reading overlay info from UBIFS volume). I can only guess you want to achieve something even else and your question probably doesn&#039;t belong to this thread at all (hint: create new thread, DESCRIBE what do you want).</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>