<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> mwan3; multi-wan policy routing (general topic)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 22 May 2013 and 6 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 43 of 65</div><nav><ul><li><a href="viewtopic.php%3Fid=39052&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=41.html">41</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=42.html">42</a></li><li class="pagination-current"><span>43</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=44.html">44</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=45.html">45</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p258042">
				<div class="post-metadata">
					<div class="post-num">Post #1051</div>
					<div class="post-author">spock</div>
					<div class="post-datetime">
						18 Dec 2014, 12:59					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for taking your time to help me Adze, it&#039;s greatly appreciated!</p><p>I think you cracked it with &quot;to which address are you trying to connect?&quot;.</p><p>All this time I was trying to connect to my main static ip pppoe-wan connection which would either time out or give &quot;connection refused&quot;.</p><p>When I tested nat reflection towards the IP address assigned to the ds-lite (pseudo-wan) interface, it worked just fine.</p><p>That&#039;s a problem however, the ds-lite address is non globably routable, and only a point to point link for translating IPv6 to IPv4 with carrier grade nat on the other end, so it doesnt help me much, the nat reflection shouldn&#039;t happen on that IP.</p><p>How would I go about telling mwan3 that my static WAN ip through pppoe is the one I want for nat reflection?</p>											<p class="post-edited">(Last edited by <strong>spock</strong> on 18 Dec 2014, 12:59)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258043">
				<div class="post-metadata">
					<div class="post-num">Post #1052</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						18 Dec 2014, 13:10					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>spock wrote:</cite><blockquote><p>How would I go about telling mwan3 that my static WAN ip through pppoe is the one I want for nat reflection?</p></blockquote></div><p>Would this ip be the &quot;213.16.246.19&quot;? If yes, no extra mwan3 config should be needed... It is not needed for all addresses listed in table mwan3_connected.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258044">
				<div class="post-metadata">
					<div class="post-num">Post #1053</div>
					<div class="post-author">spock</div>
					<div class="post-datetime">
						18 Dec 2014, 13:20					</div>
				</div>
				<div class="post-content content">
					<p>As for some more oddity, by a coincidence I tried to connect to the pppoe wan static ip with &#039;telnet &lt;public-ip&gt; 25&#039;, and it worked. Scratching my head I decided to reboot the router and now it doesn&#039;t work again.</p><p>Can there be something going on with routing/conntrack?</p>											<p class="post-edited">(Last edited by <strong>spock</strong> on 18 Dec 2014, 13:52)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258045">
				<div class="post-metadata">
					<div class="post-num">Post #1054</div>
					<div class="post-author">spock</div>
					<div class="post-datetime">
						18 Dec 2014, 13:22					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><div class="quotebox"><cite>spock wrote:</cite><blockquote><p>How would I go about telling mwan3 that my static WAN ip through pppoe is the one I want for nat reflection?</p></blockquote></div><p>Would this ip be the &quot;213.16.246.19&quot;? If yes, no extra mwan3 config should be needed... It is not needed for all addresses listed in table mwan3_connected.</p></blockquote></div><br /><p>213.16.246.19 is the bbras of my isp, not my routers public ip.</p><br /><p>Right now, when trying to connect to my public wan ip, it just seems to send packets to a black hole, telnet stalls and nothing happen, no errors reported at all, until eventually I get &quot;connection timed out&quot;.</p>											<p class="post-edited">(Last edited by <strong>spock</strong> on 18 Dec 2014, 13:24)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258048">
				<div class="post-metadata">
					<div class="post-num">Post #1055</div>
					<div class="post-author">spock</div>
					<div class="post-datetime">
						18 Dec 2014, 14:00					</div>
				</div>
				<div class="post-content content">
					<p>tcpdump running on the router doesn&#039;t really reveal anything of interest either. unless you know some better tcpdump-fu I haven&#039;t tried yet.</p><p>and tcpdump running on the dmz server doesn&#039;t even see incoming packets when the client in the main subnet tries to access the public ip for nat reflection. so it stops within the router.</p><br /><p>edit: tcpdump running on the dmzserver when the client in the main subnet does &#039;telnet &lt;wan2(192.0.0.2)&gt; 25&#039; show up normally though.</p><p>It&#039;s like mwan3 just doesnt want to reflect from the real pppoe-wan IP.</p>											<p class="post-edited">(Last edited by <strong>spock</strong> on 18 Dec 2014, 14:14)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258050">
				<div class="post-metadata">
					<div class="post-num">Post #1056</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						18 Dec 2014, 14:11					</div>
				</div>
				<div class="post-content content">
					<p>Is the address which you try to connnect to listed in table mwan3_connected? If not, could you post &quot;ip route&quot; and &quot;iptables -L mwan3_connected -t mangle -v -n&quot;? Thnx!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258052">
				<div class="post-metadata">
					<div class="post-num">Post #1057</div>
					<div class="post-author">spock</div>
					<div class="post-datetime">
						18 Dec 2014, 14:17					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Is the address which you try to connnect to listed in table mwan3_connected? If not, could you post &quot;ip route&quot; and &quot;iptables -L mwan3_connected -t mangle -v -n&quot;? Thnx!</p></blockquote></div><div class="codebox"><pre><code>root@dexter:~# ip route
default dev dslite-wan2  proto static  scope link  metric 20 
default via 213.16.246.19 dev pppoe-wan  proto static  metric 30 
10.xx.xx.0/24 dev br-lan  proto kernel  scope link  src 10.xx.xx.1 
10.xx.xx.0/24 dev eth0.3  proto kernel  scope link  src 10.xx.xx.1 
192.0.0.1 dev dslite-wan2  proto kernel  scope link  src 192.0.0.2 
192.0.0.2 dev dslite-wan2  proto static  scope link  metric 20 
192.168.1.0/24 dev eth0.2  proto kernel  scope link  src 192.168.1.10 
213.16.246.19 dev pppoe-wan  proto kernel  scope link  src 193.92.181.xx</code></pre></div><div class="codebox"><pre><code>root@dexter:~# iptables -L mwan3_connected -t mangle -v -n
Chain mwan3_connected (2 references)
 pkts bytes target     prot opt in     out     source               destination         
   42  3042 MARK       all  --  *      *       0.0.0.0/0            127.0.0.0/8          MARK or 0xff00
  197 29813 MARK       all  --  *      *       0.0.0.0/0            224.0.0.0/3          MARK or 0xff00
  768  158K MARK       all  --  *      *       0.0.0.0/0            10.xx.xx.0/24        MARK or 0xff00
    9   540 MARK       all  --  *      *       0.0.0.0/0            10.xx.xx.0/24       MARK or 0xff00
    0     0 MARK       all  --  *      *       0.0.0.0/0            192.0.0.1            MARK or 0xff00
  386 28894 MARK       all  --  *      *       0.0.0.0/0            192.0.0.2            MARK or 0xff00
    0     0 MARK       all  --  *      *       0.0.0.0/0            192.168.1.0/24       MARK or 0xff00
    0     0 MARK       all  --  *      *       0.0.0.0/0            213.16.246.19        MARK or 0xff00</code></pre></div><p>The static IP is 193.92.181.xx</p><p>Again, thanks for your time!</p>											<p class="post-edited">(Last edited by <strong>spock</strong> on 18 Dec 2014, 14:20)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258053">
				<div class="post-metadata">
					<div class="post-num">Post #1058</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						18 Dec 2014, 14:28					</div>
				</div>
				<div class="post-content content">
					<p>Hmm. Pretty strange. There is no entry for 193.92.181.xx in the routing table. Never seen that before.</p><p>What does &quot;ip route get 193.92.181.xx&quot; say?</p><p>If you were to add it yourself &quot;ip addr add 193.92.181.xx/32 dev pppoe-wan&quot; and then &quot;mwan3 restart&quot;. Does this work?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258055">
				<div class="post-metadata">
					<div class="post-num">Post #1059</div>
					<div class="post-author">spock</div>
					<div class="post-datetime">
						18 Dec 2014, 14:40					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hmm. Pretty strange. There is no entry for 193.92.181.xx in the routing table. Never seen that before.</p><p>What does &quot;ip route get 193.92.181.xx&quot; say?</p><p>If you were to add it yourself &quot;ip addr add 193.92.181.xx/32 dev pppoe-wan&quot; and then &quot;mwan3 restart&quot;. Does this work?</p></blockquote></div><br /><p>Notice how the first hop bbras IP (213.16.246.19) is listed in mwan3_connected table, instead of my static ip?</p><div class="codebox"><pre><code>root@dexter:~# ip route get 193.92.181.xx
local 193.92.181.xx dev lo  src 193.92.181.xx
    cache &lt;local&gt; </code></pre></div><p>this: &quot;ip addr add 193.92.181.xx/32 dev pppoe-wan&quot; made no difference to the routing table or functionality after mwan3 restart.</p><br /><p>can this all be pppoe related? or perhaps something more general in how openwrt/netifd(?) handles things?</p><br /><br /><br /><p>edit: just to clarify I&#039;m not a dumbo here, I&#039;m replacing the identifiable IP&#039;s with xx for peace of mind. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>											<p class="post-edited">(Last edited by <strong>spock</strong> on 18 Dec 2014, 14:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258057">
				<div class="post-metadata">
					<div class="post-num">Post #1060</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						18 Dec 2014, 14:54					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>spock wrote:</cite><blockquote><p>edit: just to clarify I&#039;m not a dumbo here, I&#039;m replacing the identifiable IP&#039;s with xx for peace of mind. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></blockquote></div><p>Oh, i can tell.. <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" />&nbsp; Never said you were!&nbsp; <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>I have to look into this. In the mean time you can use the workaround i posted earlier (create an extra mwan3 rule).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258058">
				<div class="post-metadata">
					<div class="post-num">Post #1061</div>
					<div class="post-author">spock</div>
					<div class="post-datetime">
						18 Dec 2014, 15:07					</div>
				</div>
				<div class="post-content content">
					<p>That sounds great, I&#039;ll stick with the workaround for now.</p><p>Again, many thanks for helping!</p><br /><p>edit: I just noticed something curious, a traceroute from router has just started timing out on the first hop:<br /></p><div class="codebox"><pre><code>traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 38 byte packets
 1  *  *  *
 2  te0-5-0-2.distr-kln-01.forthnet.gr (194.219.199.113)  13.367 ms  12.171 ms  12.851 ms
 3  core-kln-12Be2.forthnet.gr (213.16.247.13)  20.415 ms  22.871 ms  core-kln-13Be3.forthnet.gr (213.16.247.21)  20.596 ms
 4  core-lsf-08XE-0-0-1.forthnet.gr (212.251.94.18)  41.958 ms  21.857 ms  19.026 ms
 5  74.125.48.74 (74.125.48.74)  23.755 ms  24.430 ms  23.974 ms
 6  72.14.235.45 (72.14.235.45)  23.773 ms  23.859 ms  24.025 ms
 7  google-public-dns-a.google.com (8.8.8.8)  23.753 ms  23.956 ms  24.007 ms</code></pre></div><p>Not sure if it&#039;s related. But it&#039;s odd never the less. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>											<p class="post-edited">(Last edited by <strong>spock</strong> on 18 Dec 2014, 15:16)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258091">
				<div class="post-metadata">
					<div class="post-num">Post #1062</div>
					<div class="post-author">spock</div>
					<div class="post-datetime">
						18 Dec 2014, 23:03					</div>
				</div>
				<div class="post-content content">
					<p>After some more tinkering I figured out a second way to fix it:</p><div class="codebox"><pre><code>iptables -A mwan3_connected -t mangle -d aa.bb.cc.dd/32 -j MARK --set-xmark 0xff00/0xff00</code></pre></div><p>After the above command everything works as expected.</p><p>I think somewhere the mwan3 scripts fails to pick the real pppoe-wan IP address and instead chooses to use the one of the bbras. This must be pppoe-related dont you think?</p><div class="codebox"><pre><code>root@dexter:~# iptables -L mwan3_connected -t mangle -v
Chain mwan3_connected (2 references)
 pkts bytes target     prot opt in     out     source               destination         
   15  1074 MARK       all  --  any    any     anywhere             127.0.0.0/8          MARK or 0xff00
   89 13677 MARK       all  --  any    any     anywhere             base-address.mcast.net/3  MARK or 0xff00
  394  296K MARK       all  --  any    any     anywhere             10.xx.xx.0/24        MARK or 0xff00
    0     0 MARK       all  --  any    any     anywhere             10.xx.xx.0/24       MARK or 0xff00
    0     0 MARK       all  --  any    any     anywhere             192.0.0.1            MARK or 0xff00
  114  3648 MARK       all  --  any    any     anywhere             192.0.0.2            MARK or 0xff00
    0     0 MARK       all  --  any    any     anywhere             192.168.1.0/24       MARK or 0xff00
    0     0 MARK       all  --  any    any     anywhere             bbras-llu-ath-02L500.forthnet.gr  MARK or 0xff00</code></pre></div>											<p class="post-edited">(Last edited by <strong>spock</strong> on 18 Dec 2014, 23:05)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258128">
				<div class="post-metadata">
					<div class="post-num">Post #1063</div>
					<div class="post-author">spock</div>
					<div class="post-datetime">
						19 Dec 2014, 12:43					</div>
				</div>
				<div class="post-content content">
					<p>Spent some more time on this today.</p><p>I think I figured out why &#039;mwan3 start&#039; spews out some errors. my wan ipaddr is not listed in uci, I&#039;m guessing due to the fact that it&#039;s not a &quot;real&quot; interface but actually pppoe.</p><p>I&#039;m guessing mwan3 pulls device-local ip addresses from there?</p><p>Look at this:<br /></p><div class="codebox"><pre><code>root@dexter:/etc/config# uci show |grep ipaddr
uci: Entry not found
uci: Entry not found
network.loopback.ipaddr=127.0.0.1
network.lan.ipaddr=10.xx.xx.1
network.modem.ipaddr=192.168.1.10
network.dmz.ipaddr=10.xxx.xx.1
network.loopback.ipaddr=127.0.0.1
network.lan.ipaddr=10.xx.xx.1
network.modem.ipaddr=192.168.1.10
network.dmz.ipaddr=10.xx.xx.1
uci: Entry not found</code></pre></div><p>And since the entries are not &quot;there&quot;, we get &#039;sh: enabled: unknown operand&#039; from the scripts.</p><div class="codebox"><pre><code>root@dexter:/etc/config# uci get network.wan.ipaddr
uci: Entry not found</code></pre></div><div class="codebox"><pre><code>root@dexter:/etc/config# uci get network.pppoe-wan.ipaddr
uci: Invalid argument</code></pre></div><div class="codebox"><pre><code>root@dexter:/etc/config# uci get network.modem.ipaddr
192.168.1.10</code></pre></div><p>what do you make of this? are the mwan3 scripts pulling &quot;mwan3_connected&quot; IP&#039;s from UCI or am I just confusing myself here?</p><br /><p>Now I&#039;m thinking there are of course workarounds to mwan3 script to fix this, but shouldn&#039;t this be resolved within ubus/uci?</p>											<p class="post-edited">(Last edited by <strong>spock</strong> on 19 Dec 2014, 12:49)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258130">
				<div class="post-metadata">
					<div class="post-num">Post #1064</div>
					<div class="post-author">spock</div>
					<div class="post-datetime">
						19 Dec 2014, 13:29					</div>
				</div>
				<div class="post-content content">
					<p>I think maybe you can forget my previous guesses..</p><p>Around line 90 in /etc/hotplug.d/iface/15-mwan there is a function that pulls the local IP&#039;s.</p><div class="codebox"><pre><code>ip route list dev $DEVICE scope link | awk &#039;{print $1}&#039; | egrep &#039;[0-9]{1,3}(\.[0-9]{1,3}){3}&#039;</code></pre></div><p>On a pppoe-wan connection this will pull out the bbras uplink ip, which is why it doesnt work.</p><p>So if we first check it it&#039;s pppoe-wan (or pseudo interface?), then run this code instead:</p><div class="codebox"><pre><code>ip route list dev $DEVICE scope link | awk &#039;{print $5}&#039; | egrep &#039;[0-9]{1,3}(\.[0-9]{1,3}){3}&#039;</code></pre></div><p>Things should then be working as expected. Even better would be if the ip information could be pulled easier out of ubus, but I have no idea how to do that.</p><p>Times like these I wish I was better with bash scripting..</p>											<p class="post-edited">(Last edited by <strong>spock</strong> on 19 Dec 2014, 14:47)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258176">
				<div class="post-metadata">
					<div class="post-num">Post #1065</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						19 Dec 2014, 23:10					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>spock wrote:</cite><blockquote><p>Around line 90 in /etc/hotplug.d/iface/15-mwan there is a function that pulls the local IP&#039;s.</p><div class="codebox"><pre><code>ip route list dev $DEVICE scope link | awk &#039;{print $1}&#039; | egrep &#039;[0-9]{1,3}(\.[0-9]{1,3}){3}&#039;</code></pre></div></blockquote></div><p>Hi spock,</p><p>Thank you for looking into it, but I already know what&#039;s wrong. The above line is correct. It is actually line 70 in the mwan3_set_connected_iptables section which is incomplete. I just haven&#039;t had the time to fix it.</p><p>The section mwan3_set_iface_iptables is responsible for marking traffic origination from hosts directly connected to wan interface. That it matches bbras ip address is actually correct.</p><br /><p>Edit:<br />The reason that you get the &quot;uci: Entry not found&quot; error is not directly related to mwan3, as you get these errors when you run &quot;uci show&quot; or &quot;uci get&quot;. The other enabled error however might be a mwan3 error.</p><br /><p>Edit2:<br />What do you get when you run &quot;uci get -p /var/state network.wan.ifname&quot;?</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 19 Dec 2014, 23:44)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258190">
				<div class="post-metadata">
					<div class="post-num">Post #1066</div>
					<div class="post-author">daddynobucks</div>
					<div class="post-datetime">
						19 Dec 2014, 23:59					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adaze,</p><p>I have a similar problem with the error messages:</p><p>mwan3 restart<br />sh: enabled: unknown operand<br />uci: Entry not found<br />uci: Entry not found</p><p>Running &quot;uci get -p /var/state network.wan.ifname&quot; returns eth0.4081.</p><p>When I run ash -x mwan3 restart, in the output I see:</p><p>+ device=eth0.4081<br />+ [ -n eth0.4081 ]<br />+ [ 1 -eq 1 ]<br />+ ACTION=ifup INTERFACE=wan DEVICE=eth0.4081 /sbin/hotplug-call iface<br />sh: enabled: unknown operand<br />uci: Entry not found<br />uci: Entry not found</p><p>I don&#039;t know if that helps or not.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258192">
				<div class="post-metadata">
					<div class="post-num">Post #1067</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						20 Dec 2014, 00:06					</div>
				</div>
				<div class="post-content content">
					<p>Hi dadadynobucks,</p><p>Thank you. It helps a bit. My hunch that is not mwan3 related, gets stronger and stronger. After the hotplug event is successful triggered, you get the uci errors. At that stage any script in /etc/hotplug.d/iface/ can be responsible for these errors.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 20 Dec 2014, 00:09)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258196">
				<div class="post-metadata">
					<div class="post-num">Post #1068</div>
					<div class="post-author">daddynobucks</div>
					<div class="post-datetime">
						20 Dec 2014, 00:23					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adaze,</p><p>I removed the scripts in /etc/hotplug.d/iface one at a time. The problem script is 50-miniupnpd. When I removed it, I had no errors.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258197">
				<div class="post-metadata">
					<div class="post-num">Post #1069</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						20 Dec 2014, 00:24					</div>
				</div>
				<div class="post-content content">
					<p>Nice <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /> Thank you!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258210">
				<div class="post-metadata">
					<div class="post-num">Post #1070</div>
					<div class="post-author">spock</div>
					<div class="post-datetime">
						20 Dec 2014, 06:49					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><blockquote><p>Hi spock,</p><p>Thank you for looking into it, but I already know what&#039;s wrong. The above line is correct. It is actually line 70 in the mwan3_set_connected_iptables section which is incomplete. I just haven&#039;t had the time to fix it.</p><p>The section mwan3_set_iface_iptables is responsible for marking traffic origination from hosts directly connected to wan interface. That it matches bbras ip address is actually correct.</p><br /><p>Edit:<br />The reason that you get the &quot;uci: Entry not found&quot; error is not directly related to mwan3, as you get these errors when you run &quot;uci show&quot; or &quot;uci get&quot;. The other enabled error however might be a mwan3 error.</p><br /><p>Edit2:<br />What do you get when you run &quot;uci get -p /var/state network.wan.ifname&quot;?</p></blockquote></div><p>Thanks for looking it to this more <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I also realized that the &#039;uci show&#039; and &#039;uci get&#039; errors have nothing to do with mwan3, I just found it odd that uci itself wouldn&#039;t list the ifname or ipaddress.</p><p>The following on the other hand reports &quot;pppoe-wan&quot; and it&#039;s respective ip address as it should.<br /></p><div class="codebox"><pre><code>uci get -p /var/state network.wan.ifname
uci get -p /var/state network.wan.ipaddr</code></pre></div><p>As such I must admit that don&#039;t know the underlying code of openwrt/uci/ubus very well yet. :-)</p><p>About the following code, doesn&#039;t openwrt provide us with any better interface for retrieving such information, since it will break with pppoe, and possible other configurations too(?), just guessing here.<br /></p><div class="codebox"><pre><code>$($IP route | awk &#039;{print $1}&#039; | egrep &#039;[0-9]{1,3}(\.[0-9]{1,3}){3}&#039;);</code></pre></div><p>I was looking into ubus, but it quickly became a bit overwhelming, and maybe not suitable.. not to mention it might also need extra packages for parsing(?).<br /></p><div class="codebox"><pre><code>ubus -S call network.interface.wan status</code></pre></div><p>Being christmas vacations and all I found it a good and fun opportunity to do some tinkering in the code and learn more things, to see what I can come up with. So I&#039;ll spend some time learning and trying to post a fix/patch for it if I manage. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Thanks for your time and a merry christmas &amp; happy new years!</p>											<p class="post-edited">(Last edited by <strong>spock</strong> on 20 Dec 2014, 06:59)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258220">
				<div class="post-metadata">
					<div class="post-num">Post #1071</div>
					<div class="post-author">spock</div>
					<div class="post-datetime">
						20 Dec 2014, 11:49					</div>
				</div>
				<div class="post-content content">
					<p>I tried to replace the following (which made nat reflection work properly):</p><div class="codebox"><pre><code>~line 70
for connected_networks in $(uci -q show |grep ipaddr | awk -F\= &#039;{print $2}&#039; | tr &#039;\n&#039; &#039; &#039; | egrep &#039;[0-9]{1,3}(\.[0-9]{1,3}){3}&#039;); do
              $IPT -A mwan3_connected -d $connected_networks -j MARK --set-xmark 0xff00/0xff00
done</code></pre></div><p>But I started getting timeout and all kinds of havoc was let loose on the network. Strange things.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258223">
				<div class="post-metadata">
					<div class="post-num">Post #1072</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						20 Dec 2014, 11:52					</div>
				</div>
				<div class="post-content content">
					<p>Try to replace the line</p><div class="codebox"><pre><code>$($IP route | awk &#039;{print $1}&#039; | egrep &#039;[0-9]{1,3}(\.[0-9]{1,3}){3}&#039;);</code></pre></div><p>with<br /></p><div class="codebox"><pre><code>$($IP route list table 0 | awk &#039;{print $1}&#039; | egrep &#039;[0-9]{1,3}(\.[0-9]{1,3}){3}&#039;);</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258225">
				<div class="post-metadata">
					<div class="post-num">Post #1073</div>
					<div class="post-author">spock</div>
					<div class="post-datetime">
						20 Dec 2014, 12:07					</div>
				</div>
				<div class="post-content content">
					<div class="codebox"><pre><code>ip route list table 0</code></pre></div><p>this actually lists my ip, but like this:<br />local 193.92.xx.xx dev pppoe-wan</p><p>So I thought I&#039;d change &#039;{print $1}&#039; to &#039;{print $2}&#039; so it would fetch my IP. But once again local routing got messed up.</p><p>Running &quot;iptables -L mwan3_connected -t mangle -v -n&quot; after this change also did not look pretty. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>											<p class="post-edited">(Last edited by <strong>spock</strong> on 20 Dec 2014, 12:08)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258226">
				<div class="post-metadata">
					<div class="post-num">Post #1074</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						20 Dec 2014, 12:12					</div>
				</div>
				<div class="post-content content">
					<p>I think if you add some lines to:</p><div class="codebox"><pre><code>for connected_networks in $($IP route | awk &#039;{print $1}&#039; | egrep &#039;[0-9]{1,3}(\.[0-9]{1,3}){3}&#039;); do
    $IPT -A mwan3_connected -d $connected_networks -j MARK --set-xmark 0xff00/0xff00
done</code></pre></div><p>to</p><div class="codebox"><pre><code>for connected_networks in $($IP route | awk &#039;{print $1}&#039; | egrep &#039;[0-9]{1,3}(\.[0-9]{1,3}){3}&#039;); do
    $IPT -A mwan3_connected -d $connected_networks -j MARK --set-xmark 0xff00/0xff00
done

for connected_networks in $($IP route list table 0 | awk &#039;{print $2}&#039; | egrep &#039;[0-9]{1,3}(\.[0-9]{1,3}){3}&#039;); do
    $IPT -A mwan3_connected -d $connected_networks -j MARK --set-xmark 0xff00/0xff00
done</code></pre></div><p>You will be ok to go.</p><p>Edit: I don&#039;t know why the second do in the last paste is on a new line?? I did not post it that way..</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 20 Dec 2014, 12:15)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p258227">
				<div class="post-metadata">
					<div class="post-num">Post #1075</div>
					<div class="post-author">spock</div>
					<div class="post-datetime">
						20 Dec 2014, 12:19					</div>
				</div>
				<div class="post-content content">
					<p>You&#039;re right, that fixed it!</p><p>Many many thanks for your time. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>											<p class="post-edited">(Last edited by <strong>spock</strong> on 20 Dec 2014, 12:19)</p>
									</div>
			</article>

			
		
						<div class="notice">
				<p>Sorry, posts 1076 to 1075 are missing from our archive.</p>
			</div>
		
		
	
	<div class="pagination"><div class="pagination-number">Page 43 of 65</div><nav><ul><li><a href="viewtopic.php%3Fid=39052&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=41.html">41</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=42.html">42</a></li><li class="pagination-current"><span>43</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=44.html">44</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=45.html">45</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0.001 -->

</body>
</html>