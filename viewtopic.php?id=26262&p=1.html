<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> has anyone got 10.03-1 to boot from usb ?</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 4 Apr 2018 and 7 Apr 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 4</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=26262&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=26262&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=26262&amp;p=4.html">4</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p115827">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						25 Aug 2010, 00:36					</div>
				</div>
				<div class="post-content content">
					<p>I have managed to get my wl-600g to run backfire 10.03-1 with usb access. I can mount the drives I plug in fine, vfat and ext2. I have been trying to set the system to boot off usb using the how to at;-</p><p><a href="http://wiki.openwrt.org/oldwiki/usbstoragehowto">http://wiki.openwrt.org/oldwiki/usbstoragehowto</a></p><p> I get all the way to</p><p>****<br />Test to see if pivotroot works:</p><p>/etc/init.d/pivotroot<br />df -h</p><p>You may safely ignore errors saying &quot;</p><p>insmod: cannot insert ...</p><p>****</p><p>I got 4 insmod error as the modules were already there. but df -h gives</p><p>Filesystem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Size&nbsp; &nbsp; &nbsp; Used Available Use% Mounted on<br />/dev/root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1.8M&nbsp; &nbsp; &nbsp; 1.8M&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 100% /mnt/rom<br />tmpfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6.6M&nbsp; &nbsp; &nbsp;40.0K&nbsp; &nbsp; &nbsp; 6.5M&nbsp; &nbsp;1% /tmp<br />tmpfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;512.0K&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; 512.0K&nbsp; &nbsp;0% /dev<br />/dev/mtdblock3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.3M&nbsp; &nbsp; 856.0K&nbsp; &nbsp; 488.0K&nbsp; 64% /mnt/overlay<br />mini_fo:/overlay&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.8M&nbsp; &nbsp; &nbsp; 1.8M&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 100% /mnt<br />/dev/sda1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1.8G&nbsp; &nbsp; &nbsp; 9.9M&nbsp; &nbsp; &nbsp; 1.7G&nbsp; &nbsp;1% /<br />root@OpenWrt:/mnt/root#</p><p>if i type /etc/init.d/pivotroot again I get file not found.rc.common is the un edited one too implying root has moved!</p><p>Am I on the usb stick or the internal flash. If I reboot i am on the internal flash as /dev/sda1 is not there, rc.common is not working too .</p><p>my pivotroot is <br />#!/bin/sh<br /># change this to your boot partition<br />boot_dev=&quot;/dev/sda1&quot;<br /># install needed modules for usb and the ext3 filesystem<br /># **NOTE** for usb2.0 replace &quot;uhci&quot; with &quot;ehci_hcd&quot;<br /># **NOTE** for ohci chipsets replace &quot;uhci&quot; with &quot;usb-ohci&quot;<br />/sbin/hotplug2 --override --persistent --max-children 1 --no-coldplug &amp;</p><p>for module in usbcore ehci_hcd scsi_mod sd_mod usb-storage kmod-fs-ext2 ; do {<br />&nbsp; &nbsp; &nbsp; &nbsp; insmod $module<br />}; done</p><p>killall hotplug2</p><p># this may need to be higher if your disk is slow to initialize<br />sleep 4s<br /># mount the usb stick<br />mount &quot;$boot_dev&quot; /mnt<br /># if everything looks ok, do the pivot root<br />[ -x /mnt/sbin/init ] &amp;&amp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; mount -o move /proc /mnt/proc &amp;&amp; \<br />&nbsp; &nbsp; &nbsp; &nbsp; pivot_root /mnt /mnt/mnt &amp;&amp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mount -o move /mnt/dev /dev<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mount -o move /mnt/tmp /tmp<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mount -o move /mnt/jffs2 /jffs2 2&gt;&amp;-<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mount -o move /mnt/sys /sys 2&gt;&amp;-<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />}</p><p>my rc.common is</p><p>#!/bin/sh<br /># Copyright (C) 2006-2009 OpenWrt.org</p><p>START=99<br />STOP=40</p><br /><p>. $IPKG_INSTROOT/etc/functions.sh</p><p>initscript=$1<br />action=${2:-help}<br />shift 2</p><p>start() {<br />&nbsp; &nbsp; &nbsp; &nbsp; echo -n &quot;Testing USB Partition:&nbsp; &quot;<br />#&nbsp; &nbsp; &nbsp; &nbsp; e2fsck -p /dev/scsi/host0/bus0/target0/lun0/part1 &amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; sleep 5<br />&nbsp; &nbsp; &nbsp; &nbsp; echo -n &quot;Mounting USB drive: &quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; mount -t ext2 -o noatime /dev/sda1 /mnt/harddisc<br />&nbsp; &nbsp; &nbsp; &nbsp; echo &quot;Done.&quot;<br />}</p><p>stop() {<br />&nbsp; &nbsp; &nbsp; &nbsp; echo -n &quot;Umounting USB drive:&nbsp; &quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; sync<br />&nbsp; &nbsp; &nbsp; &nbsp; sync<br />&nbsp; &nbsp; &nbsp; &nbsp; umount /dev/sda1<br />&nbsp; &nbsp; &nbsp; &nbsp; echo &quot;Done.&quot;<br />}</p><p>reload() {<br />&nbsp; &nbsp; &nbsp; &nbsp; return 1<br />}</p><p>restart() {<br />&nbsp; &nbsp; &nbsp; &nbsp; trap &#039;&#039; TERM<br />&nbsp; &nbsp; &nbsp; &nbsp; stop &quot;$@&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; start &quot;$@&quot;<br />}</p><p>boot() {<br />&nbsp; &nbsp; &nbsp; &nbsp; start &quot;$@&quot;<br />}</p><p>shutdown() {<br />&nbsp; &nbsp; &nbsp; &nbsp; return 0<br />}</p><p>disable() {<br />&nbsp; &nbsp; &nbsp; &nbsp; name=&quot;$(basename &quot;${initscript}&quot;)&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; rm -f &quot;$IPKG_INSTROOT&quot;/etc/rc.d/S??$name<br />&nbsp; &nbsp; &nbsp; &nbsp; rm -f &quot;$IPKG_INSTROOT&quot;/etc/rc.d/K??$name<br />}</p><p>enable() {<br />&nbsp; &nbsp; &nbsp; &nbsp; name=&quot;$(basename &quot;${initscript}&quot;)&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; disable<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$START&quot; ] &amp;&amp; ln -s &quot;../init.d/$name&quot; &quot;$IPKG_INSTROOT/etc/rc.d/S${START}${name##S[0-9][0-9]}&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; [ &quot;$STOP&quot;&nbsp; ] &amp;&amp; ln -s &quot;../init.d/$name&quot; &quot;$IPKG_INSTROOT/etc/rc.d/K${STOP}${name##K[0-9][0-9]}&quot;<br />}</p><p>enabled() {<br />&nbsp; &nbsp; &nbsp; &nbsp; name=&quot;$(basename &quot;${initscript}&quot;)&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -x &quot;$IPKG_INSTROOT/etc/rc.d/S${START}${name##S[0-9][0-9]}&quot; ]<br />}</p><p>depends() {<br />&nbsp; &nbsp; &nbsp; &nbsp; return 0<br />}</p><p>help() {<br />&nbsp; &nbsp; &nbsp; &nbsp; cat &lt;&lt;EOF<br />Syntax: $initscript [command]</p><p>Available commands:<br />&nbsp; &nbsp; &nbsp; &nbsp; start&nbsp; &nbsp;Start the service<br />&nbsp; &nbsp; &nbsp; &nbsp; stop&nbsp; &nbsp; Stop the service<br />&nbsp; &nbsp; &nbsp; &nbsp; restart Restart the service<br />&nbsp; &nbsp; &nbsp; &nbsp; reload&nbsp; Reload configuration files (or restart if that fails)<br />&nbsp; &nbsp; &nbsp; &nbsp; enable&nbsp; Enable service autostart<br />&nbsp; &nbsp; &nbsp; &nbsp; disable Disable service autostart<br />$EXTRA_HELP<br />EOF<br />}</p><p>. &quot;$initscript&quot;</p><p>ALL_COMMANDS=&quot;start stop reload restart boot shutdown enable disable enabled depends ${EXTRA_COMMANDS}&quot;<br />list_contains ALL_COMMANDS &quot;$action&quot; || action=help<br />[ &quot;$action&quot; = &quot;reload&quot; ] &amp;&amp; action=&#039;eval reload &quot;$@&quot; || restart &quot;$@&quot; &amp;&amp; :&#039;<br />$action &quot;$@&quot;</p><br /><br /><p>DO I realy need e2fsck . This script does not look like anything in the howto I had to guess a bit ( lots actualy ) .</p><p>All help appreciated</p><p>Pale</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115828">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Zz</div>
					<div class="post-datetime">
						25 Aug 2010, 01:15					</div>
				</div>
				<div class="post-content content">
					<p>What router do you have? i plan to do a usb boot setup on a wrt54g because 2mb isn&#039;t enough.</p><p>e2fsck is needed to clean up filesystems that weren&#039;t cleanly unmounted, like after a power failure, without it the system will not boot</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115842">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">Memphis</div>
					<div class="post-datetime">
						25 Aug 2010, 10:03					</div>
				</div>
				<div class="post-content content">
					<div class="codebox"><pre><code>for module in usbcore ehci_hcd scsi_mod sd_mod usb-storage kmod-fs-ext2 ; do {</code></pre></div><p>Ther is no module called kmod-fs-ext2 ... it should read ext2 ...</p>											<p class="post-edited">(Last edited by <strong>Memphis</strong> on 25 Aug 2010, 10:03)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115865">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						25 Aug 2010, 18:41					</div>
				</div>
				<div class="post-content content">
					<p>I changed the kmod-fs-ext2 to just ext2 and got</p><br /><p>root@OpenWrt:/etc/init.d# ./pivotroot<br />insmod: can&#039;t insert &#039;usbcore&#039;: File exists<br />insmod: can&#039;t insert &#039;scsi_mod&#039;: File exists<br />insmod: can&#039;t insert &#039;sd_mod&#039;: File exists<br />insmod: can&#039;t insert &#039;usb-storage&#039;: File exists<br />insmod: can&#039;t insert &#039;ext2&#039;: File exists<br />root@OpenWrt:/mnt/etc/init.d#df<br />Filesystem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1K-blocks&nbsp; &nbsp; &nbsp; Used Available Use% Mounted on<br />/dev/root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1792&nbsp; &nbsp; &nbsp; 1792&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 100% /mnt/rom<br />tmpfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6712&nbsp; &nbsp; &nbsp; &nbsp; 40&nbsp; &nbsp; &nbsp; 6672&nbsp; &nbsp;1% /tmp<br />tmpfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 512&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp;512&nbsp; &nbsp;0% /dev<br />/dev/mtdblock3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1344&nbsp; &nbsp; &nbsp; &nbsp;856&nbsp; &nbsp; &nbsp; &nbsp;488&nbsp; 64% /mnt/overlay<br />mini_fo:/overlay&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1792&nbsp; &nbsp; &nbsp; 1792&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 100% /mnt<br />/dev/sda1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1890724&nbsp; &nbsp; &nbsp;10100&nbsp; &nbsp;1784580&nbsp; &nbsp;1% /</p><br /><p>pretty much as before. the kmod-fs-ext2 is how it is in the howto page and kmod-fs-ext2 does exits it the repository and I had installed it to get the ext2 formatted usb memory stick to work, does the file change it&#039;s name?</p><p>Thanks </p><p>Pale</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115866">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						25 Aug 2010, 18:42					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Zz wrote:</cite><blockquote><p>What router do you have? i plan to do a usb boot setup on a wrt54g because 2mb isn&#039;t enough.</p><p>e2fsck is needed to clean up filesystems that weren&#039;t cleanly unmounted, like after a power failure, without it the system will not boot</p></blockquote></div><p>Asus wl-600g</p><p>I will install e2fsck and see what happens</p><p>Thank </p><p>pale</p><p>EDIT: <br />I just went to install this via luci and it says I have 1.9 gig of space !!! Maybe it is all working. Or have I just changed root . I&#039;m a bit of a novice here.</p>											<p class="post-edited">(Last edited by <strong>pale</strong> on 25 Aug 2010, 18:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115869">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						25 Aug 2010, 19:37					</div>
				</div>
				<div class="post-content content">
					<p>I just re-read this bit of the howto</p><p>Note that it is safest to leave the &#039;pivot_root&#039; procedure as an ordinary script file, not part of the code automatically run on startup, at least until you are certain that it is operating as desired. This allows you to recover from any problems created by this script by simply rebooting the router without it. </p><p>Does this mean the pivot root script has to be set some where to run every boot time ? If so where? please.</p><p>thanks</p><p>pale</p><p>edit :<br />I have noticed that all the stuff i installed like kmod&#039;s and nano are not on the usb stick. I gather I have copied the original openwrt squashfs to the usb stick and not what is installed in the jffs ? this is no problem but I take it the kmods are in memory somewhere, else how does the usb port work ?</p>											<p class="post-edited">(Last edited by <strong>pale</strong> on 25 Aug 2010, 19:42)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115898">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">pfugl</div>
					<div class="post-datetime">
						26 Aug 2010, 08:52					</div>
				</div>
				<div class="post-content content">
					<p>Most of the pivotroot stuff is included in 10.03 block-extroot package. You should use this howto instead. It&#039;s much more simple and clean:<br /><a href="http://wiki.openwrt.org/doc/howto/rootfsonexternalstorage">http://wiki.openwrt.org/doc/howto/rootf … nalstorage</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115923">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						26 Aug 2010, 15:54					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for the pointer , but unfortuantly i understand about 5% of that how to!!&nbsp; ( I&#039;m still learning as I go) Will I have to build my own image to do this as I don&#039;t have a system set up to do openwrt .</p><p>Thank </p><p>pale</p><p>EDIT:</p><p>I just reread it and it makes more sense now. I have a system that in on squashfs but with a jffs overlay. do I copy the /rom ( squashfs ) or the /&nbsp; ( jffs ) to the usb stick.</p><p>EDIT EDIT:</p><p>I tried both . neither will boot. if i copy the jffs then acording to luci, fstab&nbsp; is disabled. If i enable it and rerun it then the rootfs swaps.</p><p>EDIT EDIT EDIT :&nbsp; copied the jffs and after a 3 minute wait the fs swaps to the usb stick by it&#039;s self from boot without touching anything.!&nbsp; the next question is does the the system run any more scripts ie will I be able to make it start up lighttpd , samba etc automaticaly.&nbsp; I can live with a 3 minute boot if I need to.</p><p>thanks</p>											<p class="post-edited">(Last edited by <strong>pale</strong> on 26 Aug 2010, 17:59)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115941">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						26 Aug 2010, 21:11					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ve just done a complete reflash and started afresh because I realised I still had bits left form the older method floating around. So far the system has been up 8 minutes and it is still on the old jffs root. umount and fstab are both disabled in intscripts? this happened last time. I enabled fstab and restarted it via luci as i did before. nothing happened after 13 minutes . rebooted. no change apart from fstab now running. restarted umount in the initscripts. CRASH try again CRASH oops</p><p>usb is painfully slow. something screwed. I.m going to re format the usb stick . the usb port gets very hot!</p>											<p class="post-edited">(Last edited by <strong>pale</strong> on 26 Aug 2010, 22:12)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115963">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">pfugl</div>
					<div class="post-datetime">
						27 Aug 2010, 08:43					</div>
				</div>
				<div class="post-content content">
					<p>If you have a system with squashfs, I think you will have to compile your own image in order to get the block-extroot included in the image.<br />You should try it. It&#039;s not that difficult to setup.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p115982">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						27 Aug 2010, 13:51					</div>
				</div>
				<div class="post-content content">
					<p>from the ipk</p><p>Package: block-extroot<br />Version: 0.0.1-2<br />Depends: block-mount<br />Provides: <br />Source: package/block-extroot<br />Section: utils<br />Priority: optional<br />Maintainer: OpenWrt Developers Team &lt;openwrt-devel@openwrt.org&gt;<br />Architecture: brcm63xx<br />Installed-Size: 3080<br />Description:&nbsp; Based on the moduluarized preinit and firstboot, adds the option to have<br /> the root filesystem on storage other than the jffs or the boot root device.<br /> For a squashfs image this package must be installed into the image, not as<br /> a package to add later.</p><p>Looks like you are right . thanks</p><p>My partial success must have been the leftover pivotroot script from the early attempt . i cannot get block-extroot to work with a fresh install.</p><p>pale</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116006">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						27 Aug 2010, 21:16					</div>
				</div>
				<div class="post-content content">
					<p>Well I&#039;ve gone back to the first method , and written down the steps . It all works apart from I cant get it to pivot root automaticaly. This is just me not knowing how to get scripts to auto run?</p><p>I&#039;ve added </p><p>if test $2 == &quot;boot&quot; ; then<br />/etc/init.d/pivotroot<br />fi</p><p>to the /etc/init.d/rcS script at it&#039;s start as per the <br />htp://wiki.openwrt.org/oldwiki/usbstoragehowto</p><p>but I dont understant the<br /> if test $2 == &quot;boot&quot; <br /> line</p><p>I suspect I will need to run all the init script stuff on the external usb fs as well after the pivotroot.</p><p>pale</p><p>EDIT:</p><br /><p>ah is &quot;boot&quot; from&nbsp; ::sysinit:etc/init.d/rcS S boot<br />in /etc/inittab</p><p>if so how will it work the drive has to be mounted. ah mount it in pivot root thats why it is there in the wiki one. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>drat still doesnt work</p>											<p class="post-edited">(Last edited by <strong>pale</strong> on 27 Aug 2010, 21:33)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116276">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">hamlet505a</div>
					<div class="post-datetime">
						1 Sep 2010, 19:41					</div>
				</div>
				<div class="post-content content">
					<p>I am doing the same thing and I&#039;m about at the same place.&nbsp; &nbsp; I&#039;ve copied the rcS script, but I get an error &quot;sh:&nbsp; boot: unknown operand&quot;.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116281">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						1 Sep 2010, 20:31					</div>
				</div>
				<div class="post-content content">
					<p>Here is my latest work through . It all boots to the usbfs in the end but the /etc/rc.d/S** are all on the internal jffs still.??</p><p>flash with </p><p><a href="http://downloads.openwrt.org/backfire/10.03.1-rc1/brcm63xx/openwrt-96348GW-generic-squashfs-cfe.bin">http://downloads.openwrt.org/backfire/1 … fs-cfe.bin</a></p><p>wait 6 minutes</p><p>reboot<br />use putty to<br />telnet to 192.168.1.1</p><p>type passwd <br />then enter new password 2 times</p><p>type reboot<br />close putty<br />open putty ssh to 192.168.1.1<br />and get</p><p>login as: root<br />root@192.168.1.1&#039;s password:</p><br /><p>BusyBox v1.15.3 (2010-07-11 15:57:41 PDT) built-in shell (ash)<br />Enter &#039;help&#039; for a list of built-in commands.</p><p>&nbsp; _______&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;________&nbsp; &nbsp; &nbsp; &nbsp; __<br /> |&nbsp; &nbsp; &nbsp; &nbsp;|.-----.-----.-----.|&nbsp; |&nbsp; |&nbsp; |.----.|&nbsp; |_<br /> |&nbsp; &nbsp;-&nbsp; &nbsp;||&nbsp; _&nbsp; |&nbsp; -__|&nbsp; &nbsp; &nbsp;||&nbsp; |&nbsp; |&nbsp; ||&nbsp; &nbsp;_||&nbsp; &nbsp;_|<br /> |_______||&nbsp; &nbsp;__|_____|__|__||________||__|&nbsp; |____|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |__| W I R E L E S S&nbsp; &nbsp;F R E E D O M<br /> Backfire (10.03.1-rc1, r22556) --------------------<br />&nbsp; * 1/3 shot Kahlua&nbsp; &nbsp; In a shot glass, layer Kahlua<br />&nbsp; * 1/3 shot Bailey&#039;s&nbsp; on the bottom, then Bailey&#039;s,<br />&nbsp; * 1/3 shot Vodka&nbsp; &nbsp; &nbsp;then Vodka.<br /> ---------------------------------------------------<br />root@OpenWrt:~#</p><br /><p><a href="http://192.168.1.1">http://192.168.1.1</a></p><p>change ip address to suitable one and enter default gate way and dns</p><p>click save</p><p>swap network to correct subdomain in my case 192.168.10.nnn</p><p><a href="http://192.168.10.115">http://192.168.10.115</a> ( my routers address)</p><br /><p>install</p><p>kmod-usb-ohci<br />kmod-usb2<br />kmod-usb-storage<br />kmod-usb-core<br />kmod-scsi-core<br />kmod-scsi-generic<br />fdisk<br />kmod-fs-ext2<br />kmod-fs-vfat<br />kmod-nls-base<br />kmod-nls-cp437<br />kmod-nls-cp850<br />kmod-nls-iso8859-1<br />kmod-nls-iso8859-15<br />mc</p><p>kmod-usb-uhci not used with this chipset</p><p>Install &#039;kmod-usb2&#039;: Error (Code 255)&nbsp; unless kmod-usb-ohci is installed first</p><p>reboot</p><p>partition and format usb stick to ext2<br />i used ubuntu on laptop</p><p>login as: root<br />root@192.168.10.115&#039;s password:</p><br /><p>BusyBox v1.15.3 (2010-07-11 15:57:41 PDT) built-in shell (ash)<br />Enter &#039;help&#039; for a list of built-in commands.</p><p>&nbsp; _______&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;________&nbsp; &nbsp; &nbsp; &nbsp; __<br /> |&nbsp; &nbsp; &nbsp; &nbsp;|.-----.-----.-----.|&nbsp; |&nbsp; |&nbsp; |.----.|&nbsp; |_<br /> |&nbsp; &nbsp;-&nbsp; &nbsp;||&nbsp; _&nbsp; |&nbsp; -__|&nbsp; &nbsp; &nbsp;||&nbsp; |&nbsp; |&nbsp; ||&nbsp; &nbsp;_||&nbsp; &nbsp;_|<br /> |_______||&nbsp; &nbsp;__|_____|__|__||________||__|&nbsp; |____|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |__| W I R E L E S S&nbsp; &nbsp;F R E E D O M<br /> Backfire (10.03.1-rc1, r22556) --------------------<br />&nbsp; * 1/3 shot Kahlua&nbsp; &nbsp; In a shot glass, layer Kahlua<br />&nbsp; * 1/3 shot Bailey&#039;s&nbsp; on the bottom, then Bailey&#039;s,<br />&nbsp; * 1/3 shot Vodka&nbsp; &nbsp; &nbsp;then Vodka.<br /> ---------------------------------------------------<br />root@OpenWrt:~# dmesg<br />Linux version 2.6.32.16 (openwrt@ampere) (gcc version 4.3.3 (GCC) ) #1 Mon Aug 9 10:18:34 PDT 2010<br />Detected Broadcom 0x6348 CPU revision b0<br />CPU frequency is 256 MHz<br />16MB of RAM installed<br />registering 37 GPIOs<br />board_bcm963xx: CFE version: 1.0.37-0.8<br />bootconsole [early0] enabled<br />CPU revision is: 00029107 (Broadcom BCM6348)<br />board_bcm963xx: board name: 96348GW-10<br />Determined physical RAM map:<br /> memory: 01000000 @ 00000000 (usable)<br />Initrd not found or empty - disabling initrd<br />Zone PFN ranges:<br />&nbsp; Normal&nbsp; &nbsp;0x00000000 -&gt; 0x00001000<br />Movable zone start PFN for each node<br />early_node_map[1] active PFN ranges<br />&nbsp; &nbsp; 0: 0x00000000 -&gt; 0x00001000<br />On node 0 totalpages: 4096<br />free_area_init_node: node 0, pgdat 802981e0, node_mem_map 802df000<br />&nbsp; Normal zone: 32 pages used for memmap<br />&nbsp; Normal zone: 0 pages reserved<br />&nbsp; Normal zone: 4064 pages, LIFO batch:0<br />Built 1 zonelists in Zone order, mobility grouping off.&nbsp; Total pages: 4064<br />Kernel command line: root=/dev/mtdblock2 rootfstype=squashfs,jffs2 noinitrd console=ttyS0,115200<br />PID hash table entries: 64 (order: -4, 256 bytes)<br />Dentry cache hash table entries: 2048 (order: 1, 8192 bytes)<br />Inode-cache hash table entries: 1024 (order: 0, 4096 bytes)<br />Primary instruction cache 16kB, VIPT, 2-way, linesize 16 bytes.<br />Primary data cache 8kB, 2-way, VIPT, no aliases, linesize 16 bytes<br />Memory: 13284k/16384k available (2138k kernel code, 3100k reserved, 455k data, 140k init, 0k highmem)<br />Hierarchical RCU implementation.<br />NR_IRQS:128<br />Calibrating delay loop... 254.97 BogoMIPS (lpj=509952)<br />Mount-cache hash table entries: 512<br />NET: Registered protocol family 16<br />registering PCI controller with io_map_base unset<br />registering PCI controller with io_map_base unset<br />bio: create slab &lt;bio-0&gt; at 0<br />pci 0000:00:01.0: reg 10 32bit mmio: [0x000000-0x001fff]<br />pci 0000:00:07.0: reg 20 io port: [0xfce0-0xfcff]<br />pci 0000:00:07.0: supports D1 D2<br />pci 0000:00:07.0: PME# supported from D0 D1 D2 D3hot<br />pci 0000:00:07.0: PME# disabled<br />pci 0000:00:07.1: reg 20 io port: [0xfce0-0xfcff]<br />pci 0000:00:07.1: supports D1 D2<br />pci 0000:00:07.1: PME# supported from D0 D1 D2 D3hot<br />pci 0000:00:07.1: PME# disabled<br />pci 0000:00:07.2: reg 10 32bit mmio: [0x000000-0x0000ff]<br />pci 0000:00:07.2: supports D1 D2<br />pci 0000:00:07.2: PME# supported from D0 D1 D2 D3hot<br />pci 0000:00:07.2: PME# disabled<br />pci 0000:01:1e.0: CardBus bridge, secondary bus 0000:02<br />pci 0000:01:1e.0:&nbsp; &nbsp;IO window: 0x8008000-0x80080ff<br />pci 0000:01:1e.0:&nbsp; &nbsp;IO window: 0x8008400-0x80084ff<br />pci 0000:01:1e.0:&nbsp; &nbsp;MEM window: 0x38000000-0x3fffffff<br />PCI: Enabling device 0000:01:1e.0 (0000 -&gt; 0003)<br />PCI: Setting latency timer of device 0000:01:1e.0 to 64<br />Switching to clocksource MIPS<br />PCI: Enabling device 0000:00:01.0 (0000 -&gt; 0002)<br />PCI: Setting latency timer of device 0000:00:01.0 to 64<br />ssb: Core 0 found: ChipCommon (cc 0x800, rev 0x0D, vendor 0x4243)<br />ssb: Core 1 found: IEEE 802.11 (cc 0x812, rev 0x09, vendor 0x4243)<br />ssb: Core 2 found: PCI (cc 0x804, rev 0x0C, vendor 0x4243)<br />ssb: Core 3 found: PCMCIA (cc 0x80D, rev 0x07, vendor 0x4243)<br />ssb: Sonics Silicon Backplane found on PCI device 0000:00:01.0<br />NET: Registered protocol family 2<br />IP route cache hash table entries: 1024 (order: 0, 4096 bytes)<br />TCP established hash table entries: 512 (order: 0, 4096 bytes)<br />TCP bind hash table entries: 512 (order: -1, 2048 bytes)<br />TCP: Hash tables configured (established 512 bind 512)<br />TCP reno registered<br />NET: Registered protocol family 1<br />audit: initializing netlink socket (disabled)<br />type=2000 audit(0.382:1): initialized<br />squashfs: version 4.0 (2009/01/31) Phillip Lougher<br />Registering mini_fo version $Id$<br />JFFS2 version 2.2. (NAND) (SUMMARY)&nbsp; Ac 2001-2006 Red Hat, Inc.<br />msgmni has been set to 25<br />io scheduler noop registered<br />io scheduler deadline registered (default)<br />gpiodev: gpio device registered with major 254<br />gpiodev: gpio platform device registered with access mask FFFFFFFF<br />bcm63xx_uart.0: ttyS0 at MMIO 0xfffe0300 (irq = 10) is a bcm63xx_uart<br />console [ttyS0] enabled, bootconsole disabled<br />bcm963xx_flash: 0x00400000 at 0x1fc00000<br />bcm963xx: Found 1 x16 devices at 0x0 in 16-bit bank<br /> Amd/Fujitsu Extended Query Table at 0x0040<br />bcm963xx: Swapping erase regions for broken CFI table.<br />number of CFI chips: 1<br />cfi_cmdset_0002: Disabling erase-suspend-program due to code brokenness.<br />bcm963xx_flash: Read Signature value of CFE1CFE1<br />bcm963xx_flash: CFE bootloader detected<br />bcm963xx_flash: CFE boot tag found with version 6 and board type 96348GW<br />bcm963xx_flash: Partition 0 is CFE offset 0 and length 10000<br />bcm963xx_flash: Partition 1 is kernel offset 10100 and length dff00<br />bcm963xx_flash: Partition 2 is rootfs offset f0000 and length 300000<br />bcm963xx_flash: Partition 3 is nvram offset 3f0000 and length 10000<br />bcm963xx_flash: Partition 4 is linux offset 10000 and length 3e0000<br />bcm963xx_flash: Spare partition is 2a0000 offset and length 150000<br />Creating 5 MTD partitions on &quot;bcm963xx&quot;:<br />0x000000000000-0x000000010000 : &quot;CFE&quot;<br />0x000000010100-0x0000000f0000 : &quot;kernel&quot;<br />mtd: partition &quot;kernel&quot; must either start or end on erase block boundary or be smaller than an erase block -- forcing read-only<br />0x0000000f0000-0x0000003f0000 : &quot;rootfs&quot;<br />mtd: partition &quot;rootfs&quot; set to be root filesystem<br />mtd: partition &quot;rootfs_data&quot; created automatically, ofs=2A0000, len=150000<br />0x0000002a0000-0x0000003f0000 : &quot;rootfs_data&quot;<br />0x0000003f0000-0x000000400000 : &quot;nvram&quot;<br />0x000000010000-0x0000003f0000 : &quot;linux&quot;<br />bcm63xx_enet MII bus: probed<br />bcm63xx_wdt started, timer margin: 30 sec<br />Registered led device: adsl-fail<br />Registered led device: ppp<br />Registered led device: ppp-fail<br />Registered led device: power<br />Registered led device: stop<br />TCP westwood registered<br />NET: Registered protocol family 17<br />802.1Q VLAN Support v1.8 Ben Greear &lt;greearb@candelatech.com&gt;<br />All bugs added by David S. Miller &lt;davem@redhat.com&gt;<br />VFS: Mounted root (squashfs filesystem) readonly on device 31:2.<br />Freeing unused kernel memory: 140k freed<br />Please be patient, while OpenWrt loads ...<br />mini_fo: using base directory: /<br />mini_fo: using storage directory: /overlay<br />bcm63xx_enet bcm63xx_enet.0: attached PHY at address 1 [Broadcom BCM63XX (1)]<br />eth1: link forced UP - 100/full - flow control off/off<br />device eth1 entered promiscuous mode<br />br-lan: port 1(eth1) entering forwarding state<br />Compat-wireless backport release: compat-wireless-2010-07-13-4-g04898a5<br />Backport based on wireless-2.6.git v2.6.35-rc6-48432-gdce358e<br />cfg80211: Calling CRDA to update world regulatory domain<br />SCSI subsystem initialized<br />cfg80211: World regulatory domain updated:<br />&nbsp; &nbsp; (start_freq - end_freq @ bandwidth), (max_antenna_gain, max_eirp)<br />&nbsp; &nbsp; (2402000 KHz - 2472000 KHz @ 40000 KHz), (300 mBi, 2000 mBm)<br />&nbsp; &nbsp; (2457000 KHz - 2482000 KHz @ 20000 KHz), (300 mBi, 2000 mBm)<br />&nbsp; &nbsp; (2474000 KHz - 2494000 KHz @ 20000 KHz), (300 mBi, 2000 mBm)<br />&nbsp; &nbsp; (5170000 KHz - 5250000 KHz @ 40000 KHz), (300 mBi, 2000 mBm)<br />&nbsp; &nbsp; (5735000 KHz - 5835000 KHz @ 40000 KHz), (300 mBi, 2000 mBm)<br />roboswitch: Probing device eth0: Failed to enable switch<br />roboswitch: Probing device eth1: found a 5325! It&#039;s a 5350.<br />usbcore: registered new interface driver usbfs<br />usbcore: registered new interface driver hub<br />usbcore: registered new device driver usb<br />b43-phy0: Broadcom 4318 WLAN found (core revision 9)<br />phy0: Selected rate control algorithm &#039;minstrel&#039;<br />Registered led device: b43-phy0::tx<br />Registered led device: b43-phy0::rx<br />Registered led device: b43-phy0::radio<br />Broadcom 43xx driver loaded [ Features: PL, Firmware-ID: FW13 ]<br />PPP generic driver version 2.4.2<br />ip_tables: (C) 2000-2006 Netfilter Core Team<br />NET: Registered protocol family 24<br />ehci_hcd: USB 2.0 &#039;Enhanced&#039; Host Controller (EHCI) Driver<br />PCI: Enabling device 0000:00:07.2 (0000 -&gt; 0002)<br />ehci_hcd 0000:00:07.2: EHCI Host Controller<br />ehci_hcd 0000:00:07.2: new USB bus registered, assigned bus number 1<br />ehci_hcd 0000:00:07.2: Enabling legacy PCI PM<br />ehci_hcd 0000:00:07.2: irq 32, io mem 0x30002000<br />ehci_hcd 0000:00:07.2: USB 2.0 started, EHCI 1.00<br />usb usb1: configuration #1 chosen from 1 choice<br />hub 1-0:1.0: USB hub found<br />hub 1-0:1.0: 4 ports detected<br />nf_conntrack version 0.5.0 (209 buckets, 836 max)<br />CONFIG_NF_CT_ACCT is deprecated and will be removed soon. Please use<br />nf_conntrack.acct=1 kernel parameter, acct=1 nf_conntrack module option or<br />sysctl net.netfilter.nf_conntrack_acct=1 to enable it.<br />usb 1-2: new high speed USB device using ehci_hcd and address 2<br />usb 1-2: configuration #1 chosen from 1 choice<br />ohci_hcd: USB 1.1 &#039;Open&#039; Host Controller (OHCI) Driver<br />bcm63xx_ohci bcm63xx_ohci.0: BCM63XX integrated OHCI controller<br />bcm63xx_ohci bcm63xx_ohci.0: new USB bus registered, assigned bus number 2<br />bcm63xx_ohci bcm63xx_ohci.0: irq 20, io mem 0xfffe1b00<br />usb usb2: configuration #1 chosen from 1 choice<br />hub 2-0:1.0: USB hub found<br />hub 2-0:1.0: 1 port detected<br />Initializing USB Mass Storage driver...<br />scsi0 : SCSI emulation for USB Mass Storage devices<br />usbcore: registered new interface driver usb-storage<br />USB Mass Storage support registered.<br />usb-storage: device found at 2<br />usb-storage: waiting for device to settle before scanning<br />scsi 0:0:0:0: Direct-Access&nbsp; &nbsp; &nbsp;Generic&nbsp; USB&nbsp; SD Reader&nbsp; &nbsp;1.00 PQ: 0 ANSI: 0 CCS<br />sd 0:0:0:0: Attached scsi generic sg0 type 0<br />sd 0:0:0:0: [sda] 3842048 512-byte logical blocks: (1.96 GB/1.83 GiB)<br />sd 0:0:0:0: [sda] Write Protect is off<br />sd 0:0:0:0: [sda] Mode Sense: 4b 00 00 08<br />sd 0:0:0:0: [sda] Assuming drive cache: write through<br />usb-storage: device scan complete<br />sd 0:0:0:0: [sda] Assuming drive cache: write through<br /> sda: sda1<br />sd 0:0:0:0: [sda] Assuming drive cache: write through<br />sd 0:0:0:0: [sda] Attached SCSI removable disk<br />root@OpenWrt:~#</p><p>root@OpenWrt:/mnt# fdisk -l</p><p>Disk /dev/sda: 1967 MB, 1967128576 bytes<br />57 heads, 56 sectors/track, 1203 cylinders<br />Units = cylinders of 3192 * 512 = 1634304 bytes<br />Disk identifier: 0x00074c00</p><p>&nbsp; &nbsp;Device Boot&nbsp; &nbsp; &nbsp; Start&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;End&nbsp; &nbsp; &nbsp; Blocks&nbsp; &nbsp;Id&nbsp; System<br />/dev/sda1&nbsp; &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1&nbsp; &nbsp; &nbsp; &nbsp; 1204&nbsp; &nbsp; &nbsp;1920955+&nbsp; 83&nbsp; Linux</p><br /><p>can you access the drive</p><p>root@OpenWrt:~# mount /dev/sda1 /mnt<br />root@OpenWrt:~# cd /mnt<br />root@OpenWrt:/mnt# ls<br />lost+found</p><br /><p>usb access working ok </p><br /><p>now move S39usb to S15usb</p><p>cd /etc/init.d</p><p>use mc to edit /etc/init.d/usb<br />change START=39 to START=15</p><p>./usb enable</p><p>to set /etc/rc.d/@S15usb</p><br /><p>now vi /etc/init.d/usbfsmount to create usbfsmount&nbsp; file</p><br /><br /><p>#!/bin/sh /etc/rc.common<br />START=17<br />STOP=40<br />start()<br />{<br />&nbsp; &nbsp; &nbsp; &nbsp; sleep 5<br />&nbsp; &nbsp; &nbsp; &nbsp; /etc/init.d/pivotroot<br />}<br />stop()<br />{<br />&nbsp; &nbsp; &nbsp; &nbsp; sync<br />&nbsp; &nbsp; &nbsp; &nbsp; sync<br />&nbsp; &nbsp; &nbsp; &nbsp; umount /mnt<br />}<br />restart()<br />{<br />&nbsp; &nbsp; stop<br />&nbsp; &nbsp; start<br />}</p><br /><br /><p>chmod 755 /etc/init.d/usbfsmount<br />./usbfsmount enable</p><p>this creates /etc/rc.d/S17usbfsmount </p><p>thus the the root is pivoted asap and all further S** scripts and K** scripts are from the external usbfs not the internal flash <br />(alas this does not work . all the Sxx scipts from the jffs fs are run !?).</p><p>The usb drive cannot be mounted any sooner as the modules dont appear to be loaded in at the start of /etc/rcS ( loads of kernel warnings in dmesg)<br />so I put it after the S39usb ( now S15usb )</p><p>seems to work at the moment till i find a bug or 20.</p><br /><br /><p>mount the root contents somewhere so it can be copied<br />without copying /mnt and /proc to the new usb device<br />mkdir /tmp/root</p><p>mount -o bind / /tmp/root</p><p> now /tmp/root contains the root filesystem with no extra directories mounted<br /> copy this to the usb device<br />cp /tmp/root/* /mnt -a<br /> unmount both the usb and&nbsp; /tmp/root<br />umount /tmp/root<br />umount /mnt</p><p>this copies the jffs system to usb</p><br /><p>cd /<br />mkdir internal</p><p>this puts a directory in the jffs partition so that you can see if you are in the internal fs or the external just with ls</p><p>make a script /etc/init.d/pivotroot ie&nbsp; vi /etc/init.d/pivotroot</p><br /><br /><p>#!/bin/sh</p><p>/sbin/hotplug2 --override --persistent --max-children 1 --no-coldplug &amp;</p><p>for module in usbcore ehci-hcd scsi_mod sd_mod usb-storage ext2 ;do {<br />&nbsp; &nbsp; insmod $module<br />}; done</p><p>killall hotplug2</p><p>sleep 4s<br />mount /dev/sda1 /mnt<br />[ -x /mnt/sbin/init ] &amp;&amp; {<br />&nbsp; &nbsp; mount -o move /proc /mnt/proc &amp;&amp; \<br />&nbsp; &nbsp; pivot_root /mnt /mnt/mnt &amp;&amp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; mount -o move /mnt/dev /dev<br />&nbsp; &nbsp; &nbsp; &nbsp; mount -o move /mnt/tmp /tmp<br />&nbsp; &nbsp; &nbsp; &nbsp; mount -o move /mnt/jffs2 /jffs2 2&gt;&amp;-<br />&nbsp; &nbsp; &nbsp; &nbsp; mount -o move /mnt/sys /sys 2&gt;&amp;-<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />}</p><br /><br /><p>sleep4 may have to be increased if you are using a hard disc to allow time for it to settle</p><p>chmod 755 /etc/init.d/pivotroot</p><p>this will move the root test it and see</p><p>/etc.init.d/pivotroot<br />cd /<br />ls<br />is there a directory called &quot;internal&quot; if yes then it didn&#039;t work<br />if no then you are on the external usb drive so </p><p>mkdir external</p><p>reboot</p><p>You should reboot in the external usb fs</p><p>you can check with <br />cd /<br />ls<br />if you see external you are on the usb <br />if you see internal you are on the jffs</p><p>the old jffs can be found at /mnt</p><p>all installs should go to usbfs, but watch the start sripts they will go to /etc/init.d/ or /etc/rc.d/ of the usbfs<br />and will not get processed by the init/rc.d/ at boot . To be sorted.</p><br /><br /><p>**********************</p><p>bug 1 sorted</p><p>Bug 2</p><p>Mount points dont show up in luci now ?&nbsp; ( admin/system )</p><p>Bug 3</p><p>Anything added to /etc/rc.d/ will have to come after 40&nbsp; maybe I should move usb to 11 and usbfsmount to 12 <br />to minimise the effect<br />( done)</p><p>Bug 4</p><p>init does not carry on with the usbfs&#039;s&nbsp; /etc/rc.d/@S** after pivotroot ,but it continues with the internal jffs ones.</p><p>bug 5</p><p>if you want to install anything that uses /etc/rc.d/S** then you will have to manualy put it across from the external /etc/rc.d <br />to the internal one at /mnt/etc/rc.d/ and make sure it comes after S17</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116340">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">hamlet505a</div>
					<div class="post-datetime">
						2 Sep 2010, 20:26					</div>
				</div>
				<div class="post-content content">
					<p>pale thank you for your details.&nbsp; I have an ASUS WL-500gP v2.&nbsp; &nbsp;One difference between us is that I&#039;m on 2.4 kernel.&nbsp; I am using backfire 10.03.1-rc2.&nbsp; &nbsp;I perform the pivotroot test as stated in the directions and it appears to work.&nbsp; However, I did have to modify the pivotroot script for the usb2.0 by replacing uhci with ehci-hcd.&nbsp; I was getting errors until I made this switch.</p><p>root@OpenWrt:/etc/init.d# ./pivotroot <br />insmod: a module named usbcore already exists<br />insmod: a module named scsi_mod already exists<br />insmod: a module named sd_mod already exists<br />insmod: a module named usb-storage already exists<br />insmod: a module named jbd already exists<br />root@OpenWrt:/mnt/etc/init.d# df -h<br />Filesystem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Size&nbsp; &nbsp; &nbsp; Used Available Use% Mounted on<br />/dev/root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1.7M&nbsp; &nbsp; &nbsp; 1.7M&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 100% /mnt/rom<br />tmpfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 14.9M&nbsp; &nbsp; &nbsp;44.0K&nbsp; &nbsp; &nbsp;14.9M&nbsp; &nbsp;0% /tmp<br />/dev/mtdblock/4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5.6M&nbsp; &nbsp; &nbsp; 1.0M&nbsp; &nbsp; &nbsp; 4.6M&nbsp; 19% /mnt/overlay<br />mini_fo:/overlay&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.7M&nbsp; &nbsp; &nbsp; 1.7M&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 100% /mnt<br />/dev/scsi/host0/bus0/target0/lun0/part1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3.7G&nbsp; &nbsp; &nbsp;80.0M&nbsp; &nbsp; &nbsp; 3.4G&nbsp; &nbsp;2% /</p><br /><p>Above it looks like the file systems are now mounted from the usb drive that&#039;s in /mnt.&nbsp; I would guess that the pivotroot worked as I did not receive any errors.&nbsp; &nbsp;When I reboot, it does not seem to be booting from the usb drive.&nbsp; I think it has something to do with what you are working through.&nbsp; I&#039;ve copied the rcS script</p><p>I will look closer at what you are doing and compare to what I&#039;m doing...</p>											<p class="post-edited">(Last edited by <strong>hamlet505a</strong> on 2 Sep 2010, 20:28)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116343">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						2 Sep 2010, 21:19					</div>
				</div>
				<div class="post-content content">
					<p>I believe your system is just like mine and booting from the internal flash and then changing root to the usb and that is it.</p><p>I think it may be to do with having to get the init process to swap its root . I am about to try some things but I need to get samba working so that I can see if I am running the internal etc/rc.d or the external one, but I am having some trouble getting it to work at the momoent . I will be back with my findings .</p><p>Pale</p><p>EDIT <br />later </p><p>DONT add <br />exec chroot . sh &lt;dev/console &gt;dev/console 2&gt;&amp;1 <br />after the call to pivot root in rcS</p><p>It locks you out. heheheheh</p><p>Time for a reflash and start again . DOH!!</p><p>EDIT EDIT</p><p>Whilst I could not get in&nbsp; I did a port scan and Im sure it was udp port 445 was open (SMB) . this would sugest that samba had booted up which means I had run the external rc.d/S** . 445 is not up now after a reflash etc.</p><p>my rcS on internal is now</p><p>#!/bin/sh<br /># Copyright (C) 2006 OpenWrt.org</p><p>run_scripts() {<br />&nbsp; &nbsp; &nbsp; &nbsp; for i in /etc/rc.d/$1*; do<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ -x $i ] &amp;&amp; $i $2 2&gt;&amp;1<br />&nbsp; &nbsp; &nbsp; &nbsp; done | $LOGGER<br />}</p><p>LOGGER=&quot;cat&quot;<br />[ -x /usr/bin/logger ] &amp;&amp; LOGGER=&quot;logger -s -p 6 -t sysinit&quot;</p><p>if test $2 ==&quot;boot&quot; ; then<br />./etc/rc.d/S05luci_fixtime boot<br />./etc/rc.d/S10boot boot<br />./etc/rc.d/S15usb boot<br />./etc/rc.d/S17usbfsmount boot<br />/etc/init.d/pivotroot<br />fi</p><br /><p>if [ &quot;$1&quot; = &quot;S&quot; ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; run_scripts &quot;$1&quot; &quot;$2&quot; &amp;<br />else<br />&nbsp; &nbsp; &nbsp; &nbsp; run_scripts &quot;$1&quot; &quot;$2&quot;<br />fi</p><br /><p>this time around I will do </p><p>chroot /mnt</p><p>after the first fi</p><p>. I have deleted S05 S10 S15 S17 from the external. The system will still boot even if these are run twice you just get some processes running twice.</p><p>Oops i call pivotroot twices. once in S17 and again after . just off to fix this.</p>											<p class="post-edited">(Last edited by <strong>pale</strong> on 2 Sep 2010, 23:50)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116351">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						3 Sep 2010, 00:04					</div>
				</div>
				<div class="post-content content">
					<p>I changed rcS to this</p><p>#!/bin/sh<br /># Copyright (C) 2006 OpenWrt.org</p><p>run_scripts() {<br />&nbsp; &nbsp; &nbsp; &nbsp; for i in /etc/rc.d/$1*; do<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ -x $i ] &amp;&amp; $i $2 2&gt;&amp;1<br />&nbsp; &nbsp; &nbsp; &nbsp; done | $LOGGER<br />}</p><p>LOGGER=&quot;cat&quot;<br />[ -x /usr/bin/logger ] &amp;&amp; LOGGER=&quot;logger -s -p 6 -t sysinit&quot;</p><p>if test $2 ==&quot;boot&quot; ; then<br />./etc/rc.d/S05luci_fixtime boot<br />./etc/rc.d/S10boot boot<br />./etc/rc.d/S15usb boot<br />./etc/rc.d/S17usbfsmount boot<br />#pivotroot in S17<br />#/etc/init.d/pivotroot<br />fi</p><br /><p>if [ &quot;$1&quot; = &quot;S&quot; ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; run_scripts &quot;$1&quot; &quot;$2&quot; &amp;<br />else<br />&nbsp; &nbsp; &nbsp; &nbsp; run_scripts &quot;$1&quot; &quot;$2&quot;<br />fi</p><p>exec chroot /mnt</p><p>if [&quot;$1&quot; = &quot;S&quot; ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; run_scripts &quot;$1&quot; &quot;$2&quot; &amp;<br />else<br />&nbsp; &nbsp; &nbsp; &nbsp; run_scripts &quot;$1&quot; &quot;$2&quot;<br />fi</p><br /><br /><p>I run the S** before and after the exec chroot /mnt to try to stop myself from being locked out whilst I test the running of the external /etc<br /> this screws the services/ initscripts of luci. I get the following text , which is very similar to that that I get when i run exec chroot /mnt in a shell.<br />exec chroot on its own crashes the shell. I read somwhere that an error in exec will cause the calling process to terminate. I think this is what I did when I locked myself out. I terminated init </p><p>from luci services/initscripts</p><br /><p>BusyBox v1.15.3 (2010-07-11 15:57:41 PDT) built-in shell (ash)<br />Enter &#039;help&#039; for a list of built-in commands.</p><p>/ # </p><p>BusyBox v1.15.3 (2010-07-11 15:57:41 PDT) built-in shell (ash)<br />Enter &#039;help&#039; for a list of built-in commands.</p><p>/ # Status: 200 OK<br />X-CBI-State: 0<br />Vary: Accept<br />Content-Type: application/xhtml+xml<br />Cache-Control: no-cache<br />Expires: 0</p><br /><p>etc..............</p><p>I have been readin the pivot_root (8) manual and I dont quite follow the examples.</p><br /><p>EDIt</p><p>This router keeps saving my editted scripts in the wrong place its is a bit erratic ??!!!</p>											<p class="post-edited">(Last edited by <strong>pale</strong> on 3 Sep 2010, 00:14)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116353">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						3 Sep 2010, 00:26					</div>
				</div>
				<div class="post-content content">
					<p>root@OpenWrt:~# ps<br />&nbsp; PID USER&nbsp; &nbsp; &nbsp; &nbsp;VSZ STAT COMMAND<br />&nbsp; &nbsp; 1 root&nbsp; &nbsp; &nbsp; 1364 S&nbsp; &nbsp; init<br />&nbsp; &nbsp; 2 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[kthreadd]<br />&nbsp; &nbsp; 3 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[ksoftirqd/0]<br />&nbsp; &nbsp; 4 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[events/0]<br />&nbsp; &nbsp; 5 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[khelper]<br />&nbsp; &nbsp; 8 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[async/mgr]<br />&nbsp; &nbsp;36 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[sync_supers]<br />&nbsp; &nbsp;38 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[bdi-default]<br />&nbsp; &nbsp;40 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[kblockd/0]<br />&nbsp; &nbsp;73 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[kswapd0]<br />&nbsp; &nbsp;74 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[aio/0]<br />&nbsp; &nbsp;75 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[crypto/0]<br />&nbsp; &nbsp;87 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[mtdblockd]<br />&nbsp; 249 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SWN&nbsp; [jffs2_gcd_mtd3]<br />&nbsp; 273 root&nbsp; &nbsp; &nbsp; 1368 S&nbsp; &nbsp; syslogd -C16<br />&nbsp; 275 root&nbsp; &nbsp; &nbsp; 1348 S&nbsp; &nbsp; klogd<br />&nbsp; 289 root&nbsp; &nbsp; &nbsp; &nbsp;776 S&nbsp; &nbsp; /sbin/hotplug2 --override --persistent --set-worker /<br />&nbsp; 357 root&nbsp; &nbsp; &nbsp; 1360 S&nbsp; &nbsp; udhcpc -t 0 -i eth0 -b -p /var/run/dhcp-eth0.pid -O r<br />&nbsp; 462 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[cfg80211]<br />&nbsp; 525 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[khubd]<br />&nbsp; 538 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[phy0]<br />&nbsp; 604 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[scsi_eh_0]<br />&nbsp; 608 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[usb-storage]<br />&nbsp; 633 root&nbsp; &nbsp; &nbsp; 1364 S&nbsp; &nbsp; init<br />&nbsp; 652 root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 SW&nbsp; &nbsp;[flush-8:0]<br />&nbsp; 848 root&nbsp; &nbsp; &nbsp; 1144 S&nbsp; &nbsp; /usr/sbin/dropbear -p 22 -P /var/run/dropbear.1.pid<br />&nbsp; 856 root&nbsp; &nbsp; &nbsp; 1464 S&nbsp; &nbsp; /usr/sbin/uhttpd -f -h /www -r OpenWrt -x /cgi-bin -t<br />&nbsp; 874 nobody&nbsp; &nbsp; &nbsp;904 S&nbsp; &nbsp; /usr/sbin/dnsmasq -K -D -y -Z -b -E -s lan -S /lan/ -<br />&nbsp; 883 root&nbsp; &nbsp; &nbsp; 2628 S N&nbsp; smbd -D&nbsp; &lt;----------------------------------------------------------Whoopee dooo<br />&nbsp; 885 root&nbsp; &nbsp; &nbsp; 2124 S&nbsp; &nbsp; nmbd -D&nbsp; &nbsp;&lt;-----------------------------------------------------------Whoopee doo<br />&nbsp; 892 root&nbsp; &nbsp; &nbsp; 1348 S&nbsp; &nbsp; watchdog -t 5 /dev/watchdog<br />&nbsp; 895 root&nbsp; &nbsp; &nbsp; 1200 S&nbsp; &nbsp; /usr/sbin/dropbear -p 22 -P /var/run/dropbear.1.pid<br />&nbsp; 896 root&nbsp; &nbsp; &nbsp; 1364 S&nbsp; &nbsp; -ash<br />&nbsp; 901 root&nbsp; &nbsp; &nbsp; 1356 R&nbsp; &nbsp; ps<br />root@OpenWrt:~#</p><br /><p>my internal rcS</p><p>root@OpenWrt:/etc/init.d# cd /mnt/etc/init.d<br />root@OpenWrt:/mnt/etc/init.d# cat rcS<br />#!/bin/sh<br /># Copyright (C) 2006 OpenWrt.org<br />##################<br />#internal<br />###############</p><p>run_scripts() {<br />&nbsp; &nbsp; &nbsp; &nbsp; for i in /etc/rc.d/$1*; do<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ -x $i ] &amp;&amp; $i $2 2&gt;&amp;1<br />&nbsp; &nbsp; &nbsp; &nbsp; done | $LOGGER<br />}</p><p>LOGGER=&quot;cat&quot;<br />[ -x /usr/bin/logger ] &amp;&amp; LOGGER=&quot;logger -s -p 6 -t sysinit&quot;</p><p>if test $2 == &quot;boot&quot; ; then<br />./etc/rc.d/S05luci_fixtime boot<br />./etc/rc.d/S10boot boot<br />./etc/rc.d/S15usb boot<br />./etc/rc.d/S17usbfsmount boot<br />#pivotroot in S17<br />#/etc/init.d/pivotroot<br />fi</p><br /><p>if [ &quot;$1&quot; = &quot;S&quot; ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; run_scripts &quot;$1&quot; &quot;$2&quot; &amp;<br />else<br />&nbsp; &nbsp; &nbsp; &nbsp; run_scripts &quot;$1&quot; &quot;$2&quot;<br />fi</p><p>exec chroot /mnt sh &lt;dev/console &gt;dev/console 2&gt;&amp;1</p><p>if [&quot;$1&quot; = &quot;S&quot; ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; run_scripts &quot;$1&quot; &quot;$2&quot; &amp;<br />else<br />&nbsp; &nbsp; &nbsp; &nbsp; run_scripts &quot;$1&quot; &quot;$2&quot;<br />fi<br />root@OpenWrt:/mnt/etc/init.d#</p><br /><br /><p>Samba which is only on the external has started from the external /etc/rc.d/S60</p><p>I will now dare to comment out the first if runscripts section. <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116354">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						3 Sep 2010, 00:37					</div>
				</div>
				<div class="post-content content">
					<p>I dared and locked myself out again <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><br /><p>well the above rcS seems to work . ie it runs the internal and external rc.d/S**</p><p>all scripts end up running twice though. When I have reflashed and rebuilt again I will delete all internal S** from the external rc.d/&nbsp; and not bother with the first if test=&quot;boot&quot; loop&nbsp; thus all scripts should run once only.</p><p><img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>pale</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116356">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">hamlet505a</div>
					<div class="post-datetime">
						3 Sep 2010, 01:26					</div>
				</div>
				<div class="post-content content">
					<p>I have locked myself out twice today as well!!!!&nbsp; &nbsp;This darn startup script ordering!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116378">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						3 Sep 2010, 17:32					</div>
				</div>
				<div class="post-content content">
					<p>well I commented out the first if test &quot;boot&quot; loop and bricked it again. It would seem as if S10 boot needs to run twice to stop this? My aim is to get as much of the boot onto the external /etc/rc.d as posible. this lack of chroot in the running script is a pain. The manual for pivot root says the calling routine may or may not change root. Great thanks powers that be. I shall attempt to put the s10 s15 and s17 in the preinit script so the pivot root happens in a different script thus hopefuly the /init/rcS runs in the new root.</p><p>Off to de brick again</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116398">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">hamlet505a</div>
					<div class="post-datetime">
						3 Sep 2010, 20:38					</div>
				</div>
				<div class="post-content content">
					<p>OK.. I finally got mine to work reasonably well.&nbsp; &nbsp;I basically have done what you have done by adding the S15usb and S17usbfsmount.&nbsp; &nbsp; It seems to properly switch over to use the usb drive to continue booting after the S17 script.&nbsp; Here is my pivotroot script:</p><p>#!/bin/sh<br />#change this to your boot partition<br />boot_dev=&quot;/dev/discs/disc0/part1&quot;<br /># install needed modules for usb and the ext3 filesystem<br /># **NOTE** for usb2.0 replace &quot;uhci&quot; with &quot;ehci_hcd&quot;<br /># **NOTE** for ohci chipsets replace &quot;uhci&quot; with &quot;usb-ohci&quot;<br />for module in usbcore usb-ohci scsi_mod sd_mod usb-storage jbd kmod-fs-ext2 kmod-fs-ext3 ; do {<br />&nbsp; &nbsp; &nbsp; &nbsp; insmod $module<br />&nbsp; &nbsp; &nbsp; &nbsp; }; done<br />&nbsp; &nbsp; &nbsp; &nbsp; # this may need to be higher if your disk is slow to initialize<br />&nbsp; &nbsp; &nbsp; &nbsp; sleep 4s<br />&nbsp; &nbsp; &nbsp; &nbsp; # mount the usb stick<br />&nbsp; &nbsp; &nbsp; &nbsp; mount &quot;$boot_dev&quot; /mnt<br />&nbsp; &nbsp; &nbsp; &nbsp; # if everything looks ok, do the pivot root<br />&nbsp; &nbsp; &nbsp; &nbsp; [ -x /mnt/sbin/init ] &amp;&amp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mount -o move /proc /mnt/proc &amp;&amp; \<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pivot_root /mnt /mnt/mnt &amp;&amp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mount -o move /mnt/dev /dev<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mount -o move /mnt/tmp /tmp<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mount -o move /mnt/jffs2 /jffs2 2&gt;&amp;-<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mount -o move /mnt/sys /sys 2&gt;&amp;-<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />I had to use ohci&nbsp; modules otherwise the pivotroot script would not work properly.</p><p>So now after a reboot I see this:<br />root@OpenWrt:/etc/init.d# df -h<br />Filesystem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Size&nbsp; &nbsp; &nbsp; Used Available Use% Mounted on<br />/dev/root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1.7M&nbsp; &nbsp; &nbsp; 1.7M&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 100% /mnt/rom<br />tmpfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 14.9M&nbsp; &nbsp; &nbsp;40.0K&nbsp; &nbsp; &nbsp;14.9M&nbsp; &nbsp;0% /tmp<br />/dev/mtdblock/4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5.6M&nbsp; &nbsp; &nbsp; 1.0M&nbsp; &nbsp; &nbsp; 4.6M&nbsp; 19% /mnt/overlay<br />mini_fo:/overlay&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.7M&nbsp; &nbsp; &nbsp; 1.7M&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 100% /mnt<br />/dev/discs/disc0/part1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3.7G&nbsp; &nbsp; &nbsp;84.1M&nbsp; &nbsp; &nbsp; 3.4G&nbsp; &nbsp;2% /</p><p>All seems to be properly switched over to the usb drive.&nbsp; &nbsp; I like the feature that if your usb stick is unavailable, that the router will still boot and function as a router.&nbsp; I am curious as you are as if you can move even more the boot onto the usb stick.&nbsp; &nbsp; &nbsp;Will the usb stick be a requirement then?&nbsp; &nbsp;</p><p>From reading your posts, it sounds to me that S10 gets run twice?&nbsp; &nbsp;I&#039;ll re-read your posts and see what is happening on my router...</p>											<p class="post-edited">(Last edited by <strong>hamlet505a</strong> on 3 Sep 2010, 20:57)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116408">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						4 Sep 2010, 00:28					</div>
				</div>
				<div class="post-content content">
					<p>could you post your rcS please</p><p>If i read your last post correct the init process is changing root for you. I am on Kernel 2.6.32.16-1</p><br /><br /><p>Aye the root changes over to the new one ok . I&#039;ve had that from the start. What I want is for the /etc/rc.d/S** to change over from the internal flash after S17usbfsmount which calls the pivotroot script. The root pivots ok but the etc/init.d/rcS , which is halfway through running does not change its root. It continues to process the /etc/rc.d/S** in the internal flash and then completely ignores the /etc/rc.d/S** in the usb.&nbsp; I thought I would have the first part of the scripts running from the internal flash . these bits would not change. but once the usbfs is mounted i want the processing of the internal rc.d/S** to stop and the external one to start . thus If I install any thing later its startup scripts will go in the external /etc/rc.d/S** and be started at boot. I tried to put the S05 S10 S15 S17 in the preinit so that they were part of the initialisation and so that the /etc/rc.d/S** could be left alone. but it wont run the scripts. </p><p>the&nbsp; &nbsp;<br />exec chroot /mnt sh &lt;dev/console &gt;dev/console 2&gt;&amp;1</p><p>was my attempt to force the init task to chroot to the new root thus /etc/rc.d/ pointed to the usb drive.</p><p>which worked.</p><p>running the scripts twice might screw the system. I also dont want there to be a situation where you change say the network setting in the external etc/rc.d/ and not the internal this could cause confusion / confict later. It is best to have one script for each task only.</p><p>I tried <br />root@OpenWrt:/mnt/etc/init.d# cat rcS<br />#!/bin/sh<br /># Copyright (C) 2006 OpenWrt.org<br />##################<br />#internal<br />###############</p><p>run_scripts() {<br />&nbsp; &nbsp; &nbsp; &nbsp; for i in /etc/rc.d/$1*; do<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ -x $i ] &amp;&amp; $i $2 2&gt;&amp;1<br />&nbsp; &nbsp; &nbsp; &nbsp; done | $LOGGER<br />}</p><p>run_scriptsext() {<br />&nbsp; &nbsp; &nbsp; &nbsp; for i in /mnt/etc/rc.d/$1*; do<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ -x $i ] &amp;&amp; $i $2 2&gt;&amp;1<br />&nbsp; &nbsp; &nbsp; &nbsp; done | $LOGGER<br />}</p><p>LOGGER=&quot;cat&quot;<br />[ -x /usr/bin/logger ] &amp;&amp; LOGGER=&quot;logger -s -p 6 -t sysinit&quot;</p><br /><br /><br /><p>if [ &quot;$1&quot; = &quot;S&quot; ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; run_scripts &quot;$1&quot; &quot;$2&quot; &amp;<br />else<br />&nbsp; &nbsp; &nbsp; &nbsp; run_scripts &quot;$1&quot; &quot;$2&quot;<br />fi</p><br /><p>if [&quot;$1&quot; = &quot;S&quot; ]; then<br />&nbsp; &nbsp; &nbsp; &nbsp; run_scriptsext &quot;$1&quot; &quot;$2&quot; &amp;<br />else<br />&nbsp; &nbsp; &nbsp; &nbsp; run_scriptsext &quot;$1&quot; &quot;$2&quot;<br />fi</p><br /><p>and puting S05,10,15,17 in the internal ( s17 calls pivotroot&nbsp; but init still in old root&nbsp; thus /mnt/etc/rc.d/S**)<br />and S40 etc.. in the external</p><p>Bricked it again. ???</p><p>What would be realy nice is the internal rc.d is run if there is no usb , but if there is then only the external rc.d is run. This is why i tried the starting of the usb in the preinit. I still dont see why this didnt work. </p><p>thinking about it if the root of a child process is the same as the parent then /mnt/etc/rc.d/S** processing wont work as the scripts will point to the wrong locations.</p><p>the block-extroot process moves the root in the preinit , but alas how do i compile 10.03-1 rc1 ( or3) . block-extroot even though you can install it wont work unless it is precompiled in the squashfs. </p><p>Being able to boot from flash or usb is nice but I would be happy with one that just booted from the usb. ( i have a adm5120 that does just this ) I can always backup the system then. I would have thought that having the ability to boot from usb would be a standard part of openwrt as there are so many apps that need the extra space. Maybe I&#039;m at the wrong end of the stick. I want to use my hacked router as a stand alone pc not as a router. I have no need of the adsl or enhanced routing. the wifi is not needed at the moment either but that might be needed later.</p><p>My goodness I rant on dont I <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>off to try another config</p>											<p class="post-edited">(Last edited by <strong>pale</strong> on 4 Sep 2010, 00:35)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116409">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						4 Sep 2010, 00:46					</div>
				</div>
				<div class="post-content content">
					<p>kmod-usb-storage some times crashes the router when installed via luci and always crashes if opkg install kmod-usb-storage in terminal.</p><p>EDIT</p><p>FFS I have rebuilt to the rcS that runs internal and external rc.d but now it wont work.!!!!!!!!!!!!!!</p>											<p class="post-edited">(Last edited by <strong>pale</strong> on 4 Sep 2010, 01:18)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116440">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">pale</div>
					<div class="post-datetime">
						4 Sep 2010, 13:21					</div>
				</div>
				<div class="post-content content">
					<p>New tack today. The first attempt has locked me out again, but.</p><p>run S05 S10 S15 S17 from internal etc/rc.d/ by renaming all the S** after 17 as L** ie S40 = L40 so that they dont get picked up by the rcS script</p><p>set up rc.local on the internal flash to run a similar loop that does L**. thus if there is no external usb then all runs from internal</p><p>set up external rc.local to run a similar loop that does the same as rcS but will by default execute the scripts in the external /etc/rc.d. </p><p>I have noticed that the pivot root changes the root of rc.local correctly . ie I called the S60samba from the rc.local in the external flash and all work correct.</p><p>The idea is to have the S05 S10 S15 S17 run from internal as normal. at this stage the system thinks it has finnished the boot and will go on to do the user scripts in rc.local.&nbsp; rc.local&#039;s location will have changed depending on whether the usb mounted or not.</p><p>EDIT</p><p>Well this looks scuppered too. the S95done process is the one that calls rc.local</p>											<p class="post-edited">(Last edited by <strong>pale</strong> on 4 Sep 2010, 14:01)</p>
									</div>
			</article>

			
		
						<div class="notice">
				<p>Sorry, posts 26 to 25 are missing from our archive.</p>
			</div>
		
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 4</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=26262&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=26262&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=26262&amp;p=4.html">4</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>