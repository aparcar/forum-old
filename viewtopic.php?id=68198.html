<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Problems with dnsmasq and local hostnames</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 29 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p341817">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">gward</div>
					<div class="post-datetime">
						22 Oct 2016, 19:34					</div>
				</div>
				<div class="post-content content">
					<p>Hi all,</p><p>I&#039;m having a hard time getting dnsmasq to answer DNS queries for local hostnames, whether I configure them in /etc/hosts or using static DHCP leases. I&#039;m running OpenWRT 15.05 with dnsmasq 2.73 on a Turris Omnia router.</p><p>What I want is simple: when $host gets an IP address $a from the DHCP server, DNS queries for $host should return $a. If I have to configure static DHCP leases for this to work, that&#039;s fine -- I like knowing what my IP address is going to be anyways. From the OpenWRT docs, it sounds like this is exactly what dnsmasq is designed for, and OpenWRT configures it to do that by default. So I&#039;m confused as to why it&#039;s not working for me.</p><p>First, here is my /etc/config/dhcp file (generated by luci):<br /></p><div class="codebox"><pre><code>root@turris:/etc# cat /etc/config/dhcp 

config dnsmasq
    option domainneeded &#039;1&#039;
    option boguspriv &#039;1&#039;
    option localise_queries &#039;1&#039;
    option rebind_protection &#039;1&#039;
    option rebind_localhost &#039;1&#039;
    option domain &#039;lan&#039;
    option expandhosts &#039;1&#039;
    option authoritative &#039;1&#039;
    option readethers &#039;1&#039;
    option leasefile &#039;/tmp/dhcp.leases&#039;
    option resolvfile &#039;/tmp/resolv.conf.auto&#039;
    option localservice &#039;1&#039;
    option port &#039;0&#039;
    option logqueries &#039;1&#039;
    option nonwildcard &#039;0&#039;
    option local &#039;/lan/&#039;

config dhcp &#039;lan&#039;
    option interface &#039;lan&#039;
    option limit &#039;150&#039;
    option leasetime &#039;12h&#039;
    option dhcpv6 &#039;server&#039;
    option ra &#039;server&#039;
    option ignore &#039;0&#039;
    option start &#039;2&#039;
    list dhcp_option &#039;6,192.168.45.1&#039;

config dhcp &#039;wan&#039;
    option interface &#039;wan&#039;
    option ignore &#039;1&#039;

config odhcpd &#039;odhcpd&#039;
    option maindhcp &#039;0&#039;
    option leasefile &#039;/tmp/hosts/odhcpd&#039;
    option leasetrigger &#039;/usr/sbin/odhcpd-update&#039;

config host
    option name &#039;namazu0&#039;
    option mac &#039;00:21:86:a2:97:1a&#039;
    option ip &#039;192.168.45.3&#039;

config host
    option name &#039;namazu1&#039;
    option mac &#039;00:21:6b:ac:e3:d6&#039;
    option ip &#039;192.168.45.4&#039;</code></pre></div><p>(namazu is a single laptop: namazu0 is its wired interface, namazu1 wireless.)</p><p>And the resulting dnsmasq.conf:<br /></p><div class="codebox"><pre><code>root@turris:/etc# cat /var/etc/dnsmasq.conf 
# auto-generated config file from /etc/config/dhcp
conf-file=/etc/dnsmasq.conf
dhcp-authoritative
domain-needed
log-queries
localise-queries
read-ethers
bogus-priv
expand-hosts
local-service
port=0
domain=lan
server=/lan/
dhcp-leasefile=/tmp/dhcp.leases
resolv-file=/tmp/resolv.conf.auto
addn-hosts=/tmp/hosts
conf-dir=/tmp/dnsmasq.d
stop-dns-rebind
rebind-localhost-ok
dhcp-broadcast=tag:needs-broadcast

dhcp-host=00:21:86:a2:97:1a,192.168.45.3,namazu0
dhcp-host=00:21:6b:ac:e3:d6,192.168.45.4,namazu1



dhcp-range=lan,192.168.45.2,192.168.45.151,255.255.255.0,12h
dhcp-option=lan,6,192.168.45.1
no-dhcp-interface=eth1</code></pre></div><p>IIUC, that &quot;server=/lan/&quot; entry in dnsmasq.conf is the important one that is supposed to make things work. But it doesn&#039;t.</p><p>First, I&#039;ve defined a bogus hostname in /etc/hosts to see if I can get back its bogus IP address:<br /></p><div class="codebox"><pre><code>root@turris:/etc# cat /etc/hosts
127.0.0.1 localhost
5.6.7.8 flarp.lan flarp</code></pre></div><p>No luck:<br /></p><div class="codebox"><pre><code>root@turris:/etc# dig +short flarp.lan @127.0.0.1
root@turris:/etc# dig +short flarp @127.0.0.1</code></pre></div><p>(No output to either query.)</p><p>And now one of the hostnames defined by a static lease:<br /></p><div class="codebox"><pre><code>root@turris:/etc# dig +short namazu0 @127.0.0.1
root@turris:/etc# dig +short namazu0.lan @127.0.0.1</code></pre></div><p>I&#039;m stumped. I must be missing something simple and obvious, but I&#039;ve been through the OpenWRT docs and the dnsmasq man page and I can&#039;t see it. Help!</p><p>Thanks,</p><p>Greg</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341818">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">bolvan</div>
					<div class="post-datetime">
						22 Oct 2016, 19:37					</div>
				</div>
				<div class="post-content content">
					<p>Possibly because of rebind_protection. Also why &quot;port 0&quot; ? See syslog for details (logread command)</p>											<p class="post-edited">(Last edited by <strong>bolvan</strong> on 22 Oct 2016, 19:39)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341838">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">gward</div>
					<div class="post-datetime">
						22 Oct 2016, 23:17					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bolvan wrote:</cite><blockquote><p>Possibly because of rebind_protection. Also why &quot;port 0&quot; ? See syslog for details (logread command)</p></blockquote></div><p>A-HA!! It took a bit more digging, but that &quot;port 0&quot; was the clue I needed. Thank you!</p><p>Short version: on the Turris Omnia, something called kresd is already listening on port 53. When I reconfigured dnsmasq with &quot;port 53&quot;, it failed to start:<br /></p><div class="codebox"><pre><code>2016-10-22T20:00:46-04:00 crit dnsmasq[19251]: failed to create listening socket for port 53: Address in use
2016-10-22T20:00:46-04:00 crit dnsmasq[19251]: FAILED to start up
2016-10-22T20:00:51-04:00 crit dnsmasq[19292]: failed to create listening socket for port 53: Address in use
2016-10-22T20:00:51-04:00 crit dnsmasq[19292]: FAILED to start up
2016-10-22T20:00:56-04:00 crit dnsmasq[19323]: failed to create listening socket for port 53: Address in use
2016-10-22T20:00:56-04:00 crit dnsmasq[19323]: FAILED to start up
2016-10-22T20:01:01-04:00 crit dnsmasq[19361]: failed to create listening socket for port 53: Address in use
2016-10-22T20:01:01-04:00 crit dnsmasq[19361]: FAILED to start up
2016-10-22T20:01:06-04:00 crit dnsmasq[19400]: failed to create listening socket for port 53: Address in use
2016-10-22T20:01:06-04:00 crit dnsmasq[19400]: FAILED to start up
2016-10-22T20:01:11-04:00 crit dnsmasq[19431]: failed to create listening socket for port 53: Address in use
2016-10-22T20:01:11-04:00 crit dnsmasq[19431]: FAILED to start up
2016-10-22T20:01:11-04:00 info procd[]: Instance dnsmasq::instance1 s in a crash loop 6 crashes, 0 seconds since last crash</code></pre></div><p>I found the culprit with netstat:<br /></p><div class="codebox"><pre><code>root@turris:/etc# netstat -ulnp | grep :53
udp        0    704 0.0.0.0:53              0.0.0.0:*                           2380/kresd
udp        0      0 :::53                   :::*                                2380/kresd</code></pre></div><p>Googling for &quot;openwrt kresd&quot; didn&#039;t find much, but it looks like kresd is from a package called knot-resolver. I&#039;ve never heard of that, but it looks like that&#039;s what the folks behind the Turris Omnia selected as the local DNS server, instead of dnsmasq.</p><p>I configured dnsmasq to listen on port 553, and used &quot;dig -p 553&quot; to send queries to it: worked perfectly, resolving both real hostnames from static leases and bogus hostnames from /etc/hosts.</p><p>So... either I need to figure out how to disable kresd and use dnsmasq instead, or configure kresd to use dnsmasq for local hostnames.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341868">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">bolvan</div>
					<div class="post-datetime">
						23 Oct 2016, 10:41					</div>
				</div>
				<div class="post-content content">
					<p>All daemons usually start with init script in /etc/init.d<br />Search there. if you find something like &quot;/etc/init.d/kresd&quot; then<br />/etc/init.d/kresd stop<br />/etc/init.d/kresd disable<br />If not then do textual search for all files in /etc/init.d for the string &quot;kresd&quot;.<br />If nothing found do the same for the whole fs<br />Also search packages for the name, possibly its installed as a package<br />opkg list | grep kresd</p>											<p class="post-edited">(Last edited by <strong>bolvan</strong> on 23 Oct 2016, 10:42)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p342050">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">bogon</div>
					<div class="post-datetime">
						25 Oct 2016, 09:38					</div>
				</div>
				<div class="post-content content">
					<p>You may find this topic useful: discourse dot labs dot nic dot cz/t/dnsmasq-local-domain-issue/924<br />The Knot resolver is made by CZ.nic, the same guys who designed the Omnia,</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>