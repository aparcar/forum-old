<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> SSH Tunnel to work as VPN.</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 7 Apr 2018 and 29 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=67632&amp;p=2.html">2</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p338644">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">vital21</div>
					<div class="post-datetime">
						19 Sep 2016, 17:34					</div>
				</div>
				<div class="post-content content">
					<p>Hi guys,</p><p>my device is: TL-MR3040 v1</p><p>software : chaos_calmer/15.05.1</p><p>I&#039;m not sure if this is the right place for my questions, but hope that you could help!</p><p>My goal is to set up a SSH tunnel that will forward all wireless clients to SSH server. <br />The same thing do a built-in VPN service...so maybe it&#039;s possible to do the same trick with SSH? How do you think?</p><p>I will very appreciate any advice or link to related discussions!</p><p>Unfortunately I cant achieve my goal for a 3 months already....even google doesnt help(</p><p>Cheers!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p338676">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">eduperez</div>
					<div class="post-datetime">
						20 Sep 2016, 00:51					</div>
				</div>
				<div class="post-content content">
					<p>I think you should be more specific about what you have tried and what failed.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p338680">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">iasimov</div>
					<div class="post-datetime">
						20 Sep 2016, 01:28					</div>
				</div>
				<div class="post-content content">
					<p>SSH allows set up a Socks Proxy server, but this only will redirect TCP connections, not UDP.</p><p>If you want to redirect a whole internet connection (TCP and UDP datagrams) like VPN you will need another software running in the server besides ssh daemon.</p><p>The simplest thing: Run locally in the server a VPN server and connect through a redirection in ssh.</p>											<p class="post-edited">(Last edited by <strong>iasimov</strong> on 20 Sep 2016, 01:29)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p340594">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">vital21</div>
					<div class="post-datetime">
						8 Oct 2016, 16:59					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>iasimov wrote:</cite><blockquote><p>SSH allows set up a Socks Proxy server, but this only will redirect TCP connections, not UDP.</p><p>If you want to redirect a whole internet connection (TCP and UDP datagrams) like VPN you will need another software running in the server besides ssh daemon.</p><p>The simplest thing: Run locally in the server a VPN server and connect through a redirection in ssh.</p></blockquote></div><p>Hi, could you give more info about &quot;connect through a redirection in ssh&quot;? Is it possible to use SSH client while connecting to VPN server?</p><br /><br /><br /><p><em>И если говоришь по ру, то не мог бы оставить какой то контактик свой?</em></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p340596">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">bolvan</div>
					<div class="post-datetime">
						8 Oct 2016, 17:17					</div>
				</div>
				<div class="post-content content">
					<p>I use&nbsp; &nbsp;ssh dynamic port redirection (socks5) + redsocks + iptables redirect for transparent redirection of selected TCP connections. With some magic it works fine</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341073">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">vital21</div>
					<div class="post-datetime">
						14 Oct 2016, 10:26					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bolvan wrote:</cite><blockquote><p>I use&nbsp; &nbsp;ssh dynamic port redirection (socks5) + redsocks + iptables redirect for transparent redirection of selected TCP connections. With some magic it works fine</p></blockquote></div><p>Hi, would you mind to give some advices or a brief guide &quot;how to setup&quot; using your method?</p><p>Maybe you have any kind of IM available for some communication?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341079">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">bolvan</div>
					<div class="post-datetime">
						14 Oct 2016, 12:20					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>vital21 wrote:</cite><blockquote><p>Hi, would you mind to give some advices or a brief guide &quot;how to setup&quot; using your method?</p></blockquote></div><p>Its quite a long story and probably impossible to do for copy-pasters <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> But fundamentally its quite easy, you just need to understand the logic, then process becomes interesting. Also may be some my decisions are not perfect, if you can suggest something shorter and more effective pls do it.</p><p>1)<br />openssh (not dropbear) client can give you local socks on selected port using server&#039;s ssh port redirection<br />create another (non-root) user, su, use ssh-keygen to create keys, copy pub key to &quot;authorized_keys&quot; on server (google for configuring key authentication in openssh)<br />After all done test if it works with curl.</p><div class="codebox"><pre><code>opkg update
opkg install --force-overwrite openssh-client openssh-client-utils curl shadow-useradd
useradd -d /home/proxy proxy
mkdir -p /home/proxy
chown proxy:proxy /home/proxy
# openssh client barks if it has no access to /dev/tty
echo &quot;chmod 666 /dev/tty&quot; &gt;&gt;/etc/rc.local
chmod 666 /dev/tty
su proxy
cd
mkdir -m 700 .ssh
cd .ssh
ssh-keygen
# should see id_rsa id_rsa.pub
ls
# copy id_rsa.pub to authorized_keys on server
ssh -N -D 1098 -l proxy vps.mydomain.com
# in parallel session test with curl
curl --socks5 127.0.0.1:1098 http://google.com</code></pre></div><br /><p>2)<br />Create a way to keep openssh always running. Restart it if it disconnects.<br />/etc/init.d/socks_vps :<br /></p><div class="codebox"><pre><code>#!/bin/sh /etc/rc.common
# opkg install procps-ng-pgrep coreutils-nohup
START=95
STOP=10
USER=proxy
SCRIPT_DIR=/etc/my
SCRIPT=socks_vps.sh
LOGDIR=/var/log/socks_vps
restart() {
stop
start
}
start() {
[ -d $LOGDIR ] || {
     mkdir $LOGDIR
     chown $USER $LOGDIR
}
pgrep -U $USER $SCRIPT &gt;/dev/null || su -c $SCRIPT_DIR/$SCRIPT $USER &amp;
}
stop() {
killall $SCRIPT 2&gt;/dev/null
PID=$(pgrep -U $USER ssh)
[ -n &quot;$PID&quot; ] &amp;&amp; kill $PID
sleep 1
return 0
}</code></pre></div><p>/etc/my/socks_vps.sh <br /></p><div class="codebox"><pre><code>#!/bin/sh
# opkg install coreutils-nohup
trap &quot;&quot; SIGHUP SIGINT
while :
do
    nohup ssh -4 -N -D 1098 -l proxy vps.mydomain.com &gt;/dev/null 2&gt;/var/log/socks_vps/svps.2.log
    sleep 10
done</code></pre></div><br /><div class="codebox"><pre><code>opkg install procps-ng-pgrep coreutils-nohup
chmod +x /etc/my/socks_vps.sh
chmod +x /etc/init.d/socks_vps</code></pre></div><p>Start : /etc/init.d/socks_vps start<br />Stop : /etc/init.d/socks_vps stop<br />Enable autoload : /etc/init.d/socks_vps enable</p><br /><p>3) (updated)<br />Obtain redsocks package. Its present only in CC 15.05 and DD+. CC and DD use different libc and executables are not compatible. If you&#039;re on 15.05 or DD - just install from repo. If you&#039;re on &lt;15.05 then take ipk from 15.05 and install manually.</p><p>4) Configure redsocks and make it always running.<br />/etc/redsocks.conf<br /></p><div class="codebox"><pre><code>........
      local_ip = 127.0.0.1;
      local_port = 1099;
........
      ip = 127.0.0.1;
      port = 1098;
      type = socks5;
........</code></pre></div><p>The shit is that it cant start with normal /etc/init.d script because at the moment of its execution even &quot;lo&quot; is not up and executable exits with error. So hang on hotplug event and start from there<br />/etc/hotplug.d/iface/99-exec-on-updown <br /></p><div class="codebox"><pre><code>#!/bin/sh
local cmd
if [ &quot;$ACTION&quot; = ifup ]; then
cmd=$(uci get network.$INTERFACE.exec_on_up)
[ -n &quot;$cmd&quot; ] &amp;&amp; $cmd
fi
if [ &quot;$ACTION&quot; = ifdown ]; then
cmd=$(uci get network.$INTERFACE.exec_on_down)
[ -n &quot;$cmd&quot; ] &amp;&amp; $cmd
fi</code></pre></div><p>/etc/init.d/network<br /></p><div class="codebox"><pre><code>config interface &#039;wan&#039;
        ........
        option exec_on_up &#039;/etc/init.d/redsocks start&#039;</code></pre></div><br /><div class="codebox"><pre><code># autostart not working because network is down
/etc/init.d/redsocks disable
/etc/init.d/redsocks start</code></pre></div><p>5)<br />And the final part. Create iptables filter to redirect some connections to transparent proxy &quot;redsocks&quot;<br />The reason why I started all this is russian censorship machine. They block web sites. I break http by fooling DPI but https must be redirected. I created ipset &quot;zapret&quot;. It contains blocked IP addresses </p><p>/etc/firewall.user<br /></p><div class="codebox"><pre><code>SOXIFIER_PORT=1099
. /lib/functions/network.sh
# connections originating from router
network_find_wan wan_iface
for ext_iface in $wan_iface; do
    network_get_device ext_device $ext_iface
    iptables -t nat -C OUTPUT -p tcp --dport 443 -o $ext_device -m set --match-set zapret dst -j REDIRECT --to-port $SOXIFIER_PORT ||
     iptables -t nat -I OUTPUT -p tcp --dport 443 -o $ext_device -m set --match-set zapret dst -j REDIRECT --to-port $SOXIFIER_PORT
done
# forwarded connections
sysctl -w net.ipv4.conf.br-lan.route_localnet=1
iptables -t nat -C prerouting_lan_rule -p tcp --dport 443 -m set --match-set zapret dst -j DNAT --to 127.0.0.1:$SOXIFIER_PORT ||
iptables -t nat -I prerouting_lan_rule -p tcp --dport 443 -m set --match-set zapret dst -j DNAT --to 127.0.0.1:$SOXIFIER_PORT</code></pre></div><p>Note that kernels before 3.10 cant DNAT to 127.0.0.1. They treat it as &quot;martian&quot; IP and deny.<br />uname -a<br />If version is older then bind redsocks to LAN address instead of 127.0.0.1 and change DNAT address as well or replace DNAT with REDIRECT.<br />Also check if iptables support &quot;-C&quot; command line option. Very old versions (AA) cannot.<br />Check if iptables has all required filter modules, install missing modules if it barks.<br />Only TCP can be redirected, UDP cannot</p>											<p class="post-edited">(Last edited by <strong>bolvan</strong> on 3 Nov 2016, 21:45)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341083">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">vital21</div>
					<div class="post-datetime">
						14 Oct 2016, 12:37					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bolvan wrote:</cite><blockquote><div class="quotebox"><cite>vital21 wrote:</cite><blockquote><p>Hi, would you mind to give some advices or a brief guide &quot;how to setup&quot; using your method?</p></blockquote></div><p>Its quite a long story</p></blockquote></div><p>Спасибо за подробную инфу. Правильно ли я понял, что схематически выглядит все так :</p><p>1) поднимается ссх клиент, коннектится к ссх серверу.<br />2) поднимается редсокс<br />3) с помощью iptables редирект на редсокс, который в свою очередь туннелит в ссх?<br />4) работает только с TCP</p><p>Поправте если что то&nbsp; не так понял...</p><br /><p>П.С. в случае если все получится настроить, можно будет позаимствовать ваш конфиг iptables?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341085">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">bolvan</div>
					<div class="post-datetime">
						14 Oct 2016, 12:42					</div>
				</div>
				<div class="post-content content">
					<p>Yes, all is right.<br />Russian topic is here :<br /><a href="https://rutracker.org/forum/viewtopic.php?t=5171734">https://rutracker.org/forum/viewtopic.php?t=5171734</a></p><p>The biggest problem with your device would be low flash space (4 mb) and only one USB ports which is probably&nbsp; occupied by modem. Will need usb hub, flash drive and make extroot</p>											<p class="post-edited">(Last edited by <strong>bolvan</strong> on 14 Oct 2016, 12:57)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341092">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">bolvan</div>
					<div class="post-datetime">
						14 Oct 2016, 14:13					</div>
				</div>
				<div class="post-content content">
					<p>Update : procd greatly simplifies the task of keeping ssh client running.<br />No more script magic.</p><p>/etc/init.d/socks_vps :<br /></p><div class="codebox"><pre><code>#!/bin/sh /etc/rc.common
# Copyright (C) 2006-2011 OpenWrt.org

START=50
STOP=50
USE_PROCD=1

USERNAME=proxy
COMMAND=&quot;ssh -N -D 1098 -l proxy vps.mydomain.com&quot;

start_service() {
    procd_open_instance
    procd_set_param user $USERNAME
    procd_set_param respawn 10 10 0
    procd_set_param command $COMMAND
    procd_close_instance
}</code></pre></div>											<p class="post-edited">(Last edited by <strong>bolvan</strong> on 14 Oct 2016, 16:36)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341121">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">vital21</div>
					<div class="post-datetime">
						14 Oct 2016, 20:32					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bolvan wrote:</cite><blockquote><p>Yes, all is right.</p></blockquote></div><p>How about the iptables config? This is the big black hole for me...</p><div class="quotebox"><cite>bolvan wrote:</cite><blockquote><p>The biggest problem with your device</p></blockquote></div><p>What is the best ( better ) device for such purposes? How do you think?</p><p>P.S. want to say big thanks for your advices, as nowadays it&#039;s not so easy to find answers for those tons of questions while learning &quot;Networking&quot;</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341153">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">bolvan</div>
					<div class="post-datetime">
						15 Oct 2016, 09:40					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>vital21 wrote:</cite><blockquote><p>How about the iptables config? This is the big black hole for me...</p></blockquote></div><p>Its there. see /etc/firewall.user. This is example, you need to add your own filters or adopt my &#039;zapret&#039; system if your purpose is to circumvent censorship. Iptables is well documented. Here filters description : <a href="http://ipset.netfilter.org/iptables-extensions.man.html">http://ipset.netfilter.org/iptables-extensions.man.html</a></p><div class="quotebox"><blockquote><p>What is the best ( better ) device for such purposes? How do you think?</p></blockquote></div><p>Any device with at least 8 megs of flash will fit.<br />4 meg devices with usb will also fit if used with flash drive as extroot/</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341784">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">vital21</div>
					<div class="post-datetime">
						22 Oct 2016, 13:02					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bolvan wrote:</cite><blockquote><p> 3) Obtain redsocks package. Its missing before DD. If you&#039;re on a version lower than DD then you have to install SDK toolchain, copy redsocks package definition from trunk and compile yourself. Default SDK has problems out of the box, you&#039;ll see compiler errors, some links and executables are missing, google for that.&nbsp; Or&nbsp; compile your own toolchain from source. You cant just take binary from DD because DD has new libc , its not compatible with CC and lower.</p></blockquote></div><p>Hi again, I got a new hardware, Asus RT-N66U, running Chaos Calmer 15.05.1.</p><p>And stuck on redsocks configuration...As i understand that CC do not support it...but what do you mean when you say &quot;DD&quot;?</p><p>I thought that CC is the last firmware from openwrt...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p341788">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">bolvan</div>
					<div class="post-datetime">
						22 Oct 2016, 14:01					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>vital21 wrote:</cite><blockquote><p>I thought that CC is the last firmware from openwrt...</p></blockquote></div><p>DD = designated driver<br />today&#039;s development trunk release</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p342776">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">vital21</div>
					<div class="post-datetime">
						2 Nov 2016, 11:10					</div>
				</div>
				<div class="post-content content">
					<p>Hi, there is a problem with this part of setup:</p><p># copy id_rsa.pub to authorized_keys on server<br />ssh -N -D 1098 -l proxy vps.mydomain.com</p><p>I dont have an access to SFTP session on this server ( by the way it&#039;s a VPN provider Torguard ). I usually use it with Bitvise client ( on Windows ). So the only way I could authenticate is&nbsp; the login/password method.</p><p>Any suggestions?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p342782">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">vital21</div>
					<div class="post-datetime">
						2 Nov 2016, 12:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bolvan wrote:</cite><blockquote><p>I created ipset &quot;zapret&quot;. It contains blocked IP addresses</p></blockquote></div><p>Could you advice a rule which will redirect all the traffic and all ports( not only 80 or 443 ), to SOXIFIER PORT?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p342793">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">bolvan</div>
					<div class="post-datetime">
						2 Nov 2016, 14:14					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>vital21 wrote:</cite><blockquote><p>I dont have an access to SFTP session on this server ( by the way it&#039;s a VPN provider Torguard ). I usually use it with Bitvise client ( on Windows ). So the only way I could authenticate is&nbsp; the login/password method.</p><p>Any suggestions?</p></blockquote></div><p>Perhaps <a href="https://sourceforge.net/projects/sshpass/">sshpass</a> helps.<br />Its not standard openwrt package. need to compile with sdk</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p342794">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">bolvan</div>
					<div class="post-datetime">
						2 Nov 2016, 14:16					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>vital21 wrote:</cite><blockquote><p>Could you advice a rule which will redirect all the traffic and all ports( not only 80 or 443 ), to SOXIFIER PORT?</p></blockquote></div><p>remove &quot;--dport 443&quot;<br />or even better dont use /etc/firewall.user but place redirect rule to /etc/config/firewall. This is more conformant with openwrt design. Raw iptables are not desired.<br />i used firewall.user because i havent found a way to do redirect for OUTPUT (connections originating from router itself) and didnt want to keep 2 points of modification, keeping it as simple as copy 1 file</p>											<p class="post-edited">(Last edited by <strong>bolvan</strong> on 2 Nov 2016, 16:26)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p342882">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">vital21</div>
					<div class="post-datetime">
						3 Nov 2016, 06:45					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bolvan wrote:</cite><blockquote><p>remove &quot;--dport 443&quot;</p></blockquote></div><p>With ALL port redirecting to SOCKS, my config seems to get broken.</p><p>After doing this I cant login to my router ( luci and dropbear are not working )</p><p>As a result I&#039;m not able to start redsocks service, as well as open an ssh -N -D 1098 -l proxy vps.mydomain.com.</p><p>Could you suggest which ports should I left behind the firewall? Is there any iptables rule to exclude --dport? I saw something about&nbsp; &quot;!&quot; Symbol, but cant figure out how to use it...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p342886">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">bolvan</div>
					<div class="post-datetime">
						3 Nov 2016, 09:06					</div>
				</div>
				<div class="post-content content">
					<p>Exclude lan destinations.<br />! --dst 192.168.0.0/16</p>											<p class="post-edited">(Last edited by <strong>bolvan</strong> on 3 Nov 2016, 09:27)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p342903">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">vital21</div>
					<div class="post-datetime">
						3 Nov 2016, 13:24					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bolvan wrote:</cite><blockquote><p>Exclude lan destinations.<br />! --dst 192.168.0.0/16</p></blockquote></div><p>works for lan connections, but now I cant establish a ssh -N -D 1080 -l connect.</p><p>As i understand, firewall is not allowing this connection.</p><br /><p>Here is my firewall.user</p><div class="codebox"><pre><code>SOXIFIER_PORT=1099
. /lib/functions/network.sh
# connections originating from router
network_find_wan wan_iface
for ext_iface in $wan_iface; do
   network_get_device ext_device $ext_iface
   iptables -t nat -C OUTPUT -p tcp ! --dst 192.168.0.0/16 -j REDIRECT --to-port $SOXIFIER_PORT ||
   iptables -t nat -I OUTPUT -p tcp ! --dst 192.168.0.0/16 -j REDIRECT --to-port $SOXIFIER_PORT 
done
# forwarded connections
sysctl -w net.ipv4.conf.br-lan.route_localnet=1
iptables -t nat -C prerouting_lan_rule -p tcp ! --dst 192.168.0.0/16 -j DNAT --to 127.0.0.1:$SOXIFIER_PORT ||
iptables -t nat -I prerouting_lan_rule -p tcp ! --dst 192.168.0.0/16 -j DNAT --to 127.0.0.1:$SOXIFIER_PORT</code></pre></div><br /><p>Thanks for your help, by the way! I appreciate it!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p342906">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">bolvan</div>
					<div class="post-datetime">
						3 Nov 2016, 14:03					</div>
				</div>
				<div class="post-content content">
					<p>To avoid loops without hardcoding server&#039;s excemption IP use uid filter.</p><p> -m owner ! --uid-owner nobody</p><p>nobody is the user redsocks runs under. see /etc/redsocks.conf or &#039;ps&#039;<br />its applicable only to OUTPUT rule. forwarded packets have no uid associated<br />make sure iptables-mod-extra installed</p><p>OR</p><p>remove OUTPUT chain at all if you dont want to SSHify connections originating from the router itself</p>											<p class="post-edited">(Last edited by <strong>bolvan</strong> on 3 Nov 2016, 14:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p342933">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">vital21</div>
					<div class="post-datetime">
						3 Nov 2016, 19:07					</div>
				</div>
				<div class="post-content content">
					<p>Finally, it works! Would you mind to double-check my config?</p><p>First of all, as I cant configure auto-login for ssh session, I start it from command line with </p><div class="codebox"><pre><code>ssh -N -D 1080 -l username SSH_SERVER_IP</code></pre></div><p> and enter the password manually.</p><p>Secondly I start redsocks which is configured as </p><div class="codebox"><pre><code>127.0.0.1 - ip:   localport - 1099:    serverport - 1080</code></pre></div><p>Lastly I add </p><div class="codebox"><pre><code>SOXIFIER_PORT=1099
. /lib/functions/network.sh
# forwarded connections
sysctl -w net.ipv4.conf.br-lan.route_localnet=1
iptables -t nat -C prerouting_lan_rule -p tcp ! --dst 192.168.0.0/16 -j DNAT --to 127.0.0.1:$SOXIFIER_PORT ||
iptables -t nat -I prerouting_lan_rule -p tcp ! --dst 192.168.0.0/16 -j DNAT --to 127.0.0.1:$SOXIFIER_PORT</code></pre></div><p>Am i missing something or it&#039;s OK?</p><p>P.S. Did you try to compile/setup redsocks2 with DD? I tried, but seems its not working for me on ar71xx hardware...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p342941">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">bolvan</div>
					<div class="post-datetime">
						3 Nov 2016, 19:57					</div>
				</div>
				<div class="post-content content">
					<p>Yes, config looks fine.<br />I&#039;m not aware of redsocks2. redsocks1 works just fine and is present both in DD and CC 15.05.1<br />I compiled for you sshpass static binary&nbsp; mips32 msb rel2. It will work on any ar71xx.<br /><a href="https://www.sendspace.com/file/933new">https://www.sendspace.com/file/933new</a></p>											<p class="post-edited">(Last edited by <strong>bolvan</strong> on 5 Nov 2016, 09:42)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p342989">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">vital21</div>
					<div class="post-datetime">
						4 Nov 2016, 09:23					</div>
				</div>
				<div class="post-content content">
					<p>WoW! Thanks a lot. I will test and report back asap</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=67632&amp;p=2.html">2</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>