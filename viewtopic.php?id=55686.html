<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> A solution to support multi-user on OpenWrt&#039; web page</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 29 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p264863">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">shiningstone</div>
					<div class="post-datetime">
						10 Feb 2015, 06:51					</div>
				</div>
				<div class="post-content content">
					<p>This article introduces an approach to enhance web interface security on OpenWrt. Though it acts clumsy somewhere, it is a useful reference for some guys seeking similar solutions, I think… </p><p>And, many thanks to the guys sharing their achievements which involved in this article!</p><p>This solution targets to provide 3 users, which named root, admin, user; and root owns the whole system access ability (of course), admin can execute several system commands and some modules’ check&amp;change capability, and user can only check the designated modules.</p><p>0 Introduction</p><br /><p>Reference: <a href="http://www.cnblogs.com/gnuhpc/archive/2013/08/31/3293643.html">http://www.cnblogs.com/gnuhpc/archive/2 … 93643.html</a></p><p>The following figure depicts how web interfaces works on OpenWrt. Three main modules are involved, httpd takes cares about packages transmission and parsing, LuCI in charge of web page presentation, and UCI executes the final configure actions.</p> <br /><br /><br /><p>When a http package arrives the system, uhttpd analysis it’s request first, and start a LuCI process to execute it, system command or UCI are involved based on its request content. </p><p>1 Add users<br />Edit /etc/password to add users:</p><p>root:x:0:0:root:/root:/bin/ash</p><p>daemon:*:1:1:daemon:/var:/bin/false</p><p>ftp:*:55:55:ftp:/home/ftp:/bin/false</p><p>network:*:101:101:network:/var:/bin/false</p><p>nobody:*:65534:65534:nobody:/var:/bin/false</p><p>admin:x:1000:1000::/:/bin/ash</p><p>user:x:1001:1001::/:/bin/ash</p><p>Edit /etc/group to add admin to root group.</p><p>root:x:0:root,admin</p><p>daemon:x:1:</p><p>adm:x:4:</p><p>mail:x:8:</p><p>audio:x:29:</p><p>www-data:x:33:</p><p>ftp:x:55:</p><p>users:x:100:</p><p>network:x:101:</p><p>nogroup:x:65534:</p><p>Edit /etc/shadow to impose password for each user.</p><p>The coresponding files in build environment are located in ‘package/base-files/files/etc/’</p><p>2 Enable ‘su’ command <br />The default busybox excludes ‘su’, we need it to execute commands via different users.</p><p>Use ‘make menuconfig’ (base system -&gt; busybox -&gt;Login/Password Management Utility -&gt; su),</p><p>or you can either edit ‘.config’ directly. </p><p>3 Reassign users’ authorities<br />The busybox is an integrated tool, and this solution discriminate users’ authorities with such a trick that make a copy of busybox and impose it different permission configurations:</p><p>-rwxr-xr-x. 1 smbtest smbtest 435712 Feb&nbsp; 9 15:38 busyboxl</p><p>lrwxrwxrwx. 1 smbtest smbtest&nbsp; &nbsp; &nbsp; 8 Feb&nbsp; 9 16:17 ash -&gt; busyboxl</p><p>lrwxrwxrwx. 1 smbtest smbtest&nbsp; &nbsp; &nbsp; 8 Feb&nbsp; 9 16:17 sh -&gt; busyboxl</p><p>-rwsr-xr--. 1 smbtest smbtest 435712 Feb&nbsp; 9 15:38 busybox</p><p>lrwxrwxrwx. 1 smbtest smbtest&nbsp; &nbsp; &nbsp; 7 Feb&nbsp; 9 16:17 cat -&gt; busybox</p><p>lrwxrwxrwx. 1 smbtest smbtest&nbsp; &nbsp; &nbsp; 7 Feb&nbsp; 9 16:17 chgrp -&gt; busybox</p><p>lrwxrwxrwx. 1 smbtest smbtest&nbsp; &nbsp; &nbsp; 7 Feb&nbsp; 9 16:17 chmod -&gt; busybox</p><p>……</p><p>Note: 1 ash &amp; sh are required by user to access web page and execute some basic scripts;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 attribute of busybox maybe changed during build, please make sure it when system finish start-up</p><p>To make it during building, the following lines can be copied to ‘package/busybox/patches/copy_busybox.patch’:</p><p>diff -ru old/Makefile.custom new/Makefile.custom</p><p>--- a/Makefile.custom&nbsp; &nbsp;2012-02-05 03:24:55.000000000 +0800</p><p>+++ b/Makefile.custom&nbsp; &nbsp;2015-02-09 15:16:53.928314941 +0800</p><p>@@ -26,6 +26,18 @@</p><p> install: $(srctree)/applets/install.sh busybox busybox.links</p><p>&nbsp; &nbsp; $(Q)DO_INSTALL_LIBS=&quot;$(strip $(LIBBUSYBOX_SONAME) $(DO_INSTALL_LIBS))&quot; \</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $(SHELL) $&lt; $(CONFIG_PREFIX) $(INSTALL_OPTS)</p><p>+</p><p>+&nbsp; &nbsp; #DUPLICATED BUSYBOX start: discriminate authority of admin and user</p><p>+&nbsp; &nbsp;cp busybox $(srctree)/ipkg-install/bin/busyboxl</p><p>+&nbsp; &nbsp;chmod 4750 $(srctree)/ipkg-install/bin/busybox</p><p>+&nbsp; &nbsp;chmod 755 $(srctree)/ipkg-install/bin/busyboxl</p><p>+</p><p>+&nbsp; &nbsp;rm $(srctree)/ipkg-install/bin/sh</p><p>+&nbsp; &nbsp;rm $(srctree)/ipkg-install/bin/ash</p><p>+&nbsp; &nbsp;ln -s busyboxl $(srctree)/ipkg-install/bin/sh</p><p>+&nbsp; &nbsp;ln -s busyboxl $(srctree)/ipkg-install/bin/ash</p><p>+&nbsp; &nbsp; # DUPLICATED BUSYBOX end.</p><p>+</p><p> ifeq ($(strip $(CONFIG_FEATURE_SUID)),y)</p><p>&nbsp; &nbsp; @echo</p><p>&nbsp; &nbsp; @echo</p><p>4 Enable multi-user login via web interface<br />Reference: <a href="https://forum.openwrt.org/viewtopic.php?pid=163013#p163013">https://forum.openwrt.org/viewtopic.php … 13#p163013</a></p><p>edit /usr/lib/lua/luci/controller/admin/index.lua and change line 28 to read<br />&nbsp; &nbsp; &nbsp; &nbsp; page.sysauth = {&quot;admin&quot;,&quot;user&quot;,&quot;root&quot;}</p><p>edit /usr/lib/lua/luci/controller/admin/system.lua and change line 326 to read<br />&nbsp; &nbsp; &nbsp; &nbsp;stat = luci.sys.user.setpasswd(&quot;admin&quot;, p1)</p><p>edit /usr/lib/lua/luci/controller/admin/servicectl.lua line 18 to read<br />&nbsp; &nbsp; &nbsp; entry({&quot;servicectl&quot;}, alias(&quot;servicectl&quot;, &quot;status&quot;)).sysauth = {&quot;admin&quot;,&quot;user&quot;,&quot;root&quot;}</p><p>The coresponding files in build environment are located in ‘luci/modules/admin-full/luasrc/controller/admin/…’</p><p>5 Invoke LuCI by different users<br />Till now, different users can access web pages, but the reactions are same since the LuCI process is invoked by uhttpd, which owned by root. </p><p>The following lines can be copied to ‘package/uhttpd/patches/multi-user.patch’, to start LuCI process according to the current login user.</p><p>--- a/uhttpd.c</p><p>+++ b/uhttpd.c</p><p>@@ -243,6 +243,56 @@</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return bound;</p><p> }</p> <br /><br /><p>+#ifndef MULTI_USER</p><p>+extern void mu_dbg(char *info);</p><p>+void mu_dbg(char *info)</p><p>+{</p><p>+&nbsp; &nbsp; #if 0</p><p>+&nbsp; &nbsp; int fd = open(&quot;/debug&quot;,O_RDWR|O_APPEND);</p><p>+&nbsp; &nbsp; char buf[128] = {0};</p><p>+&nbsp; &nbsp; int len = strlen(info);</p><p>+</p><p>+&nbsp; &nbsp; if (fd&lt;0) {</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; fd = open(&quot;/debug&quot;,O_CREAT|O_RDWR);</p><p>+&nbsp; &nbsp; }</p><p>+</p><p>+&nbsp; &nbsp; memcpy(buf,info,len);</p><p>+&nbsp; &nbsp; buf[len] = &#039;\n&#039;;</p><p>+</p><p>+&nbsp; &nbsp; write(fd,buf,len+1);</p><p>+&nbsp; &nbsp; close(fd);</p><p>+&nbsp; &nbsp; #endif</p><p>+}</p><p>+</p><p>+static char CUR_USER[32] = {0};</p><p>+</p><p>+extern void get_cur_user(char *user);</p><p>+void get_cur_user(char *user) {</p><p>+&nbsp; &nbsp; if ( strlen(CUR_USER)==0 ) {</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; mu_dbg(&quot;CUR_USER empty&quot;);</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; strcpy(user,&quot;admin&quot;);</p><p>+&nbsp; &nbsp; } else {</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; memcpy(user,CUR_USER,strlen(CUR_USER));</p><p>+&nbsp; &nbsp; }</p><p>+}</p><p>+</p><p>+static void mu_get_user(const struct client *cl, char *user) {</p><p>+&nbsp; &nbsp; char *usrhead = cl-&gt;httpbuf.ptr;</p><p>+&nbsp; &nbsp; char *pwdhead = strfind(usrhead,strlen(usrhead),&quot;&amp;password=&quot;,strlen(&quot;&amp;password=&quot;));</p><p>+</p><p>+&nbsp; &nbsp; if ( pwdhead != NULL ) {</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; usrhead += strlen(&quot;username=&quot;);</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; memcpy( user, usrhead, pwdhead-usrhead );</p><p>+&nbsp; &nbsp; }</p><p>+&nbsp; &nbsp; </p><p>+&nbsp; &nbsp; mu_dbg(user);</p><p>+}</p><p>+</p><p>+static void mu_clear_luci_cache() {</p><p>+&nbsp; &nbsp; system(&quot;rm -Rf /tmp/luci-*&quot;);</p><p>+}</p><p>+#endif</p><p>+</p><p> static struct http_request * uh_http_header_parse(struct client *cl,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char *buffer, int buflen)</p><p> {</p><p>@@ -281,7 +331,23 @@</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (method &amp;&amp; !strcmp(method, &quot;GET&quot;))</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;method = UH_HTTP_MSG_GET;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (method &amp;&amp; !strcmp(method, &quot;POST&quot;))</p><p>-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;method = UH_HTTP_MSG_POST;</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#ifndef MULTI_USER</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; {</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char user[32] = {0};</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mu_get_user(cl,user);</p><p>+</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ( strlen(user)!=0 ) {/* if the POST is for log in*/</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if( strncmp(user,CUR_USER,4)!=0 ) {</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mu_clear_luci_cache();</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memcpy(CUR_USER,user,32);</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&nbsp; &nbsp; </p><p>+</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;method = UH_HTTP_MSG_POST;</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; #else</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;method = UH_HTTP_MSG_POST;</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; #endif</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (method &amp;&amp; !strcmp(method, &quot;HEAD&quot;))</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;method = UH_HTTP_MSG_HEAD;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</p><p>--- a/uhttpd-cgi.c</p><p>+++ b/uhttpd-cgi.c</p><p>@@ -486,11 +486,31 @@</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (chdir(pi-&gt;root))</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; perror(&quot;chdir()&quot;);</p> <br /><br /><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #ifndef MULTI_USER</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; extern void get_cur_user(char *user);</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; extern void mu_dbg(char *info);</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char user[32] = {0};</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char info[32] = {0};</p><p>+</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; get_cur_user(user);</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(info,&quot;exec via %s&quot;,user);</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mu_dbg(info);</p><p>+</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (ip!=NULL) {</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; execl(&quot;/bin/su&quot;,&quot;su&quot;,user,&quot;-c&quot;,ip-&gt;path,pi-&gt;phys,NULL);</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; execl(&quot;/bin/su&quot;,&quot;su&quot;,user,&quot;-c&quot;,pi-&gt;phys,NULL); </p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #else</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (ip != NULL)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; execl(ip-&gt;path, ip-&gt;path, pi-&gt;phys, NULL);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; execl(pi-&gt;phys, pi-&gt;phys, NULL);</p><p>-</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #endif</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* in case it fails ... */</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; printf(&quot;Status: 500 Internal Server Error\r\n\r\n&quot;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&quot;Unable to launch the requested CGI program:\n&quot;</p><p>7 Endow UCI configure authority to admin<br />Even admin possess root group’s authority, it cannot execute uci set or uci commit since such executions require more (I don’t known the exact answer though). Here ‘su’ is deployed again to solve this problem. Modify ‘usr/lib/lua/luci/cbi.lua’ like the followings:</p><p>@Map.parse</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if self.config == &quot;designated_module&quot; then</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; os.execute(&quot;echo root_password | su root -c \&quot;uci commit\&quot;&quot;)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.uci:commit(config)</p><p>@Map.set</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if self.config == &quot; designated_module&quot; then</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmd = &quot;uci set &quot;..self.config..&quot;.&quot;..section..&quot;.&quot;..option..&quot;=&quot;..value</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return os.execute(&quot;echo root_password | su root -c \&quot;%s\&quot;&quot; % cmd)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return self.uci:set(self.config, section, option, value)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; end</p><p>The corresponding file is located in ‘luci/libs/web/luasrc’</p><p>8 Modify Web pages’ appearance<br />In fact, I did this before Section.5. Maybe there is more decent approach to get the logined user.</p><p>Copy the following lines after line 370 in ‘usr/lib/lua/luci/dispatchers.lua’ to record the current user.</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if user then</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -- if the &quot;luci_user&quot; is created by &quot;user&quot;, &quot;chmod&quot; cannot take effect since limited authority.</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -- so &quot;admin&quot; has to &quot;chmod&quot; again via &quot;su&quot;.</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; os.execute(&quot;echo root_password | su root -c \&quot;chmod 666 /var/luci_user\&quot;&quot;)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; os.execute(&quot;echo %s &gt; /var/luci_user&quot; % user)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; os.execute(&quot;chmod 666 /var/luci_user&quot;)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; end</p><p>and then modify specific files about the appearance setences, such as</p><p>entry(…) in ‘usr/lib/lua/luci/controller/admin/xxx.lua’ is enable sub-tab on a certain page,which can be commented to cancel the sub-tab, and s:option(Value, …) in ‘usr/lib/lua/luci/model/cbi/xxx/xxx.lua’ represents a EditBox, the parameter Value can be change to DummyValue to displace the EditBox with a TextView.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>