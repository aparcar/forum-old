<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> OPENVPN keeps losing connection.</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 22 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p352309">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">randomhuman</div>
					<div class="post-datetime">
						19 Feb 2017, 00:27					</div>
				</div>
				<div class="post-content content">
					<p>So i followed this guide for setting up openvpn on my omnia router. hxxps://support.nordvpn.com/hc/en-us/articles/115000254305-OpenWRT-router-tutorial</p><p>The issue is it drops connection within 5-10 minutes and gets a new vpn ip address over and over. </p><p>Looking at the logs in /var/log/messages i have a hard time understanding the log and what needs to be fixed. I was hoping someone could look at this log and tell me what is most likely the cause? If there is another detailed log file to look at let me know. Here is a portion of my log with some errors. Appreciate any advice or insight. Thank you. </p><div class="codebox"><pre><code>2017-02-18T22:13:01-08:00 info /usr/sbin/cron[28937]: (root) CMD (/usr/bin/rainbow_button_sync.sh)
2017-02-18T22:13:44-08:00 notice netifd[]: wan (2132): udhcpc: sending renew
2017-02-18T22:14:01-08:00 info /usr/sbin/cron[28976]: (root) CMD (/usr/bin/rainbow_button_sync.sh)
2017-02-18T22:14:01-08:00 info /usr/sbin/cron[28975]: (root) CMD (nethist_stats.lua)
2017-02-18T22:14:21-08:00 notice netifd[]: wan (2132): udhcpc: sending renew
2017-02-18T22:14:39-08:00 notice netifd[]: wan (2132): udhcpc: sending renew
2017-02-18T14:14:44-08:00 info dnsmasq-dhcp[2293]: DHCPINFORM(br-lan) 192.168.xxx.246 
2017-02-18T14:14:44-08:00 info dnsmasq-dhcp[2293]: DHCPACK(br-lan) 192.168.xxx.246 
2017-02-18T22:14:48-08:00 notice netifd[]: wan (2132): udhcpc: sending renew
2017-02-18T14:14:54-08:00 notice netifd[]: Last message &#039;wan (2132): udhcpc: &#039; repeated 1 times, supressed by syslog-ng on turris
2017-02-18T22:14:54-08:00 notice netifd[]: wan (2132): udhcpc: sending renew
2017-02-18T14:14:55-08:00 notice netifd[]: Last message &#039;wan (2132): udhcpc: &#039; repeated 1 times, supressed by syslog-ng on turris
2017-02-18T22:14:55-08:00 notice netifd[]: wan (2132): udhcpc: lease lost, entering init state
2017-02-18T22:14:55-08:00 notice netifd[]: Interface &#039;wan&#039; has lost the connection
2017-02-18T22:15:45-08:00 notice openvpn(sonicvpn)[2600]: [OpenVPN Server] Inactivity timeout (--ping-restart), restarting
2017-02-18T22:15:45-08:00 notice openvpn(sonicvpn)[2600]: /sbin/route del -net 209.148.113.36 netmask 255.255.255.255
2017-02-18T22:15:45-08:00 warning openvpn(sonicvpn)[2600]: ERROR: Linux route delete command failed: external program exited with error status: 1
2017-02-18T22:15:45-08:00 notice openvpn(sonicvpn)[2600]: /sbin/route del -net 0.0.0.0 netmask 128.0.0.0
2017-02-18T22:15:45-08:00 notice openvpn(sonicvpn)[2600]: /sbin/route del -net 128.0.0.0 netmask 128.0.0.0
2017-02-18T22:15:45-08:00 notice openvpn(sonicvpn)[2600]: Closing TUN/TAP interface
2017-02-18T22:15:45-08:00 notice openvpn(sonicvpn)[2600]: /sbin/ifconfig tun0 0.0.0.0
2017-02-18T22:15:45-08:00 notice netifd[]: Network device &#039;tun0&#039; link is down
2017-02-18T22:14:55-08:00 notice netifd[]: Network alias &#039;eth1&#039; link is up
2017-02-18T22:14:55-08:00 notice netifd[]: Interface &#039;wan6&#039; has link connectivity
2017-02-18T22:14:55-08:00 notice netifd[]: Interface &#039;wan6&#039; is setting up now
2017-02-18T22:14:55-08:00 notice netifd[]: Interface &#039;wan&#039; is now up
2017-02-18T22:14:55-08:00 notice firewall[]: Reloading firewall due to ifup of wan (eth1)
2017-02-18T22:14:55-08:00 err openvpn(sonicvpn)[2600]: write UDPv4: Operation not permitted (code=1)
2017-02-18T14:14:55-08:00 err openvpn(sonicvpn)[]: Last message &#039;write UDPv4: Operati&#039; repeated 12 times, supressed by syslog-ng on turris
2017-02-18T22:14:55-08:00 notice netifd[]: Interface &#039;wan6&#039; is now up
2017-02-18T22:14:56-08:00 notice firewall[]: Reloading firewall due to ifup of wan6 (eth1)
2017-02-18T22:14:56-08:00 err openvpn(sonicvpn)[2600]: write UDPv4: Operation not permitted (code=1)
2017-02-18T14:14:56-08:00 err openvpn(sonicvpn)[]: Last message &#039;write UDPv4: Operati&#039; repeated 57 times, supressed by syslog-ng on turris
2017-02-18T22:14:56-08:00 warning odhcpd[1703]: A default route is present but there is no public prefix on br-lan thus we don&#039;t announce a default route!
2017-02-18T22:15:01-08:00 info /usr/sbin/cron[29415]: (root) CMD (/usr/bin/watchdog.sh)
2017-02-18T22:15:01-08:00 info /usr/sbin/cron[29414]: (root) CMD (/usr/bin/rainbow_button_sync.sh)
2017-02-18T22:15:01-08:00 info /usr/sbin/cron[29418]: (root) CMD (   /usr/bin/notifier)
2017-02-18T22:15:12-08:00 warning watchdog[]: Restarted nethist
2017-02-18T22:15:45-08:00 notice openvpn(sonicvpn)[2600]: [OpenVPN Server] Inactivity timeout (--ping-restart), restarting
2017-02-18T22:15:45-08:00 notice openvpn(sonicvpn)[2600]: /sbin/route del -net 209.148.113.36 netmask 255.255.255.255
2017-02-18T22:15:45-08:00 warning openvpn(sonicvpn)[2600]: ERROR: Linux route delete command failed: external program exited with error status: 1
2017-02-18T22:15:45-08:00 notice openvpn(sonicvpn)[2600]: /sbin/route del -net 0.0.0.0 netmask 128.0.0.0
2017-02-18T22:15:45-08:00 notice openvpn(sonicvpn)[2600]: /sbin/route del -net 128.0.0.0 netmask 128.0.0.0
2017-02-18T22:15:45-08:00 notice openvpn(sonicvpn)[2600]: Closing TUN/TAP interface
2017-02-18T22:15:45-08:00 notice openvpn(sonicvpn)[2600]: /sbin/ifconfig tun0 0.0.0.0
2017-02-18T22:15:45-08:00 notice netifd[]: Network device &#039;tun0&#039; link is down
2017-02-18T22:15:45-08:00 notice netifd[]: Interface &#039;sonicvpntun&#039; has link connectivity loss
2017-02-18T22:15:45-08:00 notice netifd[]: Interface &#039;sonicvpntun&#039; is now down
2017-02-18T22:15:45-08:00 notice netifd[]: Interface &#039;sonicvpntun&#039; is disabled
2017-02-18T22:15:45-08:00 warning odhcpd[1703]: A default route is present but there is no public prefix on br-lan thus we don&#039;t announce a default route!
2017-02-18T22:15:45-08:00 notice openvpn(sonicvpn)[2600]: SIGUSR1[soft,ping-restart] received, process restarting
2017-02-18T22:15:45-08:00 notice openvpn(sonicvpn)[2600]: Restart pause, 2 second(s)
2017-02-18T22:15:46-08:00 warning odhcpd[1703]: A default route is present but there is no public prefix on br-lan thus we don&#039;t announce a default route!
2017-02-18T22:15:47-08:00 notice openvpn(sonicvpn)[2600]: Control Channel Authentication: tls-auth using INLINE static key file
2017-02-18T22:15:47-08:00 notice openvpn(sonicvpn)[2600]: Outgoing Control Channel Authentication: Using 160 bit message hash &#039;SHA1&#039; for HMAC authentication
2017-02-18T22:15:47-08:00 notice openvpn(sonicvpn)[2600]: Incoming Control Channel Authentication: Using 160 bit message hash &#039;SHA1&#039; for HMAC authentication
2017-02-18T22:15:47-08:00 notice openvpn(sonicvpn)[2600]: Socket Buffers: R=[163840-&gt;200000] S=[163840-&gt;200000]
2017-02-18T22:15:47-08:00 notice openvpn(sonicvpn)[2600]: UDPv4 link local: [undef]</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p352310">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">ulmwind</div>
					<div class="post-datetime">
						19 Feb 2017, 01:03					</div>
				</div>
				<div class="post-content content">
					<p>Thank you kindly for using my manual.</p><p>Your issue, to my mind, is in your WAN connection, we see the string just before OpenVPN loosing connection:<br /></p><div class="codebox"><pre><code>2017-02-18T22:14:55-08:00 notice netifd[]: Interface &#039;wan&#039; has lost the connection</code></pre></div><p>I don&#039;t know, why it took place.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p352320">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">randomhuman</div>
					<div class="post-datetime">
						19 Feb 2017, 06:17					</div>
				</div>
				<div class="post-content content">
					<p>Thank you putting that together. I was so happy to get port forwarding working etc via vpn once it was all setup on my router. Even though i am losing connection every 5 minutes i am sure i will figure out the cause eventually. just need to dissect these logs better. </p><p>I also had this error in the log so was looking into that and found this page interesting. <br />Error: Inactivity timeout (--ping-restart)<br />ww w.sparklabs.com/support/kb/article/error-inactivity-timeout-ping-restart/</p><p>That said my WAN has been 100% stable for months before i put this on my router. and i was using the standard openvpn client on my windows computer. So I know it has to be some setting i got wrong.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p352332">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">randomhuman</div>
					<div class="post-datetime">
						19 Feb 2017, 08:45					</div>
				</div>
				<div class="post-content content">
					<p>So i found a post that seems to fit my issue. He says that his WAN is dropping connection when requesting renewal lease. because it a expects a reply from different DHCP server.</p><p>I am not familiar with iptables or uci commands. Should i try applying this posts solution? Would anyone have a recommendation on the best way to correct this in opewrt? </p><p>Thanks.</p><div class="quotebox"><blockquote><p>Solved by Oleg (thanks Oleg!)</p><p>Turns out my ISP has a funny way of doing dhcp.</p><p>When I boot my asus, it gets a dhcp lease from 82.161.88.1. So far so good. About half way through the lease time (normal behavior) it starts requesting renewal of the lease. So my asus gets a reply to its request from 82.161.247.54. My asus expects a reply from the original dhcp server and drops the reply from 82.161.247.54. It then keeps on requesting renewal until the lease runs out and the lease expires.</p><p>Then my asus starts reinit process, gets a lease from 82.161.88.1 and the whole thing starts all over again. Wouldn&#039;t be too bad if leasetime wasn&#039;t 3600 (an hour).</p><p>My asus only accepts a reply from the originating dhcp server as it does statefull firewalling.</p><p>I&#039;ve send them an email with a little piece of MY log as they weren&#039;t keen on sending theirs, and I ask them why they have it set up this way, but haven&#039;t got the answer yet. Don&#039;t think I will get a satisfying answer to this question but one can hope.</p><p>Solution:</p><p>put this in post-firewall<br />iptables -I INPUT -p udp --sport 67 --dport 68 -j ACCEPT</p></blockquote></div>											<p class="post-edited">(Last edited by <strong>randomhuman</strong> on 19 Feb 2017, 08:47)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p352342">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">ulmwind</div>
					<div class="post-datetime">
						19 Feb 2017, 12:44					</div>
				</div>
				<div class="post-content content">
					<p>In your quote there is explanation, that DHCP-server migrates in network, changing its own IP. You can try to do it, of course, but you should insert the rule in the correct chain, see output of </p><div class="codebox"><pre><code>iptables -nvL</code></pre></div><p> and </p><div class="codebox"><pre><code>fw3 print</code></pre></div><p>Better for you is to set WAN not as DHCP-client, but just static IP. Is it possible for your ISP?</p>											<p class="post-edited">(Last edited by <strong>ulmwind</strong> on 19 Feb 2017, 12:45)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p352399">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">randomhuman</div>
					<div class="post-datetime">
						20 Feb 2017, 00:20					</div>
				</div>
				<div class="post-content content">
					<p>Good suggestion on static. After lots of frustration and forcing myself to learn a lot more about firewall rules and googling&nbsp; many more similar situations. </p><p>Bottom line this dhcp lease is att u-verse issue. So i call my ISP which is not att u-verse exactly and inquire about static ip address. They unfortunately cannot offer a static ip address. </p><p>However after searching some more. I found that even though att uverse is dhcp. i can still static assign that ip to my router from the att uverse router. </p><p>This is not ideal since if my ip changes I would have to update my router. However everyone seems to be saying its rare it changes on you. people reporting they been getting the same ip for months</p><p>So after assignign static ip to my openwrt router. my vpn is stable on the router now. No more diconnects every 5 minutes. </p><p>Thanks for the suggestion it worked. Great work putting that helpful vpn guide together as well. i needed that last year but at the time did not find such an article.</p>											<p class="post-edited">(Last edited by <strong>randomhuman</strong> on 20 Feb 2017, 00:26)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>