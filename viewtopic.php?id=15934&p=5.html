<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Is this router based on the infineon danube?</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 1 Oct 2014 and 1 May 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 5 of 40</div><nav><ul><li><a href="viewtopic.php%3Fid=15934&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=15934&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=15934&amp;p=4.html">4</a></li><li class="pagination-current"><span>5</span></li><li><a href="viewtopic.php%3Fid=15934&amp;p=6.html">6</a></li><li><a href="viewtopic.php%3Fid=15934&amp;p=7.html">7</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=15934&amp;p=40.html">40</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p119515">
				<div class="post-metadata">
					<div class="post-num">Post #101</div>
					<div class="post-author">WiLZy</div>
					<div class="post-datetime">
						22 Oct 2010, 13:26					</div>
				</div>
				<div class="post-content content">
					<p>I have a gift for anyone who needs a SMC-7908-ISP <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119537">
				<div class="post-metadata">
					<div class="post-num">Post #102</div>
					<div class="post-author">ngp</div>
					<div class="post-datetime">
						22 Oct 2010, 20:45					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>vpablos:<br />SMC7904 and SMC7908 are completely unrelated devices. SMC7908 is danube based running&nbsp; propietary software (maybe violating GPL, but who knows) and SMC7904 is rtl based running linux. I doubt that SMC release any sources, but who needs them anyway.</p><p>The info about&nbsp; BRN bootloader, was known, but it is not directly usable. firmware image headers and runtime checks differ. I doubt anybody cares about that if its possible to use u-boot.</p><br /><p>blogic:</p><p>Voip needs the usage of some GPIO lines. Do you know how are them configured in arv4518 devices?</p><br /><p>Thanks.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119580">
				<div class="post-metadata">
					<div class="post-num">Post #103</div>
					<div class="post-author">unaiur</div>
					<div class="post-datetime">
						23 Oct 2010, 16:31					</div>
				</div>
				<div class="post-content content">
					<p>Currently, my main problem currently is the lack of USB support. With only 4 MB of flash memory in the arv4518 board, I need external storage for the root filesystem. Is there any news about USB support?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119601">
				<div class="post-metadata">
					<div class="post-num">Post #104</div>
					<div class="post-author">ngp</div>
					<div class="post-datetime">
						23 Oct 2010, 23:31					</div>
				</div>
				<div class="post-content content">
					<p>Hi<br />Buttons and all leds except voip/phone1/2 work. FXS ports work. The missing key is support for vmcc in zaptel/freeswitch or sip in tapidemo.</p><p>I am in a dead end with the usb. The driver should work, but i can not get the port out of disconnected state. </p><p>Does anybody have info on controlling voip leds? </p><p>Thanks.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119627">
				<div class="post-metadata">
					<div class="post-num">Post #105</div>
					<div class="post-author">ngp</div>
					<div class="post-datetime">
						24 Oct 2010, 16:07					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>After many hours with objdump, I have found the missing puzzle to working usb:<br />3c 02 be 10&nbsp; 34 42 0b 10 8c 43 00 00 34 63 40 00 ac 43 00 00 <br />Free translation: GPIO0 P14 somehow controls usb port power in arv4518.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119702">
				<div class="post-metadata">
					<div class="post-num">Post #106</div>
					<div class="post-author">unaiur</div>
					<div class="post-datetime">
						25 Oct 2010, 15:03					</div>
				</div>
				<div class="post-content content">
					<p>Great work!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119919">
				<div class="post-metadata">
					<div class="post-num">Post #107</div>
					<div class="post-author">ngp</div>
					<div class="post-datetime">
						28 Oct 2010, 18:23					</div>
				</div>
				<div class="post-content content">
					<p>Hello,<br />I have managed to generate a firmware image to update by arcadyan propietary operating system. This update methos doesnt touche the brn bootloader, so you can revert to original ones.</p><p>The procedure is as follow:<br />generate a kernel plus ramdisk.<br />generate a u-boot to run from ram at 80002000 (arv4518_brnboot_config)<br />compress with lzma and &quot;obfuscate&quot;</p><p>generate firmware with sp700ex, using for 1 : uboot 2 (unused, I put a second uboot for sp700ex to work) 3 kernel+ramdisk 4 zero size file zero size file<br />add &quot;BRNDANUBE&quot; to&nbsp; this file (6th file from an original firmware).</p><p>And upload to router. Et voila: You have openwrt running.</p><p>I have put a image for testing (with adsl and usb, without wifi and voip) at: <a href="http://personales.ya.com/_ngp_/firmware_arv4518_openwrt_bin.bz2">http://personales.ya.com/_ngp_/firmware … rt_bin.bz2</a></p>											<p class="post-edited">(Last edited by <strong>ngp</strong> on 28 Oct 2010, 18:27)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119925">
				<div class="post-metadata">
					<div class="post-num">Post #108</div>
					<div class="post-author">vpablos</div>
					<div class="post-datetime">
						28 Oct 2010, 19:44					</div>
				</div>
				<div class="post-content content">
					<p>Good !!! <br />Thanks !!!</p><p>What about usb and voip?<br />I can&#039;t wait to test the image on my router ... </p><p>Are your changes into svn too?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119936">
				<div class="post-metadata">
					<div class="post-num">Post #109</div>
					<div class="post-author">pippolippi</div>
					<div class="post-datetime">
						28 Oct 2010, 21:10					</div>
				</div>
				<div class="post-content content">
					<p>ngp, you&#039;re my hero.<br />Unfortunately I cannot try it on my 7908ISP, since I rely on it both for internet access and voip (luckily not the yacom service), but I have a spare ARV7518PW-A-LF-LT (the one with wifi-n they sent in error to a handful of customers, bough on ebay for cheap), do you think I could flash it with your image?<br />After all the only difference should be the wifi chip, and since your image has no wifi it could work, don&#039;t you think?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119937">
				<div class="post-metadata">
					<div class="post-num">Post #110</div>
					<div class="post-author">pippolippi</div>
					<div class="post-datetime">
						28 Oct 2010, 21:12					</div>
				</div>
				<div class="post-content content">
					<p>BTW, do you know if the usb port can work in device (gadget) mode? Is it usb2.0 or 1.1?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119939">
				<div class="post-metadata">
					<div class="post-num">Post #111</div>
					<div class="post-author">ngp</div>
					<div class="post-datetime">
						28 Oct 2010, 21:28					</div>
				</div>
				<div class="post-content content">
					<p>Hello,<br />vpablos: usb is working in host mode. voip is working, but sip is not done. wifi works with madwifi and with ath5k, but none of them is included in my image (neither voip). The changes arent in svn, but you can get them from the links that I had posted. I think blogic is reworking the danube support including them. The code for &quot;obfuscation&quot; is the reverse of Luca Olivetti. Here it is:</p><p>#!/usr/bin/python</p><p>partname=&#039;ya-1&#039;</p><p>f=open(partname+&#039;.lzma&#039;,&#039;rb&#039;)<br />s=f.read()<br />f.close()</p><p>def rn(c):<br />&nbsp; b=ord(c)<br />&nbsp; return chr(b%16*16+b/16)</p><p>s2=&#039;&#039;<br />s2= s2 + chr(0x21)<br />s2= s2 + chr(0x43)<br />s2= s2 + chr(0x65)<br />s2= s2 + chr(0x87)</p><p>i=32+68<br />for j in range(32):<br />&nbsp; s2=s2+s[i]<br />&nbsp; i=i+1</p><p>i=32<br />for j in range(68):<br />&nbsp; s2=s2+s[i]<br />&nbsp; i=i+1</p><p>i=0<br />for j in range(16):<br />&nbsp; s2=s2+rn(s[i+1])+rn(s[i])<br />&nbsp; i=i+2</p><br /><p>s2=s2+s[132:]</p><p>f=open(partname+&#039;.bin&#039;,&#039;wb&#039;)<br />f.write(s2)<br />f.close()</p><br /><p>pipolippi: If the routers are identical, it should work, but maybe the bootloader makes some additional checks. Anyway, you can test it. If it does&nbsp; not work, you can use recovery mode (press reset button during poweron) to reflash the Ya.com provided firmware.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119941">
				<div class="post-metadata">
					<div class="post-num">Post #112</div>
					<div class="post-author">ngp</div>
					<div class="post-datetime">
						28 Oct 2010, 21:49					</div>
				</div>
				<div class="post-content content">
					<p>Hi again:</p><p>about&nbsp; usb in device mode: The ip core in danube seems to support it, but I think that the external phy/wiring/wathever does not. The original firmware does not implement it.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119943">
				<div class="post-metadata">
					<div class="post-num">Post #113</div>
					<div class="post-author">pippolippi</div>
					<div class="post-datetime">
						28 Oct 2010, 22:20					</div>
				</div>
				<div class="post-content content">
					<p>Ah, ok, I came across a device at work that has a normal a female connector and it can work both as a host (to drive memory sticks) and as a device (if I connect it to a pc with a male-male cable it sees an usb-ethernet adapter).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119945">
				<div class="post-metadata">
					<div class="post-num">Post #114</div>
					<div class="post-author">ngp</div>
					<div class="post-datetime">
						28 Oct 2010, 23:12					</div>
				</div>
				<div class="post-content content">
					<p>Hi</p><p>Some caveats:<br />sp700es pads filesizes to 1Kb. This offsets the kernel position from 0xb0060000 (address where firmware is stored). So in my case, part 1 size is 58486, padded to 59392. part 2 is the same. So offset of part 3 (the kernel) is 0x1d000. Add that to 0xb0060000 and you get 0xb007d000. That means: for u-boot autostarts,&nbsp; add&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&quot;bootcmd=bootm 0xb007d000\0&quot; to extra environment settings in u-boot-2010.03/include/configs/arv4518.h</p><p>lzma generated files had gotten me some headaches. Example:<br />lzma ya-1 <br />lzmainfo ya-1.lzma </p><p>ya-1.lzma<br />Uncompressed size:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Unknown<br />Dictionary size:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8 MB (2^23 bytes)<br />Literal context bits (lc):&nbsp; &nbsp; &nbsp;3<br />Literal pos bits (lp):&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0<br />Number of pos bits (pb):&nbsp; &nbsp; &nbsp; &nbsp;2</p><p>If uncompressed size is unknown,&nbsp; That file will fail ZIP routines in brnboot, entering in recovery mode.</p>											<p class="post-edited">(Last edited by <strong>ngp</strong> on 28 Oct 2010, 23:29)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119948">
				<div class="post-metadata">
					<div class="post-num">Post #115</div>
					<div class="post-author">ngp</div>
					<div class="post-datetime">
						28 Oct 2010, 23:33					</div>
				</div>
				<div class="post-content content">
					<p>Hi</p><p>pipolippi:<br />Yes DWC usb ip cores support host and device modes, also OTG. Danube supports host and device modes, but not OTG. But it needs some external components that I dont think are in arv4518. But I have not tried it personally.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119983">
				<div class="post-metadata">
					<div class="post-num">Post #116</div>
					<div class="post-author">dp79</div>
					<div class="post-datetime">
						29 Oct 2010, 17:00					</div>
				</div>
				<div class="post-content content">
					<p>ngp,</p><p>Thanks a lot for your hard work on this! Unfortunately I&#039;m missing an in depth linux and programming knowledge, but I’ have a good knowledge base as a WL500gP (oleg’s firmware) user. You mentioned that your image doesn’t contain wifi and voip. Does this mean that I can download them by ipkg once your image is running, like in oleg’s firmware? You also mentioned that however device mode is supported by the software, the port is not hardwired to support that. Does this mean that an usb flashdrive (mass storage) will not function there until a workaround hardware mod is available?<br />Is there an easy way to upload your image to the device, like Tftp for example. To be honest, the method you described is too high level for me ?</p><p>dp79</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119984">
				<div class="post-metadata">
					<div class="post-num">Post #117</div>
					<div class="post-author">pippolippi</div>
					<div class="post-datetime">
						29 Oct 2010, 17:53					</div>
				</div>
				<div class="post-content content">
					<p>To control an usb flashdrive the port must be in host mode, not device, so it should work</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p119986">
				<div class="post-metadata">
					<div class="post-num">Post #118</div>
					<div class="post-author">ngp</div>
					<div class="post-datetime">
						29 Oct 2010, 18:36					</div>
				</div>
				<div class="post-content content">
					<p>hi<br />dp79:<br />The method is for generating the image. Use the router firmware update page to flash the image I did provide. Usb should work. opkg should work, but the rootfs is a ramdisk, so you los all the changes after reboot.</p><p>Quick and dirty program to generate flash images. You need to provide five files (First one is a u-boot configured to run from ram at 0x80002000 and bootm a kernel at 0xb007d000 and then lzmaed with known uncompress size. Second one can be a copy of the first one. Third is a kernel+ramdisk. Fourth and Fifth can be empty files) There is no check for uboot size, so beware)</p><br /><p>/* $Id: mkarv4518fw.c,v 0.1 2010/10/29 20:49:08 $<br /> *<br /> * Based on the work of Petr Novak, BLFC from Openline ISP,<br /> * Stefan Weil and Luca Olivetti.<br /> *<br /> * This software is distributed under the GNU public license (GPL).<br /> */</p><p>#include &lt;stdio.h&gt;<br />#include &lt;stdlib.h&gt;<br />#include &lt;string.h&gt;<br />#include &lt;sys/types.h&gt;<br />#include &lt;fcntl.h&gt;</p><p>/*<br /> * Code to compute the CRC-32 table. Borrowed from <br /> * gzip-1.0.3/makecrc.c.<br /> */<br />typedef unsigned long uint32_t;<br />static uint32_t crc_32_tab[256];<br />static void makecrc(void)<br />{<br />/* Not copyrighted 1990 Mark Adler&nbsp; &nbsp; &nbsp; */<br />&nbsp; unsigned long c;&nbsp; &nbsp; &nbsp; /* crc shift register */<br />&nbsp; unsigned long e;&nbsp; &nbsp; &nbsp; /* polynomial exclusive-or pattern */<br />&nbsp; int i;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* counter for all possible eight bit values */<br />&nbsp; int k;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* byte being shifted into crc apparatus */<br />&nbsp; /* terms of polynomial defining this crc (except x^32): */<br />&nbsp; static const int p[] = {0,1,2,4,5,7,8,10,11,12,16,22,23,26};</p><p>&nbsp; /* Make exclusive-or pattern from polynomial */<br />&nbsp; e = 0;<br />&nbsp; for (i = 0; i &lt; sizeof(p)/sizeof(int); i++)<br />&nbsp; &nbsp; e |= 1L &lt;&lt; (31 - p[i]);</p><p>&nbsp; crc_32_tab[0] = 0;</p><p>&nbsp; for (i = 1; i &lt; 256; i++)<br />&nbsp; {<br />&nbsp; &nbsp; c = 0;<br />&nbsp; &nbsp; for (k = i | 256; k != 1; k &gt;&gt;= 1)<br />&nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; c = c &amp; 1 ? (c &gt;&gt; 1) ^ e : c &gt;&gt; 1;<br />&nbsp; &nbsp; &nbsp; if (k &amp; 1)<br />&nbsp; &nbsp; &nbsp; &nbsp; c ^= e;<br />&nbsp; &nbsp; }<br />&nbsp; &nbsp; crc_32_tab[i] = c;<br />&nbsp; }<br />}</p><p>unsigned long comp_crc(unsigned char *p, unsigned long len)<br />{<br />&nbsp; &nbsp; &nbsp; &nbsp; unsigned long crc = 0xFFFFFFFFUL;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; while (len--) {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; crc = crc_32_tab[(crc ^ *p++) &amp; 0xff] ^ (crc &gt;&gt; 8);<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; return crc ^ 0xFFFFFFFFUL;<br />}</p><br /><p>#define KiB 1024<br />#define MiB (KiB * KiB)<br />#define FLASH_SIZE&nbsp; &nbsp; &nbsp; 4*MiB<br />// available flas reduced by brnboot (0x0-0x6000) and board config (last sector)<br />#define FLASH_AVAIL&nbsp; &nbsp; &nbsp;(FLASH_SIZE - 0x60000 - 64 *KiB)</p><br /><p>/* buffer must be large enough to contain firmware */<br />static unsigned char buffer[FLASH_AVAIL];</p><p>static char signature[10] = &quot;BRNDANUBE&quot;;</p><p>static unsigned char rn (unsigned char b)<br />{<br />&nbsp; return b%16*16+b/16;<br />}<br />static int obfuscate(size_t si, char *in, char *out)<br />{<br />&nbsp; &nbsp; &nbsp; &nbsp; int j, i, o = 0;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; out[o++] = 0x21;<br />&nbsp; &nbsp; &nbsp; &nbsp; out[o++] = 0x43;<br />&nbsp; &nbsp; &nbsp; &nbsp; out[o++] = 0x65;<br />&nbsp; &nbsp; &nbsp; &nbsp; out[o++] = 0x87;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; i = 32+68;<br />&nbsp; &nbsp; &nbsp; &nbsp; for (j = 0; j &lt; 32; j++)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out[o++]= in[i++];</p><p>&nbsp; &nbsp; &nbsp; &nbsp; i = 32;<br />&nbsp; &nbsp; &nbsp; &nbsp; for (j = 0; j &lt; 68; j++)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out[o++] = in[i++];</p><p>&nbsp; &nbsp; &nbsp; &nbsp; i = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; for (j = 0; j &lt; 16; j++, i++)<br />&nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out[o++] = rn(in[j+i+1]);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out[o++] = rn(in[j+i]);<br />&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp; &nbsp; for (i = 132; i &lt; si; i++)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out[o++] = in[i];</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return si + 4;<br />}</p><p>static size_t add_file(char *filename, int obfus, unsigned char *buffer, size_t bytes_left)<br />{<br />&nbsp; &nbsp; &nbsp; &nbsp; unsigned long *p;<br />&nbsp; &nbsp; &nbsp; &nbsp; int fd;<br />&nbsp; &nbsp; &nbsp; &nbsp; size_t len;<br />&nbsp; &nbsp; &nbsp; &nbsp; static unsigned char *buffer_in;//[bytes_left];<br />&nbsp; &nbsp; &nbsp; &nbsp; unsigned long crc;<br />&nbsp; &nbsp; &nbsp; &nbsp; int i, n_ks, n_pad;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; fd = open(filename, O_RDONLY);<br />&nbsp; &nbsp; &nbsp; &nbsp; if (fd &lt; 0) {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; perror(filename);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; if (obfus){<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buffer_in = (unsigned char*)malloc(bytes_left);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = read(fd, buffer_in, bytes_left-4);<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = read(fd, buffer, bytes_left);<br />&nbsp; &nbsp; &nbsp; &nbsp; close(fd);<br />&nbsp; &nbsp; &nbsp; &nbsp; if (len &gt; bytes_left-(obfuscate ? 16 : 12)){<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr, &quot;%s has %lu bytes, %lu bytes left: TOO BIG\n&quot;, filename, len, bytes_left);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr, &quot;%s has %lu bytes, %lu bytes left\n&quot;, filename, len, bytes_left);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (obfus){</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; obfuscate(len, buffer_in, buffer);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len += 4;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; crc = comp_crc(buffer, len);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr, &quot;%s (%lu bytes) crc: 0x%lx\n&quot;, filename, len, crc);<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; else{<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; crc = comp_crc(buffer, len);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr, &quot;%s (%lu bytes) crc: 0x%lx\n&quot;, filename, len, crc);<br />&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp; &nbsp; n_ks = (len/1024) + 1;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; p = (unsigned long *)(buffer + n_ks*1024 - 3*4);<br />&nbsp; &nbsp; &nbsp; &nbsp; *p++ = len;<br />&nbsp; &nbsp; &nbsp; &nbsp; *p++ = 0x12345678;<br />&nbsp; &nbsp; &nbsp; &nbsp; *p++ = crc;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return ((unsigned char*)p - buffer);<br />}</p><p>int main(int argc, char *argv[])<br />{<br />&nbsp; &nbsp; &nbsp; &nbsp; unsigned long *p;<br />&nbsp; &nbsp; &nbsp; &nbsp; int fd;<br />&nbsp; &nbsp; &nbsp; &nbsp; size_t len;<br />&nbsp; &nbsp; &nbsp; &nbsp; char *filename1 = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; char *filename2 = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; char *filename3 = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; char *filename4 = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; char *filename5 = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; char *fw_file = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; size_t total_size = FLASH_AVAIL;<br />&nbsp; &nbsp; &nbsp; &nbsp; size_t count = 0;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; memset(buffer, 0xff, total_size);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; filename1 = argv[1];<br />&nbsp; &nbsp; &nbsp; &nbsp; filename2 = argv[2];<br />&nbsp; &nbsp; &nbsp; &nbsp; filename3 = argv[3];<br />&nbsp; &nbsp; &nbsp; &nbsp; filename4 = argv[4];<br />&nbsp; &nbsp; &nbsp; &nbsp; filename5 = argv[5];<br />&nbsp; &nbsp; &nbsp; &nbsp; fw_file = argv[6];</p><p>&nbsp; &nbsp; &nbsp; &nbsp; makecrc();</p><p>&nbsp; &nbsp; &nbsp; &nbsp; count += add_file(filename1, 1, buffer+count, total_size - count);<br />&nbsp; &nbsp; &nbsp; &nbsp; count += add_file(filename2, 1, buffer+count, total_size - count);<br />&nbsp; &nbsp; &nbsp; &nbsp; count += add_file(filename3, 0, buffer+count, total_size - count);<br />&nbsp; &nbsp; &nbsp; &nbsp; count += add_file(filename4, 0, buffer+count, total_size - count);<br />//&nbsp; &nbsp; &nbsp; count += add_file(filename5, 0, buffer+count, total_size - count);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; memcpy(buffer+count, signature, 10);<br />&nbsp; &nbsp; &nbsp; &nbsp; count += 10;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr, &quot;writing %s %lu bytes, %lu bytes left\n&quot;, fw_file, count, total_size - count);<br />&nbsp; &nbsp; &nbsp; &nbsp; fd = open(fw_file, O_CREAT|O_WRONLY|O_TRUNC, 0666);<br />&nbsp; &nbsp; &nbsp; &nbsp; if (fd &lt; 0) {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; perror(fw_file);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; write(fd, buffer, count);<br />&nbsp; &nbsp; &nbsp; &nbsp; close(fd);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return 1;<br />}</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120002">
				<div class="post-metadata">
					<div class="post-num">Post #119</div>
					<div class="post-author">pippolippi</div>
					<div class="post-datetime">
						29 Oct 2010, 22:24					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ngp wrote:</cite><blockquote><p>// available flas reduced by brnboot (0x0-0x6000) and board config (last sector)<br />#define FLASH_AVAIL&nbsp; &nbsp; &nbsp;(FLASH_SIZE - 0x60000 - 64 *KiB)</p></blockquote></div><p>0x6000 or 0x60000?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120006">
				<div class="post-metadata">
					<div class="post-num">Post #120</div>
					<div class="post-author">pippolippi</div>
					<div class="post-datetime">
						29 Oct 2010, 23:50					</div>
				</div>
				<div class="post-content content">
					<p>I tried to dump the current firmware of my arv7518pw but the serial/usb adapter died :-(<br />Since the original firmware file for it isn&#039;t available anywhere, I cannot test your image</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120031">
				<div class="post-metadata">
					<div class="post-num">Post #121</div>
					<div class="post-author">dp79</div>
					<div class="post-datetime">
						30 Oct 2010, 12:29					</div>
				</div>
				<div class="post-content content">
					<p>ngp,</p><p>Let me just confirm some things with you, before I upload your firmware....</p><p>I can upload this image to an smc7908A-ISP, even though your image is for arv4518.<br />I will be able to recover the original fw if I save the current fw prior the upload.</p><p>I just don&#039;t want to brick my router.....</p><p>And an other question. What has to be done in order to save permanent changes?</p><p>&nbsp; dp79</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120037">
				<div class="post-metadata">
					<div class="post-num">Post #122</div>
					<div class="post-author">pippolippi</div>
					<div class="post-datetime">
						30 Oct 2010, 16:59					</div>
				</div>
				<div class="post-content content">
					<p>@ngp, I scavenged a max232 from by scrap bin and I managed to connect to the serial port of the arv7518pw (which, btw, it seems it has a different pin-out than the 4518).<br />Since there&#039;s no option to download the firmware, I have to dump it to the screen (with the &quot;Read from memory&quot; boot menu option) and decode it. I have a program somewhere to do it, but since it&#039;s slow and error prone, I&#039;d like to know what to dump:</p><div class="codebox"><pre><code>UPLOAD Flash
---------------------------------------
    Area            Address      Length 
---------------------------------------
[0] Boot            0xB0000000     128K
[1] Configuration   0xB0020000     256K
[2] None            0xB0060000      64K
[3] Special Area    0xB0070000      64K
[4] Primary Setting 0xB0080000      64K
[5] Code Image 0    0xB0090000    3776K
[6] Code Image 1    0xB0440000    3776K
[7] Boot Params     0xB07F0000      64K
[8] Flash Image     0xB0000000    8192K
---------------------------------------</code></pre></div><p>Apparently your firmware starts at 0x60000 and doesn&#039;t overwrite the last partition, so I should dump [2],[3],[4],[5] and [6], right?</p>											<p class="post-edited">(Last edited by <strong>pippolippi</strong> on 30 Oct 2010, 16:59)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120082">
				<div class="post-metadata">
					<div class="post-num">Post #123</div>
					<div class="post-author">pippolippi</div>
					<div class="post-datetime">
						31 Oct 2010, 13:30					</div>
				</div>
				<div class="post-content content">
					<p>Mmh, the arv7518pw has double the flash (8Mbytes instead of 4) and a different disposition, this is the beginning of the bootlog of the arv4518</p><div class="codebox"><pre><code>=======================================================================
Wireless ADSL Gateway DANUBE Loader 64M-V0.02 build Nov 22 2007 17:32:23
                    Arcadyan Technology Corporation
=======================================================================
EON EN29LV320B bottom boot 16-bit mode found

Copying boot params.....DONE


Press Space Bar 3 times to enter command mode ...
Flash Checking - fw/ui...  Passed.

Image[1] at 0xb0060000, len:1378740, type:0
Image[2] at 0xb01b0c00, len:459767, type:10
Image[3] at 0xb0221400, len:174146, type:50
Image[4] at 0xb024c000, len:173329, type:60
Image[5] at 0xb0276800, len:316099, type:90
Firmware image at 0, ART image at -1</code></pre></div><p>compared to the arv7518</p><div class="codebox"><pre><code>=======================================================================
Wireless ADSL Gateway DANUBE Loader v1.04.00 build Feb 26 2010 20:49:17
                    Arcadyan Technology Corporation
=======================================================================
EON EN29LV640B bottom boot 16-bit mode found

Copying boot params.....DONE


Press Space Bar 3 times to enter command mode ...
Flash Checking [0] Passed.
Image[1] at 0xb0090000, len:1553932, type:0
Image[2] at 0xb020b800, len:477978, type:10
Image[3] at 0xb0280400, len:241582, type:9
Image[4] at 0xb02bb400, len:174146, type:50
Image[5] at 0xb02e6000, len:173329, type:60
Image[6] at 0xb0310800, len:316099, type:90
Firmware image at 0, ART image at 2</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120085">
				<div class="post-metadata">
					<div class="post-num">Post #124</div>
					<div class="post-author">ngp</div>
					<div class="post-datetime">
						31 Oct 2010, 13:47					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>pipolippi: Do no flash my image. It wont work. The flash size and flash layout are different. The uboot in my image will try to start a kernel at addr 0xb007d000 and probably in your flash it will be at 0xb009d000. Can you post a bootlog? <br />Alternatively, you can try to extract the uboot from my image (first or secon file) with sp700ex utility and unlzma the unscrambled one. Then load it at RAM address 0x80002000. If it works, you kan tftp the kernel (third file) and bootm.</p><p>dp79: smc7908A-ISP and&nbsp; arv4518 are the same router. My firmware image only replaces the firmware part of the flash, the original bootloader is kept intact, so if you have an ya/smc/whatever flash update, you can always reflash using the recovery procedure (pressing reset during powerup). But beware: my image is a test image, very far away from production state.</p><p>Greets.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p120088">
				<div class="post-metadata">
					<div class="post-num">Post #125</div>
					<div class="post-author">pippolippi</div>
					<div class="post-datetime">
						31 Oct 2010, 14:32					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ngp wrote:</cite><blockquote><p>pipolippi: Do no flash my image. It wont work. The flash size and flash layout are different. The uboot in my image will try to start a kernel at addr 0xb007d000 and probably in your flash it will be at 0xb009d000. Can you post a bootlog?</p></blockquote></div><p>Yes, I already thought that I couldn&#039;t flash the image as is. Here is the bootlog:<br /> <a href="http://pastebin.ca/1977895">http://pastebin.ca/1977895</a></p><div class="quotebox"><cite>ngp wrote:</cite><blockquote><p>Alternatively, you can try to extract the uboot from my image (first or secon file) with sp700ex utility and unlzma the unscrambled one. Then load it at RAM address 0x80002000. If it works, you kan tftp the kernel (third file) and bootm.</p></blockquote></div><p>I&#039;ll try that.</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 5 of 40</div><nav><ul><li><a href="viewtopic.php%3Fid=15934&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=15934&amp;p=3.html">3</a></li><li><a href="viewtopic.php%3Fid=15934&amp;p=4.html">4</a></li><li class="pagination-current"><span>5</span></li><li><a href="viewtopic.php%3Fid=15934&amp;p=6.html">6</a></li><li><a href="viewtopic.php%3Fid=15934&amp;p=7.html">7</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=15934&amp;p=40.html">40</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>