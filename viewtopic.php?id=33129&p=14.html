<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> New package: mwan2; testers wanted.</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 31 Mar 2018 and 27 Apr 2018.
										Unfortunately there are posts – most likely complete pages – missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 14 of 14</div><nav><ul><li><a href="viewtopic.php%3Fid=33129&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=33129&amp;p=12.html">12</a></li><li><a href="viewtopic.php%3Fid=33129&amp;p=13.html">13</a></li><li class="pagination-current"><span>14</span></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p176532">
				<div class="post-metadata">
					<div class="post-num">Post #326</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						31 Aug 2012, 17:55					</div>
				</div>
				<div class="post-content content">
					<p>Hi all,</p><br /><p>Here is the first release of mwan3. I will create a new topic soon, but i&#039;m eager to share and hear what you guys think of it.</p><p>The package:<br /><a href="http://213.136.13.52/mwan3_1.0-1_ar71xx.ipk">http://213.136.13.52/mwan3_1.0-1_ar71xx.ipk</a></p><p>And the source:<br /><a href="http://213.136.13.52/mwan3_1.0-1.tar.gz">http://213.136.13.52/mwan3_1.0-1.tar.gz</a></p><p>The big difference between mwan3 and mwan2 is that you now can define different primary and secondary wan&#039;s for different traffic. Please take a look at the config file for more info.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p176854">
				<div class="post-metadata">
					<div class="post-num">Post #327</div>
					<div class="post-author">LaySoft</div>
					<div class="post-datetime">
						4 Sep 2012, 14:43					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adze!</p><p>You are using Netgear WNDR3700v2, but this is &quot;old&quot; model, and new v3 don&#039;t supports OpenWrt. The successor WNDR3800 seems a good choice, but i don&#039;t know it can be supports to VLANs works on both LAN and WAN, like WNDR3700. Is there any recommended model for two or more cable wan configuration?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p177037">
				<div class="post-metadata">
					<div class="post-num">Post #328</div>
					<div class="post-author">julianjm</div>
					<div class="post-datetime">
						6 Sep 2012, 00:27					</div>
				</div>
				<div class="post-content content">
					<p>Hi... First of all, thanks Adze for his great work.... Multiwan never worked for us properly, and mwan2 is almost there <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I have 2 PPPoE wan links. I set mwan2 to load balance them (metric/weight=1). We use a rule for a custom checkip service, with equalize=1, and we see the reported IP changes every time we reload.</p><p>The problem we have is that sometimes, after reboot, wan1 is activated (ping -I pppoe-wan1 8.8.8.8 works), we can see mwan2 adding rules for it in logread, BUT the ip table 1 is empty (and table 3 only refers to wan2). If I restart wan1 (ifdown wan1 ; ifup wan1) everything fixes.</p><br /><p>Before:<br /></p><div class="codebox"><pre><code>root@corpe-gt:~# ip route show table 1
root@corpe-gt:~# ip route show table 2
default via 192.168.153.1 dev pppoe-wan2  metric 1 
root@corpe-gt:~# ip route show table 3
default via 192.168.153.1 dev pppoe-wan2  metric 1</code></pre></div><p>After restarting wan1:<br /></p><div class="codebox"><pre><code>root@corpe-gt:~# ip route show table 1
default via 80.58.67.104 dev pppoe-wan1  metric 1 
root@corpe-gt:~# ip route show table 2
default via 192.168.153.1 dev pppoe-wan2  metric 1 
root@corpe-gt:~# ip route show table 3
default  metric 1 
    nexthop via 80.58.67.104  dev pppoe-wan1 weight 1
    nexthop via 192.168.153.1  dev pppoe-wan2 weight 1</code></pre></div><p>We are using a custom built openwrt, r32576, no modifications. Uting qos-scripts with both interfaces defined there. Legacy multiwan not installed.</p><p>Any clue on what may be happening?</p><p>/etc/config/network&nbsp; (relevant lines)<br /></p><div class="codebox"><pre><code>config interface &#039;wan1&#039;
    option proto &#039;pppoe&#039;
    option ifname &#039;eth0.1&#039;
    option username &#039;adslppp@telefonicanetpa&#039;
    option password &#039;adslppp&#039;
    option peerdns &#039;0&#039;
    option dns &#039;8.8.8.8&#039;

config interface &#039;wan2&#039;
    option proto &#039;pppoe&#039;
    option ifname &#039;eth0.2&#039;
    option username &#039;adslppp@telefonicanetpa&#039;
    option password &#039;adslppp&#039;
    option peerdns &#039;0&#039;
    option dns &#039;8.8.8.8&#039;</code></pre></div><p>/etc/config/mwan2<br /></p><div class="codebox"><pre><code>config &#039;interface&#039; &#039;wan1&#039;
    option &#039;enabled&#039; &#039;1&#039;
    option &#039;metric&#039; &#039;1&#039;
    option &#039;weight&#039; &#039;1&#039;
    option &#039;track_ip&#039; &#039;8.8.8.8&#039;
    option &#039;count&#039; &#039;1&#039;
    option &#039;timeout&#039; &#039;2&#039;
    option &#039;interval&#039; &#039;5&#039;
    option &#039;down&#039; &#039;3&#039;
    option &#039;up&#039; &#039;8&#039;

config &#039;interface&#039; &#039;wan2&#039;
    option &#039;enabled&#039; &#039;1&#039;
    option &#039;metric&#039; &#039;1&#039;
    option &#039;weight&#039; &#039;1&#039;
    option &#039;track_ip&#039; &#039;8.8.4.4&#039;
    option &#039;count&#039; &#039;1&#039;
    option &#039;timeout&#039; &#039;2&#039;
    option &#039;interval&#039; &#039;5&#039;
    option &#039;down&#039; &#039;3&#039;
    option &#039;up&#039; &#039;8&#039;

# We have openvpn routing that subnet. The routes are pushed by openvpn (seems to be working fine)
config &#039;rule&#039;
    option &#039;dest_ip&#039; &#039;10.100.0.0/16&#039;
    list &#039;use_interface&#039; &#039;default&#039;

# checkip service, for testing equalice=1
config &#039;rule&#039;
    option &#039;dest_ip&#039; &#039;188.165.xxx.xxx/32&#039;
    option &#039;proto&#039; &#039;tcp&#039;
    option &#039;equalize&#039; &#039;1&#039;
    list &#039;use_interface&#039; &#039;wan1&#039;
    list &#039;use_interface&#039; &#039;wan2&#039;

# default rule
config &#039;rule&#039;
    option &#039;dest_ip&#039; &#039;0.0.0.0/0&#039;
    #option &#039;equalize&#039; &#039;1&#039;
    list &#039;use_interface&#039; &#039;wan1&#039;
    list &#039;use_interface&#039; &#039;wan2&#039;</code></pre></div><p>Thanks in advance,<br />Julian.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p177039">
				<div class="post-metadata">
					<div class="post-num">Post #329</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						6 Sep 2012, 00:49					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m not sure, but maybe i know what is happening...</p><p>As your network config does not include metric settings for the wan interfaces, there might be a race condition. As wan1 comes up it first handles the basic networking before mwan2 comes into play, but even before mwan2 can finish completely, wan2 comes up. This might override your default routing table entry of wan1. Which in turn causes mwan2 not to finish correctly for wan1, as it needs that information from the default routing table.</p><p>Try to set some metric values on your wan interfaces in your network config.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 6 Sep 2012, 00:59)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p177040">
				<div class="post-metadata">
					<div class="post-num">Post #330</div>
					<div class="post-author">julianjm</div>
					<div class="post-datetime">
						6 Sep 2012, 01:13					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>I&#039;m not sure, but maybe i know what is happening...</p><p>As your network config does not include metric settings for the wan interfaces, there might be a race condition. As wan1 comes up it first handles the basic networking before mwan2 comes into play, but even before mwan2 can finish completely, wan2 comes up. This might override your default routing table entry of wan1. Which in turn causes mwan2 not to finish correctly for wan1, as it needs that information from the default routing table.</p><p>Try to set some metric values on your wan interfaces in your network config.</p></blockquote></div><p>I&#039;ve done some reboots and so far it hasn&#039;t failed. Thanks man.</p><p>BTW, I didn&#039;t initially set the metric on those interfaces, because acording to the documentation, the &quot;metric&quot; option was not allowed with protocol &quot;pppoe&quot;, only &quot;static&quot;. <a href="http://wiki.openwrt.org/doc/uci/network">http://wiki.openwrt.org/doc/uci/network</a> <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Thanks again,<br />Julian.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p177509">
				<div class="post-metadata">
					<div class="post-num">Post #331</div>
					<div class="post-author">NetworkPro</div>
					<div class="post-datetime">
						9 Sep 2012, 10:09					</div>
				</div>
				<div class="post-content content">
					<p>mwan3 works</p><p>default config + suggested mwan2 static routes</p><p>wan1 DHCP<br />wan2 PPPoE</p><div class="codebox"><pre><code>#/etc/config/network
#...
config interface &#039;wan1&#039;
        option ifname &#039;eth0.1&#039;
        option proto &#039;dhcp&#039;
        option defaultroute &#039;0&#039;

config interface &#039;wan2&#039;
        option proto &#039;pppoe&#039;
        option ifname &#039;eth0.2&#039;
        option username &#039;&lt;ausername&gt;&#039;
        option password &#039;&lt;apassword&gt;&#039;
        option defaultroute &#039;0&#039;

config route 
        option interface &#039;wan1&#039;
        option target &#039;0.0.0.0&#039;
        option netmask &#039;0.0.0.0&#039;
        option metric &#039;10&#039;
        option gateway &#039;&lt;ISP1 Gateway IP&gt;&#039;
 
config route 
        option interface &#039;wan2&#039;
        option target &#039;0.0.0.0&#039;
        option netmask &#039;0.0.0.0&#039;
        option metric &#039;20&#039;
        option gateway &#039;&lt;ISP2 Gateway IP&gt;&#039;
#...</code></pre></div><p>But with the current situation we have static routes with metric 10 and 20 configured.</p><p><strong>In this case the moment when ISP changes their gateway IP - we are screwed.</strong></p><p><strong>Any suggestion to avoid this?</strong></p><p>What about the case when we use two lines where the gateway is the same and our IP on both lines is the same? This is the case when the ISP gives us a CPE and private range - same private range on all CPEs.</p><p>Thanks.</p>											<p class="post-edited">(Last edited by <strong>NetworkPro</strong> on 9 Sep 2012, 11:20)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p177517">
				<div class="post-metadata">
					<div class="post-num">Post #332</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						9 Sep 2012, 12:54					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>NetworkPro wrote:</cite><blockquote><p>with the current situation we have static routes with metric 10 and 20 configured.</p><p>In this case the moment when ISP changes their gateway IP - we are screwed.</p><p>Any suggestion to avoid this?</p></blockquote></div><p>In older versions of OpenWrt, where netifd was not used, you had to do this trick with static routes. This was because you could not set the metric option on ppp interfaces. With recent versions of OpenWrt with netifd, this trick is no longer necessary. Please try the following:</p><div class="codebox"><pre><code>config interface &#039;wan1&#039;
        option ifname &#039;eth0.1&#039;
        option proto &#039;dhcp&#039;
        option metric &#039;10&#039;

config interface &#039;wan2&#039;
        option proto &#039;pppoe&#039;
        option ifname &#039;eth0.2&#039;
        option username &#039;&lt;ausername&gt;&#039;
        option password &#039;&lt;apassword&gt;&#039;
        option metric &#039;20&#039;</code></pre></div><div class="quotebox"><cite>NetworkPro wrote:</cite><blockquote><p>What about the case when we use two lines where the gateway is the same and our IP on both lines is the same? This is the case when the ISP gives us a CPE and private range - same private range on all CPEs.</p></blockquote></div><p>I have no simple solution to that... Using two OpenWrt routers, one for each CPE could be a sollution.</p><p>Thanks for testing.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p177526">
				<div class="post-metadata">
					<div class="post-num">Post #333</div>
					<div class="post-author">NetworkPro</div>
					<div class="post-datetime">
						9 Sep 2012, 14:30					</div>
				</div>
				<div class="post-content content">
					<p>You SOLVED it High five !</p><p>option <strong>metric</strong> worked this time - I just had to remove option <strong>defaltroute</strong> so that its not there at all</p><p>Removing defaultroute and leaving only metric &#039;10&#039; and metric &#039;20&#039; for each wan respectively solved the problem.</p><p>Can you add e-mail notification on link failure and generally more business features?</p><br /><p>In what way DNS failover works? Can we do DNS preference if one ISP DNS is better?</p><p>Thank you.</p>											<p class="post-edited">(Last edited by <strong>NetworkPro</strong> on 9 Sep 2012, 14:36)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p180078">
				<div class="post-metadata">
					<div class="post-num">Post #334</div>
					<div class="post-author">julianjm</div>
					<div class="post-datetime">
						5 Oct 2012, 11:17					</div>
				</div>
				<div class="post-content content">
					<p>Hi again,</p><p>I has happened twice, that after some time, one of the wans disappears from table 3 (the load balancer). I can manually ping -I pppoe-wan1 8.8.8.8&nbsp; &nbsp;(and same for pppoe-wan2), but mwan2 seems to think it&#039;s down.</p><p>If I restart that wan connection (ifdown wan2 ; ifup wan2), everything is back to normal.</p><p>Is there any way to enable logging of what mwan2 does, or even hack it to send notifications on link failures, as previos message suggests?</p><p>Thanks<br />Julian.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182138">
				<div class="post-metadata">
					<div class="post-num">Post #335</div>
					<div class="post-author">tekoholic</div>
					<div class="post-datetime">
						1 Nov 2012, 23:38					</div>
				</div>
				<div class="post-content content">
					<p>Here&#039;s another:</p><p>5) Convert WLAN to WWAN as 2nd WAN, or add WWAN to WLAN if iface supports it...</p><div class="quotebox"><cite>Sorbe wrote:</cite><blockquote><p>I would also suggest adding a good LUCI package to select from the common multi-wan configurations.&nbsp; &nbsp;For example:<br />1) Convert 1 of the LAN ports to a 2nd WAN port.<br />2) Convert 2 of the LAN ports to 2nd &amp; 3rd WAN ports.<br />3) Convert 3 of the LAN ports to 2nd, 3rd, 4th WAN ports<br />4) Convert all of the LAN port to WAN ports and use the original WAN port for LAN traffic.<br />...</p><p>For each of these include weights and metrics options.<br />Maybe include a LED configuration page too <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Any more suggestions?</p></blockquote></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183654">
				<div class="post-metadata">
					<div class="post-num">Post #336</div>
					<div class="post-author">zensey</div>
					<div class="post-datetime">
						19 Nov 2012, 11:02					</div>
				</div>
				<div class="post-content content">
					<p><strong>Feature Request.</strong><br /><strong><span class="bbu">Long-running connections continue to use old route.</span></strong></p><br /><p>When main route becomes available, new connections are beeing directed to the main route,<br />but long running connection, e.g. OpenVPN UDP session still continues to use backup route.<br />Can mwan2 enforce those sessions to use main route or forcevely kill this sessions (possibly after some given period of time)?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183657">
				<div class="post-metadata">
					<div class="post-num">Post #337</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						19 Nov 2012, 11:30					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>zensey wrote:</cite><blockquote><p>When main route becomes available, new connections are beeing directed to the main route,<br />but long running connection, e.g. OpenVPN UDP session still continues to use backup route.<br />Can mwan2 enforce those sessions to use main route or forcevely kill this sessions (possibly after some given period of time)?</p></blockquote></div><p>No, as it would make absolutely no sense.</p><p>When a session is routed through wan2 (in the event that wan1 is down) and wan1 comes back online; and you were to send subsequent packages out wan1, the receiving host will see packets from a complete other source and won&#039;t accept them for the old session. Only when you make a new session a new routing decision will be made.</p><p>You should let OpenVPN do the force-setup of a new session.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 19 Nov 2012, 11:34)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183664">
				<div class="post-metadata">
					<div class="post-num">Post #338</div>
					<div class="post-author">zensey</div>
					<div class="post-datetime">
						19 Nov 2012, 12:55					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><div class="quotebox"><cite>zensey wrote:</cite><blockquote><p>When main route becomes available, new connections are beeing directed to the main route,<br />but long running connection, e.g. OpenVPN UDP session still continues to use backup route.<br />Can mwan2 enforce those sessions to use main route or forcevely kill this sessions (possibly after some given period of time)?</p></blockquote></div><p>No, as it would make absolutely no sense.</p><p>When a session is routed through wan2 (in the event that wan1 is down) and wan1 comes back online; and you were to send subsequent packages out wan1, the receiving host will see packets from a complete other source and won&#039;t accept them for the old session. Only when you make a new session a new routing decision will be made.</p><p>You should let OpenVPN do the force-setup of a new session.</p></blockquote></div><br /><p>OpenVPN Client is started on machine from the &quot;lan&quot; zone.<br />May be the problem is caused by file /etc/hotplug.d/iface/10-routes ? <br />After upgrade to &quot;OpenWrt Attitude Adjustment 12.09-beta&quot;{1,2} without this file mwan2 stop to function.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183665">
				<div class="post-metadata">
					<div class="post-num">Post #339</div>
					<div class="post-author">zensey</div>
					<div class="post-datetime">
						19 Nov 2012, 13:18					</div>
				</div>
				<div class="post-content content">
					<p>After main channel becomes online nf_conntrack still shows that backup channel is used</p><div class="codebox"><pre><code>root@OpenWrt:~# ip ru
0:      from all lookup local
192:    from 192.168.1.148 fwmark 0x0/0x8000 lookup 1
193:    from 10.224.202.28 fwmark 0x0/0x8000 lookup 2
256:    from all fwmark 0x100/0xff00 lookup 1
257:    from all fwmark 0x200/0xff00 lookup 2
258:    from all fwmark 0x300/0xff00 lookup 3
32766:  from all lookup main
32767:  from all lookup default

root@OpenWrt:~# route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         192.168.1.1     0.0.0.0         UG    10     0        0 eth1
default         *               0.0.0.0         U     20     0        0 3g-wan2
default         *               0.0.0.0         U     20     0        0 3g-wan2
10.64.64.64     *               255.255.255.255 UH    0      0        0 3g-wan2
192.168.1.0     *               255.255.255.0   U     10     0        0 eth1
192.168.4.0     *               255.255.255.0   U     0      0        0 br-lan


root@OpenWrt:~# cat /proc/net/nf_conntrack|grep udp| grep 1194
ipv4     2 udp      17 178 src=192.168.4.106 dst=95.163.85.124 sport=2759 dport=1194 packets=1107 bytes=310337 src=95.163.85.124 dst=[color=#FF0000]10.224.202.28[/color] sport=1194 dport=2759 packets=887 bytes=535904 [ASSURED] mark=512 use=2</code></pre></div><p>dst=<span style="color: #FF0000">10.224.202.28</span> -- It does show that backup route is being used</p><p>If I mannualy restart OpenVPN client, then rigth route becomes used as expected.</p>											<p class="post-edited">(Last edited by <strong>zensey</strong> on 19 Nov 2012, 13:20)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183698">
				<div class="post-metadata">
					<div class="post-num">Post #340</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						19 Nov 2012, 18:31					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>zensey wrote:</cite><blockquote><p>May be the problem is caused by file /etc/hotplug.d/iface/10-routes ?</p></blockquote></div><p>Could you paste me your network config, as i suspect that there is something wrong there...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183709">
				<div class="post-metadata">
					<div class="post-num">Post #341</div>
					<div class="post-author">zensey</div>
					<div class="post-datetime">
						19 Nov 2012, 20:52					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><div class="quotebox"><cite>zensey wrote:</cite><blockquote><p>May be the problem is caused by file /etc/hotplug.d/iface/10-routes ?</p></blockquote></div><p>Could you paste me your network config, as i suspect that there is something wrong there...</p></blockquote></div><br /><div class="codebox"><pre><code>config interface &#039;loopback&#039;
        option ifname &#039;lo&#039;
        option proto &#039;static&#039;
        option ipaddr &#039;127.0.0.1&#039;
        option netmask &#039;255.0.0.0&#039;

config interface &#039;lan&#039;
        option ifname &#039;eth0&#039;
        option type &#039;bridge&#039;
        option proto &#039;static&#039;
        option netmask &#039;255.255.255.0&#039;
        option ipaddr &#039;192.168.4.1&#039;

config switch
        option name &#039;eth0&#039;
        option reset &#039;1&#039;
        option enable_vlan &#039;1&#039;

config switch_vlan
        option device &#039;eth0&#039;
        option vlan &#039;1&#039;
        option ports &#039;0 1 2 3 4&#039;

config interface &#039;wan&#039;
        option ifname &#039;eth1&#039;
        option _orig_ifname &#039;eth1&#039;
        option _orig_bridge &#039;false&#039;
        option proto &#039;dhcp&#039;
        option &#039;metric&#039; &#039;10&#039;

config interface &#039;wan2&#039;
        option ifname &#039;ppp0&#039;
        option proto &#039;3g&#039;
        option &#039;device&#039; &#039;/dev/ttyUSB0&#039;
        option service &#039;umts&#039;
        option apn &#039;internet&#039;
        option &#039;peerdns&#039; &#039;0&#039;
        option &#039;metric&#039; &#039;20&#039;

config &#039;route&#039;
        option &#039;interface&#039; &#039;wan2&#039;
        option &#039;target&#039; &#039;0.0.0.0&#039;
        option &#039;netmask&#039; &#039;0.0.0.0&#039;
        option &#039;metric&#039; &#039;20&#039;</code></pre></div><br /><p>It seams that conntrack UDP entries should be removed manually when route changes:<br /><a href="http://www.unixpearls.com/solved-linux-nat-conntrack-caching-routes-to-asterisk-server/">http://www.unixpearls.com/solved-linux- … sk-server/</a><br /><a href="http://www.iptables.info/en/connection-state.html#UDPCONNECTIONS">http://www.iptables.info/en/connection- … ONNECTIONS</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183737">
				<div class="post-metadata">
					<div class="post-num">Post #342</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						20 Nov 2012, 10:02					</div>
				</div>
				<div class="post-content content">
					<p>Hi Zensey,</p><br /><p>You can leave out/remove the last route config section.</p><br /><p>Adze</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183741">
				<div class="post-metadata">
					<div class="post-num">Post #343</div>
					<div class="post-author">zensey</div>
					<div class="post-datetime">
						20 Nov 2012, 10:43					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hi Zensey,</p><br /><p>You can leave out/remove the last route config section.</p><br /><p>Adze</p></blockquote></div><p>Yes, it works.<br />But conntrack still shows use of backup route.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183746">
				<div class="post-metadata">
					<div class="post-num">Post #344</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						20 Nov 2012, 11:24					</div>
				</div>
				<div class="post-content content">
					<p>Hi Zensey,</p><br /><p>I think i don&#039;t really understand you...</p><p>I assume that you have the following situation. A node on your LAN has an OpenVPN connection through the router. In this current situation your primary link is down and traffic is routed over your secondary connection. So far OK?</p><p>Then the primary link comes back online and all new connections are routed through the primary link. All active/established session continue to route through the secondary connection. So far OK?</p><p>Your VPN connection stays connected through secondary wan, until you restart your OpenVPN client on your LAN. When you have restarted the new connection is routed through primary wan. So far OK?</p><p>If this is the case, it works exactly how it supposed to work. If there is something i&#039;m missing, please inform me.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183750">
				<div class="post-metadata">
					<div class="post-num">Post #345</div>
					<div class="post-author">zensey</div>
					<div class="post-datetime">
						20 Nov 2012, 11:49					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hi Zensey,</p><br /><p>I think i don&#039;t really understand you...</p><p>I assume that you have the following situation. A node on your LAN has an OpenVPN connection through the router. In this current situation your primary link is down and traffic is routed over your secondary connection. So far OK?</p><p>Then the primary link comes back online and all new connections are routed through the primary link. All active/established session continue to route through the secondary connection. So far OK?</p><p>Your VPN connection stays connected through secondary wan, until you restart your OpenVPN client on your LAN. When you have restarted the new connection is routed through primary wan. So far OK?</p><p>If this is the case, it works exactly how it supposed to work. If there is something i&#039;m missing, please inform me.</p></blockquote></div><br /><p>Absolutely right.<br />But I wanted to know <br />where should I issue &quot;conntrack -D ...&quot; in the code of mwan2 to break that vpn connect?</p>											<p class="post-edited">(Last edited by <strong>zensey</strong> on 20 Nov 2012, 12:11)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183754">
				<div class="post-metadata">
					<div class="post-num">Post #346</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						20 Nov 2012, 13:05					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>zensey wrote:</cite><blockquote><p>But I wanted to know <br />where should I issue &quot;conntrack -D ...&quot; in the code of mwan2 to break that vpn connect?</p></blockquote></div><br /><p>You can put it &quot;/etc/hotplug.d/iface&quot;. All scripts located in that location will run when an interface goes up or down. You don&#039;t have to / want to edit mwan2 script directly.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p183755">
				<div class="post-metadata">
					<div class="post-num">Post #347</div>
					<div class="post-author">zensey</div>
					<div class="post-datetime">
						20 Nov 2012, 13:15					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><div class="quotebox"><cite>zensey wrote:</cite><blockquote><p>But I wanted to know <br />where should I issue &quot;conntrack -D ...&quot; in the code of mwan2 to break that vpn connect?</p></blockquote></div><br /><p>You can put it &quot;/etc/hotplug.d/iface&quot;. All scripts located in that location will run when an interface goes up or down. You don&#039;t have to / want to edit mwan2 script directly.</p></blockquote></div><p>Thank you.<br />I have made like you said and now it works as expected.</p>											<p class="post-edited">(Last edited by <strong>zensey</strong> on 22 Nov 2012, 13:26)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 14 of 14</div><nav><ul><li><a href="viewtopic.php%3Fid=33129&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=33129&amp;p=12.html">12</a></li><li><a href="viewtopic.php%3Fid=33129&amp;p=13.html">13</a></li><li class="pagination-current"><span>14</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>