<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> ath79: SD-card on SPI-bus</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 6 Feb 2018 and 18 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 3</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=54077&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=54077&amp;p=3.html">3</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p254673">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">Deoptim</div>
					<div class="post-datetime">
						17 Nov 2014, 20:31					</div>
				</div>
				<div class="post-content content">
					<p>Translated &amp; added more info:<br /><a href="http://wiki.openwrt.org/toh/tp-link/tl-mr3420/deep.mmc.hack">http://wiki.openwrt.org/toh/tp-link/tl- â€¦ p.mmc.hack</a><br />Comment on this topic.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p315706">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">anarchy99</div>
					<div class="post-datetime">
						19 Mar 2016, 17:49					</div>
				</div>
				<div class="post-content content">
					<p>hi</p><p>i&#039;m trying gpio mmc mod but card not detected</p><div class="codebox"><pre><code>root@OpenWrt:~# cat /sys/kernel/debug/mmc0/clock
0
root@OpenWrt:~# cat /sys/kernel/debug/mmc0/ios
clock:        0 Hz
vdd:        0 (invalid)
bus mode:    2 (push-pull)
chip select:    1 (active high)
power mode:    0 (off)
bus width:    0 (1 bits)
timing spec:    0 (legacy)
signal voltage:    1 (3.30 V)</code></pre></div><p>looks like problem with clock and power, 3.3V taken from spi flash pin is it enough?</p><p>update: gpio debug</p><div class="codebox"><pre><code> gpio-1   (spi_cs              ) out lo    
 gpio-6   (sw1                 ) in  hi    
 gpio-7   (sw2                 ) in  lo    
 gpio-11  (reset               ) in  lo    
 gpio-14  (spi_mosi            ) out hi    
 gpio-16  (spi_clock           ) out lo    
 gpio-17  (spi_miso            ) in  hi    
 gpio-18  (USB power           ) out hi    
 gpio-27  (tp-link:blue:system ) out hi   </code></pre></div>											<p class="post-edited">(Last edited by <strong>anarchy99</strong> on 19 Mar 2016, 18:12)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p315751">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">anarchy99</div>
					<div class="post-datetime">
						19 Mar 2016, 22:56					</div>
				</div>
				<div class="post-content content">
					<p>switched clock and miso and got this, but only for 2-3 seconds before it goes back to previously posted state</p><div class="codebox"><pre><code>root@OpenWrt:~# cat /sys/kernel/debug/mmc0/ios
clock:        400000 Hz
vdd:        21 (3.3 ~ 3.4 V)
bus mode:    2 (push-pull)
chip select:    1 (active high)
power mode:    2 (on)
bus width:    0 (1 bits)
timing spec:    0 (legacy)
signal voltage:    1 (3.30 V)</code></pre></div><p>dmesg:</p><div class="codebox"><pre><code>[ 8167.810000] gpio-mmc: MMC-Card &quot;default&quot; attached to GPIO pins di=14, do=16, clk=17, cs=1
[ 8167.820000] mmc_spi spi32759.0: no support for card&#039;s volts
[ 8167.830000] mmc0: error -22 whilst initialising SDIO card
[ 8167.840000] mmc_spi spi32759.0: no support for card&#039;s volts
[ 8167.840000] mmc0: error -22 whilst initialising SD card
[ 8167.850000] mmc_spi spi32759.0: no support for card&#039;s volts
[ 8167.850000] mmc0: error -22 whilst initialising MMC card</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p348716">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						7 Jan 2017, 23:53					</div>
				</div>
				<div class="post-content content">
					<p>Hi, I&#039;ve been trying to rig up the deep mmc mod for dir-601 a1 ( ar7240, mx25l3205d spi flash ) using pins 8 (miso)15 (mosi) and 16 (clock) on flash and cs on wps led ( for internal cs on gpio0 ) or button, with no additional components other than a microsd card with sd adapter soldered to those pins. With that kernel mod ( trying to get extroot on card ) I get a freeze up at boot just as all leds light up. Serial console shows nothing, no uboot at that point and with the card out of the adapter it boots normally.</p><p>Anybody have any luck with this router? I have ordered an arduino style card reader module so that should eliminate any question of signal problems with pull up resistors etc, although spi is supposed to work anyhow. I feel like it&#039;s a short somewhere.</p>											<p class="post-edited">(Last edited by <strong>lobonse</strong> on 8 Jan 2017, 00:14)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p349077">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">Deoptim</div>
					<div class="post-datetime">
						11 Jan 2017, 23:04					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>lobonse wrote:</cite><blockquote><p>... With that kernel mod ( trying to get extroot on card ) I get a freeze up at boot just as all leds light up. Serial console shows nothing, no uboot at that point and with the card out of the adapter it boots normally.</p><p>Anybody have any luck with this router?...</p></blockquote></div><p>I have same problem with kernel integration of necessary modules(<a href="https://wiki.openwrt.org/toh/tp-link/tl-mr3420/deep.mmc.hack#second_way_build_it_in_kernel">i used &quot;make kernel_menuconfig&quot;</a>), but I had this problem only if i used fresh <strong>trunk</strong>.<br />Try to use Chaos Calmer branch.</p><p>Write please if you success.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p349301">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						14 Jan 2017, 21:50					</div>
				</div>
				<div class="post-content content">
					<p>Interesting, I am using Barrier Breaker. So CC sysupgrades no problem? I&#039;d be worried about it being too large for 4mb. I am waiting for those arduino-style sd card adapters to see if they will help. if not, I&#039;ll definitely try the CC sysupgrade, thanks!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p349309">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						15 Jan 2017, 00:40					</div>
				</div>
				<div class="post-content content">
					<p>Chaos Calmer installed, now to wait a few weeks for the sd card adapter..</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p350876">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						2 Feb 2017, 02:56					</div>
				</div>
				<div class="post-content content">
					<p>Hi again, I&#039;ve got the new sd card adapter wired in. I have tried building chaos calmer with the WPS button, LAN4 LED and now the WAN AMBER LED ( which doesn&#039;t use active low I guess ) as CS gpio. Both the sd card and the adapter were tested and work. The following is with the card in the adapter; when it&#039;s out the router boots fine.</p><p>I seem to be stuck on this one problem. From the serial console:</p><p>[&nbsp; &nbsp; 2.210000] mmc_spi spi0.1: SD/MMC host mmc0, no DMA, no WP, no poweroff<br />[&nbsp; &nbsp; 2.210000] TCP: cubic registered<br />[&nbsp; &nbsp; 2.220000] NET: Registered protocol family 17<br />[&nbsp; &nbsp; 2.220000] bridge: automatic filtering via arp/ip/ip6tables has been deprecated. Update your scripts to load br_netfilter if you need this.<br />[&nbsp; &nbsp; 2.230000] 8021q: 802.1Q VLAN Support v1.8<br />[&nbsp; &nbsp; 2.250000] jffs2: Flash size not aligned to erasesize, reducing to 2368KiB<br />[&nbsp; &nbsp; 2.270000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x000c0054: 0xffff instead<br />[&nbsp; &nbsp; 2.290000] jffs2: Empty flash at 0x000c0058 ends at 0x000c5074<br />[&nbsp; &nbsp; 2.290000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x000c5074: 0xf8ff instead<br />[&nbsp; &nbsp; 2.310000] jffs2: Empty flash at 0x000c5078 ends at 0x000c51b4<br />[&nbsp; &nbsp; 2.310000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x000c51b4: 0xffff instead<br />[&nbsp; &nbsp; 2.330000] jffs2: Empty flash at 0x000c51b8 ends at 0x000c51d4<br />[&nbsp; &nbsp; 2.330000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x000c51d4: 0xffff instead<br />[&nbsp; &nbsp; 2.340000] jffs2: Empty flash at 0x000c51d8 ends at 0x000c51f4<br />[&nbsp; &nbsp; 2.350000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x000c51f4: 0xffff instead<br />[&nbsp; &nbsp; 2.360000] jffs2: Empty flash at 0x000c51f8 ends at 0x000c5214<br />[&nbsp; &nbsp; 2.370000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x000c5214: 0xffff instead<br />[&nbsp; &nbsp; 2.380000] jffs2: Empty flash at 0x000c5218 ends at 0x000c5234<br />[&nbsp; &nbsp; 2.390000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x000c5234: 0xffff instead<br />[&nbsp; &nbsp; 2.400000] jffs2: Empty flash at 0x000c5238 ends at 0x000c5254<br />[&nbsp; &nbsp; 2.410000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x000c5254: 0xffff instead<br />[&nbsp; &nbsp; 2.420000] jffs2: Empty flash at 0x000c5258 ends at 0x000c5274<br />[&nbsp; &nbsp; 2.430000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x000c5274: 0xffff instead<br />[&nbsp; &nbsp; 2.440000] jffs2: Empty flash at 0x000c5278 ends at 0x000c5294<br />[&nbsp; &nbsp; 2.450000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x000c5294: 0xffff instead<br />[&nbsp; &nbsp; 2.460000] jffs2: Further such events for this erase block will not be printed<br />[&nbsp; &nbsp; 2.470000] jffs2: Empty flash at 0x000c5298 ends at 0x000c52b4<br />[&nbsp; &nbsp; 2.470000] jffs2: Empty flash at 0x000c52b8 ends at 0x000c52d4<br />[&nbsp; &nbsp; 2.480000] jffs2: Empty flash at 0x000c52d8 ends at 0x000c52f4<br />[&nbsp; &nbsp; 2.490000] jffs2: Empty flash at 0x000c52f8 ends at 0x000c5314<br />[&nbsp; &nbsp; 2.500000] jffs2: Empty flash at 0x000c5318 ends at 0x000c5334<br />[&nbsp; &nbsp; 2.510000] jffs2: Empty flash at 0x000c5338 ends at 0x000c5354<br />[&nbsp; &nbsp; 2.520000] jffs2: Empty flash at 0x000c5358 ends at 0x000c5374<br />[&nbsp; &nbsp; 2.530000] jffs2: Empty flash at 0x000c5378 ends at 0x000c5394<br />[&nbsp; &nbsp; 2.540000] jffs2: Empty flash at 0x000c5398 ends at 0x000c53b4<br />[&nbsp; &nbsp; 2.540000] jffs2: Empty flash at 0x000c53b8 ends at 0x000c53d4<br />[&nbsp; &nbsp; 2.550000] jffs2: Empty flash at 0x000c53d8 ends at 0x000c53f4<br />[&nbsp; &nbsp; 2.560000] jffs2: Empty flash at 0x000c53f8 ends at 0x000c5414<br />[&nbsp; &nbsp; 2.570000] jffs2: Empty flash at 0x000c5418 ends at 0x000c5434<br />[&nbsp; &nbsp; 2.580000] jffs2: Empty flash at 0x000c5438 ends at 0x000c5454<br />[&nbsp; &nbsp; 2.590000] jffs2: Empty flash at 0x000c5458 ends at 0x000c5474<br />[&nbsp; &nbsp; 2.600000] jffs2: Empty flash at 0x000c5478 ends at 0x000c5494<br />[&nbsp; &nbsp; 2.600000] jffs2: Empty flash at 0x000c5498 ends at 0x000c54b4<br />[&nbsp; &nbsp; 2.610000] jffs2: Empty flash at 0x000c54b8 ends at 0x000c54d4<br />[&nbsp; &nbsp; 2.620000] jffs2: Empty flash at 0x000c54d8 ends at 0x000c54f4<br />[&nbsp; &nbsp; 2.630000] jffs2: Empty flash at 0x000c54f8 ends at 0x000c5514<br />[&nbsp; &nbsp; 2.640000] jffs2: Empty flash at 0x000c5518 ends at 0x000c5534<br />[&nbsp; &nbsp; 2.650000] jffs2: Empty flash at 0x000c5538 ends at 0x000c6554<br />[&nbsp; &nbsp; 2.660000] jffs2: Empty flash at 0x000c6558 ends at 0x000c65b4<br />[&nbsp; &nbsp; 2.670000] jffs2: Empty flash at 0x000c65b8 ends at 0x000c6614<br />[&nbsp; &nbsp; 2.680000] jffs2: Empty flash at 0x000c6618 ends at 0x000c6654<br />[&nbsp; &nbsp; 2.690000] jffs2: Empty flash at 0x000c6658 ends at 0x000c9674<br />[&nbsp; &nbsp; 2.700000] jffs2: Empty flash at 0x000c9678 ends at 0x000c97b4<br />[&nbsp; &nbsp; 2.710000] jffs2: Empty flash at 0x000c97b8 ends at 0x000c98f4<br />[&nbsp; &nbsp; 2.720000] jffs2: Empty flash at 0x000c98f8 ends at 0x000c9914<br />[&nbsp; &nbsp; 2.720000] jffs2: Empty flash at 0x000c9918 ends at 0x000c9934<br />[&nbsp; &nbsp; 2.730000] jffs2: Empty flash at 0x000c9938 ends at 0x000c9954<br />[&nbsp; &nbsp; 2.740000] jffs2: Empty flash at 0x000c9958 ends at 0x000c9974<br />[&nbsp; &nbsp; 2.750000] jffs2: Empty flash at 0x000c9978 ends at 0x000c9994<br />[&nbsp; &nbsp; 2.760000] jffs2: Empty flash at 0x000c9998 ends at 0x000c9ab4<br />[&nbsp; &nbsp; 2.770000] jffs2: Empty flash at 0x000c9ab8 ends at 0x000c9ad4<br />[&nbsp; &nbsp; 2.780000] jffs2: Empty flash at 0x000c9ad8 ends at 0x000c9af4<br />[&nbsp; &nbsp; 2.780000] jffs2: Empty flash at 0x000c9afc ends at 0x000c9b14<br />[&nbsp; &nbsp; 2.790000] jffs2: Empty flash at 0x000c9b18 ends at 0x000c9b34<br />[&nbsp; &nbsp; 2.810000] jffs2: Empty flash at 0x000c9b38 ends at 0x000ccb54<br />[&nbsp; &nbsp; 2.820000] jffs2: Empty flash at 0x000ccb58 ends at 0x000ccb74<br />[&nbsp; &nbsp; 2.820000] jffs2: Empty flash at 0x000ccb78 ends at 0x000ccb94<br />[&nbsp; &nbsp; 2.830000] jffs2: Empty flash at 0x000ccb98 ends at 0x000ccbb4<br />[&nbsp; &nbsp; 2.840000] jffs2: Empty flash at 0x000ccbb8 ends at 0x000ccbd4<br />[&nbsp; &nbsp; 2.850000] jffs2: Empty flash at 0x000ccbd8 ends at 0x000ccbf4<br />[&nbsp; &nbsp; 2.860000] jffs2: Empty flash at 0x000ccbf8 ends at 0x000ccc14<br />[&nbsp; &nbsp; 2.870000] jffs2: Empty flash at 0x000ccc18 ends at 0x000ccc34<br />[&nbsp; &nbsp; 2.890000] jffs2: Cowardly refusing to erase blocks on filesystem with no valid JFFS2 nodes<br />[&nbsp; &nbsp; 2.900000] jffs2: empty_blocks 36, bad_blocks 0, c-&gt;nr_blocks 37<br />[&nbsp; &nbsp; 2.900000] VFS: Cannot open root device &quot;(null)&quot; or unknown-block(31,4): error -5<br />[&nbsp; &nbsp; 2.910000] Please append a correct &quot;root=&quot; boot option; here are the available partitions:<br />[&nbsp; &nbsp; 2.920000] 1f00&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;192 mtdblock0&nbsp; (driver?)<br />[&nbsp; &nbsp; 2.920000] 1f01&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64 mtdblock1&nbsp; (driver?)<br />[&nbsp; &nbsp; 2.930000] 1f02&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3712 mtdblock2&nbsp; (driver?)<br />[&nbsp; &nbsp; 2.930000] 1f03&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1288 mtdblock3&nbsp; (driver?)<br />[&nbsp; &nbsp; 2.940000] 1f04&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2423 mtdblock4&nbsp; (driver?)<br />[&nbsp; &nbsp; 2.940000] 1f05&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;320 mtdblock5&nbsp; (driver?)<br />[&nbsp; &nbsp; 2.950000] 1f06&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64 mtdblock6&nbsp; (driver?)<br />[&nbsp; &nbsp; 2.950000] 1f07&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64 mtdblock7&nbsp; (driver?)<br />[&nbsp; &nbsp; 2.960000] Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(31,4)<br />[&nbsp; &nbsp; 2.960000] ---[ end Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(31,4)</p>											<p class="post-edited">(Last edited by <strong>lobonse</strong> on 2 Feb 2017, 03:02)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p350929">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						2 Feb 2017, 17:38					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ve also sometimes noticed mmc messages mixed in with the jffs2 messages:</p><p>...<br />[&nbsp; &nbsp; 2.670000] jffs2: Empty flash at 0x00002658 ends at 0x00002694<br />[&nbsp; &nbsp; 2.690000] mmc0: host does not support reading read-only switch, assuming write-enable<br />[&nbsp; &nbsp; 2.690000] mmc0: new SDHC card on SPI<br />[&nbsp; &nbsp; 2.700000] jffs2: Empty flash at 0x00002698 ends at 0x000026b4<br />[&nbsp; &nbsp; 2.710000] jffs2: Empty flash at 0x000026b8 ends at 0x000026d4<br />[&nbsp; &nbsp; 2.720000] jffs2: Empty flash at 0x000026d8 ends at 0x00002714<br />[&nbsp; &nbsp; 2.730000] jffs2: Empty flash at 0x00002718 ends at 0x00002734<br />[&nbsp; &nbsp; 2.730000] jffs2: Empty flash at 0x00002738 ends at 0x00002774<br />[&nbsp; &nbsp; 2.740000] mmcblk0: mmc0:0000 SA08G 7.21 GiB <br />[&nbsp; &nbsp; 2.750000] jffs2: Empty flash at 0x00002778 ends at 0x00002794<br />[&nbsp; &nbsp; 2.760000] jffs2: Empty flash at 0x00002798 ends at 0x000027d4<br />[&nbsp; &nbsp; 2.760000] jffs2: Empty flash at 0x000027d8 ends at 0x00002814<br />[&nbsp; &nbsp; 2.770000] mmcblk0: timed out sending r/w cmd command, card status 0x0<br />[&nbsp; &nbsp; 2.780000] blk_update_request: I/O error, dev mmcblk0, sector 0<br />[&nbsp; &nbsp; 2.780000] Buffer I/O error on dev mmcblk0, logical block 0, async page read<br />[&nbsp; &nbsp; 2.790000] jffs2: Empty flash at 0x00002818 ends at 0x00002834<br />[&nbsp; &nbsp; 2.800000] jffs2: Empty flash at 0x00002838 ends at 0x00002874<br />[&nbsp; &nbsp; 2.810000] jffs2: Empty flash at 0x00002878 ends at 0x000028b4<br />[&nbsp; &nbsp; 2.820000] jffs2: Empty flash at 0x000028b8 ends at 0x000028f4<br />[&nbsp; &nbsp; 2.820000] jffs2: Empty flash at 0x000028f8 ends at 0x00002934<br />[&nbsp; &nbsp; 2.830000] mmcblk0: timed out sending r/w cmd command, card status 0x0<br />[&nbsp; &nbsp; 2.840000] blk_update_request: I/O error, dev mmcblk0, sector 0<br />[&nbsp; &nbsp; 2.840000] Buffer I/O error on dev mmcblk0, logical block 0, async page read<br />[&nbsp; &nbsp; 2.850000]&nbsp; mmcblk0: unable to read partition table<br />[&nbsp; &nbsp; 2.860000] jffs2: Empty flash at 0x00002938 ends at 0x00002974<br />...</p><br /><p>and on another boot:</p><p>[&nbsp; &nbsp; 4.280000] jffs2: Empty flash at 0x000f20d8 ends at 0x000f2114<br />[&nbsp; &nbsp; 4.290000] mmc0: card never left busy state<br />[&nbsp; &nbsp; 4.290000] mmc0: error -145 whilst initialising SD card<br />[&nbsp; &nbsp; 4.300000] jffs2: Empty flash at 0x000f2118 ends at 0x000f2134</p><br /><p>So card is being read, but it seems the system is looking for a jffs2 partition to mount root on? I&#039;m guessing it&#039;s the CS line confusing the flash..?</p>											<p class="post-edited">(Last edited by <strong>lobonse</strong> on 2 Feb 2017, 17:40)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351019">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">Deoptim</div>
					<div class="post-datetime">
						3 Feb 2017, 18:46					</div>
				</div>
				<div class="post-content content">
					<p>Not only CS can confuse flash, also can DI and DO line. MB need pull-up resistors</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351023">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						3 Feb 2017, 20:32					</div>
				</div>
				<div class="post-content content">
					<p>Here&#039;s a picture if it helps. The sd card is an 8gb class 4 from kingston. </p><p><span class="postimg"><img src="https://i.imgur.com/RLveJf1.jpg" alt="https://i.imgur.com/RLveJf1.jpg" /></span></p><p>The card reader has resistors built in, but I don&#039;t know if they are pulling the lines up. The gpio is internal cs1 on gpio0 ( active_low in the code, LED is always on when the sd card access takes place at boot ).</p><p>Voltages at boot:</p><p>CS: 2.48v, drops to .5v when LED lights<br />MISO: 1.3v, 3.05v<br />MOSI: 70mv, 6mv ( ignoring master I guess )<br />CLK: 200mv, 6mv</p><p>That&#039;s a rough measurement, I have no idea what they should be, GND to 3v3 is steady at 3.39v</p>											<p class="post-edited">(Last edited by <strong>lobonse</strong> on 21 Mar 2018, 14:09)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351029">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						3 Feb 2017, 21:21					</div>
				</div>
				<div class="post-content content">
					<p>I tried adding one 10k resistor between each line and 3.3v and the only change was as if there was no sd card in the reader. Just this one line:</p><p>mmc_spi spi0.1: SD/MMC host mmc0, no DMA, no WP, no poweroff</p>											<p class="post-edited">(Last edited by <strong>lobonse</strong> on 3 Feb 2017, 21:21)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351036">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						3 Feb 2017, 22:03					</div>
				</div>
				<div class="post-content content">
					<p>I tried adding all three 10k resistors from MISO MOSI and CS to 3.3V, same result, just the one line as above.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351038">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						3 Feb 2017, 22:35					</div>
				</div>
				<div class="post-content content">
					<p>Slightly different boot, after the single line from previous post:</p><br /><p>[&nbsp; &nbsp;10.170000] jffs2: jffs2_scan_eraseblock(): Node at 0x0000c448 {0x1985, 0xe002, 0x00200044) has invalid CRC 0xa4ef223e (calculated 0x9ca264de)<br />[&nbsp; &nbsp;10.180000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x0000c44c: 0x0020 instead<br />[&nbsp; &nbsp;10.190000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x0000c450: 0xa4ef instead<br />[&nbsp; &nbsp;10.200000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x0000c488: 0x5aa3 instead<br />[&nbsp; &nbsp;10.220000] jffs2: notice: (354) jffs2_build_xattr_subsystem: complete building xattr subsystem, 0 of xdatum (0 unchecked, 0 orphan) and 0 of xref (0 dead, 0 orphan) found.<br />[&nbsp; &nbsp;10.230000] block: attempting to load /tmp/jffs_cfg/upper/etc/config/fstab<br />[&nbsp; &nbsp;10.250000] block: extroot: not configured<br />[&nbsp; &nbsp;10.280000] jffs2: jffs2_scan_eraseblock(): Node at 0x0000c448 {0x1985, 0xe002, 0x00200044) has invalid CRC 0xa4ef223e (calculated 0x9ca264de)<br />[&nbsp; &nbsp;10.290000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x0000c44c: 0x0020 instead<br />[&nbsp; &nbsp;10.300000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x0000c450: 0xa4ef instead<br />[&nbsp; &nbsp;10.310000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x0000c488: 0x5aa3 instead<br />[&nbsp; &nbsp;10.330000] jffs2: notice: (351) jffs2_build_xattr_subsystem: complete building xattr subsystem, 0 of xdatum (0 unchecked, 0 orphan) and 0 of xref (0 dead, 0 orphan) found.<br />[&nbsp; &nbsp;10.560000] block: attempting to load /tmp/jffs_cfg/upper/etc/config/fstab</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351040">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						3 Feb 2017, 22:43					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ve also tried ext3, ext4, fat32 and no partition tables. Card is still alive, I also switched the card reader with another identical one. no difference yet.</p>											<p class="post-edited">(Last edited by <strong>lobonse</strong> on 3 Feb 2017, 22:43)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351043">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						3 Feb 2017, 23:54					</div>
				</div>
				<div class="post-content content">
					<p>This time I tried just 10k pullups on CS, MOSI, no MISO:</p><p>[&nbsp; &nbsp; 2.470000] mmc0: host does not support reading read-only switch, assuming write-enable<br />[&nbsp; &nbsp; 2.480000] mmc0: new SDHC card on SPI<br />[&nbsp; &nbsp; 2.780000] SQUASHFS error: xz decompression failed, data probably corrupt<br />[&nbsp; &nbsp; 2.790000] SQUASHFS error: squashfs_read_data failed to read block 0x6e<br />[&nbsp; &nbsp; 2.980000] SQUASHFS error: xz decompression failed, data probably corrupt<br />[&nbsp; &nbsp; 2.980000] SQUASHFS error: squashfs_read_data failed to read block 0x6e<br />[&nbsp; &nbsp; 2.990000] mmcblk0: mmc0:0000 SA08G 7.21 GiB <br />[&nbsp; &nbsp; 3.000000]&nbsp; mmcblk0: p1<br />[&nbsp; &nbsp; 3.010000] Starting init: /etc/preinit exists but couldn&#039;t execute it (error -5)<br />[&nbsp; &nbsp; 3.070000] SQUASHFS error: xz decompression failed, data probably corrupt<br />[&nbsp; &nbsp; 3.080000] SQUASHFS error: squashfs_read_data failed to read block 0x1525c2<br />[&nbsp; &nbsp; 3.080000] SQUASHFS error: Unable to read fragment cache entry [1525c2]<br />[&nbsp; &nbsp; 3.090000] SQUASHFS error: Unable to read page, block 1525c2, size 12a68<br />[&nbsp; &nbsp; 3.100000] SQUASHFS error: Unable to read fragment cache entry [1525c2]<br />[&nbsp; &nbsp; 3.100000] SQUASHFS error: Unable to read page, block 1525c2, size 12a68<br />[&nbsp; &nbsp; 3.110000] SQUASHFS error: Unable to read fragment cache entry [1525c2]<br />[&nbsp; &nbsp; 3.120000] SQUASHFS error: Unable to read page, block 1525c2, size 12a68<br />[&nbsp; &nbsp; 3.130000] SQUASHFS error: Unable to read fragment cache entry [1525c2]<br />[&nbsp; &nbsp; 3.130000] SQUASHFS error: Unable to read page, block 1525c2, size 12a68<br />[&nbsp; &nbsp; 3.140000] Starting init: /sbin/init exists but couldn&#039;t execute it (error -5)<br />[&nbsp; &nbsp; 3.330000] SQUASHFS error: xz decompression failed, data probably corrupt<br />[&nbsp; &nbsp; 3.340000] SQUASHFS error: squashfs_read_data failed to read block 0x6e<br />[&nbsp; &nbsp; 3.340000] Starting init: /bin/sh exists but couldn&#039;t execute it (error -5)<br />[&nbsp; &nbsp; 3.350000] Kernel panic - not syncing: No working init found.&nbsp; Try passing init= option to kernel. See Linux Documentation/init.txt for guidance.<br />[&nbsp; &nbsp; 3.350000] ---[ end Kernel panic - not syncing: No working init found.&nbsp; Try passing init= option to kernel. See Linux Documentation/init.txt for guidance.<br />[&nbsp; &nbsp;82.510000] random: nonblocking pool is initialized</p><p>Then rebooted:<br />...<br />[&nbsp; &nbsp; 2.350000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x00000024: 0x2000 instead<br />[&nbsp; &nbsp; 2.360000] jffs2: Further such events for this erase block will not be printed<br />[&nbsp; &nbsp; 2.370000] jffs2: Empty flash at 0x00000038 ends at 0x00000040<br />[&nbsp; &nbsp; 2.390000] jffs2: Old JFFS2 bitmask found at 0x00005798<br />[&nbsp; &nbsp; 2.400000] jffs2: You cannot use older JFFS2 filesystems with newer kernels<br />[&nbsp; &nbsp; 2.430000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x00010000: 0x9ed6 instead<br />...<br />[&nbsp; &nbsp; 2.520000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x00010024: 0x258e instead<br />[&nbsp; &nbsp; 2.530000] jffs2: Further such events for this erase block will not be printed<br />[&nbsp; &nbsp; 2.560000] jffs2: Old JFFS2 bitmask found at 0x00015200<br />[&nbsp; &nbsp; 2.570000] jffs2: You cannot use older JFFS2 filesystems with newer kernels<br />[&nbsp; &nbsp; 2.600000] jffs2: jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x00020000: 0xe0e2 instead<br />...plus many more &quot;jffs2 scan_eraseblock&quot; type messages</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351050">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						4 Feb 2017, 02:58					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m wondering if the cs line is the problem, would TP29 (GPIO11) which is to the left of SoC be suitable to use? I wonder this because there are no components such as resistors between it and the SoC.</p>											<p class="post-edited">(Last edited by <strong>lobonse</strong> on 4 Feb 2017, 02:58)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351080">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">Deoptim</div>
					<div class="post-datetime">
						4 Feb 2017, 15:59					</div>
				</div>
				<div class="post-content content">
					<p><strong>lobonse</strong><br />You told that you use WPS (GPIO 0) as internal CS.<br />Do you patch your profile as in this instruction &quot;<a href="https://wiki.openwrt.org/toh/tp-link/tl-mr3420/deep.mmc.hack#second_way_using_internal_cs1">Second way, using Internal CS1</a>&quot;?<br />i.e. do you add this line:<br /></p><div class="codebox"><pre><code>    /* Enabling internal CS1, disable GPIO 0 */
    ath79_gpio_function_enable(AR724X_GPIO_FUNC_SPI_CS_EN1);</code></pre></div><p>to &quot;static void __init dir_600_a1_setup(void)&quot; function?</p>											<p class="post-edited">(Last edited by <strong>Deoptim</strong> on 4 Feb 2017, 16:02)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351088">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						4 Feb 2017, 16:54					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Deoptim wrote:</cite><blockquote><p><strong>lobonse</strong></p><p>i.e. do you add this line:<br /></p><div class="codebox"><pre><code>    /* Enabling internal CS1, disable GPIO 0 */
    ath79_gpio_function_enable(AR724X_GPIO_FUNC_SPI_CS_EN1);</code></pre></div><p>to &quot;static void __init dir_600_a1_setup(void)&quot; function?</p></blockquote></div><p>Yes, I followed the deep mmc mod. Here&#039;s the file mach-dir-600-a1.c:</p><div class="codebox"><pre><code>/*
 *  D-Link DIR-600 rev. A1 board support
 *
 *  Copyright (C) 2010-2012 Gabor Juhos &lt;juhosg@openwrt.org&gt;
 *  Copyright (C) 2012 Vadim Girlin &lt;vadimgirlin@gmail.com&gt;
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License version 2 as published
 *  by the Free Software Foundation.
 */

#include &lt;linux/mmc/host.h&gt;
#include &lt;linux/spi/spi.h&gt;
#include &lt;linux/spi/mmc_spi.h&gt;

#include &lt;asm/mach-ath79/ath79.h&gt;
#include &lt;asm/mach-ath79/ar71xx_regs.h&gt;

#include &quot;common.h&quot;
#include &quot;dev-ap9x-pci.h&quot;
#include &quot;dev-eth.h&quot;
#include &quot;dev-gpio-buttons.h&quot;
#include &quot;dev-leds-gpio.h&quot;
#include &quot;dev-spi.h&quot;
#include &quot;dev-m25p80.h&quot;
#include &quot;machtypes.h&quot;
#include &quot;nvram.h&quot;

#define DIR_600_A1_GPIO_LED_WPS            0
#define DIR_600_A1_GPIO_LED_POWER_AMBER        1
#define DIR_600_A1_GPIO_LED_POWER_GREEN        6
#define DIR_600_A1_GPIO_LED_LAN1        13
#define DIR_600_A1_GPIO_LED_LAN2        14
#define DIR_600_A1_GPIO_LED_LAN3        15
#define DIR_600_A1_GPIO_LED_LAN4        16
#define DIR_600_A1_GPIO_LED_WAN_AMBER        7
#define DIR_600_A1_GPIO_LED_WAN_GREEN        17

#define DIR_600_A1_GPIO_BTN_RESET        8
#define DIR_600_A1_GPIO_BTN_WPS            12

#define DIR_600_A1_KEYS_POLL_INTERVAL        20    /* msecs */
#define DIR_600_A1_KEYS_DEBOUNCE_INTERVAL (3 * DIR_600_A1_KEYS_POLL_INTERVAL)

#define DIR_600_A1_NVRAM_ADDR    0x1f030000
#define DIR_600_A1_NVRAM_SIZE    0x10000

static struct gpio_led dir_600_a1_leds_gpio[] __initdata = {
    {
        .name        = &quot;d-link:green:power&quot;,
        .gpio        = DIR_600_A1_GPIO_LED_POWER_GREEN,
    }, {
        .name        = &quot;d-link:amber:power&quot;,
        .gpio        = DIR_600_A1_GPIO_LED_POWER_AMBER,
    }, {
        .name        = &quot;d-link:amber:wan&quot;,
        .gpio        = DIR_600_A1_GPIO_LED_WAN_AMBER,
    }, {
        .name        = &quot;d-link:green:wan&quot;,
        .gpio        = DIR_600_A1_GPIO_LED_WAN_GREEN,
        .active_low    = 1,
    }, {
        .name        = &quot;d-link:green:lan1&quot;,
        .gpio        = DIR_600_A1_GPIO_LED_LAN1,
        .active_low    = 1,
    }, {
        .name        = &quot;d-link:green:lan2&quot;,
        .gpio        = DIR_600_A1_GPIO_LED_LAN2,
        .active_low    = 1,
    }, {
        .name        = &quot;d-link:green:lan3&quot;,
        .gpio        = DIR_600_A1_GPIO_LED_LAN3,
        .active_low    = 1,
    }, {
        .name        = &quot;d-link:green:lan4&quot;,
        .gpio        = DIR_600_A1_GPIO_LED_LAN4,
        .active_low    = 1,
    }, {
        .name        = &quot;d-link:blue:wps&quot;,
        .gpio        = DIR_600_A1_GPIO_LED_WPS,
        .active_low    = 1,
    }
};

static struct gpio_keys_button dir_600_a1_gpio_keys[] __initdata = {
    {
        .desc        = &quot;reset&quot;,
        .type        = EV_KEY,
        .code        = KEY_RESTART,
        .debounce_interval = DIR_600_A1_KEYS_DEBOUNCE_INTERVAL,
        .gpio        = DIR_600_A1_GPIO_BTN_RESET,
        .active_low    = 1,
    }, {
        .desc        = &quot;wps&quot;,
        .type        = EV_KEY,
        .code        = KEY_WPS_BUTTON,
        .debounce_interval = DIR_600_A1_KEYS_DEBOUNCE_INTERVAL,
        .gpio        = DIR_600_A1_GPIO_BTN_WPS,
        .active_low    = 1,
    }
};

static struct mmc_spi_platform_data ath79_mmc_data = {
//    .detect_delay = 100, /* msecs */
    .ocr_mask    = MMC_VDD_32_33 | MMC_VDD_33_34,
};

static struct ath79_spi_controller_data ath79_spi1_cdata = {
//    .cs_type = ATH79_SPI_CS_TYPE_GPIO,
    .cs_type = ATH79_SPI_CS_TYPE_INTERNAL,
    .cs_line = 1,
//    .cs_line = DIR_600_A1_GPIO_CS1_MMC,
};

static struct spi_board_info ath79_spi_info[] = {
    {
        .bus_num    = 0,
        .chip_select    = 1,
        .max_speed_hz    = 25000000,
        .modalias    = &quot;mmc_spi&quot;,
        .platform_data    = &amp;ath79_mmc_data,
        .controller_data = &amp;ath79_spi1_cdata,
    }
};

static void __init dir_600_a1_setup(void)
{
    const char *nvram = (char *) KSEG1ADDR(DIR_600_A1_NVRAM_ADDR);
    u8 *ee = (u8 *) KSEG1ADDR(0x1fff1000);
    u8 mac_buff[6];
    u8 *mac = NULL;

    if (ath79_nvram_parse_mac_addr(nvram, DIR_600_A1_NVRAM_SIZE,
                       &quot;lan_mac=&quot;, mac_buff) == 0) {
        ath79_init_mac(ath79_eth0_data.mac_addr, mac_buff, 0);
        ath79_init_mac(ath79_eth1_data.mac_addr, mac_buff, 1);
        mac = mac_buff;
    }

    /* Enabling internal CS1, disable GPIO 0 */
    ath79_gpio_function_enable(AR724X_GPIO_FUNC_SPI_CS_EN1);

    ath79_register_m25p80(NULL);

    ath79_gpio_function_disable(AR724X_GPIO_FUNC_ETH_SWITCH_LED0_EN |
                    AR724X_GPIO_FUNC_ETH_SWITCH_LED1_EN |
                    AR724X_GPIO_FUNC_ETH_SWITCH_LED2_EN |
                    AR724X_GPIO_FUNC_ETH_SWITCH_LED3_EN |
                    AR724X_GPIO_FUNC_ETH_SWITCH_LED4_EN);

    ath79_register_leds_gpio(-1, ARRAY_SIZE(dir_600_a1_leds_gpio),
                 dir_600_a1_leds_gpio);

    ath79_register_gpio_keys_polled(-1, DIR_600_A1_KEYS_POLL_INTERVAL,
                    ARRAY_SIZE(dir_600_a1_gpio_keys),
                    dir_600_a1_gpio_keys);

    ath79_init_mac(ath79_eth0_data.mac_addr, mac, 0);
    ath79_init_mac(ath79_eth1_data.mac_addr, mac, 1);

    ath79_register_mdio(0, 0x0);

    /* LAN ports */
    ath79_register_eth(1);

    /* WAN port */
    ath79_register_eth(0);

    ap91_pci_init(ee, mac);

    spi_register_board_info(ath79_spi_info,
                ARRAY_SIZE(ath79_spi_info));
}

MIPS_MACHINE(ATH79_MACH_DIR_600_A1, &quot;DIR-600-A1&quot;, &quot;D-Link DIR-600 rev. A1&quot;,
         dir_600_a1_setup);

static void __init dir_615_e1_setup(void)
{
    dir_600_a1_setup();
}

MIPS_MACHINE(ATH79_MACH_DIR_615_E1, &quot;DIR-615-E1&quot;, &quot;D-Link DIR-615 rev. E1&quot;,
         dir_615_e1_setup);

static void __init dir_615_e4_setup(void)
{
    dir_600_a1_setup();
    ap9x_pci_setup_wmac_led_pin(0, 1);
}

MIPS_MACHINE(ATH79_MACH_DIR_615_E4, &quot;DIR-615-E4&quot;, &quot;D-Link DIR-615 rev. E4&quot;,
         dir_615_e4_setup);</code></pre></div>											<p class="post-edited">(Last edited by <strong>lobonse</strong> on 4 Feb 2017, 17:01)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351125">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						5 Feb 2017, 03:16					</div>
				</div>
				<div class="post-content content">
					<p>From Deep MMC Mod:<br /></p><div class="quotebox"><blockquote><p>Keep in mind, very often the unused GPIOs a pulled-down to the ground or pulled-up to the power bus via resistor - this may affect on detection of SD memory cards.</p></blockquote></div><p>Would a 220 ohm resistor on the WPS led negative side pulling it low affect the cs line?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351144">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">Deoptim</div>
					<div class="post-datetime">
						5 Feb 2017, 16:13					</div>
				</div>
				<div class="post-content content">
					<p>It could be anything.<br />When SPI0.0 bus is enabled (CS must be low when active) then SPI0.1 must be disabled (CS must be high when deactive) or contrariwise.<br />On hardware level, we do not touch CS0, but we create CS1 - when device read/detect the flash (SPI0,0) CS1 must be ~3.-3.3V (not less); when device read/detect the SD (SPI0,1) CS1 must be ~0.-1.V (not more).<br />The same applies to other lines: DI, DO and SCLK.<br />Ideal signal must be: ~ 3.-3.3V when logic is high and ~ 0.-1.V when logic is low.</p><p>In theory, when we connect to our balanced SPI0.0 bus a new other device, we can break this balance.<br />Therefore we need these pull-up resistors on the common signals DI, DO and SCLK.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351152">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						5 Feb 2017, 17:19					</div>
				</div>
				<div class="post-content content">
					<p>Ok, well, thanks for your help.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351156">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						5 Feb 2017, 17:55					</div>
				</div>
				<div class="post-content content">
					<p>One thing ( out of many clearly ) that I don&#039;t understand is why there is no conflict in these two parts:</p><p>From dev-m25p80.c:</p><div class="codebox"><pre><code>static struct spi_board_info ath79_spi_info[] = {
    {
        .bus_num    = 0,
        .chip_select    = 0,
        .max_speed_hz   = 25000000,
        .modalias   = &quot;m25p80&quot;,
        .controller_data = &amp;ath79_spi0_cdata,
    },
    {
        .bus_num    = 0,
        .chip_select    = 1,
        .max_speed_hz   = 25000000,
        .modalias   = &quot;m25p80&quot;,
        .controller_data = &amp;ath79_spi1_cdata,
    }
};</code></pre></div><p>From mach-dir-600-a1.c:</p><div class="codebox"><pre><code>static struct spi_board_info ath79_spi_info[] = {
    {
        .bus_num    = 0,
        .chip_select    = 1,
        .max_speed_hz   = 25000000,
        .modalias   = &quot;mmc_spi&quot;,
        .platform_data  = &amp;ath79_mmc_data,
        .controller_data = &amp;ath79_spi1_cdata,
    }
};</code></pre></div><p>From what I can see the line .platform_data is a reference to &quot;MMC_VDD_32_33 | MMC_VDD_33_34&quot; ie a voltage measurement taken to confirm the proper voltage of the card during init I guess. So the rest is identical, apart from the aliases. Why no conflict?</p>											<p class="post-edited">(Last edited by <strong>lobonse</strong> on 5 Feb 2017, 18:18)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351160">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">Deoptim</div>
					<div class="post-datetime">
						5 Feb 2017, 18:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>lobonse wrote:</cite><blockquote><p>One thing ( out of many clearly ) that I don&#039;t understand is why there is no conflict in these two parts:<br />...<br />Why no conflict?</p></blockquote></div><p>Because in the function &quot;<em>void __init ath79 register m25p80</em>&quot; we call only one part &quot;<em>ath79_register_spi(&amp;ath79_spi_data, ath79_spi_info, <strong>1</strong>);</em>&quot; of the <em>ath79_spi_info[]</em> array enclosed in curly braces.</p><p>For example, in function &quot;<em>void __init ath79_register_m25p80_multi</em>&quot; we use two elements of array &quot;<em>ath79_register_spi(&amp;ath79_spi_data, ath79_spi_info, <strong>2</strong>);</em>&quot;</p><p>By the way, you can patch the kernel in another way.<br /><a href="http://www.right.com.cn/Forum/thread-136884-1-1.html">http://www.right.com.cn/Forum/thread-136884-1-1.html</a><br />(where we change only <em>dev-m25p80.c</em> driver)</p>											<p class="post-edited">(Last edited by <strong>Deoptim</strong> on 5 Feb 2017, 18:31)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351161">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">lobonse</div>
					<div class="post-datetime">
						5 Feb 2017, 18:33					</div>
				</div>
				<div class="post-content content">
					<p>Another concern I have is the WPS LED being lit constantly. If it is active low, this would indicate that the CS line is constantly being pulled low, no? I am wondering if I have the wire soldered to the wrong place. It&#039;s on the negative post of the LED, after the on board resistor:</p><p><span class="postimg"><img src="https://i.imgur.com/JeplxuL.jpg" alt="https://i.imgur.com/JeplxuL.jpg" /></span></p>											<p class="post-edited">(Last edited by <strong>lobonse</strong> on 21 Mar 2018, 14:07)</p>
									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 3</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=54077&amp;p=2.html">2</a></li><li><a href="viewtopic.php%3Fid=54077&amp;p=3.html">3</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0.001 -->

</body>
</html>