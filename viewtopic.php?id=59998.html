<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> dnsmasq redirects</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 30 Apr 2018 and 6 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=59998&amp;p=2.html">2</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p294008">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">frietpan</div>
					<div class="post-datetime">
						30 Sep 2015, 01:46					</div>
				</div>
				<div class="post-content content">
					<p>i now use </p><p>&nbsp; &nbsp; &nbsp; &nbsp; option address &#039;/#/10.0.0.2&#039;</p><p>to redirect every IP adrress to 10.0.0.2</p><p>But that still does not reach my goal</p><p>This ends in a &#039;page cannot be loaded&#039;&nbsp; message and does not seem to load the page hosted on 10.0.0.2</p><p>I would be nicer to point everyone to <a href="http://book.shelf">http://book.shelf</a><br />Can that also be accomplished like this?</p><p>I experimented a bit but cant get it working yet.&nbsp; &nbsp;</p><p>When i manually go to <a href="http://book.shelf">http://book.shelf</a> then my http page load fine. so that part works.</p><p>But when a new user connects to the wifi and does not know about htt.p://book.shelf then nothing seems to work. so i try to capture all and redirect to that url</p><p>i tried things like</p><p>&nbsp; &nbsp; &nbsp; &nbsp; option address &#039;/#/book.shelf&#039;</p><p>but that didn&#039;t seem to work</p><br /><p>For some reason I don&#039;t understand manpages anymore</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p294027">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">eduperez</div>
					<div class="post-datetime">
						30 Sep 2015, 08:45					</div>
				</div>
				<div class="post-content content">
					<p>Perhaps what you need is a &quot;captive portal&quot;?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p294232">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">frietpan</div>
					<div class="post-datetime">
						1 Oct 2015, 22:21					</div>
				</div>
				<div class="post-content content">
					<p>Hi Eduperez,</p><p>Yes i started with NoDogSplash but for some reason I couldn&#039;t get it working when using WWAN/WLAN. An then someone suggested to try firewall / dnsmasq :-) </p><p>When using WWAN It all works until you boot the router where it can&#039;t connect to the SSID (ie a different location)&nbsp; Then several things go wrong. and you end up without any wifi at all (locked out)&nbsp; And when you finally get back in with a CAT cable connection then it&#039;s a struggle to get it all working again.... NoDogSplash then also seems to loose some config(?) Anyhow..&nbsp; When the Wifi stuff is fixed then nodogsplash messes up.</p><p>When you get that finally working it all works until the next time you boot where OpenWRT cannot find the SSID and all the shit start again...&nbsp; :-)&nbsp; So since i don&#039;t need the authentication stuff the dnsmask / firewall config seems to make more sense then staying with nodogsplash since it will break to easy... </p><p>The nodogsplash documentation seems to be talking about 2 different configurations too. Anyway&#039;s it&#039;s not clear to me... And since more people seem to have issues and walk away from it there is a bit of a gap...&nbsp; <br />I&#039;m not giving up, but it&#039;s hard to get the right info.&nbsp; </p><p>I did get a lot of hints, but i still lack understanding what needs to be done. and in what order. </p><p>It would be nice if someone could explain the order of steps that happen.</p><p>browser connects to webserver,&nbsp; what happens inbetween? </p><p>fire wall<br />dnsmasq <br />hostfile<br />uhttpd</p><p>Is that the correct order? Are there other steps inbetween?</p><p>Thing is this. If i understand how to do this manually then I also will understand nodogsplash better.<br />When trying to understand nodogsplash i&#039;m missing the basics and with nodogsplash documentation adding more confusion to the mix i&#039;m just wasting time. And i will never understand why it goes wrong</p><p>Also NoDogSplash redirects to a different port, whereas i prefer to have the page at port 80<br />And if possible redirecting all http requests on any IP to <a href="http://book.shelf">http://book.shelf</a></p><p>My current situation<br />uhttpd listens on 10.0.0.2<br />Hostname: Book<br />domainname: shelf</p><p>And <a href="http://book.shelf">http://book.shelf</a> nicely presents the index.html</p><p>But how do i point &#039;ANY&#039; URL to <a href="http://book.shelf">http://book.shelf</a>&nbsp; (not just to <a href="http://10.0.0.2">http://10.0.0.2</a>)&nbsp; </p><p>The goal is to present a hotspot that immediately loads the correct page without a user interaction.</p><p>Nodogsplash needs at least 1 click and it redirects to an ip:port&nbsp; and not to a URL that&#039;s self explaining.</p><p>Is there a wiki page that already explains the sequence? I didn&#039;t find one but maybe I did not use the best search words.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p310613">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">Max Hopper</div>
					<div class="post-datetime">
						7 Feb 2016, 17:34					</div>
				</div>
				<div class="post-content content">
					<p>Hoi, frietpan.<br />Ben je nog steeds op zoek een <strong>captive portaal</strong> oplossing?</p><p>Ik heb met CoovaChilli een gratis (sociaal) AAA dienst opgericht met aparte SSIDs (prive en openbaar).</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p310898">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">frietpan</div>
					<div class="post-datetime">
						10 Feb 2016, 07:19					</div>
				</div>
				<div class="post-content content">
					<p>Hoi Max,</p><p>Ja ik moet er nog eens naar kijken, Misschien dat ik het nu beter snap nu ik een en ander heb bijgeleerd<br />NoDogSplash leek me simpel maar bleek niet gemakkelijk te zijn. Misschien omdat ik net iets anders in gedachten had dan standaard gebruik.<br />Coova daarintegen lijkt me net wat te complex. </p><p>Een AAA dienst is dat met authentication?</p><p>Ik wil een open pagina draaien vanaf te SD zonder verder netwerk te delen dus Authentication&nbsp; lijkt in mijn geval niet nodig. Al kan ik wel andere dingen dingen bedenken waar het mooi zou zijn. Misschien als mijn plan wat uit is gegroeid dat het dan haalbaar word om als hotspot te fungeren.</p><p>Ik ga het de komende dagen eens bekijken.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p313845">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">ralph1974</div>
					<div class="post-datetime">
						7 Mar 2016, 00:36					</div>
				</div>
				<div class="post-content content">
					<p>Hoi Max,</p><p>Wat is de naam van je gratis dienst? Ik ben wel benieuwd....</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p313848">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">augustus_meyer</div>
					<div class="post-datetime">
						7 Mar 2016, 01:59					</div>
				</div>
				<div class="post-content content">
					<p>i tried things like</p><p>&nbsp; &nbsp; &nbsp; &nbsp; option address &#039;/#/book.shelf&#039;</p><p>but that didn&#039;t seem to work</p><p>Should work, assuming, the clients also get their DNS from your dnsmasq. <br />So your dnsmasq must provide DHCP, too. And, to avoid any bypass, use iptables to redirect port 53 to your dnsmasq.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p313972">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">frietpan</div>
					<div class="post-datetime">
						8 Mar 2016, 05:55					</div>
				</div>
				<div class="post-content content">
					<p>Yea i have tried that too... i thought it was me just misunderstanding the documentation. </p><p>Unfortunately i havn&#039;t found any other explanation that worked, I slowly gained some more knowledge about OpenWRT in general so maybe now i can figure it out.&nbsp; </p><p>The nodogsplash wikipage had some updates, i&#039;ll have a look at it soon.<br />But the dnsmasq wikipage still doens&#039;t have any new / better info.&nbsp; &nbsp;So i have the feeling i better spend my time on other stuff for now. Unless someone can give me a an explanation how this is done. Once I understand it then i might even be able to contribute to the wiki, but at this point that&#039;s not an option yet.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p313988">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">augustus_meyer</div>
					<div class="post-datetime">
						8 Mar 2016, 11:35					</div>
				</div>
				<div class="post-content content">
					<p>You also have to make shure, that uhttpd works as expected, in case it is accessed to serve <a href="http://anydomain.com/anyurl.">http://anydomain.com/anyurl.</a><br />As I have such setup working, you should succeed as well. Assuming, your book.shelf is hosted on openwrt box.<br />(Otherwise, it might be more complex).<br />No need for nodogsplash.</p><p>root@OpenWrt:/www# cat index.html<br />&lt;html&gt;<br />&lt;head&gt;<br />&lt;/head&gt;<br />&lt;body&gt;<br />&lt;script type=&quot;text/javascript&quot;&gt;<br />window.location=&#039;http://book.shelf&#039;;<br />&lt;/script&gt;<br />&lt;/body&gt;<br />&lt;/html&gt;</p>											<p class="post-edited">(Last edited by <strong>augustus_meyer</strong> on 8 Mar 2016, 14:10)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p314139">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">frietpan</div>
					<div class="post-datetime">
						9 Mar 2016, 15:57					</div>
				</div>
				<div class="post-content content">
					<p>Yes http worked fine i already have a webpage running, all i need is a working redirect on dns level<br />the webserver runs on 10.0.0.2 <br />if i browse to <a href="http://10.0.0.2">http://10.0.0.2</a> then my page loads just fine</p><p>the hostname of the router is book<br />the domain name is shelf<br />so <a href="http://book.shelf">http://book.shelf</a> already works</p><p>what i try to accomplish is that if anyone connects to wifi then <a href="http://book.shelf">http://book.shelf</a> should be loaded as soon as they open a browser and try to connect to anything.&nbsp; &nbsp;Just like a portal does.</p><p>There is no WAN connection to the outside only a OpenWrt box that hosts a wifi webpage on a stick.<br />And since there is no outside world then the user does not have a google or anything to start with, so somehow i need to catch a dns request to &#039;whatever homepage a use uses&#039; and direct that wildcard to <a href="http://book.shelf">http://book.shelf</a></p><p>And that is the big question...&nbsp; how does a portal like nodog do this?</p><p>now i still need to tell people to type <a href="http://book.shelf">http://book.shelf</a> or <a href="http://look.here">http://look.here</a> whatever the box is used for.<br />if this is done by the box itself that would be much better.</p><p>Ans the more simple the means to do this the better. But the wiki doesn&#039;t explain how to do this yet. or at least i don&#039;t see it yet.</p>											<p class="post-edited">(Last edited by <strong>frietpan</strong> on 9 Mar 2016, 16:02)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p314150">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">cmsigler</div>
					<div class="post-datetime">
						9 Mar 2016, 17:17					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>I&#039;m not a proxy expert, but don&#039;t you need to use a web proxy?</p><p><a href="https://wiki.openwrt.org/doc/howto/proxy.overview">https://wiki.openwrt.org/doc/howto/proxy.overview</a></p><p>tinyproxy may do what you need but I&#039;m not sure if it can be configured to do precisely what you want.&nbsp; It may be worth investigating....&nbsp; HTH.</p><p>Clemmitt</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p314217">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">frietpan</div>
					<div class="post-datetime">
						10 Mar 2016, 04:12					</div>
				</div>
				<div class="post-content content">
					<p>Thank you!&nbsp; Hmm indeed!&nbsp; It redirects to IP not to domain name <br />i&#039;ll have a look is there is something like a dest_url</p><p>Thanks again. If it points to 10.0.0.2 then i&#039;m half way there.</p><p>And i then can doe a html redirect to itself i guess...?<br />I&#039;ll give it a go it looks like this is getting me there!!!</p><p>If this works then i&#039;ll send you a golden router award!! :-)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p314236">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">augustus_meyer</div>
					<div class="post-datetime">
						10 Mar 2016, 11:18					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>frietpan wrote:</cite><blockquote><p> <br />i&#039;ll have a look is there is something like a dest_url</p></blockquote></div><p>No need. You can also use the above script like<br />window.location=&#039;http://book.shelf/welcome.html&#039;;<br />And then do everything on your book.shelf local domain.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p314239">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">Max Hopper</div>
					<div class="post-datetime">
						10 Mar 2016, 11:55					</div>
				</div>
				<div class="post-content content">
					<p>@frietpan - I have this requirement achieved with DNSmasq directives and a one-liner PHP script forcing a client agent to redirect (maar ik zit enkele weken niet thuis).</p><p>@ralph1974 - all AAA providers must offer a no-cost subscription if they use Coova Chilli: Cloudtrax, purple-wifi, HotspotSystems and Chillifire (my AAA service) are but a few.</p><p>HTH</p><p><strong>EDIT</strong>: corrected names of AAA providers</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p314258">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">frietpan</div>
					<div class="post-datetime">
						10 Mar 2016, 16:22					</div>
				</div>
				<div class="post-content content">
					<p>O I see, so thats the java script way of URL redirect.</p><p>Ok I now should have enough options to work with. <br />i&#039;m still interested in the the option how to do this with dnsmasq that way I could do without installing tinyproxy.</p><p>Would be awesome if someone could add that option to the dnsmasq wikipage.&nbsp; I have come across a few people who have tried to do the same but probably also couldn&#039;t get it to work since.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p314262">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">augustus_meyer</div>
					<div class="post-datetime">
						10 Mar 2016, 16:41					</div>
				</div>
				<div class="post-content content">
					<p>You always need some type of webserver for this. As the DNS stuff only takes care of directing the (random) URL-)traffic to book.shelf, but then what ?<br />webserver has to pick up the (random) URL and do something with it: to send YOUR html back to the browser.<br />You have to understand, that there are 2 levels involved: DNS AND http.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p314548">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">frietpan</div>
					<div class="post-datetime">
						12 Mar 2016, 18:05					</div>
				</div>
				<div class="post-content content">
					<p>Thanks Augustus,<br />Right now I&#039;m using the same http server that the OpenWrt gui runs on. Not sure if this is the smartest option but it uses the least resources</p><p>If the method that max describes works (with dnsmasq) that would be ideal since dnsmask is already installed<br />I just installed tiny proxy and I will look how this works later today.<br />I now see why I need http&nbsp; redirect, all this time I expected that a DNS could also be given a URL somehow (instead of an IP) but that doesn&#039;t seem to be the case. Although I still don&#039;t know why this is.&nbsp; Is this perhaps security related?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p314551">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">augustus_meyer</div>
					<div class="post-datetime">
						12 Mar 2016, 18:33					</div>
				</div>
				<div class="post-content content">
					<p>No. The trick with option address &#039;/#/book.shelf&#039;<br />forces dnsmasq to resolve all domain names to IP of book.shell. Which is your openwrt. <br />So the browser wants to go to anydomain.com, but receives the IP of book.shelf and directs the http-request to this IP.<br />Which is your openwrt.<br />Then a webserver must pick up the http-request (GET) and respond to it.<br />Standard uhttpd does it, and starts index.html. Which then does the rest.<br />(To be on very safe side, you might add<br />option error_page /www/index.html <br />to /etc/config/uhttpd).<br />For this to work, dnsmasq MUST be the dns-server for the browser !</p><p>You can also use a transparent proxy to have same effect, but more complicated.</p><p>DNS is done first by the browser, to find the IP of the destination (assuming, no explicit proxy specifid).<br />Has nothing to do with the http-stuff like URL. Simply a lower level.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p314839">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">frietpan</div>
					<div class="post-datetime">
						15 Mar 2016, 02:18					</div>
				</div>
				<div class="post-content content">
					<p>I made a fresh start with another box. It&#039;s not working yet.</p><p>here is what i have so far:</p><p>fstab:<br /></p><div class="codebox"><pre><code>config global
    option anon_swap &#039;0&#039;
    option anon_mount &#039;0&#039;
    option auto_swap &#039;1&#039;
    option auto_mount &#039;1&#039;
    option delay_root &#039;5&#039;
    option check_fs &#039;0&#039;

config mount
    option target &#039;/mnt/sda1&#039;
    option uuid &#039;ed59-a201&#039;
    option enabled &#039;1&#039;</code></pre></div><p>on the USB is a folder /www&nbsp; and it contains /index.html</p><br /><p>uhttpd:<br /></p><div class="codebox"><pre><code>config uhttpd &#039;main&#039;
    list listen_http &#039;192.168.251.1:80&#039;
    list listen_https &#039;192.168.251.1:443&#039;
    option redirect_https &#039;1&#039;
    option home &#039;/www&#039;
    option rfc1918_filter &#039;1&#039;
    option max_requests &#039;3&#039;
    option max_connections &#039;100&#039;
    option cert &#039;/etc/uhttpd.crt&#039;
    option key &#039;/etc/uhttpd.key&#039;
    option cgi_prefix &#039;/cgi-bin&#039;
    option script_timeout &#039;60&#039;
    option network_timeout &#039;30&#039;
    option http_keepalive &#039;20&#039;
    option tcp_keepalive &#039;1&#039;
    option ubus_prefix &#039;/ubus&#039;

config cert &#039;px5g&#039;
    option days &#039;730&#039;
    option bits &#039;1024&#039;
    option country &#039;ZZ&#039;
    option state &#039;Somewhere&#039;
    option location &#039;Uknown&#039;
    option commonname &#039;OpenWrt&#039;

config uhttpd &#039;portal&#039;
    list listen_http &#039;192.168.251.252:80&#039;
    list listen_https &#039;192.168.251.252:433&#039;
    option home &#039;mnt/sda1/www&#039;
    option rfc1918_filter &#039;1&#039;
    option max_requests &#039;3&#039;
    option max_connections &#039;100&#039;
    option script_timeout &#039;60&#039;
    option network_timeout &#039;30&#039;
    option http_keepalive &#039;20&#039;
    option tcp_keepalive &#039;1&#039;</code></pre></div><p>I used the &#039;new style&#039; instead of &#039;alias&#039;</p><p>dhcp:<br /></p><div class="codebox"><pre><code>config dnsmasq
    option address &#039;/#/192.168.251.252&#039;
    option domainneeded &#039;1&#039;
    option boguspriv &#039;1&#039;
    option filterwin2k &#039;0&#039;
    option localise_queries &#039;1&#039;
    option rebind_protection &#039;1&#039;
    option rebind_localhost &#039;1&#039;
    option local &#039;/lan/&#039;
    option domain &#039;shelf&#039;
    option expandhosts &#039;1&#039;
    option nonegcache &#039;0&#039;
    option authoritative &#039;1&#039;
    option readethers &#039;1&#039;
    option leasefile &#039;/tmp/dhcp.leases&#039;
    option resolvfile &#039;/tmp/resolv.conf.auto&#039;
    option localservice &#039;1&#039;

config dhcp &#039;lan&#039;
    option interface &#039;lan&#039;
    option start &#039;100&#039;
    option limit &#039;150&#039;
    option leasetime &#039;12h&#039;
    option dhcpv6 &#039;server&#039;
    option ra &#039;server&#039;
    option ra_management &#039;1&#039;

config dhcp &#039;wan&#039;
    option interface &#039;wan&#039;
    option ignore &#039;1&#039;

config odhcpd &#039;odhcpd&#039;
    option maindhcp &#039;0&#039;
    option leasefile &#039;/tmp/hosts/odhcpd&#039;
    option leasetrigger &#039;/usr/sbin/odhcpd-update&#039;

config domain
    option name &#039;book&#039;
    option ip &#039;192.168.251.252&#039;</code></pre></div><p>At this point the html is not yet available on 192.168.251.252 not sure what i&#039;m missing.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p314873">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">eduperez</div>
					<div class="post-datetime">
						15 Mar 2016, 09:05					</div>
				</div>
				<div class="post-content content">
					<p>I think &quot;option home &#039;mnt/sda1/www&#039;&quot; shoud be &quot;option home &#039;/mnt/sda1/www&#039;&quot;.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p314890">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">augustus_meyer</div>
					<div class="post-datetime">
						15 Mar 2016, 10:22					</div>
				</div>
				<div class="post-content content">
					<p>eduperez is right.</p><p>Then verify installation:<br />First, check DNS.<br />On your client machine, either do a <br />nslookup book.shelf<br />or<br />ping book.shelf.</p><p>Does it resolve to 192.168.251.252 ?</p><p>If not, update /etc/hosts on openwrt, and insert<br />192.168.251.252 book.shelf<br />restart dnsmasq</p><p>And retry nslookup/ping.</p><p>If this works, on your clients browser<br /><a href="http://192.168.251.252/index.html">http://192.168.251.252/index.html</a><br />Does this work ?</p>											<p class="post-edited">(Last edited by <strong>augustus_meyer</strong> on 15 Mar 2016, 10:29)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p315414">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">frietpan</div>
					<div class="post-datetime">
						17 Mar 2016, 23:38					</div>
				</div>
				<div class="post-content content">
					<p>I went back to the alias config for 192.168.251.252</p><p>in network:<br /></p><div class="codebox"><pre><code>config alias
    option interface &#039;lan&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;192.168.251.252&#039;
    option netmask &#039;255.255.255.0&#039;</code></pre></div><p>and now book.shelf resolves correct</p><p>however the option address &#039;/#/192.168.251.252&#039; still isnt doing what i expected</p><p>this still doesnt catch all http requests and serve them an index.html on 192.168.251.252</p><p>did i make a typo, or do i still need to set some other stuff to make this work?</p><p>the dnsmasq man says:</p><div class="codebox"><pre><code>-A, --address=/&lt;domain&gt;/[domain/][&lt;ipaddr&gt;]
    Specify an IP address to return for any host in the given domains. Queries in the domains are never forwarded and always replied to with the specified IP address which may be IPv4 or IPv6. To give both IPv4 and IPv6 addresses for a domain, use repeated -A flags. Note that /etc/hosts and DHCP leases override this for individual names. A common use of this is to redirect the entire doubleclick.net domain to some friendly local web server to avoid banner ads. The domain specification works in the same was as for --server, with the additional facility that /#/ matches any domain. Thus --address=/#/1.2.3.4 will always return 1.2.3.4 for any query not answered from /etc/hosts or DHCP and not sent to an upstream nameserver by a more specific --server directive. As for --server, one or more domains with no address returns a no-such-domain answer, sois equivalent to --server=/example.com/ and returns NXDOMAIN for example.com and all its subdomains. </code></pre></div><p>So:<br />address=/#/1.2.3.4 will always return 1.2.3.4 for any query not answered from /etc/hosts </p><p>and:<br />address=/example.com/ </p><p>so my creativity kicks in and invents address=/#/book.shelf once again hehe i now see this is wrong.. but my mind wont let it go</p><p>What is still missing in my config? i have been reading things over and over again to the point where i start to confuse myself . :-)</p><p>it is as if OpenWrt doesnt accept # as the wildcard</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p315421">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">frietpan</div>
					<div class="post-datetime">
						17 Mar 2016, 23:53					</div>
				</div>
				<div class="post-content content">
					<p>so my webserver works and the hostnames also are resolved correct</p><p>book.shelf points to 192.168.251.252<br />and i added the host docu also on 192.168.251.252<br />and docu.shelf also ends at 192.168.251.252</p><p>btw the path mnt/sda1/www did work&nbsp; &nbsp;(although i have now placed the / in front)</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p315490">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">augustus_meyer</div>
					<div class="post-datetime">
						18 Mar 2016, 11:01					</div>
				</div>
				<div class="post-content content">
					<p>Just to repeat:<br />On client <br />ping book.shelf works (resolved to 192.168.251.252)<br />ping anydomain.com works (also resolved to 192.168.251.252)<br /><a href="http://192.168.251.252/index.html">http://192.168.251.252/index.html</a></p><p>So the problem either is the setup of uhttpd (most likely) OR a conflicting iptables rules (less likely).<br />So, verify the firewall rules. Or just flush them all, and accept everything for the&nbsp; test.</p><p>Do these ones work from client:<br /><a href="http://192.168.251.252/index.html">http://192.168.251.252/index.html</a><br /><a href="http://book.shelf/index.html">http://book.shelf/index.html</a></p><p>If NOT,<br />does the second uhttpd really listen on correct IP, and has it correct access to /mnt/sda1/www ?<br />What says<br />netstat -tulpn</p><p>There might be a race condition, starting uhttpd-portal before the mount to /mnt/sda1/www completes.<br />Leaving uhttpd-portal without correct access to this directory.<br />Any error messages from uhttpd-portal in logread ?</p><p>To verify the access to /mnt/sda1/www, just for a test change it to /www in /etc/config/uhttpd and place simple index.html into this dir.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p316046">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">frietpan</div>
					<div class="post-datetime">
						22 Mar 2016, 04:03					</div>
				</div>
				<div class="post-content content">
					<p>I have spend a few evenings with this, it seems to get worse.</p><p>ping book.shelf works (resolved to 192.168.251.252)<br />ping anything.else does not work <br />if i ping google then i get a reply from googles ip 82.94.234.18 (when i have a WAN connection)</p><p><a href="http://192.168.251.252/index.html">http://192.168.251.252/index.html</a>&nbsp; loads my temporary html just fine<br /><a href="http://book.shelf">http://book.shelf</a> <a href="http://book.shelf/index.html">http://book.shelf/index.html</a>&nbsp; also load the same page just fine<br /></p><div class="codebox"><pre><code>netstat -tulpn:

Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 192.168.251.1:80        0.0.0.0:*               LISTEN      1131/uhttpd
tcp        0      0 192.168.251.252:80      0.0.0.0:*               LISTEN      1132/uhttpd
tcp        0      0 0.0.0.0:53              0.0.0.0:*               LISTEN      1173/dnsmasq
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1094/dropbear
tcp        0      0 :::53                   :::*                    LISTEN      1173/dnsmasq
tcp        0      0 :::22                   :::*                    LISTEN      1094/dropbear
udp        0      0 0.0.0.0:53              0.0.0.0:*                           1173/dnsmasq
udp        0      0 0.0.0.0:67              0.0.0.0:*                           1173/dnsmasq
udp        0      0 :::546                  :::*                                1338/odhcp6c
udp        0      0 :::547                  :::*                                885/odhcpd
udp        0      0 :::53                   :::*                                1173/dnsmasq</code></pre></div><p>I flushed the firewall and re-entered the settings <br />the above still works the same.</p><p>But the OpenWrt GUI 192.168.251.1 is no longer reachable, <br />so something has changed, but not what i hoped for. </p><p>I can still ping it:<br /></p><div class="codebox"><pre><code>ping 192.168.251.1

PING 192.168.251.1 (192.168.251.1) 56(84) bytes of data.
64 bytes from 192.168.251.1: icmp_req=1 ttl=64 time=0.483 ms
64 bytes from 192.168.251.1: icmp_req=2 ttl=64 time=0.344 ms
^C
--- 192.168.251.1 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 0.344/0.413/0.483/0.072 ms</code></pre></div><br /><p>Also I deleted the file /etc/config/firewall and placed the one back that i had before.<br />Though this did not bring me back to the situation i had before.<br />The OpenWrt GUI is still not working correct. </p><div class="codebox"><pre><code>cat firewall 

config defaults
    option syn_flood &#039;1&#039;
    option input &#039;ACCEPT&#039;
    option output &#039;ACCEPT&#039;
    option forward &#039;REJECT&#039;

config zone
    option name &#039;lan&#039;
    option input &#039;ACCEPT&#039;
    option output &#039;ACCEPT&#039;
    option forward &#039;ACCEPT&#039;
    option network &#039;lan&#039;

config zone
    option name &#039;wan&#039;
    option input &#039;REJECT&#039;
    option output &#039;ACCEPT&#039;
    option forward &#039;REJECT&#039;
    option masq &#039;1&#039;
    option mtu_fix &#039;1&#039;
    option network &#039;wan wan6 wwan&#039;

config forwarding
    option src &#039;lan&#039;
    option dest &#039;wan&#039;

config rule
    option name &#039;Allow-DHCP-Renew&#039;
    option src &#039;wan&#039;
    option proto &#039;udp&#039;
    option dest_port &#039;68&#039;
    option target &#039;ACCEPT&#039;
    option family &#039;ipv4&#039;

config rule
    option name &#039;Allow-Ping&#039;
    option src &#039;wan&#039;
    option proto &#039;icmp&#039;
    option icmp_type &#039;echo-request&#039;
    option family &#039;ipv4&#039;
    option target &#039;ACCEPT&#039;

config rule
    option name &#039;Allow-IGMP&#039;
    option src &#039;wan&#039;
    option proto &#039;igmp&#039;
    option family &#039;ipv4&#039;
    option target &#039;ACCEPT&#039;

config rule
    option name &#039;Allow-DHCPv6&#039;
    option src &#039;wan&#039;
    option proto &#039;udp&#039;
    option src_ip &#039;fe80::/10&#039;
    option src_port &#039;547&#039;
    option dest_ip &#039;fe80::/10&#039;
    option dest_port &#039;546&#039;
    option family &#039;ipv6&#039;
    option target &#039;ACCEPT&#039;

config rule
    option name &#039;Allow-MLD&#039;
    option src &#039;wan&#039;
    option proto &#039;icmp&#039;
    option src_ip &#039;fe80::/10&#039;
    list icmp_type &#039;130/0&#039;
    list icmp_type &#039;131/0&#039;
    list icmp_type &#039;132/0&#039;
    list icmp_type &#039;143/0&#039;
    option family &#039;ipv6&#039;
    option target &#039;ACCEPT&#039;

config rule
    option name &#039;Allow-ICMPv6-Input&#039;
    option src &#039;wan&#039;
    option proto &#039;icmp&#039;
    list icmp_type &#039;echo-request&#039;
    list icmp_type &#039;echo-reply&#039;
    list icmp_type &#039;destination-unreachable&#039;
    list icmp_type &#039;packet-too-big&#039;
    list icmp_type &#039;time-exceeded&#039;
    list icmp_type &#039;bad-header&#039;
    list icmp_type &#039;unknown-header-type&#039;
    list icmp_type &#039;router-solicitation&#039;
    list icmp_type &#039;neighbour-solicitation&#039;
    list icmp_type &#039;router-advertisement&#039;
    list icmp_type &#039;neighbour-advertisement&#039;
    option limit &#039;1000/sec&#039;
    option family &#039;ipv6&#039;
    option target &#039;ACCEPT&#039;

config rule
    option name &#039;Allow-ICMPv6-Forward&#039;
    option src &#039;wan&#039;
    option dest &#039;*&#039;
    option proto &#039;icmp&#039;
    list icmp_type &#039;echo-request&#039;
    list icmp_type &#039;echo-reply&#039;
    list icmp_type &#039;destination-unreachable&#039;
    list icmp_type &#039;packet-too-big&#039;
    list icmp_type &#039;time-exceeded&#039;
    list icmp_type &#039;bad-header&#039;
    list icmp_type &#039;unknown-header-type&#039;
    option limit &#039;1000/sec&#039;
    option family &#039;ipv6&#039;
    option target &#039;ACCEPT&#039;

config include
    option path &#039;/etc/firewall.user&#039;

config rule
    option src &#039;wan&#039;
    option dest &#039;lan&#039;
    option proto &#039;esp&#039;
    option target &#039;ACCEPT&#039;

config rule
    option src &#039;wan&#039;
    option dest &#039;lan&#039;
    option dest_port &#039;500&#039;
    option proto &#039;udp&#039;
    option target &#039;ACCEPT&#039;</code></pre></div><p>and uhttpd<br /></p><div class="codebox"><pre><code>cat uhttpd

config uhttpd &#039;main&#039;
    list listen_http &#039;192.168.251.1:80&#039;
    list listen_https &#039;192.168.251.1:443&#039;
    option redirect_https &#039;1&#039;
    option home &#039;/www&#039;
    option rfc1918_filter &#039;1&#039;
    option max_requests &#039;3&#039;
    option max_connections &#039;100&#039;
    option cert &#039;/etc/uhttpd.crt&#039;
    option key &#039;/etc/uhttpd.key&#039;
    option cgi_prefix &#039;/cgi-bin&#039;
    option script_timeout &#039;60&#039;
    option network_timeout &#039;30&#039;
    option http_keepalive &#039;20&#039;
    option tcp_keepalive &#039;1&#039;
    option ubus_prefix &#039;/ubus&#039;

config cert &#039;px5g&#039;
    option days &#039;730&#039;
    option bits &#039;1024&#039;
    option country &#039;ZZ&#039;
    option state &#039;Somewhere&#039;
    option location &#039;Uknown&#039;
    option commonname &#039;OpenWrt&#039;

config uhttpd &#039;portal&#039;
    list listen_http &#039;192.168.251.252:80&#039;
    list listen_https &#039;192.168.251.252:433&#039;
    option home &#039;/mnt/sda1/www&#039;
    option rfc1918_filter &#039;1&#039;
    option max_requests &#039;3&#039;
    option max_connections &#039;100&#039;
    option script_timeout &#039;60&#039;
    option network_timeout &#039;30&#039;
    option http_keepalive &#039;20&#039;
    option tcp_keepalive &#039;1&#039;</code></pre></div><br /><p>In either of the situations, and after a full reboot, clearing my browsers chache, the wildcard just doest seem to capture.</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=59998&amp;p=2.html">2</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>