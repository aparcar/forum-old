<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> How to switch between different wireless networks automatically?</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 8 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p197129">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">dabyd64</div>
					<div class="post-datetime">
						3 Apr 2013, 22:37					</div>
				</div>
				<div class="post-content content">
					<p>HI, I have a setup at a friends&#039;s house: He get a few free wireless networks at medium signal on the window, but none or very weak inside the house. <br />So, I&#039;m trying to setup a repeater. The problem is that the wireless networks often go down for few hours, then come back.Most of the wireless networks come from coffee-shops, so maybe they turn them off when they close.<br />I searched everywhere but found nothing about this: How to switch automatically between different networks when the other fails? Is there any script or any option in openwrt to achieve this?<br />Its like roaming but different networks.<br />These are &#039;example&#039; networks.<br />FreeHotSpot1, WPA2-PSK, KEY:12345678<br />FreeHotSpot2, WPA-PSK, KEY:ABCDEFGH<br />FreeHotSpot3, WPA2-AES, KEY:ABCD1234</p><p>Any help would be appreciated <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>											<p class="post-edited">(Last edited by <strong>dabyd64</strong> on 3 Apr 2013, 22:37)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p197259">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">dabyd64</div>
					<div class="post-datetime">
						4 Apr 2013, 22:29					</div>
				</div>
				<div class="post-content content">
					<p>Nobody? <img src="https://forum.openwrt.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p197272">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">jeffster</div>
					<div class="post-datetime">
						4 Apr 2013, 23:50					</div>
				</div>
				<div class="post-content content">
					<p>Certainly can be done, but I would imagine most people dealing with &quot;multi-link&quot; have control over the links, so that switching links don&#039;t change the end-points of the TCP connection. When you&#039;ve got NAT involved in the links you are using, it&#039;s going to be nearly impossible to keep the connections up when you change between the different links. It will be just like when you move with a mobile client from one location to another -- everything you are doing drops. Not a huge problem with web surfing; killer for most anything that expects long-lived connections.</p><p>One <em>could </em>do what you are wanting to do with a script that<br /></p><ul><li><p>Detected a network-down condition</p></li><li><p>Scanned for the networks that were up</p></li><li><p>Changed the configuration to have the WiFi client use the selected network</p></li></ul><p>I&#039;ll not comment on the ethics of what you are proposing to do, past asking you to examine it yourself.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p197279">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">dabyd64</div>
					<div class="post-datetime">
						5 Apr 2013, 01:26					</div>
				</div>
				<div class="post-content content">
					<p>It&#039;s only for surfing and such, he got 1-2 hours free a day (when not working, lunching or sleeping <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" />), so what I want is just to let him surf or watch something ocasionally.<br />Actually he must put the computer just on the window, so for 14â‚¬ it&#039;s cheap to put a repeater there.<br />As I said, it&#039;s not stolen wifi, they are free from the bars! so no cry about those, he pays his coffee everyday <img src="https://forum.openwrt.org/img/smilies/tongue.png" width="15" height="15" alt="tongue" /><br />My idea is the following, but I have zero knowledge about linux scripting..<br />Lets say I have 3 wireless configs on a file.<br />Run that script at startup, called on rc.local file. The script sleeps and run every 10 seconds. A simple ping to google.es, for example. When it losses connectivity, set the next wireless config, reload network, and start again. Hopefully the three networks won&#039;t fail at the same time!</p><p>Another idea (even easier) is to make three wireless configs.<br />wireless1, wireless2, wireless3.<br />At first rename one of them to wireless, then when the network fails, the scripts checks what file is not there (as it is renamed) and renames the current config to the old name, then renames the next wireless config and restarts network.<br />But as I said, my scripting knowledge is absolutely zero on linux <img src="https://forum.openwrt.org/img/smilies/lol.png" width="15" height="15" alt="lol" /></p>											<p class="post-edited">(Last edited by <strong>dabyd64</strong> on 5 Apr 2013, 01:35)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p197280">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">dabyd64</div>
					<div class="post-datetime">
						5 Apr 2013, 03:16					</div>
				</div>
				<div class="post-content content">
					<p>After 2 hours of brainstorming and lot of googling and failed tests, I got it working <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /><br />I know some coder is going to hate me! sorry, I know is dirty and probably the worst code ever seen on the forum <img src="https://forum.openwrt.org/img/smilies/lol.png" width="15" height="15" alt="lol" /><br /></p><div class="codebox"><pre><code>#!/bin/sh
while :
do
    #wait first, to ensure there is a connection at fresh boot
    sleep 20
    echo Checking internet connection availability...
     x=$(iw dev wlan0 station dump &gt;&amp;1 | grep &quot;authenticated&quot;)
    if [  &quot;$x&quot; = &quot;&quot; ]; then
        echo No internet available, selecting next config file
        if [ -f &quot;/etc/config/wireless1&quot; ];then
            if [ -f &quot;/etc/config/wireless2&quot; ]; then
                logger Changed to Wireless1 config
                    mv /etc/config/wireless /etc/config/wireless3
                    mv /etc/config/wireless1 /etc/config/wireless
            else
                logger Changed to Wireless3 config
                mv /etc/config/wireless /etc/config/wireless2
                mv /etc/config/wireless3 /etc/config/wireless
            fi
        else
            logger Changed to Wireless2 config...
            mv /etc/config/wireless /etc/config/wireless1
            mv /etc/config/wireless2 /etc/config/wireless
        fi
        logger Restarting network to apply settings...
        # No need to restart the network, restarting wifi is enough
        #/etc/init.d/network restart
        wifi down;wifi
    else
        echo Internet connection is OK
    fi
done</code></pre></div>											<p class="post-edited">(Last edited by <strong>dabyd64</strong> on 5 Apr 2013, 03:21)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p197281">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">jeffster</div>
					<div class="post-datetime">
						5 Apr 2013, 03:27					</div>
				</div>
				<div class="post-content content">
					<p>There you go -- way to start learning shell scripting!</p><p>A couple hints:</p><p><em>ln -s TARGET LINK_NAME </em>will remove the copying -- just have wireless &quot;point to&quot; one of the configurations. </p><p><em>Edit -- see the recommendation in the next post on using uci</em></p><p><em>while-sleep </em>loops are notorious for stopping unexpectedly on an error. If you can put up with a once-a-minute check, look into <em>cron </em>instead.</p><p>Depending on your hardware and software, <em>iw </em>may be useful in determining if another network is available along with it&#039;s current signal strength. See more detail at <a href="http://wireless.kernel.org/en/users/Documentation/iw">http://wireless.kernel.org/en/users/Documentation/iw</a></p>											<p class="post-edited">(Last edited by <strong>jeffster</strong> on 5 Apr 2013, 03:38)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p197283">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">brontide</div>
					<div class="post-datetime">
						5 Apr 2013, 03:30					</div>
				</div>
				<div class="post-content content">
					<p>Might I recommend all of the in the same config file with two option disabled 1.&nbsp; You could then use uci command to cycle between the options by disabling one and enabling one.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p197364">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">dabyd64</div>
					<div class="post-datetime">
						5 Apr 2013, 17:24					</div>
				</div>
				<div class="post-content content">
					<p>As it became a success, I made a Howto in its corresponding section:<br /><a href="https://forum.openwrt.org/viewtopic.php?id=43352">https://forum.openwrt.org/viewtopic.php?id=43352</a></p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>